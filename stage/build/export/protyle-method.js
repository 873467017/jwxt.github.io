(()=>{var Pr=(la,Qe)=>()=>(Qe||la((Qe={exports:{}}).exports,Qe),Qe.exports);var Rr=Pr((Fa,Vn)=>{(function(Qe,Oe){typeof Fa=="object"&&typeof Vn=="object"?Vn.exports=Oe():typeof define=="function"&&define.amd?define([],Oe):typeof Fa=="object"?Fa.Protyle=Oe():Qe.Protyle=Oe()})(self,()=>(()=>{var la={101:Be=>{"use strict";function pe(ce){if(typeof ce!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(ce))}function oe(ce,q){for(var O="",K=0,J=-1,Q=0,V,ee=0;ee<=ce.length;++ee){if(ee<ce.length)V=ce.charCodeAt(ee);else{if(V===47)break;V=47}if(V===47){if(!(J===ee-1||Q===1))if(J!==ee-1&&Q===2){if(O.length<2||K!==2||O.charCodeAt(O.length-1)!==46||O.charCodeAt(O.length-2)!==46){if(O.length>2){var le=O.lastIndexOf("/");if(le!==O.length-1){le===-1?(O="",K=0):(O=O.slice(0,le),K=O.length-1-O.lastIndexOf("/")),J=ee,Q=0;continue}}else if(O.length===2||O.length===1){O="",K=0,J=ee,Q=0;continue}}q&&(O.length>0?O+="/..":O="..",K=2)}else O.length>0?O+="/"+ce.slice(J+1,ee):O=ce.slice(J+1,ee),K=ee-J-1;J=ee,Q=0}else V===46&&Q!==-1?++Q:Q=-1}return O}function It(ce,q){var O=q.dir||q.root,K=q.base||(q.name||"")+(q.ext||"");return O?O===q.root?O+K:O+ce+K:K}var Fe={resolve:function(){for(var q="",O=!1,K,J=arguments.length-1;J>=-1&&!O;J--){var Q;J>=0?Q=arguments[J]:(K===void 0&&(K=process.cwd()),Q=K),pe(Q),Q.length!==0&&(q=Q+"/"+q,O=Q.charCodeAt(0)===47)}return q=oe(q,!O),O?q.length>0?"/"+q:"/":q.length>0?q:"."},normalize:function(q){if(pe(q),q.length===0)return".";var O=q.charCodeAt(0)===47,K=q.charCodeAt(q.length-1)===47;return q=oe(q,!O),q.length===0&&!O&&(q="."),q.length>0&&K&&(q+="/"),O?"/"+q:q},isAbsolute:function(q){return pe(q),q.length>0&&q.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var q,O=0;O<arguments.length;++O){var K=arguments[O];pe(K),K.length>0&&(q===void 0?q=K:q+="/"+K)}return q===void 0?".":Fe.normalize(q)},relative:function(q,O){if(pe(q),pe(O),q===O||(q=Fe.resolve(q),O=Fe.resolve(O),q===O))return"";for(var K=1;K<q.length&&q.charCodeAt(K)===47;++K);for(var J=q.length,Q=J-K,V=1;V<O.length&&O.charCodeAt(V)===47;++V);for(var ee=O.length,le=ee-V,Pe=Q<le?Q:le,Le=-1,ue=0;ue<=Pe;++ue){if(ue===Pe){if(le>Pe){if(O.charCodeAt(V+ue)===47)return O.slice(V+ue+1);if(ue===0)return O.slice(V+ue)}else Q>Pe&&(q.charCodeAt(K+ue)===47?Le=ue:ue===0&&(Le=0));break}var Ft=q.charCodeAt(K+ue),Dt=O.charCodeAt(V+ue);if(Ft!==Dt)break;Ft===47&&(Le=ue)}var We="";for(ue=K+Le+1;ue<=J;++ue)(ue===J||q.charCodeAt(ue)===47)&&(We.length===0?We+="..":We+="/..");return We.length>0?We+O.slice(V+Le):(V+=Le,O.charCodeAt(V)===47&&++V,O.slice(V))},_makeLong:function(q){return q},dirname:function(q){if(pe(q),q.length===0)return".";for(var O=q.charCodeAt(0),K=O===47,J=-1,Q=!0,V=q.length-1;V>=1;--V)if(O=q.charCodeAt(V),O===47){if(!Q){J=V;break}}else Q=!1;return J===-1?K?"/":".":K&&J===1?"//":q.slice(0,J)},basename:function(q,O){if(O!==void 0&&typeof O!="string")throw new TypeError('"ext" argument must be a string');pe(q);var K=0,J=-1,Q=!0,V;if(O!==void 0&&O.length>0&&O.length<=q.length){if(O.length===q.length&&O===q)return"";var ee=O.length-1,le=-1;for(V=q.length-1;V>=0;--V){var Pe=q.charCodeAt(V);if(Pe===47){if(!Q){K=V+1;break}}else le===-1&&(Q=!1,le=V+1),ee>=0&&(Pe===O.charCodeAt(ee)?--ee===-1&&(J=V):(ee=-1,J=le))}return K===J?J=le:J===-1&&(J=q.length),q.slice(K,J)}else{for(V=q.length-1;V>=0;--V)if(q.charCodeAt(V)===47){if(!Q){K=V+1;break}}else J===-1&&(Q=!1,J=V+1);return J===-1?"":q.slice(K,J)}},extname:function(q){pe(q);for(var O=-1,K=0,J=-1,Q=!0,V=0,ee=q.length-1;ee>=0;--ee){var le=q.charCodeAt(ee);if(le===47){if(!Q){K=ee+1;break}continue}J===-1&&(Q=!1,J=ee+1),le===46?O===-1?O=ee:V!==1&&(V=1):O!==-1&&(V=-1)}return O===-1||J===-1||V===0||V===1&&O===J-1&&O===K+1?"":q.slice(O,J)},format:function(q){if(q===null||typeof q!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof q);return It("/",q)},parse:function(q){pe(q);var O={root:"",dir:"",base:"",ext:"",name:""};if(q.length===0)return O;var K=q.charCodeAt(0),J=K===47,Q;J?(O.root="/",Q=1):Q=0;for(var V=-1,ee=0,le=-1,Pe=!0,Le=q.length-1,ue=0;Le>=Q;--Le){if(K=q.charCodeAt(Le),K===47){if(!Pe){ee=Le+1;break}continue}le===-1&&(Pe=!1,le=Le+1),K===46?V===-1?V=Le:ue!==1&&(ue=1):V!==-1&&(ue=-1)}return V===-1||le===-1||ue===0||ue===1&&V===le-1&&V===ee+1?le!==-1&&(ee===0&&J?O.base=O.name=q.slice(1,le):O.base=O.name=q.slice(ee,le)):(ee===0&&J?(O.name=q.slice(1,V),O.base=q.slice(1,le)):(O.name=q.slice(ee,V),O.base=q.slice(ee,le)),O.ext=q.slice(V,le)),ee>0?O.dir=q.slice(0,ee-1):J&&(O.dir="/"),O},sep:"/",delimiter:":",win32:null,posix:null};Fe.posix=Fe,Be.exports=Fe},232:function(Be){(function(pe,oe){Be.exports=oe()})(this,function(){"use strict";var pe=1e3,oe=6e4,It=36e5,Fe="millisecond",ce="second",q="minute",O="hour",K="day",J="week",Q="month",V="quarter",ee="year",le="date",Pe="Invalid Date",Le=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,ue=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Ft={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(ae){var W=["th","st","nd","rd"],F=ae%100;return"["+ae+(W[(F-20)%10]||W[F]||W[0])+"]"}},Dt=function(ae,W,F){var j=String(ae);return!j||j.length>=W?ae:""+Array(W+1-j.length).join(F)+ae},We={s:Dt,z:function(ae){var W=-ae.utcOffset(),F=Math.abs(W),j=Math.floor(F/60),U=F%60;return(W<=0?"+":"-")+Dt(j,2,"0")+":"+Dt(U,2,"0")},m:function ae(W,F){if(W.date()<F.date())return-ae(F,W);var j=12*(F.year()-W.year())+(F.month()-W.month()),U=W.clone().add(j,Q),G=F-U<0,Z=W.clone().add(j+(G?-1:1),Q);return+(-(j+(F-U)/(G?U-Z:Z-U))||0)},a:function(ae){return ae<0?Math.ceil(ae)||0:Math.floor(ae)},p:function(ae){return{M:Q,y:ee,w:J,d:K,D:le,h:O,m:q,s:ce,ms:Fe,Q:V}[ae]||String(ae||"").toLowerCase().replace(/s$/,"")},u:function(ae){return ae===void 0}},bt="en",lt={};lt[bt]=Ft;var ra="$isDayjsObject",Yt=function(ae){return ae instanceof H||!(!ae||!ae[ra])},me=function ae(W,F,j){var U;if(!W)return bt;if(typeof W=="string"){var G=W.toLowerCase();lt[G]&&(U=G),F&&(lt[G]=F,U=G);var Z=W.split("-");if(!U&&Z.length>1)return ae(Z[0])}else{var fe=W.name;lt[fe]=W,U=fe}return!j&&U&&(bt=U),U||!j&&bt},he=function(ae,W){if(Yt(ae))return ae.clone();var F=typeof W=="object"?W:{};return F.date=ae,F.args=arguments,new H(F)},I=We;I.l=me,I.i=Yt,I.w=function(ae,W){return he(ae,{locale:W.$L,utc:W.$u,x:W.$x,$offset:W.$offset})};var H=function(){function ae(F){this.$L=me(F.locale,null,!0),this.parse(F),this.$x=this.$x||F.x||{},this[ra]=!0}var W=ae.prototype;return W.parse=function(F){this.$d=function(j){var U=j.date,G=j.utc;if(U===null)return new Date(NaN);if(I.u(U))return new Date;if(U instanceof Date)return new Date(U);if(typeof U=="string"&&!/Z$/i.test(U)){var Z=U.match(Le);if(Z){var fe=Z[2]-1||0,de=(Z[7]||"0").substring(0,3);return G?new Date(Date.UTC(Z[1],fe,Z[3]||1,Z[4]||0,Z[5]||0,Z[6]||0,de)):new Date(Z[1],fe,Z[3]||1,Z[4]||0,Z[5]||0,Z[6]||0,de)}}return new Date(U)}(F),this.init()},W.init=function(){var F=this.$d;this.$y=F.getFullYear(),this.$M=F.getMonth(),this.$D=F.getDate(),this.$W=F.getDay(),this.$H=F.getHours(),this.$m=F.getMinutes(),this.$s=F.getSeconds(),this.$ms=F.getMilliseconds()},W.$utils=function(){return I},W.isValid=function(){return this.$d.toString()!==Pe},W.isSame=function(F,j){var U=he(F);return this.startOf(j)<=U&&U<=this.endOf(j)},W.isAfter=function(F,j){return he(F)<this.startOf(j)},W.isBefore=function(F,j){return this.endOf(j)<he(F)},W.$g=function(F,j,U){return I.u(F)?this[j]:this.set(U,F)},W.unix=function(){return Math.floor(this.valueOf()/1e3)},W.valueOf=function(){return this.$d.getTime()},W.startOf=function(F,j){var U=this,G=!!I.u(j)||j,Z=I.p(F),fe=function(et,$e){var Te=I.w(U.$u?Date.UTC(U.$y,$e,et):new Date(U.$y,$e,et),U);return G?Te:Te.endOf(K)},de=function(et,$e){return I.w(U.toDate()[et].apply(U.toDate("s"),(G?[0,0,0,0]:[23,59,59,999]).slice($e)),U)},be=this.$W,_e=this.$M,xe=this.$D,ot="set"+(this.$u?"UTC":"");switch(Z){case ee:return G?fe(1,0):fe(31,11);case Q:return G?fe(1,_e):fe(0,_e+1);case J:var rt=this.$locale().weekStart||0,ct=(be<rt?be+7:be)-rt;return fe(G?xe-ct:xe+(6-ct),_e);case K:case le:return de(ot+"Hours",0);case O:return de(ot+"Minutes",1);case q:return de(ot+"Seconds",2);case ce:return de(ot+"Milliseconds",3);default:return this.clone()}},W.endOf=function(F){return this.startOf(F,!1)},W.$set=function(F,j){var U,G=I.p(F),Z="set"+(this.$u?"UTC":""),fe=(U={},U[K]=Z+"Date",U[le]=Z+"Date",U[Q]=Z+"Month",U[ee]=Z+"FullYear",U[O]=Z+"Hours",U[q]=Z+"Minutes",U[ce]=Z+"Seconds",U[Fe]=Z+"Milliseconds",U)[G],de=G===K?this.$D+(j-this.$W):j;if(G===Q||G===ee){var be=this.clone().set(le,1);be.$d[fe](de),be.init(),this.$d=be.set(le,Math.min(this.$D,be.daysInMonth())).$d}else fe&&this.$d[fe](de);return this.init(),this},W.set=function(F,j){return this.clone().$set(F,j)},W.get=function(F){return this[I.p(F)]()},W.add=function(F,j){var U,G=this;F=Number(F);var Z=I.p(j),fe=function(_e){var xe=he(G);return I.w(xe.date(xe.date()+Math.round(_e*F)),G)};if(Z===Q)return this.set(Q,this.$M+F);if(Z===ee)return this.set(ee,this.$y+F);if(Z===K)return fe(1);if(Z===J)return fe(7);var de=(U={},U[q]=oe,U[O]=It,U[ce]=pe,U)[Z]||1,be=this.$d.getTime()+F*de;return I.w(be,this)},W.subtract=function(F,j){return this.add(-1*F,j)},W.format=function(F){var j=this,U=this.$locale();if(!this.isValid())return U.invalidDate||Pe;var G=F||"YYYY-MM-DDTHH:mm:ssZ",Z=I.z(this),fe=this.$H,de=this.$m,be=this.$M,_e=U.weekdays,xe=U.months,ot=U.meridiem,rt=function($e,Te,dt,Wt){return $e&&($e[Te]||$e(j,G))||dt[Te].slice(0,Wt)},ct=function($e){return I.s(fe%12||12,$e,"0")},et=ot||function($e,Te,dt){var Wt=$e<12?"AM":"PM";return dt?Wt.toLowerCase():Wt};return G.replace(ue,function($e,Te){return Te||function(dt){switch(dt){case"YY":return String(j.$y).slice(-2);case"YYYY":return I.s(j.$y,4,"0");case"M":return be+1;case"MM":return I.s(be+1,2,"0");case"MMM":return rt(U.monthsShort,be,xe,3);case"MMMM":return rt(xe,be);case"D":return j.$D;case"DD":return I.s(j.$D,2,"0");case"d":return String(j.$W);case"dd":return rt(U.weekdaysMin,j.$W,_e,2);case"ddd":return rt(U.weekdaysShort,j.$W,_e,3);case"dddd":return _e[j.$W];case"H":return String(fe);case"HH":return I.s(fe,2,"0");case"h":return ct(1);case"hh":return ct(2);case"a":return et(fe,de,!0);case"A":return et(fe,de,!1);case"m":return String(de);case"mm":return I.s(de,2,"0");case"s":return String(j.$s);case"ss":return I.s(j.$s,2,"0");case"SSS":return I.s(j.$ms,3,"0");case"Z":return Z}return null}($e)||Z.replace(":","")})},W.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},W.diff=function(F,j,U){var G,Z=this,fe=I.p(j),de=he(F),be=(de.utcOffset()-this.utcOffset())*oe,_e=this-de,xe=function(){return I.m(Z,de)};switch(fe){case ee:G=xe()/12;break;case Q:G=xe();break;case V:G=xe()/3;break;case J:G=(_e-be)/6048e5;break;case K:G=(_e-be)/864e5;break;case O:G=_e/It;break;case q:G=_e/oe;break;case ce:G=_e/pe;break;default:G=_e}return U?G:I.a(G)},W.daysInMonth=function(){return this.endOf(Q).$D},W.$locale=function(){return lt[this.$L]},W.locale=function(F,j){if(!F)return this.$L;var U=this.clone(),G=me(F,j,!0);return G&&(U.$L=G),U},W.clone=function(){return I.w(this.$d,this)},W.toDate=function(){return new Date(this.valueOf())},W.toJSON=function(){return this.isValid()?this.toISOString():null},W.toISOString=function(){return this.$d.toISOString()},W.toString=function(){return this.$d.toUTCString()},ae}(),ca=H.prototype;return he.prototype=ca,[["$ms",Fe],["$s",ce],["$m",q],["$H",O],["$W",K],["$M",Q],["$y",ee],["$D",le]].forEach(function(ae){ca[ae[1]]=function(W){return this.$g(W,ae[0],ae[1])}}),he.extend=function(ae,W){return ae.$i||(ae(W,H,he),ae.$i=!0),he},he.locale=me,he.isDayjs=Yt,he.unix=function(ae){return he(1e3*ae)},he.en=lt[bt],he.Ls=lt,he.p={},he})}},Qe={};function Oe(Be){var pe=Qe[Be];if(pe!==void 0)return pe.exports;var oe=Qe[Be]={exports:{}};return la[Be].call(oe.exports,oe,oe.exports,Oe),oe.exports}Oe.d=(Be,pe)=>{for(var oe in pe)Oe.o(pe,oe)&&!Oe.o(Be,oe)&&Object.defineProperty(Be,oe,{enumerable:!0,get:pe[oe]})},Oe.o=(Be,pe)=>Object.prototype.hasOwnProperty.call(Be,pe);var oa={};return(()=>{"use strict";Oe.d(oa,{default:()=>Br});var Be=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const pe=(e,t)=>Be(void 0,null,function*(){if(document.getElementById(t))return!1;const a=new XMLHttpRequest;a.open("GET",e,!1),a.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),a.send("");const n=document.createElement("script");n.type="text/javascript",n.text=a.responseText,n.id=t,document.head.appendChild(n),typeof Lute=="undefined"&&window.location.reload()}),oe=(e,t)=>new Promise(a=>{if(document.getElementById(t))return a(!1),!1;const n=document.createElement("script");n.src=e,n.async=!0,document.head.appendChild(n),n.onload=()=>{if(document.getElementById(t))return n.remove(),a(!1),!1;n.id=t,a(!0)}}),It=new Set(["docker","ios","android","harmony"]),Fe=new Set(["ios","android","harmony"]),ce=()=>It.has(window.siyuan.config.system.container),q=()=>Fe.has(window.siyuan.config.system.container),O=()=>!!document.getElementById("sidebar"),K=()=>ce()?window.siyuan.config.system.container:window.siyuan.config.system.os,J=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",Q=()=>!document.getElementById("toolbar"),V=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,ee=(e,t)=>e.length===t.length&&e.every(a=>t.includes(a)),le=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,Pe=(e,t=window.location.search)=>{const a=t.substring(t.indexOf("?")),n=a.indexOf("#");return new URLSearchParams(a.substring(0,n>=0?n:void 0)).get(e)},Le=()=>!0,ue=e=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(e),Ft=e=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(e),Dt=e=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(e),We=e=>Function(`"use strict";return (${e})`)(),bt=(e,t)=>{if(e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(!e||!t||typeof e!="object"&&typeof t!="object")return e===t;if(e.prototype!==t.prototype)return!1;const a=Object.keys(e);return a.length!==Object.keys(t).length?!1:a.every(n=>bt(e[n],t[n]))},lt=e=>{if(!e)return"";const t=e.match(/^(.*) \((\d+)\)$/);return t?e=`${t[1]} (${parseInt(t[2])+1})`:e=`${e} (1)`,e},ra="3.3.6",Yt="production",me=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",he=()=>{const e={};for(let t=1;t<=32;t++)e[t+111]="F"+t;return e},I=class{};I.SIYUAN_VERSION=ra,I.NODE_ENV=Yt,I.SIYUAN_APPID=Math.random().toString(36).substring(8),I.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",I.PROTYLE_CDN="/stage/protyle",I.UPLOAD_ADDRESS="/upload",I.SERVICE_WORKER_PATH="/service-worker.js",I.SIYUAN_DROP_FILE="application/siyuan-file",I.SIYUAN_DROP_GUTTER="application/siyuan-gutter",I.SIYUAN_DROP_TAB="application/siyuan-tab",I.SIYUAN_DROP_EDITOR="application/siyuan-editor",I.SIYUAN_CMD="siyuan-cmd",I.SIYUAN_GET="siyuan-get",I.SIYUAN_EVENT="siyuan-event",I.SIYUAN_CONFIG_TRAY="siyuan-config-tray",I.SIYUAN_QUIT="siyuan-quit",I.SIYUAN_HOTKEY="siyuan-hotkey",I.SIYUAN_INIT="siyuan-init",I.SIYUAN_SEND_WINDOWS="siyuan-send-windows",I.SIYUAN_SAVE_CLOSE="siyuan-save-close",I.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",I.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",I.SIYUAN_OPEN_URL="siyuan-open-url",I.SIYUAN_OPEN_WINDOW="siyuan-open-window",I.SIYUAN_OPEN_FILE="siyuan-open-file",I.SIYUAN_EXPORT_PDF="siyuan-export-pdf",I.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",I.SIYUAN_CONTEXT_MENU="siyuan-context-menu",I.SIYUAN_SHOW_WINDOW="siyuan-show-window",I.CUSTOM_SY_READONLY="custom-sy-readonly",I.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",I.CUSTOM_SY_AV_VIEW="custom-sy-av-view",I.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",I.CUSTOM_RIFF_DECKS="custom-riff-decks",I.SIZE_DATABASE_MAZ_SIZE=102400,I.SIZE_SCROLL_TB=24,I.SIZE_SCROLL_STEP=256,I.SIZE_LINK_TEXT_MAX=64,I.SIZE_TOOLBAR_HEIGHT=O()?0:32,I.SIZE_GET_MAX=102400,I.SIZE_UNDO=64,I.SIZE_TITLE=512,I.SIZE_EDITOR_WIDTH=760,I.SIZE_ZOOM=[{zoom:.67,position:{x:0,y:2}},{zoom:.75,position:{x:1,y:4}},{zoom:.8,position:{x:2,y:4}},{zoom:.9,position:{x:5,y:6}},{zoom:1,position:{x:8,y:8}},{zoom:1.1,position:{x:12,y:9}},{zoom:1.25,position:{x:18,y:12}},{zoom:1.5,position:{x:27,y:16}},{zoom:1.75,position:{x:36,y:20}},{zoom:2,position:{x:45,y:23}},{zoom:2.5,position:{x:63,y:31}},{zoom:3,position:{x:80,y:39}}],I.CB_MOVE_NOLIST="cb-move-nolist",I.CB_MOUNT_REMOVE="cb-mount-remove",I.CB_GET_APPEND="cb-get-append",I.CB_GET_BEFORE="cb-get-before",I.CB_GET_UNCHANGEID="cb-get-unchangeid",I.CB_GET_HL="cb-get-hl",I.CB_GET_FOCUS="cb-get-focus",I.CB_GET_FOCUSFIRST="cb-get-focusfirst",I.CB_GET_SETID="cb-get-setid",I.CB_GET_OUTLINE="cb-get-outline",I.CB_GET_ALL="cb-get-all",I.CB_GET_BACKLINK="cb-get-backlink",I.CB_GET_UNUNDO="cb-get-unundo",I.CB_GET_SCROLL="cb-get-scroll",I.CB_GET_CONTEXT="cb-get-context",I.CB_GET_ROOTSCROLL="cb-get-rootscroll",I.CB_GET_HTML="cb-get-html",I.CB_GET_HISTORY="cb-get-history",I.CB_GET_OPENNEW="cb-get-opennew",I.LOCAL_ZOOM="local-zoom",I.LOCAL_SEARCHDATA="local-searchdata",I.LOCAL_SEARCHKEYS="local-searchkeys",I.LOCAL_SEARCHASSET="local-searchasset",I.LOCAL_SEARCHUNREF="local-searchunref",I.LOCAL_DOCINFO="local-docinfo",I.LOCAL_DAILYNOTEID="local-dailynoteid",I.LOCAL_HISTORY="local-history",I.LOCAL_CODELANG="local-codelang",I.LOCAL_FONTSTYLES="local-fontstyles",I.LOCAL_EXPORTPDF="local-exportpdf",I.LOCAL_EXPORTWORD="local-exportword",I.LOCAL_EXPORTIMG="local-exportimg",I.LOCAL_BAZAAR="local-bazaar",I.LOCAL_PDFTHEME="local-pdftheme",I.LOCAL_LAYOUTS="local-layouts",I.LOCAL_AI="local-ai",I.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",I.LOCAL_FLASHCARD="local-flashcard",I.LOCAL_FILEPOSITION="local-fileposition",I.LOCAL_FILESPATHS="local-filespaths",I.LOCAL_DIALOGPOSITION="local-dialogposition",I.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",I.LOCAL_OUTLINE="local-outline",I.LOCAL_PLUGIN_DOCKS="local-plugin-docks",I.LOCAL_IMAGES="local-images",I.LOCAL_EMOJIS="local-emojis",I.LOCAL_MOVE_PATH="local-move-path",I.LOCAL_RECENT_DOCS="local-recent-docs",I.DIALOG_CONFIRM="dialog-confirm",I.DIALOG_OPENCARD="dialog-opencard",I.DIALOG_MAKECARD="dialog-makecard",I.DIALOG_VIEWCARDS="dialog-viewcards",I.DIALOG_DIALYNOTE="dialog-dialynote",I.DIALOG_RECENTDOCS="dialog-recentdocs",I.DIALOG_SWITCHTAB="dialog-switchtab",I.DIALOG_SEARCH="dialog-search",I.DIALOG_REPLACE="dialog-replace",I.DIALOG_GLOBALSEARCH="dialog-globalsearch",I.DIALOG_HISTORYCOMPARE="dialog-historycompare",I.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",I.DIALOG_AICUSTOMACTION="dialog-aicustomaction",I.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",I.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",I.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",I.DIALOG_CHANGELOG="dialog-changelog",I.DIALOG_COMMANDPANEL="dialog-commandpanel",I.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",I.DIALOG_EMOJIS="dialog-emojis",I.DIALOG_EXPORTIMAGE="dialog-exportimage",I.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",I.DIALOG_EXPORTWORD="dialog-exportword",I.DIALOG_HISTORY="dialog-history",I.DIALOG_HISTORYDOC="dialog-historydoc",I.DIALOG_MOVEPATHTO="dialog-movepathto",I.DIALOG_RENAME="dialog-rename",I.DIALOG_RENAMEASSETS="dialog-renameassets",I.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",I.DIALOG_RENAMETAG="dialog-renametag",I.DIALOG_REPLACETYPE="dialog-replacetype",I.DIALOG_SAVECRITERION="dialog-savecriterion",I.DIALOG_SEARCHTYPE="dialog-searchtype",I.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",I.DIALOG_SETTING="dialog-setting",I.DIALOG_SNAPSHOTTAG="dialog-snapshottag",I.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",I.DIALOG_SNIPPETS="dialog-snippets",I.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",I.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",I.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",I.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",I.DIALOG_WECHATREMINDER="dialog-wechatreminder",I.DIALOG_PASSWORD="dialog-password",I.DIALOG_SETPASSWORD="dialog-setpassword",I.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",I.DIALOG_KERNELFAULT="dialog-kernelfault",I.DIALOG_STATEEXCEPTED="dialog-stateexcepted",I.DIALOG_ATTR="dialog-attr",I.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",I.DIALOG_CREATENOTEBOOK="dialog-createnotebook",I.DIALOG_NOTEBOOKCONF="dialog-notebookconf",I.DIALOG_CREATEWORKSPACE="dialog-createworkspace",I.DIALOG_OPENWORKSPACE="dialog-openworkspace",I.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",I.MENU_BAR_WORKSPACE="barWorkspace",I.MENU_BAR_PLUGIN="topBarPlugin",I.MENU_BAR_ZOOM="barZoom",I.MENU_BAR_MODE="barmode",I.MENU_BAR_MORE="barmore",I.MENU_STATUS_HELP="statusHelp",I.MENU_STATUS_BACKGROUND_TASK="statusBackgroundTask",I.MENU_DOCK_MOBILE="dockMobileMenu",I.MENU_BLOCK_SINGLE="block-single",I.MENU_BLOCK_MULTI="block-multi",I.MENU_TITLE="titleMenu",I.MENU_FROM_TITLE_PROTYLE="title-protyle",I.MENU_FROM_TITLE_BREADCRUMB="title-breadcrumb",I.MENU_BREADCRUMB_MORE="breadcrumbMore",I.MENU_BREADCRUMB_MOBILE_PATH="breadcrumb-mobile-path",I.MENU_DOC_TREE_MORE="docTreeMore",I.MENU_FROM_DOC_TREE_MORE_NOTEBOOK="tree-notebook",I.MENU_FROM_DOC_TREE_MORE_DOC="tree-doc",I.MENU_FROM_DOC_TREE_MORE_ITEMS="tree-items",I.MENU_TAG="tagMenu",I.MENU_BOOKMARK="bookmarkMenu",I.MENU_OUTLINE_CONTEXT="outline-context",I.MENU_OUTLINE_EXPAND_LEVEL="outline-expand-level",I.MENU_AV_VIEW="av-view",I.MENU_AV_HEADER_CELL="av-header-cell",I.MENU_AV_HEADER_ADD="av-header-add",I.MENU_AV_ADD_FILTER="av-add-filter",I.MENU_AV_ADD_SORT="av-add-sort",I.MENU_AV_COL_OPTION="av-col-option",I.MENU_AV_COL_FORMAT_NUMBER="av-col-format-number",I.MENU_AV_GROUP_DATE="avGroupDate",I.MENU_AV_GROUP_SORT="avGroupSort",I.MENU_AV_ASSET_EDIT="av-asset-edit",I.MENU_AV_CALC="av-calc",I.MENU_AV_PAGE_SIZE="av-page-size",I.MENU_SEARCH_MORE="searchMore",I.MENU_SEARCH_METHOD="searchMethod",I.MENU_SEARCH_ASSET_MORE="searchAssetMore",I.MENU_SEARCH_ASSET_METHOD="searchAssetMethod",I.MENU_SEARCH_UNREF_MORE="searchUnRefMore",I.MENU_SEARCH_HISTORY="search-history",I.MENU_SEARCH_REPLACE_HISTORY="search-replace-history",I.MENU_SEARCH_ASSET_HISTORY="search-asset-history",I.MENU_MOVE_PATH_HISTORY="move-path-history",I.MENU_BACKGROUND_ASSET="background-asset",I.MENU_AI="ai",I.MENU_TAB="tab",I.MENU_TAB_LIST="tabList",I.MENU_INLINE_CONTEXT="inline-context",I.MENU_INLINE_IMG="inline-img",I.MENU_INLINE_FILE_ANNOTATION_REF="inline-file-annotation-ref",I.MENU_INLINE_REF="inline-block-ref",I.MENU_INLINE_A="inline-a",I.MENU_INLINE_TAG="inline-tag",I.MENU_INLINE_MATH="inline-math",I.TIMEOUT_OPENDIALOG=50,I.TIMEOUT_DBLCLICK=190,I.TIMEOUT_INPUT=256,I.TIMEOUT_LOAD=300,I.TIMEOUT_TRANSITION=300,I.TIMEOUT_COUNT=1e3,I.HELP_PATH={ar_SA:"20210808180117-6v0mkxr",de_DE:"20210808180117-6v0mkxr",en_US:"20210808180117-6v0mkxr",es_ES:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr",he_IL:"20210808180117-6v0mkxr",it_IT:"20210808180117-6v0mkxr",ja_JP:"20240530133126-axarxgx",pl_PL:"20210808180117-6v0mkxr",pt_BR:"20210808180117-6v0mkxr",ru_RU:"20210808180117-6v0mkxr",zh_CHT:"20211226090932-5lcq56f",zh_CN:"20210808180117-czj9bvb"},I.QUICK_DECK_ID="20230218211946-2kw8jgx",I.KEYCODELIST=Object.assign(he(),{8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),I.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:me+"1",custom:me+"1"},outline:{default:me+"2",custom:me+"2"},bookmark:{default:me+"3",custom:me+"3"},tag:{default:me+"4",custom:me+"4"},dailyNote:{default:me+"5",custom:me+"5"},inbox:{default:me+"6",custom:me+"6"},backlinks:{default:me+"7",custom:me+"7"},graphView:{default:me+"8",custom:me+"8"},globalGraph:{default:me+"9",custom:me+"9"},riffCard:{default:me+"0",custom:me+"0"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},recentClosed:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""},addToDatabase:{default:"",custom:""},unsplit:{default:"",custom:""},unsplitAll:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},jumpToParentPrev:{default:"\u21E7\u2318M",custom:"\u21E7\u2318M"},jumpToParent:{default:"\u21E7\u2318J",custom:"\u21E7\u2318J"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"},duplicateCompletely:{default:"",custom:""},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},ai:{default:"",custom:""},switchReadonly:{default:"",custom:""},switchAdjust:{default:"",custom:""},rtl:{default:"",custom:""},ltr:{default:"",custom:""},aiWriting:{default:"",custom:""},openInNewTab:{default:"",custom:""}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},"ordered-list":{default:"",custom:""},list:{default:"",custom:""},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},quote:{default:"",custom:""},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"",custom:""},insertRowBelow:{default:"",custom:""},insertColumnLeft:{default:"",custom:""},insertColumnRight:{default:"",custom:""},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},I.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:232,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:232,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:232,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:232,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},I.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!0,aText:!0,aTitle:!0,aHref:!0,code:!0,em:!0,strong:!0,inlineMath:!0,inlineMemo:!0,blockRef:!0,fileAnnotationRef:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!0,mathBlock:!0,htmlBlock:!0},I.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,I.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],I.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a",".aac",".flac"],I.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],I.SIYUAN_ASSETS_EXTS=[".pdf"].concat(I.SIYUAN_ASSETS_IMAGE).concat(I.SIYUAN_ASSETS_AUDIO).concat(I.SIYUAN_ASSETS_VIDEO),I.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub",".cs"],I.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","cybertopia-cherry","cybertopia-dimmer","cybertopia-icecap","cybertopia-saturated","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","rose-pine","rose-pine-moon","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],I.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","1c-light","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","rose-pine-dawn","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],I.ZWSP="\u200B",I.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],I.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],I.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},I.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],I.SIYUAN_RENDER_CODE_LANGUAGES=["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"],I.PROTYLE_TOOLBAR=O()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"];let H=I;const ca=(e,t,a=!1)=>{let n=U(e,t,a),i=!1,s=!1;for(;n&&(a?n.tagName!=="BODY":!n.classList.contains("protyle-wysiwyg"))&&!s;)i=U(n.parentElement,t,a),i?n=i:s=!0;return n||!1},ae=(e,t)=>{let a=j(e,t),n=!1,i=!1;for(;a&&!a.classList.contains("protyle-wysiwyg")&&!i;)n=j(a.parentElement,t),n?a=n:i=!0;return a||!1},W=(e,t,a,n=!1)=>{let i=F(e,t,a,n),s=!1,o=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!o;)s=F(i.parentElement,t,a,n),s?i=s:o=!0;return i||!1},F=(e,t,a,n=!1)=>{var i;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let s=e,o=!1;for(;s&&!o&&(n?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)typeof a=="string"&&((i=s.getAttribute(t))!=null&&i.split(" ").includes(a))||typeof a!="string"&&s.hasAttribute(t)?o=!0:s=s.parentElement;return o&&s},j=(e,t)=>{if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let a=e,n=!1;for(;a&&!n&&!a.classList.contains("protyle-wysiwyg");)a.nodeName===t?n=!0:a=a.parentElement;return n&&a},U=(e,t,a=!1)=>{var n;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let i=e,s=!1;for(;i&&!s&&(a?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)(n=i.classList)!=null&&n.contains(t)?s=!0:i=i.parentElement;return s&&i},G=e=>{var t;const a=F(e,"data-node-id",null);return a&&a.tagName!=="BUTTON"&&((t=a.getAttribute("data-type"))!=null&&t.startsWith("Node"))?a:!1},Z=e=>{const t=W(e,"data-type","NodeBlockQueryEmbed");return t?t===e?!1:t:!1},fe=e=>U(e,"av__gallery-cover")?U(e,"av"):!1,de=(e,t=["edit","more"])=>{let a=!0;if(e){const n=e.getAttribute("data-readonly");if(typeof n=="string")a=n==="false";else return'<div class="protyle-icons"></div>'}return t.length===3?`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__reload"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit${a?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`:`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit${a?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last${a?"":" protyle-icon--first"}"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`},be=e=>{if(e.querySelector(".protyle-cursor"))return;const t=e.getAttribute("data-type");t==="NodeBlockQueryEmbed"?e.insertAdjacentHTML("afterbegin",`<div class="protyle-icons${Z(e)?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div><div class="protyle-cursor">${H.ZWSP}</div>`):(t==="NodeMathBlock"||e.getAttribute("data-subtype")==="math")&&(e.firstElementChild.innerHTML=`<span></span><span class="protyle-cursor">${H.ZWSP}</span>`)},_e=e=>(e.querySelectorAll("protyle-html").forEach(t=>{t.setAttribute("data-content",Lute.UnEscapeHTMLStr(t.getAttribute("data-content")))}),e),xe=(e,t=H.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="graphviz"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="graphviz"]')),a.length!==0&&oe(`${t}/js/graphviz/viz.js?v=3.11.0`,"protyleGraphVizScript").then(()=>{const n=U(e,"protyle-wysiwyg",!0);a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",de(n));const s=i.firstElementChild.nextElementSibling;if(!i.getAttribute("data-content")){s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span>`;return}try{Viz.instance().then(o=>{const l=o.renderSVGElement(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div contenteditable="false">${l.outerHTML}</div>`}).catch(o=>{s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${o}</div>`})}catch(o){console.error("Graphviz error",o)}i.setAttribute("data-render","true")})})},ot=e=>{let t=e;for(;t;){if(t.previousElementSibling&&t.previousElementSibling.getAttribute("data-node-id"))return t.previousElementSibling;const a=G(t.parentElement);if(a)t=a;else return!1}},rt=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).reverse().find(a=>{if(!isInEmbedBlock(a))return t=a,!0}),t||e},ct=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).find(a=>{if(!Z(a)&&!a.classList.contains("li")&&!a.classList.contains("sb"))return t=a,!0}),t||e},et=e=>{let t=e;for(;t;){if(t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr"))return t.nextElementSibling;const a=G(t.parentElement);if(a)t=a;else return!1}return!1},$e=e=>{let t=e;for(;t;)if(t.classList.contains("list")||t.classList.contains("li")||t.classList.contains("bq")||t.classList.contains("sb"))t=t.querySelector("[data-node-id]");else return t;return!1},Te=e=>{if(!e||e.getAttribute("contenteditable")==="true"&&!e.classList.contains("protyle-wysiwyg"))return e;const t=e.querySelector('[contenteditable="true"]');if(t&&!F(t,"data-type","NodeBlockQueryEmbed"))return t},dt=e=>{if(e.classList.contains("sb")){let t=!1;return Array.from(e.querySelectorAll("[data-node-id]")).find(a=>{if(!dt(a))return t=!0,!0}),!t}return["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(e.getAttribute("data-type"))||e.getAttribute("data-type")==="NodeCodeBlock"&&e.classList.contains("render-node")},Wt=e=>{var t,a;let n=e;for(;n.parentElement&&!n.parentElement.classList.contains("protyle-wysiwyg");)if(!n.parentElement.getAttribute("data-node-id"))n=n.parentElement;else{let i=!1;if(Array.from(n.parentElement.querySelectorAll('[contenteditable="true"]')).find(s=>{if(s.textContent.replace(Constants.ZWSP,"").replace(`
`,"")!=="")return i=!0,!0}),i||(t=n.previousElementSibling)!=null&&t.getAttribute("data-node-id")||(a=n.nextElementSibling)!=null&&a.getAttribute("data-node-id"))break;n=n.parentElement}return n},jt=e=>{if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=jt(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=jt(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=jt(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else{e=jt(e);break}return e},Ya=e=>{let t=e.nextSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.nextSibling;else return t;return!1},Or=e=>{if(e.endContainer.nodeType===3&&e.endContainer.textContent.length!==e.endOffset&&e.endContainer.textContent!==Constants.ZWSP&&e.endContainer.textContent!==`
`)return!1;let t=e.endContainer;for(e.endContainer.nodeType!==3&&(t=e.endContainer.childNodes[e.endOffset]);t;){if(Ya(t))return!1;if(t.parentElement.getAttribute("spellcheck"))return!0;t=t.parentElement}return!0},Vt=e=>{let t=e.previousSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.previousSibling;else return t;return!1},qr=e=>{let t=e.nextElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.firstElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.nextElementSibling)t=t.parentElement;else{if(t.nextElementSibling.tagName==="LI")return t.nextElementSibling;if(t.nextElementSibling.tagName==="UL")return t.nextElementSibling.firstElementChild}return!1},Ur=e=>{let t=e.previousElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.lastElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.previousElementSibling)t=t.parentElement;else{if(t.previousElementSibling.tagName==="LI")return t.previousElementSibling;if(t.previousElementSibling.tagName==="UL"){const a=t.previousElementSibling.querySelectorAll(".b3-list-item");return a[a.length-1]}}return!1},Oi=(e,t)=>{if(!t){if(getSelection().rangeCount===0)return!1;t=getSelection().getRangeAt(0)}const a=t.commonAncestorContainer;return e.isEqualNode(a)||e.contains(a)},qi=e=>{const t=F(e.startContainer,"data-type","NodeTable");if(e.toString()!==""&&t&&e.commonAncestorContainer.nodeType!==3){const a=e.commonAncestorContainer.tagName;if(a!=="TH"&&a!=="TD"){const n=j(e.startContainer,"TD")||j(e.startContainer,"TH"),i=j(e.endContainer,"TD")||j(e.endContainer,"TH");if(!n&&!i){const s=t.querySelector("th")||t.querySelector("td");e.setStart(s.firstChild,0),e.setEnd(s.lastChild,s.lastChild.textContent.length)}else n&&!n.contains(e.endContainer)&&ua(n,e,!1)}}},Fr=(e,t,a)=>{const n=getContenteditableElement(t);if(n){let o;if(n.tagName==="TABLE"){const l=hasClosestByTag(a.startContainer,"TD")||hasClosestByTag(a.startContainer,"TH");if(l&&(o=Wa(l,t,a),o.start!==0||o.end!==l.textContent.length))return a.setStart(l.firstChild,0),a.setEndAfter(l.lastChild),e.toolbar.render(e,a),countSelectWord(a,e.block.rootID),!0}else if(o=Wa(n,t,a),o.start!==0||o.end!==n.textContent.length){let l=n.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){a.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){a.setStartBefore(l);break}l=l.firstChild}let r=n.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){a.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){a.setEndAfter(r);break}r=r.lastChild}return He(a),e.toolbar.render(e,a),countSelectWord(a,e.block.rootID),!0}}a.collapse(!0);const i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.wysiwyg.element.childElementCount===i.length&&i[0].parentElement===e.wysiwyg.element)return!0;hideElements(["select"],e);const s=[];Array.from(e.wysiwyg.element.children).forEach(o=>{const l=o.getAttribute("data-node-id");l&&(o.classList.add("protyle-wysiwyg--select"),s.push(l))}),countBlockWord(s,e.block.rootID)},Yr=(e,t)=>{const a=document.caretRangeFromPoint(e,t),n=hasClosestByAttribute(a.startContainer,"data-type","img");return n&&(a.setStart(n.nextSibling,0),a.collapse()),a},ut=e=>{var t,a,n;let i;if(getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),e===i.startContainer||e.contains(i.startContainer))){if(i.toString()===""&&i.startContainer.nodeType===1){if(i.startOffset===0&&i.startContainer.classList.contains("protyle-wysiwyg")){const o=Ae(i.startContainer.firstChild);if(o)return o}if(i.startContainer.getAttribute("contenteditable")!=="true"&&Te(i.startContainer)){const o=G(i.startContainer);if(o){const l=Ae(o);if(l)return l}}}return i}if(e.classList.contains("li")||e.classList.contains("list")){const o=e.querySelector("[data-node-id]");if(o)return ut(o)}e.focus({preventScroll:!0}),i||(i=document.createRange());let s;if(e.classList.contains("table"))s=e.querySelector("th")||e.querySelector("td");else if(s=Te(e),s)s.tagName==="TABLE"&&(s=s.querySelector("th")||e.querySelector("td"));else{const o=e.getAttribute("data-type");o==="NodeThematicBreak"?s=e.firstElementChild:o==="NodeBlockQueryEmbed"?s=(t=e.querySelector(".protyle-cursor"))==null?void 0:t.firstChild:["NodeMathBlock","NodeHTMLBlock"].includes(o)?s=(n=(a=e.lastElementChild.previousElementSibling)==null?void 0:a.lastElementChild)==null?void 0:n.firstChild:o==="NodeVideo"?s=e.firstElementChild.firstChild:o==="NodeAudio"&&(s=e.firstElementChild.lastChild)}return i.setStart(s||e,0),i.collapse(!0),i},Wr=(e,t,a=!1)=>{var n,i;if(t||(t=ut(e)),!e.contains(t.startContainer))return{left:0,top:0};let s;if(t.getClientRects().length===0)if(t.startContainer.nodeType===3){const o=(n=t.startContainer.parentElement)==null?void 0:n.getClientRects(),l=(i=t.startContainer.previousElementSibling)==null?void 0:i.getClientRects();if(o.length>0||l.length>0)o.length===0||l&&l.length>0&&o[0].top<l[l.length-1].bottom?s={left:l[l.length-1].left,top:l[l.length-1].bottom}:s=o[0];else return{left:0,top:0}}else{const o=t.startContainer.children;if(o[t.startOffset]&&o[t.startOffset].getClientRects().length>0)s=o[t.startOffset].getClientRects()[0];else if(t.startContainer.childNodes.length>0){const l=t.cloneRange();t.selectNode(t.startContainer.childNodes[Math.max(0,t.startOffset-1)]),s=t.getClientRects()[0],t.setEnd(l.endContainer,l.endOffset),t.setStart(l.startContainer,l.startOffset)}else s=t.startContainer.getClientRects()[0];if(!s){let l=t.startContainer.childNodes[t.startOffset];if(l||(l=t.startContainer.childNodes[t.startOffset-1]),!l)s=t.getBoundingClientRect();else{for(;!l.getClientRects||l.getClientRects&&l.getClientRects().length===0;)l=l.parentElement;s=l.getClientRects()[0]}}}else{const o=t.getClientRects();if(t.toString())if(a){const l=window.getSelection(),r=l&&"direction"in l&&l.direction!=="none"?l.direction==="backward":t.startContainer===(l==null?void 0:l.focusNode)&&t.startOffset===(l==null?void 0:l.focusOffset),c=!r&&o[0].top!==o[o.length-1].top;return{left:r?o[0].left:o[o.length-1].right,top:c?o[o.length-1].bottom:o[0].top,isBottom:c}}else return{left:o[o.length-1].left,top:o[0].top};else return{left:o[o.length-1].left,top:o[o.length-1].top}}return{left:s.left,top:s.top}},Wa=(e,t,a)=>{const n={end:0,start:0};if(!a){if(getSelection().rangeCount===0)return n;a=window.getSelection().getRangeAt(0)}if(t&&!Oi(t,a))return n;const i=a.cloneRange();return e.childNodes[0]&&e.childNodes[0].childNodes[0]?i.setStart(e.childNodes[0].childNodes[0],0):i.selectNodeContents(e),i.setEnd(a.startContainer,a.startOffset),n.start=i.toString().length+i.cloneContents().querySelectorAll("br").length,n.end=n.start+a.toString().length+a.cloneContents().querySelectorAll("br").length,n};function da(e,t,a,n){if(!t)return!1;if(a(t))return!0;for(let i=0,s=t.childNodes.length;i<s;i++)if(da(t,t.childNodes[i],a,!0))return!0;if(!n){let i=t;for(;i&&i!==e;){let s=i.nextSibling;for(;s;){if(da(e,s,a,!0))return!0;s=s.nextSibling}i=i.parentNode}}return!1}const ua=(e,t,a=!0)=>{if(!e)return t;let n=e.lastChild;for(;n&&n.nodeType!==3&&n.lastChild;)n=n.lastChild;return n||(n=e),a?n.nodeType!==3&&(n.classList.contains("render-node")||n.tagName==="BR")&&n.innerHTML===""?t.setStartAfter(n):t.setStart(n,n.textContent.length):n.nodeType!==3&&(n.classList.contains("render-node")||n.tagName==="BR")&&n.innerHTML===""?t.setEndAfter(n):t.setEnd(n,n.textContent.length),t},Ui=(e,t)=>{if(!e)return t;let a=e.firstChild;for(;a&&a.nodeType!==3&&!a.classList.contains("render-node");){if(a.classList.contains("img"))return t.setStartBefore(a),t;a=a.firstChild}return a?(a.nodeType!==3&&a.classList.contains("render-node")?t.setStartBefore(a):t.setStart(a,0),t):(t.selectNodeContents(e),t)},ja=(e,t,a,n=!0)=>{if(!e)return!1;const i=Te(e);if(i)e=i;else if(n&&(dt(e)||e.classList.contains("av")))return Ae(e);let s;da(e,e.firstChild,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return t<=c?(s=r,!0):(t-=c,a-=c,!1)}else if(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="BR")return t<=1?(s=r,!0):(t-=1,a-=1,!1)});let o;s&&da(e,s,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return a<=c?(o=r,!0):(a-=c,!1)}});const l=document.createRange();return s?s.nodeType===Node.TEXT_NODE&&t<=s.data.length?l.setStart(s,t):l.setStartAfter(s):t===0?l.setStart(e,0):ua(Te(e),l),o?a<=o.data.length?l.setEnd(o,a):l.setEndAfter(o):a===0?l.setEnd(e,0):ua(Te(e),l,!1),n&&He(l),l},jr=(e,t,a)=>{const n=getContenteditableElement(e);if(!n)return;const i=Wa(n,e,t),s=e.cloneNode(!0),o=ja(s,i.end,i.end,!1);o&&o.insertNode(document.createElement("wbr")),a.wysiwyg.lastHTMLs[e.getAttribute("data-node-id")]=s.outerHTML},Va=(e,t)=>{var a;const n=e.querySelectorAll("wbr");if(n.length===0)return;n.forEach((s,o)=>{o!==0&&s.remove()});const i=n[0];if(!i.previousElementSibling)i.previousSibling?t.setStart(i.previousSibling,i.previousSibling.textContent.length):i.nextSibling?i.nextSibling.nodeType===3?t.setStart(i.nextSibling,0):t.setStartAfter(i):t.setStart(i.parentElement,0);else{const s=Vt(i);s&&i.previousElementSibling===s?((a=i.previousElementSibling.lastChild)==null?void 0:a.nodeType)===3?t.setStart(i.previousElementSibling.lastChild,i.previousElementSibling.lastChild.textContent.length):s.nodeType!==3&&s.classList.contains("img")?t.setStartAfter(s):t.setStartBefore(i):t.setStart(i.previousSibling,i.previousSibling.textContent.length)}t.collapse(!0),i.remove(),He(t)},He=e=>{if(!e)return;const t=e.startContainer.childNodes[e.startOffset];if(t&&t.nodeType!==3&&["INPUT","TEXTAREA"].includes(t.tagName)){t.focus();return}const a=window.getSelection();a.removeAllRanges(),a.addRange(e)},Ae=(e,t,a=!0)=>{if(!e)return!1;if(e.classList.contains("render-node")||e.classList.contains("iframe")||e.classList.contains("hr")||e.classList.contains("av")){const i=document.createRange(),s=e.getAttribute("data-type");let o=!1;if(s==="NodeThematicBreak")i.selectNodeContents(e.firstElementChild),o=!0;else if(s==="NodeBlockQueryEmbed")be(e),i.setStart(e.querySelector(".protyle-cursor").firstChild,0),i.collapse(!0),o=!0;else if(s==="NodeMathBlock")be(e),i.setStart(e.firstElementChild.lastElementChild.firstChild,0),o=!0;else if(s==="NodeHTMLBlock")i.setStart(e.lastElementChild.previousElementSibling.lastElementChild.firstChild,0),i.collapse(!0),o=!0;else if(s==="NodeIFrame"||s==="NodeWidget")i.setStart(e,0),o=!0;else if(s==="NodeVideo")i.setStart(e.firstElementChild.firstChild,0),o=!0;else if(s==="NodeAudio")i.setStart(e.firstElementChild.lastChild,0),o=!0;else if(s==="NodeCodeBlock")i.selectNodeContents(e),i.collapse(!0),o=!0;else if(s==="NodeAttributeView")return!1;return o?(He(i),i):(Fi(e),!1)}let n;if(a?n=Te(e):Array.from(e.querySelectorAll('[contenteditable="true"]')).reverse().find(i=>{if(i.getBoundingClientRect().width>0)return n=i,!0}),n){if(n.tagName==="TABLE")if(a)n=n.querySelector("th, td");else{const s=n.querySelectorAll("th, td");n=s[s.length-1]}let i;if(a)i=Ui(n,ut(n)),i.collapse(!0);else{let s=!1;if(e.getAttribute("data-type")==="NodeCodeBlock"){let o=n.lastChild;if(o||(n.innerHTML=`
`,o=n.lastChild),o.textContent===""&&o.nodeType===3&&(o=Vt(n.lastChild)),o&&o.textContent.endsWith(`
`)){if(o.nodeType===1)for(o=o.lastChild;o&&o.textContent.indexOf(`
`)===-1;)o=o.previousSibling;i=ut(n),i.setStart(o,o.textContent.length-1),s=!0}}s||(i=ua(n,ut(n))),i.collapse(!1)}return He(i),i}else if(t)t.focus();else if(e.classList.contains("li"))return Ae(e.querySelector("[data-node-id]"),t,a);return!1},Fi=e=>{if(e.getAttribute("data-node-id")){let a,n;e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr")?(n=!0,a=et(e)):e.previousElementSibling&&(n=!1,a=ot(e)),a||(a=e),Ae(a,void 0,n);return}const t=ut(e);e.nextSibling?(t.selectNodeContents(e.nextSibling),t.collapse(!0)):e.previousSibling&&(t.selectNodeContents(e.previousSibling),t.collapse(!1)),He(t)},Ga=(e,t)=>{if(!document.getElementById(t)){const a=document.createElement("link");a.id=t,a.rel="stylesheet",a.type="text/css",a.href=e;const n=document.querySelector("#pluginsStyle");n?n.before(a):document.getElementsByTagName("head")[0].appendChild(a)}},Gn=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),Vr=()=>{const e=document.getElementById("message");e.innerHTML='<div class="fn__flex-1"></div>',e.addEventListener("click",t=>{let a=t.target;for(;a&&!a.isEqualNode(e);){if(a.classList.contains("b3-snackbar__close")){yt(a.parentElement.getAttribute("data-id")),t.preventDefault();break}else{if(a.tagName==="A"||a.tagName==="BUTTON")break;if(a.classList.contains("b3-snackbar")){(getSelection().rangeCount===0||!getSelection().getRangeAt(0).toString())&&yt(a.getAttribute("data-id")),t.preventDefault(),t.stopPropagation();break}}a=a.parentElement}}),document.querySelectorAll("#tempMessage > div").forEach(t=>{tt(t.innerHTML,parseInt(t.getAttribute("data-timeout")),t.getAttribute("data-type"),t.getAttribute("data-message-id")),t.remove()})},tt=(e,t=6e3,a="info",n)=>{const i=document.getElementById("message").firstElementChild;if(!i){let c=document.getElementById("tempMessage");c||(document.body.insertAdjacentHTML("beforeend",`<div style="font-size: 14px;top: 22px;position: fixed;z-index: 100;right: 30px;line-height: 20px;word-break: break-word;display: flex;flex-direction: column;align-items: flex-end;" 
id="tempMessage"></div>`),c=document.getElementById("tempMessage")),c.insertAdjacentHTML("beforeend",`<div style="background: white;padding: 8px 16px;border-radius: 6px;margin-bottom: 16px;"  
data-timeout="${t}" 
data-type="${a}" 
data-message-id="${n||""}">${e}</div>`);return}const s=n||Gn(),o=i.querySelector(`.b3-snackbar[data-id="${s}"]`),l=e+(a==="error"?" v"+H.SIYUAN_VERSION:"");if(o){if(window.clearTimeout(parseInt(o.getAttribute("data-timeoutid"))),o.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>${t===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,a==="error"?o.classList.add("b3-snackbar--error"):o.classList.remove("b3-snackbar--error"),t>0){const c=window.setTimeout(()=>{yt(s)},t);o.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${s}" class="b3-snackbar--hide b3-snackbar${a==="error"?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>`;if(t===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(t!==-1){const c=window.setTimeout(()=>{yt(s)},t);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return i.parentElement.classList.add("b3-snackbars--show"),i.parentElement.style.zIndex=(++window.siyuan.zIndex).toString(),i.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),i.firstElementChild.nextElementSibling&&i.firstElementChild.nextElementSibling.innerHTML===i.firstElementChild.innerHTML&&i.firstElementChild.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),s},yt=e=>{const t=document.getElementById("message").firstElementChild;if(t)if(e){const a=t.querySelector(`[data-id="${e}"]`);a&&(a.classList.add("b3-snackbar--hide"),window.clearTimeout(parseInt(a.getAttribute("data-timeoutid"))),setTimeout(()=>{a.remove(),t.childElementCount===0&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},H.TIMEOUT_INPUT));let n=!1;Array.from(t.children).find(i=>{if(!i.classList.contains("b3-snackbar--hide"))return n=!0,!0}),n?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},H.TIMEOUT_INPUT)};var za=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Gr=e=>{if(typeof Buffer!="undefined")return Buffer.from(e,"utf8").toString("base64");{const a=new TextEncoder().encode(e);let n="";const i=32768;for(let s=0;s<a.length;s+=i){const o=a.subarray(s,Math.min(s+i,a.length));n+=String.fromCharCode(...o)}return btoa(n)}},Ka=e=>{const t=e.match(/<!--data-siyuan='([^']+)'-->/);let a="",n=e;if(t)try{if(typeof Buffer!="undefined")a=Buffer.from(t[1],"base64").toString("utf8");else{const i=new TextDecoder,s=Uint8Array.from(atob(t[1]),o=>o.charCodeAt(0));a=i.decode(s)}n=e.replace(/<!--data-siyuan='[^']+'-->/,"")}catch(i){console.log("Failed to decode siyuan data from HTML comment:",i)}return{textSiyuan:a,textHtml:n}},zn=e=>{if(e)if(Mt())if(e.startsWith("assets/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+"/assets/"+encodeURIComponent(e.replace("assets/","")));else if(e.startsWith("/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+e);else try{new URL(e),window.webkit.messageHandlers.openLink.postMessage(e)}catch(t){window.webkit.messageHandlers.openLink.postMessage("https://"+e)}else Ve()?window.JSAndroid.openExternal(e):ft()?window.JSHarmony.openExternal(e):window.open(e)},Yi=e=>{e&&(Mt()?zn(e):Ve()?window.JSAndroid.exportByDefault(e):ft()?window.JSHarmony.exportByDefault(e):window.open(e))},zr=()=>Ve()?window.JSAndroid.readClipboard():ft()?window.JSHarmony.readClipboard():typeof navigator.clipboard=="undefined"?(alert(window.siyuan.languages.clipboardPermissionDenied),""):navigator.clipboard.readText().catch(()=>{alert(window.siyuan.languages.clipboardPermissionDenied)})||"",Wi=()=>za(void 0,null,function*(){const e={textPlain:"",textHTML:"",siyuanHTML:""};if(Ve()){e.textPlain=window.JSAndroid.readClipboard(),e.textHTML=window.JSAndroid.readHTMLClipboard();const t=Ka(e.textHTML);return e.textHTML=t.textHtml,e.siyuanHTML=t.textSiyuan,e}if(ft()){e.textPlain=window.JSHarmony.readClipboard(),e.textHTML=window.JSHarmony.readHTMLClipboard();const t=Ka(e.textHTML);return e.textHTML=t.textHtml,e.siyuanHTML=t.textSiyuan,e}if(typeof navigator.clipboard=="undefined")return alert(window.siyuan.languages.clipboardPermissionDenied),e;try{const t=yield navigator.clipboard.read().catch(()=>{alert(window.siyuan.languages.clipboardPermissionDenied)});if(!t)return e;for(const a of t){if(a.types.includes("text/html")){const n=yield a.getType("text/html");e.textHTML=yield n.text();const i=Ka(e.textHTML);e.textHTML=i.textHtml,e.siyuanHTML=i.textSiyuan}if(a.types.includes("text/plain")){const n=yield a.getType("text/plain");e.textPlain=yield n.text()}if(a.types.includes("image/png")){const n=yield a.getType("image/png");e.files=[new File([n],"image.png",{type:"image/png",lastModified:Date.now()})]}}return e}catch(t){return e}}),Za=e=>{let t;getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0).cloneRange());try{if(Ve()){window.JSAndroid.writeClipboard(e);return}if(ft()){window.JSHarmony.writeClipboard(e);return}if(Mt()){window.webkit.messageHandlers.setClipboard.postMessage(e);return}navigator.clipboard.writeText(e)}catch(a){if(Mt())window.webkit.messageHandlers.setClipboard.postMessage(e);else if(Ve())window.JSAndroid.writeClipboard(e);else if(ft())window.JSHarmony.writeClipboard(e);else{const n=document.createElement("textarea");n.value=e,n.style.position="fixed",document.body.appendChild(n),n.focus(),n.select(),document.execCommand("copy"),document.body.removeChild(n),t&&He(t)}}},Kr=e=>za(void 0,null,function*(){e=e.replace(new RegExp(Constants.ZWSP,"g"),""),yield Za(e)}),ji=()=>Gi()?"touchstart":"click",Zr=e=>Kn()?!!(e.metaKey&&!e.ctrlKey):!!(!e.metaKey&&e.ctrlKey),Vi=e=>!e.metaKey&&!e.ctrlKey,Xr=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,Jr=e=>{var t;return((t=window.siyuan.config.system.disabledFeatures)==null?void 0:t.indexOf(e))>-1},Gi=()=>navigator.userAgent.indexOf("iPhone")>-1,Qr=()=>{const e=navigator.userAgent;return e.includes("Safari")&&!e.includes("Chrome")&&!e.includes("Chromium")},ec=()=>navigator.userAgent.indexOf("iPad")>-1,Kn=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,tc=()=>za(void 0,null,function*(){if(!navigator.userAgentData||!navigator.userAgentData.getHighEntropyValues)return!1;const e=yield navigator.userAgentData.getHighEntropyValues(["platformVersion"]);return navigator.userAgentData.platform==="Windows"&&parseInt(e.platformVersion.split(".")[0])>=13}),ac=()=>Ve()?window.JSAndroid.getScreenWidthPx():ft()?window.JSHarmony.getScreenWidthPx():window.outerWidth,nc=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,Ve=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Mt=()=>{var e;return window.siyuan.config.system.container==="ios"&&((e=window.webkit)==null?void 0:e.messageHandlers)},ft=()=>window.siyuan.config.system.container==="harmony"&&window.JSHarmony,sc=e=>e?" "+fa(e):"",fa=e=>{if(Kn())return e;const t=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),a=[];(e.indexOf("\u2318")>-1||e.indexOf("\u2303")>-1)&&a.push(t.get("\u2318")),e.indexOf("\u21E7")>-1&&a.push(t.get("\u21E7")),e.indexOf("\u2325")>-1&&a.push(t.get("\u2325"));const n=e.replace(/⌘|⇧|⌥|⌃/g,"");return n&&a.push(t.get(n)||n),a.join("+")},ic=e=>{fetchPost("/api/storage/getLocalStorage",void 0,t=>{window.siyuan.storage=t.data;const a={};a[Constants.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},a[Constants.LOCAL_SEARCHUNREF]={col:"",row:"",layout:0},Constants.SIYUAN_ASSETS_SEARCH.forEach(n=>{a[Constants.LOCAL_SEARCHASSET].types[n]=!0}),a[Constants.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},a[Constants.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},a[Constants.LOCAL_LAYOUTS]=[],a[Constants.LOCAL_AI]=[],a[Constants.LOCAL_PLUGIN_DOCKS]={},a[Constants.LOCAL_PLUGINTOPUNPIN]=[],a[Constants.LOCAL_OUTLINE]={keepCurrentExpand:!1},a[Constants.LOCAL_FILEPOSITION]={},a[Constants.LOCAL_DIALOGPOSITION]={},a[Constants.LOCAL_HISTORY]={notebookId:"%",type:0,operation:"all",sideWidth:"256px",sideDocWidth:"256px",sideDiffWidth:"256px"},a[Constants.LOCAL_FLASHCARD]={fullscreen:!1},a[Constants.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},a[Constants.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},a[Constants.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},a[Constants.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},a[Constants.LOCAL_DOCINFO]={id:""},a[Constants.LOCAL_IMAGES]={file:"1f4c4",note:"1f5c3",folder:"1f4d1"},a[Constants.LOCAL_EMOJIS]={currentTab:"emoji"},a[Constants.LOCAL_FONTSTYLES]=[],a[Constants.LOCAL_FILESPATHS]=[],a[Constants.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},a[Constants.LOCAL_ZOOM]=1,a[Constants.LOCAL_MOVE_PATH]={keys:[],k:""},a[Constants.LOCAL_RECENT_DOCS]={type:"viewedAt"},[Constants.LOCAL_EXPORTIMG,Constants.LOCAL_SEARCHKEYS,Constants.LOCAL_PDFTHEME,Constants.LOCAL_BAZAAR,Constants.LOCAL_EXPORTWORD,Constants.LOCAL_EXPORTPDF,Constants.LOCAL_DOCINFO,Constants.LOCAL_FONTSTYLES,Constants.LOCAL_SEARCHDATA,Constants.LOCAL_ZOOM,Constants.LOCAL_LAYOUTS,Constants.LOCAL_AI,Constants.LOCAL_PLUGINTOPUNPIN,Constants.LOCAL_SEARCHASSET,Constants.LOCAL_FLASHCARD,Constants.LOCAL_DIALOGPOSITION,Constants.LOCAL_SEARCHUNREF,Constants.LOCAL_HISTORY,Constants.LOCAL_OUTLINE,Constants.LOCAL_FILEPOSITION,Constants.LOCAL_FILESPATHS,Constants.LOCAL_IMAGES,Constants.LOCAL_PLUGIN_DOCKS,Constants.LOCAL_EMOJIS,Constants.LOCAL_MOVE_PATH,Constants.LOCAL_RECENT_DOCS].forEach(n=>{if(typeof t.data[n]=="string")try{const i=JSON.parse(t.data[n]);typeof i=="number"?window.siyuan.storage[n]=i:window.siyuan.storage[n]=Object.assign(a[n],i)}catch(i){window.siyuan.storage[n]=a[n]}else typeof t.data[n]=="undefined"&&(window.siyuan.storage[n]=a[n])}),(!window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)),e()})},Xa=(e,t,a)=>{window.siyuan.config.readonly||window.siyuan.isPublish||Ce("/api/storage/setLocalStorageVal",{app:H.SIYUAN_APPID,key:e,val:t},()=>{a&&a()})},Zn=e=>{var t,a,n;if(e.cmd==="msg"){const i=tt(e.msg,e.data.closeTimeout,e.code===0?"info":"error",e.data.id);return(t=document.querySelector("#message #addMicrosoftDefenderExclusion"))==null||t.addEventListener("click",s=>{s.target.innerHTML='<svg class="fn__rotate" style="margin-right: 0;"><use xlink:href="#iconRefresh"></use></svg>',Ce("/api/system/addMicrosoftDefenderExclusion",{},()=>{yt(i)})},{once:!0}),(a=document.querySelector("#message #ignoreAddMicrosoftDefenderExclusion"))==null||a.addEventListener("click",()=>{yt(i),Ce("/api/system/ignoreAddMicrosoftDefenderExclusion")},{once:!0}),!1}if(e.cmd==="cmsg")return yt(e.data.id),!1;if(e.cmd==="cprogress"){const i=document.getElementById("progress");return i&&i.remove(),!1}return e.cmd==="reloadui"?((n=e.data)!=null&&n.resetScroll?(window.siyuan.storage[H.LOCAL_FILEPOSITION]={},Xa(H.LOCAL_FILEPOSITION,window.siyuan.storage[H.LOCAL_FILEPOSITION],()=>{window.location.reload()})):window.location.reload(),!1):e.code<0?(tt(e.msg,e.data&&e.data.closeTimeout||0,e.code===-1?"error":"info"),!1):e};class Xn{constructor(t){this.disableClose=t.disableClose,this.id=Gn(),window.siyuan.dialogs.push(this),this.destroyCallback=t.destroyCallback,this.element=document.createElement("div");let a,n;if(!O()&&t.positionId){const i=window.siyuan.storage[H.LOCAL_DIALOGPOSITION][t.positionId];i&&i.left+i.width+34<=window.innerWidth&&i.top+i.height<=window.innerHeight&&(a=i.left+"px",n=i.top+"px",t.width=i.width+"px",t.height=i.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof a=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${t.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container ${t.containerClassName||""}" style="width:${t.width||"auto"};height:${t.height||"auto"};
left:${a||"auto"};top:${n||"auto"}">
  <svg ${O()&&t.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||t.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${t.title?"":" fn__none"}" onselectstart="return false;">${t.title||""}</div>
  <div class="b3-dialog__body">${t.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",i=>{this.disableClose||this.destroy(),i.preventDefault(),i.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",i=>{this.destroy(),i.preventDefault(),i.stopPropagation()}),document.body.append(this.element),t.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")},H.TIMEOUT_OPENDIALOG)}destroy(t){this.element.classList.remove("b3-dialog--open"),setTimeout(()=>{var a;this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(t),window.siyuan.dialogs.find((n,i)=>{if(n.id===this.id)return window.siyuan.dialogs.splice(i,1),!0}),(a=document.getElementById("drag"))==null||a.classList.remove("fn__hidden")},H.TIMEOUT_DBLCLICK)}bindInput(t,a,n=!0){t.focus();let i;t.addEventListener("keydown",s=>{if(s.isComposing||s.repeat){s.preventDefault();return}if(s.key==="Escape"){this.destroy(),s.preventDefault(),s.stopPropagation();return}if(!s.shiftKey&&Vi(s)&&s.key==="Enter"&&a&&n){if(i&&s.timeStamp-i<124)return;i=s.timeStamp,a(),s.preventDefault(),s.stopPropagation()}})}}const lc=(e,t,a,n,i=!1)=>{if(!t&&!e){a();return}const s=new Dialog({title:e,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${t}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel" id="cancelDialogConfirmBtn">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button ${i?"b3-button--remove":"b3-button--text"}" id="confirmDialogConfirmBtn">${window.siyuan.languages[i?"delete":"confirm"]}</button>
</div>`,width:isMobile()?"92vw":"520px"});s.element.addEventListener("click",o=>{let l=o.target;const r=typeof o.detail=="string";for(;l&&l!==s.element||r;){if(l.id==="cancelDialogConfirmBtn"||r&&o.detail==="Escape"){n&&n(s),s.destroy();break}else if(l.id==="confirmDialogConfirmBtn"||r&&o.detail==="Enter"){a&&a(s),s.destroy();break}l=l.parentElement}}),s.element.setAttribute("data-key",Constants.DIALOG_CONFIRM)};var Ja=Oe(101);const oc=(e,t,a,n=0,i=0)=>{e.style.top=a+"px",e.style.left=t+"px";const s=e.getBoundingClientRect();if(s.bottom>window.innerHeight||s.top<Constants.SIZE_TOOLBAR_HEIGHT){const o=a-s.height-n;o>Constants.SIZE_TOOLBAR_HEIGHT&&o+s.height<window.innerHeight?e.style.top=o+"px":o<=Constants.SIZE_TOOLBAR_HEIGHT?e.style.top=Constants.SIZE_TOOLBAR_HEIGHT+"px":e.style.top=Math.max(Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-s.height)+"px"}s.right>window.innerWidth?e.style.left=`${window.innerWidth-s.width-i}px`:s.left<0&&(e.style.left="0")};var at=Oe(232);const zi=()=>{const e=window.siyuan.emojis[getRandom(0,window.siyuan.emojis.length-1)];return typeof e.items[getRandom(0,e.items.length-1)]=="undefined"?"1f600":e.items[getRandom(0,e.items.length-1)].unicode},ve=(e,t="",a=!1,n=!1)=>{if(!e)return"";let i="";if(e.startsWith("api/icon/getDynamicIcon"))i=`<img class="${t}" ${n?"data-":""}src="${e}"/>`;else if(e.indexOf(".")>-1)i=`<img class="${t}" ${n?"data-":""}src="/emojis/${e}"/>`;else try{e.split("-").forEach(s=>{s.length<5?i+=String.fromCodePoint(parseInt("0"+s,16)):i+=String.fromCodePoint(parseInt(s,16))}),a&&(i=`<span class="${t}">${i}</span>`)}catch(s){}return i},Qa=e=>{const t=new IntersectionObserver(a=>{a.forEach(n=>{const i=n.target.getAttribute("data-index");if((typeof n.isIntersecting=="undefined"?n.intersectionRatio!==0:n.isIntersecting)&&i){let s="";window.siyuan.emojis[parseInt(i)].items.forEach(o=>{s+=`<button data-unicode="${o.unicode}" class="emojis__item ariaLabel" aria-label="${Ht(o)}">
${ve(o.unicode)}</button>`}),n.target.innerHTML=s,n.target.removeAttribute("data-index"),n.target.style.minHeight=""}})});e.querySelectorAll(".emojis__content").forEach(a=>{t.observe(a)})},en=e=>{const t=new IntersectionObserver(a=>{a.forEach(n=>{const i=n.target.getAttribute("data-src");(typeof n.isIntersecting=="undefined"?n.intersectionRatio!==0:n.isIntersecting)&&i&&(n.target.src=i,n.target.removeAttribute("data-src"))})});e.querySelectorAll("img").forEach(a=>{t.observe(a)})},tn=(e="",t)=>{let a="";const n=[];e&&(a=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let i=0,s="";const o=[];window.siyuan.emojis.forEach((r,c)=>{e||(a+=`<div class="emojis__title" data-type="${c+1}">${Ge(c)}</div><div style="min-height:${c===0?"30px":"300px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!e&&(a+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(u=>{if(e){if(window.siyuan.config.editor.emoji.includes(u.unicode)&&(ve(u.unicode)===e||u.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||u.description.toLowerCase().indexOf(e.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||u.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&n.push(u),t&&i>t)return;(ve(u.unicode)===e||u.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||u.description.toLowerCase().indexOf(e.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||u.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&(r.id==="custom"?o.push(u):s+=`<button data-unicode="${u.unicode}" class="emojis__item ariaLabel" aria-label="${Ht(u)}">
${ve(u.unicode,void 0,!1,!0)}</button>`,i++)}else window.siyuan.config.editor.emoji.includes(u.unicode)&&n.push(u),c<2&&(a+=`<button data-unicode="${u.unicode}" class="emojis__item ariaLabel" aria-label="${Ht(u)}">
${ve(u.unicode,void 0,!1,!0)}</button>`)}),e||(a+="</div>")}),e&&(o.sort((r,c)=>{const u=r.keywords.split("/"),g=c.keywords.split("/");return u[u.length-1].toLowerCase().indexOf(e.toLowerCase())<g[g.length-1].toLowerCase().indexOf(e.toLowerCase())?-1:0}).sort((r,c)=>{const u=r.keywords.split("/"),g=c.keywords.split("/");return u[u.length-1].toLowerCase().indexOf(e.toLowerCase())===g[g.length-1].toLowerCase().indexOf(e.toLowerCase())&&u[u.length-1].length<g[g.length-1].length?-1:0}).forEach(r=>{a+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${Ht(r)}">
${ve(r.unicode,void 0,!1,!0)}</button>`}),a=a+s+"</div>");let l="";return n.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=n.filter(u=>u.unicode===r);c[0]&&(l+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${Ht(c[0])}">
${ve(c[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+a===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+a},ga=e=>{window.siyuan.config.editor.emoji.unshift(e),window.siyuan.config.editor.emoji.length>Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),fetchPost("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},Jn=(e,t)=>{const a={1:["Sun","\u5468\u65E5","\u9031\u65E5"],2:["SUN","\u5468\u5929","\u9031\u5929"],3:["Sunday","\u661F\u671F\u65E5","\u661F\u671F\u65E5"],4:["SUNDAY","\u661F\u671F\u5929","\u661F\u671F\u5929"]};let n=0;return e===""&&(e=window.siyuan.config.lang),e==="zh_CN"?n=1:e==="zh_CHT"&&(n=2),`<option value="1" ${t==="1"?" selected":""}>${a[1][n]}</option>
<option value="2" ${t==="2"?" selected":""}>${a[2][n]}</option>
<option value="3" ${t==="3"?" selected":""}>${a[3][n]}</option>
<option value="4" ${t==="4"?" selected":""}>${a[4][n]}</option>`},Qn=(e,t)=>{if(!e)return;let a="";window.siyuan.emojis[parseInt(e)].items.forEach(n=>{a+=`<button data-unicode="${n.unicode}" class="emojis__item ariaLabel" aria-label="${Ht(n)}">${ve(n.unicode)}</button>`}),t.innerHTML=a,t.removeAttribute("data-index"),t.removeAttribute("style")},rc=(e,t,a,n,i)=>{t!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const s="api/icon/getDynamicIcon?",o={color:"#d23f31",lang:"",date:dayjs().format("YYYY-MM-DD"),weekdayType:"1",type:"1",content:"SiYuan"};if(i&&i.getAttribute("src").startsWith(s)){const p=new URLSearchParams(i.getAttribute("src").replace(s,""));o.color=p.get("color")||"#d23f31",o.color.startsWith("#")||(o.color="#"+o.color),o.lang=p.get("lang")||"",o.date=p.get("date")||"",o.weekdayType=p.get("weekdayType")||"1",o.type=p.get("type")||"1",o.content=p.get("content")||"SiYuan"}const l=new Dialog({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:isMobile()?"80vw":"368px",height:"50vh",content:`<div class="emojis">
    <div class="emojis__tabheader">
        <div data-type="tab-emoji" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.emoji}"><svg><use xlink:href="#iconEmoji"></use></svg></div>
        <div class="fn__space"></div>
        <div data-type="tab-dynamic" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicIcon}"><svg><use xlink:href="#iconCalendar"></use></svg></div>
        <div class="fn__flex-1"></div>
        <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="emojis__tabbody">
        <div class="fn__none" data-type="tab-emoji">
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
                    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                    <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
                </label>
                <span class="fn__space"></span>
                <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="emojis__panel">${tn()}</div>
            <div class="fn__flex">
                ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",Ge(0)],["1f60d",Ge(1)],["1f433",Ge(2)],["1f96a",Ge(3)],["1f3a8",Ge(4)],["1f3dd-fe0f",Ge(5)],["1f52e",Ge(6)],["267e-fe0f",Ge(7)],["1f6a9",Ge(8)]].map(([p,y],_)=>`<div data-type="${_}" class="emojis__type ariaLabel" aria-label="${y}">${ve(p)}</div>`).join("")}
            </div>
        </div>
        <div class="fn__none" data-type="tab-dynamic">
            <div class="fn__flex emoji__dynamic-color">
                <div class="color__square fn__pointer${o.color==="#d23f31"?" color__square--current":""}" style="background-color:#d23f31"></div>
                <div class="color__square fn__pointer${o.color==="#3575f0"?" color__square--current":""}" style="background-color:#3575f0"></div>
                <div class="color__square fn__pointer${o.color==="#f3a92f"?" color__square--current":""}" style="background-color:#f3a92f"></div>
                <div class="color__square fn__pointer${o.color==="#65b84d"?" color__square--current":""}" style="background-color:#65b84d"></div>
                <div class="color__square fn__pointer${o.color==="#e099ff"?" color__square--current":""}" style="background-color:#e099ff"></div>
                <div class="color__square fn__pointer${o.color==="#ea5d97"?" color__square--current":""}" style="background-color:#ea5d97"></div>
                <div class="color__square fn__pointer${o.color==="#93627f"?" color__square--current":""}" style="background-color:#93627f"></div>
                <div class="color__square fn__pointer${o.color==="#5f6368"?" color__square--current":""}" style="background-color:#5f6368"></div>
                <div class="fn__space--small"></div>
                <input type="text" class="b3-text-field fn__flex-1 fn__flex-center" value="${o.color}">
            </div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.language}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    <option value="" ${o.lang===""?" selected":""}>${window.siyuan.languages.themeOS}</option>
                    <option value="en_US" ${o.lang==="en_US"?" selected":""}>English (en_US)</option>
                    <option value="zh_CHT" ${o.lang==="zh_CHT"?" selected":""}>\u7E41\u9AD4\u4E2D\u6587 (zh_CHT)</option>
                    <option value="zh_CN" ${o.lang==="zh_CN"?" selected":""}>\u7B80\u4F53\u4E2D\u6587 (zh_CN)</option>
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.date}</span>
                <span class="fn__space--small"></span>
                <input type="date" max="9999-12-31" class="b3-text-field fn__flex-1" value="${o.date}"/>
                <span class="fn__space--small"></span>
                <span data-action="clearDate" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicIconDateEmptyInfo}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.format}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    ${Jn(o.lang,o.weekdayType)}
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__flex fn__flex-wrap">
                <img class="emoji__dynamic-item${o.type==="1"?" emoji__dynamic-item--current":""}" src="${s}type=1&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="2"?" emoji__dynamic-item--current":""}" src="${s}type=2&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="3"?" emoji__dynamic-item--current":""}" src="${s}type=3&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="4"?" emoji__dynamic-item--current":""}" src="${s}type=4&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="5"?" emoji__dynamic-item--current":""}" src="${s}type=5&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="6"?" emoji__dynamic-item--current":""}" src="${s}type=6&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="7"?" emoji__dynamic-item--current":""}" src="${s}type=7&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.custom}</span>
                <span class="fn__space--small"></span>
                <input type="text" class="b3-text-field fn__flex-1" value="">
                <span class="fn__space"></span>
            </div>
            <div>
                <img data-type="text" class="emoji__dynamic-item${o.type==="8"?" emoji__dynamic-item--current":""}" src="${s}type=8&color=${encodeURIComponent(o.color)}&content=${encodeURIComponent(o.content)}&id=${e}">
            </div>
        </div>
    </div>
</div>`});l.element.setAttribute("data-key",Constants.DIALOG_EMOJIS),l.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const r=l.element.querySelector(".b3-dialog");r.style.justifyContent="inherit",r.style.alignItems="inherit";const c=window.siyuan.storage[Constants.LOCAL_EMOJIS].currentTab;l.element.querySelector(`.emojis__tabheader [data-type="tab-${c}"]`).classList.add("block__icon--active"),l.element.querySelector(`.emojis__tabbody [data-type="tab-${c}"]`).classList.remove("fn__none"),setPosition(l.element.querySelector(".b3-dialog__container"),a.x,a.y,a.h,a.w),l.element.querySelector(".emojis__item").classList.add("emojis__item--current");const u=l.element.querySelector('[data-type="tab-emoji"] .b3-text-field'),g=l.element.querySelector(".emojis__panel");u.addEventListener("compositionend",()=>{var p;g.innerHTML=tn(u.value),u.value?g.nextElementSibling.classList.add("fn__none"):g.nextElementSibling.classList.remove("fn__none"),g.scrollTop=0,(p=l.element.querySelector(".emojis__item"))==null||p.classList.add("emojis__item--current"),u.value===""&&Qa(l.element),en(l.element)}),u.addEventListener("input",p=>{var y;p.isComposing||(g.innerHTML=tn(u.value),u.value?g.nextElementSibling.classList.add("fn__none"):g.nextElementSibling.classList.remove("fn__none"),g.scrollTop=0,(y=l.element.querySelector(".emojis__item"))==null||y.classList.add("emojis__item--current"),u.value===""&&Qa(l.element),en(l.element))}),u.addEventListener("keydown",p=>{var y,_,k,x;if(p.isComposing||p.key.indexOf("Arrow")===-1&&p.key!=="Enter")return;const T=l.element.querySelector(".emojis__item--current");if(!T)return;if(p.key==="Enter"){const v=T.getAttribute("data-unicode");t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:v},()=>{l.destroy(),ga(v),$t(v,e,"iconFilesRoot")}):t==="doc"&&fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:v}},()=>{l.destroy(),ga(v),$t(v,e),an(v,e)}),n&&n(v),p.preventDefault(),p.stopPropagation();return}let w;if(p.key==="ArrowLeft")T.previousElementSibling?(T.classList.remove("emojis__item--current"),w=T.previousElementSibling,p.preventDefault(),p.stopPropagation()):(y=T.parentElement.previousElementSibling)!=null&&y.previousElementSibling&&(T.classList.remove("emojis__item--current"),w=T.parentElement.previousElementSibling.previousElementSibling.lastElementChild,p.preventDefault(),p.stopPropagation());else if(p.key==="ArrowRight")T.nextElementSibling?(T.classList.remove("emojis__item--current"),w=T.nextElementSibling,p.preventDefault(),p.stopPropagation()):(_=T.parentElement.nextElementSibling)!=null&&_.nextElementSibling&&(T.classList.remove("emojis__item--current"),w=T.parentElement.nextElementSibling.nextElementSibling.firstElementChild,p.preventDefault(),p.stopPropagation());else if(p.key==="ArrowDown"){if(T.nextElementSibling){T.classList.remove("emojis__item--current");let v=Math.floor(T.parentElement.clientWidth/(T.clientWidth+2));for(w=T;w.nextElementSibling&&v>0;)w=w.nextElementSibling,v--}else{const v=(k=T.parentElement.nextElementSibling)==null?void 0:k.nextElementSibling;v&&(w=v.firstElementChild,T.classList.remove("emojis__item--current"))}p.preventDefault(),p.stopPropagation()}else if(p.key==="ArrowUp"){if(T.previousElementSibling){T.classList.remove("emojis__item--current");let v=Math.floor(T.parentElement.clientWidth/(T.clientWidth+2));for(w=T;w.previousElementSibling&&v>0;)w=w.previousElementSibling,v--}else{const v=(x=T.parentElement.previousElementSibling)==null?void 0:x.previousElementSibling;v&&(w=v.lastElementChild,T.classList.remove("emojis__item--current"))}p.preventDefault(),p.stopPropagation()}if(w){w.classList.add("emojis__item--current");const v=u.clientHeight+6;w.offsetTop-v<g.scrollTop?g.scrollTop=w.offsetTop-v-6:w.offsetTop-v-g.clientHeight+w.clientHeight>g.scrollTop&&(g.scrollTop=w.offsetTop-v-g.clientHeight+w.clientHeight)}}),!isMobile()&&c==="emoji"&&u.focus(),Qa(l.element),en(l.element),l.element.addEventListener("click",p=>{var y,_;let k=p.target;for(;k&&k!==l.element;){if(k.classList.contains("emojis__type")){const x=g.querySelector(`[data-type="${k.getAttribute("data-type")}"]`);if(x){const T=x.nextElementSibling.getAttribute("data-index");T&&(Qn((y=x.previousElementSibling)==null?void 0:y.getAttribute("data-index"),x.previousElementSibling),Qn(T,x.nextElementSibling)),g.scrollTo({top:x.offsetTop-77})}break}else if(k.getAttribute("data-action")==="remove"){t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:""},()=>{l.destroy(),$t("",e,"iconFilesRoot")}):t==="doc"&&fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:""}},()=>{l.destroy(),$t("",e),an("",e)}),n&&n("");break}else if(k.classList.contains("emojis__item")||k.getAttribute("data-action")==="random"||k.classList.contains("emoji__dynamic-item")){let x="";k.classList.contains("emojis__item")?(x=k.getAttribute("data-unicode"),l.destroy()):k.classList.contains("emoji__dynamic-item")?(x=k.getAttribute("src"),l.destroy()):x=zi(),t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:x},()=>{ga(x),$t(x,e,"iconFilesRoot")}):t==="doc"&&fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:x}},()=>{ga(x),$t(x,e),an(x,e)}),n&&n(x);break}else if((_=k.getAttribute("data-type"))!=null&&_.startsWith("tab-")){r.querySelectorAll('.emojis__tabheader [data-type|="tab"]').forEach(x=>{x.dataset.type===k.dataset.type?x.classList.add("block__icon--active"):x.classList.remove("block__icon--active")}),r.querySelectorAll(".emojis__tabbody > div").forEach(x=>{x.dataset.type===k.dataset.type?x.classList.remove("fn__none"):x.classList.add("fn__none")}),window.siyuan.storage[Constants.LOCAL_EMOJIS].currentTab=k.dataset.type.replace("tab-",""),setStorageVal(Constants.LOCAL_EMOJIS,window.siyuan.storage[Constants.LOCAL_EMOJIS]);break}else if(k.classList.contains("color__square")){f[0].value=k.getAttribute("style").replace("background-color:",""),f[0].dispatchEvent(new CustomEvent("input"));break}else if(k.dataset.action==="clearDate"){d.value="",d.dispatchEvent(new CustomEvent("change"));break}k=k.parentElement}});const m=l.element.querySelectorAll('[data-type="tab-dynamic"] .b3-select');m[0].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(p=>{const y=new URLSearchParams(p.getAttribute("src").replace(s,""));m[0].value?y.set("lang",m[0].value):y.delete("lang"),p.setAttribute("src",s+y.toString()),m[1].innerHTML=Jn(m[0].value,m[1].value)})}),m[1].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(p=>{const y=new URLSearchParams(p.getAttribute("src").replace(s,""));y.set("weekdayType",m[1].value),p.setAttribute("src",s+y.toString())})});const d=l.element.querySelector('[data-type="tab-dynamic"] [type="date"]');d.addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(p=>{const y=new URLSearchParams(p.getAttribute("src").replace(s,""));y.set("date",d.value?dayjs(d.value).format("YYYY-MM-DD"):""),p.setAttribute("src",s+y.toString())})});const f=l.element.querySelectorAll('[data-type="tab-dynamic"] [type="text"]'),b=l.element.querySelector('.emoji__dynamic-item[data-type="text"]');f[0].addEventListener("input",()=>{f[0].value.startsWith("#")&&(l.element.querySelectorAll(".emoji__dynamic-item").forEach(p=>{const y=new URLSearchParams(p.getAttribute("src").replace(s,""));y.set("color",f[0].value),p.setAttribute("src",s+y.toString())}),l.element.querySelectorAll(".color__square").forEach(p=>{p.style.backgroundColor===f[0].value?p.classList.add("color__square--current"):p.classList.remove("color__square--current")}))}),f[1].value=o.content,f[1].addEventListener("input",()=>{const p=new URLSearchParams(b.getAttribute("src").replace(s,""));p.set("content",f[1].value),b.setAttribute("src",s+p.toString())})},an=(e,t)=>{},$t=(e,t,a="iconFile")=>{let n;n=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${t}"] .b3-list-item__icon`),n&&(n.innerHTML=ve(e||(a==="iconFile"?n.previousElementSibling.classList.contains("fn__hidden")?window.siyuan.storage[Constants.LOCAL_IMAGES].file:window.siyuan.storage[Constants.LOCAL_IMAGES].folder:window.siyuan.storage[Constants.LOCAL_IMAGES].note))),a!=="iconFile"&&setNoteBook()},Ht=e=>window.siyuan.config.lang==="zh_CN"?e.description_zh_cn:window.siyuan.config.lang==="ja_JP"?e.description_ja_jp:e.description,Ge=e=>window.siyuan.config.lang==="zh_CN"?window.siyuan.emojis[e].title_zh_cn:window.siyuan.config.lang==="ja_JP"?window.siyuan.emojis[e].title_ja_jp:window.siyuan.emojis[e].title,Ki=e=>{if(window.siyuan.emojis[0].items.length>0){const t={};window.siyuan.emojis[0].items.forEach(a=>{t[a.keywords]=e.options.hint.emojiPath+"/"+a.unicode}),e.lute.PutEmojis(t)}},cc=()=>{fetchPost("/api/system/getEmojiConf",{},e=>{window.siyuan.emojis=e.data,getAllEditor().forEach(t=>{Ki(t.protyle)})})},dc=(e,t)=>{if(e.includes("\u2303")){if(!t.ctrlKey)return!1}else if(isMac()?t.ctrlKey:e.includes("\u2318")?!t.ctrlKey:t.ctrlKey)return!1;if(e.includes("\u2325")){if(!t.altKey)return!1}else if(t.altKey)return!1;if(e.includes("\u21E7")){if(!t.shiftKey)return!1}else if(t.shiftKey)return!1;if(e.includes("\u2318")){if(isMac()?!t.metaKey:!t.ctrlKey)return!1}else if(isMac()?t.metaKey:e.includes("\u2303")?!t.ctrlKey:t.ctrlKey)return!1;return!0},ma=(e,t)=>{const a=e.replace(t,Constants.ZWSP).split("");return a.forEach((n,i)=>{n===Constants.ZWSP&&(a[i]=t)}),a},uc=(e,t)=>{if(!e)return!1;if(e.startsWith("\u2303")&&!isMac()){if(e==="\u2303D")return!1;e=e.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(e.indexOf("\u21E7")===-1&&e.indexOf("\u2318")===-1&&e.indexOf("\u2325")===-1&&e.indexOf("\u2303")===-1)return!!(isNotCtrl(t)&&!t.altKey&&!t.shiftKey&&e===Constants.KEYCODELIST[t.keyCode]);let a=e.split("");if(e.indexOf("F")>-1?a.forEach((i,s)=>{i==="F"&&(a[s]="F"+a.splice(s+1,1),a[s+1]&&(a[s+1]+=a.splice(s+1,1)))}):e.indexOf("PageUp")>-1?a=ma(e,"PageUp"):e.indexOf("PageDown")>-1?a=ma(e,"PageDown"):e.indexOf("Home")>-1?a=ma(e,"Home"):e.indexOf("End")>-1&&(a=ma(e,"End")),e.startsWith("\u21E7")&&a.length===2)return!!(isNotCtrl(t)&&!t.altKey&&t.shiftKey&&a[1]===Constants.KEYCODELIST[t.keyCode]);if(e.startsWith("\u2325")){let i=a.length===3?a[2]:a[1];a.length===4&&(i=a[3]);const s=i===Constants.KEYCODELIST[t.keyCode];return!!(s&&t.altKey&&!t.shiftKey&&a.length<4&&(a.length===3?isOnlyMeta(t)&&e.startsWith("\u2325\u2318"):isNotCtrl(t))||s&&e.startsWith("\u2325\u21E7\u2318")&&a.length===4&&t.altKey&&t.shiftKey&&isOnlyMeta(t)||s&&e.startsWith("\u2325\u21E7")&&a.length===3&&t.altKey&&t.shiftKey&&isNotCtrl(t))}if(e.startsWith("\u2303")){if(!isMac())return!1;let i=a.length===3?a[2]:a[1];a.length===4?i=a[3]:a.length===5&&(i=a[4]);const s=i===Constants.KEYCODELIST[t.keyCode];return!!(s&&t.ctrlKey&&!t.altKey&&!t.shiftKey&&a.length<4&&(a.length===3?t.metaKey&&e.startsWith("\u2303\u2318"):!t.metaKey)||s&&e.startsWith("\u2303\u21E7")&&a.length===3&&t.ctrlKey&&!t.altKey&&t.shiftKey&&!t.metaKey||s&&e.startsWith("\u2303\u2325")&&a.length===3&&t.ctrlKey&&t.altKey&&!t.shiftKey&&!t.metaKey||s&&a.length===4&&t.ctrlKey&&(e.startsWith("\u2303\u2325\u21E7")&&t.shiftKey&&!t.metaKey&&t.altKey||e.startsWith("\u2303\u2325\u2318")&&!t.shiftKey&&t.metaKey&&t.altKey||e.startsWith("\u2303\u21E7\u2318")&&t.shiftKey&&t.metaKey&&!t.altKey)||s&&a.length===5&&t.ctrlKey&&t.shiftKey&&t.metaKey&&t.altKey)}const n=a.length>2&&a[0]==="\u21E7";return isOnlyMeta(t)&&!t.altKey&&(!n&&!t.shiftKey||n&&t.shiftKey)?(n?a[2]:a[1])===Constants.KEYCODELIST[t.keyCode]:!1},fc=e=>{let t=!1;return Object.keys(window.siyuan.config.keymap).find(a=>{const n=window.siyuan.config.keymap[a];if(Object.keys(n).find(i=>{const s=n[i];if(typeof s.custom=="string"){if(s.custom===e)return t=!0,!0}else if(Object.keys(s).forEach(o=>{if(s[o].custom===e)return t=!0,!0}),t)return!0}),t)return!0}),t},gc=()=>{window.siyuan.config.keymap.general&&Object.keys(window.siyuan.config.keymap.general).forEach(e=>{["fileTree","outline","bookmark","tag","dailyNote","inbox","backlinks","graphView","globalGraph","riffCard"].includes(e)&&(navigator.platform.toUpperCase().indexOf("MAC")>-1?(window.siyuan.config.keymap.general[e].default=window.siyuan.config.keymap.general[e].default.replace("\u2325","\u2303"),window.siyuan.config.keymap.general[e].default===window.siyuan.config.keymap.general[e].custom&&(window.siyuan.config.keymap.general[e].custom=window.siyuan.config.keymap.general[e].default.replace("\u2325","\u2303"))):(window.siyuan.config.keymap.general[e].default=window.siyuan.config.keymap.general[e].default.replace("\u2303","\u2325"),window.siyuan.config.keymap.general[e].default===window.siyuan.config.keymap.general[e].custom&&(window.siyuan.config.keymap.general[e].custom=window.siyuan.config.keymap.general[e].default.replace("\u2303","\u2325"))))})},mc=(e,t)=>{},pc=()=>{const e=new URLSearchParams(window.location.search),t=e.get("url");let a="",n=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t))a=t.substring(20,42),n=getSearch("focus",t)==="1";else if(window.JSAndroid){const i=window.JSAndroid.getBlockURL();a=Zi(i),n=getSearch("focus",i)==="1"}else a=e.get("id"),n=e.get("focus")==="1";return{id:a,isZoomIn:n}},bc=e=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e),Zi=e=>e.substring(16,38),yc=(e=window.location.href)=>{const t=new URL(window.location.origin);t.pathname="/check-auth",t.searchParams.set("to",e),window.location.href=t.href},hc=()=>{let e=document.getElementById("baseURL");e||(e=document.createElement("base"),e.id="baseURL"),e.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(e)},es=(e,t=!0,a=!1)=>{let n=e;return t&&(n=nn().basename(e)),a&&n.endsWith(".sy")&&(n=n.substr(0,n.length-3)),n},Xi=e=>nn().basename(e,nn().extname(e)).replace(/-\d{14}-\w{7}/,""),_c=e=>!e||(e=e.trim(),1>e.length)?!1:(e=e.toLowerCase(),e.startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\")?!0:isWindows()?e.indexOf(":")===1:e.startsWith("/")),nn=()=>Ja.posix?Ja.posix:Ja,wc=()=>path,vc=e=>{const t=[];return e.forEach(a=>{if(a.getAttribute("data-type")!=="navigation-root"){const n=a.getAttribute("data-path");t.find(s=>{if(n.startsWith(s.replace(".sy","")))return!0})||t.push(n)}}),t},Ec=(e,t,a)=>{fetchPost("/api/filetree/moveDocs",{toNotebook:t,fromPaths:e,toPath:a})},kc=(e,t,a,n,i=!1)=>{if(window.siyuan.dialogs.find(d=>{if(d.element.querySelector("#foldList"))return d.destroy(),!0}))return;const o=new Dialog({title:`<div style="padding: 8px;">
    ${n||window.siyuan.languages.move}
    <div style="max-height: 16px;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>
</div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <span data-menu="true" class="b3-form__icon-list fn__a b3-tooltips b3-tooltips__s" aria-label="${updateHotkeyTip("\u2325\u2193")}">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input class="b3-text-field fn__block" style="padding-left: 42px;" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"50vw",height:isMobile()?"80vh":"70vh",destroyCallback(){a&&focusByRange(a)}});o.element.querySelector(".b3-dialog__header").setAttribute("style","padding:0"),o.element.setAttribute("data-key",Constants.DIALOG_MOVEPATHTO),t&&t.length>0&&fetchPost("/api/filetree/getHPathsByPaths",{paths:t},d=>{o.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=escapeHtml(d.data.join(" "))});const l=o.element.querySelector("#foldList"),r=o.element.querySelector("#foldTree");Ji(d=>{let f="";d.forEach(b=>{if(!b.closed){let p="";i&&(p=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),f+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${f===""?" b3-list-item--focus":""}" data-path="/" data-box="${b.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(b.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${escapeHtml(b.name)}</span>
    ${p}
</li></ul>`}}),r.innerHTML=f},i);const c=o.element.querySelector(".b3-text-field");c.value=window.siyuan.storage[Constants.LOCAL_MOVE_PATH].k;const u=d=>{if(!(d&&d.isComposing)){if(c.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),fetchPost("/api/filetree/searchDocs",{k:c.value,flashcard:i},f=>{let b="";f.data.forEach(p=>{let y="";i&&(y=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${p.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${p.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${p.flashcardCount}</span>`),b+=`<li class="b3-list-item${b===""?" b3-list-item--focus":""}" data-path="${p.path}" data-box="${p.box}">
    ${unicode2Emoji(p.boxIcon||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding: 4px 0">${escapeHtml(p.hPath)}</span>
    ${y}
</li>`}),l.innerHTML=b})}},g=()=>{const d=window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys;if(!d||d.length===0||d.length===1&&d[0]===c.value)return;const f=new Menu(Constants.MENU_MOVE_PATH_HISTORY);if(f.isOpen)return;f.element.classList.add("b3-menu--list"),f.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys=[],setStorageVal(Constants.LOCAL_MOVE_PATH,window.siyuan.storage[Constants.LOCAL_MOVE_PATH])}});const b=f.addSeparator(1);let p=!0;d.forEach(_=>{if(_!==c.value&&_){const k=f.addItem({iconHTML:"",label:escapeHtml(_),action:"iconCloseRound",bind(x){x.addEventListener("click",T=>{var w;hasClosestByClassName(T.target,"b3-menu__action")?(d.find((v,h)=>{if(v===_)return d.splice(h,1),!0}),window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys=d,setStorageVal(Constants.LOCAL_MOVE_PATH,window.siyuan.storage[Constants.LOCAL_MOVE_PATH]),(w=x.previousElementSibling)!=null&&w.classList.contains("b3-menu__separator")&&!x.nextElementSibling?window.siyuan.menus.menu.remove():x.remove()):(c.value=x.textContent,u(),window.siyuan.menus.menu.remove()),T.preventDefault(),T.stopPropagation()})}});p&&k.classList.add("b3-menu__item--current"),p=!1}}),p&&b.remove();const y=c.getBoundingClientRect();f.open({x:y.left,y:y.bottom})};u(),c.addEventListener("compositionend",d=>{u(d)}),c.addEventListener("input",d=>{u(d)}),c.addEventListener("blur",()=>{if(c.value){let d=window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys;d.splice(0,0,c.value),d=Array.from(new Set(d)),d.length>window.siyuan.config.search.limit&&d.splice(window.siyuan.config.search.limit,d.length-window.siyuan.config.search.limit),window.siyuan.storage[Constants.LOCAL_MOVE_PATH].keys=d}window.siyuan.storage[Constants.LOCAL_MOVE_PATH].k=c.value,setStorageVal(Constants.LOCAL_MOVE_PATH,window.siyuan.storage[Constants.LOCAL_MOVE_PATH])});const m=28;c.addEventListener("keydown",d=>{if(d.isComposing)return;if(matchHotKey("\u2325\u2193",d)){d.stopPropagation(),g();return}if(window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_MOVE_PATH_HISTORY)return;const f=l.classList.contains("fn__none")?r:l,b=f.querySelectorAll(".b3-list-item--focus");if(b.length===0)return;let p=b[0];if(d.key.startsWith("Arrow")&&b.forEach((y,_)=>{_!==0&&y.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(d.key==="ArrowRight"&&!p.querySelector(".b3-list-item__arrow--open")&&!p.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||d.key==="ArrowLeft"&&p.querySelector(".b3-list-item__arrow--open")){sn(p,i),d.preventDefault();return}if(d.key==="ArrowLeft"){let y=p.parentElement.previousElementSibling;if(y){y.tagName!=="LI"&&(y=f.querySelector(".b3-list-item")),p.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const _=y.getBoundingClientRect(),k=f.getBoundingClientRect();(_.top<k.top||_.bottom>k.bottom)&&y.scrollIntoView(_.top<k.top)}return d.preventDefault(),!0}if(d.key==="ArrowDown"||d.key==="ArrowRight"){let y=p;for(;y;)if(y.nextElementSibling)if(y.nextElementSibling.classList.contains("fn__none"))y=y.nextElementSibling;else{y.nextElementSibling.tagName==="UL"?y=y.nextElementSibling.firstElementChild:y=y.nextElementSibling;break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){p.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const _=y.getBoundingClientRect(),k=r.getBoundingClientRect();(_.top<k.top||_.bottom>k.bottom)&&y.scrollIntoView(_.top<k.top)}return d.preventDefault(),!0}if(d.key==="ArrowUp"){let y=p;for(;y;)if(y.previousElementSibling)if(y.previousElementSibling.classList.contains("fn__none"))y=y.previousElementSibling;else{if(y.previousElementSibling.tagName==="LI")y=y.previousElementSibling;else{const _=y.previousElementSibling.querySelectorAll(".b3-list-item");y=_[_.length-1]}break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){p.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const _=y.getBoundingClientRect(),k=r.getBoundingClientRect();(_.top<k.top||_.bottom>k.bottom)&&y.scrollIntoView(_.top<k.top)}d.preventDefault()}}else{if(d.key==="ArrowDown"){p.classList.remove("b3-list-item--focus"),p.nextElementSibling?p.nextElementSibling.classList.add("b3-list-item--focus"):f.children[0].classList.add("b3-list-item--focus"),p=f.querySelector(".b3-list-item--focus"),(f.scrollTop<p.offsetTop-f.clientHeight+m||f.scrollTop>p.offsetTop)&&(f.scrollTop=p.offsetTop-f.clientHeight+m),d.preventDefault();return}if(d.key==="ArrowUp"){if(p.classList.remove("b3-list-item--focus"),p.previousElementSibling)p.previousElementSibling.classList.add("b3-list-item--focus");else{const y=f.children.length;f.children[y-1].classList.add("b3-list-item--focus")}p=f.querySelector(".b3-list-item--focus"),(f.scrollTop<p.offsetTop-f.clientHeight+m||f.scrollTop>p.offsetTop-m*2)&&(f.scrollTop=p.offsetTop-m*2),d.preventDefault();return}}if(d.key==="Enter"){const y=f.querySelectorAll(".b3-list-item--focus");if(y.length===0)return;const _=[],k=[];y.forEach(x=>{_.push(x.getAttribute("data-path")),k.push(x.getAttribute("data-box"))}),e(_,k),o.destroy(),d.preventDefault()}}),o.element.addEventListener("click",d=>{let f=d.target;for(;f&&!f.isEqualNode(o.element);){if(f.classList.contains("b3-list-item__toggle")){sn(f.parentElement,i),d.preventDefault(),d.stopPropagation();break}else if(f.classList.contains("b3-form__icon-list")){g(),d.preventDefault(),d.stopPropagation();break}else if(f.classList.contains("b3-button--text")){const p=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(p.length===0)return;const y=[],_=[];p.forEach(k=>{y.push(k.getAttribute("data-path")),_.push(k.getAttribute("data-box"))}),e(y,_),o.destroy(),d.preventDefault(),d.stopPropagation();break}else if(f.classList.contains("b3-button--cancel")){o.destroy(),d.preventDefault(),d.stopPropagation();break}else if(f.classList.contains("b3-list-item")){const p=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(p.length===0)return;n===window.siyuan.languages.specifyPath&&isOnlyMeta(d)?p.length===1&&p[0]===f||f.classList.toggle("b3-list-item--focus"):(p[0].classList.remove("b3-list-item--focus"),f.classList.add("b3-list-item--focus")),f.getAttribute("data-path")==="/"&&sn(f,i),d.preventDefault(),d.stopPropagation();break}f=f.parentElement}})},sn=(e,t)=>{const a=e.querySelector(".b3-list-item__arrow");if(a.classList.contains("b3-list-item__arrow--open")){a.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling&&e.nextElementSibling.tagName==="UL"&&e.nextElementSibling.classList.add("fn__none");return}if(e.nextElementSibling&&e.nextElementSibling.tagName==="UL"){a.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none");return}const n=e.getAttribute("data-box");fetchPost("/api/filetree/listDocsByPath",{notebook:n,path:e.getAttribute("data-path"),flashcard:t,app:Constants.SIYUAN_APPID},i=>{if(i.data.files.length===0){showMessage(window.siyuan.languages.emptyContent);return}let s="";if(i.data.files.forEach(l=>{let r="";t?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),s+=`<li data-box="${n}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${l.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(l.icon||(l.subFileCount===0?window.siyuan.storage[Constants.LOCAL_IMAGES].file:window.siyuan.storage[Constants.LOCAL_IMAGES].folder),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" aria-label="${es(l.name,!0,!0)} <small class='ft__on-surface'>${l.hSize}</small>${l.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?"<br>"+window.siyuan.languages.name+" "+l.name1:""}${l.alias?"<br>"+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?"<br>"+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${l.hMtime}<br>${window.siyuan.languages.createdAt} ${l.hCtime}">${es(l.name,!0,!0)}</span>
    ${r}
</li>`}),s==="")return;a.classList.add("b3-list-item__arrow--open"),e.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${s}</ul>`);const o=e.nextElementSibling;setTimeout(()=>{o.setAttribute("style",`height:${o.childElementCount*e.clientHeight}px;`),setTimeout(()=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")},120)},2)})},Cc=e=>{let t="";return window.siyuan.notebooks.find(a=>{if(a.id===e)return t=a.name,!0}),t},Ac=e=>{let t="";return window.siyuan.notebooks.find(a=>{if(a.id===e)return t=a.icon,!0}),t},Sc=(e,t)=>{window.siyuan.notebooks.find(a=>{if(a.id===e)return a.name=t,!0})},Lc=()=>{let e=0;return window.siyuan.notebooks.forEach(t=>{t.closed||e++}),e},Ji=(e,t=!1)=>{fetchPost("/api/notebook/lsNotebooks",{flashcard:t},a=>{t||(window.siyuan.notebooks=a.data.notebooks),e&&e(a.data.notebooks)})},xc=e=>{const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
    <div class="b3-list fn__flex-1 b3-list--background fn__none protyle-hint" style="    position: absolute;
    width: calc(100% - 48px);">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_RENAMETAG);const a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{fetchPost("/api/tag/renameTag",{oldLabel:e,newLabel:n.value},()=>{t.destroy(),window.siyuan.mobile.docks.tag.update()})});const n=t.element.querySelector("input");n.value=e,n.focus(),n.select();const i=t.element.querySelector(".b3-list--background");n.addEventListener("keydown",s=>{if(s.stopPropagation(),!s.isComposing){if(upDownHint(i,s),s.key==="Escape")i.classList.contains("fn__none")?t.destroy():i.classList.add("fn__none"),s.preventDefault();else if(!s.shiftKey&&isNotCtrl(s)&&s.key==="Enter"){if(i.classList.contains("fn__none"))a[1].click();else{const o=i.querySelector(".b3-list-item--focus");n.value=o.dataset.type==="new"?o.querySelector("mark").textContent.trim():o.textContent.trim(),i.classList.add("fn__none")}s.preventDefault()}}}),n.addEventListener("input",s=>{s.stopPropagation(),i.classList.remove("fn__none"),fetchPost("/api/search/searchTag",{k:n.value.trim()},o=>{let l="",r=!1;o.data.tags.forEach((c,u)=>{l+=`<div class="b3-list-item${u===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${c}</div>
</div>`,c===`<mark>${o.data.k}</mark>`&&(r=!0)}),!r&&o.data.k&&(l=`<div data-type="new" class="b3-list-item${l?"":" b3-list-item--focus"}"><div class="fn__flex-1">${window.siyuan.languages.new} <mark>${escapeHtml(o.data.k)}</mark></div></div>`+l),i.innerHTML=l})}),i.addEventListener("click",s=>{const o=s.target,l=hasClosestByClassName(o,"b3-list-item");l&&(n.value=l.dataset.type==="new"?l.querySelector("mark").textContent.trim():l.textContent.trim(),i.classList.add("fn__none"))})},Tc=()=>pathPosix().basename(window.siyuan.config.system.workspaceDir.replace(/\\/g,"/")),Ic=(e,t)=>{e&&fetchPost("/api/block/checkBlockFold",{id:e},a=>{t(a.data.isFolded,a.data.isFolded?[Constants.CB_GET_FOCUS,Constants.CB_GET_ALL]:[Constants.CB_GET_FOCUS,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL],a.data.isRoot)})},Dc=()=>{let e;e=window.siyuan.mobile.docks.file.element;const t=[];Object.keys(Constants.HELP_PATH).forEach(a=>{t.push(Constants.HELP_PATH[a])}),e.childNodes.forEach(a=>{a.querySelector('[data-type="addLocal"]')||t.includes(a.getAttribute("data-url"))||a.querySelector('[data-type="more-root"]').insertAdjacentHTML("beforebegin",`<span data-type="addLocal" class="b3-list-item__action">
    <svg><use xlink:href="#iconRiffCard"></use></svg>
</span>`)})},Mc=()=>{const e=new Dialog({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),t=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.element.setAttribute("data-key",Constants.DIALOG_ACCESSAUTHCODE),e.bindInput(t,()=>{a[1].click()}),t.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{fetchPost("/api/system/setAccessAuthCode",{accessAuthCode:t.value})})},Qi=e=>{const t=window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io";return!e||e===""?t:`${t}/${e}`},$c=e=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${e}`,el=(e=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(e&&(e===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?tt(window.siyuan.languages._kernel[122]):(e===window.siyuan.languages._kernel[29]&&(e=window.siyuan.languages._kernel[29].replaceAll("${accountServer}",Qi(""))),tt(e))),!0),tl=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1),ts="%%params",al=e=>{let t={responsive:"resize"};const a=e.substring(0,e.indexOf(`
`));if(a.startsWith(ts))try{t=We(a.substring(ts.length))}catch(n){console.error(`Failed to parse ABCJS params: ${n}`)}return t},ln=(e,t=H.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="abc"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="abc"]')),a.length!==0&&a.length>0&&oe(`${t}/js/abcjs/abcjs-basic-min.js?v=6.5.0`,"protyleAbcjsScript").then(()=>{const n=U(e,"protyle-wysiwyg",!0);a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",de(n));const s=i.firstElementChild.nextElementSibling;s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div contenteditable="false"></div>`;const o=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));window.ABCJS.renderAbc(s.lastElementChild,o,al(o)),i.setAttribute("data-render","true")})})};var nl=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const on=(e,t=H.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="echarts"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="echarts"]')),a.length!==0&&a.length>0&&oe(`${t}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{oe(`${t}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{const n=U(e,"protyle-wysiwyg",!0);let i;n&&n.clientWidth>0&&a[0].firstElementChild.clientWidth===0&&n.firstElementChild&&(i=n.firstElementChild.clientWidth),a.forEach(s=>nl(void 0,null,function*(){var o,l,r;if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",de(n,["refresh","edit","more"]));const c=s.firstElementChild.nextElementSibling;if(!s.getAttribute("data-content")){c.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span>`;return}try{!c.lastElementChild||c.childElementCount===1?c.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div style="height:${s.style.height||"420px"}" contenteditable="false"></div>`:c.lastElementChild.classList.remove("ft__error");const u=window.echarts.getInstanceById((o=c.lastElementChild)==null?void 0:o.getAttribute("_echarts_instance_")),g=yield We(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")));u&&(((l=u.getOption().series[0])==null?void 0:l.type)!==((r=g.series[0])==null?void 0:r.type)&&u.clear(),u==null||u.resize()),window.echarts.init(c.lastElementChild,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:i}).setOption(g)}catch(u){window.echarts.dispose(c.lastElementChild),c.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div class="ft__error" style="height:${s.style.height||"420px"}" contenteditable="false">echarts render error: <br>${u}</div>`}s.setAttribute("data-render","true")}))})})},rn=(e,t=H.PROTYLE_CDN,a=!1)=>{let n=[];e.getAttribute("data-subtype")==="math"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="math"]')),n.length!==0&&(Ga(`${t}/js/katex/katex.min.css?v=0.16.9`,"protyleKatexStyle"),oe(`${t}/js/katex/katex.min.js?v=0.16.9`,"protyleKatexScript").then(()=>{oe(`${t}/js/katex/mhchem.min.js?v=0.16.9`,"protyleKatexMhchemScript").then(()=>{n.forEach(i=>{var s,o;if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true");let l={};try{l=We(window.siyuan.config.editor.katexMacros||"{}")}catch(c){console.warn("KaTex macros is not JSON",c)}const r=i.tagName==="DIV";try{const c=window.katex.renderToString(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")),{displayMode:r,output:"html",macros:l,trust:!0,strict:g=>g==="unicodeTextInMathMode"?"ignore":"warn"}),u=G(i);if(r){be(i),i.firstElementChild.firstElementChild.classList.remove("ft__error"),i.firstElementChild.firstElementChild.setAttribute("contenteditable","false"),i.firstElementChild.firstElementChild.innerHTML=c;const g=i.querySelectorAll(".base");g.length>0&&g[g.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const m=i.querySelector(".katex-html > .newline");m&&(m.parentElement.style.display="block")}else{i.classList.remove("ft__error"),i.innerHTML=c,u&&i.getBoundingClientRect().width>u.clientWidth?(i.style.maxWidth="100%",i.style.overflowX="auto",i.style.overflowY="hidden",i.style.display="inline-block"):(i.style.maxWidth="",i.style.overflowX="",i.style.overflowY="",i.style.display="");const g=Ya(i);g?g&&g.nodeType!==3&&(((s=g.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1||g.classList.contains("img"))?i.after(document.createTextNode(H.ZWSP)):g&&!g.textContent.startsWith(`
`)&&g.textContent!==H.ZWSP&&i.insertAdjacentHTML("beforeend","&#xFEFF;"):i.parentElement.tagName!=="TH"&&i.parentElement.tagName!=="TD"?i.insertAdjacentText("afterend",`
`):i.insertAdjacentText("afterend",H.ZWSP),(o=i.previousSibling)!=null&&o.textContent.endsWith(`
`)?i.insertAdjacentText("beforebegin",H.ZWSP):!Vt(i)&&["TH","TD"].includes(i.parentElement.tagName)&&i.insertAdjacentText("afterbegin",H.ZWSP)}a&&setTimeout(()=>{if(r){const g=i.querySelector(".katex-display");g.clientWidth<g.scrollWidth&&g.firstElementChild.setAttribute("style",`font-size:${g.clientWidth*100/g.scrollWidth}%`)}else u&&i.offsetWidth>u.clientWidth&&i.firstElementChild.setAttribute("style",`font-size:${u.clientWidth*100/i.offsetWidth}%`)})}catch(c){r?(be(i),i.firstElementChild.firstElementChild.setAttribute("contenteditable","false"),i.firstElementChild.firstElementChild.innerHTML=c.message,i.firstElementChild.firstElementChild.classList.add("ft__error")):(i.innerHTML=c.message,i.classList.add("ft__error"))}})})}))};var as=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const cn=(e,t=H.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="mermaid"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="mermaid"]')),a.length!==0&&oe(`${t}/js/mermaid/mermaid.min.js?v=11.12.0`,"protyleMermaidScript").then(()=>{oe(`${t}/js/mermaid/mermaid-zenuml.min.js?v=0.2.2`,"protyleMermaidZenumlScript").then(()=>as(void 0,null,function*(){yield window.mermaid.registerExternalDiagrams([window.zenuml]),window.mermaid.registerIconPacks([{name:"logos",loader:()=>fetch(`${t}/js/mermaid/icons.json?v=11.11.0`).then(i=>i.json())}]);const n={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(n.theme="dark"),window.mermaid.initialize(n),a[0].firstElementChild.clientWidth===0){const i=new MutationObserver(()=>{ns(a),i.disconnect()}),s=F(a[0],"fold","1");if(s)i.observe(s,{attributeFilter:["fold"]});else{const o=U(a[0],"card__block",!0);o&&i.observe(o,{attributeFilter:["class"]})}}else ns(a)}))})},ns=e=>{const t=U(e[0],"protyle-wysiwyg",!0);e.forEach(a=>as(void 0,null,function*(){if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",de(t));const n=a.firstElementChild.nextElementSibling;if(!a.getAttribute("data-content")){n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span>`;return}const i="mermaid"+Lute.NewNodeID();try{n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div contenteditable="false"><span id="${i}"></span></div>`;const s=yield window.mermaid.render(i,Lute.UnEscapeHTMLStr(a.getAttribute("data-content")));n.lastElementChild.innerHTML=s.svg}catch(s){const o=document.querySelector("#"+i);n.lastElementChild.innerHTML=`${o.outerHTML}<div class="fn__hr"></div><div class="ft__error">${s.message.replace(/\n/,"<br>")}</div>`,o.parentElement.remove()}a.setAttribute("data-render","true")}))},dn=(e,t=H.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="mindmap"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="mindmap"]')),a.length!==0&&oe(`${t}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{const n=U(e,"protyle-wysiwyg",!0);let i;n&&n.clientWidth>0&&a[0].firstElementChild.clientWidth===0&&n.firstElementChild&&(i=n.firstElementChild.clientWidth),a.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",de(n));const o=s.firstElementChild.nextElementSibling;if(!s.getAttribute("data-content")){o.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span>`;return}try{!o.lastElementChild||o.childElementCount===1?o.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div style="height:${s.style.height||"420px"}" contenteditable="false"></div>`:o.lastElementChild.classList.remove("ft__error"),window.echarts.init(o.lastElementChild,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:i}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(s.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(l,r)=>{var c;return(c=r==null?void 0:r.data)!=null&&c.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"})}catch(l){window.echarts.dispose(o.lastElementChild),o.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div class="ft__error" style="height:${s.style.height||"420px"}" contenteditable="false">Mindmap render error: <br>${l}</div>`}s.setAttribute("data-render","true")})})},un=(e,t=H.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="flowchart"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="flowchart"]')),a.length!==0&&oe(`${t}/js/flowchart.js/flowchart.min.js?v=1.18.0`,"protyleFlowchartScript").then(()=>{if(a[0].firstElementChild.clientWidth===0){const n=new MutationObserver(()=>{ss(a),n.disconnect()}),i=F(a[0],"fold","1");if(i)n.observe(i,{attributeFilter:["fold"]});else{const s=U(a[0],"card__block",!0);s&&n.observe(s,{attributeFilter:["class"]})}}else ss(a)})},ss=e=>{const t=U(e[0],"protyle-wysiwyg",!0);e.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",de(t));const n=a.firstElementChild.nextElementSibling;if(!a.getAttribute("data-content")){n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span>`;return}try{n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div contenteditable="false"></div>`,flowchart.parse(Lute.UnEscapeHTMLStr(a.getAttribute("data-content"))).drawSVG(n.lastElementChild)}catch(i){n.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${i}</div>`}a.setAttribute("data-render","true")})},fn=(e,t=H.PROTYLE_CDN)=>{let a=[];e.getAttribute("data-subtype")==="plantuml"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="plantuml"]')),a.length!==0&&oe(`${t}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{const n=U(e,"protyle-wysiwyg",!0);a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",de(n));const s=i.firstElementChild.nextElementSibling;if(!i.getAttribute("data-content")){s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${H.ZWSP}</span>`;return}try{const o=`${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")))}`;s.innerHTML=`<object type="image/svg+xml" data="${o}"/>`,s.classList.remove("ft__error"),s.firstElementChild.addEventListener("error",()=>{s.innerHTML=`<img src=${o}">`})}catch(o){s.classList.add("ft__error"),s.innerHTML=`plantuml render error: <br>${o}`}i.setAttribute("data-render","true")})})},gn=e=>{let t=[];e.getAttribute("data-type")==="NodeHTMLBlock"?t=[e]:t=Array.from(e.querySelectorAll('[data-type="NodeHTMLBlock"]')),t.length!==0&&t.length>0&&t.forEach(a=>{a.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),a.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},Hc=(e,t,a)=>{const n=document.createElement("div");n.innerHTML=e;let i=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||e.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(i=!0),i){let s=t||e;return/\n/.test(s)?a.lute.Md2BlockDOM(s):(s=s.replace("<","&lt;").replace(">","&gt;"),"`"+s+"`")}return!1},ht=e=>{const t=e.getAttribute("data-subtype");if(!H.SIYUAN_RENDER_CODE_LANGUAGES.includes(t)||e.getAttribute("data-type")!=="NodeHTMLBlock"){ln(e),gn(e),fn(e),cn(e),un(e),on(e),dn(e),xe(e),rn(e);return}t==="abc"?ln(e):t==="plantuml"?fn(e):t==="mermaid"?cn(e):t==="flowchart"?un(e):t==="echarts"?on(e):t==="mindmap"?dn(e):t==="graphviz"?xe(e):t==="math"?rn(e):e.getAttribute("data-type")==="NodeHTMLBlock"&&gn(e)},is=(e,t)=>{let a="";switch(e){case"NodeDocument":a="iconFile";break;case"NodeThematicBreak":a="iconLine";break;case"NodeParagraph":a="iconParagraph";break;case"NodeHeading":t?a="icon"+t.toUpperCase():a="iconHeadings";break;case"NodeBlockquote":a="iconQuote";break;case"NodeList":t==="t"?a="iconCheck":t==="o"?a="iconOrderedList":a="iconList";break;case"NodeListItem":a="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":a="iconCode";break;case"NodeTable":a="iconTable";break;case"NodeBlockQueryEmbed":a="iconSQL";break;case"NodeSuperBlock":a="iconSuper";break;case"NodeMathBlock":a="iconMath";break;case"NodeHTMLBlock":a="iconHTML5";break;case"NodeWidget":a="iconBoth";break;case"NodeIFrame":a="iconLanguage";break;case"NodeVideo":a="iconVideo";break;case"NodeAudio":a="iconRecord";break;case"NodeAttributeView":a="iconDatabase";break}return a},Nt=(e,t,a=!1)=>{if(!t){if(e.includes("dialog")){const n=window.siyuan.dialogs.length;for(let i=0;i<n;i++)window.siyuan.dialogs[i].destroy()}return}if(e.includes("hint")&&(clearTimeout(t.hint.timeId),t.hint.element.classList.add("fn__none")),t.gutter&&e.includes("gutter")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML="",t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(n=>{n.classList.remove("protyle-wysiwyg--hl")})),t.gutter&&e.includes("gutterOnly")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML=""),t.toolbar&&e.includes("toolbar")&&(t.toolbar.element.classList.add("fn__none"),t.toolbar.element.style.display=""),t.toolbar&&e.includes("util")){const n=t.toolbar.subElement.querySelector('[data-type="pin"]');(a||!n||n&&n.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.toolbar.subElement.classList.add("fn__none"),t.toolbar.subElementCloseCB&&(t.toolbar.subElementCloseCB(),t.toolbar.subElementCloseCB=void 0))}e.includes("select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(n=>{n.classList.remove("protyle-wysiwyg--select"),n.removeAttribute("select-start"),n.removeAttribute("select-end")})},Nc=e=>{e.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(t=>{t.classList.add("fn__none"),t.style.display=""}),e.includes("util")&&getAllEditor().forEach(t=>{if(t.protyle.toolbar){const a=t.protyle.toolbar.subElement.querySelector('[data-type="pin"]');(!a||a&&a.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.protyle.toolbar.subElement.classList.add("fn__none"),t.protyle.toolbar.subElementCloseCB&&(t.protyle.toolbar.subElementCloseCB(),t.protyle.toolbar.subElementCloseCB=void 0))}}),e.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(t=>{t.classList.add("fn__none")}),e.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""})},pa=e=>{e.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){e.classList.remove("protyle-wysiwyg--hl")},1024)},Bc=(e,t,a=!1)=>{let n;const i=e.wysiwyg.element;if(!e.preview.element.classList.contains("fn__none")){n=document.getElementById(t),n&&(e.preview.element.scrollTop=n.offsetTop,pa(n));return}if(Array.from(i.querySelectorAll(`[data-node-id="${t}"]`)).find(s=>{if(!isInEmbedBlock(s))return n=s,!0}),n)return Gt(e,n,a),pa(n),n;if(t===e.block.rootID&&e.options.render.title&&e.title.editElement)return pa(e.title.editElement),e.title.editElement},Gt=(e,t,a=!1,n="auto")=>{var i,s,o,l,r,c;if(!e.disabled&&!a&&getSelection().rangeCount>0){const f=getSelection().getRangeAt(0),b=G(f.startContainer);if(b){if(b.classList.contains("code-block")){const T=document.createElement("br");f.insertNode(T),T.scrollIntoView({block:"nearest",behavior:n}),T.remove();return}if(b.classList.contains("av")&&b.dataset.render==="true"){if(((s=(i=b.querySelector(".av__row--header"))==null?void 0:i.getAttribute("style"))==null?void 0:s.indexOf("transform"))>-1||((l=(o=b.querySelector(".av__row--footer"))==null?void 0:o.getAttribute("style"))==null?void 0:l.indexOf("transform"))>-1)return;const T=b.querySelector(".av__cell--select, .av__row--select, .av__gallery-item--select");T?T.scrollIntoView({block:"nearest",behavior:n}):b.scrollIntoView({block:"nearest",behavior:n});return}const p=f.cloneRange(),y=document.createElement("br");f.insertNode(y);const _=e.contentElement,k=y.getBoundingClientRect().top-_.getBoundingClientRect().top;let x=0;k<0?x=_.scrollTop+k:k>_.clientHeight-74&&(x=_.scrollTop+(k+74-_.clientHeight)),x!==0&&_.scroll({top:x,behavior:n}),y.remove(),He(p);return}}if(!t&&((r=document.activeElement)==null?void 0:r.tagName)!=="TEXTAREA"&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&(t=G(ut(e.wysiwyg.element).startContainer)),!t)return;let u=0,g=t;for(;g&&!g.classList.contains("protyle-wysiwyg");)u+=g.offsetTop,g=g.parentElement;let m=0,d=e.element.firstElementChild;for(;d&&!d.classList.contains("protyle-content");)m+=d.clientHeight,d=d.nextElementSibling;if(a){e.contentElement.scroll({top:u-m,behavior:n});return}e.contentElement.scrollTop>u-32?e.contentElement.scroll({top:u-m,behavior:n}):e.contentElement.scrollTop+e.contentElement.clientHeight<u+t.clientHeight-m&&e.contentElement.scroll({top:u+t.clientHeight-m-e.contentElement.clientHeight,behavior:n})},mn=(e,t=0,a=1e3)=>{e.scroll.lastScrollTop=-1,setTimeout(()=>{e.scroll.lastScrollTop=t},a)};class Pc{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(isMobile()?"click":"mouseover",t=>{const a=t.target;if(isMobile()&&(hasClosestByClassName(a,"b3-menu__title")||typeof t.detail=="string"&&t.detail==="back")){const o=this.element.querySelectorAll(".b3-menu__item--show");o.length>0?o[o.length-1].classList.remove("b3-menu__item--show"):(this.element.style.transform="",setTimeout(()=>{this.remove()},Constants.TIMEOUT_DBLCLICK));return}const n=hasClosestByClassName(a,"b3-menu__item");if(!n||n.classList.contains("b3-menu__item--readonly"))return;const i=n.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(s=>{!s.contains(n)&&s!==n&&!n.contains(s)&&s.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(s=>{s.classList.remove("b3-menu__item--current")}),n.classList.add("b3-menu__item--current"),i&&(n.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(i))})}showSubMenu(t){const a=t.parentElement.getBoundingClientRect();t.style.top=a.top-8+"px",t.style.left=a.right+8+"px",t.style.bottom="auto";const n=t.getBoundingClientRect();n.right>window.innerWidth&&(a.left-8>n.width?t.style.left=a.left-8-n.width+"px":t.style.left=window.innerWidth-n.width+"px"),n.bottom>window.innerHeight&&(t.style.top="auto",t.style.bottom="8px")}preventDefault(t){!hasClosestByClassName(t.target,"b3-menu")&&!hasClosestByClassName(t.target,"keyboard__bar")&&t.preventDefault()}addItem(t){const a=new Ee(t);if(a)return this.append(a.element,t.index),a.element}removeScrollEvent(){window.removeEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(t=!1){var a;if(t){const n=window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item--show");if(n.length>0){const i=n[n.length-1];i.classList.remove("b3-menu__item--show"),i.classList.add("b3-menu__item--current"),(a=i.querySelector(".b3-menu__item--current"))==null||a.classList.remove("b3-menu__item--current");return}}window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),this.element.removeAttribute("data-name"),this.element.removeAttribute("data-from"),this.data=void 0}append(t,a){if(t){if(typeof a=="number"){const n=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[a];if(n){n.before(t);return}}this.element.lastElementChild.append(t)}}popup(t){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),setPosition(this.element,t.x-(t.isLeft?this.element.clientWidth:0),t.y,t.h,t.w))}fullscreen(t="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{t==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100%)"}),this.element.lastElementChild.scrollTop=0)}}class Ee{constructor(t){if(!t.ignore){if(t.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=t.label,t.bind&&t.bind(this.element);return}if(this.element=document.createElement("button"),t.disabled&&this.element.setAttribute("disabled","disabled"),t.id&&this.element.setAttribute("data-id",t.id),t.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),t.current&&this.element.classList.add("b3-menu__item--selected"),t.click&&this.element.addEventListener("click",a=>{if(this.element.getAttribute("disabled"))return;let n=t.click(this.element,a);n instanceof Promise&&(n=!1),a.preventDefault(),a.stopImmediatePropagation(),a.stopPropagation(),this.element.parentElement&&!n&&window.siyuan.menus.menu.remove()}),t.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),(t.icon==="iconTrashcan"||t.warning)&&this.element.classList.add("b3-menu__item--warning"),t.element)this.element.append(t.element);else{let a=`<span class="b3-menu__label">${t.label||"&nbsp;"}</span>`;typeof t.iconHTML=="string"?a=t.iconHTML+a:a=`<svg class="b3-menu__icon ${t.iconClass||""}" style="${t.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${t.icon||""}"></use></svg>${a}`,t.accelerator&&(a+=`<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${fa(t.accelerator)}</span>`),t.action&&(a+=`<svg class="b3-menu__action${t.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${t.action}"></use></svg>`),t.checked&&(a+='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),this.element.innerHTML=a}if(t.bind&&(this.element.classList.add("b3-menu__item--custom"),t.bind(this.element)),t.submenu){const a=document.createElement("div");a.classList.add("b3-menu__submenu"),a.innerHTML='<div class="b3-menu__items"></div>',t.submenu.forEach(n=>{var i;a.firstElementChild.append(((i=new Ee(n))==null?void 0:i.element)||"")}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(a)}}}}const gt=(e,t)=>{let a=e;for(;a&&(a.classList.contains("b3-menu__separator")||a.classList.contains("b3-menu__item--readonly")||a.getBoundingClientRect().height===0)&&!a.querySelector(".b3-text-field");)t?a=a.nextElementSibling:a=a.previousElementSibling;return a},Rc=e=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)return!1;const t=e.target;if(window.siyuan.menus.menu.element.contains(t)&&["INPUT","TEXTAREA"].includes(t.tagName))return!1;const a=Constants.KEYCODELIST[e.keyCode];if(a==="\u2193"||a==="\u2191"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let i;if(n?(n.classList.remove("b3-menu__item--current","b3-menu__item--show"),a==="\u2191"?(i=gt(n.previousElementSibling,!1),i||(i=gt(n.parentElement.lastElementChild,!1))):(i=gt(n.nextElementSibling,!0),i||(i=gt(n.parentElement.firstElementChild,!0)))):a==="\u2191"?i=gt(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):i=gt(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),i){i.classList.contains("b3-menu__item")&&i.classList.add("b3-menu__item--current");const s=i.querySelector(":scope > .b3-text-field");s&&s.focus(),i.classList.remove("b3-menu__item--show");const o=i.parentElement.getBoundingClientRect(),l=i.getBoundingClientRect();(o.top>l.top||o.bottom<l.bottom)&&i.scrollIntoView(o.top>l.top)}return!0}else if(a==="\u2192"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!n)return!0;const i=n.querySelector(".b3-menu__submenu");if(!i)return!0;n.classList.remove("b3-menu__item--current"),n.classList.add("b3-menu__item--show");const s=gt(i.firstElementChild.firstElementChild,!0);return s&&s.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(i),!0}else if(a==="\u2190"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!n)return!0;const i=hasClosestByClassName(n,"b3-menu__item--show");return i&&(i.classList.remove("b3-menu__item--show"),i.classList.add("b3-menu__item--current"),n.classList.remove("b3-menu__item--current")),!0}else if(a==="\u21A9"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(n){const i=n.querySelector(".b3-menu__submenu");if(i){n.classList.remove("b3-menu__item--current"),n.classList.add("b3-menu__item--show");const l=gt(i.firstElementChild.firstElementChild,!0);return l&&l.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(i),!0}const s=n.querySelector(".b3-text-field"),o=n.querySelector(".b3-switch");if(s)return s.focus(),!0;o?o.click():n.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.element.contains(n)&&window.siyuan.menus.menu.remove()}else return!1;return!0}};class sl{constructor(){this.menus=[]}addSeparator(t,a){typeof t=="number"?this.menus.splice(t,0,{type:"separator",id:a}):this.menus.push({type:"separator",id:a})}addItem(t){typeof t.index=="number"?this.menus.splice(t.index,0,t):this.menus.push(t)}}class Oc{constructor(t=""){this.eventTarget=document.appendChild(document.createComment(t))}on(t,a){this.eventTarget.addEventListener(t,a)}once(t,a){this.eventTarget.addEventListener(t,a,{once:!0})}off(t,a){this.eventTarget.removeEventListener(t,a)}emit(t,a){return this.eventTarget.dispatchEvent(new CustomEvent(t,{detail:a,cancelable:!0}))}}const il=e=>{const t=new sl;e.detail.menu=t,e.plugins.forEach(a=>{a.eventBus.emit(e.type,e.detail)}),t.menus.length>0&&(e.separatorPosition==="top"&&window.siyuan.menus.menu.append(new Ee({id:"separator_pluginTop",type:"separator"}).element),window.siyuan.menus.menu.append(new Ee({id:"plugin",label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:t.menus}).element),e.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new Ee({id:"separator_pluginBottom",type:"separator"}).element))},pn=(e,t,a)=>{if(e.getAttribute("custom-pinthead")==="true"){const n=e.querySelector("table");n.clientHeight+n.scrollTop<t.offsetTop+t.clientHeight?n.scrollTop=t.offsetTop-n.clientHeight+t.clientHeight+1:n.scrollTop>t.offsetTop-t.clientHeight&&(n.scrollTop=t.offsetTop-t.clientHeight+1)}else scrollCenter(a,t)},nt=e=>{let t=e.previousElementSibling,a=0;for(;t;)a++,t=t.previousElementSibling;return a},ls=(e,t,a=!0)=>{let n=e.previousElementSibling;return n||(e.parentElement.previousElementSibling?n=e.parentElement.previousElementSibling.lastElementChild:e.parentElement.parentElement.tagName==="TBODY"&&e.parentElement.parentElement.previousElementSibling?n=e.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:n=null),n&&(t.selectNodeContents(n),a||t.collapse(!1),focusByRange(t)),n},bn=(e,t,a,n,i)=>{i.insertNode(document.createElement("wbr"));const s=a.outerHTML,o=a.querySelector("table"),l=o.rows[0].cells.length,r=o.rows.length,c=[];for(let u=0;u<r;u++){for(let g=0;g<l;g++)o.rows[u].cells[g]===t[c.length]&&c.push(g);if(c.length>0)break}for(let u=0;u<r;u++)c.forEach(g=>{o.rows[u].cells[g].setAttribute("align",n)});updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,s),focusByWbr(o,i)},os=(e,t,a,n)=>{const i=document.createElement("wbr");t.insertNode(i);const s=n.outerHTML;i.remove();let o="";for(let r=0;r<a.parentElement.childElementCount;r++)o+=`<td align="${a.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(a.tagName==="TH"){const r=n.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`),l=r.firstElementChild):(a.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`),l=a.parentElement.parentElement.nextElementSibling.firstElementChild)}else a.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`),l=a.parentElement.nextElementSibling;t.selectNodeContents(l.cells[nt(a)]),t.collapse(!0),focusByRange(t),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,s),pn(n,l,e)},ll=(e,t,a,n)=>{const i=document.createElement("wbr");t.insertNode(i);const s=n.outerHTML;i.remove();let o="",l=!1;for(let c=0;c<a.parentElement.childElementCount;c++){const u=a.parentElement.children[c];u.className==="fn__none"&&(l=!0),a.tagName==="TH"?o+=`<th class="${u.className}" colspan="${u.colSpan}" align="${u.getAttribute("align")}"></th>`:o+=`<td class="${u.className}" colspan="${u.colSpan}" align="${u.getAttribute("align")}"></td>`}if(l){let c=a.parentElement.previousElementSibling,u=1;for(;c;)u++,Array.from(c.children).forEach(g=>{g.rowSpan>=u&&g.rowSpan>1&&(g.rowSpan=g.rowSpan+1)}),c=c.previousElementSibling}let r;a.parentElement.parentElement.tagName==="THEAD"&&!a.parentElement.previousElementSibling?(a.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${o}</tr></thead>`),r=n.querySelector("thead tr"),a.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",a.parentElement.parentElement.innerHTML.replace(/<th/g,"<td").replace(/<\/th>/g,"</td>")),a.parentElement.parentElement.remove()):(a.parentElement.insertAdjacentHTML("beforebegin",`<tr>${o}</tr>`),r=a.parentElement.previousElementSibling),t.selectNodeContents(r.cells[nt(a)]),t.collapse(!0),focusByRange(t),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,s),pn(n,r,e)},rs=(e,t,a,n,i)=>{const s=document.createElement("wbr");i.insertNode(s);const o=t.outerHTML;s.remove();const l=nt(a),r=t.querySelector("table");for(let c=0;c<r.rows.length;c++){const u=r.rows[c].cells[l],g=document.createElement(u.tagName);u.insertAdjacentElement(n,g),u===a?(g.innerHTML="<wbr> ",g.offsetLeft+g.clientWidth>t.firstElementChild.scrollLeft+t.firstElementChild.clientWidth&&(t.firstElementChild.scrollLeft=g.offsetLeft+g.clientWidth-t.firstElementChild.clientWidth)):g.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(n,"<col style='min-width: 60px;'>"),focusByWbr(t,i),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,o)},ol=(e,t,a,n)=>{if(a.parentElement.parentElement.tagName!=="THEAD"){const i=document.createElement("wbr");t.insertNode(i);const s=n.outerHTML;i.remove();const o=nt(a),l=a.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;a.parentElement.previousElementSibling&&(r=a.parentElement.previousElementSibling),l.childElementCount===1?l.remove():a.parentElement.remove(),t.selectNodeContents(r.cells[o]),t.collapse(!0),focusByRange(t),pn(n,r,e),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,s)}},rl=(e,t,a,n)=>{var i;const s=document.createElement("wbr");t.insertNode(s);const o=a.outerHTML;s.remove();const l=nt(n),r=n.previousElementSibling||n.nextElementSibling;if(r)t.selectNodeContents(r),t.collapse(!0),r.offsetLeft+r.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-a.firstElementChild.clientWidth);else{a.classList.add("protyle-wysiwyg--select"),removeBlock(e,a,t,"remove");return}const c=a.querySelector("table");for(let u=0;u<c.rows.length;u++){const g=c.rows[u].cells;if(g.length===1){c.remove();break}g[l].remove()}(i=a.querySelectorAll("col")[l])==null||i.remove(),updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,o),focusByRange(t)},cl=(e,t,a,n)=>{const i=a.parentElement;if(i.parentElement.tagName==="THEAD")return;t.insertNode(document.createElement("wbr"));const s=n.outerHTML;if(i.previousElementSibling)i.after(i.previousElementSibling);else{const o=i.parentElement.previousElementSibling.firstElementChild;o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.previousElementSibling.append(i)}updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,s),focusByWbr(n,t),scrollCenter(e,i)},dl=(e,t,a,n)=>{const i=a.parentElement;if(i.parentElement.tagName==="TBODY"&&!i.nextElementSibling||i.parentElement.tagName==="THEAD"&&!i.parentElement.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const s=n.outerHTML;if(i.nextElementSibling)i.before(i.nextElementSibling);else{const o=i.parentElement.nextElementSibling.firstElementChild;o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",i)}updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,s),focusByWbr(n,t),scrollCenter(e,i)},ul=(e,t,a,n)=>{if(!a.previousElementSibling)return;t.insertNode(document.createElement("wbr"));const i=n.outerHTML;let s=0;Array.from(a.parentElement.children).find((l,r)=>{if(a===l)return s=r,!0}),n.querySelectorAll("tr").forEach(l=>{l.cells[s].after(l.cells[s-1])}),a.offsetLeft<n.firstElementChild.scrollLeft&&(n.firstElementChild.scrollLeft=a.offsetLeft);const o=n.querySelectorAll("col");o[s].after(o[s-1]),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i),focusByWbr(n,t)},fl=(e,t,a,n)=>{if(!a.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const i=n.outerHTML;let s=0;Array.from(a.parentElement.children).find((l,r)=>{if(a===l)return s=r,!0}),n.querySelectorAll("tr").forEach(l=>{l.cells[s].before(l.cells[s+1])}),a.offsetLeft+a.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=a.offsetLeft+a.clientWidth-n.firstElementChild.clientWidth);const o=n.querySelectorAll("col");o[s].before(o[s+1]),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,i),focusByWbr(n,t)},qc=(e,t,a)=>{var n,i;const s=hasClosestByTag(a.startContainer,"TD")||hasClosestByTag(a.startContainer,"TH"),o=hasClosestBlock(a.startContainer);if(!s||!o)return!1;if(t.key==="Backspace"&&a.toString()===""){const v=hasPreviousSibling(a.startContainer);if(a.startOffset===1&&v.nodeType===1&&v.tagName==="BR"&&a.startContainer.textContent.length===1&&!hasNextSibling(a.startContainer))return v.insertAdjacentHTML("beforebegin","<br>"),!1}if(t.key==="Enter"&&t.shiftKey&&isNotCtrl(t)&&!t.altKey){const v=document.createElement("wbr");a.insertNode(v);const h=o.outerHTML;if(v.remove(),s&&!s.innerHTML.endsWith("<br>")&&s.insertAdjacentHTML("beforeend","<br>"),a.extractContents(),e.toolbar.getCurrentType(a).includes("code")&&a.startContainer.nodeType!==3){const C=document.createElement("br");a.startContainer.after(C),a.setStartAfter(C)}else a.insertNode(document.createElement("br"));return a.collapse(!1),scrollCenter(e),updateTransaction(e,o.getAttribute("data-node-id"),o.outerHTML,h),t.preventDefault(),!0}if(!o.classList.contains("protyle-wysiwyg--select")&&!hasClosestByClassName(o,"protyle-wysiwyg--select")){if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Enter"){t.preventDefault();const v=s.parentElement;if(!v.nextElementSibling&&v.parentElement.tagName==="TBODY"||v.parentElement.tagName==="THEAD"&&!v.parentElement.nextElementSibling)return insertEmptyBlock(e,"afterend",o.getAttribute("data-node-id")),!0;let h=v.nextElementSibling;return h||(h=v.parentElement.nextElementSibling.firstChild),h&&(a.selectNodeContents(h.cells[nt(s)]),a.collapse(!0),scrollCenter(e)),!0}if(t.key==="ArrowRight"&&a.toString()===""&&!o.nextElementSibling&&s===o.querySelector("table").lastElementChild.lastElementChild.lastElementChild&&getSelectionOffset(s,e.wysiwyg.element,a).start===s.textContent.length)return t.preventDefault(),insertEmptyBlock(e,"afterend",o.getAttribute("data-node-id")),!0;if(t.key==="Tab"&&isNotCtrl(t)){if(t.shiftKey)return ls(s,a),t.preventDefault(),!0;let v=s.nextElementSibling;return v||(s.parentElement.nextElementSibling?v=s.parentElement.nextElementSibling.firstElementChild:s.parentElement.parentElement.tagName==="THEAD"&&s.parentElement.parentElement.nextElementSibling?v=s.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:v=null),v?a.selectNodeContents(v):os(e,a,s.parentElement.firstElementChild,o),t.preventDefault(),!0}if(t.key==="ArrowUp"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const v=a.startContainer;let h;for(v.nodeType!==3&&(v.tagName==="TH"||v.tagName==="TD")?h=v.childNodes[Math.min(a.startOffset,v.childNodes.length-1)]:v.parentElement.tagName==="SPAN"?h=v.parentElement.previousElementSibling:h=v.previousElementSibling;h;){if(h.tagName==="BR"&&hasPreviousSibling(h))return!1;h=h.previousElementSibling}const E=s.parentElement;let C=E.previousElementSibling;return C||(C=E.parentElement.previousElementSibling.lastElementChild),!C||(C==null?void 0:C.tagName)==="COL"?!1:(a.selectNodeContents(C.cells[nt(s)]),a.collapse(!1),scrollCenter(e),t.preventDefault(),!0)}if(t.key==="ArrowDown"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const v=a.endContainer;let h;for(v.nodeType!==3&&(v.tagName==="TH"||v.tagName==="TD")?h=(n=v.childNodes[Math.max(0,a.endOffset-1)])==null?void 0:n.nextElementSibling:v.parentElement.tagName==="SPAN"?h=v.parentElement.nextElementSibling:h=v.nextElementSibling;h;){if(h.tagName==="BR"&&h.nextSibling)return!1;h=h.nextElementSibling}const E=s.parentElement;if(!E.nextElementSibling&&E.parentElement.tagName==="TBODY"||E.parentElement.tagName==="THEAD"&&!E.parentElement.nextElementSibling)return!1;let C=E.nextElementSibling;return C||(C=E.parentElement.nextElementSibling.firstChild),C?(a.selectNodeContents(C.cells[nt(s)]),a.collapse(!0),scrollCenter(e),t.preventDefault(),!0):!1}if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Backspace"&&getSelectionOffset(s,e.wysiwyg.element,a).start===0&&a.toString()===""&&(a.startOffset===0||a.startOffset===1&&s.querySelectorAll("br").length===1))return!ls(s,a,!1)&&o.previousElementSibling&&focusBlock(o.previousElementSibling,void 0,!1),scrollCenter(e),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,t))return bn(e,[s],o,"left",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,t))return bn(e,[s],o,"center",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,t))return bn(e,[s],o,"right",a),t.preventDefault(),!0}const l=o.querySelector("table"),r=s.parentElement.querySelector(".fn__none");let c=!1,u=!1;Array.from(s.parentElement.children).forEach(v=>{v.colSpan>1&&(c=!0),v.rowSpan>1&&(u=!0)});let g=!1,m=!1,d=!1,f=s.parentElement.previousElementSibling;!f&&s.parentElement.parentElement.tagName==="TBODY"&&(f=l.querySelector("thead").lastElementChild),f&&(g=f.querySelector(".fn__none"),Array.from(f.children).forEach(v=>{v.colSpan>1&&(m=!0),v.rowSpan>1&&(d=!0)}));let b=!1,p=!1,y=!1,_=s.parentElement.nextElementSibling;!_&&s.parentElement.parentElement.tagName==="THEAD"&&(_=(i=l.querySelector("tbody"))==null?void 0:i.firstElementChild),_&&(b=_.querySelector(".fn__none"),Array.from(_.children).forEach(v=>{v.colSpan>1&&(p=!0),v.rowSpan>1&&(y=!0)}));const k=nt(s);let x=!0;Array.from(l.rows).find(v=>{const h=v.cells[k];if(h.classList.contains("fn__none")||h.colSpan>1||h.rowSpan>1)return x=!1,!0});let T=!0;Array.from(l.rows).find(v=>{const h=v.cells[k+1];if(h&&(h.classList.contains("fn__none")||h.colSpan>1||h.rowSpan>1))return T=!1,!0});let w=!0;if(Array.from(l.rows).find(v=>{const h=v.cells[k-1];if(h&&(h.classList.contains("fn__none")||h.colSpan>1||h.rowSpan>1))return w=!1,!0}),matchHotKey(window.siyuan.config.keymap.editor.table.moveToUp.custom,t))return(!r||r&&!u&&c)&&(!g||g&&!d&&m)&&cl(e,a,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToDown.custom,t))return(!r||r&&!u&&c)&&(!b||b&&!y&&p)&&dl(e,a,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToLeft.custom,t))return x&&w&&ul(e,a,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToRight.custom,t))return x&&T&&fl(e,a,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,t))return ll(e,a,s,o),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,t))return(!b||b&&!y&&p)&&os(e,a,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,t))return(x||w)&&rs(e,o,s,"beforebegin",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,t))return(x||T)&&rs(e,o,s,"afterend",a),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-row"].custom,t))return(!r&&!u||r&&!u&&c)&&ol(e,a,s,o),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-column"].custom,t))return x&&rl(e,a,o,s),t.preventDefault(),!0},gl=e=>e.item.offsetLeft+6>e.tableSelectElement.offsetLeft+e.scrollLeft&&e.item.offsetLeft+e.item.clientWidth-6<e.tableSelectElement.offsetLeft+e.scrollLeft+e.tableSelectElement.clientWidth&&e.item.offsetTop+6>e.tableSelectElement.offsetTop+e.scrollTop&&e.item.offsetTop+e.item.clientHeight-6<e.tableSelectElement.offsetTop+e.scrollTop+e.tableSelectElement.clientHeight,Uc=(e,t)=>{var a;if(!t)return;const n=t.querySelector(".table__select"),i=[],s=t.firstElementChild.scrollLeft,o=t.querySelector("table").scrollTop;if(t.querySelectorAll("th, td").forEach(r=>{!r.classList.contains("fn__none")&&gl({tableSelectElement:n,scrollLeft:s,scrollTop:o,item:r})&&i.push(r)}),n.removeAttribute("style"),getSelection().rangeCount>0){const r=getSelection().getRangeAt(0);t.contains(r.startContainer)&&r.insertNode(document.createElement("wbr"))}const l=t.outerHTML;(a=t.querySelector("wbr"))==null||a.remove(),t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),i.forEach(r=>{r.innerHTML=""}),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,l)};var yn=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const ml=()=>yn(void 0,null,function*(){const e=yield fetchSyncPost("/api/petal/loadPetals",{frontend:getFrontend()});let t="";return e.data.forEach(a=>{t+=a.css||""}),t}),pl=e=>(["ant","material"].includes(window.siyuan.config.appearance.icon)?"":`<script src="${e}appearance/icons/material/icon.js?v=${Constants.SIYUAN_VERSION}"><\/script>`)+`<script src="${e}appearance/icons/${window.siyuan.config.appearance.icon}/icon.js?v=${Constants.SIYUAN_VERSION}"><\/script>`,Fc=e=>{if(["html","htmlmd"].includes(e.type)){const t=showMessage(window.siyuan.languages.exporting,-1),a=e.type==="htmlmd"?"/api/export/exportMdHTML":"/api/export/exportHTML";fetchPost(a,{id:e.id,pdf:!1,removeAssets:!1,merge:!0,savePath:""},n=>yn(void 0,null,function*(){const i=yield yl(n,void 0,"",e);fetchPost("/api/export/exportBrowserHTML",{folder:n.data.folder,html:i,name:n.data.name},s=>{if(hideMessage(t),s.code===-1){showMessage(window.siyuan.languages._kernel[14]+": "+s.msg,0,"error");return}window.open(s.data.zip),showMessage(window.siyuan.languages.exported)})}));return}},bl=()=>{let e="";return document.querySelectorAll("style").forEach(t=>{t.id.startsWith("snippet")&&(e+=t.outerHTML)}),e},yl=(e,t,a,n,i)=>yn(void 0,null,function*(){let s=window.siyuan.config.appearance.themeLight,o=0;["html","htmlmd"].includes(n.type)&&window.siyuan.config.appearance.mode===1&&(s=window.siyuan.config.appearance.themeDark,o=1);const l=window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark==="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight==="daylight";let r="";l||(r=`<link rel="stylesheet" type="text/css" id="themeStyle" href="${a}appearance/themes/${s}/theme.css?${Constants.SIYUAN_VERSION}"/>`);const c=getScreenWidth(),u=isInAndroid()||isInHarmony()?`document.body.style.minWidth = "${c}px"`:"",g=`<!DOCTYPE html>
<html lang="${window.siyuan.config.appearance.lang}" data-theme-mode="${getThemeMode()}" data-light-theme="${window.siyuan.config.appearance.themeLight}" data-dark-theme="${window.siyuan.config.appearance.themeDark}">
<head>
    <base href="${a}">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="${a}stage/build/export/base.css?v=${Constants.SIYUAN_VERSION}"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="${a}appearance/themes/${s}/theme.css?v=${Constants.SIYUAN_VERSION}"/>
    <script src="${a}stage/protyle/js/protyle-html.js?v=${Constants.SIYUAN_VERSION}"><\/script>
    ${r}
    <title>${e.data.name}</title>
    <!-- Exported by SiYuan v${Constants.SIYUAN_VERSION} -->
    <style>
        body {font-family: var(--b3-font-family);background-color: var(--b3-theme-background);color: var(--b3-theme-on-background)}
        ${yield setInlineStyle(!1,a)}
        ${yield ml()}
    </style>
    ${bl()}
</head>
<body>
<div class="${["htmlmd","word"].includes(n.type)?"b3-typography":"protyle-wysiwyg"+(window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":"")}" 
style="${isInAndroid()||isInHarmony()?"margin: 0 16px;":"max-width: 800px;margin: 0 auto;"}" id="preview">${e.data.content}</div>
${pl(a)}
<script src="${a}stage/build/export/protyle-method.js?v=${Constants.SIYUAN_VERSION}"><\/script>
<script src="${a}stage/protyle/js/lute/lute.min.js?v=${Constants.SIYUAN_VERSION}"><\/script>  
<script>
    ${u};
    window.siyuan = {
      config: {
        appearance: { mode: ${o}, codeBlockThemeDark: "${window.siyuan.config.appearance.codeBlockThemeDark}", codeBlockThemeLight: "${window.siyuan.config.appearance.codeBlockThemeLight}" },
        editor: { 
          codeLineWrap: true,
          fontSize: ${window.siyuan.config.editor.fontSize},
          codeLigatures: ${window.siyuan.config.editor.codeLigatures},
          plantUMLServePath: "${window.siyuan.config.editor.plantUMLServePath}",
          codeSyntaxHighlightLineNum: ${window.siyuan.config.editor.codeSyntaxHighlightLineNum},
          katexMacros: decodeURI(\`${encodeURI(window.siyuan.config.editor.katexMacros)}\`),
        }
      },
      languages: {copy:"${window.siyuan.languages.copy}"}
    };
    const previewElement = document.getElementById('preview');
    Protyle.highlightRender(previewElement, "stage/protyle");
    Protyle.mathRender(previewElement, "stage/protyle", ${n.type==="pdf"});
    Protyle.mermaidRender(previewElement, "stage/protyle");
    Protyle.flowchartRender(previewElement, "stage/protyle");
    Protyle.graphvizRender(previewElement, "stage/protyle");
    Protyle.chartRender(previewElement, "stage/protyle");
    Protyle.mindmapRender(previewElement, "stage/protyle");
    Protyle.abcRender(previewElement, "stage/protyle");
    Protyle.htmlRender(previewElement);
    Protyle.plantumlRender(previewElement, "stage/protyle");
    document.querySelectorAll(".protyle-action__copy").forEach((item) => {
      item.addEventListener("click", (event) => {
            let text = item.parentElement.nextElementSibling.textContent.trimEnd();
            text = text.replace(/\xA0/g, " "); // Replace non-breaking spaces with normal spaces when copying
            navigator.clipboard.writeText(text);
            event.preventDefault();
            event.stopPropagation();
      })
    });
<\/script></body></html>`;if(typeof t=="undefined")return g}),Yc=(e,t,a)=>{if(isMobile())return;const n=t.getBoundingClientRect();if(n.height===0||!e){ba();return}const i=document.getElementById("tooltip");i.className=a?`tooltip tooltip--${a}`:"tooltip",i.innerHTML=e,i.removeAttribute("style");const s=t.getAttribute("data-position"),o=t.parentElement.getBoundingClientRect();let l,r;if(s==="parentE")r=Math.max(0,o.top-(i.clientHeight-o.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),l=o.right+8,l+i.clientWidth>window.innerWidth&&(l=o.left-i.clientWidth-8);else if(s==="parentW")r=Math.max(0,o.top-(i.clientHeight-o.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),l=o.left-i.clientWidth,l<0&&(l=o.right);else if(s!=null&&s.endsWith("west")){const c=parseInt(s)||.5;r=Math.max(0,n.top-(i.clientHeight-n.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),l=n.left-i.clientWidth-c,l<0&&(l=n.right)}else if(s==="north")l=Math.max(0,n.left-(i.clientWidth-n.width)/2),r=n.top-i.clientHeight-.5,r<0&&(n.top<window.innerHeight-n.bottom?(r=n.bottom+.5,i.style.maxHeight=window.innerHeight-r+"px"):(r=0,i.style.maxHeight=n.top-.5+"px")),l+i.clientWidth>window.innerWidth&&(l=window.innerWidth-i.clientWidth);else{const c=parseInt(s)||.5;l=Math.max(0,n.left-(i.clientWidth-n.width)/2),r=n.bottom+c,r+i.clientHeight>window.innerHeight&&(n.top-c>window.innerHeight-r?(r=n.top-c-i.clientHeight,i.style.maxHeight=n.top-c+"px"):i.style.maxHeight=window.innerHeight-r+"px"),l+i.clientWidth>window.innerWidth&&(l=window.innerWidth-i.clientWidth)}i.style.top=r+"px",i.style.left=l+"px"},ba=()=>{document.getElementById("tooltip").classList.add("fn__none")},hl=()=>{const e=[];return window.siyuan.mobile.editor&&e.push(window.siyuan.mobile.editor),window.siyuan.mobile.popEditor&&e.push(window.siyuan.mobile.popEditor),e},_l=(e,t)=>/\r\n|\r|\n|\u2028|\u2029|\t/.test(e)?(t?showTooltip(window.siyuan.languages.fileNameRule,t,"error"):showMessage(window.siyuan.languages.fileNameRule),!1):e.length>Constants.SIZE_TITLE?(t?showTooltip(window.siyuan.languages._kernel[106],t,"error"):showMessage(window.siyuan.languages._kernel[106]),!1):!0,hn=e=>(e.indexOf("/")>-1&&(tt(window.siyuan.languages.fileNameRule),e=e.replace(/\//g,"\uFF0F")),e.replace(/\r\n|\r|\n|\u2028|\u2029|\t|/g,"").substring(0,H.SIZE_TITLE)),Wc=e=>e.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),jc=e=>{if(window.siyuan.config.readonly)return;const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",destroyCallback(){e.range&&focusByRange(e.range)}});t.element.setAttribute("data-key",Constants.DIALOG_RENAME);const a=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{n[1].click()}),a.value=Lute.UnEscapeHTMLStr(e.name),a.focus(),a.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{if(!_l(a.value))return!1;if(a.value===e.name)return t.destroy(),!1;a.value.trim()===""?a.value=window.siyuan.languages.untitled:a.value=hn(a.value),e.type==="notebook"?fetchPost("/api/notebook/renameNotebook",{notebook:e.notebookId,name:a.value},()=>{setNotebookName(e.notebookId,a.value)}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:a.value}),t.destroy()})},wl=e=>{const t=new Xn({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:O()?"92vw":"520px"});t.element.setAttribute("data-key",H.DIALOG_RENAMEASSETS);const a=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{n[1].click()});const i=Xi(e);a.value=i,a.focus(),a.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{if(a.value===i||!a.value)return t.destroy(),!1;Ce("/api/asset/renameAsset",{oldPath:e,newName:a.value},s=>{hl().forEach(o=>{o.reload(!1)}),t.destroy()})})},Vc=e=>{if(getSelection().rangeCount===0)return;const t=getSelection().getRangeAt(0),a=hasClosestBlock(t.startContainer);if(!a)return;let n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&(n=[a]);let i="",s=t.toString();if(s===""){if(s=n[0].textContent,n.forEach(o=>{i+=removeEmbed(o)}),!s)return}else{const o=document.createElement("div");o.appendChild(t.cloneContents()),i=o.innerHTML}s.length>10&&(s=s.substr(0,10)+"..."),s=hn(s),fetchPost("/api/filetree/createDoc",{notebook:e.notebookId,path:pathPosix().join(getDisplayName(e.path,!1,!0),Lute.NewNodeID()+".sy"),title:s,md:e.lute.BlockDOM2StdMd(i)})};var cs=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Gc=(e,t)=>{},zc=e=>{const t=new Dialog({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${isMobile()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${isMobile()?"margin: 8px 0":"padding: 48px;margin: 8px 0"}" class="export-img">
        <div ${isMobile()?'style="padding:8px"':""} class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export30}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1 export-img__space"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:isMobile()?"92vw":"990px",height:"70vh"});t.element.setAttribute("data-key",Constants.DIALOG_EXPORTIMAGE);const a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>cs(void 0,null,function*(){const r=showMessage(window.siyuan.languages.exporting,0),c=t.element.querySelector(".b3-dialog__container");c.style.height="",c.style.width="100vw";const u=t.element.querySelector(".b3-dialog__content");u.style.overflow="hidden",setStorageVal(Constants.LOCAL_EXPORTIMG,window.siyuan.storage[Constants.LOCAL_EXPORTIMG]);const g=n.querySelectorAll("[data-subtype='plantuml']");for(let m=0;m<g.length;m++){const d=g[m].querySelector("object");if(d){const b=yield(yield fetch(d.getAttribute("data"))).text();d.insertAdjacentHTML("beforebegin",b),d.remove()}}n.querySelectorAll(".protyle-linenumber__rows span").forEach((m,d)=>{m.textContent=(d+1).toString()}),setTimeout(()=>{addScript("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>cs(void 0,null,function*(){let m=yield window.htmlToImage.toBlob(t.element.querySelector(".b3-dialog__content"));(isIPhone()||isSafari())&&(yield window.htmlToImage.toBlob(u),yield window.htmlToImage.toBlob(u),yield window.htmlToImage.toBlob(u),m=yield window.htmlToImage.toBlob(u));const d=new FormData;d.append("file",m,a[1].getAttribute("data-title")),d.append("type","image/png"),fetchPost("/api/export/exportAsFile",d,f=>{openByMobile(f.data.file)}),hideMessage(r),t.destroy()}))},Constants.TIMEOUT_LOAD)}));const n=t.element.querySelector(".protyle-wysiwyg"),i=t.element.querySelector("#keepFold");i.addEventListener("change",()=>{a[0].setAttribute("disabled","disabled"),a[1].setAttribute("disabled","disabled"),a[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold=i.checked,fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:i.checked,image:!0},r=>{l(r)})});const s=t.element.querySelector("#watermark");s.addEventListener("change",()=>{window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark=s.checked,o()});const o=()=>{const r=t.element.querySelector(".export-img__watermark");r.innerHTML="",s.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):addScript("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>{const c=Math.max(t.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${c}px;height: ${c}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.htmlToImage.toCanvas(r).then(u=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${u.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},l=r=>{n.innerHTML=r.data.content,n.setAttribute("data-doc-type",r.data.type||"NodeDocument"),Object.keys(r.data.attrs).forEach(c=>{n.setAttribute(c,r.data.attrs[c])}),n.querySelectorAll(".code-block").forEach(c=>{c.setAttribute("linewrap","true")}),processRender(n),highlightRender(n),n.querySelectorAll("table").forEach(c=>{c.clientWidth>c.parentElement.clientWidth&&(c.setAttribute("style",`margin-bottom:${c.parentElement.clientWidth*c.clientHeight/c.clientWidth-c.parentElement.clientHeight+1}px;transform: scale(${c.parentElement.clientWidth/c.clientWidth});transform-origin: top left;`),c.parentElement.style.overflow="hidden")}),o(),a[0].removeAttribute("disabled"),a[1].removeAttribute("disabled"),t.element.querySelector(".fn__loading").remove()};fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:i.checked,image:!0},r=>{l(r),a[1].setAttribute("data-title",r.data.name+".png")})},Kc=(e,t,a,n)=>{!vl()||(!t||t.length===0)&&!a||setTimeout(()=>{e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.rangeIndex=0,e.highlight.ranges=[];let i=!1,s;typeof a=="string"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id='${a}']`)).find(d=>{if(!isInEmbedBlock(d))return s=d,!0}),!s&&a===e.block.rootID&&e.title&&!e.title.element.classList.contains("fn__none")&&(s=e.title.element);const o=[],l=[];let r=0;const c=document.createTreeWalker(e.contentElement,NodeFilter.SHOW_TEXT);let u=c.nextNode();for(;u;)o.push(u),r+=u.textContent.length,l.push(r),u=c.nextNode();const g=e.contentElement.textContent,m=[];if(t&&t.length>0&&t.forEach(d=>{if(!d)return;let f=0,b=0,p=0;for(;(f=g.indexOf(d,f))!==-1;){const y=new Range;b=f+d.length;try{for(;p<o.length&&l[p]<=f;)p++;let _=o[p];for(y.setStart(_,f-(p?l[p-1]:0));p<o.length&&l[p]<b;)p++;_=o[p],y.setEnd(_,b-(p?l[p-1]:0));let k=!1;!i&&s&&s.contains(_)&&(i=!0,k=!0),m.push({range:y,startIndex:f,isCurrent:k})}catch(_){console.error("searchMarkRender error:",_)}f=b}}),!i&&s){const d=g.indexOf(s.textContent);if(d>-1){const f=new Range;let b=0;for(;o.length&&l[b]<=d;)b++;f.setStart(o[b],0),m.push({range:f,startIndex:d,isCurrent:!0})}}m.sort((d,f)=>f.startIndex>d.startIndex?-1:0).forEach((d,f)=>{typeof a=="string"&&d.isCurrent||typeof a=="number"&&a===f?(e.highlight.rangeIndex=f,e.highlight.markHL.add(d.range)):e.highlight.mark.add(d.range),e.highlight.ranges.push(d.range)}),CSS.highlights.set("search-mark-"+e.highlight.styleElement.dataset.uuid,e.highlight.mark),typeof a!="undefined"&&CSS.highlights.set("search-mark-hl-"+e.highlight.styleElement.dataset.uuid,e.highlight.markHL),n&&n()},e.wysiwyg.element.querySelector(".hljs")?Constants.TIMEOUT_TRANSITION:0)},vl=()=>!!(CSS&&CSS.highlights),Zc=e=>{var t,a;if(e){hideElements(["util"],e),isSupportCSSHL()&&(e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.ranges=[],e.highlight.rangeIndex=0),(t=e.observer)==null||t.disconnect(),(a=e.observerLoad)==null||a.disconnect(),e.element.classList.remove("protyle"),e.element.removeAttribute("style"),e.wysiwyg&&(e.wysiwyg.lastHTMLs={}),e.undo&&e.undo.clear();try{e.ws.send("closews",{})}catch(n){setTimeout(()=>{e.ws.send("closews",{})},10240)}e.app.plugins.forEach(n=>{n.eventBus.emit("destroy-protyle",{protyle:e})})}},Xc=e=>{if(!e)return"";const t=pathPosix().extname(e).toLowerCase();return Constants.SIYUAN_ASSETS_IMAGE.includes(t)?`<img style="max-height: 100%" src="${e}">`:Constants.SIYUAN_ASSETS_AUDIO.includes(t)?`<audio style="max-width: 100%" controls="controls" src="${e}"></audio>`:Constants.SIYUAN_ASSETS_VIDEO.includes(t)?`<video style="max-width: 100%" controls="controls" src="${e}"></video>`:e},Jc=()=>{},Qc=(e,t,a,n)=>{let i="";if(Constants.SIYUAN_ASSETS_AUDIO.includes(e))i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${t}"></audio>${Constants.ZWSP}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`;else if(Constants.SIYUAN_ASSETS_IMAGE.includes(e)){let s="";t.startsWith("assets/")||(s='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),i=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${t}" data-src="${t}" alt="${a}" /><span class="protyle-action__drag"></span>${s}<span class="protyle-action__title"></span></span><span> </span></span>`}else Constants.SIYUAN_ASSETS_VIDEO.includes(e)?i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${Constants.ZWSP}<video controls="controls" src="${t}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:i=`<span data-type="a" data-href="${t}">${n}</span>`;return i};class ed{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const El=(e,t)=>{const a=[];let n="",i="";for(let o=t.length,l=0;l<o;l++){const r=t[l];let c=!0;r.name||(n+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>e.options.upload.max&&(n+=`<li>${r.name} ${window.siyuan.languages.over} ${e.options.upload.max/1024/1024}M</li>`,c=!1);const u=r.name.lastIndexOf("."),g=u===-1?"":r.name.substr(u),m=u===-1?r.name:e.options.upload.filename(r.name.substr(0,u))+g;e.options.upload.accept&&(e.options.upload.accept.split(",").some(f=>{const b=f.trim();if(b.indexOf(".")===0){if(g.toLowerCase()===b.toLowerCase())return!0}else if(r.type.split("/")[0]===b.split("/")[0])return!0;return!1})||(n+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(a.push(r),i+=`<li>${m} ${window.siyuan.languages.uploading}</li>`)}let s;return(n!==""||i!=="")&&(s=showMessage(`<ul>${n}${i}</ul>`,-1)),{files:a,msgId:s}},ds=(e,t)=>{var a,n,i;const s=JSON.parse(e);let o="";s.code===1&&(o=`${s.msg}`),s.data.errFiles&&s.data.errFiles.length>0&&(o=`<ul><li>${o}</li>`,s.data.errFiles.forEach(f=>{const b=f.lastIndexOf("."),p=b===-1?f:t.options.upload.filename(f.substr(0,b))+f.substr(b);o+=`<li>${p} ${window.siyuan.languages.uploadError}</li>`}),o+="</ul>"),o&&showMessage(o);let l=!0;const r=getEditorRange(t.wysiwyg.element);r.toString()===""&&r.startContainer.nodeType===3&&t.toolbar.getCurrentType(r).length>0&&(r.setEndAfter(r.startContainer.parentElement),r.collapse(!1));const c=Object.keys(s.data.succMap),u=hasClosestBlock(r.startContainer);if(u)if(u.classList.contains("table"))l=!1;else{const f=getContenteditableElement(u);f&&u.classList.contains("p")&&(f.textContent!==""||c.length<2)&&(l=!1)}let g="";c.sort((f,b)=>f.localeCompare(b,void 0,{numeric:!0}));const m=[];let d=!1;if(c.forEach((f,b)=>{const p=s.data.succMap[f],y=pathPosix().extname(f).toLowerCase(),_=t.options.upload.filename(f),k=_.substring(0,_.length-y.length);d=Constants.SIYUAN_ASSETS_IMAGE.includes(y),m.push({type:Constants.SIYUAN_ASSETS_IMAGE.includes(y)?"image":"file",content:p,name:k}),g+=genAssetHTML(y,p,k,_),!Constants.SIYUAN_ASSETS_AUDIO.includes(y)&&!Constants.SIYUAN_ASSETS_VIDEO.includes(y)&&c.length-1!==b&&(u&&u.classList.contains("table")?g+="<br>":l?g+=`

`:g+=`
`)}),document.querySelector(".av__panel")){const f=[document.querySelector('.custom-attr__avvalue[data-type="mAsset"][data-active="true"]')];if(f[0]||(f.splice(0,1),t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(b=>{getTypeByCellElement(b)==="mAsset"&&f.push(b)}),f.length===0&&((n=(a=document.querySelector(".av__panel .b3-menu__items"))==null?void 0:a.getAttribute("data-ids"))==null||n.split(",").forEach(b=>{const p=t.wysiwyg.element.querySelector(`.av__gallery-fields [data-dtype="mAsset"][data-id="${b}"]`);p&&f.push(p)}))),f.length>0){const b=hasClosestBlock(f[0]);if(b){updateCellsValue(t,b,m,f),(i=document.querySelector(".av__panel"))==null||i.remove();return}}else return}else if(u&&u.classList.contains("av")){const f=[];if(u.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(b=>{b.querySelectorAll(".av__cell").forEach(p=>{getTypeByCellElement(p)==="mAsset"&&f.push(p)})}),f.length===0&&t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(b=>{getTypeByCellElement(b)==="mAsset"&&f.push(b)}),f.length>0){updateCellsValue(t,u,m,f);return}else return}insertHTML(g,t,l),setTimeout(()=>{scrollCenter(t,void 0,!1,"smooth")},d?0:Constants.TIMEOUT_LOAD)},kl=(e,t,a)=>{const n=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:a,id:t.block.rootID},i=>{hideMessage(n);let s="";Object.keys(i.data.succMap).forEach(o=>{i.data.succMap[o].startsWith("file:")&&(s+=o+", ")}),s&&showMessage(window.siyuan.languages.dndFolderTip.replace("${x}",`<b>${s.substring(0,s.length-2)}</b>`)),ds(JSON.stringify(i),t)})},td=(e,t,a,n)=>{if(!e){const u=new FormData;for(let m=0,d=t.length;m<d;m++)u.append("file[]",t[m]);const g=new XMLHttpRequest;g.open("POST",Constants.UPLOAD_ADDRESS),g.onreadystatechange=()=>{g.readyState===XMLHttpRequest.DONE&&(g.status===200?n(g.responseText):g.status===0?showMessage(window.siyuan.languages.fileTypeError):showMessage(g.responseText),a&&(a.value=""))},g.send(u);return}let i=[];for(let u=0;u<t.length;u++){let g=t[u];g instanceof DataTransferItem&&(g=g.getAsFile()),g.size===0&&g.type===""&&g.name.indexOf(".")===-1?kl([g.path],e,!1):i.push(g)}if(e.options.upload.handler){const u=e.options.upload.handler(i);if(typeof u=="string"){showMessage(u);return}return}if(!e.options.upload.url||!e.upload){a&&(a.value=""),showMessage("please config: options.upload.url");return}if(e.options.upload.file&&(i=e.options.upload.file(i)),e.options.upload.validate){const u=e.options.upload.validate(i);if(typeof u=="string"){showMessage(u);return}}const s=e.wysiwyg.element,o=El(e,i);if(o.files.length===0){a&&(a.value="");return}const l=new FormData,r=e.options.upload.extraData;for(const u of Object.keys(r))l.append(u,r[u]);for(let u=0,g=o.files.length;u<g;u++)l.append(e.options.upload.fieldName,o.files[u]);l.append("id",e.block.rootID);const c=new XMLHttpRequest;c.open("POST",e.options.upload.url),e.options.upload.token&&c.setRequestHeader("X-Upload-Token",e.options.upload.token),e.options.upload.withCredentials&&(c.withCredentials=!0),e.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(e.upload.isUploading=!1,!document.body.contains(e.element)){destroy(e);return}if(c.status===200)if(hideMessage(o.msgId),e.options.upload.success)e.options.upload.success(s,c.responseText);else if(n)n(c.responseText);else{let u=c.responseText;e.options.upload.format&&(u=e.options.upload.format(t,c.responseText)),ds(u,e)}else c.status===0?showMessage(window.siyuan.languages.fileTypeError):e.options.upload.error?e.options.upload.error(c.responseText):showMessage(c.responseText);a&&(a.value=""),e.upload.element.style.display="none"}},c.upload.onprogress=u=>{if(!u.lengthComputable)return;const g=u.loaded/u.total*100;e.upload.element.style.display="block";const m=e.upload.element;m.style.width=g+"%"},c.send(l)},ad=(e,t,a,n=!1)=>{let i=Lute.UnEscapeHTMLStr(t),s;if(isLocalPath(i)&&!i.startsWith("file://")&&i.indexOf(".pdf")>-1){const o=i.split("/");o.length===3&&o[0]==="assets"&&o[1].endsWith(".pdf")&&/\d{14}-\w{7}/.test(o[2])?(i=`assets/${o[1]}`,s=o[2]):(s=parseInt(getSearch("page",i)),i=i.split("?page")[0])}openByMobile(i)};var Cl=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Al=e=>({id:"export",label:window.siyuan.languages.export,icon:"iconUpload",click(){return Cl(this,null,function*(){Yi(e)})}}),nd=(e,t,a,n,i=!1)=>{},sd=e=>{if(isInAndroid())window.JSAndroid.writeImageClipboard(e);else{const t=document.createElement("canvas"),a=document.createElement("img");a.onload=n=>{t.width=n.target.width,t.height=n.target.height,t.getContext("2d").drawImage(n.target,0,0,n.target.width,n.target.height),t.toBlob(i=>{navigator.clipboard.write([new ClipboardItem({"image/png":i})])},"image/png",1)},a.src=e}},us=(e,t)=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{const a=document.createElement("ul");let n="",i=-1;e.forEach((s,o)=>{s&&(n+=`<li><img src="${s}"></li>`,t&&i===-1&&(t.endsWith(encodeURI(s))||t.endsWith(s))&&(i=o))}),a.innerHTML=n,window.siyuan.viewer=new Viewer(a,{initialViewIndex:t?i:0,title:[1,(s,o)=>{let l=s.alt;return l||(l=s.src.substring(s.src.lastIndexOf("/")+1)),l=l.substring(0,l.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${l} [${o.naturalWidth} \xD7 ${o.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},id=(e,t)=>{fetchPost("/api/asset/getDocImageAssets",{id:t},a=>{us(a.data,e)})},ld=(e,t,a,n)=>{fetchPost("/api/av/getCurrentAttrViewImages",{id:t,viewID:a,query:n},i=>{us(i.data,e)})},Sl=e=>{e.menuElement.querySelector("input").addEventListener("change",t=>{t.target.files.length!==0&&uploadFiles(e.protyle,t.target.files,t.target,a=>{const n=JSON.parse(a),i=[];Object.keys(n.data.succMap).forEach(s=>{i.push({name:s,content:n.data.succMap[s],type:Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(n.data.succMap[s]).toLowerCase())?"image":"file"})}),zt({protyle:e.protyle,cellElements:e.cellElements,addValue:i,blockElement:e.blockElement})})})},Ll=e=>{let t="";genCellValueByElement("mAsset",e[0]).mAsset.forEach((n,i)=>{let s;n.type==="image"?s=`<span data-type="openAssetItem" class="fn__flex-1 ariaLabel" aria-label="${n.content}">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${getCompressURL(n.content)}"/>
</span>`:s=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label ariaLabel" aria-label="${escapeAttr(n.content)}" style="max-width: 360px">${n.name||n.content}</span>`,t+=`<button class="b3-menu__item" draggable="true" data-index="${i}" data-name="${escapeAttr(n.name)}" data-type="${n.type}" data-content="${escapeAttr(n.content)}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${s}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`});const a=[];return e.forEach(n=>{a.push(n.dataset.id)}),`<div class="b3-menu__items" data-ids="${a}">
    ${t}
    <button data-type="addAssetExist" class="b3-menu__item b3-menu__item--current">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},zt=e=>{const t=e.blockElement.getAttribute("data-av-type"),a=getColId(e.cellElements[0],t),n=[],i=[];let s;e.cellElements.forEach((l,r)=>{var c,u;const g=getFieldIdByCellElement(l,t);e.blockElement.contains(l)||(t==="table"?l=e.cellElements[r]=e.blockElement.querySelector(`.av__row[data-id="${g}"] .av__cell[data-col-id="${l.dataset.colId}"]`)||e.blockElement.querySelector(`.fn__flex-1[data-col-id="${l.dataset.colId}"]`):l=e.cellElements[r]=e.blockElement.querySelector(`.av__gallery-item[data-id="${g}"] .av__cell[data-field-id="${l.dataset.fieldId}"]`));const m=genCellValueByElement(getTypeByCellElement(l)||l.dataset.type,l),d=JSON.parse(JSON.stringify(m));r===0?(typeof e.removeIndex=="number"?m.mAsset.splice(e.removeIndex,1):((c=e.addValue)==null?void 0:c.length)>0?m.mAsset=m.mAsset.concat(e.addValue):e.updateValue?m.mAsset.find((b,p)=>{if(p===e.updateValue.index)return b.content=e.updateValue.value.content,b.type=e.updateValue.value.type,b.name=e.updateValue.value.name,!0}):((u=e.replaceValue)==null?void 0:u.length)>0&&(m.mAsset=e.replaceValue),s=m.mAsset):m.mAsset=s;const f=e.blockElement.getAttribute("data-av-id");n.push({action:"updateAttrViewCell",id:m.id,keyID:a,rowID:g,avID:f,data:m}),i.push({action:"updateAttrViewCell",id:m.id,keyID:a,rowID:g,avID:f,data:d}),l.classList.contains("custom-attr__avvalue")?l.innerHTML=genAVValueHTML(m):updateAttrViewCellAnimation(l,m)}),n.push({action:"doUpdateUpdated",id:e.blockElement.getAttribute("data-node-id"),data:dayjs().format("YYYYMMDDHHmmss")}),transaction(e.protyle,n,i);const o=document.querySelector(".av__panel > .b3-menu");if(o){o.innerHTML=Ll(e.cellElements),Sl({protyle:e.protyle,menuElement:o,cellElements:e.cellElements,blockElement:e.blockElement});const l=(e.cellElements[0].classList.contains("custom-attr__avvalue")?e.cellElements[0]:e.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${e.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{setPosition(o,l.left,l.bottom,l.height)},Constants.TIMEOUT_LOAD)}},od=e=>{const t=removeCompressURL(e.content),a=e.type,n=new Menu(Constants.MENU_AV_ASSET_EDIT,()=>{!o[1]&&o[0].value===t||o[1]&&o[0].value===t&&o[1].value===e.name||zt({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,updateValue:{index:e.index,value:{content:o[0].value,name:o[1]?o[1].value:"",type:a}}})});if(n.isOpen)return;a==="file"?(n.addItem({id:"linkAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){writeText(c.parentElement.nextElementSibling.value),showMessage(window.siyuan.languages.copied);break}c=c.parentElement}})}}),n.addSeparator({id:"separator_1"}),n.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(`[${o[1].value||o[0].value}](${o[0].value})`)}})):(n.addItem({id:"link",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){writeText(c.parentElement.nextElementSibling.value),showMessage(window.siyuan.languages.copied);break}c=c.parentElement}})}}),n.addSeparator({id:"separator_1"}),n.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(`![](${t.replace(/%20/g," ")})`)}}),n.addItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,icon:"iconImage",click(){copyPNGByLink(t)}})),n.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){zt({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,removeIndex:e.index})}}),t!=null&&t.startsWith("assets/")&&n.addItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){var l;renameAsset(t),(l=document.querySelector(".av__panel"))==null||l.remove()}});const i=openMenu(e.protyle?e.protyle.app:window.siyuan.ws.app,t,!0,!1);(a!=="file"||i.length>0)&&n.addSeparator({id:"separator_2"}),a!=="file"&&n.addItem({id:"cardPreview",icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){var l;previewAttrViewImages(t,e.blockElement.getAttribute("data-av-id"),e.blockElement.getAttribute(Constants.CUSTOM_SY_AV_VIEW),((l=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:l.value.trim())||"")}}),i.length>0&&window.siyuan.menus.menu.append(new MenuItem({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element),t!=null&&t.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem(exportAsset(t)).element);const s=e.rect;n.open({x:s.right,y:s.top,w:s.width,h:s.height});const o=n.element.querySelectorAll("textarea");o[0].value=t,o[0].focus(),o[0].select(),o.length>1&&(o[1].value=e.name)},rd=(e,t,a,n)=>{const i=new Menu(Constants.MENU_AV_ASSET_EDIT,()=>{const o=i.element.querySelectorAll("textarea");!o[0].value&&!o[1].value||zt({protyle:e,cellElements:t,blockElement:n,addValue:[{type:"file",name:o[1].value,content:o[0].value}]})});if(i.isOpen)return;i.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`});const s=a.getBoundingClientRect();i.open({x:s.right,y:s.bottom,w:a.parentElement.clientWidth+8,h:s.height}),i.element.querySelector("textarea").focus()},cd=(e,t,a)=>{const n=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:!0,id:t.block.rootID},i=>{const s=hasClosestBlock(a);if(s){hideMessage(n);const o=[];Object.keys(i.data.succMap).forEach(l=>{const r=pathPosix().extname(l).toLowerCase(),c=l.substring(0,l.length-r.length);Constants.SIYUAN_ASSETS_IMAGE.includes(r)?o.push({type:"image",name:c,content:i.data.succMap[l]}):o.push({type:"file",name:c,content:i.data.succMap[l]})}),zt({protyle:t,blockElement:s,cellElements:[a],addValue:o})}})},xl=e=>{var t,a;let n="";const i=e[e.type];switch(e.type){case"block":e!=null&&e.isDetached?n=`<span>${((t=e.block)==null?void 0:t.content)||window.siyuan.languages.untitled}</span>`:n=`<span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext--ref">${((a=e.block)==null?void 0:a.content)||window.siyuan.languages.untitled}</span>`;break;case"text":n=e.text.content;break;case"number":n=e.number.formattedContent||e.number.content.toString();break;case"date":case"updated":case"created":i.formattedContent?n=i.formattedContent:(i&&i.isNotEmpty&&(n=dayjs(i.content).format(i.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),i&&i.hasEndDate&&i.isNotEmpty&&i.isNotEmpty2&&(n=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(i.content2).format(i.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),n&&(n=`<span class="av__celltext">${n}</span>`);break;case"url":n=e.url.content?`<a class="fn__a" href="${e.url.content}" target="_blank">${e.url.content}</a>`:"";break;case"phone":n=e.phone.content?`<a class="fn__a" href="tel:${e.phone.content}" target="_blank">${e.phone.content}</a>`:"";break;case"email":n=e.email.content?`<a class="fn__a" href="mailto:${e.email.content}" target="_blank">${e.email.content}</a>`:"";break}return n},fs=e=>{var t,a,n,i,s,o,l,r;let c="";switch(e.type){case"block":c=`<input data-id="${e.block.id}" value="${escapeAttr(e.block.content)}" type="text" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">`;break;case"text":c=`<textarea style="resize: vertical" rows="${(((t=e.text)==null?void 0:t.content)||"").split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">${((a=e.text)==null?void 0:a.content)||""}</textarea>`;break;case"number":c=`<input value="${e.number.isNotEmpty?e.number.content:""}" type="number" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span><span class="fn__flex-center ft__on-surface b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.format}">${e.number.formattedContent}</span><span class="fn__space"></span>`;break;case"mSelect":case"select":(n=e.mSelect)==null||n.forEach((u,g)=>{e.type==="select"&&g>0||(c+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${u.color});color:var(--b3-font-color${u.color})">${escapeHtml(u.content)}</span>`)});break;case"mAsset":(i=e.mAsset)==null||i.forEach(u=>{u.type==="image"?c+=`<img loading="lazy" class="av__cellassetimg ariaLabel" aria-label="${u.content}" src="${getCompressURL(u.content)}">`:c+=`<span class="b3-chip b3-chip--middle av__celltext--url ariaLabel" aria-label="${escapeAttr(u.content)}" data-name="${escapeAttr(u.name)}" data-url="${escapeAttr(u.content)}">${u.name||u.content}</span>`});break;case"date":c=`<span class="av__celltext" data-value='${JSON.stringify(e[e.type])}' placeholder="${window.siyuan.languages.empty}">`,e[e.type]&&e[e.type].isNotEmpty&&(c+=dayjs(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(c+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),c+="</span>";break;case"created":case"updated":e[e.type].isNotEmpty&&(c=`<span data-content="${e[e.type].content}">${dayjs(e[e.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":c=`<input value="${e.url.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.url.content?`href="${e.url.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":c=`<input value="${e.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.phone.content?`href="tel:${e.phone.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":c=`<svg class="av__checkbox"><use xlink:href="#icon${e.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":c=`<div class="fn__flex-1" placeholder="${window.siyuan.languages.empty}">${e.template.content}</div>`;break;case"email":c=`<input value="${e.email.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.email.content?`href="mailto:${e.email.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":(o=(s=e==null?void 0:e.relation)==null?void 0:s.contents)==null||o.forEach((u,g)=>{if(u&&u.block){const m=e.relation.blockIDs[g];u!=null&&u.isDetached?c+=`<span data-row-id="${m}" class="av__cell--relation"><span>\u2796<span class="fn__space--5"></span></span><span class="av__celltext">${Lute.EscapeHTMLStr(u.block.content||window.siyuan.languages.untitled)}</span></span>`:c+=`<span data-row-id="${m}" class="av__cell--relation" data-block-id="${u.block.id}"><span class="b3-menu__avemoji" data-unicode="${u.block.icon||""}">${unicode2Emoji(u.block.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${u.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(u.block.content||window.siyuan.languages.untitled)}</span></span>`}}),c&&c.endsWith(", ")&&(c=c.substring(0,c.length-2));break;case"rollup":(r=(l=e==null?void 0:e.rollup)==null?void 0:l.contents)==null||r.forEach(u=>{const g=["template","select","mSelect","mAsset","checkbox","relation"].includes(u.type)?fs(u):xl(u);g&&(c+=g.replace("fn__flex-1","")+",&nbsp;")}),c&&c.endsWith(",&nbsp;")&&(c=c.substring(0,c.length-7));break}return c},dd=(e,t,a,n)=>{fetchPost("/api/av/getAttributeViewKeys",{id:t},i=>{let s="";if(i.data.forEach(o=>{var l;let r=`<div class="custom-attr__avheader">
    <div class="block__logo popover__block" style="max-width:calc(100% - 40px)" data-id='${JSON.stringify(o.blockIDs)}'>
        <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__ellipsis">${o.avName||window.siyuan.languages.database}</span>
    </div>
    <div class="fn__flex-1"></div>
    <span data-type="remove" data-row-id="${o.keyValues&&o.keyValues[0].values[0].blockID}" class="block__icon block__icon--warning block__icon--show b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.removeAV}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
</div>`;(l=o.keyValues)==null||l.forEach(c=>{var u;r+=`<div class="block__icons av__row" data-id="${t}" data-col-id="${c.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${escapeAriaLabel(c.key.name)}<div class='ft__on-surface'>${escapeAriaLabel(c.key.desc)}</div>">
        ${c.key.icon?unicode2Emoji(c.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(c.key.type)}"></use></svg>`}
        <span>${escapeHtml(c.key.name)}</span>
    </div>
    <div data-av-id="${o.avID}" data-col-id="${c.values[0].keyID}" data-row-id="${c.values[0].blockID}" data-id="${c.values[0].id}" data-type="${c.values[0].type}" 
data-options="${(u=c.key)!=null&&u.options?escapeAttr(JSON.stringify(c.key.options)):"[]"}" 
${["text","number","date","url","phone","template","email"].includes(c.values[0].type)?"":`placeholder="${window.siyuan.languages.empty}"`}  
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(c.values[0].type)?"":" custom-attr__avvalue"}${["created","updated"].includes(c.values[0].type)?" custom-attr__avvalue--readonly":""}">${fs(c.values[0])}</div>
</div>`}),r+=`<div class="fn__hr"></div>
<button data-type="addColumn" class="b3-button b3-button--cancel"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.newCol}</button>
<div class="fn__hr--b"></div><div class="fn__hr--b"></div>`,s+=`<div data-av-id="${o.avID}" data-av-type="table" data-node-id="${t}" data-type="NodeAttributeView">${r}</div>`,e.innerHTML&&(e.querySelector(`[data-node-id="${t}"][data-av-id="${o.avID}"]`).innerHTML=r)}),e.innerHTML===""){let o;e.addEventListener("dragstart",r=>{const c=r.target;window.siyuan.dragElement=c.parentElement,window.siyuan.dragElement.style.opacity=".38",o=hasClosestBlock(window.siyuan.dragElement);const u=document.createElement("div");u.className="block__icons",u.innerHTML=c.nextElementSibling.outerHTML,u.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(u),r.dataTransfer.setDragImage(u,0,0),setTimeout(()=>{u.remove()})}),e.addEventListener("drop",r=>{var c,u;if(l=0,a.disabled){r.preventDefault(),r.stopPropagation();return}const g=e.querySelector(".dragover__bottom, .dragover__top");if(g&&o){const m=g.classList.contains("dragover__bottom"),d=m?g.dataset.colId:(c=g.previousElementSibling)==null?void 0:c.getAttribute("data-col-id"),f=(u=window.siyuan.dragElement.previousElementSibling)==null?void 0:u.getAttribute("data-col-id");d!==f&&d!==window.siyuan.dragElement.dataset.colId&&(transaction(a,[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:d,id:window.siyuan.dragElement.dataset.colId}],[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:f,id:t}]),m?g.after(window.siyuan.dragElement):g.before(window.siyuan.dragElement)),g.classList.remove("dragover__bottom","dragover__top")}else if(!window.siyuan.dragElement&&r.dataTransfer.types[0]==="Files"){const m=e.querySelector(".custom-attr__avvalue--active");if(m&&r.dataTransfer.types[0]==="Files"&&!isBrowser()){const d=[];for(let f=0;f<r.dataTransfer.files.length;f++)d.push(webUtils.getPathForFile(r.dataTransfer.files[f]));dragUpload(d,a,m)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("dragover",r=>{const c=r.target;let u;if(r.dataTransfer.types.includes("Files")){e.querySelectorAll(".custom-attr__avvalue--active").forEach(d=>{d.classList.remove("custom-attr__avvalue--active")}),u=hasClosestByClassName(c,"custom-attr__avvalue"),u&&u.getAttribute("data-type")==="mAsset"&&(u.classList.add("custom-attr__avvalue--active"),r.preventDefault());return}if(u=hasClosestByClassName(c,"av__row"),u||(u=hasClosestByClassName(document.elementFromPoint(r.clientX,r.clientY-1),"av__row")),!u||u===window.siyuan.dragElement||!o)return;const g=hasClosestBlock(u);if(!g||g!==o)return;r.preventDefault();const m=u.getBoundingClientRect();e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(d=>{d.classList.remove("dragover__bottom","dragover__top")}),r.clientY>m.top+m.height/2?u.classList.add("dragover__bottom"):u.classList.add("dragover__top")});let l=0;e.addEventListener("dragleave",()=>{l--,l===0&&e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(r=>{r.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragenter",r=>{r.preventDefault(),l++}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("paste",r=>{var c;const u=r.clipboardData.files;if(document.querySelector(".av__panel .b3-form__upload"))if(u&&u.length>0)uploadFiles(a,u);else{const g=r.clipboardData.getData("text/plain"),m=r.target,d=hasClosestBlock(m),f=hasClosestByAttribute(m,"data-type","mAsset");d&&f&&g&&(updateCellsValue(a,d,g,[f],void 0,a.lute.Md2BlockDOM(g)),(c=document.querySelector(".av__panel"))==null||c.remove())}}),e.addEventListener("click",r=>{const c=hasClosestByAttribute(r.target,"data-type","remove");if(c){const u=hasClosestBlock(c);u&&(transaction(a,[{action:"removeAttrViewBlock",srcIDs:[c.dataset.rowId],avID:u.dataset.avId},{action:"doUpdateUpdated",id:c.dataset.rowId,data:dayjs().format("YYYYMMDDHHmmss")}]),u.remove(),e.innerHTML||window.siyuan.dialogs.find(g=>{if(g.element.getAttribute("data-key")===Constants.DIALOG_ATTR)return g.destroy(),!0})),r.stopPropagation();return}gs(a,e,r)}),e.addEventListener("contextmenu",r=>{gs(a,e,r)}),e.innerHTML=s}e.querySelectorAll(".b3-text-field--text").forEach(o=>{o.addEventListener("change",()=>{let l;const r=o.parentElement.dataset.type;if(["url","text","email","phone"].includes(r)){if(l={[r]:{content:o.value}},r!=="text"){const c=o.parentElement.querySelector("a");o.value?c.setAttribute("href",(r==="url"?"":r==="email"?"mailto:":"tel:")+o.value):c.removeAttribute("href")}}else r==="number"?o.value==="undefined"||!o.value?l={number:{content:null,isNotEmpty:!1}}:l={number:{content:parseFloat(o.value)||0,isNotEmpty:!0}}:r==="block"&&(l={block:{content:o.value,id:o.dataset.id},isDetached:!1});fetchPost("/api/av/setAttributeViewBlockAttr",{avID:o.parentElement.dataset.avId,keyID:o.parentElement.dataset.colId,itemID:o.parentElement.dataset.rowId,value:l},c=>{r==="number"?o.parentElement.querySelector(".fn__flex-center").textContent=c.data.value.number.formattedContent:r==="block"&&!o.value&&(o.value=c.data.value.block.content)})})}),n&&n(e)})},gs=(e,t,a)=>{let n=a.target;const i=hasClosestBlock(n);if(i)for(;n&&t!==n;){const s=n.getAttribute("data-type");if(n.classList.contains("b3-menu__avemoji")){const o=n.getBoundingClientRect();return openEmojiPanel(n.nextElementSibling.getAttribute("data-id"),"doc",{x:o.left,y:o.bottom,h:o.height,w:o.width},l=>{n.innerHTML=unicode2Emoji(l||window.siyuan.storage[Constants.LOCAL_IMAGES].file)},n.querySelector("img")),a.preventDefault(),a.stopPropagation(),!0}else if(n.classList.contains("av__celltext--url")||n.classList.contains("av__cellassetimg")){if(a.type==="contextmenu"||!n.dataset.url&&n.tagName!=="IMG"){let o=0;Array.from(n.parentElement.children).find((l,r)=>{if(l===n)return o=r,!0}),editAssetItem({protyle:e,cellElements:[n.parentElement],blockElement:hasClosestBlock(n),content:n.tagName==="IMG"?n.getAttribute("src"):n.getAttribute("data-url"),type:n.tagName==="IMG"?"image":"file",name:n.tagName==="IMG"?"":n.getAttribute("data-name"),index:o,rect:n.getBoundingClientRect()})}else n.tagName==="IMG"?previewImages([n.getAttribute("src")]):openLink(e,n.dataset.url,a,a.ctrlKey||a.metaKey);a.stopPropagation(),a.preventDefault();break}else if(s==="date"){popTextCell(e,[n],"date"),a.stopPropagation(),a.preventDefault();break}else if(s==="select"||s==="mSelect"){popTextCell(e,[n],n.getAttribute("data-type")),a.stopPropagation(),a.preventDefault();break}else if(s==="mAsset"){t.querySelectorAll('.custom-attr__avvalue[data-type="mAsset"]').forEach(o=>{o.removeAttribute("data-active")}),n.setAttribute("data-active","true"),n.focus(),popTextCell(e,[n],"mAsset"),a.stopPropagation(),a.preventDefault();break}else if(s==="checkbox"){popTextCell(e,[n],"checkbox"),a.stopPropagation(),a.preventDefault();break}else if(s==="relation"){popTextCell(e,[n],"relation"),a.stopPropagation(),a.preventDefault();break}else if(s==="template"){popTextCell(e,[n],"template"),a.stopPropagation(),a.preventDefault();break}else if(s==="rollup"){popTextCell(e,[n],"rollup"),a.stopPropagation(),a.preventDefault();break}else if(s==="addColumn"){const o=i.querySelectorAll(".av__row"),l=addCol(e,i,o[o.length-1].getAttribute("data-col-id")),r=n.getBoundingClientRect();l.open({x:r.left,y:r.bottom,h:r.height}),a.stopPropagation(),a.preventDefault();break}else if(s==="editCol"){openMenuPanel({protyle:e,blockElement:i,type:"edit",colId:n.parentElement.dataset.colId}),a.stopPropagation(),a.preventDefault();break}n=n.parentElement}},ud=e=>!!e.getAttribute("data-av-id");var Tl=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const fd=(e,t,a)=>{if(!e){t.innerHTML="";return}fetchPost("/api/template/render",{id:a,path:e,preview:!0},n=>{t.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${n.data.content.replace(/contenteditable="true"/g,"")}</div>`})},ms=(e,t,a=!0)=>{if(!e.getAttribute("data-type")||!t.getAttribute("data-type"))return!1;e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim()),t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim());const n=e.attributes;let i=!0;for(let s=0;s<n.length;s++)t.getAttribute(n[s].name)!==n[s].value&&(i=!1);return i&&(a?e.innerHTML=e.innerHTML+t.innerHTML:e.innerHTML=t.innerHTML+e.innerHTML,t.remove()),i},gd=e=>{let t=e.previousSibling;for(;t&&t.nodeType!==3&&ms(e,t,!1);)t=e.previousSibling;let a=e.nextSibling;for(;a&&a.nodeType!==3&&ms(e,a);)a=e.nextSibling;(e.getAttribute("data-type")||"").includes("search-mark")&&e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim())},Il=(e,t,a)=>{const n=e.getAttribute("data-type").split(" ");if(n.length===1){const i=e.parentElement;e.outerHTML=e.innerHTML.replace(H.ZWSP,"")+"<wbr>",a&&Va(i,a)}else n.find((i,s)=>{if(t===i)return n.splice(s,1),!0}),e.setAttribute("data-type",n.join(" ")),t==="a"?e.removeAttribute("data-href"):t==="file-annotation-ref"?e.removeAttribute("data-id"):t==="block-ref"&&(e.removeAttribute("data-id"),e.removeAttribute("data-subtype")),a&&(a.selectNodeContents(e),a.collapse(!1),He(a))},md=e=>{const t=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],a=[];return e.forEach(n=>{let i=n;t.find(s=>{if(typeof n=="string"&&s.name===n)return i=s,!0;if(typeof n=="object"&&s.name===n.name)return i=Object.assign({},s,n),!0}),a.push(i)}),a},pd=(e,t)=>Tl(void 0,null,function*(){let a="";for(let n=0;n<e.length;n++){const i=e[n];if(e.length>1&&(a+="- "),t==="ref"){const s=yield fetchSyncPost("/api/block/getRefText",{id:i});a+=`((${i} '${s.data}'))`}else if(t==="blockEmbed")a+=`{{select * from blocks where id='${i}'}}`;else if(t==="protocol")a+=`siyuan://blocks/${i}`;else if(t==="protocolMd"){const s=yield fetchSyncPost("/api/block/getRefText",{id:i});a+=`[${s.data}](siyuan://blocks/${i})`}else if(t==="hPath"){const s=yield fetchSyncPost("/api/filetree/getHPathByID",{id:i});a+=s.data}else t==="id"&&(a+=i);e.length>1&&n!==e.length-1&&(a+=`
`)}writeText(a)}),_n=(e,t)=>{fetchPost("/api/filetree/createDailyNote",{notebook:t,app:Constants.SIYUAN_APPID},a=>{openMobileFileById(e,a.data.id)})},bd=e=>{if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===Constants.DIALOG_DIALYNOTE)return s.destroy(),!0}))return;const a=getOpenNotebookCount();if(a===0){showMessage(window.siyuan.languages.newFileTip);return}if(a===1){let s="";window.siyuan.notebooks.find(o=>{o.closed||(s=o.id)}),_n(e,s);return}const n=window.siyuan.storage[Constants.LOCAL_DAILYNOTEID],i=window.siyuan.notebooks.find(s=>{if(s.id===n&&!s.closed)return!0});if(n&&i&&!isMobile())_n(e,n);else{let s="";window.siyuan.notebooks.forEach(c=>{c.closed||(s+=`<option value="${c.id}">${c.name}</option>`)});const o=new Dialog({positionId:Constants.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${s}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});o.element.setAttribute("data-key",Constants.DIALOG_DIALYNOTE);const l=o.element.querySelectorAll(".b3-button"),r=o.element.querySelector(".b3-select");r.value=n,l[0].addEventListener("click",()=>{o.destroy()}),l[1].addEventListener("click",()=>{const c=r.value;window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]=c,setStorageVal(Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]),_n(e,c),o.destroy()})}},yd=()=>{const e=Constants.HELP_PATH[window.siyuan.config.appearance.lang];fetchPost("/api/notebook/removeNotebook",{notebook:e,callback:Constants.CB_MOUNT_REMOVE},()=>{fetchPost("/api/notebook/openNotebook",{notebook:e,app:Constants.SIYUAN_APPID})})},hd=()=>{const e=new Dialog({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_CREATENOTEBOOK);const t=e.element.querySelectorAll(".b3-button");e.bindInput(e.element.querySelector("input"),()=>{t[1].dispatchEvent(new CustomEvent("click"))}),t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const a=e.element.querySelector("input").value;if(!validateName(a))return!1;fetchPost("/api/notebook/createNotebook",{name:a}),e.destroy()})},_d=(e,t,a)=>{var n,i,s,o,l,r,c,u,g;let m,d="",f=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(f.length===0){let p=getTopAloneElement(t);const y=hasClosestByAttribute(p,"fold","1");y&&(p=y),(n=p.previousElementSibling)!=null&&n.classList.contains("protyle-action")&&(p=getTopAloneElement(p.parentElement)),f=[p]}const b=f[0].getAttribute("data-type");if(b==="NodeListItem"&&!f[0].previousElementSibling&&((s=(i=f[0].parentElement.previousElementSibling)==null?void 0:i.previousElementSibling)!=null&&s.classList.contains("protyle-action")))if((o=f[0].parentElement.parentElement.previousElementSibling)!=null&&o.classList.contains("li")){if(m=f[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),a.insertNode(document.createElement("wbr")),d=f[0].parentElement.parentElement.parentElement.outerHTML,!m){const p=Lute.NewNodeID();f[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),m=f[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(b==="NodeList"&&((r=(l=f[0].previousElementSibling)==null?void 0:l.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((c=f[0].parentElement.previousElementSibling)!=null&&c.classList.contains("li")){if(m=f[0].parentElement.previousElementSibling.querySelector(".list"),a.insertNode(document.createElement("wbr")),d=f[0].parentElement.parentElement.outerHTML,!m){const p=Lute.NewNodeID();f[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),m=f[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(m){m=m.lastElementChild.previousElementSibling;const p=f[0].classList.contains("list")?f[0]:f[0].parentElement;f.reverse().forEach(y=>{y.classList.contains("list")?m.after(y.firstElementChild):m.after(y)}),m.id==="moveTempLi"&&(m=m.nextElementSibling,m.previousElementSibling.remove()),p.childElementCount===1?p.remove():p.getAttribute("data-subtype")==="o"&&p.classList.contains("list")&&updateListOrder(p,1),m.getAttribute("data-subtype")==="o"&&updateListOrder(m.parentElement),updateTransaction(e,m.parentElement.parentElement.parentElement.getAttribute("data-node-id"),m.parentElement.parentElement.parentElement.outerHTML,d),preventScroll(e),scrollCenter(e),focusByWbr(m.parentElement,a);return}if(!(!f[0].previousElementSibling||(u=f[0].previousElementSibling)!=null&&u.classList.contains("protyle-action"))){if(m=f[0].previousElementSibling,f[0].getAttribute("data-subtype")==="o"&&b==="NodeListItem"){const p=f[0].parentElement.outerHTML;f[f.length-1].after(m),updateListOrder(f[0].parentElement,1),updateTransaction(e,f[0].parentElement.getAttribute("data-node-id"),f[0].parentElement.outerHTML,p)}else{const p=m.getAttribute("data-node-id");transaction(e,[{action:"move",id:p,previousID:f[f.length-1].getAttribute("data-node-id")}],[{action:"move",id:p,previousID:(g=m.previousElementSibling)==null?void 0:g.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")||e.block.parentID}]),f[f.length-1].after(m)}preventScroll(e),scrollCenter(e)}},wd=(e,t,a)=>{var n,i,s,o,l,r,c;let u,g="",m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length===0){let f=getTopAloneElement(t);const b=hasClosestByAttribute(f,"fold","1");b&&(f=b),(n=f.previousElementSibling)!=null&&n.classList.contains("protyle-action")&&(f=getTopAloneElement(f.parentElement)),m=[f]}const d=m[0].getAttribute("data-type");if(d==="NodeListItem"&&m[m.length-1].nextElementSibling.classList.contains("protyle-attr")&&((i=m[0].parentElement.parentElement)!=null&&i.classList.contains("li")))if((s=m[0].parentElement.parentElement.nextElementSibling)!=null&&s.classList.contains("li")){if(u=m[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),a.insertNode(document.createElement("wbr")),g=m[0].parentElement.parentElement.parentElement.outerHTML,!u){const f=Lute.NewNodeID();m[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${f}" data-type="NodeList" class="list" updated="${f.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=m[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(d==="NodeList"&&m[m.length-1].nextElementSibling.classList.contains("protyle-attr")&&((o=m[0].parentElement)!=null&&o.classList.contains("li")))if((l=m[0].parentElement.nextElementSibling)!=null&&l.classList.contains("li")){if(u=m[0].parentElement.nextElementSibling.querySelector(".list > .li"),a.insertNode(document.createElement("wbr")),g=m[0].parentElement.parentElement.outerHTML,!u){const f=Lute.NewNodeID();m[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${f}" data-type="NodeList" class="list" updated="${f.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=m[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(u){const f=m[0].classList.contains("list")?m[0]:m[0].parentElement;m.forEach(b=>{b.classList.contains("list")?u.before(b.firstElementChild):u.before(b)}),f.childElementCount===1?f.remove():f.getAttribute("data-subtype")==="o"&&f.classList.contains("list")&&updateListOrder(f,1),u.getAttribute("data-subtype")==="o"&&updateListOrder(u.parentElement,1),updateTransaction(e,u.parentElement.parentElement.parentElement.getAttribute("data-node-id"),u.parentElement.parentElement.parentElement.outerHTML,g),preventScroll(e),scrollCenter(e),focusByWbr(u.parentElement,a);return}if(!(!m[m.length-1].nextElementSibling||(r=m[m.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(u=m[m.length-1].nextElementSibling,u.getAttribute("data-subtype")==="o"&&u.getAttribute("data-type")==="NodeListItem"){const f=u.parentElement.outerHTML;m[0].before(u),updateListOrder(u.parentElement,1),updateTransaction(e,u.parentElement.getAttribute("data-node-id"),u.parentElement.outerHTML,f)}else{const f=u.getAttribute("data-node-id");transaction(e,[{action:"move",id:f,previousID:(c=m[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:u.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:f,previousID:m[m.length-1].getAttribute("data-node-id")}]),m[0].before(u)}preventScroll(e),scrollCenter(e)}};class Kt{constructor(t,a){this.element=document.createElement("button");const n=a.hotkey?` ${fa(a.hotkey)}`:"",i=a.tip||window.siyuan.languages[a.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${a.tipPosition}`),this.element.setAttribute("data-type",a.name),this.element.setAttribute("aria-label",i+n),this.element.innerHTML=`<svg><use xlink:href="#${a.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(a.name)&&this.element.addEventListener(ji(),s=>{s.preventDefault(),H.INLINE_TYPE.includes(a.name)?t.toolbar.setInlineMark(t,a.name,"toolbar"):a.click&&a.click(t.getInstance())})}}class vd extends Kt{constructor(t,a){super(t,a),this.element.addEventListener("click",()=>{t.toolbar.element.classList.add("fn__none"),t.toolbar.subElement.innerHTML="",t.toolbar.subElement.style.width="",t.toolbar.subElement.style.padding="",t.toolbar.subElement.append(Dl(t,Ml(t))),t.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),t.toolbar.subElement.classList.remove("fn__none"),t.toolbar.subElementCloseCB=void 0,He(t.toolbar.range)})}}const Dl=(e,t)=>{let a="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(d=>{a+=`<button ${d?`class="color__square" style="color:${d}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="color">A</button>`});let n="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(d=>{n+=`<button ${d?`class="color__square" style="background-color:${d}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="backgroundColor"></button>`});const i=document.createElement("div");i.classList.add("protyle-font");let s=!1;t==null||t.find(d=>{if(d.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[H.LOCAL_FONTSTYLES];l.length>0&&(o=`<div data-id="lastUsed" class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="fn__kbd fn__flex-center${window.siyuan.config.keymap.editor.insert.lastUsed.custom?"":" fn__none"}">${fa(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div data-id="lastUsedWrap" class="fn__flex fn__flex-wrap" style="align-items: center">`,l.forEach(d=>{const f=d.split(H.ZWSP);switch(f[0]){case"color":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorFont}${f[1]?"":" "+window.siyuan.languages.default}" ${f[1]?`style="color:${f[1]}"`:""} data-type="${f[0]}">A</button>`;break;case"backgroundColor":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorPrimary}${f[1]?"":" "+window.siyuan.languages.default}" ${f[1]?`style="background-color:${f[1]}"`:""} data-type="${f[0]}"></button>`;break;case"style2":o+=`<button data-type="${f[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":o+=`<button data-type="${f[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":s||(o+=`<button data-type="${f[0]}" class="protyle-font__style">${f[1]}</button>`);break;case"style1":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.color}${f[1]?"":" "+window.siyuan.languages.default}" ${f[1]?`style="background-color:${f[1]};color:${f[2]}"`:""} data-type="${f[0]}">A</button>`;break;case"clear":o+=`<button style="height: 26px;display: flex;align-items: center;padding: 0 5px;" data-type="${f[0]}" class="protyle-font__style ariaLabel" aria-label="${window.siyuan.languages.clearFontStyle}"><svg class="svg--mid"><use xlink:href="#iconTrashcan"></use></svg></button>`;break}}),o+="</div>");let r,c=window.siyuan.config.editor.fontSize+"px";t&&t.length>0?r=t[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=F(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||window.siyuan.config.editor.fontSize+"px"),i.innerHTML=`${o}
<div class="fn__hr"></div>
<div data-id="color">${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div data-id="colorWrap" class="fn__flex fn__flex-wrap">
    <button class="color__square ariaLabel" data-position="3south" data-type="style1" aria-label="${window.siyuan.languages.default}">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div data-id="colorFont">${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div data-id="colorFontWrap" class="fn__flex fn__flex-wrap">
    ${a}
</div>
<div class="fn__hr"></div>
<div data-id="colorPrimary">${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div data-id="colorPrimaryWrap" class="fn__flex fn__flex-wrap">
    ${n}
</div>
<div class="fn__hr"></div>
<div data-id="fontStyle">${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div data-id="fontStyleWrap" class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${s?" fn__none":""}"></div>
<div data-id="fontSize" class="fn__flex${s?" fn__none":""}">
    ${window.siyuan.languages.fontSize}
    <span class="fn__flex-1"></span>
    <label class="fn__flex">
        ${window.siyuan.languages.relativeFontSize}
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" ${c.endsWith("em")?"checked":""} type="checkbox">
        <span class="fn__space--small"></span>
    </label>
</div>
<div data-id="fontSizeWrap" class="${s?" fn__none":""}">
    <div class="fn__hr"></div>
    <div class="b3-tooltips b3-tooltips__n fn__flex${c.endsWith("em")?" fn__none":""}" aria-label="${c}">   
        <input class="b3-slider fn__block" id="fontSizePX" max="72" min="9" step="1" type="range" value="${parseInt(c)}">
    </div>
    <div class="b3-tooltips b3-tooltips__n fn__flex${c.endsWith("em")?"":" fn__none"}" aria-label="${parseFloat(c)*100}%">   
        <input class="b3-slider fn__block" id="fontSizeEM" max="4.5" min="0.56" step="0.01" type="range" value="${parseFloat(c)}">
    </div>
</div>
<div class="fn__hr--b"></div>
<div data-id="clearFontStyle" class="fn__flex">
    <div class="fn__space--small"></div>
    <button class="b3-button b3-button--remove fn__block" data-type="clear">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
    </button>
    <div class="fn__space--small"></div>
</div>`,i.addEventListener("click",function(d){let f=d.target;for(;f&&!f.isEqualNode(i);){const b=f.getAttribute("data-type");if(f.tagName==="BUTTON"){b==="style1"?st(e,t,b,f.style.backgroundColor+H.ZWSP+f.style.color):b==="fontSize"?st(e,t,b,f.textContent.trim()):b==="backgroundColor"?st(e,t,b,f.style.backgroundColor):b==="color"?st(e,t,b,f.style.color):st(e,t,b);break}f=f.parentElement}});const u=i.querySelector(".b3-switch"),g=i.querySelector("#fontSizePX"),m=i.querySelector("#fontSizeEM");return u.addEventListener("change",function(){if(u.checked){const d=parseFloat((parseInt(g.value)/16).toFixed(2));m.parentElement.setAttribute("aria-label",(d*100).toString()+"%"),m.value=d.toString(),g.parentElement.classList.add("fn__none"),m.parentElement.classList.remove("fn__none"),st(e,t,"fontSize",m.value+"em")}else{const d=Math.round(parseFloat(m.value)*16);g.parentElement.setAttribute("aria-label",d+"px"),g.value=d.toString(),g.parentElement.classList.remove("fn__none"),m.parentElement.classList.add("fn__none"),st(e,t,"fontSize",g.value+"px")}}),g.addEventListener("change",function(){st(e,t,"fontSize",g.value+"px")}),m.addEventListener("change",function(){st(e,t,"fontSize",m.value+"em")}),g.addEventListener("input",function(){g.parentElement.setAttribute("aria-label",g.value+"px")}),m.addEventListener("input",function(){m.parentElement.setAttribute("aria-label",(parseFloat(m.value)*100).toFixed(0)+"%")}),i},st=(e,t,a,n)=>{let i=window.siyuan.storage[H.LOCAL_FONTSTYLES];if(a)i.splice(0,0,`${a}${H.ZWSP}${n}`),i=[...new Set(i)],i.length>8&&i.splice(8,1),window.siyuan.storage[H.LOCAL_FONTSTYLES]=i,Xa(H.LOCAL_FONTSTYLES,window.siyuan.storage[H.LOCAL_FONTSTYLES]);else if(i.length===0)a="style1",n="var(--b3-card-error-color)"+H.ZWSP+"var(--b3-card-error-background)";else{const s=i[0].split(H.ZWSP);a=s.splice(0,1)[0],n=s.join(H.ZWSP)}t&&t.length>0?(Er(t,e,s=>{if(a==="clear")s.style.color="",s.style.webkitTextFillColor="",s.style.webkitTextStroke="",s.style.textShadow="",s.style.backgroundColor="",s.style.fontSize="",s.style.removeProperty("--b3-parent-background");else if(a==="style1"){const o=n.split(H.ZWSP);s.style.backgroundColor=o[0],s.style.color=o[1],s.style.setProperty("--b3-parent-background",o[0])}else a==="style2"?(s.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",s.style.webkitTextFillColor="transparent"):a==="style4"?s.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":a==="color"?s.style.color=n:a==="backgroundColor"?(s.style.backgroundColor=n,s.style.setProperty("--b3-parent-background",n)):a==="fontSize"&&(s.style.fontSize=n);(a==="fontSize"||a==="clear")&&s.getAttribute("data-type")==="NodeCodeBlock"&&Ri(s.querySelector(".hljs"))}),He(e.toolbar.range)):a==="clear"?e.toolbar.setInlineMark(e,"clear","range",{type:"text"}):e.toolbar.setInlineMark(e,"text","range",{type:a,color:n})},Ed=(e,t)=>{const a=s=>{const o=s.split(Constants.ZWSP),l=o.splice(0,1)[0];e.setAttribute("data-id",l),e.setAttribute("data-subtype",o.splice(0,1)[0]),e.removeAttribute("data-href");let r=o.join("");r.replace(/\s/g,"")===""&&(r=l),e.innerText=r},n=s=>{const o=s.split(Constants.ZWSP);e.setAttribute("data-href",o[0]),e.removeAttribute("data-subtype"),e.removeAttribute("data-id"),o[1]&&(e.textContent=o[1])},i=s=>{const o=s.split(Constants.ZWSP);e.setAttribute("data-id",o[0]),e.removeAttribute("data-href"),e.removeAttribute("data-subtype"),o[1]&&(e.textContent=o[1])};if(t){switch(t.type){case"color":e.style.color=t.color;break;case"fontSize":e.style.fontSize=t.color;break;case"backgroundColor":e.style.backgroundColor=t.color;break;case"style1":e.style.backgroundColor=t.color.split(Constants.ZWSP)[0],e.style.color=t.color.split(Constants.ZWSP)[1];break;case"style2":e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent";break;case"style4":e.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":a(t.color);break;case"inline-math":e.className="render-node",e.setAttribute("contenteditable","false"),e.setAttribute("data-subtype","math"),e.setAttribute("data-content",e.textContent.replace(Constants.ZWSP,"")),e.removeAttribute("data-render"),e.textContent="";break;case"a":n(t.color);break;case"file-annotation-ref":i(t.color);break;case"inline-memo":e.removeAttribute("contenteditable"),e.removeAttribute("data-content");break}e.getAttribute("style")||e.removeAttribute("style")}},kd=(e,t,a)=>{if(!a&&e){const n=t.getAttribute("data-type").split(" ");return n.includes("inline-math")||n.includes("inline-memo")||n.includes("a")||n.includes("block-ref")&&(e.getAttribute("data-id")!==t.getAttribute("data-id")||e.getAttribute("data-subtype")!==t.getAttribute("data-subtype")||e.textContent!==t.textContent)||n.includes("file-annotation-ref")&&(e.getAttribute("data-id")!==t.getAttribute("data-id")||e.textContent!==t.textContent)?!1:t.style.color===e.style.color&&t.style.webkitTextFillColor===e.style.webkitTextFillColor&&t.style.webkitTextStroke===e.style.webkitTextStroke&&t.style.textShadow===e.style.textShadow&&t.style.backgroundColor===e.style.backgroundColor&&t.style.fontSize===e.style.fontSize}if(a){if(a.type==="text")return!t.style.color&&!t.style.webkitTextFillColor&&!t.style.webkitTextStroke&&!t.style.textShadow&&!t.style.fontSize&&!t.style.backgroundColor;if(a.type==="color")return a.color===t.style.color;if(a.type==="backgroundColor")return a.color===t.style.backgroundColor;if(a.type==="style1")return a.color.split(Constants.ZWSP)[0]===t.style.color&&a.color.split(Constants.ZWSP)[1]===t.style.backgroundColor;if(a.type==="style2")return t.style.webkitTextFillColor==="transparent"&&t.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)";if(a.type==="style4")return t.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";if(a.type==="fontSize")return a.color===t.style.fontSize}return!1},Ml=e=>{let t;if(e.toolbar.range.toString()===""&&(t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0)){const a=G(e.toolbar.range.startContainer);a&&(t=[a])}return t},Cd=(e,t,a)=>{var n,i,s;if(hasClosestByClassName(e,"protyle-wysiwyg__embed"))return;const o=isNotEditBlock(e);if(!o&&e.classList.contains("protyle-wysiwyg--select")){setLastNodeRange(getContenteditableElement(e),t,!1),t.collapse(!1),hideElements(["select"],a);return}if((n=a.observerLoad)==null||n.disconnect(),o||e.classList.contains("table")){e.classList.contains("protyle-wysiwyg--select")&&e.classList.contains("render-node")?a.toolbar.showRender(a,e):insertEmptyBlock(a,"afterend");return}const l=getContenteditableElement(e);if(l.querySelectorAll(".img--select").forEach(h=>{h.classList.remove("img--select")}),e.getAttribute("data-type")==="NodeAttributeView")return!0;const r=l.innerHTML.trimStart(),c=l.textContent.trimStart();if((r.startsWith("```")||r.startsWith("\xB7\xB7\xB7")||r.startsWith("~~~")||r.indexOf("\n```")>-1&&c.indexOf("\n```")>-1||r.indexOf(`
~~~`)>-1&&c.indexOf(`
~~~`)>-1||r.indexOf(`
\xB7\xB7\xB7`)>-1&&c.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(r.indexOf(`
`)===-1&&r.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(e.classList.contains("p")){const h=e.outerHTML;let E=l.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");E.endsWith("\n```")||(E+="<wbr>\n```"),l.innerHTML=E,e.outerHTML=a.lute.SpinBlockDOM(e.outerHTML),e=a.wysiwyg.element.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`);const C=e.querySelector(".protyle-action__language");return C?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&C.textContent===""?C.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]:Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(C.textContent)||(window.siyuan.storage[Constants.LOCAL_CODELANG]=C.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG])),Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(C.textContent)?(e.dataset.content="",e.dataset.subtype=C.textContent,e.className="render-node",e.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,a.toolbar.showRender(a,e),processRender(e)):highlightRender(e)):(a.toolbar.showRender(a,e),processRender(e)),updateTransaction(a,e.getAttribute("data-node-id"),e.outerHTML,h),!0}}if(e.getAttribute("data-type")==="NodeCodeBlock"){const h=document.createElement("wbr");t.insertNode(h);const E=e.outerHTML;return h.remove(),t.extractContents(),l.textContent.endsWith(`
`)||l.insertAdjacentText("beforeend",`
`),t.insertNode(document.createTextNode(`
`)),t.collapse(!1),t.insertNode(h),l.parentElement.removeAttribute("data-render"),highlightRender(e),updateTransaction(a,e.getAttribute("data-node-id"),e.outerHTML,E),scrollCenter(a),!0}if(l.textContent.replace(Constants.ZWSP,"").replace(`
`,"")===""&&e.nextElementSibling&&e.nextElementSibling.classList.contains("protyle-attr")&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){t.insertNode(document.createElement("wbr"));const h=getTopEmptyElement(e),E=e.getAttribute("data-node-id"),C=h.getAttribute("data-node-id"),A={action:"insert",id:E,data:e.outerHTML},S={action:"insert",id:C,data:h.outerHTML};return C===E?(A.previousID=e.parentElement.getAttribute("data-node-id"),S.previousID=e.previousElementSibling.getAttribute("data-node-id"),e.parentElement.after(e)):(A.previousID=h.previousElementSibling?h.previousElementSibling.getAttribute("data-node-id"):void 0,A.parentID=h.parentElement.getAttribute("data-node-id")||a.block.parentID,S.previousID=A.previousID,S.parentID=A.parentID,h.after(e),h.remove()),transaction(a,[{action:"delete",id:C},A],[{action:"delete",id:E},S]),C===E&&e.parentElement.classList.contains("sb")&&e.parentElement.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:a,selectsElement:[e.previousElementSibling,e],type:"BlocksMergeSuperBlock",level:"row"}),focusByWbr(e,t),!0}const u=getSelectionOffset(l,a.wysiwyg.element,t);if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&(e.nextElementSibling.classList.contains("protyle-attr")||e.nextElementSibling.classList.contains("list")&&((i=e.previousElementSibling)!=null&&i.classList.contains("protyle-action"))||u.start===0&&e.previousElementSibling.classList.contains("protyle-action")||e.parentElement.getAttribute("fold")==="1")&&$l(a,e,t))return!0;if(l.textContent!==""&&t.toString()===""&&u.start===0){let h;e.previousElementSibling&&e.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&e.previousElementSibling.getAttribute("fold")==="1"?h=genHeadingElement(e.previousElementSibling,!1,!0):h=genEmptyElement(!1,!0);const E=h.getAttribute("data-node-id");return transaction(a,[{action:"insert",data:h.outerHTML,id:E,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):"",parentID:e.parentElement.getAttribute("data-node-id")||a.block.parentID}],[{action:"delete",id:E}]),h.querySelector("wbr").remove(),e.insertAdjacentElement("beforebegin",h),ya(h),!0}t.insertNode(document.createElement("wbr"));const g=e.outerHTML;if(t.toString()!==""){const h=hasClosestByAttribute(t.startContainer,"data-type","inline-math");if(h){const E=hasNextSibling(h);return E&&(t=getSelection().getRangeAt(0),t.setEnd(E,E.textContent.startsWith(Constants.ZWSP)?1:0),t.collapse(!1)),(s=h.querySelector("wbr"))==null||s.remove(),!0}t.extractContents(),t.insertNode(document.createElement("wbr"))}l.lastChild&&t.setEndAfter(l.lastChild);const m=e.getAttribute("data-node-id"),d=document.createElement("div");e.getAttribute("data-type")==="NodeHeading"&&e.getAttribute("fold")==="1"?d.innerHTML=genHeadingElement(e,!0):d.appendChild(genEmptyElement(!1,!1));const f=d.querySelector('[contenteditable="true"]');f.appendChild(t.extractContents());const b=f.querySelector("wbr");b&&b.parentElement.tagName==="SPAN"&&b.parentElement.innerHTML==="<wbr>"&&(b.parentElement.outerHTML="<wbr>");const p=f.innerHTML.trimStart(),y=f.textContent.trimStart();if((p.startsWith("```")||p.startsWith("\xB7\xB7\xB7")||p.startsWith("~~~")||p.indexOf("\n```")>-1&&y.indexOf("\n```")>-1||p.indexOf(`
~~~`)>-1&&y.indexOf(`
~~~`)>-1||p.indexOf(`
\xB7\xB7\xB7`)>-1&&y.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(p.indexOf(`
`)===-1&&p.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=f.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");h.endsWith("\n```")||(h+="\n```"),f.innerHTML=h}d.innerHTML=a.lute.SpinBlockDOM(d.innerHTML);const _=document.createElement("div");_.innerHTML=a.lute.SpinBlockDOM(l.parentElement.outerHTML);const k=[],x=[];let T=e;const w=[];Array.from(_.children).forEach(h=>{h.dataset.nodeId===m?(e.before(h),e.remove(),k.push({action:"update",data:h.outerHTML,id:m}),x.push({action:"update",data:g,id:m})):(k.push({action:"insert",data:h.outerHTML,id:h.dataset.nodeId,nextID:m}),T.insertAdjacentElement("afterend",h),x.push({action:"delete",id:h.dataset.nodeId})),h.dataset.type==="NodeBlockQueryEmbed"?blockRender(a,h):mathRender(h),T=h,w.push(h)}),Array.from(d.children).forEach(h=>{const E=h.getAttribute("data-node-id");k.push({action:"insert",data:h.outerHTML,id:E,previousID:T.getAttribute("data-node-id")}),x.push({action:"delete",id:E}),T.insertAdjacentElement("afterend",h),h.classList.contains("code-block")?highlightRender(h):h.dataset.type==="NodeBlockQueryEmbed"?blockRender(a,h):mathRender(T.nextElementSibling),T=h,w.push(h)});const v=T.parentElement;return transaction(a,k,x),v.classList.contains("sb")&&v.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:a,selectsElement:w,type:"BlocksMergeSuperBlock",level:"row"}),focusByWbr(T,t),scrollCenter(a),!0},$l=(e,t,a)=>{var n,i;const s=t.parentElement,o=getContenteditableElement(t);if(["",`
`].includes(o.textContent)&&t.previousElementSibling.classList.contains("protyle-action")&&!t.querySelector("img")){if((n=s.nextElementSibling)!=null&&n.classList.contains("protyle-attr"))return listOutdent(e,[t.parentElement],a),!0;if(!s.parentElement.classList.contains("protyle-wysiwyg"))return breakList(e,t,a),!0}const l=getSelectionOffset(o,e.wysiwyg.element,a);if(a.toString()===""&&l.start===0&&!hasPreviousSibling(a.startContainer)){if(s.parentElement.classList.contains("protyle-wysiwyg"))return!0;const f=document.createElement("wbr");a.insertNode(f);const b=s.parentElement.outerHTML;f.remove();let p=genListItemElement(s,-1,!0);if(t.previousElementSibling.classList.contains("protyle-action"))getContenteditableElement(t).textContent===""?s.insertAdjacentElement("afterend",p):s.insertAdjacentElement("beforebegin",p);else{if(getContenteditableElement(t).textContent!=="")return!1;t.remove(),p=genListItemElement(s,-1,!0),s.insertAdjacentElement("afterend",p)}return s.getAttribute("data-subtype")==="o"&&updateListOrder(s.parentElement),updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,b),focusByWbr(p,a),scrollCenter(e),ya(p),!0}const r=s.querySelector(".list");let c;if(r&&s.getAttribute("fold")!=="1"&&t.nextElementSibling===r){if(l.end>=o.textContent.length-(o.textContent.endsWith(Constants.ZWSP)?1:0)){a.insertNode(document.createElement("wbr"));const f=s.outerHTML;t.querySelector("wbr").remove(),c=genListItemElement(r.firstElementChild,-1,!0),r.firstElementChild.before(c),r.getAttribute("data-subtype")==="o"&&updateListOrder(r),updateTransaction(e,s.getAttribute("data-node-id"),s.outerHTML,f),focusByWbr(s,a),scrollCenter(e)}else{a.insertNode(document.createElement("wbr"));const f=s.outerHTML,b=s.parentElement.outerHTML;a.toString()!==""&&(a.extractContents(),a.insertNode(document.createElement("wbr"))),a.setEndAfter(o.lastChild),c=genListItemElement(s,0,!1);const p=getContenteditableElement(c);p.appendChild(a.extractContents());const y=p.querySelector("wbr");y&&y.parentElement.tagName==="SPAN"&&y.parentElement.innerHTML==="<wbr>"&&(y.parentElement.outerHTML="<wbr>");let _=r.nextElementSibling;for(c.lastElementChild.before(r);!_.classList.contains("protyle-attr");)_=_.nextElementSibling,c.lastElementChild.before(_.previousElementSibling);s.insertAdjacentElement("afterend",c),s.getAttribute("data-subtype")==="o"&&updateListOrder(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",data:f,id:s.getAttribute("data-node-id")}]):updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,b),focusByWbr(c,a),scrollCenter(e)}return ya(c),!0}if((a.toString()===""||a.toString()===Constants.ZWSP)&&a.startContainer.nodeType===3&&a.startOffset===0){let f=a.startContainer;for(;f;)if(f.textContent===Constants.ZWSP){a.setStart(f,1),a.collapse(!1);break}else f=f.nextSibling}a.insertNode(document.createElement("wbr"));const u=s.outerHTML,g=s.parentElement.outerHTML;if(a.toString()!==""){const f=hasClosestByAttribute(a.startContainer,"data-type","inline-math");if(f){const b=hasNextSibling(f);return b&&(a=getSelection().getRangeAt(0),a.setEnd(b,b.textContent.startsWith(Constants.ZWSP)?1:0),a.collapse(!1)),(i=f.querySelector("wbr"))==null||i.remove(),!0}a.extractContents(),a.insertNode(document.createElement("wbr"))}o.lastChild&&a.setEndAfter(o.lastChild),c=genListItemElement(s,0,!1);const m=getContenteditableElement(c);m.appendChild(a.extractContents());const d=m.querySelector("wbr");return d&&d.parentElement.tagName==="SPAN"&&d.parentElement.innerHTML==="<wbr>"&&(d.parentElement.outerHTML="<wbr>"),m.parentElement.outerHTML=e.lute.SpinBlockDOM(m.parentElement.outerHTML),s.insertAdjacentElement("afterend",c),blockRender(e,c),mathRender(c),processRender(c),o.parentElement.outerHTML=e.lute.SpinBlockDOM(o.parentElement.outerHTML),blockRender(e,s),mathRender(s),processRender(s),s.getAttribute("data-subtype")==="o"&&updateListOrder(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",id:s.getAttribute("data-node-id"),data:s.outerHTML},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",id:s.getAttribute("data-node-id"),data:u}]):updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,g),focusByWbr(c,a),scrollCenter(e),ya(c),!0},ya=e=>{const t=getContenteditableElement(e).childNodes;for(let a=0;a<t.length;a++)t[a].nodeType===3&&t[a].textContent.length===0&&(t[a].remove(),a--)},Ad=(e,t,a)=>{let n=e.startContainer;const i=hasNextSibling(n);if(t.getAttribute("data-type")==="NodeAttributeView")return!0;if(i&&i.nodeType!==3&&getSelectionOffset(e.startContainer,a.wysiwyg.element,e).end===e.endContainer.textContent.length&&(i.classList.contains("img")||i.getAttribute("data-type")==="inline-math")){i.insertAdjacentHTML("beforebegin","<wbr>");const o=t.outerHTML;i.previousElementSibling.remove();const l=document.createTextNode(`
`);return n.after(document.createTextNode(Constants.ZWSP)),n.after(l),e.selectNode(l),e.collapse(!1),updateTransaction(a,t.getAttribute("data-node-id"),t.outerHTML,o),!0}if(n.nodeType===3&&(n=n.parentElement),n&&a.toolbar.getCurrentType(e).length>0&&getSelectionOffset(n,n,e).end===n.textContent.length)return ps(e,t,a,n),!0;if(isIPad()||isMobile()){n=e.startContainer;const s=hasNextSibling(n);return s&&s.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(ps(e,t,a,n),!0)}return!1},ps=(e,t,a,n)=>{const i=document.createElement("wbr");n.nodeType===3?e.insertNode(i):n.insertAdjacentElement("afterend",i);const s=t.outerHTML;i.remove();let o;hasNextSibling(n)||(o=document.createTextNode(`
`),n.after(o));const l=document.createTextNode(`
`);n.after(l),o?e.setStart(o,0):e.setStart(l,1),e.collapse(!0),focusByRange(e),updateTransaction(a,t.getAttribute("data-node-id"),t.outerHTML,s)};let bs,Zt=!1;const ne=(e,t,a,n="false")=>{let i;return t&&t.startsWith("icon")?i=`<svg class="keyboard__slash-icon"><use xlink:href="#${t}"></use></svg>`:i=t,`<button class="keyboard__slash-item" data-focus="${n}" data-value="${encodeURIComponent(e)}">
    ${i}
    <span class="keyboard__slash-text">${a}</span>
</button>`},Hl=(e,t)=>{let a="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((g,m)=>{a+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" ${g?`style="color:${g}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${g?m+1:window.siyuan.languages.default}</span>
</button>`});let n="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((g,m)=>{n+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" ${g?`style="background-color:${g}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${g?m+1:window.siyuan.languages.default}</span>
</button>`});const i=getFontNodeElements(e);let s=!1;i==null||i.find(g=>{if(g.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];l.length>0&&(o=`<div data-id="lastUsed" class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div data-id="lastUsedWrap" class="keyboard__slash-block">`,l.forEach(g=>{const m=g.split(Constants.ZWSP);switch(m[0]){case"color":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" ${m[1]?`style="color:${m[1]}"`:""} >A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${m[1]?parseInt(m[1].replace("var(--b3-font-color",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"backgroundColor":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" ${m[1]?`style="background-color:${m[1]}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${m[1]?parseInt(m[1].replace("var(--b3-font-background",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"style2":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":s||(o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text">${m[1]}</span>
</button>`);break;case"style1":m[1]?o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" style="background-color:${m[1]};color:${m[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[m[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`:o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
</button>`;break;case"clear":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),o+="</div>");let r,c="16px";i&&i.length>0?r=i[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=hasClosestByAttribute(e.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const u=t.querySelector(".keyboard__util");u.innerHTML=`${o}
<div data-id="color" class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div data-id="colorWrap" class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div data-id="colorFont" class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div data-id="colorFontWrap" class="keyboard__slash-block">
    ${a}
</div>
<div data-id="colorPrimary" class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div data-id="colorPrimaryWrap" class="keyboard__slash-block">
    ${n}
</div>
<div data-id="fontStyle" class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div data-id="fontStyleWrap" class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div data-id="fontSize" class="keyboard__slash-title${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div data-id="fontSizeWrap" class="keyboard__slash-block${s?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,u.querySelector("select").addEventListener("change",function(g){fontEvent(e,i,"fontSize",g.target.value)})},Nl=(e,t)=>{e.hint.splitChar="/",e.hint.lastIndex=-1;let a="";e.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{a+=ne(`plugin${Constants.ZWSP}${i.name}${Constants.ZWSP}${s.id}`,"",s.html,"true")})}),a&&(a=`<div class="keyboard__slash-title"></div><div class="keyboard__slash-block">${a}</div>`);const n=t.querySelector(".keyboard__util");n.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ne(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${ne(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${ne(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${ne("((","iconRef",window.siyuan.languages.ref,"true")}
    ${ne("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${ne(Constants.ZWSP+5,"iconSparkles",window.siyuan.languages.aiWriting)}
    ${ne('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true")}
    ${ne(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newSubDocRef)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ne(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true")}
    ${isInAndroid()?ne(Constants.ZWSP+3,"iconCamera",window.siyuan.languages.insertPhoto+'<input class="b3-form__upload" capture="user" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true"):""}
    ${ne('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${ne("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${ne('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${ne('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    ${ne("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ne("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${ne("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${ne("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${ne("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${ne("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${ne("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${ne("- "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${ne("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${ne("- [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${ne("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${ne("```","iconCode",window.siyuan.languages.code,"true")}
    ${ne(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${ne("---","iconLine",window.siyuan.languages.line,"true")}
    ${ne("$$","iconMath",window.siyuan.languages.math)}
    ${ne("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ne("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${ne("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${ne("```flowchart\n```","","Flow Chart","true")}
    ${ne("```graphviz\n```","","Graph","true")}
    ${ne("```mermaid\n```","","Mermaid","true")}
    ${ne("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${ne("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ne(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${ne(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${ne(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${ne(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${ne(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>${a}`,e.hint.bindUploadEvent(e,n)},ys=e=>{window.siyuan.menus.menu.remove(),Zt=!0;const t=document.getElementById("keyboardToolbar");let a=t.getAttribute("data-keyboardheight");a=(a?parseInt(a)+42:window.outerHeight/2)+"px";const n=getCurrentEditor();n&&(n.protyle.element.parentElement.style.paddingBottom=a,n.protyle.contentElement.scrollTop=e),setTimeout(()=>{t.style.height=a},Constants.TIMEOUT_TRANSITION),setTimeout(()=>{Zt=!1},1e3)},Xt=()=>{const e=document.getElementById("keyboardToolbar");e.style.height="";const t=getCurrentEditor();t&&(t.protyle.element.parentElement.style.paddingBottom="42px"),e.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},Bl=()=>{clearTimeout(bs),bs=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){wn();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){wn();return}Zt||Xt(),Pl();const e=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),t=getSelection().getRangeAt(0);if(!hasClosestByClassName(t.startContainer,"protyle-wysiwyg",!0)){e[0].classList.add("fn__none"),e[1].classList.add("fn__none");return}t.toString()||e[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(e[0].classList.add("fn__none"),e[1].classList.remove("fn__none")):(e[0].classList.remove("fn__none"),e[1].classList.add("fn__none"));const i=getCurrentEditor().protyle;if(i.toolbar.range=t,!e[0].classList.contains("fn__none")){i.undo.undoStack.length===0?e[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),i.undo.redoStack.length===0?e[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const s=hasClosestBlock(t.startContainer);if(s){const o=e[0].querySelector('[data-type="outdent"]');s.parentElement.classList.contains("li")?(o.classList.remove("fn__none"),o.nextElementSibling.classList.remove("fn__none")):(o.classList.add("fn__none"),o.nextElementSibling.classList.add("fn__none"))}}e[1].classList.contains("fn__none")||(e[1].querySelectorAll(".protyle-toolbar__item--current").forEach(o=>{o.classList.remove("protyle-toolbar__item--current")}),i.toolbar.getCurrentType(t).forEach(o=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(o))return;const l=e[1].querySelector(`[data-type="${o}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},Pl=()=>{Zt||Xt();const e=document.getElementById("keyboardToolbar");if(!e.classList.contains("fn__none"))return;e.classList.remove("fn__none"),e.style.zIndex=(++window.siyuan.zIndex).toString();const t=document.getElementById("model");t.style.transform==="translateY(0px)"&&(t.style.paddingBottom="42px");const a=getSelection().getRangeAt(0),n=getCurrentEditor();n&&n.protyle.wysiwyg.element.contains(a.startContainer)&&(n.protyle.element.parentElement.style.paddingBottom="42px"),getCurrentEditor().protyle.app.plugins.forEach(i=>{i.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const i=hasClosestByClassName(a.startContainer,"protyle-content",!0);if(i){const s=i.getBoundingClientRect().top,o=getSelectionPosition(i).top;if(o<window.innerHeight-42&&o>s)return;i.scroll({top:i.scrollTop+o-window.innerHeight+42+26,left:i.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},wn=()=>{if(Zt)return;const e=document.getElementById("keyboardToolbar");if(e.classList.contains("fn__none"))return;e.classList.add("fn__none"),e.style.height="";const t=Sn();t&&(t.protyle.element.parentElement.style.paddingBottom="");const a=document.getElementById("model");a.style.transform==="translateY(0px)"&&(a.style.paddingBottom=""),Sn().protyle.app.plugins.forEach(n=>{n.eventBus.emit("mobile-keyboard-hide")})},vn=()=>{window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard(),wn(),document.activeElement.blur()},Sd=()=>{let e=!1;document.addEventListener("selectionchange",()=>{e||Bl()},!1);const t=document.getElementById("keyboardToolbar");t.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`;let a=0,n=0,i=!1;t.addEventListener("touchstart",s=>{a=s.touches[0].clientY,n=s.touches[0].clientX,i=!1}),t.addEventListener("touchmove",s=>{(Math.abs(s.touches[0].clientY-a)>10||Math.abs(s.touches[0].clientX-n)>10)&&(i=!0)}),t.addEventListener(isInAndroid()||isInHarmony()?"touchend":"click",s=>{var o;if(i)return;const l=(o=getCurrentEditor())==null?void 0:o.protyle,r=s.target,c=hasClosestByClassName(s.target,"keyboard__slash-item");if(c&&!c.getAttribute("data-type")){const f=decodeURIComponent(c.getAttribute("data-value"));if(f===Constants.ZWSP+3)return;l.hint.fill(f,l,!1),s.preventDefault(),s.stopPropagation(),c.getAttribute("data-focus")==="true"&&focusByRange(l.toolbar.range);return}const u=hasClosestByTag(r,"BUTTON");if(!u||u.getAttribute("disabled"))return;const g=u.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(g)){const f=getFontNodeElements(l),b=u.firstElementChild;g==="style1"?fontEvent(l,f,g,b.style.backgroundColor+Constants.ZWSP+b.style.color):g==="fontSize"?fontEvent(l,f,g,b.textContent.trim()):g==="backgroundColor"?fontEvent(l,f,g,b.style.backgroundColor):g==="color"?fontEvent(l,f,g,b.style.color):fontEvent(l,f,g)}if(s.preventDefault(),s.stopPropagation(),getSelection().rangeCount===0)return;const m=getSelection().getRangeAt(0);if(g==="done"){t.clientHeight>100?(Xt(),focusByRange(m)):vn();return}if(window.siyuan.config.readonly||!l||l.disabled)return;if(g==="undo"){l.undo.undo(l);return}else if(g==="redo"){l.undo.redo(l);return}if(getSelection().rangeCount===0)return;const d=hasClosestBlock(m.startContainer);if(d){if(g==="goback"){t.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const f=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");f[0].classList.remove("fn__none"),f[1].classList.add("fn__none"),focusByRange(m),e=!0,setTimeout(()=>{e=!1},1e3);return}else if(g==="goinline"){u.classList.add("protyle-toolbar__item--current");const f=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");f[1].classList.remove("fn__none"),f[0].classList.add("fn__none"),focusByRange(m);return}else if(["a","block-ref","inline-math","inline-memo"].includes(g)){hasClosestByAttribute(m.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],l),l.toolbar.element.querySelector(`[data-type="${g}"]`).dispatchEvent(new CustomEvent("click")));return}else if(u.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(g)){hasClosestByAttribute(m.startContainer,"data-type","NodeCodeBlock")||l.toolbar.setInlineMark(l,g,"toolbar");return}else if(g==="text"){if(u.classList.contains("protyle-toolbar__item--current"))Xt(),focusByRange(m);else{u.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const f=l.contentElement.scrollTop;Hl(l,t),ys(f),window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard()}return}else if(g==="moveup"){moveToUp(l,d,m),focusByRange(m);return}else if(g==="movedown"){moveToDown(l,d,m),focusByRange(m);return}else if(g==="softLine"){m.extractContents(),softEnter(m,d,l),focusByRange(m);return}else if(g==="add"){if(u.classList.contains("protyle-toolbar__item--current"))Xt(),focusByRange(m);else{u.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const f=l.contentElement.scrollTop;Nl(l,t),ys(f),window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard()}return}else if(g==="block"){l.gutter.renderMenu(l,d),window.siyuan.menus.menu.fullscreen(),vn();return}else if(g==="outdent"){listOutdent(l,[d.parentElement],m),focusByRange(m);return}else if(g==="indent"){listIndent(l,[d.parentElement],m),focusByRange(m);return}}})},Ld=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const e=document.querySelector(".side-mask");e.classList.add("fn__none"),e.style.opacity="",window.siyuan.menus.menu.remove()},xd=()=>{activeBlur(),document.getElementById("model").style.transform=""};var Rl=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Ol=(e,t)=>{const a=new Dialog({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${e.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${e.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${e.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${e.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${e.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${e.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${e.types.databaseBlock?" checked":""}>
    </label>    
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${e.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconVideo"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.video}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="videoBlock" type="checkbox"${e.types.videoBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconRecord"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.audio}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="audioBlock" type="checkbox"${e.types.audioBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconLanguage"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            IFrame
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="iframeBlock" type="checkbox"${e.types.iframeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconBoth"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.widget}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="widgetBlock" type="checkbox"${e.types.widgetBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${e.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${e.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${e.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${e.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${e.types.document?" checked":""}>
    </label>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>    
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});a.element.setAttribute("data-key",Constants.DIALOG_SEARCHTYPE);const n=a.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{a.destroy()}),n[1].addEventListener("click",()=>{a.element.querySelectorAll(".b3-switch").forEach(i=>{e.types[i.getAttribute("data-type")]=i.checked}),t(),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},e),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),a.destroy()})},ql=e=>{let t="";Object.keys(Constants.SIYUAN_DEFAULT_REPLACETYPES).forEach(i=>{t+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[i]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${i}" type="checkbox"${e.replaceTypes[i]?" checked":""}>
</label>`});const a=new Dialog({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${t}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});a.element.setAttribute("data-key",Constants.DIALOG_REPLACETYPE);const n=a.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{a.destroy()}),n[1].addEventListener("click",()=>{a.element.querySelectorAll(".b3-switch").forEach(i=>{e.replaceTypes[i.getAttribute("data-type")]=i.checked}),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},e),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),a.destroy()})},Td=(e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_SEARCH_METHOD){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_SEARCH_METHOD),window.siyuan.menus.menu.append(new MenuItem({icon:"iconExact",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconQuote",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconDatabase",label:"SQL",current:e.method===2,click(){e.method=2,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconRegex",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,t()}}).element)},ha=(e,t,a,n,i)=>{e.removed=!1;const s=e;s.name=n,t.push(Object.assign({},s)),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},e),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),fetchPost("/api/storage/setCriterion",{criterion:s},()=>{var o;i.destroy();const l=a.querySelector("#criteria").firstElementChild;l.classList.remove("fn__none"),(o=l.querySelector(".b3-chip--current"))==null||o.classList.remove("b3-chip--current"),l.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer">${s.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},Ul=(e,t,a)=>{const n=new Dialog({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});n.element.setAttribute("data-key",Constants.DIALOG_SAVECRITERION);const i=n.element.querySelectorAll(".b3-button");n.bindInput(n.element.querySelector("input"),()=>{i[1].dispatchEvent(new CustomEvent("click"))}),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{const s=n.element.querySelector("input"),o=s.value.trim();if(!o){showMessage(window.siyuan.languages._kernel[142]);return}isMobile()?(e.k=document.querySelector("#toolbarSearch").value,e.r=a.querySelector("#toolbarReplace").value):(e.k=a.querySelector("#searchInput").value,e.r=a.querySelector("#replaceInput").value);const l=a.querySelector("#criteria").firstElementChild;let r="",c="";if(t.forEach(u=>{u.name===o&&(r=u.name),hs(u,e)&&(c=u.name)}),s.blur(),r&&!c)confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(l.children).forEach(u=>{u.textContent===o&&u.remove()}),t.find((u,g)=>{if(u.name===o)return t.splice(g,1),!0}),ha(e,t,a,o,n)});else if(r&&c)if(r===c)n.destroy();else{const u=r===o?c:r;confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",u).replace("${y}",o),()=>{Array.from(l.children).forEach(g=>{(g.textContent===c||g.textContent===r)&&g.remove()}),t.find((g,m)=>{if(g.name===u||g.name===r)return fetchPost("/api/storage/removeCriterion",{name:u}),t.splice(m,1),!0}),ha(e,t,a,o,n)})}else!r&&c?confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",c).replace("${y}",o),()=>{Array.from(l.children).forEach(u=>{u.textContent===c&&u.remove()}),t.find((u,g)=>{if(u.name===c)return fetchPost("/api/storage/removeCriterion",{name:c}),t.splice(g,1),!0}),ha(e,t,a,o,n)}):ha(e,t,a,o,n)})},Id=(e,t,a,n,i,s)=>Rl(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_SEARCH_MORE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_SEARCH_MORE),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.listInvalidRefBlocks,click(){goUnRef()}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchType,click(){Ol(e,()=>{updateSearchResult(e,a,!0)})}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.replaceType,click(){ql(e)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchMethod,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,e.page=1,updateSearchResult(e,a,!0)}},{iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,e.page=1,updateSearchResult(e,a,!0)}},{iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,e.page=1,updateSearchResult(e,a,!0)}},{iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,e.page=1,updateSearchResult(e,a,!0)}}]}).element);const o=[{iconHTML:"",label:window.siyuan.languages.type,current:e.sort===0,click(){e.sort=0,n()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:e.sort===1,click(){e.sort=1,n()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:e.sort===2,click(){e.sort=2,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:e.sort===3,click(){e.sort=3,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:e.sort===4,click(){e.sort=4,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:e.sort===6,click(){e.sort=6,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:e.sort===7,click(){e.sort=7,n()}}];e.group===1&&o.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:e.sort===5,click(){e.sort=5,n()}}),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:e.group===0,click(){isMobile()?(a.querySelector('[data-type="expand"]').classList.add("fn__none"),a.querySelector('[data-type="contract"]').classList.add("fn__none")):a.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),e.group=0,e.sort===5&&(e.sort=0),n()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:e.group===1,click(){isMobile()?(a.querySelector('[data-type="expand"]').classList.remove("fn__none"),a.querySelector('[data-type="contract"]').classList.remove("fn__none")):a.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),e.group=1,n()}}]}).element),s&&s(),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){Ul(e,t,a)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){i()}}).element)}),hs=(e,t)=>!!(t.group===e.group&&t.hPath===e.hPath&&t.hasReplace===e.hasReplace&&t.k===e.k&&t.method===e.method&&t.r===e.r&&t.sort===e.sort&&objEquals(t.types,e.types)&&objEquals(t.replaceTypes,e.replaceTypes)&&objEquals(t.idPath,e.idPath)),Dd=(e,t,a)=>{fetchPost("/api/storage/getCriteria",{},n=>{let i="";n.data.forEach(s=>{t.push(s);let o=!1;hs(s,a)&&(o=!0),i+=`<div data-type="set-criteria" class="${o?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer">${escapeHtml(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),e.innerHTML=`<div class="b3-chips${i?"":" fn__none"}">
    ${i}
</div>`})},Md=e=>{const t=[];return e.querySelectorAll(".b3-list-item__text mark").forEach(a=>{t.push(a.textContent)}),t.length===0&&e.querySelectorAll(".b3-list-item__meta mark").forEach(a=>{t.push(a.textContent)}),[...new Set(t)].join(" ")},$d=(e,t)=>{};let _s;const ws=(e,t,a=1)=>{const n=e.parentElement.querySelector(".fn__loading--top");n.classList.remove("fn__none"),clearTimeout(_s),_s=window.setTimeout(()=>{t||(t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET]);const i=e.querySelector('[data-type="assetPrevious"]');a>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const s=e.querySelector("#searchAssetInput");fetchPost("/api/search/fullTextSearchAssetContent",{page:a,query:s.value,types:t.types,method:t.method,orderBy:t.sort},o=>{var l,r;n.classList.add("fn__none");const c=e.querySelector('[data-type="assetNext"]');a<o.data.pageCount?c.removeAttribute("disabled"):c.setAttribute("disabled","disabled");let u="";o.data.assetContents.forEach((m,d)=>{u+=`<div data-type="search-item" class="b3-list-item${d===0?" b3-list-item--focus":""}" data-id="${m.id}">
<span class="ft__on-surface">${m.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${m.content}</span>
<span class="b3-list-item__meta">${m.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${escapeAriaLabel(m.path)}">${m.name}</span>
</div>`});const g=e.querySelector("#searchAssetPreview");o.data.assetContents.length>0?(g.classList.remove("fn__none"),(l=e.querySelector(".search__drag"))==null||l.classList.remove("fn__none"),Fl(g,o.data.assetContents[0].id,s.value,t.method)):(g.classList.add("fn__none"),(r=e.querySelector(".search__drag"))==null||r.classList.add("fn__none")),e.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${a}/${o.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${o.data.matchedAssetCount}</span>`,e.querySelector("#searchAssetList").innerHTML=u||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},Constants.TIMEOUT_INPUT)},Fl=(e,t,a,n)=>{fetchPost("/api/search/getAssetContent",{id:t,query:a,queryMethod:n},i=>{e.innerHTML=`<p style="white-space: pre-wrap;">${i.data.assetContent.content}</p>`;const s=e.querySelector("mark");if(s){s.classList.add("mark--hl");const o=e.getBoundingClientRect();e.scrollTop=e.scrollTop+s.getBoundingClientRect().top-o.top-o.height/2}})},Hd=e=>{let t;const a=Array.from(e.querySelectorAll("mark"));if(a.find((n,i)=>{if(n.classList.contains("mark--hl")){n.classList.remove("mark--hl"),t=a[i+1];return}}),t||(t=a[0]),t){t.classList.add("mark--hl");const n=e.getBoundingClientRect();e.scrollTop=e.scrollTop+t.getBoundingClientRect().top-n.top-n.height/2}},Nd=(e,t)=>{const a=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_SEARCH_ASSET_METHOD){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_SEARCH_ASSET_METHOD),window.siyuan.menus.menu.append(new MenuItem({icon:"iconExact",label:window.siyuan.languages.keyword,current:a===0,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconQuote",label:window.siyuan.languages.querySyntax,current:a===1,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconRegex",label:window.siyuan.languages.regex,current:a===3,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=3,t()}}).element),window.siyuan.menus.menu.fullscreen()},Yl=e=>{let t="";return Constants.SIYUAN_ASSETS_SEARCH.sort((a,n)=>a.localeCompare(n)).forEach(a=>{t+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${a}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${a}" type="checkbox" ${e[a]?" checked":""}>
    </label>`}),t},Bd=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].types,a=new Dialog({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${Yl(t)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});a.element.setAttribute("data-key",Constants.DIALOG_SEARCHASSETSTYPE);const n=a.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{a.destroy()}),n[1].addEventListener("click",()=>{a.element.querySelectorAll(".b3-switch").forEach(i=>{t[i.getAttribute("data-type")]=i.checked}),ws(e),setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),a.destroy()})},Pd=(e,t,a)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_SEARCH_ASSET_MORE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_SEARCH_ASSET_MORE);const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],i=[{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:n.sort===1,click(){n.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:n.sort===0,click(){n.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:n.sort===3,click(){n.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:n.sort===2,click(){n.sort=2,a()}}];window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.rebuildIndex,click(){t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),fetchPost("/api/asset/fullReindexAssetContent",{},()=>{ws(t,n)})}}).element),window.siyuan.menus.menu.fullscreen()},Rd=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHKEYS];if(!t.replaceKeys||t.replaceKeys.length===0||t.length===1&&t[0]===e.value)return;const a=new Menu(Constants.MENU_SEARCH_REPLACE_HISTORY);if(a.isOpen)return;a.element.classList.add("b3-menu--list"),a.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].replaceKeys=[],setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS])}});const n=a.addSeparator(1);let i=!0;t.replaceKeys.forEach(o=>{if(o!==e.value&&o){const l=a.addItem({iconHTML:"",label:escapeHtml(o),action:"iconCloseRound",bind(r){r.addEventListener("click",c=>{var u;hasClosestByClassName(c.target,"b3-menu__action")?(t.replaceKeys.find((g,m)=>{if(g===o)return t.replaceKeys.splice(m,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].replaceKeys=t.replaceKeys,setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS]),(u=r.previousElementSibling)!=null&&u.classList.contains("b3-menu__separator")&&!r.nextElementSibling?window.siyuan.menus.menu.remove():r.remove()):(e.value=r.textContent,window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})}});i&&l.classList.add("b3-menu__item--current"),i=!1}}),i&&n.remove();const s=e.previousElementSibling.getBoundingClientRect();a.open({x:s.left,y:s.bottom})},Od=(e,t,a)=>{const n=e.querySelector("#searchInput, #toolbarSearch"),i=window.siyuan.storage[Constants.LOCAL_SEARCHKEYS];if(!i.keys||i.keys.length===0||i.length===1&&i[0]===n.value)return;const s=new Menu(Constants.MENU_SEARCH_HISTORY);if(s.isOpen)return;s.element.classList.add("b3-menu--list"),s.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].keys=[],setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS])}});const o=s.addSeparator(1);let l=!0;i.keys.forEach(c=>{if(c!==n.value&&c){const u=s.addItem({iconHTML:"",label:escapeHtml(c),action:"iconCloseRound",bind(g){g.addEventListener("click",m=>{var d;hasClosestByClassName(m.target,"b3-menu__action")?(i.keys.find((f,b)=>{if(f===c)return i.keys.splice(b,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHKEYS].keys=i.keys,setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS]),(d=g.previousElementSibling)!=null&&d.classList.contains("b3-menu__separator")&&!g.nextElementSibling?window.siyuan.menus.menu.remove():g.remove()):(n.value=g.textContent,t.page=1,updateSearchResult(t,e,!0),window.siyuan.menus.menu.remove()),m.preventDefault(),m.stopPropagation()})}});l&&u.classList.add("b3-menu__item--current"),l=!1}}),l&&o.remove();const r=n.previousElementSibling.getBoundingClientRect();s.open({x:r.left,y:r.bottom})},qd=e=>{const t=e.querySelector("#searchAssetInput"),a=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys;if(!a||a.length===0||a.length===1&&a[0]===t.value)return;const n=new Menu(Constants.MENU_SEARCH_ASSET_HISTORY);if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=[],setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET])}});const i=n.addSeparator(1);let s=!0;a.forEach(l=>{if(l!==t.value&&l){const r=n.addItem({iconHTML:"",label:escapeHtml(l),action:"iconCloseRound",bind(c){c.addEventListener("click",u=>{var g;hasClosestByClassName(u.target,"b3-menu__action")?(a.find((m,d)=>{if(m===l)return a.splice(d,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=a,setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),(g=c.previousElementSibling)!=null&&g.classList.contains("b3-menu__separator")&&!c.nextElementSibling?window.siyuan.menus.menu.remove():c.remove()):(t.value=c.textContent,assetInputEvent(e),window.siyuan.menus.menu.remove()),u.preventDefault(),u.stopPropagation()})}});s&&r.classList.add("b3-menu__item--current"),s=!1}}),s&&i.remove();const o=t.previousElementSibling.getBoundingClientRect();n.open({x:o.left,y:o.bottom})},Ud=(e,t)=>{let a=window.siyuan.storage[Constants.LOCAL_SEARCHKEYS][e];a.splice(0,0,t),a=Array.from(new Set(a)),a.length>window.siyuan.config.search.limit&&a.splice(window.siyuan.config.search.limit,a.length-window.siyuan.config.search.limit),window.siyuan.storage[Constants.LOCAL_SEARCHKEYS][e]=a,setStorageVal(Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[Constants.LOCAL_SEARCHKEYS])},Fd=e=>{if(!e.value)return;let t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys;t.splice(0,0,e.value),t=Array.from(new Set(t)),t.length>window.siyuan.config.search.limit&&t.splice(window.siyuan.config.search.limit,t.length-window.siyuan.config.search.limit),window.siyuan.storage[Constants.LOCAL_SEARCHASSET].k=e.value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=t,setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET])},vs=(e,t,a)=>{if(t.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const n=e.querySelector("#searchList"),i=e.querySelector("#toolbarReplace"),s=i.parentElement.querySelector(".fn__rotate");if(!s.classList.contains("fn__none"))return;saveKeyList("replaceKeys",i.value);const o=n.querySelector(".b3-list-item--focus");if(!o)return;s.classList.remove("fn__none"),s.nextElementSibling.classList.add("fn__none");const l=o.getAttribute("data-node-id");fetchPost("/api/search/findReplace",{k:t.method===0||t.method===1?getKeyByLiElement(o):document.querySelector("#toolbarSearch").value,r:i.value,ids:a?[]:[l],types:t.types,method:t.method,replaceTypes:t.replaceTypes,paths:t.idPath||[],groupBy:t.group,orderBy:t.sort,page:t.page},r=>{var c;if(s.classList.add("fn__none"),s.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(a){Re(t,e,!1);return}reloadProtyle(window.siyuan.mobile.editor.protyle,!1);let u=o.getAttribute("data-node-id");if(o.nextElementSibling?u=o.nextElementSibling.getAttribute("data-node-id"):o.previousElementSibling&&(u=o.previousElementSibling.getAttribute("data-node-id")),t.group===1&&!u){const g=o.parentElement.nextElementSibling||((c=o.parentElement.previousElementSibling.previousElementSibling)==null?void 0:c.previousElementSibling);g&&(u=g.nextElementSibling.firstElementChild.getAttribute("data-node-id"))}Re(t,e,!1,{currentId:l,newId:u})})},En=(e,t,a)=>{a.hasReplace!==t.hasReplace&&(t.hasReplace?(e.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),e.querySelector(".toolbar").classList.remove("fn__none")):(e.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),e.querySelector(".toolbar").classList.add("fn__none")));const n=e.querySelector("#searchPath");t.hPath?(n.classList.remove("fn__none"),n.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):n.classList.add("fn__none"),a.group!==t.group&&(t.group===0?(e.querySelector('[data-type="expand"]').classList.add("fn__none"),e.querySelector('[data-type="contract"]').classList.add("fn__none")):(e.querySelector('[data-type="expand"]').classList.remove("fn__none"),e.querySelector('[data-type="contract"]').classList.remove("fn__none")));let i=!0,s=!1;t.idPath.forEach(l=>{l.endsWith(".sy")&&(i=!1),l.split("/").length>1&&(s=!0)});const o=e.querySelector('[data-type="include"]');i?o.classList.add("toolbar__icon--active"):o.classList.remove("toolbar__icon--active"),s?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=t.k,e.querySelector("#toolbarReplace").value=t.r,Object.assign(a,t),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},a),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),Re(a,e),window.siyuan.menus.menu.remove()},Es=(e,t,a,n)=>{const i=document.querySelector("#searchList");let s="",o,l;e.forEach(c=>{const u=getNotebookName(c.box)+getDisplayName(c.hPath,!1);c.children?(s+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(c.box)||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(u)}</span>
</div><div>`,c.children.forEach(g=>{n&&(g.id===n.currentId&&(o=g),g.id===n.newId&&(l=g)),s+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item" data-node-id="${g.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(g.type)}"></use></svg>
${unicode2Emoji(g.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${g.content}</span>
${g.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${g.tag.replace(/#/g,"")}</span>`:""}
</div>`}),s+="</div>"):(n&&(c.id===n.currentId&&(o=c),c.id===n.newId&&(l=c)),s+=`<div class="b3-list-item b3-list-item--two" data-type="search-item" data-node-id="${c.id}">
    <div class="b3-list-item__first">
        <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(c.type)}"></use></svg>
        ${unicode2Emoji(c.ial.icon,"b3-list-item__graphic",!0)}
        <span class="b3-list-item__text">${c.content}</span>
    </div>
    <div class="fn__flex">
        ${c.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${c.tag.replace(/#/g,"")}</span><span class="fn__space"></span>`:""}
        <span class="b3-list-item__text b3-list-item__meta">${escapeGreat(u)}</span>
    </div>
</div>`)}),i.innerHTML=s||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,i.scrollTop=0;let r="";if(a){let c=window.siyuan.languages.findInDoc.replace("${x}",a.data.matchedRootCount).replace("${y}",a.data.matchedBlockCount);a.data.docMode&&(c=window.siyuan.languages.matchDoc.replace("${x}",a.data.matchedRootCount)),r=`<span class="fn__flex-center">${c}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t.page}/${a.data.pageCount||1}</span>`}if(i.previousElementSibling.querySelector('[data-type="result"]').innerHTML=r,o||(o=l),!o&&e.length>0&&(e[0].children?o=e[0].children[0]:o=e[0]),o){const c=i.querySelector(`[data-node-id="${o.id}"]`);c&&(c.classList.add("b3-list-item--focus"),c.scrollIntoView())}};let ks=0;const Re=(e,t,a=!1,n)=>{clearTimeout(ks),ks=window.setTimeout(()=>{var i;a&&((i=t.querySelector("#criteria .b3-chip--current"))==null||i.classList.remove("b3-chip--current"));const s=t.querySelector(".fn__loading--top");s.classList.remove("fn__none");const o=t.querySelector('[data-type="previous"]'),l=t.querySelector('[data-type="next"]'),r=document.getElementById("toolbarSearch");e.query=r.value,e.query===""&&(!e.idPath||e.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},c=>{Es(c.data,e,void 0,n),s.classList.add("fn__none"),o.setAttribute("disabled","true"),l.setAttribute("disabled","true")}):(e.page||(e.page=1),e.page>1?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:e.query,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page},c=>{Es(c.data.blocks,e,c,n),s.classList.add("fn__none"),e.page<c.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},Wl=(e,t,a)=>{const n=document.getElementById("toolbarSearch");n.value=a.k||"",n.addEventListener("compositionend",u=>{u&&u.isComposing||(a.page=1,Re(a,t,!0))}),n.addEventListener("input",u=>{u&&u.isComposing||(a.page=1,Re(a,t,!0))}),n.addEventListener("blur",()=>{a.removed&&(a.k=n.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},a),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),saveKeyList("keys",n.value)}),addClearButton({inputElement:n,className:"toolbar__icon",clearCB(){a.page=1,Re(a,t)}});const i=t.querySelector(".toolbar .toolbar__title");i.value=a.r||"",addClearButton({inputElement:i,className:"toolbar__icon"});const s=[];initCriteriaMenu(t.querySelector("#criteria"),s,a);const o=document.querySelector("#searchAssetsPanel"),l=document.querySelector("#searchUnRefPanel"),r=t.querySelector("#searchList"),c=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];t.addEventListener("click",u=>{var g,m;let d=u.target;for(;d&&d!==t;){const f=d.getAttribute("data-type");if(f==="replaceHistory"){toggleReplaceHistory(d.nextElementSibling),u.stopPropagation(),u.preventDefault();break}else if(f==="assetHistory"){toggleAssetHistory(o),u.stopPropagation(),u.preventDefault();break}else if(f==="previous"){d.getAttribute("disabled")||(a.page--,Re(a,t)),u.stopPropagation(),u.preventDefault();break}else if(f==="next"){d.getAttribute("disabled")||(a.page++,Re(a,t)),u.stopPropagation(),u.preventDefault();break}else if(f==="set-criteria"){a.removed=!1,(g=d.parentElement.querySelector(".b3-chip--current"))==null||g.classList.remove("b3-chip--current"),d.classList.add("b3-chip--current"),s.find(b=>{if(b.name===d.innerText.trim())return En(t,b,a),!0}),u.stopPropagation(),u.preventDefault();break}else if(f==="remove-criteria"){const b=d.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:b}),s.find((p,y)=>{if(p.name===b)return s.splice(y,1),!0}),d.parentElement.classList.contains("b3-chip--current")&&En(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},a),d.parentElement.parentElement.childElementCount===1&&d.parentElement.parentElement.classList.add("fn__none"),d.parentElement.remove(),u.stopPropagation(),u.preventDefault();break}else if(f==="remove-path"){a.idPath=[],a.hPath="",t.querySelector("#searchPath").classList.add("fn__none"),a.page=1,Re(a,t,!0);const b=t.querySelector('[data-type="include"]');b.classList.remove("toolbar__icon--active"),b.setAttribute("disabled","disabled"),u.stopPropagation(),u.preventDefault();break}else if(f==="expand"){Array.from(r.children).forEach(b=>{b.classList.contains("b3-list-item")&&(b.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),b.nextElementSibling.classList.remove("fn__none"))}),u.stopPropagation(),u.preventDefault();break}else if(f==="contract"){Array.from(r.children).forEach(b=>{b.classList.contains("b3-list-item")&&(b.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),b.nextElementSibling.classList.add("fn__none"))}),u.stopPropagation(),u.preventDefault();break}else if(f==="currentPath"&&!d.hasAttribute("disabled")){const b=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[b.path]},p=>{a.idPath=[pathPosix().join(b.notebookId,b.path)],a.hPath=p.data[0];const y=t.querySelector("#searchPath");y.classList.remove("fn__none"),y.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(a.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const _=t.querySelector('[data-type="include"]');_.classList.remove("toolbar__icon--active"),_.removeAttribute("disabled"),a.page=1,Re(a,t,!0)}),u.stopPropagation(),u.preventDefault();break}else if(f==="path"){movePathTo((b,p)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:b},y=>{a.idPath=[];const _=[];let k=!1;b.forEach((w,v)=>{w==="/"?(a.idPath.push(p[v]),_.push(getNotebookName(p[v]))):(k=!0,a.idPath.push(pathPosix().join(p[v],w.replace(".sy",""))))}),y.data&&_.push(...y.data),a.hPath=_.join(" ");const x=t.querySelector("#searchPath");x.classList.remove("fn__none"),x.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(a.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const T=t.querySelector('[data-type="include"]');T.classList.add("toolbar__icon--active"),k?T.removeAttribute("disabled"):T.setAttribute("disabled","disabled"),a.page=1,Re(a,t,!0)})},[],void 0,window.siyuan.languages.specifyPath),u.stopPropagation(),u.preventDefault();break}else if(f==="include"&&!d.hasAttribute("disabled")){d.classList.toggle("toolbar__icon--active"),d.classList.contains("toolbar__icon--active")?a.idPath.forEach((b,p)=>{b.endsWith(".sy")&&(a.idPath[p]=b.replace(".sy",""))}):a.idPath.forEach((b,p)=>{!b.endsWith(".sy")&&b.split("/").length>1&&(a.idPath[p]=b+".sy")}),a.page=1,Re(a,t,!0),u.stopPropagation(),u.preventDefault();break}else if(f==="toggle-replace"){a.hasReplace=!a.hasReplace,i.parentElement.classList.toggle("fn__none"),d.classList.toggle("toolbar__icon--active"),u.stopPropagation(),u.preventDefault();break}else if(f==="more"){moreMenu(a,s,t,()=>{a.page=1,Re(a,t,!0)},()=>{En(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},a)}),window.siyuan.menus.menu.fullscreen(),u.stopPropagation(),u.preventDefault();break}else if(f==="replace-all"){vs(t,a,!0),u.stopPropagation(),u.preventDefault();break}else if(f==="refreshUnRef"){_a(l),u.stopPropagation(),u.preventDefault();break}else if(f==="unRefPrevious"){if(!d.getAttribute("disabled")){let b=parseInt(l.querySelector("#searchUnRefResult").lastElementChild.textContent);b>1&&(b--,_a(l,b))}u.stopPropagation(),u.preventDefault();break}else if(f==="unRefNext"){const b=l.querySelector("#searchUnRefResult").lastElementChild;let p=parseInt(b.textContent);p<parseInt(b.textContent.split("/")[1])&&(p++,_a(l,p)),u.stopPropagation(),u.preventDefault();break}else if(f==="queryAsset"){assetMethodMenu(d,()=>{assetInputEvent(o,c),setStorageVal(Constants.LOCAL_SEARCHASSET,c)}),u.stopPropagation(),u.preventDefault();break}else if(f==="filterAsset"){assetFilterMenu(o),u.stopPropagation(),u.preventDefault();break}else if(f==="moreAsset"){assetMoreMenu(d,o,()=>{assetInputEvent(o),setStorageVal(Constants.LOCAL_SEARCHASSET,c)}),u.stopPropagation(),u.preventDefault();break}else if(f==="goAsset"){jl(),u.stopPropagation(),u.preventDefault();break}else if(f==="goSearch"){o.classList.add("fn__none"),l.classList.add("fn__none"),u.stopPropagation(),u.preventDefault();break}else if(f==="assetPrevious"){d.getAttribute("disabled")||assetInputEvent(o,c,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),u.stopPropagation(),u.preventDefault();break}else if(f==="assetNext"){d.getAttribute("disabled")||assetInputEvent(o,c,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),u.stopPropagation(),u.preventDefault();break}else if(f==="replace"){vs(t,a,!1),u.stopPropagation(),u.preventDefault();break}else if(d.classList.contains("b3-list-item__toggle")){d.parentElement.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.classList.toggle("b3-list-item__arrow--open"),u.stopPropagation(),u.preventDefault();break}else if(d.classList.contains("b3-list-item")){if(d.getAttribute("data-type")==="search-new")newFileByName(e,n.value);else if(d.getAttribute("data-type")==="search-item"){const b=d.getAttribute("data-node-id");b?((m=window.siyuan.mobile.editor)!=null&&m.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),checkFold(b,p=>{openMobileFileById(e,b,p?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):d.classList.contains("b3-list-item--focus")?d.classList.contains("b3-list-item--focus")&&renderNextAssetMark(t.querySelector("#searchAssetPreview")):(t.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus"),renderPreview(t.querySelector("#searchAssetPreview"),d.dataset.id,t.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else d.querySelector(".b3-list-item__toggle")&&(d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));u.stopPropagation(),u.preventDefault();break}d=d.parentElement}},!1)},Yd=(e,t)=>{var a;const n=JSON.parse(JSON.stringify(window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),i=(((a=getCurrentEditor())==null?void 0:a.protyle.toolbar.range)||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange())).toString();i&&(n.k=i),t&&Object.keys(t).forEach(l=>{n[l]=t[l]}),activeBlur();let s=!0,o=!1;n.idPath.forEach(l=>{l.endsWith(".sy")&&(s=!1),l.split("/").length>1&&(o=!0)}),openModel({title:`<div class="fn__flex">
    <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="history">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block" autocomplete="off" autocorrect="off" spellcheck="false">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${n.hasReplace?"":" fn__none"}">
        <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="replaceHistory">
            <svg class="svg--mid"><use xlink:href="#iconReplace"></use></svg>
            <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${n.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(n.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${n.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${o?"":"disabled"} data-type="include" class="toolbar__icon${s?" toolbar__icon--active":""}"><use xlink:href="#iconInclude"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${n.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${n.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
           <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="assetHistory">
                <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
                <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchUnRefPanel">
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchUnRefResult" class="fn__flex-1 fn__flex"></span>
            <span class="fn__space"></span>
            <svg data-type="unRefPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="unRefNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchUnRefList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="refreshUnRef" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(l){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{newFileByName(e,document.querySelector("#toolbarSearch").value)}),document.querySelector('.toolbar [data-type="history"]').addEventListener("click",()=>{toggleSearchHistory(document.querySelector("#model"),n,void 0)}),Wl(e,l.firstElementChild,n),Re(n,l)}})},jl=()=>{const e=document.querySelector("#searchAssetsPanel");if(e.classList.remove("fn__none"),e.querySelector("#searchAssetList").innerHTML)return;const a=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],n=e.querySelector("input");n.value=a.k,n.addEventListener("compositionend",i=>{i.isComposing||assetInputEvent(e,a)}),n.addEventListener("input",i=>{i.isComposing||assetInputEvent(e,a)}),n.addEventListener("blur",()=>{saveAssetKeyList(n)}),assetInputEvent(e,a),addClearButton({inputElement:n,className:"toolbar__icon",clearCB(){assetInputEvent(e,a)}})},Wd=()=>{window.siyuan.menus.menu.remove();const e=document.querySelector("#searchUnRefPanel");e.classList.remove("fn__none"),!e.querySelector("#searchUnRefList").innerHTML&&_a(e)},_a=(e,t=1)=>{const a=e.querySelector('[data-type="unRefPrevious"]');t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),fetchPost("/api/search/listInvalidBlockRefs",{page:t},n=>{e.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const i=e.querySelector('[data-type="unRefNext"]');t<n.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");let s="";n.data.blocks.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);s+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),e.querySelector("#searchUnRefResult").innerHTML=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t}/${n.data.pageCount||1}</span>`,e.querySelector("#searchUnRefList").innerHTML=s||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},jd=e=>{fetchPost("/api/storage/getRecentDocs",{sortBy:"viewedAt"},t=>{let a="";t.data.forEach((n,i)=>{a+=`<li data-index="${i}" data-node-id="${n.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${unicode2Emoji(n.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(n.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${a}</ul>`,bindEvent(n){n.firstElementChild.addEventListener("click",i=>{const s=hasClosestByClassName(i.target,"b3-list-item");s&&openMobileFileById(e,s.dataset.nodeId,[Constants.CB_GET_SCROLL])})}})})},Vd=(e,t,a)=>{e.addEventListener("mousedown",n=>{const i=hasClosestByClassName(t,"b3-dialog__body")||hasClosestByClassName(t,"protyle-util");if(!i)return;i.style.userSelect="none",i.style.pointerEvents="none";const s=document;s.ondragstart=()=>!1;const o=n.clientX,l=t.clientWidth,r=i.clientWidth-256;s.onmousemove=c=>{const u=l+(c.clientX-o);u<256||u>r||(t.style.width=u+"px")},s.onmouseup=()=>{i.style.userSelect="auto",i.style.pointerEvents="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,a&&(window.siyuan.storage[Constants.LOCAL_HISTORY][a]=t.clientWidth+"px",setStorageVal(Constants.LOCAL_HISTORY,window.siyuan.storage[Constants.LOCAL_HISTORY]))}})},kn=(e,t)=>{if(!e||e.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let a="";return e.forEach((n,i)=>{let s="";t&&(s=`data-id2="${t[i].fileID}"`),a+=`<li style="padding-left: 40px;" class="b3-list-item" ${s} data-id="${n.fileID}">
    <span class="b3-list-item__text" title="${escapeAttr(n.path)} ${n.hSize}">${escapeHtml(n.title)}</span>
</li>`}),a};let _t,Bt;const Cs=(e,t)=>{if(!hasClosestByClassName(t,"history__side"))return;const n=hasClosestByClassName(t,"b3-dialog__container");if(!n)return;const i=n.querySelector('[data-type="editors"]'),s=i.firstElementChild,o=i.lastElementChild;_t||(_t=new Protyle(e,s.lastElementChild,{blockId:"",history:{snapshot:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(_t.protyle),Bt=new Protyle(e,o.lastElementChild,{blockId:"",action:[Constants.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(Bt.protyle)),fetchPost("/api/repo/openRepoSnapshotDoc",{id:t.getAttribute("data-id")},r=>{s.classList.remove("fn__none");const c=s.querySelector("textarea"),u=pathPosix().extname(r.data.content).toLowerCase(),g=s.querySelector(".protyle-title__input");Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(u)?(c.previousElementSibling.innerHTML=renderAssetsPreview(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),s.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),s.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),s.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),_t.protyle.options.history.snapshot=n.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),onGet({data:r,protyle:_t.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),g.textContent=r.data.title,s.querySelector(".history__date").textContent=dayjs(r.data.updated).format("YYYY-MM-DD HH:mm")});const l=t.getAttribute("data-id2");l?(o.classList.remove("fn__none"),fetchPost("/api/repo/openRepoSnapshotDoc",{id:l},r=>{const c=o.querySelector("textarea"),u=pathPosix().extname(r.data.content).toLowerCase(),g=o.querySelector(".protyle-title__input");Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(u)?(c.previousElementSibling.innerHTML=renderAssetsPreview(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),o.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),o.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),o.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),Bt.protyle.options.history.snapshot=n.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),onGet({data:r,protyle:Bt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),g.textContent=r.data.title,o.querySelector(".history__date").textContent=dayjs(r.data.updated).format("YYYY-MM-DD HH:mm")})):o.classList.add("fn__none")},Gd=(e,t)=>{if(t.length!==2)return;let a,n;t[0].time>t[1].time?(a=t[1].id,n=t[0].id):(a=t[0].id,n=t[1].id);const i=new Dialog({title:window.siyuan.languages.compare,content:"",width:isMobile()?"92vw":"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){_t=void 0,Bt=void 0}});i.element.setAttribute("data-key",Constants.DIALOG_HISTORYCOMPARE),i.element.addEventListener("click",s=>{var o;if(typeof s.detail=="string"){Cs(e,i.element.querySelector(".history__side .b3-list-item--focus")),s.stopPropagation(),s.preventDefault();return}let l=s.target;for(;l&&l!==i.element;){if(l.classList.contains("b3-list-item")&&!l.dataset.id){l.nextElementSibling.classList.toggle("fn__none"),l.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("b3-list-item")&&l.dataset.id){if(l.classList.contains("b3-list-item--focus"))return;(o=i.element.querySelector(".history__side .b3-list-item--focus"))==null||o.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus"),Cs(e,l),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("block__icon")){l.getAttribute("data-direct")==="left"?(l.setAttribute("data-direct","right"),Cn(n,a,i,"right")):(l.setAttribute("data-direct","left"),Cn(a,n,i,"left")),s.preventDefault(),s.stopPropagation();break}l=l.parentElement}}),Cn(a,n,i,"left")},Cn=(e,t,a,n)=>{_t=void 0,Bt=void 0;const i=isMobile();fetchPost("/api/repo/diffRepoSnapshots",{left:e,right:t},s=>{const o=a.element.querySelector(".b3-dialog__header");o.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${dayjs(s.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${n}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${dayjs(s.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,o.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__side" ${isMobile()?"":`style="width: ${window.siyuan.storage[Constants.LOCAL_HISTORY].sideDiffWidth}"`}>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${s.data.updatesLeft.length===0?" fn__none":""}">${s.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${kn(s.data.updatesLeft,s.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${s.data.addsLeft.length===0?" fn__none":""}">${s.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${kn(s.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${s.data.removesRight.length===0?" fn__none":""}">${s.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${kn(s.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex" data-type="editors">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${dayjs(s.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${s.data.left.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${s.data.right.title} ${dayjs(s.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${s.data.right.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`,resizeSide(a.element.querySelector(".history__resize"),a.element.querySelector(".history__side"),"sideDiffWidth")})};let wt;const Pt=(e,t)=>{const a=e.querySelector('[data-type="docprevious"]'),n=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const i=e.querySelector('button[data-type="jumpHistoryPage"]');i.textContent=`${t}`;const s=e.querySelector(".b3-text-field"),o=e.querySelector('.b3-select[data-type="opselect"]'),l=e.querySelector('.b3-select[data-type="typeselect"]'),r=e.querySelector('.b3-select[data-type="notebookselect"]'),c=e.querySelector('.history__text[data-type="docPanel"]'),u=e.querySelector('.history__text[data-type="assetPanel"]'),g=e.querySelector('.history__text[data-type="mdPanel"]'),m=e.querySelector(".b3-list");e.querySelector(".protyle-title__input").classList.add("fn__none"),u.classList.add("fn__none"),g.classList.add("fn__none"),c.classList.add("fn__none"),l.value==="2"?(r.setAttribute("disabled","disabled"),window.siyuan.storage[Constants.LOCAL_HISTORY].type!==2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.remove("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.add("fn__none"),o.querySelector('option[value="format"]').classList.add("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.add("fn__none"),o.querySelector('option[value="outline"]').classList.add("fn__none")):(r.removeAttribute("disabled"),window.siyuan.storage[Constants.LOCAL_HISTORY].type===2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.add("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.remove("fn__none"),o.querySelector('option[value="format"]').classList.remove("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.remove("fn__none"),o.querySelector('option[value="outline"]').classList.remove("fn__none")),window.siyuan.storage[Constants.LOCAL_HISTORY].notebookId=r.value,window.siyuan.storage[Constants.LOCAL_HISTORY].type=parseInt(l.value),window.siyuan.storage[Constants.LOCAL_HISTORY].operation=o.value,setStorageVal(Constants.LOCAL_HISTORY,window.siyuan.storage[Constants.LOCAL_HISTORY]),fetchPost("/api/history/searchHistory",{notebook:r.value,query:s.value,page:t,op:o.value,type:parseInt(l.value)},d=>{t<d.data.pageCount?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(d.data.pageCount||1).toString());const f=n.nextElementSibling.nextElementSibling;if(f.textContent=`${window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",d.data.pageCount).replace("${y}",d.data.totalCount||1)}`,f.classList.remove("fn__none"),d.data.histories.length===0){m.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let b="";d.data.histories.forEach(p=>{b+=`<li class="b3-list-item" data-type="toggle" data-created="${p}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${dayjs(parseInt(p)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),m.innerHTML=b})},As=(e,t,a)=>{if(e.data.snapshots.length===0){t.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";a==="getCloudRepoTagSnapshots"?n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:a==="getCloudRepoSnapshots"?n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:a==="getRepoTagSnapshots"?n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:a==="getRepoSnapshots"&&(n=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let i="";const s=isMobile();e.data.snapshots.forEach(o=>{let l="";o.typesCount&&(l=`<div class="b3-list-item__meta${s?" fn__none":""}">
${window.siyuan.languages.fileCount} ${o.count}<span class="fn__space"></span>`,o.typesCount.forEach(c=>{l+=`${c.type} ${c.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${s?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${o.hCreated}</span>
    <span class="fn__space"></span>
    ${o.hSize}
    <span class="fn__space"></span>
    ${o.systemOS}${o.systemName&&o.systemOS?"/":""}${o.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${o.tag?"":" fn__none"}">${o.tag}</span>
</div>
<div class="b3-list-item__meta${s?" fn__none":""}">
    ${escapeHtml(o.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${o.id.substring(0,7)}</code>
</div>
${l}`;i+=`<li class="b3-list-item" data-type="repoitem" data-id="${o.id}" data-tag="${o.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${o.id}" data-tag="${o.tag}">
        ${n}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),t.lastElementChild.innerHTML=`${i}`},mt=(e,t)=>{const a=e.querySelector(".b3-select");a.disabled=!0;const n=a.value;e.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const i=e.querySelector('button[data-type="jumpRepoPage"]');i.textContent=`${t}`;const s=e.querySelector('[data-type="previous"]'),o=e.querySelector('[data-type="next"]'),l=o.nextElementSibling.nextElementSibling;e.setAttribute("data-init","true"),n==="getRepoTagSnapshots"||n==="getCloudRepoTagSnapshots"?(fetchPost(`/api/repo/${n}`,{},r=>{As(r,e,n),a.disabled=!1}),s.classList.add("fn__none"),o.classList.add("fn__none"),l.classList.add("fn__none"),i.classList.add("fn__none")):(s.classList.remove("fn__none"),o.classList.remove("fn__none"),i.classList.remove("fn__none"),e.setAttribute("data-page",t.toString()),t>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),o.setAttribute("disabled","disabled"),fetchPost(`/api/repo/${n}`,{page:t},r=>{a.disabled=!1,t<r.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(r.data.pageCount||1).toString()),l.textContent=`${window.siyuan.languages.pageCountAndSnapshotCount.replace("${x}",r.data.pageCount).replace("${y}",r.data.totalCount||1)}`,l.classList.remove("fn__none"),As(r,e,n)}))},Vl=e=>{e.setAttribute("data-init","true"),fetchPost("/api/history/getNotebookHistory",{},t=>{if(t.data.histories.length===0){e.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";t.data.histories.forEach((n,i)=>{a+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${i===0?" b3-list-item__arrow--open":""}${n.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${n.hCreated}</span>
</li>`,n.items.length>0&&(a+=`<ul class="${i===0?"":"fn__none"}">`,n.items.forEach(s=>{a+=`<li data-type="notebook" data-path="${s.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${escapeHtml(s.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),a+="</ul>")}),e.innerHTML=a})},zd=e=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(s=>{if(s.element.querySelector("#historyContainer"))return s.destroy(),!0}))return;const a=window.siyuan.storage[Constants.LOCAL_HISTORY];let n=`<option value='%' ${a.notebookId==="%"?"selected":""}>${window.siyuan.languages.allNotebooks}</option>`;window.siyuan.notebooks.forEach(s=>{s.closed||(n+=` <option value="${s.id}"${s.id===a.notebookId?" selected":""}>${escapeHtml(s.name)}</option>`)});const i=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" ${isMobile()?"":'style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0"'}>
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpHistoryPage" data-totalpage="1">1</button>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${isMobile()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="0" ${a.type===0?"selected":""}>${window.siyuan.languages.docName}</option>
                        <option value="1" ${a.type===1?"selected":""}>${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2" ${a.type===2?"selected":""}>${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${isMobile()?" fn__size96":""}">
                        <option value="all" ${a.operation==="all"?"selected":""}>${window.siyuan.languages.allOp}</option>
                        <option value="clean" ${a.operation==="clean"?"selected":""}>${window.siyuan.languages.historyClean}</option>
                        <option value="update" ${a.operation==="update"?"selected":""}>${window.siyuan.languages.historyUpdate}</option>
                        <option value="delete" ${a.operation==="delete"?"selected":""}>${window.siyuan.languages.historyDelete}</option>
                        <option value="format" ${a.operation==="format"?"selected":""}>${window.siyuan.languages.historyFormat}</option>
                        <option value="sync" ${a.operation==="sync"?"selected":""}>${window.siyuan.languages.historySync}</option>
                        <option value="replace" ${a.operation==="replace"?"selected":""}>${window.siyuan.languages.historyReplace}</option>
                        <option value="outline" ${a.operation==="outline"?"selected":""}>${window.siyuan.languages.historyOutline}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        ${n}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background history__side" ${isMobile()?"":`style="width: ${a.sideWidth}"`}>
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="history__resize"></div>
                <div class="fn__flex-column fn__flex-1">
                    <div class="protyle-title__input ft__center ft__breakword fn__none"></div>
                    <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                    <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                    <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
                </div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" data-totalpage="1">1</button>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndSnapshotCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(isMobile())openModel({html:i,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(s){s.firstElementChild.setAttribute("style","background-color:var(--b3-theme-background);height:100%"),Ss(e,s.firstElementChild)}});else{const s=new Dialog({content:i,width:"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){wt=void 0}});s.element.setAttribute("data-key",Constants.DIALOG_HISTORY),s.element.querySelector("input").focus(),Ss(e,s.element,s),resizeSide(s.element.querySelector(".history__resize"),s.element.querySelector(".history__side"),"sideWidth")}},Ss=(e,t,a)=>{const n=t.querySelector("#historyContainer [data-type=doc]");n.querySelectorAll(".b3-select").forEach(g=>{g.addEventListener("change",()=>{Pt(n,1)})}),n.querySelector(".b3-text-field").addEventListener("input",g=>{g.isComposing||Pt(n,1)}),n.querySelector(".b3-text-field").addEventListener("compositionend",()=>{Pt(n,1)});const i=n.querySelector('.history__text[data-type="docPanel"]'),s=n.querySelector('.history__text[data-type="assetPanel"]'),o=n.querySelector('.history__text[data-type="mdPanel"]'),l=n.querySelector(".protyle-title__input");Pt(n,1),wt=new Protyle(e,i,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(wt.protyle);const r=t.querySelector('#historyContainer [data-type="repo"]'),c=t.querySelector('#historyContainer [data-type="doc"]'),u=r.querySelector(".b3-select");u.addEventListener("change",()=>{mt(r,1);const g=t.querySelector(".b3-button[data-type='compare']");g.setAttribute("disabled","disabled"),g.removeAttribute("data-ids")}),t.addEventListener("click",g=>{var m;let d=g.target;for(;d&&!d.isEqualNode(t);){const f=d.getAttribute("data-type");if(d.classList.contains("item")){d.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(t.querySelector("#historyContainer").children).forEach(b=>{b.getAttribute("data-type")===f?(b.classList.remove("fn__none"),b.classList.add("fn__block"),d.classList.add("item--focus"),b.getAttribute("data-init")!=="true"&&(f==="notebook"?Vl(b):f==="repo"&&mt(b,1))):(b.classList.add("fn__none"),b.classList.remove("fn__block"))}),g.stopPropagation(),g.preventDefault();break}else if(d.classList.contains("b3-list-item__action")&&f==="rollback"&&!window.siyuan.config.readonly){const b=d.parentElement.getAttribute("data-type");let p=d.previousElementSibling.previousElementSibling.textContent.trim(),y=dayjs(parseInt(d.parentElement.getAttribute("data-created"))*1e3).format("YYYY-MM-DD HH:mm:ss");b==="notebook"?y=d.parentElement.parentElement.previousElementSibling.textContent.trim():b==="repoitem"&&(p=window.siyuan.languages.workspaceData,y=d.parentElement.querySelector("span[data-type='hCreated']").textContent.trim());const _=window.siyuan.languages.rollbackConfirm.replace("${name}",p).replace("${time}",y);confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,_,()=>{b==="assets"?fetchPost("/api/history/rollbackAssetsHistory",{historyPath:d.parentElement.getAttribute("data-path")}):b==="doc"?fetchPost("/api/history/rollbackDocHistory",{notebook:d.parentElement.getAttribute("data-notebook-id"),historyPath:d.parentElement.getAttribute("data-path")}):b==="notebook"?fetchPost("/api/history/rollbackNotebookHistory",{historyPath:d.parentElement.getAttribute("data-path")}):fetchPost("/api/repo/checkoutRepo",{id:d.parentElement.getAttribute("data-id")})}),g.stopPropagation(),g.preventDefault();break}else if(f==="more"){d.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(b=>{b.classList.toggle("fn__none")}),g.stopPropagation(),g.preventDefault();break}else if(f==="toggle"){const b=d.firstElementChild.firstElementChild;if(b.classList.contains("b3-list-item__arrow--open"))d.nextElementSibling.classList.add("fn__none"),b.classList.remove("b3-list-item__arrow--open");else if(d.nextElementSibling&&d.nextElementSibling.tagName==="UL")d.nextElementSibling.classList.remove("fn__none"),b.classList.add("b3-list-item__arrow--open");else{const p=n.querySelector(".b3-text-field"),y=n.querySelector('.b3-select[data-type="opselect"]'),_=n.querySelector('.b3-select[data-type="typeselect"]'),k=n.querySelector('.b3-select[data-type="notebookselect"]'),x=d.getAttribute("data-created");fetchPost("/api/history/getHistoryItems",{notebook:k.value,query:p.value,op:y.value,type:parseInt(_.value),created:x},T=>{b.classList.add("b3-list-item__arrow--open");let w="",v="";T.data.items.forEach(h=>{let E=" b3-chip b3-chip--list ";h.op==="clean"?(E+="b3-chip--primary ",v=window.siyuan.languages.historyClean):h.op==="update"?(E+="b3-chip--info ",v=window.siyuan.languages.historyUpdate):h.op==="delete"?(E+="b3-chip--error ",v=window.siyuan.languages.historyDelete):h.op==="format"?(E+="b3-chip--pink ",v=window.siyuan.languages.historyFormat):h.op==="sync"?(E+="b3-chip--success ",v=window.siyuan.languages.historySync):h.op==="replace"?(E+="b3-chip--secondary ",v=window.siyuan.languages.historyReplace):h.op==="outline"&&(E+="b3-chip--warning ",v=window.siyuan.languages.historyOutline),w+=`<li data-notebook-id="${h.notebook}" data-created="${x}" data-type="${_.value==="2"?"assets":"doc"}" data-path="${h.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 22px">
    <span class="${y.value==="all"?"":"fn__none"}${E}ariaLabel" data-position="6south" aria-label="${v}">${h.op.substring(0,1).toUpperCase()}</span>
    <span class="b3-list-item__text" title="${escapeAttr(h.title)}">${escapeHtml(h.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action ariaLabel" data-type="rollback" data-position="6south" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),d.insertAdjacentHTML("afterend",`<ul>${w}</ul>`)})}g.stopPropagation(),g.preventDefault();break}else if(f==="rmtoggle"){d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),g.stopPropagation(),g.preventDefault();break}else if(d.classList.contains("b3-list-item")&&f==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(u.value)){const b=t.querySelector(".b3-button[data-type='compare']"),p=JSON.parse(b.getAttribute("data-ids")||"[]"),y=d.getAttribute("data-id");if(d.classList.contains("b3-list-item--focus"))d.classList.remove("b3-list-item--focus"),p.forEach((_,k)=>{y===_.id&&p.splice(k,1)});else{for(d.classList.add("b3-list-item--focus");p.length>1;)p[0].id!==y&&((m=d.parentElement.querySelector(`.b3-list-item[data-id="${p.splice(0,1)[0].id}"]`))==null||m.classList.remove("b3-list-item--focus"));p.push({id:y,time:d.querySelector('[data-type="hCreated"]').textContent})}p.length===2?b.removeAttribute("disabled"):b.setAttribute("disabled","disabled"),b.setAttribute("data-ids",JSON.stringify(p)),g.stopPropagation(),g.preventDefault();break}else if(d.classList.contains("b3-list-item")&&(f==="assets"||f==="doc")){const b=d.getAttribute("data-path");if(f==="assets")s.classList.remove("fn__none"),s.innerHTML=renderAssetsPreview(b);else if(f==="doc"){const y=n.querySelector(".b3-text-field").value;fetchPost("/api/history/getDocHistoryContent",{historyPath:b,highlight:!isSupportCSSHL(),k:y},_=>{_.data.isLargeDoc?(o.value=_.data.content,o.classList.remove("fn__none"),i.classList.add("fn__none")):(o.classList.add("fn__none"),i.classList.remove("fn__none"),wt.protyle.options.history.created=d.dataset.created,onGet({data:_,protyle:wt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]}),searchMarkRender(wt.protyle,y.split(" ")))})}l.classList.remove("fn__none"),l.textContent=d.querySelector(".b3-list-item__text").textContent;let p=hasClosestByClassName(d,"b3-list");p&&(p=p.querySelector(".b3-list-item--focus"),p&&p.classList.remove("b3-list-item--focus")),d.classList.add("b3-list-item--focus"),g.stopPropagation(),g.preventDefault();break}else if(f==="genRepo"){const b=new Dialog({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});b.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTMEMO);const p=b.element.querySelector("textarea");p.focus();const y=b.element.querySelectorAll(".b3-button");b.bindInput(p,()=>{y[1].click()}),y[0].addEventListener("click",()=>{b.destroy()}),y[1].addEventListener("click",()=>{fetchPost("/api/repo/createSnapshot",{memo:p.value},()=>{mt(r,1)}),b.destroy()}),g.stopPropagation(),g.preventDefault();break}else if(f==="removeRepoTagSnapshot"||f==="removeCloudRepoTagSnapshot"){const b=d.parentElement.getAttribute("data-tag");confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${b}</i>?`,()=>{fetchPost("/api/repo/"+f,{tag:b},()=>{mt(r,1)})},void 0,!0),g.stopPropagation(),g.preventDefault();break}else if(f==="uploadSnapshot"){fetchPost("/api/repo/uploadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),g.stopPropagation(),g.preventDefault();break}else if(f==="downloadSnapshot"){fetchPost("/api/repo/downloadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),g.stopPropagation(),g.preventDefault();break}else if(f==="genTag"){const b=new Dialog({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${dayjs().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:isMobile()?"92vw":"520px"});b.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTTAG);const p=b.element.querySelector(".b3-text-field");p.select();const y=b.element.querySelectorAll(".b3-button");y[0].addEventListener("click",()=>{b.destroy()}),y[2].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:p.value},()=>{fetchPost("/api/repo/uploadCloudSnapshot",{tag:p.value,id:d.parentElement.getAttribute("data-id")},()=>{mt(r,1)})}),b.destroy()}),y[1].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:p.value},()=>{mt(r,1)}),b.destroy()}),g.stopPropagation(),g.preventDefault();break}else if((f==="previous"||f==="next")&&d.getAttribute("disabled")!=="disabled"){const b=parseInt(r.getAttribute("data-page"));mt(r,f==="previous"?b-1:b+1),g.stopPropagation(),g.preventDefault();break}else if(f==="jumpRepoPage"){const b=parseInt(r.getAttribute("data-page")),p=parseInt(d.getAttribute("data-totalpage")||"1");p>1&&confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",p),`<input class="b3-text-field fn__block" type="number" min="1" max="${p}" value="${b}">`,y=>{const _=y.element.querySelector(".b3-text-field");if(_.value==="")return;let k=parseInt(_.value);k=Math.max(1,Math.min(k,p)),mt(r,k)})}else if(f==="jumpHistoryPage"){const b=parseInt(c.getAttribute("data-page")),p=parseInt(d.getAttribute("data-totalpage")||"1");p>1&&confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",p),`<input class="b3-text-field fn__block" type="number" min="1" max="${p}" value="${b}">`,y=>{const _=y.element.querySelector(".b3-text-field");if(_.value==="")return;let k=parseInt(_.value);k=Math.max(1,Math.min(k,p)),Pt(n,k)})}else if((f==="docprevious"||f==="docnext")&&d.getAttribute("disabled")!=="disabled"){const b=parseInt(n.getAttribute("data-page"));Pt(n,f==="docprevious"?b-1:b+1),g.stopPropagation(),g.preventDefault();break}else if(f==="rebuildIndex"){fetchPost("/api/history/reindexHistory"),a?a.destroy():(closeModel(),wt=void 0),g.stopPropagation(),g.preventDefault();break}else if(f==="compare"&&!d.getAttribute("disabled")){showDiff(e,JSON.parse(d.getAttribute("data-ids")||"[]")),g.stopPropagation(),g.preventDefault();break}d=d.parentElement}})},Kd=e=>{setTitle(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const t=document.getElementById("empty");t.classList.remove("fn__none"),t.innerHTML===""&&(t.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item${isIPhone()||window.siyuan.config.readonly?" fn__none":""}" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.userGuide}</span>
</div>`,t.addEventListener("click",a=>{let n=a.target;for(;n&&!n.isEqualNode(t);){if(n.id==="emptySearch"){popSearch(e),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyRecent"){getRecentDocs(e),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyHistory"){openHistory(e),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyNewFile"){newFile({app:e,useSavePath:!0}),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyNewNotebook"){newNotebook(),a.stopPropagation(),a.preventDefault();break}else if(n.id==="emptyHelp"){mountHelp(),a.stopPropagation(),a.preventDefault();break}n=n.parentElement}}))},Zd=()=>{const e=document.getElementById("toolbarName");setTitle(e.value),e.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},An=null,Gl=e=>{var t;const a=getCurrentEditor().protyle;if((t=a.observerLoad)==null||t.disconnect(),window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],a),a.contentElement.classList.contains("fn__none")&&setEditMode(a,"wysiwyg"),a.notebookId=e.data.notebookId,a.path=e.data.path,e.data.startId===a.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&e.data.endId===a.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){a.contentElement.scrollTo({top:e.scrollTop,behavior:"smooth"});return}e.id!==a.block.rootID&&fetchPost("/api/block/getDocInfo",{id:e.id},i=>{setTitle(i.data.name),a.title.setTitle(i.data.name),a.background.render(i.data.ial,a.block.rootID),a.wysiwyg.renderCustom(i.data.ial)});const n=a.breadcrumb.element.parentElement.querySelector('[data-type="exit-focus"]');if(e.zoomId){e.zoomId!==a.block.id?fetchPost("/api/block/checkBlockExist",{id:e.id},i=>{i.data&&zoomOut({protyle:a,id:e.id,isPushBack:!1,callback:()=>{a.contentElement.scrollTop=e.scrollTop}})}):a.contentElement.scrollTop=e.scrollTop,n.classList.remove("fn__none");return}fetchPost("/api/filetree/getDoc",{id:e.id,startID:e.data.startId,endID:e.data.endId},i=>{a.block.parentID=i.data.parentID,a.block.parent2ID=i.data.parent2ID,a.block.rootID=i.data.rootID,a.block.showAll=!1,a.block.mode=i.data.mode,a.block.blockCount=i.data.blockCount,a.block.id=i.data.id,a.block.action=e.callback,a.wysiwyg.element.setAttribute("data-doc-type",i.data.type),a.wysiwyg.element.innerHTML=i.data.content,processRender(a.wysiwyg.element),highlightRender(a.wysiwyg.element),avRender(a.wysiwyg.element,a),blockRender(a,a.wysiwyg.element,e.scrollTop),i.data.isSyncing?disabledForeverProtyle(a):setReadonlyByConfig(a,!0),a.contentElement.scrollTop=e.scrollTop,setTimeout(()=>{a.contentElement.scrollTop=e.scrollTop},Constants.TIMEOUT_LOAD),a.app.plugins.forEach(s=>{s.eventBus.emit("switch-protyle",{protyle:a}),s.eventBus.emit("loaded-protyle-static",{protyle:a})}),n.classList.add("fn__none")})},zl=()=>{const e=Sn().protyle;e.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:e.block.showAll?e.block.id:e.block.rootID,data:{startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:e.notebookId,path:e.path},scrollTop:e.contentElement.scrollTop,callback:e.block.action,zoomId:e.block.showAll?e.block.id:void 0})},Xd=()=>{const e=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const a=document.getElementById("searchAssetsPanel");!a||a.classList.contains("fn__none")?document.getElementById("model").style.transform="":a.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(e&&!e.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],e.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if((window.JSAndroid||window.JSHarmony)&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid?window.JSAndroid.returnDesktop():window.JSHarmony&&window.JSHarmony.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(An.length===0&&e){const a=e.protyle;An.push({id:a.block.showAll?a.block.id:a.block.rootID,data:{startId:a.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:a.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:a.notebookId,path:a.path},scrollTop:a.contentElement.scrollTop,callback:a.block.action,zoomId:a.block.showAll?a.block.id:void 0})}const t=window.siyuan.backStack.pop();An.push(t),Gl(t)},Jd=(e,t=!1)=>{if(!e.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const a={rootId:e.block.rootID,startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop||parseInt(e.contentElement.getAttribute("data-scrolltop"))||0};let n;if(getSelection().rangeCount>0&&(n=getSelection().getRangeAt(0)),(!n||!e.wysiwyg.element.contains(n.startContainer))&&(n=e.toolbar.range),n&&e.wysiwyg.element.contains(n.startContainer)){const i=hasClosestBlock(n.startContainer);if(i){const s=getSelectionOffset(i,void 0,n);a.focusId=i.getAttribute("data-node-id"),a.focusStart=s.start,a.focusEnd=s.end}}return e.block.showAll&&(a.zoomInId=e.block.id),t?a:(window.siyuan.storage[Constants.LOCAL_FILEPOSITION][e.block.rootID]=a,new Promise(i=>{setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION],()=>{i(!0)})}))},Qd=e=>{var t,a,n,i,s,o,l,r,c,u,g,m,d,f;let b=[];if(e.mergedOptions?b=e.mergedOptions.action:e.focus?b=[Constants.CB_GET_UNUNDO,Constants.CB_GET_FOCUS]:b=[Constants.CB_GET_UNUNDO],(t=e.scrollAttr)!=null&&t.zoomInId&&((a=e.scrollAttr)!=null&&a.rootId)&&e.scrollAttr.zoomInId!==e.scrollAttr.rootId){fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.zoomInId,size:Constants.SIZE_GET_MAX,query:(n=e.protyle.query)==null?void 0:n.key,queryMethod:(i=e.protyle.query)==null?void 0:i.method,queryTypes:(s=e.protyle.query)==null?void 0:s.types,highlight:!isSupportCSSHL()},p=>{var y,_,k,x,T;p.code===1?fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.rootId||((y=e.mergedOptions)==null?void 0:y.blockId)||((_=e.protyle.block)==null?void 0:_.rootID)||e.scrollAttr.startId,query:(k=e.protyle.query)==null?void 0:k.key,queryMethod:(x=e.protyle.query)==null?void 0:x.method,queryTypes:(T=e.protyle.query)==null?void 0:T.types,highlight:!isSupportCSSHL()},w=>{onGet({data:w,protyle:e.protyle,action:b,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(w.data.keywords)}:void 0,updateReadonly:e.updateReadonly})}):(b.push(Constants.CB_GET_ALL),onGet({data:p,protyle:e.protyle,action:b,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(p.data.keywords)}:void 0,updateReadonly:e.updateReadonly}))});return}fetchPost("/api/filetree/getDoc",{id:((o=e.scrollAttr)==null?void 0:o.rootId)||((l=e.mergedOptions)==null?void 0:l.blockId)||((r=e.protyle.block)==null?void 0:r.rootID)||((c=e.scrollAttr)==null?void 0:c.startId),startID:(u=e.scrollAttr)==null?void 0:u.startId,endID:(g=e.scrollAttr)==null?void 0:g.endId,query:(m=e.protyle.query)==null?void 0:m.key,queryMethod:(d=e.protyle.query)==null?void 0:d.method,queryTypes:(f=e.protyle.query)==null?void 0:f.types,highlight:!isSupportCSSHL()},p=>{onGet({data:p,protyle:e.protyle,action:b,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(p.data.keywords)}:void 0,updateReadonly:e.updateReadonly})})},Sn=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,eu=(e,t,a=[Constants.CB_GET_HL])=>{window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]);const n=document.querySelector(".av__panel");if(n&&!n.classList.contains("fn__none")&&n.dispatchEvent(new CustomEvent("click",{detail:"close"})),window.siyuan.mobile.editor){saveScroll(window.siyuan.mobile.editor.protyle),hideElements(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&setEditMode(window.siyuan.mobile.editor.protyle,"wysiwyg");let i;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t}"]`)).find(s=>{if(!isInEmbedBlock(s))return i=s,!0}),i){pushBack(),scrollCenter(window.siyuan.mobile.editor.protyle,i,!0),closePanel(),fetchPost("/api/storage/updateRecentDocViewTime",{rootID:window.siyuan.mobile.editor.protyle.block.rootID});return}}fetchPost("/api/block/getBlockInfo",{id:t},i=>{if(i.code===3){showMessage(i.msg);return}const s={blockId:t,rootId:i.data.rootID,action:a,render:{scroll:!0,title:!0,titleShowTop:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu","yuque"]}};window.siyuan.mobile.editor?(window.siyuan.mobile.editor.protyle.title.element.removeAttribute("data-render"),pushBack(),addLoading(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==i.data.rootID?(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML="",fetchPost("/api/storage/updateRecentDocOpenTime",{rootID:i.data.rootID})):fetchPost("/api/storage/updateRecentDocViewTime",{rootID:i.data.rootID}),a.includes(Constants.CB_GET_SCROLL)&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][i.data.rootID]?getDocByScroll({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][i.data.rootID],mergedOptions:s,cb(){e.plugins.forEach(o=>{o.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}}):fetchPost("/api/filetree/getDoc",{id:t,size:a.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:a.includes(Constants.CB_GET_CONTEXT)?3:0},o=>{onGet({data:o,protyle:window.siyuan.mobile.editor.protyle,action:a,afterCB(){e.plugins.forEach(l=>{l.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}})}),window.siyuan.mobile.editor.protyle.undo.clear()):(fetchPost("/api/storage/updateRecentDocOpenTime",{rootID:i.data.rootID}),window.siyuan.mobile.editor=new Protyle(e,document.getElementById("editor"),s)),setEditor(),closePanel()})},Kl=e=>{let t="",a="";return window.siyuan.mobile.editor&&document.getElementById("empty").classList.contains("fn__none")&&(t=window.siyuan.mobile.editor.protyle.notebookId,e?a=window.siyuan.mobile.editor.protyle.path:a=pathPosix().dirname(window.siyuan.mobile.editor.protyle.path)),t||window.siyuan.notebooks.find(n=>{if(!n.closed)return t=n.id,a="/",!0}),{notebookId:t,currentPath:a}},Zl=e=>{if(getOpenNotebookCount()===0){showMessage(window.siyuan.languages.newFileTip);return}if(!e.notebookId){const t=Kl(e.useSavePath);e.notebookId=t.notebookId,e.currentPath=t.currentPath}fetchPost("/api/filetree/getDocCreateSavePath",{notebook:e.notebookId},t=>{if(e.useSavePath||(t.data.box=e.notebookId),t.data.path.indexOf("/")>-1&&e.useSavePath||e.name)if(t.data.path.startsWith("/")||e.currentPath==="/"){const a=pathPosix().join(t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:a,markdown:"",listDocTree:e.listDocTree},n=>{e.afterCB&&e.afterCB(n.data,pathPosix().basename(a)),openMobileFileById(e.app,n.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})}else fetchPost("/api/filetree/getHPathByPath",{notebook:t.data.box,path:e.notebookId===t.data.box?e.currentPath.endsWith(".sy")?e.currentPath:e.currentPath+".sy":t.data.path||"/"},a=>{const n=pathPosix().join(a.data,t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:n,parentID:getDisplayName(e.currentPath,!0,!0),markdown:"",listDocTree:e.listDocTree},i=>{e.afterCB&&e.afterCB(i.data,pathPosix().basename(n)),openMobileFileById(e.app,i.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})});else{const a=pathPosix().basename(t.data.path||window.siyuan.languages.untitled);if(!validateName(a))return;if(e.notebookId!==t.data.box){const s=pathPosix().join(t.data.path||"/",e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:s,markdown:"",listDocTree:e.listDocTree},o=>{e.afterCB&&e.afterCB(o.data,pathPosix().basename(s)),openMobileFileById(e.app,o.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])});return}const n=Lute.NewNodeID(),i=pathPosix().join(getDisplayName(e.currentPath,!1,!0),n+".sy");e.paths&&(e.paths[e.paths.indexOf(void 0)]=i),fetchPost("/api/filetree/createDoc",{notebook:t.data.box,path:i,title:a,md:"",sorts:e.paths,listDocTree:e.listDocTree},()=>{e.afterCB&&e.afterCB(n,a),openMobileFileById(e.app,n,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})}})},tu=(e,t,a)=>{fetchPost("/api/filetree/getRefCreateSavePath",{notebook:t},n=>{let i=e;t!==n.data.box&&(i=n.data.path||"/"),n.data.path?n.data.path.startsWith("/")?a(getDisplayName(n.data.path,!1,!0),n.data.box):fetchPost("/api/filetree/getHPathByPath",{notebook:n.data.box,path:i},s=>{a(getDisplayName(pathPosix().join(s.data,n.data.path),!1,!0),n.data.box)}):fetchPost("/api/filetree/getHPathByPath",{notebook:n.data.box,path:i},s=>{a(getDisplayName(s.data,!1,!0),n.data.box)})})},au=(e,t)=>{hideElements(["dialog"]),Zl({app:e,useSavePath:!0,name:replaceFileName(t.trim())||window.siyuan.languages.untitled})},nu=(e,t,a,n,i)=>{const s=replaceFileName(t.trim()?t.trim():e.lute.BlockDOM2Content(a.outerHTML).replace(/\n/g,"").trim())||window.siyuan.languages.untitled,o=pathPosix().join(n,s);fetchPost("/api/filetree/getIDsByHPath",{path:o,notebook:i},l=>{const r=s.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen);if(l.data&&l.data.length>0){const c=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${l.data[0]}${Constants.ZWSP}d${Constants.ZWSP}${r}`});c[0]&&e.toolbar.range.selectNodeContents(c[0])}else fetchPost("/api/filetree/createDocWithMd",{notebook:i,path:o,parentID:e.notebookId===i?e.block.rootID:"",markdown:""},c=>{const u=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${c.data}${Constants.ZWSP}d${Constants.ZWSP}${r}`});u[0]&&e.toolbar.range.selectNodeContents(u[0])});hideElements(["toolbar"],e)})},Ln=(e,t,a)=>{t&&(setLastNodeRange(getContenteditableElement(a[a.length-1]),e.toolbar.range),e.toolbar.range.collapse(!0),insertHTML(e.lute.SpinBlockDOM(t),e,!0,!0),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element))},Xl=(e,t)=>{const a=new Dialog({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});a.element.setAttribute("data-key",Constants.DIALOG_AIUPDATECUSTOMACTION);const n=a.element.querySelector("input");n.value=e;const i=a.element.querySelector("textarea"),s=a.element.querySelectorAll(".b3-button");a.bindInput(i,()=>{s[2].click()}),i.value=t,s[1].addEventListener("click",()=>{a.destroy()}),s[2].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find(o=>{if(e===o.name&&t===o.memo)return o.name=n.value,o.memo=i.value,setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),a.destroy()}),s[0].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find((o,l)=>{if(e===o.name&&t===o.memo)return window.siyuan.storage[Constants.LOCAL_AI].splice(l,1),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),a.destroy()}),n.focus()},Ls=(e,t,a)=>{const n=new Dialog({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:isMobile()?"92vw":"520px"});n.element.setAttribute("data-key",Constants.DIALOG_AICUSTOMACTION);const i=n.element.querySelector("input"),s=n.element.querySelector("textarea"),o=n.element.querySelectorAll(".b3-button");n.bindInput(s,()=>{o[1].click()}),o[0].addEventListener("click",()=>{n.destroy()}),o[1].addEventListener("click",()=>{if(!s.value){showMessage(window.siyuan.languages._kernel[142]);return}fetchPost("/api/ai/chatGPTWithAction",{ids:t,action:s.value},l=>{n.destroy(),Ln(e,l.data,a)})}),o[2].addEventListener("click",()=>{if(!i.value&&!s.value){showMessage(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[Constants.LOCAL_AI].push({name:i.value,memo:s.value}),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),n.destroy()}),i.focus()},xs=(e,t)=>{e.querySelectorAll(".b3-list-item").forEach(a=>{a.textContent.indexOf(t.value)>-1?a.classList.remove("fn__none"):a.classList.add("fn__none")}),e.querySelectorAll(".b3-menu__separator").forEach(a=>{t.value?a.classList.add("fn__none"):a.classList.remove("fn__none")}),e.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),e.querySelector(".b3-list-item:not(.fn__none)").classList.add("b3-list-item--focus")},su=(e,t)=>{window.siyuan.menus.menu.remove();const a=[];e.forEach(o=>{a.push(o.getAttribute("data-node-id"))});const n=new Menu(Constants.MENU_AI,()=>{focusByRange(t.toolbar.range)});let i="";window.siyuan.storage[Constants.LOCAL_AI].forEach((o,l)=>{i+=`<div data-action="${escapeAttr(o.memo||o.name)}" data-index="${l}" class="b3-list-item b3-list-item--narrow ariaLabel" aria-label="${escapeAriaLabel(o.memo)}">
    <span class="b3-list-item__text">${escapeHtml(o.name)}</span>
    <span data-type="edit" class="b3-list-item__action"><svg><use xlink:href="#iconEdit"></use></svg></span>
</div>`}),i&&(i=`<div class="b3-menu__separator"></div>${i}`);const s="Clear context";n.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.ai}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
       <div class="b3-list-item b3-list-item--narrow b3-list-item--focus" data-action="Continue writing">
            ${window.siyuan.languages.aiContinueWrite}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiExtractSummary}">
            ${window.siyuan.languages.aiExtractSummary}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiBrainStorm}">
            ${window.siyuan.languages.aiBrainStorm}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiFixGrammarSpell}">
            ${window.siyuan.languages.aiFixGrammarSpell}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${s}">
            ${window.siyuan.languages.clearContext}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-type="custom">
            ${window.siyuan.languages.aiCustomAction}
        </div>
        ${i}
    </div>
</div>`,bind(o){o.setAttribute("style","height: 100%;padding: 0 16px;"),o.querySelectorAll(".b3-menu__separator").forEach(c=>{c.remove()});const l=o.querySelector(".b3-list"),r=o.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;if(upDownHint(l,c)&&c.stopPropagation(),c.key==="Enter"){c.preventDefault(),c.stopPropagation();const g=l.querySelector(".b3-list-item--focus");g.dataset.type==="custom"?(Ls(t,a,e),n.close()):(fetchPost("/api/ai/chatGPTWithAction",{ids:a,action:g.dataset.action},m=>{Ln(t,m.data,e)}),g.dataset.action===s?showMessage(window.siyuan.languages.clearContextSucc):n.close())}}),r.addEventListener("compositionend",()=>{xs(o,r)}),r.addEventListener("input",c=>{c.isComposing||xs(o,r)}),o.addEventListener("click",c=>{let u=c.target;for(;u&&u!==o;){if(u.classList.contains("b3-list-item__action")){const g=window.siyuan.storage[Constants.LOCAL_AI][u.parentElement.dataset.index];Xl(g.name,g.memo),n.close(),c.stopPropagation(),c.preventDefault();break}else if(u.classList.contains("b3-list-item")){u.dataset.type==="custom"?(Ls(t,a,e),n.close()):(fetchPost("/api/ai/chatGPTWithAction",{ids:a,action:u.dataset.action},g=>{Ln(t,g.data,e)}),u.dataset.action===s?showMessage(window.siyuan.languages.clearContextSucc):n.close()),c.stopPropagation(),c.preventDefault();break}u=u.parentElement}})}}),n.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial"),n.fullscreen()},iu=(e,t)=>{const a=new Dialog({title:"\u2728 "+window.siyuan.languages.aiWriting,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),n=a.element.querySelector("textarea"),i=a.element.querySelectorAll(".b3-button");a.bindInput(n,()=>{i[1].click()}),n.focus(),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{let s=n.value;fetchPost("/api/ai/chatGPT",{msg:s},o=>{a.destroy();let l="";o.data&&o.data!==""&&(l=`

`+o.data),s==="Clear context"&&(s=""),fillContent(e,`${s}${l}`,[t])})})};class lu{constructor(t){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",a=>{var n;const i=a.target;if(i.tagName==="INPUT"){a.stopPropagation();return}const s=hasClosestByTag(i,"BUTTON");if(s&&!s.classList.contains("emojis__item")&&!s.classList.contains("emojis__type")){this.fill(decodeURIComponent(s.getAttribute("data-value")),t,!1,this.source==="search"?isNotCtrl(a):isOnlyMeta(a)),a.preventDefault(),a.stopPropagation();return}const o=this.element.querySelector(".emojis__panel"),l=hasClosestByClassName(i,"emojis__type");if(l){const c=o.querySelector(`[data-type="${l.getAttribute("data-type")}"]`);if(c){const u=c.nextElementSibling.getAttribute("data-index");if(u){let g="";window.siyuan.emojis[parseInt(u)].items.forEach(m=>{g+=`<button data-unicode="${m.unicode}" class="emojis__item ariaLabel" aria-label="${getEmojiDesc(m)}">
${unicode2Emoji(m.unicode)}</button>`}),c.nextElementSibling.innerHTML=g,c.nextElementSibling.removeAttribute("data-index")}o.scrollTo({top:c.offsetTop})}return}const r=hasClosestByClassName(i,"emojis__item");if(r){const c=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const u=getSelection().getRangeAt(0);u.endContainer.nodeType!==3?(n=u.endContainer.childNodes[u.endOffset-1])==null||n.remove():u.endContainer.textContent===":"&&(u.endContainer.textContent=""),addEmoji(c);let g;c.indexOf(".")>-1?g=`:${c.split(".")[0]}: `:g=unicode2Emoji(c)+" ",insertHTML(t.lute.SpinBlockDOM(g),t,!1,!0),this.element.classList.add("fn__none")}else this.fill(c,t)}})}render(t){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(t.toolbar.range=getSelection().getRangeAt(0),t.toolbar.range.startContainer.nodeType===3&&t.toolbar.range.startContainer.textContent===""){const s=hasPreviousSibling(t.toolbar.range.startContainer);if(s&&s.nodeType===3){if(s.wholeText!==s.textContent){let o=s.previousSibling;for(;o&&o.nodeType===3;)if(o.textContent==="")o=o.previousSibling,o.nextSibling.remove();else{s.textContent=o.textContent+s.textContent,o.remove();break}}t.toolbar.range.setStart(s,s.textContent.length),t.toolbar.range.collapse(!0)}}const a=getSelectionOffset(t.toolbar.range.startContainer,t.wysiwyg.element).start,n=t.toolbar.range.startContainer.textContent.substring(0,a)||"",i=this.getKey(n,t.options.hint.extend);if(typeof i=="undefined"||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","code")||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const s=hasClosestBlock(t.toolbar.range.startContainer);if(s&&s.getAttribute("data-type")==="NodeHeading"){const o=getSelectionOffset(t.toolbar.range.startContainer,s).start;if(s.textContent.startsWith("#".repeat(o))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),i?this.genEmojiHTML(t,i):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!isMobile()&&this.genHTML(hintSlash(i,t),t,!1,"hint");return}t.options.hint.extend.forEach(s=>{s.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(s.hint(i,t,"hint"),t,!1,"hint")},t.options.hint.delay))})}genLoading(t){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const a=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,a.left,a.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(t,a){a.querySelectorAll('input[type="file"]').forEach(n=>{n.addEventListener("change",i=>{if(i.target.files.length===0)return;const s=getEditorRange(t.wysiwyg.element);this.lastIndex>-1&&s.setStart(s.startContainer,this.lastIndex),s.deleteContents(),uploadFiles(t,i.target.files,i.target),hideElements(["hint","toolbar"],t)})})}getHTMLByData(t){let a='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(a='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),t.forEach((n,i)=>{let s="";(i===1&&t[i].focus||i===0&&(t.length===1||!t[1].focus))&&(s=" b3-list-item--focus"),n.html==="separator"?a+=`<button data-id="${n.id||""}" class="b3-menu__separator"></button>`:a+=`<button data-id="${n.id||""}" style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s}" data-value="${encodeURIComponent(n.value)}">${n.html}</button>`}),`${a}</div>`}genHTML(t,a,n=!1,i){var s;if(this.source=i,t.length===0){(!this.element.querySelector(".fn__loading")||n)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(t),this.element.classList.remove("fn__none"),t[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.source==="av"){const l=hasClosestByClassName(a.toolbar.range.startContainer,"av__cell");if(l){const r=l.getBoundingClientRect();setPosition(this.element,0,0)}}else{const l=getSelectionPosition(a.wysiwyg.element);setPosition(this.element,0,0)}this.element.scrollTop=0;let o=this.element.querySelector(".b3-list-item--focus");for(;isAbnormalItem(o,"b3-list-item");)o.classList.remove("b3-list-item--focus"),o=o.nextElementSibling,o==null||o.classList.add("b3-list-item--focus");if(this.bindUploadEvent(a,this.element),this.source!=="hint"){const l=this.element.querySelector("input.b3-text-field"),r=((s=this.element.querySelector("mark"))==null?void 0:s.textContent)||"";l.value=r,l.select(),l.addEventListener("keydown",u=>{u.key!=="Meta"&&u.key!=="Control"&&u.stopPropagation(),!u.isComposing&&(upDownHint(this.element.lastElementChild,u),u.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),a,!1,isNotCtrl(u)),u.preventDefault()):u.key==="Escape"&&(this.element.classList.add("fn__none"),focusByRange(a.toolbar.range)))});const c=a.toolbar.range?hasClosestBlock(a.toolbar.range.startContainer):!1;l.addEventListener("input",u=>{u.isComposing||(u.stopPropagation(),this.genSearchHTML(a,l,c,r,i))}),l.addEventListener("compositionend",u=>{u.stopPropagation(),this.genSearchHTML(a,l,c,r,i)})}}genSearchHTML(t,a,n,i,s){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',fetchPost("/api/search/searchRefBlock",{k:a.value,id:n?n.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:s==="av"?"":t.block.rootID,isDatabase:s==="av"},o=>{let l="";if(o.data.newDoc){const r=`((newFile "${i}"${Constants.ZWSP}'${o.data.k}${Lute.Caret}'))`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${o.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(r)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${o.data.k}</mark></span></div></button>`}o.data.blocks.forEach((r,c)=>{let u;if(s==="av"){let g=r.name||r.refText.replace(new RegExp(Constants.ZWSP,"g"),"");n&&(g=r.ial["custom-sy-av-s-text-"+n.getAttribute("data-av-id")]||g),u=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${g}</span>`}else u=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${i}</span>`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${c===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(u)}">
${genHintItemHTML(r)}
</button>`}),l===""&&(l=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=l,setPosition(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(t,a=""){if(a&&!this.enableEmoji)return;const n=this.element.querySelector(".emojis__panel");n?(n.innerHTML=filterEmoji(a,256),a?n.nextElementSibling.classList.add("fn__none"):n.nextElementSibling.classList.remove("fn__none"),lazyLoadEmojiImg(n)):(this.element.innerHTML=`<div style="padding:0;max-height:min(402px,40vh);width:366px" class="emojis">
<div class="emojis__panel">${filterEmoji(a,256)}</div>
<div class="fn__flex${a?" fn__none":""}">
    ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",getEmojiTitle(0)],["1f60d",getEmojiTitle(1)],["1f433",getEmojiTitle(2)],["1f96a",getEmojiTitle(3)],["1f3a8",getEmojiTitle(4)],["1f3dd-fe0f",getEmojiTitle(5)],["1f52e",getEmojiTitle(6)],["267e-fe0f",getEmojiTitle(7)],["1f6a9",getEmojiTitle(8)]].map(([s,o],l)=>`<button data-type="${l}" class="emojis__type ariaLabel" aria-label="${o}">${unicode2Emoji(s)}</button>`).join("")}
</div>
</div>`,lazyLoadEmoji(this.element),lazyLoadEmojiImg(this.element));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none");const s=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,s.left,s.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(t,a,n=!0,i=!1){var s;hideElements(["hint","toolbar"],a),n&&this.source!=="av"&&(a.toolbar.range=getEditorRange(a.wysiwyg.element));const o=a.toolbar.range;let l=hasClosestBlock(a.toolbar.range.startContainer);if(!l)return;if(this.source==="av"){let g=hasClosestByClassName(a.toolbar.range.startContainer,"av__cell");if(g||(g=l.querySelector(".av__cell--select")),!g)return;const m=hasClosestByClassName(g,l.getAttribute("data-av-type")==="table"?"av__row":"av__gallery-item");if(!m)return;const d=m.dataset.id,f=l.getAttribute("data-av-id");let b=document.createElement("div");if(b.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),b=b.firstElementChild,t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const p=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),y=p.length===1?p[0]:p[1],_=Lute.NewNodeID();m.dataset.id=_,getSavePath(a.path,a.notebookId,(k,x)=>{fetchPost("/api/filetree/createDocWithMd",{notebook:x,path:pathPosix().join(k,y),parentID:a.notebookId===x?a.block.rootID:"",markdown:"",id:_},()=>{transaction(a,[{action:"replaceAttrViewBlock",avID:f,previousID:d,nextID:_,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:f,previousID:_,nextID:d,isDetached:!0}])})}),updateAttrViewCellAnimation(g,{type:"block",isDetached:!1,block:{content:y,id:_}})}else{const p=b.getAttribute("data-id");m.dataset.id=p,transaction(a,[{action:"replaceAttrViewBlock",avID:f,previousID:d,nextID:p,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:f,previousID:p,nextID:d,isDetached:!0}]),updateAttrViewCellAnimation(g,{type:"block",isDetached:!1,block:{content:b.textContent,id:p}})}return}this.enableExtend=!1;let r="";l&&(r=l.getAttribute("data-node-id"));const c=l.outerHTML,u=Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&u&&o.startContainer.nodeType===3&&o.startContainer.wholeText.indexOf(u)>-1&&o.startContainer.wholeText.indexOf(this.splitChar)>-1){let g=0,m=o.startContainer;for(;m&&g<2;){const d=m.textContent.indexOf(u),f=m.textContent.indexOf(this.splitChar);if(d>-1&&(d<f||f<0)){g=2,o.setEnd(m,d+2);break}const b=m.textContent.indexOf(u.substr(1));if(b>-1&&(g+=1),g===2){o.setEnd(m,b+1);break}m=m.nextSibling}}if(this.lastIndex>-1&&(o.setStart(o.startContainer,this.lastIndex),focusByRange(o)),Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const g=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),m=g.length===1?g[0]:g[1];getSavePath(a.path,a.notebookId,(d,f)=>{fetchPost("/api/filetree/createDocWithMd",{notebook:f,path:pathPosix().join(d,m),parentID:a.notebookId===f?a.block.rootID:"",markdown:""},b=>{a.toolbar.range=o;const p=a.toolbar.setInlineMark(a,"block-ref","range",{type:"id",color:`${b.data}${Constants.ZWSP}${i?"s":"d"}${Constants.ZWSP}${(i?g[0]:m).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`});p[0]&&a.toolbar.range.setEnd(p[0].lastChild,p[0].lastChild.textContent.length),a.toolbar.range.collapse(!1)})});return}if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(t===""){const d=getContenteditableElement(l);d.textContent===""&&(d.innerHTML="<wbr>",focusByWbr(d,o));return}let g=document.createElement("div");if(g.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),g=g.firstElementChild,i){const d=o.toString().replace(this.splitChar,"");d&&(g.setAttribute("data-subtype","s"),g.innerText=d)}else{g.setAttribute("data-subtype","d");const d=g.innerText.split(Constants.ZWSP);d.length===2&&(g.innerText=d[1])}const m=a.toolbar.setInlineMark(a,"block-ref","range",{type:"id",color:`${g.getAttribute("data-id")}${Constants.ZWSP}${g.getAttribute("data-subtype")}${Constants.ZWSP}${g.textContent}`});m[0]&&a.toolbar.range.setEnd(m[0].lastChild,m[0].lastChild.textContent.length),a.toolbar.range.collapse(!1);return}else if(this.splitChar===":"){addEmoji(t);let g;t.indexOf(".")>-1?g=`:${t.split(".")[0]}: `:g=unicode2Emoji(t)+" ",insertHTML(a.lute.SpinBlockDOM(g),a)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(t===""){const g=getContenteditableElement(l);g.textContent===""&&(g.innerHTML="<wbr>",focusByWbr(g,o));return}insertHTML(a.lute.SpinBlockDOM(t),a,!1,isMobile()),blockRender(a,a.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,t==="(("||t==="{{"){t==="(("?hintRef("",a,"hint"):hintEmbed("",a),this.splitChar=t,this.lastIndex=0,o.deleteContents();const g=document.createTextNode(t);o.insertNode(g),o.setEnd(g,t.length),o.collapse(!1),focusByRange(o);return}else if(t===Constants.ZWSP){o.deleteContents(),this.fixImageCursor(o),a.toolbar.showTpl(a,l,o),updateTransaction(a,r,l.outerHTML,c);return}else if(t===Constants.ZWSP+1){o.deleteContents(),this.fixImageCursor(o),a.toolbar.showWidget(a,l,o),updateTransaction(a,r,l.outerHTML,c);return}else if(t===Constants.ZWSP+2){o.deleteContents(),this.fixImageCursor(o),a.toolbar.range=o;const g=getSelectionPosition(l,o);assetMenu(a,{x:g.left,y:g.top+26,w:0,h:26}),updateTransaction(a,r,l.outerHTML,c);return}else if(t===Constants.ZWSP+3){o.deleteContents();return}else if(t===Constants.ZWSP+4){newFile({app:a.app,notebookId:a.notebookId,useSavePath:!0,currentPath:a.path,afterCB:(g,m)=>{insertHTML(`<span data-type="block-ref" data-id="${g}" data-subtype="d">${m}</span>`,a)}});return}else if(t===Constants.ZWSP+6){const g=Lute.NewNodeID();fetchPost("/api/filetree/createDoc",{notebook:a.notebookId,path:pathPosix().join(getDisplayName(a.path,!1,!0),g+".sy"),title:window.siyuan.languages.untitled,md:""},()=>{insertHTML(`<span data-type="block-ref" data-id="${g}" data-subtype="d">${window.siyuan.languages.untitled}</span>`,a),openMobileFileById(a.app,g,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])});return}else if(t===Constants.ZWSP+5){o.deleteContents(),AIChat(a,l);return}else if(Constants.INLINE_TYPE.includes(t)){if(o.deleteContents(),focusByRange(o),["a","block-ref","inline-math","inline-memo","text"].includes(t)){a.toolbar.element.querySelector(`[data-type="${t}"]`).dispatchEvent(new CustomEvent("click"));return}a.toolbar.setInlineMark(a,t,"range");return}else if(t==="emoji"){o.deleteContents(),o.insertNode(document.createTextNode(":")),o.collapse(!1),focusByRange(o),this.genEmojiHTML(a);return}else if(t.startsWith("style")){o.deleteContents(),this.fixImageCursor(o),l.setAttribute("style",t.split(Constants.ZWSP)[1]||""),updateTransaction(a,r,l.outerHTML,c);return}else if(t.startsWith("plugin")){a.app.plugins.find(g=>{const m=t.split(Constants.ZWSP);if(m[1]===g.name)return g.protyleSlash.find(d=>{if(d.id===m[2])return d.callback(a.getInstance(),l),!0}),!0});return}else{o.deleteContents(),t!=="![]()"&&this.fixImageCursor(o);let g=t;t==="```"&&(g=t+(Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(window.siyuan.storage[Constants.LOCAL_CODELANG])?"":window.siyuan.storage[Constants.LOCAL_CODELANG])+Lute.Caret+"\n```");const m=getContenteditableElement(l);if(t==="![]()"){let d="";o.insertNode(document.createElement("wbr")),o.insertNode(document.createTextNode(t)),d=a.lute.SpinBlockDOM(l.outerHTML),l.outerHTML=d,l=a.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),focusByWbr(l,o),updateTransaction(a,r,l.outerHTML,c);let f=o.startContainer.childNodes[o.startOffset-1]||o.startContainer;f&&f.nodeType!==3&&f.classList.contains("img")||(((s=f.previousSibling)==null?void 0:s.nodeType)!==3&&f.previousSibling.classList.contains("img")?f=f.previousSibling:Array.from(l.querySelectorAll(".img")).find(p=>{if(p.querySelector("img").getAttribute("data-src")==="")return f=p,!0}));const b=f.getBoundingClientRect();imgMenu(a,o,f,{clientX:b.left,clientY:b.top});return}else if(m.textContent===""&&l.getAttribute("data-type")==="NodeParagraph"){let d="";t==="<div>"?d=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(m.textContent=g,d=a.lute.SpinBlockDOM(l.outerHTML)),l.outerHTML=d,l=a.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),l.getAttribute("data-type")==="NodeTable"&&(l.querySelectorAll("colgroup col").forEach(f=>{f.style.minWidth="60px"}),d=l.outerHTML),updateTransaction(a,r,d,c)}else{let d=a.lute.SpinBlockDOM(g);t==="<div>"&&(d=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`);const f=l.outerHTML;let b;l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"&&(b=setFold(a,l,!0,!1,!1,!0)),l.insertAdjacentHTML("afterend",d);const p=d.substr(d.indexOf('data-node-id="')+14,22);l=a.wysiwyg.element.querySelector(`[data-node-id="${p}"]`),l.getAttribute("data-type")==="NodeTable"&&l.querySelectorAll("colgroup col").forEach(k=>{k.style.minWidth="60px"});const y=[{data:f,id:r,action:"update"},{data:l.outerHTML,id:p,previousID:r,action:"insert"}],_=[{id:p,action:"delete"},{data:c,id:r,action:"update"}];b&&(y.push(...b.doOperations),_.push(...b.undoOperations)),transaction(a,y,_)}if(t==="<div>"||t==="$$"||t.indexOf("```")>-1&&(t.length>3||l.classList.contains("render-node")))a.toolbar.showRender(a,l),processRender(l);else if(t.startsWith("```"))highlightRender(l);else if(t.startsWith("<iframe")||t.startsWith("<video")||t.startsWith("<audio")){a.gutter.renderMenu(a,l);const d=l.getBoundingClientRect();window.siyuan.menus.menu.popup({x:d.left,y:d.top,isLeft:!0});const f=window.siyuan.menus.menu.element.querySelector('[data-id="assetVideo"], [data-id="assetAudio"], [data-id="assetIFrame"]');f.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(f.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else t==="---"?focusBlock(l):l.classList.contains("av")?avRender(l,a,()=>{const d=l.querySelector(".av__title");d.focus(),o.setStart(d,0),o.collapse(!0),focusByRange(o)}):focusByWbr(l,o)}}select(t,a){var n,i,s,o,l;const r=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!r)return!1;if(t.key==="Enter"){if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;const u=c.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const g=getSelection().getRangeAt(0);g.endContainer.nodeType!==3&&((n=g.endContainer.childNodes[g.endOffset-1])==null||n.remove()),addEmoji(u);let m;u.indexOf(".")>-1?m=`:${u.split(".")[0]}: `:m=unicode2Emoji(u)+" ",insertHTML(a.lute.SpinBlockDOM(m),a),this.element.classList.add("fn__none")}else this.fill(u,a)}else{const c=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));c===Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(c,a,!0,isOnlyMeta(t))}return t.preventDefault(),t.stopPropagation(),!0}if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;let u;if(t.key==="ArrowLeft")c.previousElementSibling?(c.classList.remove("emojis__item--current"),u=c.previousElementSibling):(i=c.parentElement.previousElementSibling)!=null&&i.previousElementSibling&&(c.classList.remove("emojis__item--current"),u=c.parentElement.previousElementSibling.previousElementSibling.lastElementChild);else if(t.key==="ArrowRight")c.nextElementSibling?(c.classList.remove("emojis__item--current"),u=c.nextElementSibling):(s=c.parentElement.nextElementSibling)!=null&&s.nextElementSibling&&(c.classList.remove("emojis__item--current"),u=c.parentElement.nextElementSibling.nextElementSibling.firstElementChild);else if(t.key==="ArrowDown"){if(c.nextElementSibling){c.classList.remove("emojis__item--current");let g=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(u=c;u.nextElementSibling&&g>0;)u=u.nextElementSibling,g--}else{const g=(o=c.parentElement.nextElementSibling)==null?void 0:o.nextElementSibling;g&&(u=g.firstElementChild,c.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}else if(t.key==="ArrowUp"){if(c.previousElementSibling){c.classList.remove("emojis__item--current");let g=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(u=c;u.previousElementSibling&&g>0;)u=u.previousElementSibling,g--}else{const g=(l=c.parentElement.previousElementSibling)==null?void 0:l.previousElementSibling;g&&(u=g.lastElementChild,c.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}if(u){u.classList.add("emojis__item--current");const g=this.element.querySelector(".emojis__panel");if(u.offsetTop-8<g.scrollTop)g.scrollTop=u.offsetTop-8;else{const m=g.nextElementSibling.classList.contains("fn__none")?8:36;u.offsetTop+m-this.element.clientHeight+u.clientHeight>g.scrollTop&&(g.scrollTop=u.offsetTop+m-this.element.clientHeight+u.clientHeight)}}return t.preventDefault(),t.stopPropagation(),!0}else if(t.key==="ArrowDown"||t.key==="ArrowUp")return upDownHint(this.element.firstElementChild,t),t.preventDefault(),t.stopPropagation(),!0;return t.key==="ArrowLeft"||t.key==="ArrowRight"?(hideElements(["hint"],a),!0):!1}fixImageCursor(t){const a=hasPreviousSibling(t.startContainer);a&&a.nodeType!==3&&a.classList.contains("img")&&(hasNextSibling(a)||(t.insertNode(document.createTextNode(Constants.ZWSP)),t.collapse(!1)))}getKey(t,a){const n=this.splitChar,i=this.lastIndex;if(this.lastIndex=-1,this.splitChar="",a.forEach(l=>{let r=t.lastIndexOf(l.key);Constants.BLOCK_HINT_KEYS.includes(l.key)&&r>-1&&t.lastIndexOf(l.key+l.key.substring(0,1))>-1&&(r=Math.min(r,t.lastIndexOf(l.key+l.key.substring(0,1)))),this.lastIndex<r&&(this.splitChar=l.key,this.lastIndex=r)}),this.lastIndex===-1)return;!this.element.classList.contains("fn__none")&&n&&n!==this.splitChar&&(this.splitChar=n,this.lastIndex=i),this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(t.substr(this.lastIndex-1,1))||t.substr(this.lastIndex-1,2)==="::"));const s=t.split(this.splitChar),o=s[s.length-1];if(s.length>1&&o.trimStart()===o&&o.length<Constants.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&t.endsWith("\u3010\u3010\u3011")?"":o}}const ou=(e,t)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const a='<svg><use xlink:href="#iconPlay"></use></svg>',n='<svg><use xlink:href="#iconPause"></use></svg>';let i=document.querySelector(".protyle-speech");if(!i){i=document.createElement("div"),i.className="protyle-speech",document.body.insertAdjacentElement("beforeend",i);const s=()=>{const l=speechSynthesis.getVoices();let r,c;return l.forEach(u=>{u.lang===t.replace("_","-")&&(r=u),u.default&&(c=u)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=s);const o=s();i.onclick=()=>{if(i.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(i.getAttribute("data-text"));l.voice=o,l.onend=()=>{i.className="protyle-speech",speechSynthesis.cancel(),i.innerHTML=a},speechSynthesis.speak(l),i.className="protyle-speech protyle-speech--current",i.innerHTML=n}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),i.innerHTML=n):(speechSynthesis.pause(),i.innerHTML=a));focusByRange(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&i.style.display==="block"&&(i.className="protyle-speech",speechSynthesis.cancel(),i.style.display="none")})}e.addEventListener("mouseup",s=>{const o=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){i.style.display==="block"&&(i.className="protyle-speech",i.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();i.innerHTML=a,i.style.display="block",i.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",i.style.left=s.screenX+2+"px",i.setAttribute("data-text",o)})};var Jl=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class ru{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const a=document.createElement("div");a.className="b3-typography",t.options.classes.preview&&a.classList.add(t.options.classes.preview);const n=t.options.preview.actions,i=document.createElement("div");i.className="protyle-preview__action";const s=[];for(let o=0;o<n.length;o++){const l=n[o];if(typeof l=="object"){s.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":s.push(`<button type="button" class="protyle-preview__action--current" data-type="desktop">${window.siyuan.languages.desktop}</button>`);break;case"tablet":s.push(`<button type="button" data-type="tablet">${window.siyuan.languages.tablet}</button>`);break;case"mobile":s.push(`<button type="button" data-type="mobile">${window.siyuan.languages.mobile}</button>`);break;case"mp-wechat":s.push(`<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToWechatMP}"><svg><use xlink:href="#iconMp"></use></svg></button>`);break;case"zhihu":s.push(`<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToZhihu}"><svg><use xlink:href="#iconZhihu"></use></svg></button>`);break;case"yuque":s.push(`<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToYuque}"><svg><use xlink:href="#iconYuque"></use></svg></button>`);break}}i.innerHTML=s.join(""),this.element.appendChild(i),this.element.appendChild(a),this.element.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){const c=l.getAttribute("href");if(c.startsWith("#")){const u=c.substring(1);a.querySelector('[data-node-id="'+u+'"], [id="'+u+'"]').scrollIntoView(),o.stopPropagation(),o.preventDefault();break}if(isMobile()){openByMobile(c),o.stopPropagation(),o.preventDefault();break}o.stopPropagation(),o.preventDefault(),isLocalPath(c)||window.open(c);break}else if(l.tagName==="IMG"){previewDocImage(o.target.getAttribute("src"),t.block.rootID),o.stopPropagation(),o.preventDefault();break}else if(l.tagName==="BUTTON"){const c=l.getAttribute("data-type"),u=n.find(g=>(g==null?void 0:g.key)===c);u?u.click(c):c==="mp-wechat"||c==="zhihu"||c==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),t,c):c==="desktop"?(a.style.width="",a.style.padding=t.wysiwyg.element.style.padding):c==="tablet"?(a.style.width="1024px",a.style.padding="8px 16px"):(a.style.width="360px",a.style.padding="8px"),c!=="mp-wechat"&&c!=="zhihu"&&c!=="yuque"&&(i.querySelectorAll("button").forEach(g=>{g.classList.remove("protyle-preview__action--current")}),l.classList.add("protyle-preview__action--current"))}l=l.parentElement}const r=hasClosestByAttribute(o.target,"id",void 0);r&&(this.element.querySelectorAll(".protyle-wysiwyg--select").forEach(c=>{c.classList.remove("selected")}),r.classList.add("selected"))}),this.previewElement=a}render(t){var a;if(this.element.style.display==="none")return;if((a=this.element.querySelector('.protyle-preview__action [data-type="desktop"]'))!=null&&a.classList.contains("protyle-preview__action--current")){const i=getPadding(t);this.previewElement.style.padding=`${i.top}px ${i.left}px ${i.bottom}px ${i.right}px`}let n=this.element.querySelector(".fn__loading");n||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),n=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{fetchPost("/api/export/preview",{id:t.block.id||t.options.blockId||t.block.parentID},i=>{const s=t.preview.previewElement.scrollTop;t.preview.previewElement.innerHTML=i.data.html,processRender(t.preview.previewElement),highlightRender(t.preview.previewElement),avRender(t.preview.previewElement,t),speechRender(t.preview.previewElement,t.options.lang),t.preview.previewElement.scrollTop=s,n.remove()})},t.options.preview.delay)}link2online(t){needSubscribe("")||t.querySelectorAll("[href],[src]").forEach(a=>{const n=a.getAttribute("href")||a.getAttribute("src");if(n&&n.startsWith("assets/")){const i=Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+n;a.getAttribute("href")?a.setAttribute("href",i):a.setAttribute("src",i)}})}copyToX(t,a,n){return Jl(this,null,function*(){if(n==="mp-wechat")this.link2online(t),t.querySelectorAll(".katex-html .base").forEach(o=>{o.style.display="initial"}),t.querySelectorAll("mjx-container > svg").forEach(o=>{o.setAttribute("width",parseInt(o.getAttribute("width"))*8+"px")}),t.querySelectorAll("ul, ol").forEach(o=>{Array.from(o.children).forEach(l=>{const r=l.querySelector("ul, ol");r&&l.parentNode.insertBefore(r,l.nextSibling)})}),t.querySelectorAll("li.protyle-task").forEach(o=>{const l=o.querySelector('input[type="checkbox"]');l&&(l.style.opacity="0",l.checked?o.style.setProperty("list-style-type","'\u2705'","important"):o.style.setProperty("list-style-type","'\u25A2'","important"))}),typeof window.MathJax=="undefined"&&(window.MathJax={svg:{fontCache:"none"}}),yield addScriptSync(`${Constants.PROTYLE_CDN}/js/mathjax/tex-svg-full.js`,"protyleMathJaxScript"),yield window.MathJax.startup.promise,t.querySelectorAll('[data-subtype="math"]').forEach(o=>{const l=window.MathJax.tex2svg(Lute.UnEscapeHTMLStr(o.getAttribute("data-content")).trim(),{display:o.tagName==="DIV"});l.querySelector("mjx-assistive-mml").remove(),o.innerHTML=l.outerHTML});else if(n==="zhihu")this.link2online(t),t.querySelectorAll('[data-subtype="math"]').forEach(o=>{o.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${o.getAttribute("data-content")}" style="${o.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),t.querySelectorAll("blockquote").forEach(o=>{const l=[];this.processZHBlockquote(o,l),l.reverse().forEach(r=>{o.insertAdjacentElement("afterend",r)}),o.remove()}),this.processZHTable(t);else if(n==="yuque"){fetchPost("/api/lute/copyStdMarkdown",{id:a.block.id||a.options.blockId||a.block.parentID,assetsDestSpace2Underscore:!0,fillCSSVar:!0,adjustHeadingLevel:!0},o=>{writeText(o.data),showMessage(`${window.siyuan.languages.pasteToYuque}`)});return}t.style.backgroundColor="#fff",t.querySelectorAll("code").forEach(o=>{o.style.backgroundImage="none"}),this.element.append(t),t.insertAdjacentHTML("beforeend","<p>&zwj;</p>");let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0).cloneRange());const s=t.ownerDocument.createRange();s.selectNodeContents(t),focusByRange(s),document.execCommand("copy"),this.element.lastElementChild.remove(),focusByRange(i),n&&showMessage(`${n==="zhihu"?window.siyuan.languages.pasteToZhihu:window.siyuan.languages.pasteToWechatMP}`)})}processZHBlockquote(t,a){Array.from(t.children).forEach(n=>{if(n.tagName==="BLOCKQUOTE")this.processZHBlockquote(n,a);else if(n.tagName!=="P"||n.querySelector("img"))a.push(n);else{const i=a[a.length-1];(!i||i&&i.tagName!=="BLOCKQUOTE")&&a.push(document.createElement("blockquote")),a[a.length-1].append(n)}})}processZHTable(t){t.querySelectorAll("table").forEach(a=>{const n=a.querySelector("thead");if(!n)return;const i=a.querySelector("tbody");i?i.insertAdjacentElement("afterbegin",n.firstElementChild):a.innerHTML=`<tbody>${n.innerHTML}</tbody>`,n.remove()})}}class cu{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(t){if(t.disabled||this.undoStack.length===0)return;const a=this.undoStack.pop();if(this.render(t,a,!1),this.hasUndo=!0,this.redoStack.push(a),t.breadcrumb){const n=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&(this.undoStack.length===0&&n.setAttribute("disabled","true"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').removeAttribute("disabled"))}}redo(t){if(t.disabled||this.redoStack.length===0)return;const a=this.redoStack.pop();if(this.render(t,a,!0),this.undoStack.push(a),t.breadcrumb){const n=t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');n&&(t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]').removeAttribute("disabled"),this.redoStack.length===0&&n.setAttribute("disabled","true"))}}render(t,a,n){var i;hideElements(["hint","gutter"],t),t.wysiwyg.lastHTMLs={},n?(a.doOperations.forEach(s=>{onTransaction(t,s,!0)}),transaction(t,a.doOperations)):(a.undoOperations.forEach(s=>{onTransaction(t,s,!0)}),transaction(t,a.undoOperations)),(i=document.querySelector(".av__panel"))==null||i.remove(),preventScroll(t),scrollCenter(t)}replace(t,a){if(this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1,a.breadcrumb)){const n=a.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');n&&n.setAttribute("disabled","true")}this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=t)}add(t,a,n){if(this.undoStack.push({undoOperations:a,doOperations:t}),this.undoStack.length>Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1),n.breadcrumb){const i=n.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');i&&i.removeAttribute("disabled")}}clear(){this.undoStack=[],this.redoStack=[]}}const Jt=e=>!1;class du{constructor(t){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,titleShowTop:!1,hideTitleOnZoom:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},click:{preventInsetEmptyBlock:!1},hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:hintRef},{key:"\u3010\u3010",hint:hintRef},{key:"\uFF08\uFF08",hint:hintRef},{key:"[[",hint:hintRef},{key:"{{",hint:hintEmbed},{key:"\u300C\u300C",hint:hintEmbed},{key:"\u300C\u300E",hint:hintEmbed},{key:"\u300E\u300C",hint:hintEmbed},{key:"\u300E\u300E",hint:hintEmbed},{key:"#",hint:hintTag},{key:"/",hint:hintSlash},{key:"\u3001",hint:hintSlash},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:Constants.PROTYLE_TOOLBAR,typewriterMode:!1,upload:{max:1024*1024*1024*8,url:Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:a=>a.replace(/[\\/:*?"'<>|\[\]\(\)~!`&{}=#%$]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=t}merge(){var t;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(t=this.options.hint)!=null&&t.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),merge(this.defaultOptions,this.options)}mergeToolbar(t){return toolbarKeyToMenu(t)}}const uu=(e,t)=>{e.element.querySelector(".wysiwygLoading")||(addLoading(e),hideElements(["toolbar"],e),fetchPost(`/api/format/net${t}2LocalAssets`,{id:e.block.rootID},()=>{reloadProtyle(e,!1)}))},fu=(e,t)=>{var a,n;setTimeout(()=>{hideAllElements(["gutter"])},Constants.TIMEOUT_TRANSITION);const i=e.className.includes("fullscreen");if(i?(e.classList.remove("fullscreen"),(a=document.getElementById("drag"))==null||a.classList.remove("fn__hidden")):(e.classList.add("fullscreen"),(n=document.getElementById("drag"))==null||n.classList.add("fn__hidden")),isWindow(),t){i?t.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):t.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const s=hasClosestByClassName(e,"layout--float");s&&(i?(s.setAttribute("data-temp",s.style.transform),s.style.transform="none"):(s.style.transform=s.getAttribute("data-temp"),s.removeAttribute("data-temp")));return}},gu=(e,t)=>{if(!window.siyuan.config.readonly){const a=e.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?a?enableProtyle(t):disabledProtyle(t):fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:a?"false":"true"}})}};var Ql=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const mu=(e,t,a)=>{if(matchHotKey(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,t))return net2LocalAssets(e,"Img"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,t))return net2LocalAssets(e,"Assets"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,t))return fetchPost("/api/format/autoSpace",{id:e.block.rootID}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyHPath.custom,t))return fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},n=>{writeText(n.data)}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(i=>i.getAttribute("data-node-id")),"protocolMd")}else copyTextByType([e.block.rootID],"protocolMd");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyID.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(i=>i.getAttribute("data-node-id")),"id")}else copyTextByType([e.block.rootID],"id");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocol.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(i=>i.getAttribute("data-node-id")),"protocol")}else copyTextByType([e.block.rootID],"protocol");return t.preventDefault(),t.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,t)){if(a){const n=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));n.length===0&&n.push(a),copyTextByType(n.map(i=>i.getAttribute("data-node-id")),"blockEmbed")}else copyTextByType([e.block.rootID],"blockEmbed");return t.preventDefault(),t.stopPropagation(),!0}},pu=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const i=hasClosestByTag(e.range.startContainer,"TD")||hasClosestByTag(e.range.startContainer,"TH")||getContenteditableElement(e.nodeElement)||e.nodeElement,s=getSelectionOffset(i,e.editorElement,e.range).start,o=i.innerText,l=matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,e.event);if(!(!isMac()&&l)){if(s>0){o.substr(0,s).indexOf(`
`)===-1&&e.range.getBoundingClientRect().top-i.getBoundingClientRect().top-parseInt(getComputedStyle(i).paddingTop)<14&&(setFirstNodeRange(i,e.range),e.event.preventDefault());return}}}e.range.collapse(!0),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const a=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(n=>{a.push(n.getAttribute("data-node-id"))}),countBlockWord(a,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},bu=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const n=hasClosestByTag(e.range.startContainer,"TD")||hasClosestByTag(e.range.startContainer,"TH"),i=n||getContenteditableElement(e.nodeElement)||e.nodeElement,s=getSelectionOffset(i,e.editorElement,e.range).end,o=i.innerText,l=matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,e.event);if(!(!isMac()&&l)){if(s<o.length){!getNextBlock(e.nodeElement)&&o.trimRight().substr(s).indexOf(`
`)===-1&&i.getBoundingClientRect().bottom-e.range.getBoundingClientRect().bottom-parseInt(getComputedStyle(i).paddingBottom)<14?(setLastNodeRange(i,e.range,!1),e.nodeElement.classList.contains("code-block")&&l&&e.event.preventDefault()):n&&(setLastNodeRange(n,e.range,!1),e.event.preventDefault());return}}}e.range.collapse(!1),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const a=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(n=>{a.push(n.getAttribute("data-node-id"))}),countBlockWord(a,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},yu=e=>{let t,a;return e.forEach(n=>{n.getAttribute("select-start")&&(t=n),n.getAttribute("select-end")&&(a=n)}),t||(t=e[0],t.setAttribute("select-start","true")),a||(a=e[e.length-1],a.setAttribute("select-end","true")),{startElement:t,endElement:a}},hu=(e,t)=>Ql(void 0,null,function*(){var a;let n;const i=[],s=[];let o,l=e[e.length-1],r=!0;l.classList.contains("li")&&(l.getAttribute("data-subtype")==="o"&&(o=parseInt(l.getAttribute("data-marker"),10)),e.find(g=>{if(!g.classList.contains("li")||l.getAttribute("data-subtype")!==g.getAttribute("data-subtype"))return r=!1,!0}),r||(l=hasTopClosestByClassName(l,"list")||l));let c="";const u=[];for(let g=e.length-1;g>=0;--g){const m=e[g];m.classList.remove("protyle-wysiwyg--select");let d=m.cloneNode(!0);const f=Lute.NewNodeID();if(m.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&m.querySelector('[data-type="NodeHeading"][fold="1"]')){const b=yield fetchSyncPost("/api/block/getBlockDOM",{id:m.getAttribute("data-node-id")}),p=document.createElement("template");p.innerHTML=b.data.dom,d=p.content.firstElementChild}if(m.getAttribute("data-type")==="NodeListItem"&&!r)if(c||(c=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`),c=removeEmbed(m)+c,g===0||e[g-1].getAttribute("data-type")!=="NodeListItem"||e[g-1].getAttribute("data-subtype")!==m.getAttribute("data-subtype")){const b=document.createElement("template");b.innerHTML=`<div data-subtype="${m.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${c}`,d=b.content.firstElementChild,c=""}else continue;if(g===e.length-1&&(n=d),d.setAttribute("data-node-id",f),d.removeAttribute(Constants.CUSTOM_RIFF_DECKS),d.classList.remove("protyle-wysiwyg--hl"),d.setAttribute("updated",f.split("-")[0]),d.removeAttribute("refcount"),(a=d.lastElementChild.querySelector(".protyle-attr--refcount"))==null||a.remove(),d.querySelectorAll("[data-node-id]").forEach(b=>{var p;const y=Lute.NewNodeID();b.setAttribute("data-node-id",y),b.removeAttribute(Constants.CUSTOM_RIFF_DECKS),b.classList.remove("protyle-wysiwyg--hl"),b.setAttribute("updated",y.split("-")[0]),b.removeAttribute("refcount"),(p=b.lastElementChild.querySelector(".protyle-attr--refcount"))==null||p.remove()}),typeof o=="number"){const b=o+g+1;d.setAttribute("data-marker",b+"."),d.querySelector(".protyle-action--order").textContent=b+"."}if(l.after(processClonePHElement(d)),i.push({action:"insert",data:d.outerHTML,id:f,previousID:l.getAttribute("data-node-id")}),s.push({action:"delete",id:f}),m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1"){u.push({oldId:m.getAttribute("data-node-id"),newId:f});const b=yield fetchSyncPost("/api/block/getHeadingChildrenDOM",{id:m.getAttribute("data-node-id")}),p=document.createElement("template");p.innerHTML=b.data,Array.from(p.content.children).reverse().forEach((y,_)=>{if(_===p.content.children.length-1)return;y.querySelectorAll("[data-node-id]").forEach(x=>{x.setAttribute("data-node-id",Lute.NewNodeID()),x.removeAttribute(Constants.CUSTOM_RIFF_DECKS),x.removeAttribute("refcount")});const k=Lute.NewNodeID();y.setAttribute("data-node-id",k),y.removeAttribute(Constants.CUSTOM_RIFF_DECKS),y.removeAttribute("refcount"),i.push({context:{ignoreProcess:"true"},action:"insert",data:y.outerHTML,id:k,previousID:f}),s.push({action:"delete",id:k})})}}if(t.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(g=>{g.remove()}),typeof o=="number"){let g=n.nextElementSibling;for(o=o+e.length;g&&g.getAttribute("data-subtype")==="o";){o++;const m=g.getAttribute("data-node-id");s.push({action:"update",id:m,data:g.outerHTML}),g.setAttribute("data-marker",o+"."),g.querySelector(".protyle-action--order").textContent=o+".",i.push({action:"update",data:g.outerHTML,id:m}),g=g.nextElementSibling}}transaction(t,i,s),focusBlock(n),scrollCenter(t)}),_u=e=>{e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.options.backlinkData?(focusBlock(e.wysiwyg.element.firstElementChild),e.contentElement.scrollTop=0,e.scroll.lastScrollTop=1):fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS]})})},wu=e=>{!e.scroll.element.classList.contains("fn__none")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS],afterCB(){focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1)}})}):(e.contentElement.scrollTop=e.contentElement.scrollHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop,focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1))},vu=(e,t,a,n,i)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),a.forEach(s=>{s.style.minWidth="calc(100% - 0.1em)"}),updateTransaction(e,n,t.outerHTML,i)},Eu=(e,t,a,n,i)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),a.forEach(s=>{s.removeAttribute("style")}),updateTransaction(e,n,t.outerHTML,i)};class ku{constructor(t){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),this.parentElement.innerHTML=`<div class="protyle-scroll__up ariaLabel" data-position="north" aria-label="${updateHotkeyTip("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar ariaLabel" data-position="2west" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="protyle-scroll__down ariaLabel" aria-label="${updateHotkeyTip("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,t.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`),showTooltip(this.element.getAttribute("aria-label"),this.element)}),this.inputElement.addEventListener("change",()=>{this.setIndex(t)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(t)}),this.parentElement.addEventListener("click",a=>{const n=a.target;hasClosestByClassName(n,"protyle-scroll__up")?goHome(t):hasClosestByClassName(n,"protyle-scroll__down")?goEnd(t):n.classList.contains("b3-slider")&&this.setIndex(t)}),this.parentElement.addEventListener("mousewheel",a=>{a.deltaY!==0&&t.scroll.lastScrollTop!==-1&&(t.contentElement.scrollTop+=a.deltaY)},{passive:!0})}setIndex(t){t.wysiwyg.element.getAttribute("data-top")||(t.wysiwyg.element.setAttribute("data-top",t.wysiwyg.element.scrollTop.toString()),t.contentElement.style.overflow="hidden",fetchPost("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:t.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{onGet({data:a,protyle:t,action:[Constants.CB_GET_FOCUSFIRST,Constants.CB_GET_UNCHANGEID],afterCB:()=>{setTimeout(()=>{t.contentElement.style.overflow=""},Constants.TIMEOUT_INPUT),showTooltip(this.element.getAttribute("aria-label"),this.element)}})}))}updateIndex(t,a,n){fetchPost("/api/block/getBlockIndex",{id:a},i=>{if(!i.data)return;const s=t.scroll.element.querySelector(".b3-slider");s.value=i.data,t.scroll.element.setAttribute("aria-label",`Blocks ${i.data}/${t.block.blockCount}`),n&&n(i.data)})}update(t){typeof t.block.blockCount=="number"&&(this.inputElement.setAttribute("max",t.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`)),t.block.showAll?this.element.classList.add("fn__none"):t.block.scroll&&!t.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class Cu{constructor(t){this.app=t.app,t.msgCallback&&this.connect(t)}connect(t){const a=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,n=new WebSocket(`${a}?app=${Constants.SIYUAN_APPID}&id=${t.id}${t.type?"&type="+t.type:""}`);n.onopen=()=>{t.callback&&t.callback.call(this),document.getElementById("errorLog")&&(reloadSync(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(s=>{if(s.element.id==="errorLog")return s.destroy(),!0}))},n.onmessage=i=>{if(t.msgCallback){const s=processMessage(JSON.parse(i.data));t.msgCallback.call(this,s)}},n.onclose=i=>{0<=i.reason.indexOf("unauthenticated")||0>i.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",i),setTimeout(()=>{this.connect({id:t.id,type:t.type,msgCallback:t.msgCallback})},3e3))},n.onerror=i=>{i.target.url.endsWith("&type=main")&&i.target.readyState===3&&kernelError()},this.ws=n}send(t,a,n=!1){this.ws&&(this.reqId=n?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:t,reqId:this.reqId,param:a})))}}var wa=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const eo=e=>{const t=e.dataset.type;let a="";if(["NodeHeading","NodeParagraph"].includes(t))a=getContenteditableElement(e).innerHTML;else if(t==="NodeHTMLBlock")a="HTML";else if(t==="NodeAttributeView")a=e.querySelector(".av__title").textContent||window.siyuan.languages.database;else if(t==="NodeThematicBreak")a=window.siyuan.languages.line;else if(t==="NodeIFrame")a="IFrame";else if(t==="NodeWidget")a=window.siyuan.languages.widget;else if(t==="NodeVideo")a=window.siyuan.languages.video;else if(t==="NodeAudio")a=window.siyuan.languages.audio;else if(["NodeCodeBlock","NodeTable"].includes(t))a=Ts(e);else if(e.classList.contains("render-node"))a+=e.dataset.subtype||Lute.UnEscapeHTMLStr(e.getAttribute("data-content"));else if(["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(t)&&(Array.from(e.querySelectorAll("[data-node-id]")).find(n=>{if(!["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(n.getAttribute("data-type")))return a=eo(e.querySelector("[data-node-id]")),!0}),a))return a;return a+` <span data-type="block-ref" data-subtype="s" data-id="${e.getAttribute("data-node-id")}">*</span>`},Ts=(e,t=!1)=>{let a="";const n=e.dataset.type;return n==="NodeHTMLBlock"?a+=Lute.UnEscapeHTMLStr(e.querySelector("protyle-html").getAttribute("data-content")):n==="NodeAttributeView"?(e.querySelectorAll(".av__row").forEach(i=>{i.querySelectorAll(".av__cell").forEach(s=>{a+=getCellText(s)+" "}),a+=`
`}),a=a.trimEnd()):n==="NodeThematicBreak"?a+="---":n==="NodeIFrame"||n==="NodeWidget"?a+=e.querySelector("iframe").getAttribute("src"):n==="NodeVideo"?a+=e.querySelector("video").getAttribute("src"):n==="NodeAudio"?a+=e.querySelector("audio").getAttribute("src"):e.classList.contains("render-node")?a+=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")):["NodeHeading","NodeParagraph","NodeCodeBlock"].includes(n)?a+=e.querySelector("[spellcheck]").textContent:n==="NodeTable"?(e.querySelectorAll("th, td").forEach(i=>{a+=i.textContent.trim()+"	",i.nextElementSibling||(a=a.slice(0,-1)+`
`)}),a=a.slice(0,-1)):!t&&["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(n)&&e.querySelectorAll("[data-node-id]").forEach(i=>{const s=Ts(i,!0);a+=s?s+`
`:""}),a},Au=(e,t)=>wa(void 0,null,function*(){try{let a=(yield readText())||"";a=a.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),a=a.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|").replace(/\./g,"\\."),so(e,{textPlain:a,textHTML:"",target:t})}catch(a){console.log(a)}}),Su=e=>wa(void 0,null,function*(){if([].length===0){let a=(yield readText())||"";if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);if(hasClosestByAttribute(i.startContainer,"data-type","code")||hasClosestByClassName(i.startContainer,"hljs")){insertHTML(a.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}}a=a.replace(/<sub>/g,"__@sub@__").replace(/<\/sub>/g,"__@/sub@__"),a=a.replace(/<sup>/g,"__@sup@__").replace(/<\/sup>/g,"__@/sup@__"),a=a.replace(/<kbd>/g,"__@kbd@__").replace(/<\/kbd>/g,"__@/kbd@__"),a=a.replace(/<u>/g,"__@u@__").replace(/<\/u>/g,"__@/u@__"),a=a.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),a=a.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),a=a.replace(/__@sub@__/g,"<sub>").replace(/__@\/sub@__/g,"</sub>"),a=a.replace(/__@sup@__/g,"<sup>").replace(/__@\/sup@__/g,"</sup>"),a=a.replace(/__@kbd@__/g,"<kbd>").replace(/__@\/kbd@__/g,"</kbd>"),a=a.replace(/__@u@__/g,"<u>").replace(/__@\/u@__/g,"</u>"),to(e);const n=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(a));ao(e),insertHTML(n,e,!1,!1,!0)}}),to=e=>{e.lute.SetInlineAsterisk(!0),e.lute.SetGFMStrikethrough(!0),e.lute.SetInlineMath(!0),e.lute.SetSub(!0),e.lute.SetSup(!0),e.lute.SetTag(!0),e.lute.SetInlineUnderscore(!0)},ao=e=>{e.lute.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.lute.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.lute.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.lute.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.lute.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.lute.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.lute.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.lute.SetMark(window.siyuan.config.editor.markdown.inlineMark)},no=(e,t)=>wa(void 0,null,function*(){if(e&&e.app&&e.app.plugins)for(let a=0;a<e.app.plugins.length;a++){const n=yield new Promise(i=>{e.app.plugins[a].eventBus.emit("paste",{protyle:e,resolve:i,textHTML:"",textPlain:"",siyuanHTML:"",files:t})&&i(void 0)});n!=null&&n.files&&(t=n.files)}uploadLocalFiles(t,e,!0)}),so=(e,t)=>wa(void 0,null,function*(){var a;("clipboardData"in t||"dataTransfer"in t)&&(t.stopPropagation(),t.preventDefault());let n,i,s,o;if("clipboardData"in t)n=t.clipboardData.getData("text/html"),i=t.clipboardData.getData("text/plain"),s=t.clipboardData.getData("text/siyuan"),o=t.clipboardData.files;else if("dataTransfer"in t)n=t.dataTransfer.getData("text/html"),i=t.dataTransfer.getData("text/plain"),s=t.dataTransfer.getData("text/siyuan"),t.dataTransfer.types[0]==="Files"&&(o=t.dataTransfer.items);else{if(((a=t.localFiles)==null?void 0:a.length)>0){no(e,t.localFiles);return}n=t.textHTML,i=t.textPlain,s=t.siyuanHTML,o=t.files}if(i=i.replace(/\r\n|\r|\u2028|\u2029/g,`
`),(n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${i}">${i}</a>`||n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${i}">${i}</a><!--EndFragment-->`)&&(n=""),i.endsWith(Constants.ZWSP)&&!n&&!s&&(s=i.substr(0,i.length-1)),n&&i&&!s){const g=getTextSiyuanFromTextHTML(n);s=g.textSiyuan,n=g.textHtml}if(!s){const g=new DOMParser().parseFromString(n,"text/html");g.body&&g.body.innerHTML&&(n=g.body.innerHTML),n.startsWith(`
<!--StartFragment-->`)&&n.endsWith(`<!--EndFragment-->

`)&&(n=g.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),n=Lute.Sanitize(n)}if(e&&e.app&&e.app.plugins)for(let g=0;g<e.app.plugins.length;g++){const m=yield new Promise(d=>{e.app.plugins[g].eventBus.emit("paste",{protyle:e,resolve:d,textHTML:n,textPlain:i,siyuanHTML:s,files:o})&&d(void 0)});m!=null&&m.textHTML&&(n=m.textHTML),m!=null&&m.textPlain&&(i=m.textPlain),m!=null&&m.siyuanHTML&&(s=m.siyuanHTML),m!=null&&m.files&&(o=m.files)}const l=hasClosestBlock(t.target);if(!l){o&&o.length>0&&uploadFiles(e,o);return}e.hint.enableExtend=Constants.BLOCK_HINT_KEYS.includes(e.hint.splitChar),hideElements(e.hint.enableExtend?["select"]:["select","hint"],e),e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(g=>{g.classList.remove("protyle-wysiwyg--hl")});const r=processPasteCode(n,i,e),c=getEditorRange(e.wysiwyg.element);if(l.getAttribute("data-type")==="NodeCodeBlock"||e.toolbar.getCurrentType(c).includes("code")){insertHTML(i.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}else if(s){const g=document.createElement("div");if(g.innerHTML=s,c.toString()){let f=[],b;if(g.childNodes.length===1&&g.childElementCount===1&&(f=(g.firstElementChild.getAttribute("data-type")||"").split(" "),(f.includes("block-ref")||f.includes("a"))&&(b=g.firstElementChild)),!b){const p=document.createElement("template");p.innerHTML=e.lute.SpinBlockDOM(s),p.content.firstChild.nodeType!==3&&p.content.firstElementChild.classList.contains("p")&&(p.innerHTML=p.content.firstElementChild.firstElementChild.innerHTML.trim()),p.content.childNodes.length===1&&p.content.childElementCount===1&&(f=(p.content.firstElementChild.getAttribute("data-type")||"").split(" "),(f.includes("block-ref")||f.includes("a"))&&(b=p.content.firstElementChild))}if(f.includes("block-ref")){const p=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${b.dataset.id}${Constants.ZWSP}s${Constants.ZWSP}${c.toString()}`});p[0]&&e.toolbar.range.selectNodeContents(p[0]);return}if(f.includes("a")){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:`${b.dataset.href}${Constants.ZWSP}${c.toString()}`});return}}let m=!1;g.querySelectorAll("[data-node-id]").forEach(f=>{const b=Lute.NewNodeID();f.setAttribute("data-node-id",b),f.removeAttribute(Constants.CUSTOM_RIFF_DECKS),f.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),f.setAttribute("updated",b.split("-")[0]),f.removeAttribute("refcount"),m=!0}),l.classList.contains("table")&&(m=!1),g.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(f=>{f.setAttribute("contenteditable","true")});let d=g.innerHTML;if(!l.classList.contains("av")&&d.startsWith("[[{")&&d.endsWith("}]]"))try{const f=JSON.parse(d);f.length>0&&f[0].length>0&&f[0][0].id&&f[0][0].type?insertHTML(i,e,m):insertHTML(d,e,m)}catch(f){insertHTML(d,e,m)}else-1<d.indexOf("NodeHTMLBlock")&&(d=Lute.UnEscapeHTMLStr(d)),d=d.replace(/\u200D```/g,"```"),insertHTML(d,e,m,!1,!0);blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}else if(r)r.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(insertHTML(r,e,!0,!1,!0),highlightRender(e.wysiwyg.element)):insertHTML(r,e),hideElements(["hint"],e);else{let g=!1;if(n.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""){n=n.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),o&&o.length===1&&(n.startsWith("<img")||n.startsWith("<table")&&n.indexOf("<img")>-1)?g=!1:g=!0;const m=n.toLowerCase();i&&i.trim()!==""&&(n.startsWith("<span")||n.startsWith("<br"))&&0>m.indexOf('class="katex')&&0>m.indexOf('class="math')&&0>m.indexOf("</a>")&&0>m.indexOf("</img>")&&0>m.indexOf("</code>")&&0>m.indexOf("</b>")&&0>m.indexOf("</strong>")&&0>m.indexOf("</i>")&&0>m.indexOf("</em>")&&0>m.indexOf("</ol>")&&0>m.indexOf("</ul>")&&0>m.indexOf("</table>")&&0>m.indexOf("</blockquote>")&&0>m.indexOf("</h1>")&&0>m.indexOf("</h2>")&&0>m.indexOf("</h3>")&&0>m.indexOf("</h4>")&&0>m.indexOf("</h5>")&&0>m.indexOf("</h6>")&&(g=!1)}if(g){const m=document.createElement("div");m.innerHTML=n,m.querySelectorAll("[style]").forEach(f=>{f.removeAttribute("style")}),m.querySelectorAll("a").forEach(f=>{f.innerHTML.trim()===""&&f.remove()});let d;if(m.childElementCount===1&&m.childNodes.length===1&&(m.firstElementChild.tagName==="A"?d=m.firstElementChild:m.firstElementChild.tagName==="P"&&m.firstElementChild.childElementCount===1&&m.firstElementChild.childNodes.length===1&&m.firstElementChild.firstElementChild.tagName==="A"&&(d=m.firstElementChild.firstElementChild)),d){const f=c.toString(),b=e.toolbar.setInlineMark(e,"a","range",{type:"a",color:`${d.getAttribute("href")}${Constants.ZWSP}${f||d.textContent}`});f||(b[0].lastChild&&c.setEnd(b[0].lastChild,b[0].lastChild.textContent.length),c.collapse(!1));return}fetchPost("/api/lute/html2BlockDOM",{dom:m.innerHTML},f=>{insertHTML(f.data,e,!1,!1,!0),e.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(b=>{b.textContent===""&&fetchPost("/api/block/getRefText",{id:b.getAttribute("data-id")},p=>{b.innerHTML=p.data})}),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),scrollCenter(e,void 0,!1,"smooth")});return}else if(o&&o.length>0){uploadFiles(e,o);return}else if(i.trim()!==""&&(o&&o.length===0||!o)){if(c.toString()!==""){const d=i.split(`
`)[0];if(isDynamicRef(i)){const f=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${i.substring(2,24)}${Constants.ZWSP}s${Constants.ZWSP}${c.toString()}`});f[0]&&e.toolbar.range.selectNodeContents(f[0]);return}else if(isFileAnnotation(d)){e.toolbar.setInlineMark(e,"file-annotation-ref","range",{type:"file-annotation-ref",color:d.substring(2).replace(/ ".+">>$/,"")});return}else{const f=i.startsWith("assets/")?i:e.lute.GetLinkDest(i);if(f){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:f});return}}}i=i.replace(/\u200D```/g,"```");const m=e.lute.Md2BlockDOM(i);insertHTML(m,e,!1,!1,!0)}blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}const u=l.querySelector(".av__cell--select");l.classList.contains("av")&&u?cellScrollIntoView(l,u):scrollCenter(e,void 0,!1,"smooth")}),Lu=(e,t)=>{e.includes("cell")&&t.querySelectorAll(".av__cell--select, .av__cell--active").forEach(a=>{var n;(n=a.querySelector(".av__drag-fill"))==null||n.remove(),a.classList.remove("av__cell--select","av__cell--active")}),e.includes("row")&&t.querySelectorAll(".av__row--select").forEach(a=>{a.classList.remove("av__row--select"),a.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(a)}),e.includes("galleryItem")&&t.querySelectorAll(".av__gallery-item--select").forEach(a=>{a.classList.remove("av__gallery-item--select")}),e.includes("av")&&t.querySelectorAll(" .av__cell--select, .av__cell--active, .av__row--select, .av__gallery-item--select").forEach(a=>{var n;a.classList.contains("av__row--select")?(a.classList.remove("av__row--select"),a.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(a)):((n=a.querySelector(".av__drag-fill"))==null||n.remove(),a.classList.remove("av__cell--select","av__cell--active","av__gallery-item--select"))}),e.includes("img")&&t.querySelectorAll(".img--select").forEach(a=>{a.classList.remove("img--select")})},xu=e=>{var t,a,n;e.blockElement.querySelector('[data-type="av-search"]').value="";const i=e.groupID?`.av__body[data-group-id="${e.groupID}"] `:"";let s=e.previousId?e.blockElement.querySelector(i+`.av__gallery-item[data-id="${e.previousId}"]`):e.blockElement.querySelector(i+".av__gallery-item");e.blockElement.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(s=e.blockElement.querySelector(i+".av__gallery-add").previousElementSibling);const l=e.blockElement.querySelector(`.av__body[data-group-id="${e.groupID}"] `);if(l&&["updated","created"].includes(l.getAttribute("data-dtype"))&&l.getAttribute("data-content")!=="_@today@_"&&(s=(t=e.blockElement.querySelector('.av__body[data-content="_@today@_"] .av__gallery-add'))==null?void 0:t.previousElementSibling,!s))return;let r="";s==null||s.querySelectorAll(".av__cell").forEach(g=>{var m;let d=1;const f=getTypeByCellElement(g);if(f==="lineNumber"){const p=(m=g.querySelector(".av__celltext"))==null?void 0:m.getAttribute("data-value");p&&(d=parseInt(p))}const b=`<div class="av__cell${f==="checkbox"?" av__cell-uncheck":""}" 
data-field-id="${g.dataset.fieldId}" 
data-wrap="${g.dataset.wrap}" 
data-dtype="${g.dataset.dtype}" 
${f==="block"?' data-detached="true"':""}>${renderCell(genCellValue(f,null),d,!1,"gallery")}</div>`;g.previousElementSibling.classList.contains("av__gallery-name")?r+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${g.parentElement.dataset.empty}">
    ${g.previousElementSibling.outerHTML}
    ${b}
</div>`:r+=`<div class="av__gallery-field" data-empty="${g.parentElement.dataset.empty}">
    ${g.previousElementSibling.outerHTML}
    ${b}
</div>`}),clearSelect(["galleryItem"],e.blockElement);let c="";const u=((a=s==null?void 0:s.querySelector(".av__gallery-cover"))==null?void 0:a.className)||"fn__none";e.srcIDs.forEach(()=>{c+=`<div class="av__gallery-item" data-type="ghost">
    <div class="${u}"><span style="width: 100%;height: 100%;border-radius: var(--b3-border-radius) var(--b3-border-radius) 0 0;" class="av__pulse"></span></div>
    <div class="av__gallery-fields">${r}</div>
</div>`}),s?s.insertAdjacentHTML("afterend",c):(n=e.blockElement.querySelector(i+".av__gallery"))==null||n.insertAdjacentHTML("afterbegin",c),fetchPost("/api/av/getAttributeViewAddingBlockDefaultValues",{avID:e.blockElement.getAttribute("data-av-id"),viewID:e.blockElement.getAttribute(Constants.CUSTOM_SY_AV_VIEW),groupID:e.groupID,previousID:e.previousId},g=>{if(g.data.values){let m;const d=Object.keys(g.data.values);e.blockElement.querySelectorAll('[data-type="ghost"]').forEach(f=>{f.querySelectorAll(".av__cell").forEach(b=>{if(!m&&b.getAttribute("data-detached")==="true"&&(m=b),d.includes(b.dataset.fieldId)){const p=g.data.values[b.dataset.fieldId];p.type==="checkbox"&&b.parentElement.querySelector(".av__gallery-tip")&&(p.checkbox.content=b.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]),b.innerHTML=renderCell(p,void 0,!1,"gallery"),renderCellAttr(b,p)}})})}setPage(e.blockElement)})},Tu=e=>{if(e.protyle.disabled)return;const t=new Menu(Constants.MENU_AV_VIEW);if(t.isOpen)return;t.addItem({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config",cb:i=>{i.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),t.addItem({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config"})}}),t.addSeparator(),t.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove();const i=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:e.blockElement.dataset.avId,previousID:e.element.dataset.id,id:i,blockID:e.blockElement.dataset.nodeId}],[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:i,blockID:e.blockElement.dataset.nodeId}])}}),e.blockElement.querySelectorAll(".layout-tab-bar .item").length>1&&t.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var n;(n=document.querySelector(".av__panel"))==null||n.remove(),transaction(e.protyle,[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:e.element.dataset.id,blockID:e.blockElement.dataset.nodeId}])}});const a=e.element.getBoundingClientRect();t.open({x:a.left,y:a.bottom})},Iu=e=>{const t=e.menuElement.querySelector('.b3-text-field[data-type="name"]');t.addEventListener("blur",()=>{t.value!==t.dataset.value&&(transaction(e.protyle,[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.value}],[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.dataset.value}]),t.dataset.value=t.value)}),t.addEventListener("keydown",n=>{n.isComposing||n.key==="Enter"&&(n.preventDefault(),t.blur(),e.menuElement.parentElement.remove())}),t.select(),t.value=t.dataset.value;const a=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');t.nextElementSibling.addEventListener("click",()=>{const n=a.parentElement;n.classList.toggle("fn__none"),n.classList.contains("fn__none")||a.focus()}),a.addEventListener("blur",()=>{a.value!==a.dataset.value&&(transaction(e.protyle,[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:a.value}],[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:a.dataset.value}]),a.dataset.value=a.value)}),a.addEventListener("keydown",n=>{n.isComposing||n.key==="Enter"&&(n.preventDefault(),a.blur(),e.menuElement.parentElement.remove())}),a.addEventListener("input",()=>{t.nextElementSibling.setAttribute("aria-label",a.value?escapeHtml(a.value):window.siyuan.languages.addDesc)})},Du=e=>{const t=e.view,a=Ds(e);return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-type="update-view-icon">${t.icon?unicode2Emoji(t.icon):`<svg style="height: 14px;width: 14px"><use xlink:href="#${va(e.viewType)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text" data-value="${escapeAttr(t.name)}">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${t.desc?escapeAriaLabel(t.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__block" type="text" data-value="${escapeAttr(t.desc)}">${t.desc}</textarea>
        </div>
        <div class="fn__hr"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="go-layout">
    <svg class="b3-menu__icon"><use xlink:href="#${va(e.viewType)}"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.layout}</span>
    <span class="b3-menu__accelerator">${io(e.viewType)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"><use xlink:href="#iconList"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.fields}</span>
    <span class="b3-menu__accelerator">${a.filter(n=>!n.hidden).length}/${a.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${t.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${t.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goGroups">
    <svg class="b3-menu__icon"><use xlink:href="#iconGroups"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.group}</span>
    <span class="b3-menu__accelerator">${e.view.group&&e.view.group.field?a.filter(n=>n.id===e.view.group.field)[0].name:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item${e.views.length>1?"":" fn__none"}" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Mu=e=>{const t=e.menuElement.querySelector(".b3-text-field");t.focus(),t.addEventListener("keydown",a=>{if(a.stopPropagation(),!a.isComposing)if(upDownHint(e.menuElement.querySelector(".fn__flex-1"),a,"b3-menu__item--current"),a.key==="Enter"){const n=e.menuElement.querySelector(".b3-menu__item--current");n&&(transaction(e.protyle,[{action:"setAttrViewBlockView",blockID:e.blockElement.getAttribute("data-node-id"),id:n.dataset.id,avID:e.blockElement.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:e.blockElement.getAttribute("data-node-id"),id:e.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:e.blockElement.getAttribute("data-av-id")}]),e.menuElement.remove(),focusBlock(e.blockElement))}else a.key==="Escape"&&(e.menuElement.remove(),focusBlock(e.blockElement))}),t.addEventListener("input",a=>{a.isComposing||Is(e.menuElement)}),t.addEventListener("compositionend",()=>{Is(e.menuElement)})},Is=e=>{var t;const n=e.querySelector(".b3-text-field").value;e.querySelectorAll('.b3-menu__item[draggable="true"]').forEach(i=>{!n||n.toLowerCase().indexOf(i.textContent.trim().toLowerCase())>-1||i.textContent.trim().toLowerCase().indexOf(n.toLowerCase())>-1?i.classList.remove("fn__none"):(i.classList.add("fn__none"),i.classList.remove("b3-menu__item--current"))}),e.querySelector(".b3-menu__item--current")||(t=e.querySelector(".fn__flex-1 .b3-menu__item:not(.fn__none)"))==null||t.classList.add("b3-menu__item--current")},$u=(e,t)=>{let a="";return e.forEach(n=>{a+=`<button draggable="true" class="b3-menu__item${n.id===t?" b3-menu__item--current":""}" data-id="${n.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex" data-type="av-view-switch" data-av-type="${n.type}">
        ${n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${va(n.type)}"></use></svg>`}
        <span class="fn__ellipsis">${n.name}</span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items fn__flex-column">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.newView}</span>
</button>
<button class="b3-menu__separator"></button>
<div class="b3-menu__item fn__flex-shrink" data-type="nobg">
    <input class="b3-text-field fn__block" type="text" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
</div>
<div class="fn__flex-1" style="overflow: auto">
    ${a}
</div>
</div>`},Hu=(e,t)=>{var a;const n=Lute.NewNodeID(),i=t.getAttribute("data-av-id"),s=t.querySelector(".av__views"),o=new Menu(void 0,()=>{s.classList.remove("av__views--show")});o.addItem({icon:"iconTable",label:window.siyuan.languages.table,click(){transaction(e,[{action:"addAttrViewView",avID:i,id:n,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",avID:i,id:n,blockID:t.getAttribute("data-node-id")}])}}),o.addItem({icon:"iconGallery",label:window.siyuan.languages.gallery,click(){transaction(e,[{action:"addAttrViewView",avID:i,layout:"gallery",id:n,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",layout:"gallery",avID:i,id:n,blockID:t.getAttribute("data-node-id")}])}}),s.classList.add("av__views--show");const l=(a=s.querySelector('.block__icon[data-type="av-add"]'))==null?void 0:a.getBoundingClientRect();o.open({x:l.left,y:l.bottom+8})},va=e=>{switch(e){case"table":return"iconTable";case"gallery":return"iconGallery"}},io=e=>{switch(e){case"table":return window.siyuan.languages.table;case"gallery":return window.siyuan.languages.gallery}},Ds=e=>e.viewType==="table"?e.view.columns:e.view.fields,Nu=e=>{const t=window.siyuan.dragElement.parentElement;if(t.scrollWidth>t.clientWidth){const i=t.getBoundingClientRect();e.clientX<i.left?t.scroll({left:t.scrollLeft-Constants.SIZE_SCROLL_STEP,behavior:"smooth"}):e.clientX>i.right&&t.scroll({left:t.scrollLeft+Constants.SIZE_SCROLL_STEP,behavior:"smooth"})}const a=hasClosestByClassName(document.elementFromPoint(e.clientX,window.siyuan.dragElement.getBoundingClientRect().top+10),"item");if(!a||t!==window.siyuan.dragElement.parentElement||a===window.siyuan.dragElement)return;const n=a.getBoundingClientRect();if(n.left+n.width/2<e.clientX){if(a.nextElementSibling&&a.nextElementSibling===window.siyuan.dragElement)return;a.after(window.siyuan.dragElement)}else{if(a.previousElementSibling&&a.previousElementSibling===window.siyuan.dragElement)return;a.before(window.siyuan.dragElement)}};var Ea=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Ms=(e,t,a,n,i,s)=>Ea(void 0,null,function*(){var o,l,r,c,u,g,m,d,f;const b=[],p=[],y=[],_=a.getAttribute("data-node-id"),k=[];let x=a,T=!0;t.find(E=>{if(!E.classList.contains("li")||a.getAttribute("data-subtype")!==E.getAttribute("data-subtype"))return T=!1,!0});let w,v;const h={};for(let E=t.length-1;E>=0;E--){const C=t[E],A=C.getAttribute("data-node-id"),S=C.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID;C.getAttribute("data-type")==="NodeListItem"&&!v&&!T&&(v=Lute.NewNodeID(),w=document.createElement("div"),w.innerHTML=`<div data-subtype="${C.getAttribute("data-subtype")}" data-node-id="${v}" data-type="NodeList" class="list"><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,w=w.firstElementChild,b.push({action:"insert",data:w.outerHTML,id:v,previousID:i==="afterbegin"?null:i==="afterend"?_:(o=x.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:i==="afterbegin"?_:((l=x.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),p.push({action:"delete",id:v}),x.insertAdjacentElement(i,w),k.push(w));const L=Lute.NewNodeID();s&&C.getAttribute("data-type")==="NodeHeading"&&C.getAttribute("fold")==="1"&&y.push({newId:L,oldId:A});let $;if(s?p.push({action:"delete",id:L}):p.push({action:"move",id:A,previousID:(r=C.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:S}),!n&&!s){const R=e.wysiwyg.element.querySelector(`[data-node-id="${A}"]`);R&&R.remove()}if(s)$=C.cloneNode(!0),$.setAttribute("data-node-id",L),$.querySelectorAll("[data-node-id]").forEach(R=>{const D=Lute.NewNodeID();R.setAttribute("data-node-id",D),R.setAttribute("updated",D.split("-")[0])}),v?(w.insertAdjacentElement("afterbegin",$),b.push({action:"insert",id:L,data:$.outerHTML,parentID:v})):(x.insertAdjacentElement(i,$),b.push({action:"insert",id:L,data:$.outerHTML,previousID:i==="afterbegin"?null:i==="afterend"?_:(c=$.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:i==="afterbegin"?_:((u=$.parentElement)==null?void 0:u.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),k.push($));else{const R=getTopAloneElement(C),D=C.parentElement;if(C.classList.contains("li")&&C.getAttribute("data-subtype")==="o"&&(h[C.parentElement.getAttribute("data-node-id")]=C.parentElement),v?(w.insertAdjacentElement("afterbegin",C),b.push({action:"move",id:A,parentID:v})):(x.insertAdjacentElement(i,C),b.push({action:"move",id:A,previousID:i==="afterbegin"?null:i==="afterend"?_:(g=C.previousElementSibling)==null?void 0:g.getAttribute("data-node-id"),parentID:i==="afterbegin"?_:((m=C.parentElement)==null?void 0:m.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),k.push(C)),R!==C){if(b.push({action:"delete",id:R.getAttribute("data-node-id")}),p.push({action:"insert",data:R.outerHTML,id:R.getAttribute("data-node-id"),previousID:(d=R.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:((f=R.parentElement)==null?void 0:f.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),R.remove(),!n){const M=e.wysiwyg.element.querySelector(`[data-node-id="${R.getAttribute("data-node-id")}"]`);M&&M.remove()}}else if(D.classList.contains("sb")&&D.childElementCount===2){if(n){const M=yield cancelSB(e,D);b.push(M.doOperations[0],M.doOperations[1]),p.push(M.undoOperations[1],M.undoOperations[0])}}else D.classList.contains("protyle-wysiwyg")&&D.childElementCount}v&&(E===0||t[E-1].getAttribute("data-type")!=="NodeListItem"||t[E-1].getAttribute("data-subtype")!==C.getAttribute("data-subtype"))?(i==="beforebegin"&&(x=w),v=null):i==="beforebegin"&&(x=s?$:C)}Object.keys(h).forEach(E=>{Array.from(h[E].children).forEach(C=>{C.classList.contains("protyle-attr")||p.push({action:"update",id:C.getAttribute("data-node-id"),data:C.outerHTML})}),updateListOrder(h[E],1),Array.from(h[E].children).forEach(C=>{C.classList.contains("protyle-attr")||b.push({action:"update",id:C.getAttribute("data-node-id"),data:C.outerHTML})})}),p.reverse();for(let E=0;E<y.length;E++){const C=y[E],A=yield fetchSyncPost("/api/block/getHeadingInsertTransaction",{id:C.oldId});A.data.doOperations.splice(0,1),A.data.doOperations[0].previousID=C.newId,A.data.undoOperations.splice(0,1),b.push(...A.data.doOperations),p.push(...A.data.undoOperations)}return{doOperations:b,undoOperations:p,newSourceElements:k}}),$s=(e,t,a,n,i,s)=>Ea(void 0,null,function*(){var o,l,r,c;const u=e.element.contains(t[0]),g=[],m={action:"move",id:a.getAttribute("data-node-id"),previousID:(o=a.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:((l=a.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID},d=genSBElement(i);a.parentElement.replaceChild(d,a);const f=[{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),nextID:(r=d.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(c=d.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:d.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID}],b=yield Ms(e,t,d,u,"afterbegin",s);f.push(...b.doOperations),g.push(...b.undoOperations);const p=b.newSourceElements;n?(d.insertAdjacentElement("afterbegin",a),f.push({action:"move",id:a.getAttribute("data-node-id"),parentID:d.getAttribute("data-node-id")})):(d.lastElementChild.insertAdjacentElement("beforebegin",a),f.push({action:"move",id:a.getAttribute("data-node-id"),previousID:p[0].getAttribute("data-node-id")})),g.push(m),g.push({action:"delete",id:d.getAttribute("data-node-id")});let y=!1;p.forEach(_=>{if(_.getAttribute("data-type")==="NodeHeading"&&_.getAttribute("fold")==="1"){if(y=!0,_.nextElementSibling&&(_.nextElementSibling.getAttribute("data-type")!=="NodeHeading"||_.nextElementSibling.getAttribute("data-subtype")>_.getAttribute("data-subtype"))){const k=setFold(e,_,!0,!1,!1,!0);f.push(...k.doOperations)}return!0}}),u||s?transaction(e,f,g):transaction(e,f),(p.length>1||y)&&i==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:p.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),document.contains(t[0])?focusBlock(t[0]):focusBlock(a)}),Hs=(e,t,a,n,i)=>Ea(void 0,null,function*(){const s=e.element.contains(t[0]),o=[],l=[],r=yield Ms(e,t,a,s,n?"afterend":"beforebegin",i);o.push(...r.doOperations),l.push(...r.undoOperations);const c=r.newSourceElements;let u;n&&a.getAttribute("data-type")==="NodeHeading"&&a.getAttribute("fold")==="1"?u=setFold(e,a,!0,!1,!1,!0):!n&&a.previousElementSibling&&a.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&a.previousElementSibling.getAttribute("fold")==="1"&&(u=setFold(e,a.previousElementSibling,!0,!1,!1,!0)),u&&(u.doOperations[0].context={focusId:t[0].getAttribute("data-node-id")},o.push(...u.doOperations),l.push(...u.undoOperations)),a.getAttribute("data-type")==="NodeListItem"&&a.getAttribute("data-subtype")==="o"&&(Array.from(a.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||l.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})}),updateListOrder(a.parentElement,1),Array.from(a.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||o.push({action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})}));let g=!1;c.forEach(m=>{if(m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1"){if(g=!0,m.nextElementSibling&&(m.nextElementSibling.getAttribute("data-type")!=="NodeHeading"||m.nextElementSibling.getAttribute("data-subtype")>m.getAttribute("data-subtype"))){const d=setFold(e,m,!0,!1,!1,!0);o.push(...d.doOperations)}return!0}}),s||i?transaction(e,o,l):transaction(e,o),(c.length>1||g)&&c[0].parentElement.classList.contains("sb")&&c[0].parentElement.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:c.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),document.contains(t[0])?focusBlock(t[0]):focusBlock(a)}),Bu=(e,t)=>{t.addEventListener("dragstart",s=>{var o,l,r;if(e.disabled){s.preventDefault(),s.stopPropagation();return}let c=s.target;if((o=c.classList)!=null&&o.contains("av__gallery-img")&&(c=hasClosestByClassName(c,"av__gallery-item")),!!c){if(c.tagName==="IMG"){window.siyuan.dragElement=void 0,s.preventDefault();return}if(c.classList){if(hasClosestByClassName(c,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,s.preventDefault();else if(c.parentElement.parentElement.classList.contains("av__views")){window.siyuan.dragElement=c,c.style.width=c.clientWidth+"px",c.style.opacity=".36",s.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}ViewTab${Constants.ZWSP}${[(l=c.previousElementSibling)==null?void 0:l.getAttribute("data-id")]}`,c.outerHTML);return}else if(c.classList.contains("protyle-action")){c.parentElement.classList.add("protyle-wysiwyg--select");const u=document.createElement("div");u.className=e.wysiwyg.element.className,u.append(processClonePHElement(c.parentElement.cloneNode(!0))),u.setAttribute("style",`position:fixed;opacity:.1;width:${c.parentElement.clientWidth}px;padding:0;`),document.body.append(u),s.dataTransfer.setDragImage(u,0,0),setTimeout(()=>{u.remove()}),window.siyuan.dragElement=e.wysiwyg.element,s.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeListItem${Constants.ZWSP}${c.parentElement.getAttribute("data-subtype")}${Constants.ZWSP}${[c.parentElement.getAttribute("data-node-id")]}`,e.wysiwyg.element.innerHTML);return}else if(c.classList.contains("av__cell--header")){window.siyuan.dragElement=c,s.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}${[c.getAttribute("data-col-id")]}`,c.outerHTML);return}else if(c.classList.contains("av__gallery-item")){const u=hasClosestBlock(c);if(u){if((r=u.querySelector('.block__icon[data-type="av-sort"]'))!=null&&r.classList.contains("block__icon--active")){const p=u.querySelectorAll(".av__body");if(p.length===1){s.preventDefault(),s.stopPropagation();return}else if(["template","created","updated"].includes(p[0].getAttribute("data-dtype"))){s.preventDefault(),s.stopPropagation();return}}c.classList.contains("av__gallery-item--select")||(u.querySelectorAll(".av__gallery-item--select").forEach(p=>{p.classList.remove("av__gallery-item--select")}),c.classList.add("av__gallery-item--select"));const g=document.createElement("div");g.className="protyle-wysiwyg protyle-wysiwyg--attr";const m=u.querySelectorAll(".av__gallery-item--select");let d,f=document.createElement("div");m.forEach(p=>{(!d||!d.contains(p))&&(d=p.parentElement,f=document.createElement("div"),f.classList.add("av__gallery"),f.setAttribute("style",`width: 100vw;margin-bottom: 16px;grid-template-columns: repeat(auto-fill, ${m[0].clientWidth}px);`),g.appendChild(f));const y=processClonePHElement(p.cloneNode(!0));y.setAttribute("style",`height:${p.clientHeight}px;`),y.querySelector(".av__gallery-fields").setAttribute("style","background-color: var(--b3-theme-background)"),f.appendChild(y)}),g.setAttribute("style","top:100vh;position:fixed;opacity:.1;padding:0;z-index: 8"),document.body.append(g),s.dataTransfer.setDragImage(g,-10,-10),setTimeout(()=>{g.remove()}),window.siyuan.dragElement=c;const b=[];u.querySelectorAll(".av__gallery-item--select").forEach(p=>{const _=hasClosestByClassName(p,"av__body").getAttribute("data-group-id");b.push(p.getAttribute("data-id")+(_?`@${_}`:""))}),s.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}GalleryItem${Constants.ZWSP}${b}`,g.outerHTML)}return}}s.dataTransfer.setData(Constants.SIYUAN_DROP_EDITOR,Constants.SIYUAN_DROP_EDITOR),e.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}}),t.addEventListener("drop",s=>Ea(void 0,null,function*(){var o,l,r,c,u,g,m;if(i=0,e.disabled||s.dataTransfer.getData(Constants.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation();return}let d="";for(const b of s.dataTransfer.items)b.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(d=b.type);if(d.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}ViewTab${Constants.ZWSP}`.toLowerCase())){const b=hasClosestBlock(window.siyuan.dragElement);if(b){const p=b.getAttribute("data-av-id"),y=b.getAttribute("data-node-id"),_=window.siyuan.dragElement.getAttribute("data-id");transaction(e,[{action:"sortAttrViewView",avID:p,blockID:y,id:_,previousID:(o=window.siyuan.dragElement.previousElementSibling)==null?void 0:o.getAttribute("data-id"),data:"unRefresh"}],[{action:"sortAttrViewView",avID:p,blockID:y,id:_,previousID:d.split(Constants.ZWSP).pop()}])}return}const f=t.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(f&&(f.classList.remove("dragover"),f.removeAttribute("select-start"),f.removeAttribute("select-end")),d){const b=[],p=d.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP),y=p[2].split(",");if(s.altKey||s.shiftKey)if(s.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)insertEmptyBlock(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const _=getRangeByPoint(s.clientX,s.clientY);if(hasClosestByAttribute(_.startContainer,"data-type","NodeBlockQueryEmbed"))return;focusByRange(_)}if(s.altKey){let _="";for(let k=0;k<y.length;k++){const x=yield fetchSyncPost("/api/block/getRefText",{id:y[k]});_+=e.lute.Md2BlockDOM(`((${y[k]} '${x.data}'))`)}insertHTML(_,e)}else if(s.shiftKey){let _="";y.forEach(k=>{_+=`{{select * from blocks where id='${k}'}}
`}),insertHTML(e.lute.SpinBlockDOM(_),e,!0),blockRender(e,e.wysiwyg.element)}else if(f&&f.className.indexOf("dragover__")>-1){let _="";if(y.forEach(w=>{_+=`[data-node-id="${w}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(_.substring(0,_.length-1)).forEach(w=>{isInEmbedBlock(w)||b.push(w)});else if(window.siyuan.config.system.workspaceDir.toLowerCase()===p[3]){const w=document.createElement("template");w.innerHTML=`<div>${s.dataTransfer.getData(d)}</div>`,w.content.querySelectorAll(_.substring(0,_.length-1)).forEach(v=>{isInEmbedBlock(v)||b.push(v)})}const k=[],x=[];b.forEach(w=>{w.classList.remove("protyle-wysiwyg--hl"),w.removeAttribute("select-start"),w.removeAttribute("select-end"),w.querySelectorAll('[data-type="search-mark"]').forEach(h=>{h.outerHTML=h.innerHTML});const v=w.getAttribute("data-node-id");k.push(v),x.push({itemID:Lute.NewNodeID(),id:v,isDetached:!1})}),hideElements(["gutter"],e);const T=f.className.split(" ");if(f.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),f.classList.contains("av__cell")){const w=hasClosestBlock(f);if(w){const v=w.getAttribute("data-av-id");let h="";T.includes("dragover__left")?f.previousElementSibling&&(f.previousElementSibling.classList.contains("av__colsticky")?h=f.previousElementSibling.lastElementChild.getAttribute("data-col-id"):h=f.previousElementSibling.getAttribute("data-col-id")):h=f.getAttribute("data-col-id");let E="";const C=hasClosestByClassName(f,"av__row");if(C){const A=(l=C.querySelector(`[data-col-id="${p[2]}"`))==null?void 0:l.previousElementSibling;A&&(A.classList.contains("av__colsticky")?E=A.lastElementChild.getAttribute("data-col-id"):E=A.getAttribute("data-col-id"))}h!==E&&h!==p[2]&&transaction(e,[{action:"sortAttrViewCol",avID:v,previousID:h,id:p[2],blockID:w.dataset.nodeId}],[{action:"sortAttrViewCol",avID:v,previousID:E,id:p[2],blockID:w.dataset.nodeId}])}}else if(f.classList.contains("av__row")){const w=hasClosestBlock(f);if(w){let v="";T.includes("dragover__bottom")?v=f.getAttribute("data-id")||"":v=((r=f.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"";const h=w.getAttribute("data-av-id");if(p[0]==="nodeattributeviewrowmenu"){const E=[],C=[],A=f.parentElement.getAttribute("data-group-id");y.reverse().forEach(S=>{var L;const $=S.split("@"),R=$[0],D=$[1]||"",M=((L=w.querySelector(`.av__body${D?`[data-group-id="${D}"]`:""} .av__row[data-id="${R}"]`).previousElementSibling)==null?void 0:L.getAttribute("data-id"))||"";(v!==R&&M!==v||M===""&&v===""&&A!==D)&&(E.push({action:"sortAttrViewRow",avID:h,previousID:v,id:R,blockID:w.dataset.nodeId,groupID:D,targetGroupID:A}),C.push({action:"sortAttrViewRow",avID:h,previousID:M,id:R,blockID:w.dataset.nodeId,groupID:A,targetGroupID:D}))}),transaction(e,E,C)}else{const E=dayjs().format("YYYYMMDDHHmmss"),C=hasClosestByClassName(f,"av__body"),A=C&&C.getAttribute("data-group-id");transaction(e,[{action:"insertAttrViewBlock",avID:h,previousID:v,srcs:x,blockID:w.dataset.nodeId,groupID:A},{action:"doUpdateUpdated",id:w.dataset.nodeId,data:E}],[{action:"removeAttrViewBlock",srcIDs:k,avID:h},{action:"doUpdateUpdated",id:w.dataset.nodeId,data:w.getAttribute("updated")}]),w.setAttribute("updated",E),insertAttrViewBlockAnimation({protyle:e,blockElement:w,srcIDs:k,previousId:v,groupID:A})}}}else if(f.classList.contains("av__gallery-item")||f.classList.contains("av__gallery-add")){const w=hasClosestBlock(f);if(w){let v="";T.includes("dragover__right")?v=f.getAttribute("data-id")||"":v=((c=f.previousElementSibling)==null?void 0:c.getAttribute("data-id"))||"";const h=w.getAttribute("data-av-id");if(p[1]==="galleryitem"&&p[0]==="nodeattributeview"){const E=[],C=[],A=f.parentElement.parentElement.getAttribute("data-group-id");y.reverse().forEach(S=>{var L;const $=S.split("@"),R=$[0],D=$[1]||"",M=((L=w.querySelector(`.av__body[data-group-id="${D}"] .av__gallery-item[data-id="${R}"]`).previousElementSibling)==null?void 0:L.getAttribute("data-id"))||"";(v!==S&&M!==v||M===""&&v===""&&A!==D)&&(E.push({action:"sortAttrViewRow",avID:h,previousID:v,id:R,blockID:w.dataset.nodeId,groupID:D,targetGroupID:A}),C.push({action:"sortAttrViewRow",avID:h,previousID:M,id:R,blockID:w.dataset.nodeId,groupID:A,targetGroupID:D}))}),transaction(e,E,C)}else{const E=dayjs().format("YYYYMMDDHHmmss"),C=hasClosestByClassName(f,"av__body");transaction(e,[{action:"insertAttrViewBlock",avID:h,previousID:v,srcs:x,blockID:w.dataset.nodeId,groupID:C&&C.getAttribute("data-group-id")},{action:"doUpdateUpdated",id:w.dataset.nodeId,data:E}],[{action:"removeAttrViewBlock",srcIDs:k,avID:h},{action:"doUpdateUpdated",id:w.dataset.nodeId,data:w.getAttribute("updated")}]),w.setAttribute("updated",E),insertGalleryItemAnimation({protyle:e,blockElement:w,srcIDs:k,previousId:v,groupID:f.parentElement.getAttribute("data-group-id")})}}}else b.length>0&&(f.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&f.parentElement.getAttribute("data-sb-layout")==="col"?T.includes("dragover__left")||T.includes("dragover__right")?Hs(e,b,f,T.includes("dragover__right"),s.ctrlKey):$s(e,b,f,T.includes("dragover__bottom"),"row",s.ctrlKey):T.includes("dragover__left")||T.includes("dragover__right")?$s(e,b,f,T.includes("dragover__right"),"col",s.ctrlKey):Hs(e,b,f,T.includes("dragover__bottom"),s.ctrlKey),t.querySelectorAll(".protyle-wysiwyg--empty").forEach(w=>{w.classList.remove("protyle-wysiwyg--empty")}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(w=>{w.removeAttribute("data-render"),blockRender(e,w)}));a=void 0}}else if(((u=s.dataTransfer.getData(Constants.SIYUAN_DROP_FILE))==null?void 0:u.split("-").length)>1){const b=s.dataTransfer.getData(Constants.SIYUAN_DROP_FILE).split(",");if(!s.altKey&&(!f||!f.classList.contains("av__row")&&!f.classList.contains("av__gallery-item")&&!f.classList.contains("av__gallery-add"))){if(s.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)insertEmptyBlock(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const y=getRangeByPoint(s.clientX,s.clientY);if(hasClosestByAttribute(y.startContainer,"data-type","NodeBlockQueryEmbed"))return;focusByRange(y)}let p="";for(let y=0;y<b.length;y++){b.length>1&&(p+="- ");const _=yield fetchSyncPost("/api/block/getRefText",{id:b[y]});p+=`((${b[y]} '${_.data}'))`,b.length>1&&y!==b.length-1&&(p+=`
`)}insertHTML(e.lute.Md2BlockDOM(p),e)}else if(f&&!e.options.backlinkData&&f.className.indexOf("dragover__")>-1){const p=e.contentElement.scrollTop;if(f.classList.contains("av__row")||f.classList.contains("av__gallery-item")||f.classList.contains("av__gallery-add")){const y=hasClosestBlock(f);if(y){let _="";f.classList.contains("dragover__bottom")?_=f.getAttribute("data-id")||"":f.classList.contains("dragover__top")?_=((g=f.previousElementSibling)==null?void 0:g.getAttribute("data-id"))||"":f.classList.contains("dragover__left")?_=((m=f.previousElementSibling)==null?void 0:m.getAttribute("data-id"))||"":f.classList.contains("dragover__right")&&(_=f.getAttribute("data-id")||"");const k=y.getAttribute("data-av-id"),x=dayjs().format("YYYYMMDDHHmmss"),T=[],w=hasClosestByClassName(f,"av__body"),v=w&&w.getAttribute("data-group-id");b.forEach(h=>{T.push({itemID:Lute.NewNodeID(),id:h,isDetached:!1})}),transaction(e,[{action:"insertAttrViewBlock",avID:k,previousID:_,srcs:T,blockID:y.dataset.nodeId,groupID:v},{action:"doUpdateUpdated",id:y.dataset.nodeId,data:x}],[{action:"removeAttrViewBlock",srcIDs:b,avID:k},{action:"doUpdateUpdated",id:y.dataset.nodeId,data:y.getAttribute("updated")}]),insertAttrViewBlockAnimation({protyle:e,blockElement:y,srcIDs:b,previousId:_,groupID:v}),y.setAttribute("updated",x)}}else{if(f.classList.contains("dragover__bottom"))for(let y=b.length-1;y>-1;y--)b[y]&&(yield fetchSyncPost("/api/filetree/doc2Heading",{srcID:b[y],after:!0,targetID:f.getAttribute("data-node-id")}));else for(let y=0;y<b.length;y++)b[y]&&(yield fetchSyncPost("/api/filetree/doc2Heading",{srcID:b[y],after:!1,targetID:f.getAttribute("data-node-id")}));fetchPost("/api/filetree/getDoc",{id:e.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},y=>{onGet({data:y,protyle:e}),setTimeout(()=>{e.contentElement.scrollTop=p,e.scroll.lastScrollTop=p-1},Constants.TIMEOUT_LOAD)})}f.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}}else if(!window.siyuan.dragElement&&(s.dataTransfer.types[0]==="Files"||s.dataTransfer.types.includes("text/html"))){s.preventDefault();const b=hasClosestByClassName(s.target,"av");if(b){const p=hasClosestByClassName(s.target,"av__cell");if(p&&getTypeByCellElement(p)==="mAsset"&&s.dataTransfer.types[0]==="Files"&&!isBrowser()){const y=[];for(let _=0;_<s.dataTransfer.files.length;_++)y.push(webUtils.getPathForFile(s.dataTransfer.files[_]));dragUpload(y,e,p),clearSelect(["cell"],b)}}else{if(focusByRange(getRangeByPoint(s.clientX,s.clientY)),s.dataTransfer.types[0]==="Files"&&!isBrowser()){const p=[];for(let y=0;y<s.dataTransfer.files.length;y++)p.push(webUtils.getPathForFile(s.dataTransfer.files[y]));uploadLocalFiles(p,e,!s.altKey)}else paste(e,s);clearSelect(["av","img"],e.wysiwyg.element)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let a,n;t.addEventListener("dragover",s=>{var o,l,r,c,u;if(e.disabled||s.dataTransfer.types.includes(Constants.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation(),s.dataTransfer.dropEffect="none";return}let g="";for(const _ of s.dataTransfer.items)_.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(g=_.type);if(g.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}ViewTab${Constants.ZWSP}`.toLowerCase())){dragoverTab(s),s.preventDefault();return}const m=e.contentElement.getBoundingClientRect();!hasClosestByClassName(s.target,"av__cell")&&(s.clientY<m.top+Constants.SIZE_SCROLL_TB||s.clientY>m.bottom-Constants.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(s.clientY<m.top+Constants.SIZE_SCROLL_TB?-Constants.SIZE_SCROLL_STEP:Constants.SIZE_SCROLL_STEP),behavior:"smooth"});let d;if(s.dataTransfer.types.includes("Files")){if(d=hasClosestByClassName(s.target,"av__cell"),d&&d.getAttribute("data-dtype")==="mAsset"&&!d.classList.contains("av__cell--header")){if(s.preventDefault(),a&&d===a)return;const _=hasClosestBlock(d);_&&(clearSelect(["cell","row"],e.wysiwyg.element),d.classList.add("av__cell--select"),_.getAttribute("data-av-type")!=="gallery"&&addDragFill(d),a=d)}return}if(!g&&!window.siyuan.dragElement){s.preventDefault();return}const f=g?g.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP):[],b=s.dataTransfer.types.includes(Constants.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(s.shiftKey||s.altKey&&b.indexOf("-")===-1){const _=hasClosestBlock(s.target);_?(_.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),_.removeAttribute("select-start"),_.removeAttribute("select-end")):t.querySelectorAll(".dragover__top, .protyle-wysiwyg--select, .dragover__bottom, .dragover__left, .dragover__right").forEach(k=>{k.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),k.removeAttribute("select-start"),k.removeAttribute("select-end")}),s.preventDefault();return}if(s.preventDefault(),d=hasClosestByClassName(s.target,"av__gallery-item")||hasClosestByClassName(s.target,"av__gallery-add")||hasClosestByClassName(s.target,"av__row")||hasClosestByClassName(s.target,"av__row--util")||hasClosestBlock(s.target),d&&d.getAttribute("data-av-type")==="gallery"&&s.target.classList.contains("av__gallery"))return;const p={x:s.clientX,y:s.clientY,className:""};if(d&&(d.classList.contains("bq")||d.classList.contains("sb")||d.classList.contains("list")||d.classList.contains("li"))){let _=hasClosestBlock(document.elementFromPoint(p.x,p.y-6));for(;_&&d.contains(_);)(o=_.nextElementSibling)!=null&&o.getAttribute("data-node-id")&&(d=_),_=_.parentElement}if(d)d&&d.classList.contains("list")&&(f[0]!=="nodelistitem"?d=hasClosestBlock(document.elementFromPoint(s.clientX,s.clientY-6)):d=hasClosestByClassName(document.elementFromPoint(s.clientX,s.clientY-6),"li"));else if(s.clientY>t.lastElementChild.getBoundingClientRect().bottom)d=t.lastElementChild,p.className="dragover__bottom";else if(s.clientY<t.firstElementChild.getBoundingClientRect().top)d=t.firstElementChild,p.className="dragover__top";else if(m){const _={left:m.left+parseInt(t.style.paddingLeft),right:m.left+e.contentElement.clientWidth-parseInt(t.style.paddingRight)};s.clientX<_.left?(p.x=_.left,p.className="dragover__left"):s.clientX>=_.right&&(p.x=_.right-6,p.className="dragover__right"),d=document.elementFromPoint(p.x,p.y),d.classList.contains("protyle-wysiwyg")&&(d=document.elementFromPoint(p.x,p.y-6)),d=hasTopClosestByAttribute(d,"data-node-id",null)}if(g&&g.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}`.toLowerCase())){if(d=hasClosestByClassName(s.target,"av__cell"),d){const _=hasClosestByClassName(d,"av__row--header"),k=hasClosestByClassName(window.siyuan.dragElement,"av__row--header");(d===window.siyuan.dragElement||!_||!k||_&&k&&_!==k)&&(d=!1)}}else if(d&&g&&g.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${Constants.ZWSP}`.toLowerCase()))if(!d.classList.contains("av__row")&&!d.classList.contains("av__row--util")||window.siyuan.dragElement&&!window.siyuan.dragElement.contains(d))d=!1;else{const _=hasClosestByClassName(d,"av__body");if(_){const k=hasClosestBlock(_),x=_.getAttribute("data-group-id"),T=["template","created","updated"].includes(_.getAttribute("data-dtype")),w=(l=k.querySelector('.block__icon[data-type="av-sort"]'))==null?void 0:l.classList.contains("block__icon--active");f[2].split(",").find(v=>{const h=v?v.split("@")[1]:"";if(h!==x&&T||h===x&&w)return d=!1,!0})}}else if(d&&g&&g.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}GalleryItem${Constants.ZWSP}`.toLowerCase())){const _=hasClosestByClassName(s.target,"av__container");if(d.classList.contains("av")||!_||!_.contains(window.siyuan.dragElement)||d===window.siyuan.dragElement)d=!1;else{const k=hasClosestByClassName(d,"av__body");if(k){const x=hasClosestBlock(k),T=k.getAttribute("data-group-id"),w=["template","created","updated"].includes(k.getAttribute("data-dtype")),v=(r=x.querySelector('.block__icon[data-type="av-sort"]'))==null?void 0:r.classList.contains("block__icon--active");f[2].split(",").find(h=>{const E=h?h.split("@")[1]:"";if(E!==T&&w||E===T&&v)return d=!1,!0})}}}if(!d){t.querySelectorAll(".dragover__bottom, .dragover__top, .dragover, .dragover__left, .dragover__right").forEach(_=>{_.classList.remove("dragover__top","dragover__bottom","dragover","dragover__left","dragover__right")});return}const y=!d.classList.contains("av__row")&&!d.classList.contains("av__row--util")&&!d.classList.contains("av__gallery-item")&&!d.classList.contains("av__gallery-add");if(d&&a&&d===a){const _=d.getBoundingClientRect();if(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(k=>{k.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),k.removeAttribute("select-start"),k.removeAttribute("select-end")}),b.indexOf("-")>-1&&y)if(s.altKey){if(b.split(",").includes(e.block.rootID)&&s.altKey)return}else return;if(d.getAttribute("data-type")==="NodeAttributeView"&&hasClosestByTag(s.target,"TD"))return;if(p.className){d.classList.add(p.className),vt(d);return}if(d.getAttribute("data-type")==="NodeListItem"){s.clientY>_.top+_.height/2?(d.classList.add("dragover__bottom"),vt(d)):d.classList.contains("av__row--header")||(d.classList.add("dragover__top"),vt(d));return}if(d.classList.contains("av__cell")){s.clientX<_.left+_.width/2&&s.clientX>_.left&&!d.classList.contains("av__row")&&d.previousElementSibling!==window.siyuan.dragElement?d.classList.add("dragover__left"):s.clientX>_.right-_.width/2&&s.clientX<=_.right+1&&!d.classList.contains("av__row")&&d!==window.siyuan.dragElement.previousElementSibling&&(window.siyuan.dragElement.previousElementSibling.classList.contains("av__colsticky")&&d===window.siyuan.dragElement.previousElementSibling.lastElementChild||d.classList.add("dragover__right"));return}if(d.classList.contains("av__gallery-item")){const k=_.left+_.width/2;s.clientX<k&&s.clientX>_.left-13?d.classList.add("dragover__left"):s.clientX>k&&s.clientX<=_.right+13&&d.classList.add("dragover__right");return}if(d.classList.contains("av__gallery-add")){d.classList.add("dragover__left");return}s.clientX<_.left+32&&s.clientX>=_.left-1&&!d.classList.contains("av__row")?(d.classList.add("dragover__left"),vt(d)):s.clientX>_.right-32&&s.clientX<_.right&&!d.classList.contains("av__row")?(d.classList.add("dragover__right"),vt(d)):d.classList.contains("av__row--header")?d.classList.add("dragover__bottom"):d.classList.contains("av__row--util")?d.previousElementSibling.classList.add("dragover__bottom"):s.clientY>_.top+_.height/2&&n!=="bottom"?(d.classList.add("dragover__bottom"),vt(d)):n!=="top"&&(d.classList.add("dragover__top"),vt(d));return}if(b.indexOf("-")>-1){b.split(",").includes(e.block.rootID)&&y&&s.altKey?(a=void 0,t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(_=>{_.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),_.removeAttribute("select-start"),_.removeAttribute("select-end")})):a=d;return}if(g){if(n="",f[0]==="nodeattributeview"&&f[1]==="col"&&d.getAttribute("data-id")===f[2]){Et(a);return}if(f[0]==="nodeattributeviewrowmenu"&&f[2].split("@")[0]===d.getAttribute("data-id")){Et(a);return}if(f[2].split(",").find(k=>{if(k&&hasClosestByAttribute(d,"data-node-id",k))return!0})&&f[0]!=="nodeattributeviewrowmenu"){Et(a);return}if(isInEmbedBlock(d)){Et(a);return}if(f[0]==="nodelistitem"&&d.getAttribute("data-type")==="NodeListItem"){if(f[1]!==d.getAttribute("data-subtype")){Et(a);return}if(Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")).find(x=>{if(!x.classList.contains("li"))return!0})){Et(a);return}}if(f[0]!=="nodelistitem"&&d.getAttribute("data-type")==="NodeListItem"){Et(a);return}f[0]==="nodelistitem"&&d.parentElement.classList.contains("li")&&((c=d.previousElementSibling)!=null&&c.classList.contains("protyle-action"))&&(n="top"),f[0]==="nodelistitem"&&((u=d.nextElementSibling)!=null&&u.classList.contains("list"))&&(n="bottom"),d&&d.classList.contains("av__row--header")&&(n="top"),a=d}});let i=0;t.addEventListener("dragleave",s=>{if(e.disabled){s.preventDefault(),s.stopPropagation();return}i--,i===0&&(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(o=>{o.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover")}),a=void 0)}),t.addEventListener("dragenter",s=>{s.preventDefault(),i++}),t.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0,document.onmousemove=null)})},vt=e=>{(e.classList.contains("sb")||e.classList.contains("li")||e.classList.contains("list")||e.classList.contains("bq"))&&e.classList.add("dragover")},Et=e=>{e&&(e.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),e=void 0)},Pu=(e,t,a)=>{if(!t.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.isComposing)return!0;if(matchHotKey("\u2318B",e)||matchHotKey("\u2318I",e)||matchHotKey("\u2318U",e))return e.preventDefault(),!0;const n=t.querySelector(".av__cell--select");if(n){const s=hasClosestByClassName(n,"av__row");if(!s||s.dataset.type==="ghost")return!1;const o=document.querySelector(".av__panel");if(o&&(e.key==="Backspace"||e.key==="Delete"||e.key==="Escape"||e.key.startsWith("ArrowLeft")||e.key==="Enter"||matchHotKey("\u21E5",e)||matchHotKey("\u21E7\u21E5",e)))return o.remove(),e.preventDefault(),e.stopPropagation(),!0;if(e.key==="Backspace"||e.key==="Delete")return updateCellsValue(a,t,void 0,Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select"))),e.preventDefault(),!0;if(e.key==="Escape")return clearSelect(["cell"],t),selectRow(s.querySelector(".av__firstcol"),"select"),e.preventDefault(),!0;if(e.key==="Enter")return popTextCell(a,[n]),e.preventDefault(),!0;let l;if(e.key==="ArrowLeft"||matchHotKey("\u21E7\u21E5",e)){const r=s.previousElementSibling;if(n.previousElementSibling&&!n.previousElementSibling.classList.contains("av__firstcol")&&(n.previousElementSibling.classList.contains("av__colsticky")?(l=n.previousElementSibling.lastElementChild,l.classList.contains("av__firstcol")&&(l=void 0)):n.previousElementSibling.classList.contains("av__cell")&&(l=n.previousElementSibling)),!l&&r&&!r.classList.contains("av__row--header")){const c=r.querySelectorAll(".av__cell");l=c[c.length-1]}return l&&(clearSelect(["cell"],t),l.classList.add("av__cell--select"),addDragFill(l),cellScrollIntoView(t,l,!1)),e.preventDefault(),!0}if(e.key==="ArrowRight"||matchHotKey("\u21E5",e)){const r=s.nextElementSibling;return n.nextElementSibling&&n.nextElementSibling.classList.contains("av__cell")?l=n.nextElementSibling:!n.nextElementSibling&&n.parentElement.nextElementSibling?l=n.parentElement.nextElementSibling:r&&!r.classList.contains("av__row--footer")&&(l=r.querySelector(".av__cell")),l?(clearSelect(["cell"],t),l.classList.add("av__cell--select"),addDragFill(l),cellScrollIntoView(t,l,!1)):e.key!=="ArrowRight"&&(clearSelect(["cell"],t),insertRows({blockElement:t,protyle:a,count:1,previousID:s.getAttribute("data-id"),groupID:s.parentElement.getAttribute("data-group-id")})),e.preventDefault(),!0}if(e.key==="ArrowUp"){const r=s.previousElementSibling;return r&&!r.classList.contains("av__row--header")&&(l=r.querySelector(`.av__cell[data-col-id="${n.dataset.colId}"]`)),l&&(clearSelect(["cell"],t),l.classList.add("av__cell--select"),addDragFill(l),cellScrollIntoView(t,l)),e.preventDefault(),!0}if(e.key==="ArrowDown"){const r=s.nextElementSibling;return r&&!r.classList.contains("av__row--footer")&&(l=r.querySelector(`.av__cell[data-col-id="${n.dataset.colId}"]`)),l&&(clearSelect(["cell"],t),l.classList.add("av__cell--select"),addDragFill(l),cellScrollIntoView(t,l)),e.preventDefault(),!0}if(!Constants.KEYCODELIST[e.keyCode]||Constants.KEYCODELIST[e.keyCode].length===1&&!e.metaKey&&!e.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(Constants.KEYCODELIST[e.keyCode]))return n.style.backgroundColor?e.preventDefault():popTextCell(a,[n]),!0}const i=t.querySelectorAll(".av__row--select:not(.av__row--header)");if(i.length>0){if(matchHotKey("\u2318/",e))return e.stopPropagation(),e.preventDefault(),avContextmenu(a,i[0],{x:t.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:i[0].getBoundingClientRect().bottom}),!0;if(e.key==="Escape")return e.preventDefault(),selectRow(i[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(e.key==="Backspace")return e.preventDefault(),deleteRow(t,a),!0;if(e.key==="Enter")return selectRow(i[0].querySelector(".av__firstcol"),"unselectAll"),popTextCell(a,[i[0].querySelector(".av__cell")]),e.preventDefault(),!0;if(e.key==="ArrowUp"){const s=i[0].previousElementSibling;return selectRow(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--header")?(selectRow(s.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,s)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}if(e.key==="ArrowDown"){const s=i[i.length-1].nextElementSibling;return selectRow(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--util")?(selectRow(s.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,s)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}}return!1},Ru=e=>{const t=document.querySelector(".av__panel");if(t&&window.siyuan.menus.menu.element.classList.contains("fn__none")&&(t.querySelector('[data-type="goSearchRollupCol"]')&&!t.querySelector(".b3-text-field")||t.querySelector('[data-type="addAssetExist"]'))){const a=t.querySelector(".b3-menu__items");if(e.key==="Enter"){const n=a.querySelector(".b3-menu__item--current");if(n){const i=n.querySelector('[data-type="editAssetItem"]'),s=n.querySelector(".b3-form__upload");return i?t.dispatchEvent(new CustomEvent("click",{detail:{type:i.getAttribute("data-type"),target:i}})):s?s.dispatchEvent(new MouseEvent("click",{bubbles:!0})):t.dispatchEvent(new CustomEvent("click",{detail:{type:n.getAttribute("data-type"),target:n}})),!0}}else{if(e.key==="Escape")return t.dispatchEvent(new CustomEvent("click",{detail:"close"})),!0;if(upDownHint(a,e,"b3-menu__item--current",a.firstElementChild))return!0}}return!1},Ou=e=>{var t;if(e.command==="switchReadonly")return updateReadonly(e.protyle.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),e.protyle),!0;if(e.command==="switchAdjust"){let n;const i=e.protyle.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_FULLWIDTH);return i?n=i==="true"?"false":"true":n=window.siyuan.config.editor.fullWidth?"false":"true",fetchPost("/api/attr/setBlockAttrs",{id:e.protyle.block.rootID,attrs:{[Constants.CUSTOM_SY_FULLWIDTH]:n}}),!0}const a=hasClosestBlock(e.previousRange.startContainer);if(!a)return!1;if(e.command==="enter"){let n=getTopAloneElement(a);n.parentElement.classList.contains("li")&&n.parentElement.parentElement.classList.contains("list")&&((t=n.nextElementSibling)!=null&&t.classList.contains("list"))&&n.previousElementSibling.classList.contains("protyle-action")&&(n=n.parentElement);const i=n.getAttribute("data-node-id");return e.protyle.options.backlinkData||zoomOut({protyle:e.protyle,id:i}),!0}return e.command==="enterBack"?(enterBack(e.protyle,a.getAttribute("data-node-id")),!0):!1};var lo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Ns=(e,t)=>{let a="";Array.from(e.cloneContents().childNodes).forEach(n=>{n.nodeType===3?a+=n.textContent:a+=n.outerHTML}),fetchPost("/api/block/getDOMText",{dom:a},n=>{t(n.data)})},qu=(e,t)=>{t.addEventListener("keydown",a=>lo(void 0,null,function*(){var n,i,s,o,l,r,c,u,g,m;if(a.target.localName==="protyle-html"||a.target.localName==="input"){a.stopPropagation();return}if(e.disabled||!e.selectElement.classList.contains("fn__none")){a.stopPropagation(),a.preventDefault();return}e.wysiwyg.preventKeyup=!1,hideElements(["util"],e),a.shiftKey&&a.key.indexOf("Arrow")>-1||!a.repeat&&a.code!==""&&hideElements(["toolbar"],e);const d=getEditorRange(e.wysiwyg.element),f=hasClosestBlock(d.startContainer);if(!f)return;const b=hasClosestBlock(d.endContainer);if(!matchHotKey("\u2318C",a)&&b&&f!==b){a.stopPropagation(),a.preventDefault();return}if(document.querySelector(".av__panel")||avKeydown(a,f,e))return;if(f.classList.contains("protyle-wysiwyg--select")&&isNotCtrl(a)&&!a.shiftKey&&!a.altKey){if(a.key.toLowerCase()==="a")return a.stopPropagation(),a.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"afterend")},100),!1;if(a.key.toLowerCase()==="b")return a.stopPropagation(),a.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"beforebegin")},100),!1}if(a.isComposing){a.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(Constants.KEYCODELIST[a.keyCode])||(Constants.KEYCODELIST[a.keyCode]==="/"||a.key==="/"||a.code==="Slash"&&a.key==="Process"&&a.keyCode===229?e.hint.enableSlash=!0:(Constants.KEYCODELIST[a.keyCode]==="\\"||a.key==="\\"||a.key===","&&a.keyCode===229||a.code==="Backslash"&&a.key==="Process"&&a.keyCode===229)&&(e.hint.enableSlash=!1,hideElements(["hint"],e))),a.key!=="PageUp"&&a.key!=="PageDown"&&a.key!=="Home"&&a.key!=="End"&&a.key.indexOf("Arrow")===-1&&a.key!=="Escape"&&a.key!=="Shift"&&a.key!=="Meta"&&a.key!=="Alt"&&a.key!=="Control"&&a.key!=="CapsLock"&&!isNotEditBlock(f)&&!/^F\d{1,2}$/.test(a.key)&&a.key!=="Process"&&(setInsertWbrHTML(f,d,e),e.wysiwyg.preventKeyup=!0),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(Constants.KEYCODELIST[a.keyCode])||Constants.KEYCODELIST[a.keyCode]==="\u21A9")&&!a.altKey&&!a.shiftKey&&isNotCtrl(a)){a.preventDefault();return}else a.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(a.key)&&e.options.render.breadcrumb&&e.breadcrumb.hide(),!a.altKey&&!a.shiftKey&&isNotCtrl(a)&&(a.key==="ArrowDown"||a.key==="ArrowUp")){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(w.length>0){if(a.preventDefault(),a.stopPropagation(),hideElements(["select"],e),a.key==="ArrowDown"){const v=w[w.length-1];let h=getNextBlock(v);if(h)if(h.getBoundingClientRect().width===0){const C=hasTopClosestByAttribute(h,"fold","1");C?(h=getNextBlock(C),h?h=getFirstBlock(h):h=v):h=v}else h.getAttribute("fold")==="1"&&(h.classList.contains("sb")||h.classList.contains("bq"))||(h=getFirstBlock(h));else h=v;h.classList.add("protyle-wysiwyg--select"),countBlockWord([h.getAttribute("data-node-id")]);const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1),focusBlock(h)}else if(a.key==="ArrowUp"){let v=getPreviousBlock(w[0]);if(v){if(v=getLastBlock(v),v.getBoundingClientRect().width===0){const h=hasTopClosestByAttribute(v,"fold","1");h?v=getFirstBlock(h):v=w[0]}else if(v){const h=hasTopClosestByAttribute(v,"fold","1");h&&(h.classList.contains("sb")||h.classList.contains("bq"))&&(v=h)}}else if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const h=setLastNodeRange(e.title.editElement,d,!1);h.collapse(!1),focusByRange(h),a.stopPropagation(),a.preventDefault()}else e.contentElement.scrollTop!==0?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):v=w[0];if(v){v.classList.add("protyle-wysiwyg--select"),countBlockWord([v.getAttribute("data-node-id")]);const h=v.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1),focusBlock(v)}}return}}if(a.key!=="PageUp"&&a.key!=="PageDown"&&a.key!=="Home"&&a.key!=="End"&&a.key.indexOf("Arrow")===-1&&isNotCtrl(a)&&a.key!=="Escape"&&!a.shiftKey&&!a.altKey&&!/^F\d{1,2}$/.test(a.key)&&a.key!=="Enter"&&a.key!=="Tab"&&a.key!=="Backspace"&&a.key!=="Delete"&&a.key!=="ContextMenu")return a.stopPropagation(),hideElements(["select"],e),f&&getContenteditableElement(f)&&d.endContainer.nodeType===1&&d.endContainer.classList.contains("protyle-attr")&&d.collapse(!0),!1;if(matchHotKey(window.siyuan.config.keymap.editor.general.collapse.custom,a)&&!a.repeat){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return w.length>0?setFold(e,w[0]):f.parentElement.getAttribute("data-type")==="NodeListItem"?f.parentElement.childElementCount>3?setFold(e,f.parentElement):setFold(e,f):f.getAttribute("data-type")==="NodeHeading"?setFold(e,f):setFold(e,getTopAloneElement(f)),a.stopPropagation(),a.preventDefault(),!1}if(matchHotKey(window.siyuan.config.keymap.editor.general.expand.custom,a)&&!a.repeat){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");w.length>0?setFold(e,w[0],!0):f.parentElement.getAttribute("data-type")==="NodeListItem"?f.parentElement.childElementCount>3?setFold(e,f.parentElement,!0):setFold(e,f,!0):f.getAttribute("data-type")==="NodeHeading"?setFold(e,f,!0):setFold(e,getTopAloneElement(f),!0),a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,a)){upSelect({protyle:e,event:a,nodeElement:f,editorElement:t,range:d,cb(w){const v=w[0].previousElementSibling;if(v&&v.getAttribute("data-node-id")){v.classList.add("protyle-wysiwyg--select"),w.forEach(E=>{E.removeAttribute("select-end")}),v.setAttribute("select-end","true");const h=v.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else w[0].parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),w[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,a)){downSelect({protyle:e,event:a,nodeElement:f,editorElement:t,range:d,cb(w){const v=w[w.length-1],h=v.nextElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),w.forEach(C=>{C.removeAttribute("select-end")}),h.setAttribute("select-end","true");const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else v.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),v.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey("\u21E7\u2191",a)){upSelect({protyle:e,event:a,nodeElement:f,editorElement:t,range:d,cb(w){const v=getStartEndElement(w);if(v.startElement.getBoundingClientRect().top>=v.endElement.getBoundingClientRect().top){const h=v.endElement.previousElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),v.endElement.removeAttribute("select-end");const E=h.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;E<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else v.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),v.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{v.endElement.classList.remove("protyle-wysiwyg--select"),v.endElement.removeAttribute("select-end");const h=getPreviousBlock(v.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().top<=e.contentElement.getBoundingClientRect().top&&(preventScroll(e),h.scrollIntoView(!0)))}}});return}if(matchHotKey("\u21E7\u2193",a)){downSelect({protyle:e,event:a,nodeElement:f,editorElement:t,range:d,cb(w){const v=getStartEndElement(w);if(v.startElement.getBoundingClientRect().top<=v.endElement.getBoundingClientRect().top){const h=v.endElement.nextElementSibling;if(h&&h.getAttribute("data-node-id"))if(h.getBoundingClientRect().width===0)hideElements(["select"],e),v.endElement.parentElement.classList.add("protyle-wysiwyg--select");else{h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),v.endElement.removeAttribute("select-end");const E=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else v.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),v.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{v.endElement.classList.remove("protyle-wysiwyg--select"),v.endElement.removeAttribute("select-end");const h=getNextBlock(v.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().bottom>=e.contentElement.getBoundingClientRect().bottom&&(preventScroll(e),h.scrollIntoView(!1)))}}});return}if(matchHotKey(window.siyuan.config.keymap.general.enter.custom,a)){onlyProtyleCommand({protyle:e,command:"enter",previousRange:d}),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.general.enterBack.custom,a)){onlyProtyleCommand({protyle:e,command:"enterBack",previousRange:d}),a.preventDefault(),a.stopPropagation();return}if(a.shiftKey&&!a.altKey&&isNotCtrl(a)&&(a.key==="Home"||a.key==="End")&&isMac()||a.shiftKey&&!a.altKey&&isOnlyMeta(a)&&(a.key==="Home"||a.key==="End")&&!isMac()){const w=hasTopClosestByAttribute(f,"data-node-id",null);if(w){w.querySelectorAll(".protyle-wysiwyg--select").forEach(h=>{h.classList.remove("protyle-wysiwyg--select")}),w.classList.add("protyle-wysiwyg--select");let v=a.key==="Home"?w.previousElementSibling:w.nextElementSibling;for(;v;)v.classList.add("protyle-wysiwyg--select"),v=a.key==="Home"?v.previousElementSibling:v.nextElementSibling;a.key==="Home"?e.wysiwyg.element.firstElementChild.scrollIntoView():e.wysiwyg.element.lastElementChild.scrollIntoView(!1)}a.stopPropagation(),a.preventDefault();return}if((a.key==="Home"||a.key==="End")&&!a.shiftKey&&!a.altKey&&isNotCtrl(a)&&hideElements(["hint"],e),!a.altKey&&!a.shiftKey&&isNotCtrl(a)&&(a.key==="PageUp"||a.key==="PageDown")){a.key==="PageUp"?(e.contentElement.scrollTop=e.contentElement.scrollTop-e.contentElement.clientHeight+60,e.scroll.lastScrollTop=e.contentElement.scrollTop+1):(e.contentElement.scrollTop=e.contentElement.scrollTop+e.contentElement.clientHeight-60,e.scroll.lastScrollTop=e.contentElement.scrollTop-1);const w=e.contentElement.getBoundingClientRect();let v=document.elementFromPoint(w.x+w.width/2,w.y+w.height/2);v.classList.contains("protyle-wysiwyg")&&(v=document.elementFromPoint(w.x+w.width/2,w.y+w.height/2+Constants.SIZE_TOOLBAR_HEIGHT));const h=hasClosestBlock(v);h&&h!==f&&focusBlock(h,void 0,!1),a.stopPropagation(),a.preventDefault();return}if(!a.altKey&&!a.shiftKey&&(a.key.indexOf("Arrow")>-1&&isNotCtrl(a)||a.key==="Enter")&&!e.hint.element.classList.contains("fn__none")&&e.hint.select(a,e))return;if(matchHotKey("\u2318/",a)){a.stopPropagation(),a.preventDefault();const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===0){const h=hasClosestByAttribute(d.startContainer,"data-type",null);if(h&&h.tagName==="SPAN"){const E=h.getAttribute("data-type").split(" ");if(E.length>0&&(e.toolbar.range=d,removeSearchMark(h)),E.includes("block-ref")){refMenu(e,h);return}else if(E.includes("inline-memo")){e.toolbar.showRender(e,h);return}else if(E.includes("file-annotation-ref")){fileAnnotationRefMenu(e,h);return}else if(E.includes("a")){linkMenu(e,h);return}else if(E.includes("tag")){tagMenu(e,h);return}}if(d.startOffset===0&&d.startContainer.nodeType===3){const E=hasPreviousSibling(d.startContainer);if(E&&E.nodeType!==3&&((n=E.getAttribute("data-type"))==null?void 0:n.indexOf("inline-math"))>-1){inlineMathMenu(e,E);return}else if(!E&&d.startContainer.parentElement.previousSibling&&d.startContainer.parentElement.previousSibling===d.startContainer.parentElement.previousElementSibling&&((i=d.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){inlineMathMenu(e,d.startContainer.parentElement.previousElementSibling);return}}w.push(f)}w.length===1?e.gutter.renderMenu(e,w[0]):e.gutter.renderMultipleMenu(e,w);const v=f.getBoundingClientRect();window.siyuan.menus.menu.popup({x:v.left,y:v.top,isLeft:!0});return}if(fixTable(e,a,d)){a.preventDefault();return}const p=d.toString();if(!a.altKey&&!a.shiftKey&&isNotCtrl(a)&&!a.isComposing&&a.key.indexOf("Arrow")>-1){const w=hasClosestByTag(d.startContainer,"TD")||hasClosestByTag(d.startContainer,"TH"),v=w||getContenteditableElement(f)||f,h=getSelectionOffset(v,e.wysiwyg.element,d);if(f.classList.contains("code-block")&&h.end===v.innerText.length&&(h.end-=1),a.key==="ArrowDown"&&(v==null?void 0:v.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&(w&&!w.parentElement.nextElementSibling&&f.getAttribute("data-type")==="NodeTable"&&!getNextBlock(f)||f.getAttribute("data-type")==="NodeCodeBlock"&&!getNextBlock(f)||f.parentElement.getAttribute("data-type")==="NodeBlockquote"&&f.nextElementSibling.classList.contains("protyle-attr")&&!getNextBlock(f.parentElement)))f.parentElement.getAttribute("data-type")==="NodeBlockquote"?insertEmptyBlock(e,"afterend",f.parentElement.getAttribute("data-node-id")):insertEmptyBlock(e,"afterend",f.getAttribute("data-node-id"));else if(a.key==="ArrowUp"){const E=getContenteditableElement(e.wysiwyg.element.firstElementChild);if(!getPreviousBlock(f)&&f.contains(E)||!E&&f===e.wysiwyg.element.firstElementChild){if(getSelectionPosition(v,d).top-v.getBoundingClientRect().top<20||f.classList.contains("av"))if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const C=setLastNodeRange(e.title.editElement,d,!1);C.collapse(!1),focusByRange(C),a.stopPropagation(),a.preventDefault()}else e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8}else if(((v==null?void 0:v.innerText.substr(0,h.end).indexOf(`
`))===-1||h.start===0)&&getSelectionPosition(v,d).top-v.getBoundingClientRect().top<20){let C=getPreviousBlock(f);if(C&&(C=getLastBlock(C),C)){const A=hasTopClosestByAttribute(C,"fold","1");if(!A&&C.classList.contains("code-block"))focusBlock(C,void 0,!1),scrollCenter(e,C),a.stopPropagation(),a.preventDefault();else if(A)A.scrollTop=0,focusBlock(A,void 0,!0),scrollCenter(e,A),a.stopPropagation(),a.preventDefault();else{const S=getContenteditableElement(C);if(S&&((s=S.lastChild)==null?void 0:s.nodeType)===3&&((o=S.lastChild)!=null&&o.textContent.endsWith(`
`))){focusBlock(C,void 0,!1),a.preventDefault(),a.stopPropagation();return}}}}}else if(p===""&&(a.key==="ArrowDown"||a.key==="ArrowRight")&&f===getLastBlock(e.wysiwyg.element.lastElementChild)&&!hasClosestByTag(d.startContainer,"TD")&&!hasClosestByTag(d.startContainer,"TH")){const E=getContenteditableElement(f);E&&!E.querySelector(".emoji")&&E.textContent.replace(/\n$/,"").length<=getSelectionOffset(E,void 0,d).end&&(a.stopPropagation(),a.preventDefault(),focusByRange(d))}else if(p===""&&a.key==="ArrowLeft"&&f===getFirstBlock(e.wysiwyg.element.firstElementChild)){const E=getContenteditableElement(f);E&&getSelectionOffset(E,void 0,d).start===0&&(a.stopPropagation(),a.preventDefault(),focusByRange(d))}if(a.key==="ArrowDown"){if((v==null?void 0:v.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&f===e.wysiwyg.element.lastElementChild){setLastNodeRange(getContenteditableElement(v),d,!1),d.collapse(!1),a.stopPropagation(),a.preventDefault();return}const E=hasClosestByAttribute(d.startContainer,"fold","1");if(E){let C=getNextBlock(E);C&&(C.getAttribute("fold")==="1"&&(C.classList.contains("sb")||C.classList.contains("bq"))||(C=getFirstBlock(C)),focusBlock(C),scrollCenter(e,C)),a.stopPropagation(),a.preventDefault()}else if((v==null?void 0:v.innerText.substr(h.end).indexOf(`
`))===-1||h.end>=v.innerText.trimEnd().length){d.collapse(!1);const C=getNextBlock(f);C&&(C.getAttribute("fold")==="1"||C.classList.contains("code-block"))&&v.getBoundingClientRect().bottom-getSelectionPosition(f,d).top<40&&(focusBlock(C),scrollCenter(e,C),a.stopPropagation(),a.preventDefault())}}return}if(!a.altKey&&(a.key==="Backspace"||a.key==="Delete")||matchHotKey("\u2303D",a)){if(e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){removeBlock(e,f,d,a.key==="Backspace"?"Backspace":"Delete"),a.stopPropagation(),a.preventDefault();return}if(p===""&&a.key==="Backspace"&&d.startOffset===d.startContainer.textContent.length&&d.startContainer.textContent.endsWith(`
`+Constants.ZWSP)){d.setStart(d.startContainer,d.startOffset-1),d.collapse(!0),a.stopPropagation(),a.preventDefault();return}const w=hasPreviousSibling(d.startContainer);if(d.startOffset===1&&d.startContainer.textContent===Constants.ZWSP&&w&&w.nodeType!==3&&a.key==="Backspace"){if(w.classList.contains("img"))w.classList.add("img--select");else if(((l=w.getAttribute("data-type"))==null?void 0:l.indexOf("inline-math"))>-1){w.after(document.createElement("wbr"));const E=f.outerHTML;d.startContainer.textContent="",w.remove(),updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,E),focusByWbr(f,d),a.stopPropagation(),a.preventDefault();return}}const v=getContenteditableElement(f),h=e.wysiwyg.element.querySelector(".img--select");if(h){if(h.classList.remove("img--select"),f.contains(h)){removeImage(h,f,d,e),a.stopPropagation(),a.preventDefault();return}}else if(p===""){if(f.classList.contains("table")&&f.querySelector(".table__select").clientHeight>0){clearTableCell(e,f),a.stopPropagation(),a.preventDefault();return}if(!v){f.classList.add("protyle-wysiwyg--select"),removeBlock(e,f,d,a.key==="Backspace"?"Backspace":"Delete"),a.stopPropagation(),a.preventDefault();return}const E=getSelectionOffset(v,e.wysiwyg.element,d);if(a.key==="Delete"||matchHotKey("\u2303D",a)){if(d.startOffset===0&&d.startContainer.textContent.length===1){const C=hasPreviousSibling(d.startContainer),A=hasNextSibling(d.startContainer);if(C&&C.nodeType===1&&C.classList.contains("img")&&A&&A.nodeType===1&&A.classList.contains("img")){const S=document.createElement("wbr");d.insertNode(S);const L=f.outerHTML;S.nextSibling.textContent=Constants.ZWSP,updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,L),focusByWbr(f,d),a.preventDefault();return}if(E.start===0&&d.startContainer.textContent!==Constants.ZWSP&&!C&&A&&A.nodeType===1&&A.classList.contains("img")){const S=document.createElement("wbr");d.insertNode(S);const L=f.outerHTML;S.nextSibling.textContent=Constants.ZWSP,updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,L),focusByWbr(f,d),a.preventDefault();return}}if(isEndOfBlock(d)||v.textContent.substring(E.start)===`
`){const C=d.cloneRange(),A=getNextBlock(getTopAloneElement(f));if(A){const S=focusBlock(A);if(S){const L=hasClosestBlock(S.startContainer);L&&(!L.classList.contains("code-block")||L.classList.contains("code-block")&&getContenteditableElement(L).textContent==`
`||L.parentElement.classList.contains("li"))&&(C.insertNode(document.createElement("wbr")),removeBlock(e,L,S,"Delete"))}a.stopPropagation(),a.preventDefault();return}}else if(E.end===v.innerText.length-1&&f.getAttribute("data-type")==="NodeCodeBlock"){a.stopPropagation(),a.preventDefault();return}else{let C=hasNextSibling(d.startContainer);if(C){if(C.nodeType===3&&C.textContent===Constants.ZWSP){if(!C.nextSibling){const A=getNextBlock(f);A&&removeBlock(e,A,d,"remove"),a.stopPropagation(),a.preventDefault();return}C=C.nextSibling}if(C.nodeType===1&&C.classList.contains("img")&&getSelectionOffset(d.startContainer,e.wysiwyg.element,d).start===d.startContainer.textContent.length){removeImage(C,f,d,e),a.stopPropagation(),a.preventDefault();return}}}}else{const C=d.startContainer.childNodes[d.startOffset-1];if(E.start===0&&(d.startOffset===0||C&&C.nodeType===3&&!hasPreviousSibling(C)&&C.textContent==="")){(!f.classList.contains("code-block")||f.classList.contains("code-block")&&(v.textContent==`
`||f.parentElement.classList.contains("li")))&&removeBlock(e,f,d,"Backspace"),a.stopPropagation(),a.preventDefault();return}if(d.startContainer.nodeType!==3&&f.getAttribute("data-type")==="NodeTable"&&((r=d.startContainer.children[d.startOffset-1])==null?void 0:r.tagName)==="TABLE"){f.classList.add("protyle-wysiwyg--select"),removeBlock(e,f,d,"Backspace"),a.stopPropagation(),a.preventDefault();return}if(C&&C.nodeType!==3&&C.classList.contains("img")){removeImage(C,f,d,e),a.stopPropagation(),a.preventDefault();return}const A=hasNextSibling(d.startContainer);if(A&&A.nodeType===1&&["code","tag","kbd"].includes(A.dataset.type)&&(E.start===1||d.startContainer.textContent.slice(-2,-1)===`
`)&&(d.insertNode(document.createTextNode(Constants.ZWSP)),d.collapse(!0)),d.startOffset===1&&d.startContainer.textContent.length===1){const L=hasPreviousSibling(d.startContainer);if(L&&L.nodeType===1&&L.classList.contains("img")&&A&&A.nodeType===1&&A.classList.contains("img")){const $=document.createElement("wbr");d.insertNode($);const R=f.outerHTML;$.previousSibling.textContent=Constants.ZWSP,updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,R),focusByWbr(f,d),a.preventDefault();return}if(E.start===1&&d.startContainer.textContent!==Constants.ZWSP&&!L&&A&&A.nodeType===1&&A.classList.contains("img")){const $=document.createElement("wbr");d.insertNode($);const R=f.outerHTML;$.previousSibling.textContent=Constants.ZWSP,updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,R),focusByWbr(f,d),a.preventDefault();return}}if(f.classList.contains("code-block")&&isOnlyMeta(a)&&d.startContainer.nodeType===3&&d.startContainer.textContent.substring(d.startOffset-1,d.startOffset)===`
`){a.stopPropagation(),a.preventDefault();return}const S=hasClosestByTag(d.startContainer,"SPAN");if(E.start===2&&S&&getSelectionOffset(S,e.wysiwyg.element,d).start===1&&S.innerText.startsWith(Constants.ZWSP)&&S.innerText!==Constants.ZWSP&&v.innerText.startsWith(Constants.ZWSP)){focusBlock(f),a.stopPropagation(),a.preventDefault();return}if(E.start===1&&!S&&v.innerText.startsWith(Constants.ZWSP)&&v.innerText.length>1){setFirstNodeRange(v,d),removeBlock(e,f,d,"Backspace"),a.stopPropagation(),a.preventDefault();return}}}else if(f.classList.contains("code-block")&&v.textContent===`
`){d.collapse(!0),a.stopPropagation(),a.preventDefault();return}else if(p!==""){const E=getSelectionOffset(v,e.wysiwyg.element,d);if(d.startOffset===0&&d.endContainer.textContent.length===d.endOffset){const C=hasPreviousSibling(d.startContainer),A=hasNextSibling(d.endContainer);if(C&&C.nodeType===1&&C.classList.contains("img")&&A&&A.nodeType===1&&A.classList.contains("img")||E.start===0&&d.startContainer.textContent!==Constants.ZWSP&&!C&&A&&A.nodeType===1&&A.classList.contains("img")){d.insertNode(document.createElement("wbr"));const S=f.outerHTML;d.deleteContents(),d.insertNode(document.createTextNode(Constants.ZWSP)),d.insertNode(document.createElement("wbr")),updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,S),focusByWbr(f,d),a.preventDefault();return}}}}if(matchHotKey("\u21E7\u21A9",a)&&p===""&&softEnter(d,f,e)){a.stopPropagation(),a.preventDefault();return}if(matchHotKey("\u2325\u21A9",a)&&p===""){const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===0&&w.push(f),w.length>0&&!isIncludesHotKey("\u2325\u21A9")){if(w.find(h=>!h.classList.contains("code-block")))addSubList(e,f,d);else{const h=[];w.forEach(E=>{h.push(E.querySelector(".protyle-action__language"))}),e.toolbar.showCodeLanguage(e,h)}a.stopPropagation(),a.preventDefault();return}}if(matchHotKey("\u21A9",a)){enter(f,d,e),a.stopPropagation(),a.preventDefault();return}if(matchHotKey("\u2318A",a))return a.preventDefault(),selectAll(e,f,d),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.undo.custom,a)){e.undo.undo(e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.redo.custom,a)){e.undo.redo(e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyText.custom,a)){if(p!=="")Ns(d,w=>{writeText(`${w.trim()} ((${f.getAttribute("data-node-id")} "*"))`)});else{const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");w.length>0?(w[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(f)),document.execCommand("copy")):writeText(`((${f.getAttribute("data-node-id")} "*"))`)}return a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.attr.custom,a)){const w=getTopAloneElement(f);if(p===""){const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;v.length===1?h=v[0]:h=w,openAttr(h,"bookmark",e)}else Ns(d,v=>{const h=w.outerHTML,E=w.lastElementChild.querySelector(".protyle-attr--name");E?E.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${v.trim()}`:w.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${v.trim()}</div>`),w.setAttribute("name",v.trim()),updateTransaction(e,w.getAttribute("data-node-id"),w.outerHTML,h)});return a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.rename.custom,a)&&!e.disabled){p===""?fetchPost("/api/block/getDocInfo",{id:e.block.rootID},w=>{rename({notebookId:e.notebookId,path:e.path,name:w.data.ial.title,range:d,type:"file"})}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:replaceFileName(p)}),a.preventDefault(),a.stopPropagation();return}const y=matchHotKey(window.siyuan.config.keymap.editor.general.newNameFile.custom,a);if(y||matchHotKey(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,a)){!p.trim()&&(f.querySelector("tr")||f.querySelector("span"))||(!p.trim()&&getContenteditableElement(f).textContent&&selectAll(e,f,d),y?fetchPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:e.path},w=>{newFileBySelect(e,p,f,w.data,e.notebookId)}):getSavePath(e.path,e.notebookId,(w,v)=>{newFileBySelect(e,p,f,w,v)})),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.newContentFile.custom,a)){newFileContentBySelect(e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,a)){const w=f.querySelectorAll(".img--select");if(w.length>0)alignImgLeft(e,f,Array.from(w),f.getAttribute("data-node-id"),f.outerHTML);else{let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[f]),updateBatchTransaction(v,e,h=>{h.classList.contains("av")?h.style.justifyContent="":h.style.textAlign="left"})}a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,a)){const w=f.querySelectorAll(".img--select");if(w.length>0)alignImgCenter(e,f,Array.from(w),f.getAttribute("data-node-id"),f.outerHTML);else{let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[f]),updateBatchTransaction(v,e,h=>{h.classList.contains("av")?h.style.justifyContent="center":h.style.textAlign="center"})}a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,a)){let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[f]),updateBatchTransaction(w,e,v=>{v.classList.contains("av")?v.style.justifyContent="flex-end":v.style.textAlign="right"}),a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.rtl.custom,a)){let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[f]),updateBatchTransaction(w,e,v=>{v.style.direction="rtl"}),a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.ltr.custom,a)){let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[f]),updateBatchTransaction(w,e,v=>{v.style.direction="ltr"}),a.stopPropagation(),a.preventDefault();return}if(a.key==="Escape"){if(a.repeat){const w=hasClosestByClassName(d.startContainer,"card__main",!0);w&&document.activeElement&&document.activeElement.classList.contains("protyle-wysiwyg")&&(w.querySelector(".card__action:not(.fn__none) button:not([disabled])").focus(),hideElements(["select"],e))}else!e.toolbar.element.classList.contains("fn__none")||!e.hint.element.classList.contains("fn__none")||!e.toolbar.subElement.classList.contains("fn__none")?(hideElements(["toolbar","hint","util"],e),e.hint.enableExtend=!1):window.siyuan.menus.menu.element.classList.contains("fn__none")?f.classList.contains("protyle-wysiwyg--select")?(hideElements(["select"],e),countBlockWord([],e.block.rootID)):(hideElements(["select"],e),d.collapse(!1),f.classList.add("protyle-wysiwyg--select"),countBlockWord([f.getAttribute("data-node-id")],e.block.rootID)):window.siyuan.menus.menu.remove(!0);a.stopPropagation(),a.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.heading.paragraph.custom,a)){const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===0&&w.push(f),w.length>1)turnsIntoTransaction({protyle:e,nodeElement:w[0],type:"Blocks2Ps"});else{const v=w[0].getAttribute("data-type");v==="NodeHeading"?turnsIntoTransaction({protyle:e,nodeElement:w[0],type:"Blocks2Ps"}):v==="NodeList"?turnsOneInto({protyle:e,nodeElement:w[0],id:w[0].getAttribute("data-node-id"),type:"CancelList"}):v==="NodeBlockquote"&&turnsOneInto({protyle:e,nodeElement:w[0],id:w[0].getAttribute("data-node-id"),type:"CancelBlockquote"})}return a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading1.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:f,type:"Blocks2Hs",level:1}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading2.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:f,type:"Blocks2Hs",level:2}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading3.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:f,type:"Blocks2Hs",level:3}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading4.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:f,type:"Blocks2Hs",level:4}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading5.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:f,type:"Blocks2Hs",level:5}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading6.custom,a))return turnsIntoTransaction({protyle:e,nodeElement:f,type:"Blocks2Hs",level:6}),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.insert.code.custom,a)&&!["NodeCodeBlock","NodeHeading","NodeTable"].includes(f.getAttribute("data-type"))){const w=getContenteditableElement(f);if(w){const v=f.getAttribute("data-node-id"),h=f.outerHTML;w.innerHTML="```"+window.siyuan.storage[Constants.LOCAL_CODELANG]+`
`+Lute.EscapeHTMLStr(w.textContent)+"<wbr>\n```";const E=e.lute.SpinBlockDOM(f.outerHTML);f.outerHTML=E;const C=e.wysiwyg.element.querySelector(`[data-node-id="${v}"]`);return updateTransaction(e,v,E,h),highlightRender(C),a.preventDefault(),a.stopPropagation(),!0}}if(matchHotKey(window.siyuan.config.keymap.editor.insert.lastUsed.custom,a)){e.toolbar.range=d;const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p===""&&w.length===0&&w.push(f),fontEvent(e,w),a.stopPropagation(),a.preventDefault();return}if(!f.classList.contains("code-block")&&!a.repeat&&!isInEmbedBlock(f)){let w=!1;if(e.options.toolbar.find(v=>{if(!v.hotkey)return!1;if(matchHotKey(v.hotkey,a))return e.toolbar.range=d,["block-ref"].includes(v.name)&&e.toolbar.range.toString()===""||(w=!0,["a","block-ref","inline-math","inline-memo","text"].includes(v.name)?e.toolbar.element.querySelector(`[data-type="${v.name}"]`).dispatchEvent(new CustomEvent("click")):Constants.INLINE_TYPE.includes(v.name)?e.toolbar.setInlineMark(e,v.name,"range"):v.click&&v.click(e.getInstance())),!0}),w)return a.preventDefault(),a.stopPropagation(),e.wysiwyg.preventKeyup=!0,!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.outdent.custom,a)){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(w.length>0){let v=!0;return w.forEach((h,E)=>{h.nextElementSibling&&w[E+1]&&w[E+1]!==h.nextElementSibling&&(v=!1)}),v&&(w[0].classList.contains("li")||w[0].parentElement.classList.contains("li"))&&listOutdent(e,Array.from(w),d),a.preventDefault(),a.stopPropagation(),!0}else if(f.parentElement.classList.contains("li")&&f.getAttribute("data-type")!=="NodeCodeBlock")return listOutdent(e,[f.parentElement],d),a.preventDefault(),a.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.indent.custom,a)){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(w.length>0){let v=!0;return w.forEach((h,E)=>{h.nextElementSibling&&w[E+1]&&w[E+1]!==h.nextElementSibling&&(v=!1)}),v&&(w[0].classList.contains("li")||w[0].parentElement.classList.contains("li"))&&listIndent(e,Array.from(w),d),a.preventDefault(),a.stopPropagation(),!0}else if(f.parentElement.classList.contains("li")&&f.getAttribute("data-type")!=="NodeCodeBlock")return listIndent(e,[f.parentElement],d),a.preventDefault(),a.stopPropagation(),!0}const _=matchHotKey(window.siyuan.config.keymap.editor.insert.list.custom,a),k=matchHotKey(window.siyuan.config.keymap.editor.insert.check.custom,a),x=matchHotKey(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,a),T=matchHotKey(window.siyuan.config.keymap.editor.insert.quote.custom,a);if(_||x||k||T){const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===0&&w.push(f),w.length===1){const v=w[0].dataset.subtype,h=w[0].dataset.type;if(T)["NodeHeading","NodeParagraph","NodeList"].includes(h)?turnsIntoOneTransaction({protyle:e,selectsElement:w,type:"Blocks2Blockquote"}):(e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(">"+Lute.Caret,e));else if(h==="NodeParagraph")turnsIntoOneTransaction({protyle:e,selectsElement:w,type:k?"Blocks2TLs":_?"Blocks2ULs":"Blocks2OLs"});else if(h==="NodeList"){const E=w[0].dataset.nodeId;v==="o"&&(_||k)?turnsOneInto({protyle:e,nodeElement:w[0],id:E,type:k?"UL2TL":"OL2UL"}):v==="t"&&(_||x)?turnsOneInto({protyle:e,nodeElement:w[0],id:E,type:_?"TL2UL":"TL2OL"}):v==="u"&&(k||x)&&turnsOneInto({protyle:e,nodeElement:w[0],id:E,type:k?"OL2TL":"UL2OL"})}else e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill((k?"- [ ] ":_?"- ":"1. ")+Lute.Caret,e)}else{let v=!1,h=!1;w.find((E,C)=>{if(E.classList.contains("li"))return v=!0,!0;if(E.nextElementSibling&&w[C+1]&&E.nextElementSibling===w[C+1])h=!0;else if(C!==w.length-1)return h=!1,!0}),!v&&h&&turnsIntoOneTransaction({protyle:e,selectsElement:w,type:T?"Blocks2Blockquote":k?"Blocks2TLs":_?"Blocks2ULs":"Blocks2OLs"})}a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.insert.table.custom,a)){e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,e),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.list.checkToggle.custom,a)){const w=hasClosestByAttribute(d.startContainer,"data-subtype","t");if(!w)return;const v=w.outerHTML;w.classList.contains("protyle-task--done")?(w.querySelector("use").setAttribute("xlink:href","#iconUncheck"),w.classList.remove("protyle-task--done")):(w.querySelector("use").setAttribute("xlink:href","#iconCheck"),w.classList.add("protyle-task--done")),w.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,w.getAttribute("data-node-id"),w.outerHTML,v),a.preventDefault(),a.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.insertBefore.custom,a))return(c=f.querySelector(".img--select"))==null||c.classList.remove("img--select"),insertEmptyBlock(e,"beforebegin"),a.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.insertAfter.custom,a))return(u=f.querySelector(".img--select"))==null||u.classList.remove("img--select"),insertEmptyBlock(e,"afterend"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,a))return jumpToParent(e,f,"next"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParent.custom,a))return jumpToParent(e,f,"parent"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,a))return jumpToParent(e,f,"previous"),a.preventDefault(),a.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToUp.custom,a)){a.preventDefault(),a.stopPropagation(),moveToUp(e,f,d);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToDown.custom,a)){a.preventDefault(),a.stopPropagation(),moveToDown(e,f,d);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.vLayout.custom,a)){a.preventDefault(),a.stopPropagation();const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===1&&w[0].getAttribute("data-type")==="NodeSuperBlock"){if(w[0].getAttribute("data-sb-layout")==="col"){const v=w[0].outerHTML;w[0].setAttribute("data-sb-layout","row"),w[0].setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,w[0].getAttribute("data-node-id"),w[0].outerHTML,v)}else{d.insertNode(document.createElement("wbr"));const v=yield cancelSB(e,w[0]);transaction(e,v.doOperations,v.undoOperations),focusByWbr(e.wysiwyg.element,d)}return}if(w.length<2||(g=w[0])!=null&&g.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:w,type:"BlocksMergeSuperBlock",level:"row"});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.hLayout.custom,a)){a.preventDefault(),a.stopPropagation();const w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(w.length===1&&w[0].getAttribute("data-type")==="NodeSuperBlock"){if(w[0].getAttribute("data-sb-layout")==="row"){const v=w[0].outerHTML;w[0].setAttribute("data-sb-layout","col"),w[0].setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,w[0].getAttribute("data-node-id"),w[0].outerHTML,v)}else{d.insertNode(document.createElement("wbr"));const v=yield cancelSB(e,w[0]);transaction(e,v.doOperations,v.undoOperations),focusByWbr(e.wysiwyg.element,d)}return}if(w.length<2||(m=w[0])!=null&&m.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:w,type:"BlocksMergeSuperBlock",level:"col"});return}if(!a.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.ai.custom,a)){a.preventDefault(),a.stopPropagation();let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[f]),AIActions(w,e);return}if(!a.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.aiWriting.custom,a)){a.preventDefault(),a.stopPropagation(),AIChat(e,f);return}if(!a.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.openInNewTab.custom,a)){a.preventDefault(),a.stopPropagation();const w=window.siyuan.blockPanels.find(h=>{if(h.element.contains(f))return!0}),v=f.getAttribute("data-node-id");checkFold(v,(h,E)=>{openFileById({app:e.app,id:v,action:E,zoomIn:h,openNewTab:!0}),w.destroy()});return}if(a.key==="Tab"&&isNotCtrl(a)&&!a.altKey){a.preventDefault();const w=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(f.getAttribute("data-type")==="NodeCodeBlock"&&p!==""){!hasNextSibling(d.endContainer)&&d.endContainer.textContent.endsWith(`
`)&&d.endOffset>0&&d.setEnd(d.endContainer,d.endOffset-1);const v=document.createElement("wbr");d.insertNode(v),d.setStartAfter(v);const h=f.outerHTML;let E="";a.shiftKey?d.extractContents().textContent.split(`
`).forEach(S=>{S.startsWith(w)?E+=S.replace(w,"")+`
`:E+=S+`
`}):d.extractContents().textContent.split(`
`).forEach(S=>{E+=w+S+`
`});let C=f.querySelector(".protyle-action__language").textContent;if(d.commonAncestorContainer.nodeType===1){const S=d.commonAncestorContainer.className;S.startsWith("language-")&&(C=S.replace("language-",""),v.parentElement!==d.commonAncestorContainer&&(v.parentElement.after(v),v.previousElementSibling.remove()))}window.hljs.getLanguage(C)||(C="plaintext"),v.insertAdjacentHTML("afterend",window.hljs.highlight(E.substr(0,E.length-1),{language:C,ignoreIllegals:!0}).value+"<br>"),d.setStart(v.nextSibling,0);const A=v.parentElement.querySelector("br");setLastNodeRange(A.previousSibling,d,!1),A.remove(),updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,h),v.remove();return}if(!a.shiftKey){const v=d.startContainer.parentElement,h=e.toolbar.getCurrentType(d);h.length>0&&d.toString()===""&&d.startOffset===0&&v.tagName==="SPAN"&&!hasPreviousSibling(d.startContainer)&&!hasPreviousSibling(v)?(d.setStartBefore(v),d.collapse(!0)):v.tagName==="SPAN"&&!h.includes("search-mark")&&!h.includes("code")&&!h.includes("kbd")&&!h.includes("tag")&&d.toString()===""&&d.startContainer.nodeType===3&&(h.includes("inline-memo")||h.includes("block-ref")||h.includes("file-annotation-ref")||h.includes("a"))&&!hasNextSibling(d.startContainer)&&d.startContainer.textContent.length===d.startOffset&&(d.setEndAfter(v),d.collapse(!1));const E=document.createElement("wbr");d.insertNode(E);const C=f.outerHTML;return d.extractContents(),d.insertNode(document.createTextNode(w)),d.collapse(!1),focusByRange(d),E.remove(),updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,C),!0}}if(a.key==="ContextMenu"){const w=getSelectionPosition(f,d);e.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:f,y:w.top+8,x:w.left}})),a.preventDefault(),a.stopPropagation();return}if(matchHotKey("\u21E7\u2318V",a)){a.returnValue=!1,a.preventDefault(),a.stopPropagation(),pasteAsPlainText(e);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.openBy.custom,a)){const w=hasClosestByAttribute(d.startContainer,"data-type","a");if(w){openLink(e,w.getAttribute("data-href"),void 0,!1),a.preventDefault(),a.stopPropagation();return}const v=hasClosestByAttribute(d.startContainer,"data-type","file-annotation-ref");if(v){const E=`assets/${v.getAttribute("data-id").split("/")[1]}`;openLink(e,E,void 0,!1),a.preventDefault(),a.stopPropagation();return}return}if(a.shiftKey&&(a.key==="ArrowLeft"||a.key==="ArrowRight")){if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){a.stopPropagation(),a.preventDefault();return}if(!d.toString()){if(a.key==="ArrowRight"&&isEndOfBlock(d)&&!isIncludesHotKey("\u2325\u21E7\u2192")){a.preventDefault(),a.stopPropagation();return}const v=getContenteditableElement(f);if(getSelectionOffset(v,e.wysiwyg.element,d).start===0&&a.key==="ArrowLeft"&&!isIncludesHotKey("\u2325\u21E7\u2190")){a.preventDefault(),a.stopPropagation();return}}}if(isNotCtrl(a)&&a.key!=="Backspace"&&a.key!=="Escape"&&a.key!=="Delete"&&!a.shiftKey&&!a.altKey&&a.key!=="Enter"&&hideElements(["select"],e),matchHotKey("\u2318B",a)||matchHotKey("\u2318I",a)||matchHotKey("\u2318U",a)){a.preventDefault(),a.stopPropagation();return}}))},Uu=(e,t,a)=>{const n=isMobile(),i=hasClosestByClassName(e.target,"protyle-attr--bookmark");if(i)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"bookmark",t):openAttr(i.parentElement.parentElement,"bookmark",t)),e.stopPropagation(),!0;const s=hasClosestByClassName(e.target,"protyle-attr--name");if(s)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"name",t):openAttr(s.parentElement.parentElement,"name",t)),e.stopPropagation(),!0;const o=hasClosestByClassName(e.target,"protyle-attr--av");if(o)return a?openFileAttr(a,"av",t):openAttr(o.parentElement.parentElement,"av",t),e.stopPropagation(),!0;const l=hasClosestByClassName(e.target,"protyle-attr--alias");if(l)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"alias",t):openAttr(l.parentElement.parentElement,"alias",t)),e.stopPropagation(),!0;const r=hasClosestByClassName(e.target,"protyle-attr--memo");if(r)return!n&&isOnlyMeta(e)||(a?openFileAttr(a,"memo",t):openAttr(r.parentElement.parentElement,"memo",t)),e.stopPropagation(),!0},Fu=()=>{var e;const t=document.getElementById("dragGhost");if(t){if(t.dataset.ghostType==="dock")t.parentElement.querySelectorAll(".dock__item").forEach(a=>{a.style.opacity=""}),(e=document.querySelector("#dockMoveItem"))==null||e.remove();else{const a=t.parentElement.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);a&&(a.style.opacity=""),t.parentElement.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(n=>{n.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current"),n.style.opacity=""})}t.remove(),document.onmousemove=null,Bs()}},ke={},Bs=()=>{ke.animationId&&(cancelAnimationFrame(ke.animationId),ke.animationId=null,ke.element=null,ke.space=null,ke.lastTime=null)},Ps=e=>{ke.lastTime||(ke.lastTime=e-8),ke.element.scroll({top:ke.element.scrollTop+(e-ke.lastTime)*ke.space/64}),ke.animationId=requestAnimationFrame(Ps),ke.lastTime=e},Yu=(e,t,a)=>{const n=e.clientY<t.top+Constants.SIZE_SCROLL_TB;n||e.clientY>t.bottom-Constants.SIZE_SCROLL_TB?(ke.space=n?e.clientY-t.top-Constants.SIZE_SCROLL_TB:e.clientY-t.bottom+Constants.SIZE_SCROLL_TB,ke.animationId||(ke.element=a,ke.animationId=requestAnimationFrame(Ps))):Bs()},oo=e=>{!window.siyuan.menus.menu.element.contains(e)&&!hasClosestByAttribute(e,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove())},Wu=e=>{cancelDrag(),oo(e.target);const t=hasClosestByClassName(e.target,"protyle",!0);if(t){const n=t.querySelector(".protyle-wysiwyg");(n.getAttribute("data-readonly")==="true"||!n.contains(e.target))&&n.dispatchEvent(new Event("focusin"))}!hasTopClosestByClassName(e.target,"protyle-util")&&!hasTopClosestByClassName(e.target,"protyle-toolbar")&&document.querySelectorAll(".protyle-font").forEach(n=>{n.parentElement.classList.add("fn__none")});const a=hasTopClosestByClassName(e.target,"protyle-action__copy");if(a){let n=a.parentElement.nextElementSibling.textContent.replace(/\n$/,"");n=n.replace(/\u00A0/g," "),writeText(n),showMessage(window.siyuan.languages.copied,2e3),e.preventDefault();return}},ju=e=>{const t=e.nodeElement.getAttribute("data-av-id"),a=e.nodeElement.getAttribute("data-node-id"),n=e.target.querySelector(".b3-menu__accelerator"),i=new Menu;i.addItem({iconHTML:"",checked:e.view.coverFrom===0,label:window.siyuan.languages.calcOperatorNone,click(){transaction(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:0}],[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:e.view.coverFrom}]),e.view.coverFrom=0,n.textContent=window.siyuan.languages.calcOperatorNone}}),i.addItem({iconHTML:"",checked:e.view.coverFrom===3,label:window.siyuan.languages.contentBlock,click(){transaction(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:3}],[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:e.view.coverFrom}]),e.view.coverFrom=3,n.textContent=window.siyuan.languages.contentBlock}}),i.addItem({iconHTML:"",checked:e.view.coverFrom===1,label:window.siyuan.languages.contentImage,click(){transaction(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:1}],[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:e.view.coverFrom}]),e.view.coverFrom=1,n.textContent=window.siyuan.languages.contentImage}});let s=!1;e.view.fields.forEach(l=>{l.type==="mAsset"&&(s||(i.addSeparator(),s=!0),i.addItem({iconHTML:l.icon?unicode2Emoji(l.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(l.type)}"></use></svg>`,checked:e.view.coverFrom===2&&e.view.coverFromAssetKeyID===l.id,label:l.name,click(){transaction(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:2},{action:"setAttrViewCoverFromAssetKeyID",avID:t,blockID:a,keyID:l.id}],[{action:"setAttrViewCoverFrom",avID:t,blockID:a,data:e.view.coverFrom},{action:"setAttrViewCoverFromAssetKeyID",avID:t,blockID:a,keyID:e.view.coverFromAssetKeyID}]),e.view.coverFrom=2,e.view.coverFromAssetKeyID=l.id,n.textContent=l.name}}))});const o=e.target.getBoundingClientRect();i.open({x:o.left,y:o.bottom})},Vu=e=>{const t=new Menu,a=e.nodeElement.getAttribute("data-av-id"),n=e.nodeElement.getAttribute("data-node-id"),i=e.target.querySelector(".b3-menu__accelerator");t.addItem({iconHTML:"",checked:e.view.cardSize===0,label:window.siyuan.languages.small,click(){transaction(e.protyle,[{action:"setAttrViewCardSize",avID:a,blockID:n,data:0}],[{action:"setAttrViewCardSize",avID:a,blockID:n,data:e.view.cardSize}]),e.view.cardSize=0,i.textContent=window.siyuan.languages.small}}),t.addItem({iconHTML:"",checked:e.view.cardSize===1,label:window.siyuan.languages.medium,click(){transaction(e.protyle,[{action:"setAttrViewCardSize",avID:a,blockID:n,data:1}],[{action:"setAttrViewCardSize",avID:a,blockID:n,data:e.view.cardSize}]),e.view.cardSize=1,i.textContent=window.siyuan.languages.medium}}),t.addItem({iconHTML:"",checked:e.view.cardSize===2,label:window.siyuan.languages.large,click(){transaction(e.protyle,[{action:"setAttrViewCardSize",avID:a,blockID:n,data:2}],[{action:"setAttrViewCardSize",avID:a,blockID:n,data:e.view.cardSize}]),e.view.cardSize=2,i.textContent=window.siyuan.languages.large}});const s=e.target.getBoundingClientRect();t.open({x:s.left,y:s.bottom})},Rs=e=>{switch(e){case 0:return"16:9";case 1:return"9:16";case 2:return"4:3";case 3:return"3:4";case 4:return"3:2";case 5:return"2:3";case 6:return"1:1"}return"16:9"},Gu=e=>{const t=new Menu,a=e.nodeElement.getAttribute("data-av-id"),n=e.nodeElement.getAttribute("data-node-id"),i=e.target.querySelector(".b3-menu__accelerator");[0,1,2,3,4,5,6].forEach(o=>{t.addItem({iconHTML:"",checked:e.view.cardAspectRatio===o,label:Rs(o),click(){transaction(e.protyle,[{action:"setAttrViewCardAspectRatio",avID:a,blockID:n,data:o}],[{action:"setAttrViewCardAspectRatio",avID:a,blockID:n,data:e.view.cardAspectRatio}]),e.view.cardAspectRatio=o,i.textContent=Rs(o)}})});const s=e.target.getBoundingClientRect();t.open({x:s.left,y:s.bottom})},zu=e=>{const t=hasClosestByClassName(e.target,"av__gallery-item");t&&avContextmenu(e.protyle,t,e.position)},Ku=e=>{const t=hasClosestByClassName(e,"av__gallery-item");if(t){const a=t.querySelector(".av__gallery-fields");a&&(e.setAttribute("aria-label",window.siyuan.languages[a.classList.contains("av__gallery-fields--edit")?"displayEmptyFields":"hideEmptyFields"]),a.classList.toggle("av__gallery-fields--edit"))}};var xn=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class Zu{constructor(t){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),isMobile()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(t),!t.options.action.includes(Constants.CB_GET_HISTORY)&&(this.bindEvent(t),keydown(t,this.element),dropEvent(t,this.element))}renderCustom(t){let a=t[Constants.CUSTOM_SY_FULLWIDTH];a||(a=window.siyuan.config.editor.fullWidth?"true":"false"),a==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const n=Object.keys(t);for(let i=0;i<this.element.attributes.length;i++){const s=this.element.attributes[i].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(s)&&!n.includes(s)&&(this.element.removeAttribute(s),i--)}n.forEach(i=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(i)||this.element.setAttribute(i,t[i])})}escapeInline(t,a,n){if(!n.data&&n.inputType!=="insertLineBreak")return;const i=n.data;t.toolbar.range=a;const s=a.startContainer.parentElement,o=t.toolbar.getCurrentType();if(n.inputType==="insertLineBreak"){o.length>0&&a.toString()===""&&s.tagName==="SPAN"&&s.textContent.startsWith(`
`)&&a.startContainer.previousSibling&&a.startContainer.previousSibling.textContent===`
`&&s.before(a.startContainer.previousSibling);return}let l=i.length;if(i==="<"||i===">"?l=4:i==="&"&&(l=5),o.length>0&&a.toString()===""&&a.startOffset===i.length&&s.tagName==="SPAN"&&s.textContent.replace(Constants.ZWSP,"")!==i&&s.textContent.replace(Constants.ZWSP,"").length>=i.length&&!hasPreviousSibling(a.startContainer)&&!hasPreviousSibling(s)){const r=s.innerHTML.replace(Constants.ZWSP,"");s.innerHTML=r.substr(l);const c=document.createTextNode(i);s.before(c),a.selectNodeContents(c),a.collapse(!1);return}if(s.tagName==="SPAN"&&s.textContent!==i&&!o.includes("search-mark")&&!o.includes("code")&&!o.includes("kbd")&&!o.includes("tag")&&a.toString()===""&&a.startContainer.nodeType===3&&(o.includes("inline-memo")||o.includes("block-ref")||o.includes("file-annotation-ref")||o.includes("a"))&&!hasNextSibling(a.startContainer)&&a.startContainer.textContent.length===a.startOffset&&s.textContent.length>i.length){const r=getSelectionOffset(s,t.wysiwyg.element,a),c=s.innerHTML;if(r.start===s.textContent.length){s.innerHTML=c.substr(0,c.length-l);const u=document.createTextNode(i);s.after(u),a.selectNodeContents(u),a.collapse(!1)}}}setEmptyOutline(t,a){let n=a;if(!a.getAttribute("data-node-id")){const i=hasClosestBlock(a);if(!i)return;n=i}t.disabled&&(t.toolbar.range=getEditorRange(n))}emojiToMd(t){t.querySelectorAll(".emoji").forEach(a=>{a.outerHTML=`:${a.getAttribute("alt")}:`})}bindCommonEvent(t){this.element.addEventListener("copy",a=>xn(this,null,function*(){var n;if(window.siyuan.ctrlIsPressed=!1,a.target.tagName==="PROTYLE-HTML"||a.target.localName==="input"){a.stopPropagation();return}a.stopPropagation(),a.preventDefault();const i=getEditorRange(t.wysiwyg.element),s=hasClosestBlock(i.startContainer);if(!s)return;const o=s.querySelector(".img--select"),l=s.querySelector(".av__row--select, .av__cell--select"),r=((n=s.querySelector(".table__select"))==null?void 0:n.clientWidth)>0;let c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&i.toString()===""&&!i.cloneContents().querySelector("img")&&!o&&!l&&!r&&(s.classList.add("protyle-wysiwyg--select"),countBlockWord([s.getAttribute("data-node-id")]),c=[s]);let u="",g="",m=!1,d=!1;if(c.length>0){const f=c[0].getAttribute("data-reftext")==="true";c[0].getAttribute("data-type")==="NodeListItem"&&c[0].parentElement.classList.contains("list")&&c[0].parentElement.childElementCount-1===c.length&&(c.find(y=>{if(!c[0].parentElement.contains(y))return!0})||(c=[c[0].parentElement]));let b="";for(let p=0;p<c.length;p++){const y=c[p];if(f)u+=getTextStar(y)+`

`;else{let _="";y.getAttribute("data-type")==="NodeHeading"&&y.getAttribute("fold")==="1"?(d=!0,_=(yield fetchSyncPost("/api/block/getHeadingChildrenDOM",{id:y.getAttribute("data-node-id"),removeFoldAttr:!1})).data):y.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&y.querySelector('[data-type="NodeHeading"][fold="1"]')?(d=!0,_=(yield fetchSyncPost("/api/block/getBlockDOM",{id:y.getAttribute("data-node-id")})).data.dom):_=removeEmbed(y),y.getAttribute("data-type")==="NodeListItem"?(b||(b=`<div data-subtype="${y.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">`),b+=_,(p===c.length-1||c[p+1].getAttribute("data-type")!=="NodeListItem"||c[p+1].getAttribute("data-subtype")!==y.getAttribute("data-subtype"))&&(u+=`${b}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,b="")):u+=_}}f&&(u=u.slice(0,-2),c[0].removeAttribute("data-reftext"))}else if(l){const f=Array.from(s.querySelectorAll(".av__cell--active, .av__cell--select"))||[];f.length===0&&s.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(b=>{b.querySelectorAll(".av__cell").forEach(p=>{f.push(p)})}),f.length>0&&(u="[",f.forEach((b,p)=>{var y;const _=getCellText(b);(p===0||f[p-1]!==b.previousElementSibling&&!((y=b.previousElementSibling)!=null&&y.classList.contains("av__colsticky")&&!f[p-1].nextElementSibling&&f[p-1].parentElement===b.previousElementSibling))&&(u+="["),u+=JSON.stringify(genCellValueByElement(getTypeByCellElement(b),b))+",",p===f.length-1||f[p+1]!==b.nextElementSibling&&!(!b.nextElementSibling&&b.parentElement.nextElementSibling===f[p+1])?(u=u.substring(0,u.length-1)+"],",g+=_+`
`):g+=_+"	"}),g=g.substring(0,g.length-1),u=u.substring(0,u.length-1)+"]")}else if(r){const f=[],b=s.firstElementChild.scrollLeft,p=s.querySelector("table").scrollTop,y=s.querySelector(".table__select");u="<table>",s.querySelectorAll("th, td").forEach(_=>{!_.classList.contains("fn__none")&&isIncludeCell({tableSelectElement:y,scrollLeft:b,scrollTop:p,item:_})&&f.push(_)}),f.forEach((_,k)=>{(k===0||!_.previousElementSibling||_.previousElementSibling!==f[k-1])&&(u+="<tr>"),u+=_.outerHTML,(!_.nextElementSibling||!f[k+1]||_.nextElementSibling!==f[k+1])&&(u+="</tr>")}),u+="</table>",g=t.lute.HTML2Md(u)}else{const f=document.createElement("div"),b=t.toolbar.getCurrentType(i),p=hasClosestByTag(i.startContainer,"SPAN"),y=hasClosestByAttribute(i.startContainer,"data-type","NodeHeading"),_=y&&y.textContent.replace(Constants.ZWSP,"")===i.toString();if(b.length>0&&p&&p.textContent.replace(Constants.ZWSP,"")===i.toString()||_)_?(f.append(y.cloneNode(!0)),y.removeAttribute("fold")):["DIV","TD","TH","TR"].includes(i.startContainer.parentElement.tagName)?(f.append(i.cloneContents()),this.emojiToMd(f)):(f.append(i.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(f)),u=f.innerHTML,g=i.toString();else if(o)u=o.outerHTML,g=o.querySelector("img").getAttribute("data-src");else if(b.length>0&&i.startContainer.nodeType===3&&i.startContainer.parentElement.tagName==="SPAN"&&i.startContainer.parentElement===i.endContainer.parentElement){const k=i.startContainer.parentElement.attributes,x=document.createElement("span");for(let T=0;T<k.length;T++)x.setAttribute(k[T].name,k[T].value);x.getAttribute("data-type").indexOf("block-ref")>-1&&x.getAttribute("data-subtype")==="d"&&x.setAttribute("data-subtype","s"),x.textContent=i.toString(),u=x.outerHTML,g=i.toString()}else{f.append(i.cloneContents()),this.emojiToMd(f);const k=hasClosestByAttribute(i.commonAncestorContainer,"data-type","inline-math");k?u=k.outerHTML:u=f.innerHTML,g=f.textContent,hasClosestByAttribute(i.startContainer,"data-type","NodeCodeBlock")?(isEndOfBlock(i)&&(g=g.replace(/\n$/,"")),m=!0):hasClosestByTag(i.startContainer,"TD")||hasClosestByTag(i.startContainer,"TH")?(f.innerHTML=f.innerHTML.replace(/<br>/g,`
`).replace(/<br\/>/g,`
`),g=f.textContent.endsWith(`
`)?f.textContent.replace(/\n$/,""):f.textContent):hasClosestByTag(i.startContainer,"CODE")||(g=i.toString())}}if(t.disabled&&(u=getEnableHTML(u)),g=g||t.lute.BlockDOM2StdMd(u).trimEnd(),g=g.replace(/\u00A0/g," ").replace(new RegExp(Constants.ZWSP,"g"),""),a.clipboardData.setData("text/plain",g),!m){enableLuteMarkdownSyntax(t);const f=r?t.lute.HTML2BlockDOM(u):u;a.clipboardData.setData("text/siyuan",f),restoreLuteMarkdownSyntax(t);const b=`<!--data-siyuan='${encodeBase64(f)}'-->`+(r?u:t.lute.BlockDOM2HTML(l?g:u));if(a.clipboardData.setData("text/html",b),d)try{yield navigator.clipboard.write([new ClipboardItem({"text/plain":g,"text/html":b})])}catch(p){console.log("Copy write clipboard error:",p)}}})),this.element.addEventListener("mousedown",a=>{var n;if(t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),a.button===2)return;const i=document;i.onmouseup=null;let s=a.target,o=hasClosestBlock(s);const l=this.element.querySelector(".protyle-wysiwyg--select"),r=hasClosestByClassName(s,"av__gallery-item");if(a.shiftKey){let S,L=o;if(getSelection().rangeCount>0&&(S=hasClosestBlock(getSelection().getRangeAt(0).startContainer)),!l&&r){r.classList.add("av__gallery-item--select");let $=r.previousElementSibling,R=[];for(;$&&!$.classList.contains("av__gallery-item--select");)if(R.push($),$=$.previousElementSibling,!$){R=[];break}$=r.nextElementSibling;let D=[];for(;$&&!$.classList.contains("av__gallery-item--select");)if(D.push($),$=$.nextElementSibling,!$||$.classList.contains("av__gallery-add")){D=[];break}R.concat(D).forEach(M=>{M.classList.add("av__gallery-item--select")}),a.preventDefault()}else if(S&&L&&S!==L){let $=!0;const R=S.getBoundingClientRect(),D=L.getBoundingClientRect();let M=R.top,P=D.top;if(M===P&&(M=R.left,P=D.left),M>P){const Y=L;L=S,S=Y;const z=P;P=M,M=z,$=!1}let B=[],N=S,X=!1;for(;N;)if(N&&!N.classList.contains("protyle-attr")){const Y=N.getBoundingClientRect();if(R.top===D.top?Y.left<=P:Y.top<=P)if(X)if(N.nextElementSibling&&!N.nextElementSibling.classList.contains("protyle-attr")){const z=N.nextElementSibling.getBoundingClientRect();if(R.top===D.top?z.left<=P&&z.bottom<=D.bottom:z.top<=P)B=[N],N=N.nextElementSibling,X=!1;else if(N.parentElement.classList.contains("sb"))N=hasClosestBlock(N.parentElement),X=!0;else break}else N=hasClosestBlock(N.parentElement),X=!0;else B.push(N),N=N.nextElementSibling;else if(N.parentElement.classList.contains("sb"))N=hasClosestBlock(N.parentElement),X=!0;else break}else N=hasClosestBlock(N.parentElement),X=!0;if(!(B.length===1&&!B[0].classList.contains("list")&&!B[0].classList.contains("bq")&&!B[0].classList.contains("sb"))){const Y=[];!l&&t.scroll&&!t.scroll.element.classList.contains("fn__none")&&!t.scroll.keepLazyLoad&&(S.getBoundingClientRect().top<-t.contentElement.clientHeight*2||L.getBoundingClientRect().bottom>t.contentElement.clientHeight*2)&&showMessage(window.siyuan.languages.crossKeepLazyLoad),B.forEach(z=>{hasClosestByClassName(N,"protyle-wysiwyg--select")||(z.classList.add("protyle-wysiwyg--select"),Y.push(z.getAttribute("data-node-id")),z.querySelectorAll(".protyle-wysiwyg--select").forEach(se=>{se.classList.remove("protyle-wysiwyg--select")}))}),countBlockWord(Y),$?focusBlock(B[B.length-1],t.wysiwyg.element,!1):focusBlock(B[0],t.wysiwyg.element,!1)}a.preventDefault()}return}if(isOnlyMeta(a)&&!a.shiftKey&&!a.altKey){let S=o;if(!l&&r)r.classList.toggle("av__gallery-item--select");else if(S){const L=isInEmbedBlock(S);L&&(S=L),S=getTopAloneElement(S),S.classList.contains("protyle-wysiwyg--select")?(S.classList.remove("protyle-wysiwyg--select"),S.removeAttribute("select-start"),S.removeAttribute("select-end")):S.classList.add("protyle-wysiwyg--select"),S.querySelectorAll(".protyle-wysiwyg--select").forEach(D=>{D.classList.remove("protyle-wysiwyg--select"),D.removeAttribute("select-start"),D.removeAttribute("select-end")});const $=hasClosestByClassName(S.parentElement,"protyle-wysiwyg--select");$&&($.classList.remove("protyle-wysiwyg--select"),$.removeAttribute("select-start"),$.removeAttribute("select-end"));const R=[];t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(D=>{R.push(D.getAttribute("data-node-id"))}),countBlockWord(R)}return}if(r&&!hasClosestByAttribute(s,"data-type","av-gallery-more")){i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,clearSelect(["galleryItem"],t.wysiwyg.element),!1);return}const c=hasClosestByClassName(s,"av__drag-fill");if(hideElements(["select"],t),hasClosestByAttribute(s,"data-type","av-gallery-more")?clearSelect(["img","row","cell"],t.wysiwyg.element):!hasClosestByClassName(s,"av__firstcol")&&!c&&clearSelect(["img","av"],t.wysiwyg.element),hasClosestByClassName(s,"protyle-action")&&!hasClosestByClassName(s,"code-block")||hasClosestByClassName(s,"av__cell--header")&&!hasClosestByClassName(s,"av__widthdrag"))return;const u=t.wysiwyg.element.getBoundingClientRect(),g=window.getComputedStyle(t.wysiwyg.element),m=u.left+(parseInt(g.paddingLeft)||24)+1,d=u.right-(parseInt(g.paddingRight)||16)-2,f=t.element.getBoundingClientRect(),b=f.bottom,p=a.clientY,y=t.contentElement.getBoundingClientRect();if(!t.disabled&&s.classList.contains("av__widthdrag")){if(!o)return;const S=o.getAttribute("data-av-id"),L=o.dataset.nodeId,$=s.parentElement,R=$.clientWidth,D=$.getAttribute("data-col-id");let M;const P=o.querySelector(".av__scroll");i.onmousemove=B=>{M=Math.max(R+(B.clientX-a.clientX),25),P.querySelectorAll(".av__row, .av__row--footer").forEach(N=>{N.querySelector(`[data-col-id="${D}"]`).style.width=M+"px"}),stickyRow(o,y,"bottom")},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,!M||M===R)return;const B=o.getAttribute(Constants.CUSTOM_SY_AV_VIEW);transaction(t,[{action:"setAttrViewColWidth",id:D,avID:S,data:M+"px",blockID:L,keyID:B}],[{action:"setAttrViewColWidth",id:D,avID:S,data:R+"px",blockID:L,keyID:B}])},this.preventClick=!0,a.preventDefault();return}if(!t.disabled&&c){if(!o)return;const S={};let L;const $=[];o.querySelectorAll(".av__cell--active").forEach(B=>{const N=hasClosestByClassName(B,"av__row");N&&(S[N.dataset.id]||(S[N.dataset.id]=[]),S[N.dataset.id].push(genCellValueByElement(getTypeByCellElement(B),B)),L=B,$.push(B.dataset.id))});const R=getPositionByCellElement(L),D=getPositionByCellElement(o.querySelector(".av__cell--active"));let M,P;return i.onmousemove=B=>{const N=hasClosestByClassName(B.target,"av__cell");if(!(M&&N&&N===M)&&(M=N,M&&M.dataset.id)){const X=getPositionByCellElement(M);if(o.querySelectorAll(".av__cell--active").forEach(Y=>{$.includes(Y.dataset.id)||Y.classList.remove("av__cell--active")}),X.celIndex!==R.celIndex){P=void 0;return}o.querySelectorAll(".av__row").forEach((Y,z)=>{(X.rowIndex<D.rowIndex&&z>=X.rowIndex&&z<D.rowIndex||X.rowIndex>R.rowIndex&&z<=X.rowIndex&&z>R.rowIndex)&&Y.querySelectorAll(".av__cell").forEach((se,te)=>{te>=D.celIndex&&te<=X.celIndex&&(se.classList.add("av__cell--active"),P=se)})})}},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,P){dragFillCellsValue(t,o,S,$,L);const B=o.querySelectorAll(".av__cell--active");addDragFill(B[B.length-1])}return!1},this.preventClick=!0,!1}const _=hasClosestByClassName(s,"av__cell");if(!t.disabled&&_&&_.dataset.id&&!isInEmbedBlock(_)){if(!o||o.dataset.avType!=="table")return;o.querySelectorAll(".av__cell--select").forEach(P=>{P.classList.remove("av__cell--select")}),o.querySelectorAll(".av__drag-fill").forEach(P=>{P.remove()}),_.classList.add("av__cell--select");const S=getPositionByCellElement(_);let L,$;const R=o.getBoundingClientRect(),D=o.querySelector(".av__scroll"),M=hasClosestByClassName(_,"av__body");return i.onmousemove=P=>{const B=hasClosestByClassName(P.target,"av__cell");if(D.scrollWidth>D.clientWidth+2&&(P.clientX>R.right-10?D.scrollLeft+=10:P.clientX<R.left+34&&(D.scrollLeft-=10),P.clientY<y.top+48?t.contentElement.scrollTop-=5:P.clientY>y.bottom-48&&(t.contentElement.scrollTop+=5)),!(M!==hasClosestByClassName(B,"av__body")||L&&B&&B===L)&&B&&B.dataset.id&&(a.clientX!==P.clientX||a.clientY!==P.clientY)){const N=getPositionByCellElement(B);o.querySelectorAll(".av__cell--active").forEach(X=>{X.classList.remove("av__cell--active")}),M.querySelectorAll(".av__row").forEach((X,Y)=>{Y>=Math.min(S.rowIndex,N.rowIndex)&&Y<=Math.max(S.rowIndex,N.rowIndex)&&X.querySelectorAll(".av__cell").forEach((z,se)=>{se>=Math.min(S.celIndex,N.celIndex)&&se<=Math.max(S.celIndex,N.celIndex)&&(z.classList.add("av__cell--active"),$=z)})}),L=B}},i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,$&&(selectRow(o.querySelector(".av__firstcol"),"unselectAll"),focusBlock(o),addDragFill($),this.preventClick=!0),!1),!1}if(!t.disabled&&s.classList.contains("protyle-action__drag")){if(!o)return;let S=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(o.getAttribute("data-type"))?(o.classList.add("iframe--drag"),(o.style.textAlign==="left"||o.style.textAlign==="right")&&(S=!1)):s.parentElement.parentElement.getAttribute("data-type")==="img"&&s.parentElement.parentElement.classList.add("img--drag");const L=o.getAttribute("data-node-id"),$=o.outerHTML,R=a.clientX,D=s.previousElementSibling,M=D.clientWidth,P=D.clientHeight,B=D.parentElement.parentElement;D.tagName==="IMG"&&img3115(B),i.onmousemove=N=>{if(D.tagName==="IMG"&&(D.style.height=""),N.clientX>R-M+8&&N.clientX<d){const X=D.tagName==="IMG"&&!B.style.minWidth&&o.style.textAlign!=="center"||!S?1:2;D.tagName==="IMG"?D.parentElement.style.width=Math.max(17,M+(N.clientX-R)*X)+"px":D.style.width=Math.max(17,M+(N.clientX-R)*X)+"px"}D.tagName!=="IMG"&&N.clientY>p-P+8&&N.clientY<b&&(D.style.height=P+(N.clientY-p)+"px")},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,s.classList.contains("protyle-action__drag")&&o&&updateTransaction(t,L,o.outerHTML,$),o.classList.remove("iframe--drag"),s.parentElement.parentElement.classList.remove("img--drag")};return}let k;const x=hasClosestByTag(s,"TH")||hasClosestByTag(s,"TD");if(x&&(s=x),(s.tagName==="TH"||s.tagName==="TD"||((n=s.firstElementChild)==null?void 0:n.tagName)==="TABLE"||s.classList.contains("table__resize")||s.classList.contains("table__select"))&&(k=o,k&&(k.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),hideElements(["toolbar"],t),s.classList.contains("table__select")&&(s=document.elementFromPoint(a.clientX,a.clientY),o=hasClosestBlock(s)),a.stopPropagation())),!t.disabled&&s.classList.contains("table__resize")){if(!o)return;const S=o.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),o.firstElementChild.style.webkitUserModify="read-only",o.style.cursor="col-resize",s.removeAttribute("style");const L=o.getAttribute("data-node-id"),$=a.clientX,R=parseInt(s.getAttribute("data-col-index")),D=o.querySelectorAll("table col")[R];D.style.minWidth&&(D.style.width=o.querySelectorAll("table td, table th")[R].offsetWidth+"px",D.style.minWidth=""),o.querySelectorAll("tr").forEach(B=>{B.cells[R].style.width=""});const M=D.clientWidth,P=o.firstElementChild.clientWidth<o.firstElementChild.scrollWidth;i.onmousemove=B=>{o.style.textAlign==="center"&&!P?D.style.width=M+(B.clientX-$)*2+"px":D.style.width=M+(B.clientX-$)+"px"},i.onmouseup=()=>{o.firstElementChild.style.webkitUserModify="",o.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,o&&updateTransaction(t,L,o.outerHTML,S)};return}let T=a.clientX;a.clientX>d?T=d:a.clientX<m&&(T=m);const w=f.top+(t.options.render.breadcrumb?t.breadcrumb.element.parentElement.clientHeight:0);let v,h,E,C;this.element.querySelectorAll("iframe").forEach(S=>{S.style.pointerEvents="none"});const A=["IMG","VIDEO","AUDIO"].includes(s.tagName)||s.classList.contains("img");i.onmousemove=S=>{let L=S.target;if(k&&k.contains(L)&&!hasClosestByClassName(k,"protyle-wysiwyg__embed")){if(L.classList.contains("table__select")){L.classList.add("fn__none");const te=document.elementFromPoint(S.clientX,S.clientY);L.classList.remove("fn__none"),L=hasClosestByTag(te,"TH")||hasClosestByTag(te,"TD")}if(L&&L===s)return k.querySelector(".table__select").removeAttribute("style"),t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),h=L,!1;if(L&&(L.tagName==="TH"||L.tagName==="TD")&&(!h||h!==L)){k.firstElementChild.style.webkitUserModify="read-only";let te=s.offsetLeft+s.clientWidth-L.offsetLeft,re=L.offsetLeft;s.offsetLeft===L.offsetLeft?te=Math.max(s.clientWidth,L.clientWidth):s.offsetLeft<L.offsetLeft&&(te=L.offsetLeft+L.clientWidth-s.offsetLeft,re=s.offsetLeft);let Ue=s.offsetTop+s.clientHeight-L.offsetTop,De=L.offsetTop;s.offsetTop===L.offsetTop?Ue=Math.max(s.clientHeight,L.clientHeight):s.offsetTop<L.offsetTop&&(Ue=L.offsetTop+L.clientHeight-s.offsetTop,De=s.offsetTop),Array.from(k.querySelectorAll("th, td")).find(ie=>{const Me=ie.offsetLeft<re+te&&ie.offsetLeft+ie.clientWidth>re+te,pt=ie.offsetLeft<re&&ie.offsetLeft+ie.clientWidth>re;ie.offsetTop<De&&ie.offsetTop+ie.clientHeight>De?((ie.offsetLeft+6>re&&ie.offsetLeft+ie.clientWidth-6<re+te||Me||pt)&&(Ue=De+Ue-ie.offsetTop,De=ie.offsetTop),Me&&(te=ie.offsetLeft+ie.clientWidth-re),pt&&(te=re+te-ie.offsetLeft,re=ie.offsetLeft)):ie.offsetTop<De+Ue&&ie.offsetTop+ie.clientHeight>De+Ue?((ie.offsetLeft+6>re&&ie.offsetLeft+ie.clientWidth-6<re+te||Me||pt)&&(Ue=ie.clientHeight+ie.offsetTop-De),Me&&(te=ie.offsetLeft+ie.clientWidth-re),pt&&(te=re+te-ie.offsetLeft,re=ie.offsetLeft)):pt&&ie.offsetTop+6>De&&ie.offsetTop+ie.clientHeight-6<De+Ue?(te=re+te-ie.offsetLeft,re=ie.offsetLeft):Me&&ie.offsetTop+6>De&&ie.offsetTop+ie.clientHeight-6<De+Ue&&(te=ie.offsetLeft+ie.clientWidth-re)}),t.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),k.querySelector(".table__select").setAttribute("style",`left:${re-k.firstElementChild.scrollLeft}px;top:${De-k.querySelector("table").scrollTop}px;height:${Ue}px;width:${te+1}px;`),h=L}return}A&&(S.clientY<y.top+Constants.SIZE_SCROLL_TB||S.clientY>y.bottom-Constants.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(S.clientY<y.top+Constants.SIZE_SCROLL_TB?-Constants.SIZE_SCROLL_STEP:Constants.SIZE_SCROLL_STEP),behavior:"smooth"}),t.selectElement.classList.remove("fn__none"),hideElements(["gutter"],t);let $=0,R=0,D=0,M=0;if(S.clientX<T?(S.clientX<m?R=m:R=S.clientX,D=T-R):S.clientX>d?(R=T,D=d-R):(R=T,D=S.clientX-T),S.clientY>p?S.clientY>b?($=p,M=b-p):($=p,M=S.clientY-p):(S.clientY<w?$=w:$=S.clientY,M=p-$),M<4)return;t.selectElement.setAttribute("style",`background-color: ${t.selectElement.style.backgroundColor};top:${$}px;height:${M}px;left:${R+2}px;width:${D-2}px;`);const P=document.elementFromPoint(S.clientX,S.clientY);if(v&&v===P&&!v.classList.contains("protyle-wysiwyg")&&!v.classList.contains("list")&&!v.classList.contains("bq")&&!v.classList.contains("sb"))return;v=P,hideElements(["select"],t);let B;if(S.clientY>p?(B=E||document.elementFromPoint(R,$),C=void 0):(B=document.elementFromPoint(R,$),E=void 0),!B||((B.classList.contains("protyle-wysiwyg")||B.classList.contains("list")||B.classList.contains("li")||B.classList.contains("sb")||B.classList.contains("bq"))&&(B=document.elementFromPoint(R,$+16)),!B))return;let N=hasClosestBlock(B);!N&&B.classList.contains("protyle-breadcrumb__bar")&&(N=B.nextElementSibling),S.clientY>p?E||(N||(N=t.wysiwyg.element.firstElementChild,N.classList.contains("protyle-breadcrumb__bar")&&(N=N.nextElementSibling)),E=N):!N&&S.clientY<t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(N=t.wysiwyg.element.firstElementChild,N.classList.contains("protyle-breadcrumb__bar")&&(N=N.nextElementSibling));let X=[],Y=N;if(Y){const te=isInEmbedBlock(Y);te&&(Y=te)}let z=!1;const se=C?C.getBoundingClientRect().bottom:$+M;for(;Y;)if(Y&&!Y.classList.contains("protyle-attr")){const te=Y.getBoundingClientRect();if(te.height>0&&te.top<se&&te.left<R+D)if(z)if(Y.nextElementSibling&&!Y.nextElementSibling.classList.contains("protyle-attr")){const re=Y.nextElementSibling.getBoundingClientRect();if(re.top<se&&re.left<R+D)X=[Y],Y=Y.nextElementSibling,z=!1;else if(Y.parentElement.classList.contains("sb"))Y=hasClosestBlock(Y.parentElement),z=!0;else break}else Y=hasClosestBlock(Y.parentElement),z=!0;else!Y.classList.contains("protyle-breadcrumb__bar")&&!Y.classList.contains("protyle-breadcrumb__item")&&X.push(Y),Y=Y.nextElementSibling;else if(Y.parentElement.classList.contains("sb"))Y=hasClosestBlock(Y.parentElement),z=!0;else if(te.height===0&&te.width===0&&Y.parentElement.getAttribute("fold")==="1")Y=Y.parentElement,X=[];else break}else Y=hasClosestBlock(Y.parentElement),z=!0;S.clientY<=p&&!C&&(C=X[X.length-1]),X.length===1&&!X[0].classList.contains("list")&&!X[0].classList.contains("bq")&&!X[0].classList.contains("sb")?(t.selectElement.style.backgroundColor="transparent",t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange")):(t.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),X.forEach(te=>{hasClosestByClassName(te,"protyle-wysiwyg__embed")||te.classList.add("protyle-wysiwyg--select")}),t.selectElement.style.backgroundColor="")},i.onmouseup=S=>{var L;if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,E=void 0,C=void 0,t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),this.element.querySelectorAll("iframe").forEach(D=>{D.style.pointerEvents=""}),t.selectElement.classList.add("fn__none"),t.selectElement.removeAttribute("style"),k){k.firstElementChild.style.webkitUserModify="";const D=k.querySelector(".table__select");if(D.getAttribute("style")){if(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),t.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"mergeCell",label:window.siyuan.languages.mergeCell,click:()=>{if(k){const M=[],P=[],B=k.querySelectorAll("th").length;let N=0;const X=k.firstElementChild.scrollLeft,Y=k.querySelector("table").scrollTop;let z=!1,se=!1;k.querySelectorAll("th, td").forEach((ge,Je)=>{ge.classList.contains("fn__none")?(ge.previousElementSibling&&ge.previousElementSibling===M[M.length-1]||Je<N&&P.includes((Je+1)%B))&&(M.push(ge),!z&&ge.parentElement.parentElement.tagName==="THEAD"?z=!0:!se&&ge.parentElement.parentElement.tagName==="TBODY"&&(se=!0)):isIncludeCell({tableSelectElement:D,scrollLeft:X,scrollTop:Y,item:ge})&&(M.push(ge),!z&&ge.parentElement.parentElement.tagName==="THEAD"?z=!0:!se&&ge.parentElement.parentElement.tagName==="TBODY"&&(se=!0),P.push((Je+1)%B),N=Math.max((ge.rowSpan-1)*B+Je+1,N))}),D.removeAttribute("style");const te=k.outerHTML;let re=M[0],Ue=re.colSpan,De=1;for(;re.nextElementSibling&&re.nextElementSibling===M[De];)re=re.nextElementSibling,re.classList.contains("fn__none")||(Ue+=re.colSpan),De++;let ie="",Me=M[0].parentElement,pt=M[0].rowSpan;if(M.forEach((ge,Je)=>{let it=ge.innerHTML.trim();it.endsWith("<br>")&&(it=it.substr(0,it.length-4)),ie+=it+(!it||Je===M.length-1?"":"<br>"),Je!==0&&(Me!==ge.parentElement&&(ge.classList.contains("fn__none")||(pt+=ge.rowSpan),Me=ge.parentElement,M[0].parentElement.parentElement.tagName==="THEAD"&&ge.parentElement.parentElement.tagName!=="THEAD"&&M[0].parentElement.parentElement.insertAdjacentElement("beforeend",ge.parentElement)),ge.classList.add("fn__none"),ge.innerHTML="")}),z&&se)for(Me=Me.parentElement.nextElementSibling.firstElementChild;Me&&Me.parentElement.tagName!=="THEAD";){let ge=0,Je=0;if(Array.from(Me.children).forEach(it=>{ge+=it.colSpan-1,it.classList.contains("fn__none")&&Je++}),ge!==Je)M[0].parentElement.parentElement.insertAdjacentElement("beforeend",Me),Me=Me.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{k&&(M[0].innerHTML=ie+"<wbr>",M[0].colSpan=Ue,M[0].rowSpan=pt,focusByWbr(M[0],document.createRange()),updateTransaction(t,k.getAttribute("data-node-id"),k.outerHTML,te))})}}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(k){const M=[],P=k.firstElementChild.scrollLeft,B=k.querySelector("table").scrollTop;k.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&isIncludeCell({tableSelectElement:D,scrollLeft:P,scrollTop:B,item:N})&&(M.length===0||M.length>0&&N.offsetTop===M[0].offsetTop)&&M.push(N)}),D.removeAttribute("style"),setTableAlign(t,M,k,"left",getEditorRange(k))}}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"alignCenter",icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(k){const M=[],P=k.firstElementChild.scrollLeft,B=k.querySelector("table").scrollTop;k.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&isIncludeCell({tableSelectElement:D,scrollLeft:P,scrollTop:B,item:N})&&(M.length===0||M.length>0&&N.offsetTop===M[0].offsetTop)&&M.push(N)}),D.removeAttribute("style"),setTableAlign(t,M,k,"center",getEditorRange(k))}}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"alignRight",icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(k){const M=[],P=k.firstElementChild.scrollLeft,B=k.querySelector("table").scrollTop;k.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&isIncludeCell({tableSelectElement:D,scrollLeft:P,scrollTop:B,item:N})&&(M.length===0||M.length>0&&N.offsetTop===M[0].offsetTop)&&M.push(N)}),D.removeAttribute("style"),setTableAlign(t,M,k,"right",getEditorRange(k))}}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{if(k){const M=[],P=k.firstElementChild.scrollLeft,B=k.querySelector("table").scrollTop;k.querySelectorAll("th, td").forEach(N=>{!N.classList.contains("fn__none")&&isIncludeCell({tableSelectElement:D,scrollLeft:P,scrollTop:B,item:N})&&(M.length===0||M.length>0&&N.offsetTop===M[0].offsetTop)&&M.push(N)}),D.removeAttribute("style"),setTableAlign(t,M,k,"",getEditorRange(k))}}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"copyPlainText",label:window.siyuan.languages.copyPlainText,click(){if(k){const M=[],P=k.firstElementChild.scrollLeft,B=k.querySelector("table").scrollTop,N=k.querySelector(".table__select");k.querySelectorAll("th, td").forEach(Y=>{!Y.classList.contains("fn__none")&&isIncludeCell({tableSelectElement:N,scrollLeft:P,scrollTop:B,item:Y})&&M.push(Y)});let X="";M.forEach((Y,z)=>{X+=Y.textContent.trim()+"	",(!Y.nextElementSibling||!M[z+1]||Y.nextElementSibling!==M[z+1])&&(X=X.slice(0,-1)+`
`)}),copyPlainText(X.slice(0,-1)),focusBlock(k)}}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){k&&(focusByRange(getEditorRange(k)),document.execCommand("copy"))}}).element),!t.disabled){let M;window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){k&&(focusByRange(getEditorRange(k)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"clear",label:window.siyuan.languages.clear,icon:"iconTrashcan",accelerator:"\u2326",click(){clearTableCell(t,k)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click(){return xn(this,null,function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else if(k)try{const P=yield readClipboard();paste(t,Object.assign(P,{target:k}))}catch(P){console.log(P)}})}}).element)}window.siyuan.menus.menu.popup({x:S.clientX-8,y:S.clientY-16})}}const $=[],R=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(R.forEach(D=>{$.push(D.getAttribute("data-node-id"))}),countBlockWord($),getSelection().rangeCount>0){const D=getSelection().getRangeAt(0);if((D.toString()===""||window.siyuan.shiftIsPressed)&&a.detail>2){let B=hasClosestBlock(D.startContainer);if(B){if((L=B.nextElementSibling)!=null&&L.classList.contains("table"))setLastNodeRange(getContenteditableElement(B),D,!1);else if(B.classList.contains("table")){const N=B.querySelectorAll("th, td");B=N[N.length-1],B.contains(D.startContainer)&&setLastNodeRange(B,D,!1)}}return}if(R.length>0){D.collapse(!0),D.commonAncestorContainer.nodeType===1&&D.startContainer.childNodes[D.startOffset]&&D.startContainer.childNodes[D.startOffset].nodeType===1&&D.commonAncestorContainer.classList.contains("protyle-wysiwyg")&&focusBlock(D.startContainer.childNodes[D.startOffset]);return}const M=hasClosestBlock(D.startContainer);let P;if(S.detail>2&&D.endContainer.nodeType!==3&&["DIV","TD","TH"].includes(D.endContainer.tagName)&&D.endOffset===0){if(D.endContainer.classList.contains("protyle-attr")&&M)setLastNodeRange(getContenteditableElement(M),D,!1);else if(["TD","TH"].includes(D.endContainer.tagName)){const B=hasClosestByTag(D.startContainer,"TH")||hasClosestByTag(D.startContainer,"TD");B&&setLastNodeRange(B,D,!1)}}else P=hasClosestBlock(D.endContainer);M&&P&&P!==M&&(D.startContainer.nodeType===1&&D.startContainer.tagName==="DIV"&&D.startContainer.classList.contains("protyle-attr")||a.clientY>S.clientY?setFirstNodeRange(getContenteditableElement(P),D):D.endOffset===0&&D.endContainer.nodeType===1&&D.endContainer.tagName==="DIV"?setLastNodeRange(getContenteditableElement(M),D,!1):D.collapse(!0))}}})}bindEvent(t){t.observer=new ResizeObserver(()=>{const l=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(r=>{r.querySelector(".av__scroll")&&stickyRow(r,l,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const l=getSelection().getRangeAt(0);(this.element===l.startContainer||this.element.contains(l.startContainer))&&(t.toolbar.range=l.cloneRange())}),this.element.addEventListener("cut",l=>xn(this,null,function*(){var r,c,u;if(window.siyuan.ctrlIsPressed=!1,t.disabled)return;if(l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}t.options.render.breadcrumb&&t.breadcrumb.hide();const g=getEditorRange(t.wysiwyg.element);let m=hasClosestBlock(g.startContainer);if(!m){l.stopPropagation(),l.preventDefault();return}const d=isInEmbedBlock(m);d&&(m=d),l.stopPropagation(),l.preventDefault();const f=m.querySelector(".img--select"),b=m.querySelector(".av__row--select, .av__cell--select"),p=((r=m.querySelector(".table__select"))==null?void 0:r.clientWidth)>0;let y=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&g.toString()===""&&!g.cloneContents().querySelector("img")&&!f&&!b&&!p&&(m.classList.add("protyle-wysiwyg--select"),y=[m]);let _="",k="",x=!1,T=!1;if(y.length>0){y[0].getAttribute("data-type")==="NodeListItem"&&y[0].parentElement.classList.contains("list")&&y[0].parentElement.childElementCount-1===y.length&&(y.find(E=>{if(!y[0].parentElement.contains(E))return!0})||(y=[y[0].parentElement]));let w="";for(let h=0;h<y.length;h++){const E=getTopAloneElement(y[h]);let C="";E.getAttribute("data-type")==="NodeHeading"&&E.getAttribute("fold")==="1"?(T=!0,C=(yield fetchSyncPost("/api/block/getHeadingChildrenDOM",{id:E.getAttribute("data-node-id"),removeFoldAttr:!1})).data):E.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&E.querySelector('[data-type="NodeHeading"][fold="1"]')?(T=!0,C=(yield fetchSyncPost("/api/block/getBlockDOM",{id:E.getAttribute("data-node-id")})).data.dom):C=removeEmbed(E),E.getAttribute("data-type")==="NodeListItem"?(w||(w=`<div data-subtype="${E.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">`),w+=C,(h===y.length-1||y[h+1].getAttribute("data-type")!=="NodeListItem"||y[h+1].getAttribute("data-subtype")!==E.getAttribute("data-subtype"))&&(_+=`${w}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,w="")):_+=C}const v=getNextBlock(y[y.length-1]);removeBlock(t,m,g,"remove"),v&&focusBlock(v)}else if(b){T=!0;const w=yield updateCellsValue(t,m);_=JSON.stringify(w.json),k=w.text}else if(p){const w=[],v=m.firstElementChild.scrollLeft,h=m.querySelector("table").scrollTop,E=m.querySelector(".table__select");if(_="<table>",m.querySelectorAll("th, td").forEach(A=>{!A.classList.contains("fn__none")&&isIncludeCell({tableSelectElement:E,scrollLeft:v,scrollTop:h,item:A})&&w.push(A)}),E.removeAttribute("style"),getSelection().rangeCount>0){const A=getSelection().getRangeAt(0);m.contains(A.startContainer)&&A.insertNode(document.createElement("wbr"))}const C=m.outerHTML;(c=m.querySelector("wbr"))==null||c.remove(),m.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),w.forEach((A,S)=>{(S===0||!A.previousElementSibling||A.previousElementSibling!==w[S-1])&&(_+="<tr>"),_+=A.outerHTML,(!A.nextElementSibling||!w[S+1]||A.nextElementSibling!==w[S+1])&&(_+="</tr>"),A.innerHTML=""}),_+="</table>",k=t.lute.HTML2Md(_),updateTransaction(t,m.getAttribute("data-node-id"),m.outerHTML,C)}else{const w=m.getAttribute("data-node-id");setInsertWbrHTML(m,g,t);const v=t.wysiwyg.lastHTMLs[w]||m.outerHTML,h=document.createElement("div");let E=g.startContainer;if(E.nodeType===3&&E.textContent===""){const A=hasNextSibling(g.startContainer);A&&(E=A)}const C=hasClosestByAttribute(E,"data-type","NodeHeading");if(C&&g.toString()===C.firstElementChild.textContent)h.insertAdjacentHTML("afterbegin",C.firstElementChild.innerHTML),C.firstElementChild.innerHTML="";else if(g.toString()!==""&&E===g.endContainer&&g.startContainer.nodeType===3&&g.endOffset===g.endContainer.wholeText.length&&g.startOffset===0&&!["DIV","TD","TH","TR"].includes(g.startContainer.parentElement.tagName))h.append(g.startContainer.parentElement);else if(f)h.append(f);else if(g.startContainer.nodeType===3&&g.startContainer.parentElement.tagName==="SPAN"&&g.startContainer.parentElement.getAttribute("data-type")&&g.startContainer.parentElement===g.endContainer.parentElement){const A=g.startContainer.parentElement,S=A.attributes,L=document.createElement("span");for(let $=0;$<S.length;$++)L.setAttribute(S[$].name,S[$].value);A.getAttribute("data-type").indexOf("block-ref")>-1&&A.getAttribute("data-subtype")==="d"&&(L.setAttribute("data-subtype","s"),A.setAttribute("data-subtype","s")),L.textContent=g.toString(),g.deleteContents(),h.append(L)}else if(g.cloneContents().querySelectorAll("td, th").length>0){const A=document.createElement("wbr");g.insertNode(A),g.setStartAfter(A),h.append(g.extractContents()),m.outerHTML=t.lute.SpinBlockDOM(m.outerHTML),m=t.wysiwyg.element.querySelector(`[data-node-id="${w}"]`),mathRender(m),focusByWbr(m,g)}else{const A=hasClosestByAttribute(g.commonAncestorContainer,"data-type","inline-math");if(A)h.append(A);else{h.append(g.extractContents());let S;m.classList.contains("av")?updateAVName(t,m):m.classList.contains("table")?S=hasClosestByTag(g.startContainer,"TD")||hasClosestByTag(g.startContainer,"TH"):S=getContenteditableElement(m),S&&Array.from(S.children).forEach(L=>{L.textContent===""&&L.nodeType===1&&!["BR","IMG"].includes(L.tagName)&&L.remove()})}}if(this.emojiToMd(h),_=h.innerHTML,(hasClosestByAttribute(g.startContainer,"data-type","NodeCodeBlock")||hasClosestByTag(g.startContainer,"CODE"))&&(k=h.textContent.replace(Constants.ZWSP,""),x=!0),!m.classList.contains("table")){const A=getContenteditableElement(m);A&&A.textContent===""&&(A.innerHTML="")}m.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),m.getAttribute("data-type")==="NodeCodeBlock"&&(g.insertNode(document.createElement("wbr")),(u=m.querySelector('[data-render="true"]'))==null||u.removeAttribute("data-render"),highlightRender(m)),m.parentElement.parentElement&&!m.classList.contains("av")&&(setInsertWbrHTML(m,g,t),updateTransaction(t,w,t.wysiwyg.lastHTMLs[w]||m.outerHTML,v))}if(t.hint.render(t),b||(k=k||t.lute.BlockDOM2StdMd(_).trimEnd(),m.classList.contains("table")&&(k=k.replace(/<br>/g,`
`).replace(/<br\/>/g,`
`),k=k.endsWith(`
`)?k.replace(/\n$/,""):k)),k=k.replace(/\u00A0/g," "),l.clipboardData.setData("text/plain",k),!x){enableLuteMarkdownSyntax(t);const w=p?t.lute.HTML2BlockDOM(_):_;restoreLuteMarkdownSyntax(t),l.clipboardData.setData("text/siyuan",w);const v=`<!--data-siyuan='${encodeBase64(w)}'-->`+(p?_:t.lute.BlockDOM2HTML(b?k:_));if(l.clipboardData.setData("text/html",v),T)try{yield navigator.clipboard.write([new ClipboardItem({"text/plain":k,"text/html":v})])}catch(h){console.log("Cut write clipboard error:",h)}}}));let a;this.element.addEventListener("contextmenu",l=>{var r,c,u,g,m;if(l.shiftKey)return;l.stopPropagation(),l.preventDefault();const d=l.clientX||l.detail.x,f=l.clientY||l.detail.y,b=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>1){hideElements(["util"],t),t.gutter.renderMenu(t,b[0]),window.siyuan.menus.menu.popup({x:d,y:f});return}const p=l.detail.target||l.target,y=isInEmbedBlock(p);if(y)return getSelection().rangeCount===0&&focusSideBlock(y),t.gutter.renderMenu(t,y),window.siyuan.menus.menu.fullscreen(),!1;const _=hasClosestBlock(p);if(!_)return!1;const k=hasClosestByClassName(p,"av__gallery-item");if(k)return openGalleryItemMenu({target:k.querySelector(".protyle-icon--last"),protyle:t,position:{x:l.clientX,y:l.clientY}}),l.stopPropagation(),l.preventDefault(),!1;const x=hasClosestByClassName(p,"av__cell");if(x){if(x.classList.contains("av__cell--header")){t.disabled||showColMenu(t,_,x),l.stopPropagation(),l.preventDefault();return}if(getTypeByCellElement(x)==="mAsset"){const h=hasClosestByClassName(p,"av__cellassetimg")||hasClosestByClassName(p,"av__celltext--url");if(h){let E=0;Array.from(x.children).find((C,A)=>{if(C===h)return E=A,!0}),editAssetItem({protyle:t,cellElements:[x],blockElement:hasClosestBlock(h),content:p.tagName==="IMG"?p.getAttribute("src"):p.getAttribute("data-url"),type:p.tagName==="IMG"?"image":"file",name:p.tagName==="IMG"?"":p.getAttribute("data-name"),index:E,rect:p.getBoundingClientRect()}),l.stopPropagation(),l.preventDefault();return}}}const T=hasClosestByClassName(p,"av__row");if(T&&avContextmenu(t,T,{x:l.clientX,y:T.getBoundingClientRect().bottom,h:T.clientHeight})){l.stopPropagation(),l.preventDefault();return}const w=hasClosestByClassName(p,"item");if(_.classList.contains("av")&&w){w.classList.contains("item--focus")?openViewMenu({protyle:t,blockElement:_,element:w}):(transaction(t,[{action:"setAttrViewBlockView",blockID:_.getAttribute("data-node-id"),id:w.dataset.id,avID:_.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:_.getAttribute("data-node-id"),id:w.parentElement.querySelector(".item--focus").getAttribute("data-id"),avID:_.getAttribute("data-av-id")}]),window.siyuan.menus.menu.remove(),openViewMenu({protyle:t,blockElement:_,element:w})),l.stopPropagation(),l.preventDefault();return}if(t.toolbar.range=getEditorRange(t.element),p.tagName==="SPAN"&&!isNotEditBlock(_)){let h=((r=p.getAttribute("data-type"))==null?void 0:r.split(" "))||[];if(h.length===0&&(h=(p.dataset.type||"").split(" ")),h.length>0&&removeSearchMark(p),h.includes("block-ref"))return refMenu(t,p),p.setAttribute("prevent-popover","true"),setTimeout(()=>{p.removeAttribute("prevent-popover")},620),!1;if(h.includes("file-annotation-ref")&&!t.disabled)return fileAnnotationRefMenu(t,p),!1;if(h.includes("tag")&&!t.disabled)return tagMenu(t,p),!1;if(h.includes("inline-memo"))return t.toolbar.showRender(t,p),!1;if(h.includes("a"))return linkMenu(t,p),window.siyuan.config.editor.floatWindowMode===0&&((c=p.getAttribute("data-href"))!=null&&c.startsWith("siyuan://blocks"))&&(p.setAttribute("prevent-popover","true"),setTimeout(()=>{p.removeAttribute("prevent-popover")},620)),!1}const v=hasClosestByAttribute(p,"data-type","inline-math");if(v)return inlineMathMenu(t,v),!1;if(p.tagName==="IMG"&&hasClosestByClassName(p,"img"))return imgMenu(t,t.toolbar.range,p.parentElement.parentElement,{clientX:d+4,clientY:f}),!1;!isNotEditBlock(_)&&!_.classList.contains("protyle-wysiwyg--select")&&!hasClosestByClassName(p,"protyle-action")&&(isMobile()||l.detail.target||a&&_.contains(a.startContainer))?(!isMobile()||(u=t.toolbar)!=null&&u.element.classList.contains("fn__none"))&&!_.classList.contains("av")&&(contentMenu(t,_),window.siyuan.menus.menu.popup({x:d,y:f+13,h:26}),(g=t.toolbar)==null||g.element.classList.add("fn__none"),_.classList.contains("table")&&_.querySelector(".table__select").removeAttribute("style")):t.toolbar.range.toString()===""&&(hideElements(["util"],t),t.gutter&&t.gutter.renderMenu(t,_),window.siyuan.menus.menu.fullscreen(),(m=t.toolbar)==null||m.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?a=getSelection().getRangeAt(0):a=void 0});let n=!1;this.element.addEventListener("mousewheel",l=>{if(hideTooltip(),!n&&l.deltaY<0&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.clientHeight===t.contentElement.scrollHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{n=!1,onGet({data:c,protyle:t,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})}),n=!0),l.deltaX===0)return;const r=hasClosestByClassName(l.target,"table");if(r){const c=r.querySelector(".table__select");c!=null&&c.style.width&&(c.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0}),this.element.addEventListener("paste",l=>{if(l.target.localName==="input"&&l.target.getAttribute("data-type")==="av-search")return;if(t.disabled){l.stopPropagation(),l.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}if(!hasClosestByAttribute(l.target,"contenteditable","true")){l.stopPropagation(),l.preventDefault();return}const r=hasClosestBlock(l.target);if(r&&!getContenteditableElement(r)){l.stopPropagation(),l.preventDefault();return}if(!r)return;const c=getSelection().getRangeAt(0);t.toolbar.range=c;const u=c.startContainer.parentElement;if(c.toString()===""&&u.tagName==="SPAN"){const g=(u.getAttribute("data-type")||"").split(" ");if(g.includes("inline-memo")||g.includes("text")||g.includes("block-ref")||g.includes("file-annotation-ref")||g.includes("a")){const m=getSelectionOffset(u,r,c);m.start===0?(c.setStartBefore(u),c.collapse(!0)):m.start===u.textContent.length&&(c.setEndAfter(u),c.collapse(!1))}}paste(t,l)});let i=!1;this.element.addEventListener("compositionstart",l=>{i=!0;const r=getEditorRange(t.wysiwyg.element),c=hasClosestBlock(r.startContainer);!isMac()&&c&&setInsertWbrHTML(c,r,t),l.stopPropagation()}),this.element.addEventListener("compositionend",l=>{l.stopPropagation(),i=!1;const r=getEditorRange(this.element),c=hasClosestBlock(r.startContainer);if(c)if(l.data!=="")this.escapeInline(t,r,l),input(t,c,r,!0);else{const u=c.getAttribute("data-node-id");t.wysiwyg.lastHTMLs[u]&&updateTransaction(t,u,c.outerHTML,t.wysiwyg.lastHTMLs[u])}});let s;this.element.addEventListener("input",l=>{const r=l.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||l.inputType==="historyRedo")return;if(l.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const c=getEditorRange(this.element),u=hasClosestBlock(c.startContainer);u&&([":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(l.data)&&(t.hint.enableExtend=!0),!(l.isComposing||i||l.inputType==="deleteByDrag"||l.inputType==="insertFromDrop")&&(this.escapeInline(t,c,l),/^\d{1}$/.test(l.data)||l.data==="\u2018"||l.data==="\u201C"||l.data==="\u201D"||l.data==="\u300C"?(clearTimeout(s),s=window.setTimeout(()=>{input(t,u,c,!0)})):input(t,u,c,!0,l),l.stopPropagation()))}),this.element.addEventListener("keyup",l=>{const r=getEditorRange(this.element).cloneRange(),c=hasClosestBlock(r.startContainer);if(l.key!=="PageUp"&&l.key!=="PageDown"&&l.key!=="Home"&&l.key!=="End"&&l.key.indexOf("Arrow")===-1&&l.key!=="Escape"&&l.key!=="Shift"&&l.key!=="Meta"&&l.key!=="Alt"&&l.key!=="Control"&&l.key!=="CapsLock"&&!l.ctrlKey&&!l.shiftKey&&!l.metaKey&&!l.altKey&&!/^F\d{1,2}$/.test(l.key)){!isMac()&&c&&!i&&(typeof t.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"||r.toString()!==""||!this.preventKeyup)&&setInsertWbrHTML(c,r,t),this.preventKeyup=!1;return}if(this.preventKeyup){this.preventKeyup=!1;return}if((l.shiftKey||isOnlyMeta(l))&&!l.isComposing&&r.toString()!==""&&(t.toolbar.render(t,r,l),countSelectWord(r)),l.eventPhase!==3&&!l.shiftKey&&(l.key.indexOf("Arrow")>-1||l.key==="Home"||l.key==="End"||l.key==="PageUp"||l.key==="PageDown")&&!l.isComposing){if(c&&(clearSelect(["img","av"],t.wysiwyg.element),this.setEmptyOutline(t,c),r.toString()===""&&!c.classList.contains("protyle-wysiwyg--select")&&countSelectWord(r,t.block.rootID),t.breadcrumb)){const u=t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');if(u){const g=t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');c.parentElement.classList.contains("li")?(u.removeAttribute("disabled"),g.removeAttribute("disabled")):(u.setAttribute("disabled","true"),g.setAttribute("disabled","true"))}}l.stopPropagation()}if((l.key==="ArrowLeft"||l.key==="ArrowRight")&&c&&!c.classList.contains("protyle-wysiwyg--select")){const u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let g=!1;u.find(m=>{if(m.contains(r.startContainer))return g=!0,!0}),!g&&u.length>0&&(u.forEach(m=>{m.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",l=>{if(l.target.tagName==="IMG"&&!l.target.classList.contains("emoji")){previewDocImage(l.target.getAttribute("src"),t.block.rootID);return}});let o=!1;this.element.addEventListener("click",l=>{if(this.preventClick){this.preventClick=!1;return}t.app.plugins.forEach(S=>{S.eventBus.emit("click-editorcontent",{protyle:t,event:l})}),hideElements(["hint","util"],t);const r=isOnlyMeta(l),c=hasClosestByClassName(l.target,"protyle-breadcrumb__item");if(c){c.getAttribute("data-id")&&loadBreadcrumb(t,c),l.stopPropagation();return}this.setEmptyOutline(t,l.target);const u=hasClosestByClassName(l.target,"table");this.element.querySelectorAll(".table").forEach(S=>{S.tagName==="DIV"&&((!u||S!==u)&&S.querySelector(".table__select").removeAttribute("style"),u&&u===S&&S.querySelector(".table__select").getAttribute("style")&&l.stopPropagation())}),t.options.render.breadcrumb&&t.breadcrumb.render(t,!1,hasClosestBlock(l.target));const g=getEditorRange(this.element);g.startContainer.nodeType!==3&&g.startContainer.classList.contains("protyle-action")&&g.startContainer.parentElement.classList.contains("code-block")&&setFirstNodeRange(g.startContainer.parentElement.querySelector(".hljs").lastElementChild,g);const m=hasClosestByAttribute(l.target,"data-type","a")||hasClosestByClassName(l.target,"av__celltext--url");let d=m&&m.getAttribute("data-href")||"";m&&!d&&m.classList.contains("av__celltext--url")&&(d=m.textContent.trim(),m.dataset.type==="phone"?d="tel:"+d:m.dataset.type==="email"?d="mailto:"+d:m.classList.contains("b3-chip")&&(d=m.dataset.url));const f=hasClosestByAttribute(l.target,"data-type","block-ref");if((f||d.startsWith("siyuan://blocks/"))&&(l.stopPropagation(),l.preventDefault(),hideElements(["dialog","toolbar"],t),g.toString()===""||l.shiftKey)){let S;f?S=f.getAttribute("data-id"):m&&(S=d.substring(16,38)),checkFold(S,(L,$,R)=>{R||$.push(Constants.CB_GET_HL),o=!0,activeBlur(),openMobileFileById(t.app,S,L?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])});return}const b=hasClosestByAttribute(l.target,"data-type","virtual-block-ref");if(b&&g.toString()===""){l.stopPropagation(),l.preventDefault();const S=hasClosestBlock(b);S&&fetchPost("/api/block/getBlockDefIDsByRefText",{anchor:b.textContent,excludeIDs:[S.getAttribute("data-node-id")]},L=>{checkFold(L.data.refDefs[0].refID,$=>{o=!0,activeBlur(),openMobileFileById(t.app,L.data.refDefs[0].refID,$?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])})});return}const p=hasClosestByAttribute(l.target,"data-type","file-annotation-ref");if(p&&g.toString()===""){l.stopPropagation(),l.preventDefault(),openLink(t,p.getAttribute("data-id"),l,r);return}if(m&&(l.shiftKey||g.toString()==="")&&d){l.stopPropagation(),l.preventDefault(),openLink(t,d,l,r);return}if(m&&m.classList.contains("av__celltext--url")&&!d){let S=0;Array.from(m.parentElement.children).find((L,$)=>{if(L===m)return S=$,!0}),editAssetItem({protyle:t,cellElements:[m.parentElement],blockElement:hasClosestBlock(m),content:m.getAttribute("data-url"),type:"file",name:m.getAttribute("data-name"),index:S,rect:m.getBoundingClientRect()});return}const y=hasClosestByAttribute(l.target,"data-type","tag");if(y&&!l.altKey&&!l.shiftKey&&g.toString()===""){popSearch(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${y.textContent}#`,r:"",page:1});return}const _=hasClosestByClassName(l.target,"protyle-wysiwyg__embed");if(_){const S=_.getAttribute("data-id");if(checkFold(S,(L,$)=>{o=!0,activeBlur(),openMobileFileById(t.app,S,L?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),!r){l.stopPropagation();return}}if(commonClick(l,t)||hasTopClosestByClassName(l.target,"protyle-action__copy"))return;const k=hasClosestByClassName(l.target,"protyle-action__edit");if(k&&!t.disabled){t.toolbar.showRender(t,k.parentElement.parentElement),l.stopPropagation(),l.preventDefault();return}const x=hasClosestByClassName(l.target,"protyle-action__menu");if(x){t.gutter.renderMenu(t,x.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),l.stopPropagation(),l.preventDefault();return}const T=hasClosestByClassName(l.target,"protyle-action__reload");if(T){const S=isInEmbedBlock(T);if(S)S.removeAttribute("data-render"),blockRender(t,S);else{const L=hasClosestBlock(T);L&&L.getAttribute("data-subtype")==="echarts"&&(L.removeAttribute("data-render"),chartRender(L))}l.stopPropagation(),l.preventDefault();return}const w=hasClosestByClassName(l.target,"protyle-action__language");if(w&&!t.disabled&&!r){t.toolbar.showCodeLanguage(t,[w]),l.stopPropagation(),l.preventDefault();return}const v=hasClosestByAttribute(l.target,"data-subtype","math");if(!l.shiftKey&&!r&&v&&!t.disabled){t.toolbar.showRender(t,v),l.stopPropagation();return}const h=hasClosestByClassName(l.target,"protyle-action");if(h){if(h.parentElement.parentElement.getAttribute("data-type")==="img"&&!t.disabled){imgMenu(t,g,h.parentElement.parentElement,{clientX:l.clientX+4,clientY:l.clientY}),l.stopPropagation();return}else if(h.parentElement.classList.contains("li")){const L=h.parentElement.getAttribute("data-node-id");if(l.altKey&&!t.disabled){if(h.parentElement.parentElement.classList.contains("protyle-wysiwyg"))setFold(t,h.parentElement);else{let $=!0;const R=h.parentElement.parentElement.outerHTML;Array.from(h.parentElement.parentElement.children).find(D=>{if(D.classList.contains("li")&&D.getAttribute("fold")!=="1"&&D.childElementCount>3)return $=!1,!0}),Array.from(h.parentElement.parentElement.children).find(D=>{D.classList.contains("li")&&($?D.removeAttribute("fold"):D.childElementCount>3&&D.setAttribute("fold","1"))}),updateTransaction(t,h.parentElement.parentElement.getAttribute("data-node-id"),h.parentElement.parentElement.outerHTML,R)}hideElements(["gutter"],t)}else if(l.shiftKey&&!t.disabled)openAttr(h.parentElement,"bookmark",t);else if(r)zoomOut({protyle:t,id:L});else if(h.classList.contains("protyle-action--task")){if(!t.disabled){const $=h.parentElement.outerHTML;h.parentElement.classList.contains("protyle-task--done")?(h.querySelector("use").setAttribute("xlink:href","#iconUncheck"),h.parentElement.classList.remove("protyle-task--done")):(h.querySelector("use").setAttribute("xlink:href","#iconCheck"),h.parentElement.classList.add("protyle-task--done")),h.parentElement.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,L,h.parentElement.outerHTML,$)}}else window.siyuan.config.editor.listItemDotNumberClickFocus&&(t.block.showAll&&t.block.id===L?enterBack(t,L):zoomOut({protyle:t,id:L}));l.stopPropagation();return}}const E=hasClosestByClassName(l.target,"hr")||hasClosestByClassName(l.target,"iframe");if(!l.shiftKey&&!r&&E){E.classList.add("protyle-wysiwyg--select"),globalClickHideMenu(l.target),l.stopPropagation();return}const C=hasTopClosestByClassName(l.target,"img");if(!l.shiftKey&&!r&&C){C.classList.add("img--select");const S=hasNextSibling(C);S&&(S.textContent.startsWith(Constants.ZWSP)?g.setStart(S,1):g.setStart(S,0),g.collapse(!0),focusByRange(g),t.options.render.breadcrumb&&t.breadcrumb.render(t));return}const A=hasTopClosestByClassName(l.target,"emoji");if(!t.disabled&&!l.shiftKey&&!r&&A){const S=hasClosestBlock(A);if(S){const L=A.getBoundingClientRect();openEmojiPanel("","av",{x:L.left,y:L.bottom,h:L.height,w:L.width},$=>{A.insertAdjacentHTML("afterend","<wbr>");const R=S.outerHTML;let D;if($.startsWith("api/icon/getDynamicIcon"))D=`<img class="emoji" src="${$}"/>`;else if($.indexOf(".")>-1){const M=$.split(".");D=`<img alt="${M[0]}" class="emoji" src="/emojis/${$}" title="${M[0]}">`}else D=unicode2Emoji($);A.outerHTML=D,hideElements(["dialog"]),updateTransaction(t,S.getAttribute("data-node-id"),S.outerHTML,R),focusByWbr(S,g)},A)}return}avClick(t,l)||(setTimeout(()=>{var S;let L=getEditorRange(this.element);if(hasClosestBlock(l.target)!==hasClosestBlock(L.startContainer)&&((S=this.element.querySelector("[data-node-id]"))!=null&&S.contains(L.startContainer))){const D=this.element.getBoundingClientRect();let M=document.elementFromPoint(D.left+D.width/2,l.clientY);M===this.element&&(M=document.elementFromPoint(D.left+D.width/2,l.clientY+8));let P=hasClosestBlock(M);if(P){const B=isInEmbedBlock(P);B&&(P=B),L=focusBlock(P,void 0,l.clientX<D.left+parseInt(this.element.style.paddingLeft))||L,t.options.render.breadcrumb&&t.breadcrumb.render(t,!1,P)}}const $=hasClosestByClassName(L.endContainer,"protyle-attr");$&&(L=setLastNodeRange($.previousElementSibling,L,!1));const R=hasClosestByAttribute(L.startContainer,"data-type","inline-math");R&&(L.setEndAfter(R),L.collapse(!1),focusByRange(L)),t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||countSelectWord(L,t.block.rootID),getSelection().rangeCount===0&&!o&&focusByRange(L),o=!1},isMobile()||isInIOS()?520:0),t.hint.enableExtend=!1,this.element.querySelector(".protyle-wysiwyg--select")&&g.toString()!==""&&(g.collapse(!1),focusByRange(g)))})}}var ro=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class Xu extends Kt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>ro(this,null,function*(){t.toolbar.element.classList.add("fn__none"),n.stopPropagation();const i=t.toolbar.range;if(!G(i.startContainer))return;const o=F(i.startContainer,"data-type","a");if(o){Gs(t,o);return}let l="",r=i.toString().trim().replace(H.ZWSP,""),c=!1;try{if(l=t.lute.GetLinkDest(r),!l){const g=yield Wi(),m=g.textHTML||t.lute.Md2BlockDOM(g.textPlain);if(m){const d=document.createElement("template");d.innerHTML=m;const f=d.content.querySelector('span[data-type~="a"], a');f&&(r=r||f.textContent,l=f.getAttribute("data-href")||f.getAttribute("href"))}if(l||(l=t.lute.GetLinkDest(g.textPlain)),!l){const d=g.textPlain.lastIndexOf(" ");d>-1&&(l=t.lute.GetLinkDest(g.textPlain.substring(d)),l&&!r&&(r=g.textPlain.substring(0,d)))}!l&&g.textPlain.startsWith("assets/")&&(l=g.textPlain),l&&!r&&(r=decodeURIComponent(l.replace("https://","").replace("http://","")),l.length>H.SIZE_LINK_TEXT_MAX&&(r=l.substring(0,H.SIZE_LINK_TEXT_MAX)+"..."),c=!0)}}catch(g){console.log(g)}const u=t.toolbar.setInlineMark(t,"a","range",{type:"a",color:l+(r?H.ZWSP+r:"")});c&&Gs(t,u[0],!0)}))}}class Ju extends Kt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>{t.toolbar.range.toString()!==""&&(qi(t.toolbar.range),Po(t.toolbar.range.toString(),t,"search"),t.toolbar.element.classList.add("fn__none"),n.stopPropagation())})}}var co=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class Qu extends Kt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>co(this,null,function*(){t.toolbar.element.classList.add("fn__none"),n.stopPropagation();const i=t.toolbar.range;if(!G(i.startContainer))return;let o=F(i.startContainer,"data-type","inline-math");if(!o&&i.startContainer.nodeType!==3&&i.startContainer.childNodes[i.startOffset]){const l=Vt(i.startContainer.childNodes[i.startOffset]);l&&l.nodeType!==3&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(o=l)}if(!o&&i.startOffset===i.startContainer.textContent.length&&i.startContainer.nodeType===3){let l=!0,r=!1;if(i.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:l=!1}),l&&r){const c=Ya(i.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)o=c;else{const u=Vt(i.startContainer);i.startOffset===0&&u&&u.nodeType!==3&&u.getAttribute("data-type").indexOf("inline-math")>-1&&(o=u)}}}if(o){t.toolbar.showRender(t,o);return}t.toolbar.setInlineMark(t,"inline-math","range",{type:"inline-math"})}))}}var uo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class ef extends Kt{constructor(t,a){super(t,a),this.element.addEventListener("click",n=>uo(this,null,function*(){t.toolbar.element.classList.add("fn__none"),n.stopPropagation();const i=t.toolbar.range;if(!G(i.startContainer))return;const o=F(i.startContainer,"data-type","inline-memo");if(o&&o.textContent===i.toString()){t.toolbar.showRender(t,o);return}i.toString()!==""&&t.toolbar.setInlineMark(t,"inline-memo","range",{type:"inline-memo"})}))}}var fo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class tf{constructor(t){const a=t.options,n=document.createElement("div");n.className="protyle-toolbar fn__none",this.element=n,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,t.app.plugins.forEach(i=>{const s=i.updateProtyleToolbar(a.toolbar);s.forEach(o=>{typeof o=="string"||Constants.INLINE_TYPE.concat("|").includes(o.name)||!o.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[i.name]&&window.siyuan.config.keymap.plugin[i.name][o.name]&&(o.hotkey=window.siyuan.config.keymap.plugin[i.name][o.name].custom)}),a.toolbar=toolbarKeyToMenu(s)}),a.toolbar.forEach(i=>{const s=this.genItem(t,i);this.element.appendChild(s)})}update(t){this.element.innerHTML="",t.options.toolbar=toolbarKeyToMenu(Constants.PROTYLE_TOOLBAR),t.app.plugins.forEach(a=>{const n=a.updateProtyleToolbar(t.options.toolbar);n.forEach(i=>{typeof i=="string"||Constants.INLINE_TYPE.concat("|").includes(i.name)||!i.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[a.name]&&window.siyuan.config.keymap.plugin[a.name][i.name]&&(i.hotkey=window.siyuan.config.keymap.plugin[a.name][i.name].custom)}),t.options.toolbar=toolbarKeyToMenu(n)}),t.options.toolbar.forEach(a=>{const n=this.genItem(t,a);this.element.appendChild(n)})}render(t,a,n){this.range=a;let i=hasClosestBlock(a.startContainer);if(isMobile()||!i||t.disabled||i.classList.contains("av")){this.element.classList.add("fn__none");return}let s=!1;if(Array.from(a.cloneContents().childNodes).find(g=>{if(g.textContent.length>0&&g.textContent!==Constants.ZWSP&&!(g.nodeType===1&&g.classList.contains("img")))return s=!0,!0}),!s||a.commonAncestorContainer.nodeType!==3&&a.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const o=hasClosestBlock(a.startContainer),l=hasClosestBlock(a.endContainer);if(o&&l&&o!==l){if(n)if(n.key==="ArrowLeft")this.range=setLastNodeRange(getContenteditableElement(o),a,!1);else if(n.key==="ArrowRight")this.range=setFirstNodeRange(getContenteditableElement(l),a),this.range.collapse(!1);else if(n.key==="ArrowUp"){if(this.range=setFirstNodeRange(getContenteditableElement(l),a),i=hasClosestBlock(l),!i)return}else n.key==="ArrowDown"&&(this.range=setLastNodeRange(getContenteditableElement(o),a,!1));else this.range=setLastNodeRange(getContenteditableElement(i),a,!1);if(focusByRange(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(i.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const r=getSelectionPosition(i,a,!0);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const c=r.isBottom?Math.min(r.top+4,t.element.getBoundingClientRect().bottom-this.toolbarHeight):Math.max(r.top-this.toolbarHeight-4,t.element.getBoundingClientRect().top+30);this.element.setAttribute("data-inity",c+Constants.ZWSP+t.contentElement.scrollTop.toString()),setPosition(this.element,r.left-this.element.clientWidth/4,c),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(g=>{g.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(g=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(g))return;const m=this.element.querySelector(`[data-type="${g}"]`);m&&m.classList.add("protyle-toolbar__item--current")})}getCurrentType(t=this.range){var a,n;let i=[],s=t.startContainer;if(s.nodeType===3?s=s.parentElement:s.childElementCount>0&&((a=s.childNodes[t.startOffset])==null?void 0:a.nodeType)!==3&&(s=s.childNodes[t.startOffset],(s==null?void 0:s.tagName)==="WBR"&&(s=s.parentElement)),!s||s.nodeType===3)return[];["DIV","TD","TH","TR"].includes(s.tagName)||(i=(s.getAttribute("data-type")||"").split(" "));let o=t.endContainer;return o.nodeType===3?o=o.parentElement:o.childElementCount>0&&((n=o.childNodes[t.endOffset])==null?void 0:n.nodeType)!==3&&(o=o.childNodes[t.endOffset]),i.length===0&&(!o||o.nodeType===3)?[]:(o&&!["DIV","TD","TH","TR"].includes(o.tagName)&&s!==o&&(i=i.concat((o.getAttribute("data-type")||"").split(" "))),t.cloneContents().childNodes.forEach(l=>{l.nodeType!==3&&(i=i.concat((l.getAttribute("data-type")||"").split(" ")))}),i=[...new Set(i)],i.find((l,r)=>{if(l==="")return i.splice(r,1),!0}),i)}setInlineMark(t,a,n,i){const s=hasClosestBlock(this.range.startContainer);if(!s||s.getAttribute("data-type")==="NodeCodeBlock")return;const o=hasClosestBlock(this.range.endContainer);if(!o)return;s!==o&&(this.range=setLastNodeRange(getContenteditableElement(s),this.range,!1));let l=[];this.range.cloneContents().childNodes.forEach(h=>{h.nodeType!==3&&(l=l.concat((h.getAttribute("data-type")||"").split(" ")))});let r=hasNextSibling(this.range.startContainer);for(;r&&r.nodeType===1&&r.tagName==="BR";)r=hasNextSibling(r);const c=this.range.startContainer===this.range.endContainer||r&&r===this.range.endContainer&&this.range.startContainer.parentElement===this.range.endContainer.parentElement;this.range.startContainer.nodeType===3&&this.range.startContainer.parentElement.tagName==="SPAN"&&c&&this.range.startOffset>-1&&this.range.endOffset<=this.range.endContainer.textContent.length&&(l=l.concat((this.range.startContainer.parentElement.getAttribute("data-type")||"").split(" ")));const u=this.range.toString();let g=!1;if(!u&&this.range.startOffset===1&&this.range.startContainer.textContent===Constants.ZWSP){let h;this.range.startContainer.nodeType===1?h=this.range.startContainer:h=this.range.startContainer.parentElement,h.tagName==="SPAN"&&(l=l.concat((h.getAttribute("data-type")||"").split(" ")),this.range.setStart(h.firstChild,0),this.range.setEnd(h.lastChild,h.lastChild.textContent.length||0),g=!0)}if(l.length===1&&["block-ref","virtual-block-ref","file-annotation-ref","a","inline-memo","inline-math","tag"].includes(l[0])&&a==="clear")return;if(l.includes("text")&&a==="text"&&i&&this.range.startContainer.nodeType===3&&this.range.startContainer===this.range.endContainer){const h=this.range.startContainer.parentElement;if(h&&hasSameTextStyle(null,h,i))return}fixTableRange(this.range);let m,d,f;if(this.range.startContainer.nodeType===3&&this.range.startContainer.parentElement.tagName==="SPAN"&&c){this.range.startOffset>-1&&this.range.endOffset<=this.range.endContainer.textContent.length&&(f=this.range.startContainer.parentElement);const h=hasPreviousSibling(this.range.startContainer),E=hasNextSibling(this.range.endContainer);if((this.range.startOffset!==0||this.range.startOffset===0&&h&&(h.nodeType===3||h.tagName==="BR")&&this.range.startContainer.previousSibling.parentElement===this.range.startContainer.parentElement)&&(this.range.endOffset!==this.range.endContainer.textContent.length||this.range.endOffset===this.range.endContainer.textContent.length&&E&&(E.nodeType===3||E.tagName==="BR")&&this.range.endContainer.nextSibling.parentElement===this.range.endContainer.parentElement)&&!(this.range.startOffset===1&&this.range.startContainer.textContent.startsWith(Constants.ZWSP))){const C=this.range.startContainer.parentElement,A=document.createElement("span"),S=C.attributes;for(let L=0;L<S.length;L++)A.setAttribute(S[L].name,S[L].value);this.range.insertNode(document.createElement("wbr")),d=s.outerHTML,m=this.range.extractContents(),this.range.setEnd(C.lastChild,C.lastChild.textContent.length),A.append(this.range.extractContents()),C.after(A),this.range.setStartBefore(A),this.range.collapse(!0)}}let b=!1;if(this.range.endOffset===this.range.startContainer.textContent.length&&!["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)&&!hasNextSibling(this.range.endContainer)&&(this.range.setEndAfter(this.range.endContainer.parentElement),b=!0),this.range.startOffset===0&&!["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)&&!hasPreviousSibling(this.range.startContainer)&&this.range.setStartBefore(this.range.startContainer.parentElement),d||(this.range.insertNode(document.createElement("wbr")),d=s.outerHTML,m=this.range.extractContents()),this.mergeNode(m.childNodes),m.childNodes.forEach(h=>{h.nodeType===3&&h.textContent===Constants.ZWSP&&h.remove(),h.nodeType===1&&h.textContent===""&&h.tagName==="SPAN"&&h.remove()}),u&&this.range.startContainer.nodeType!==3){let h=this.range.startContainer.childNodes[this.range.startOffset];h||(h=this.range.startContainer.childNodes[this.range.startOffset-1]),h&&h.nodeType===3&&(this.range.startContainer.tagName==="DIV"?h=h.previousSibling:h=this.range.startContainer),h&&h.nodeType!==3&&h.textContent.replace(Constants.ZWSP,"")===""&&!["TD","TH","BR"].includes(h.tagName)&&h.remove()}if(f){const h=f.attributes;m.childNodes.forEach(E=>{if(E.nodeType===3){const C=document.createElement("span");for(let A=0;A<h.length;A++)C.setAttribute(h[A].name,h[A].value);C.innerHTML=E.textContent,E.replaceWith(C)}})}const p=isMobile()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,y=n==="toolbar"?p.querySelector(`[data-type="${a}"]`):void 0,_=[];let k,x,T,w;if(a==="clear"||y!=null&&y.classList.contains("protyle-toolbar__item--current")||n==="range"&&l.length>0&&l.includes(a)&&!i){if(a==="clear"?p.querySelectorAll('[data-type="strong"],[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="kbd"],[data-type="mark"],[data-type="code"]').forEach(h=>{h.classList.remove("protyle-toolbar__item--current")}):y&&y.classList.remove("protyle-toolbar__item--current"),m.childNodes.length===0){if(l.find((h,E)=>{if(a===h)return l.splice(E,1),!0}),l.length===0||a==="clear")_.push(document.createTextNode(Constants.ZWSP)),k=_[0];else{let h=0;for(;h<l.length;)["inline-memo","text","block-ref","virtual-block-ref","file-annotation-ref","a"].includes(l[h])?l.splice(h,1):++h;const E=document.createElement("span");E.setAttribute("data-type",l.join(" ")),E.textContent=Constants.ZWSP,_.push(E),k=_[0].firstChild}g=!0,T=1}m.childNodes.forEach(h=>{if(h.nodeType!==3&&h.tagName!=="BR"&&h.tagName!=="IMG"&&!h.classList.contains("img")){const E=(h.getAttribute("data-type")||"").split(" ");if(a==="clear")for(let C=0;C<E.length;C++)i&&i.type==="text"?E[C]==="text"&&(E.splice(C,1),C--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(E[C])&&(E.splice(C,1),C--);else E.find((C,A)=>{if(a===C)return E.splice(A,1),!0});E.length===0?_.push(document.createTextNode(h.textContent)):(a==="clear"&&(h.style.color="",h.style.webkitTextFillColor="",h.style.webkitTextStroke="",h.style.textShadow="",h.style.backgroundColor="",h.style.fontSize=""),h.setAttribute("data-type",E.join(" ")),_.push(h))}else _.push(h)})}else if(!this.element.classList.contains("fn__none")&&a!=="text"&&y&&y.classList.add("protyle-toolbar__item--current"),u===""){const h=document.createElement("span");if(l.push(a),b){let E=0;for(;E<l.length;)["inline-memo","text","block-ref","virtual-block-ref","file-annotation-ref","a"].includes(l[E])?l.splice(E,1):++E;l.length===0&&l.push(a)}h.setAttribute("data-type",[...new Set(l)].join(" ")),h.textContent=Constants.ZWSP,setFontStyle(h,i),_.push(h),g=!0}else{if(a==="block-ref")for(;m.childNodes.length>1;)m.childNodes[0].remove();m.childNodes.forEach(h=>{let E="";if(h.nodeType===3&&h.textContent){for(;h.textContent.endsWith(`
`);)h.textContent=h.textContent.substring(0,h.textContent.length-1),E+=`
`;if(h.textContent){const C=document.createElement("span");C.setAttribute("data-type",a),C.textContent=h.textContent,a==="a"&&(C.textContent||(C.textContent="*"),i.color=i.color.split(Constants.ZWSP)[0]),setFontStyle(C,i),a==="text"&&!C.getAttribute("style")?_.push(h):_.push(C)}}else if(h.nodeType===1){let C=(h.getAttribute("data-type")||"").split(" ");for(let A=0;A<C.length;A++)["backslash","virtual-block-ref","search-mark"].includes(C[A])&&(C.splice(A,1),A--);if(C.includes("img")||C.push(a),a==="sub"&&C.includes("sup")?C.find((A,S)=>{if(A==="sup")return C.splice(S,1),p.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):a==="sup"&&C.includes("sub")?C.find((A,S)=>{if(A==="sub")return C.splice(S,1),p.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):a==="block-ref"&&(C.includes("a")||C.includes("file-annotation-ref"))?C.find((A,S)=>{if(A==="a"||A==="file-annotation-ref")return C.splice(S,1),!0}):a==="a"&&(C.includes("block-ref")||C.includes("file-annotation-ref"))?C.find((A,S)=>{if(A==="block-ref"||A==="file-annotation-ref")return C.splice(S,1),!0}):a==="file-annotation-ref"&&(C.includes("block-ref")||C.includes("a"))?C.find((A,S)=>{if(A==="block-ref"||A==="a")return C.splice(S,1),!0}):a==="inline-memo"&&C.includes("inline-math")?(C.find((A,S)=>{if(A==="inline-math")return C.splice(S,1),!0}),h.querySelector(".katex")&&(h.textContent=h.getAttribute("data-content"))):a==="inline-math"&&C.includes("inline-memo")&&C.find((A,S)=>{if(A==="inline-memo")return C.splice(S,1),!0}),C=[...new Set(C)],h.tagName!=="BR"&&h.tagName!=="IMG"&&!C.includes("img"))if(h.setAttribute("data-type",C.join(" ")),a==="a"&&(h.textContent||(h.textContent="*"),i.color=i.color.split(Constants.ZWSP)[0]),setFontStyle(h,i),C.includes("text")&&!h.getAttribute("style"))if(C.length===1){const A=document.createTextNode(h.textContent);_.push(A)}else C.splice(C.indexOf("text"),1),h.setAttribute("data-type",C.join(" ")),_.push(h);else _.push(h);else _.push(h)}E&&_.push(document.createTextNode(E))})}for(let h=_.length-1;h>-1;h--)this.range.insertNode(_[h]);if(_.length===1&&_[0].textContent===Constants.ZWSP&&(this.range.setStart(_[0],1),this.range.collapse(!0),_[0].nodeType!==3)){const h=(_[0].getAttribute("data-type")||"").split(" ");(h.includes("code")||h.includes("tag")||h.includes("kbd"))&&(g=!1)}if(!g){for(let h=0;h<=_.length;h++){let E=h===_.length?_[h-1]:hasPreviousSibling(_[h]);E.nodeType===3&&E.textContent===Constants.ZWSP&&(E=hasPreviousSibling(E),E&&E.nextSibling.remove());let C=_[h];if(C||(C=hasNextSibling(_[h-1]),C&&C.nodeType===3&&C.textContent===Constants.ZWSP&&(C=hasNextSibling(C),C&&C.previousSibling.remove())),C&&C.nodeType!==3){const A=(C.getAttribute("data-type")||"").split(" ");if(C.tagName!=="BR"&&E&&E.nodeType!==3&&C.nodeType!==3&&isArrayEqual(A,(E.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(C,E)&&((A.includes("code")||A.includes("tag")||A.includes("kbd"))&&C.textContent.startsWith(Constants.ZWSP)&&(C.textContent=C.textContent.substring(1)),A.includes("inline-math")?C.setAttribute("data-content",E.getAttribute("data-content")+C.getAttribute("data-content")):A.includes("block-ref")&&E.getAttribute("data-id")===C.getAttribute("data-id")?(E.dataset.subtype!=="d"||E.dataset.subtype!=="d")&&(C.setAttribute("data-subtype","s"),C.textContent=E.textContent+C.textContent):(C.textContent=E.innerText+C.innerText,A.includes("inline-memo")&&C.setAttribute("data-inline-memo-content",(E.getAttribute("data-inline-memo-content")||"")+(C.getAttribute("data-inline-memo-content")||""))),A.includes("inline-math")||(h===0?(k=C,T=E.textContent.length):h===_.length&&(x=C,w=E.textContent.length,k?k===E&&(k=C):k=C)),E.remove(),h>0&&(_.splice(h-1,1),h--),_.length===0)){_.push(C);break}}}for(let h=0;h<=_.length;h++){const E=h===_.length?_[h-1]:hasPreviousSibling(_[h]);let C=_[h];if(C||(C=hasNextSibling(_[h-1])),!C){if(E.nodeType!==3){const A=(E.getAttribute("data-type")||"").split(" ");(A.includes("code")||A.includes("tag")||A.includes("kbd"))&&E.insertAdjacentText("afterend",Constants.ZWSP)}break}if(C.nodeType===3)if(E&&E.nodeType===3)C.textContent.startsWith(Constants.ZWSP)&&(C.textContent=C.textContent.substring(1)),E.textContent.endsWith(Constants.ZWSP)&&(E.textContent=E.textContent.substring(0,E.textContent.length-2));else{const A=E?(E.getAttribute("data-type")||"").split(" "):[];A.includes("code")||A.includes("tag")||A.includes("kbd")?C.textContent.startsWith(Constants.ZWSP)||(C.textContent=Constants.ZWSP+C.textContent):C.textContent.startsWith(Constants.ZWSP)&&(C.textContent=C.textContent.substring(1))}else{const A=C.nodeType===3?[]:(C.getAttribute("data-type")||"").split(" ");if(A.includes("code")||A.includes("tag")||A.includes("kbd")?(C.textContent.startsWith(Constants.ZWSP)||C.insertAdjacentText("afterbegin",Constants.ZWSP),(!E||E.nodeType===3&&E.textContent.endsWith(`
`))&&C.insertAdjacentText("beforebegin",Constants.ZWSP)):C.textContent.startsWith(Constants.ZWSP)&&(C.textContent=C.textContent.substring(1)),E&&E.nodeType!==3){const S=(E.getAttribute("data-type")||"").split(" ");(S.includes("code")||S.includes("tag")||S.includes("kbd"))&&C.insertAdjacentText("beforebegin",Constants.ZWSP)}}}}s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s.getAttribute("data-node-id"),s.outerHTML,d),s.querySelectorAll("wbr").forEach(h=>{h.remove()}),k&&typeof T=="number"&&(k.nodeType===3?this.range.setStart(k,T):this.range.setStart(k.firstChild,T)),x&&typeof w=="number"&&(x.nodeType===3?this.range.setEnd(x,w):this.range.setEnd(x.firstChild,w)),focusByRange(this.range);const v=_[0];if(v.nodeType!==3){const h=(v.getAttribute("data-type")||"").split(" ");a==="inline-math"?(mathRender(s),u===""&&h.includes("inline-math")&&t.toolbar.showRender(t,v,void 0,d)):a==="inline-memo"?!v.getAttribute("data-inline-memo-content")&&h.includes("inline-memo")&&t.toolbar.showRender(t,v,_,d):a==="a"&&h.includes("a")&&(v.textContent.replace(Constants.ZWSP,"")===""||!v.getAttribute("data-href"))&&linkMenu(t,v,!!v.getAttribute("data-href"))}return _}showRender(t,a,n,i){var s;const o=hasClosestBlock(a);if(!o)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove();const l=o.getAttribute("data-node-id"),r=(a.getAttribute("data-type")||"").split(" "),c=i||o.outerHTML;let u="HTML",g="";const m=r.includes("inline-memo");switch(a.getAttribute("data-subtype")){case"abc":u=window.siyuan.languages.staff;break;case"echarts":u=window.siyuan.languages.chart;break;case"flowchart":u="Flow Chart";break;case"graphviz":u="Graphviz";break;case"mermaid":u="Mermaid";break;case"mindmap":g=`- foo
  - bar
- baz`,u=window.siyuan.languages.mindmap;break;case"plantuml":u="UML";break;case"math":r.includes("NodeMathBlock")?u=window.siyuan.languages.math:u=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?u=window.siyuan.languages.blockEmbed:m&&(u=window.siyuan.languages.memo);const d=((s=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:s.getAttribute("aria-label"))===window.siyuan.languages.unpin,f={};if(d){const T=this.subElement.querySelector(".b3-text-field");f.styleH=T.style.height,f.styleW=T.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${d&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move" style="line-height: 24px;">
        ${u}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${d&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages.insertBefore}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages.insertAfter}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${d?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${d?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px;margin: 0 2px;"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${t.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${g}" style="${isMobile()?"":"width:"+Math.max(480,a.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const b=()=>{if(_.style.height=_.scrollHeight+"px",isMobile()){setPosition(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){_.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const T=x.bottom===x.top?x.bottom+26:x.bottom;this.subElement.clientHeight<=window.innerHeight-T||this.subElement.clientHeight<=x.top?r.includes("inline-math")||m?setPosition(this.subElement,x.left,T,x.height||26):setPosition(this.subElement,x.left+(x.width-this.subElement.clientWidth)/2,T,x.height||26):setPosition(this.subElement,x.right,T)},p=this.subElement.querySelector(".block__icons");p.addEventListener("click",T=>{const w=T.target,v=hasClosestByClassName(w,"b3-tooltips");if(!v){if(T.detail===2){const h=p.querySelector('[data-type="pin"]');h.getAttribute("aria-label")===window.siyuan.languages.unpin?(h.querySelector("svg use").setAttribute("xlink:href","#iconPin"),h.setAttribute("aria-label",window.siyuan.languages.pin)):(h.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),h.setAttribute("aria-label",window.siyuan.languages.unpin)),T.preventDefault(),T.stopPropagation()}return}switch(T.stopPropagation(),v.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);break;case"pin":v.getAttribute("aria-label")===window.siyuan.languages.unpin?(v.querySelector("svg use").setAttribute("xlink:href","#iconPin"),v.setAttribute("aria-label",window.siyuan.languages.pin)):(v.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),v.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":v.classList.toggle("block__icon--active");break;case"before":insertEmptyBlock(t,"beforebegin",l),hideElements(["util"],t);break;case"after":insertEmptyBlock(t,"afterend",l),hideElements(["util"],t);break;case"export":y();break}});const y=()=>{const T=showMessage(window.siyuan.languages.exporting,0);if(a.getAttribute("data-subtype")==="plantuml"){fetch(a.querySelector("object").getAttribute("data")).then(function(w){return w.blob()}).then(function(w){const v=new FormData;v.append("file",w),v.append("type","image/svg+xml"),fetchPost("/api/export/exportAsFile",v,h=>{openByMobile(h.data.file),hideMessage(T)})});return}setTimeout(()=>{addScript("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>{a.style.display="inline-block",window.htmlToImage.toBlob(a).then(w=>{a.style.display="";const v=new FormData;v.append("file",w),v.append("type","image/png"),fetchPost("/api/export/exportAsFile",v,h=>{openByMobile(h.data.file),hideMessage(T)})})})},Constants.TIMEOUT_LOAD)},_=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?_.value=Lute.UnEscapeHTMLStr(a.querySelector("protyle-html").getAttribute("data-content")||""):m?_.value=Lute.UnEscapeHTMLStr(a.getAttribute("data-inline-memo-content")||""):_.value=Lute.UnEscapeHTMLStr(a.getAttribute("data-content")||"");const k=_.value;_.addEventListener("input",T=>{if(a.parentElement&&(_.clientHeight!==_.scrollHeight&&b(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))a.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(_.value));else if(m){let w;n?w=n:w=[a],w.forEach(v=>{v.nodeType!==3&&v.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(_.value))})}else a.setAttribute("data-content",Lute.EscapeHTMLStr(_.value)),a.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!m)&&processRender(a),T.stopPropagation()}}),_.addEventListener("keydown",T=>{if(T.stopPropagation(),matchHotKey(window.siyuan.config.keymap.editor.insert["inline-math"].custom,T)){T.preventDefault();return}if(!T.isComposing){if(T.key==="Escape"||matchHotKey("\u2318\u21A9",T))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);else if(T.key==="Tab")document.execCommand("insertText",!1,"	"),T.preventDefault();else if(electronUndo(T))return}}),this.subElementCloseCB=()=>{var T;if(!a.parentElement||t.disabled||k===_.value&&_.value)return;let w;if(r.includes("NodeHTMLBlock")){let v=_.value;v&&(v=v.trim().replace(/\n+/g,`
`),v.startsWith("<div>")&&v.endsWith("</div>")||(v=`<div>
${v}
</div>`)),a.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(v))}else if(m){let v;n?v=n:v=[a],v.forEach((h,E)=>{if(_.value)h.nodeType!==3&&h.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(_.value));else{const C=h.getAttribute("data-type").split(" ");C.length===1&&C[0]==="inline-memo"?h.outerHTML=h.innerHTML+(E===v.length-1?"<wbr>":""):(C.find((A,S)=>{if(A==="inline-memo")return C.splice(S,1),!0}),h.setAttribute("data-type",C.join(" ")),h.removeAttribute("data-inline-memo-content")),E===v.length-1&&(w=h)}})}else r.includes("inline-math")?_.value?(a.setAttribute("data-content",Lute.EscapeHTMLStr(_.value)),a.removeAttribute("data-render"),processRender(a)):(w=a,a.outerHTML="<wbr>"):(a.setAttribute("data-content",Lute.EscapeHTMLStr(_.value)),a.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?(blockRender(t,a),a.style.height=""):processRender(a));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&hasClosestByClassName(getSelection().getRangeAt(0).startContainer,"protyle-util")?a.tagName==="SPAN"?w?w.parentElement?(this.range.setStartAfter(w),this.range.collapse(!0),focusByRange(this.range)):focusByWbr(o,this.range):a.parentElement&&(this.range.setStartAfter(a),this.range.collapse(!0),focusByRange(this.range)):(focusBlock(a),a.classList.add("protyle-wysiwyg--select")):(T=o.querySelector("wbr"))==null||T.remove(),o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),r.includes("NodeHTMLBlock")){const v=document.createElement("template");v.innerHTML=t.lute.SpinBlockDOM(o.outerHTML),v.content.childElementCount>1&&showMessage(window.siyuan.languages.htmlBlockTip)}updateTransaction(t,l,o.outerHTML,c)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const x=a.getBoundingClientRect();this.element.classList.add("fn__none"),d?(_.style.width=f.styleW,_.style.height=f.styleH):b(),t.disabled||_.select(),t.app.plugins.forEach(T=>{T.eventBus.emit("open-noneditableblock",{protyle:t,toolbar:this,blockElement:o,renderElement:a})})}showCodeLanguage(t,a){var n,i;const s=hasClosestBlock(a[0]);if(!s)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.range=getEditorRange(s),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div data-id="codeLanguage" class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"></div>
</div>`;const o=this.subElement.lastElementChild.lastElementChild;let l=`<div data-id="clearLanguage" class="b3-list-item">${window.siyuan.languages.clear}</div>`,r=Constants.ALIAS_CODE_LANGUAGES.concat((i=(n=window.hljs)==null?void 0:n.listLanguages())!=null?i:[]).sort();const c={languages:r,type:"init",listElement:o};t.app&&t.app.plugins&&t.app.plugins.forEach(m=>{m.eventBus.emit("code-language-update",c)}),r=c.languages,r.forEach(m=>{l+=`<div data-id="${m}" class="b3-list-item">${m}</div>`}),o.innerHTML=l,o.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus");const u=this.subElement.querySelector("input");u.addEventListener("keydown",m=>{if(m.stopPropagation(),!m.isComposing){if(upDownHint(o,m),m.key==="Enter"){this.updateLanguage(a,t,this.subElement.querySelector(".b3-list-item--focus").textContent),m.preventDefault();return}m.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}});const g=(m,d)=>{const f=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),b=new RegExp(f,"gi");return m.replace(b,p=>`<b>${p}</b>`)};u.addEventListener("input",m=>{var d;const f=u.value.trim();let b,p=`<div data-id="clearLanguage" class="b3-list-item">${window.siyuan.languages.clear}</div>`,y=!1;if(f){const k=f.toLowerCase();b=r.filter(x=>x.toLowerCase().includes(k)).sort((x,T)=>{const w=x.toLowerCase().startsWith(k),v=T.toLowerCase().startsWith(k);return w&&v?x.length-T.length:w?-1:v?1:0}),(d=window.hljs)!=null&&d.getLanguage(f)&&(b=[f].concat(b.filter(x=>x!==f)))}const _={languages:f?b:r,type:"match",value:f,listElement:o};t.app&&t.app.plugins&&t.app.plugins.forEach(k=>{k.eventBus.emit("code-language-update",_)}),b=_.languages,f?b.forEach(k=>{f===k?(y=!0,p+=`<div data-id="${k}" class="b3-list-item"><b>${k}</b></div>`):p+=`<div data-id="${k}" class="b3-list-item">${g(k,f)}</div>`}):b.forEach(k=>{p+=`<div data-id="${k}" class="b3-list-item">${k}</div>`}),f&&!y&&(p+=`<div data-id="customLanguage" class="b3-list-item"><b>${escapeHtml(f.replace(/`| /g,"_"))}</b></div>`),o.innerHTML=p,o.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"),m.stopPropagation()}),o.addEventListener("click",m=>{const d=m.target,f=hasClosestByClassName(d,"b3-list-item");f&&this.updateLanguage(a,t,f.textContent)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,setPosition(this.subElement,0,0),this.element.classList.add("fn__none"),u.select()}showTpl(t,a,n){this.range=n,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${isMobile()?"width: 100%":"width: 256px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="toolbarResize" style="    cursor: col-resize;
    box-shadow: 2px 0 0 0 var(--b3-theme-surface) inset, 3px 0 0 0 var(--b3-border-color) inset;
    width: 5px;
    margin-left: -2px;"></div>
<div style="width: 520px;${isMobile()||window.outerWidth<window.outerWidth/2+520?"display:none;":""}overflow: auto;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list");resizeSide(this.subElement.querySelector(".toolbarResize"),i.parentElement);const s=this.subElement.firstElementChild.lastElementChild;let o;i.addEventListener("mouseover",r=>{const c=r.target,u=hasClosestByClassName(c,"b3-list-item");if(!u)return;const g=u.getAttribute("data-value");o!==g&&(o=g,previewTemplate(o,s,t.block.parentID),r.stopPropagation())});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const u=upDownHint(i,r);if(u){const g=u.getAttribute("data-value");if(o===g)return;o=g,previewTemplate(o,s,t.block.parentID)}}r.key==="Enter"?(c?focusByRange(this.range):hintRenderTemplate(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),t,a),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTemplate",{k:l.value},c=>{var u;let g="";c.data.blocks.forEach((d,f)=>{g+=`<div data-value="${d.path}" class="b3-list-item--hide-action b3-list-item${f===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${d.content}</span>`,g+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),i.innerHTML=g||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const m=(u=c.data.blocks[0])==null?void 0:u.path;o!==m&&(o=m,previewTemplate(o,s,t.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),focusByRange(this.range),r.stopPropagation();return}const u=hasClosestByClassName(c,"b3-list-item__action");if(u&&u.getAttribute("data-type")==="remove"){confirmDialog(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{fetchPost("/api/search/removeTemplate",{path:u.parentElement.getAttribute("data-value")},()=>{if(u.parentElement.parentElement.childElementCount===1)u.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,previewTemplate("",s,t.block.parentID);else{if(u.parentElement.classList.contains("b3-list-item--focus")){const f=u.parentElement.previousElementSibling||u.parentElement.nextElementSibling;f.classList.add("b3-list-item--focus");const b=f.getAttribute("data-value");if(o===b)return;o=b,previewTemplate(o,s,t.block.parentID)}u.parentElement.remove()}})}),r.stopPropagation();return}if(hasClosestByAttribute(c,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(hasClosestByAttribute(c,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const d=hasClosestByClassName(c,"b3-list-item");d&&(hintRenderTemplate(decodeURIComponent(d.getAttribute("data-value")),t,a),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),fetchPost("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((u,g)=>{c+=`<div data-value="${u.path}" class="b3-list-item--hide-action b3-list-item${g===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${u.content}</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=c||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,setPosition(this.subElement,0,0),o=i.firstElementChild.getAttribute("data-value"),previewTemplate(o,s,t.block.parentID)})}showWidget(t,a,n){this.range=n,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const i=this.subElement.lastElementChild.lastElementChild,s=this.subElement.querySelector("input");s.addEventListener("keydown",o=>{o.stopPropagation(),!o.isComposing&&(upDownHint(i,o),o.key==="Enter"?(hintRenderWidget(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-content"),t),this.subElement.classList.add("fn__none"),o.preventDefault()):o.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range)))}),s.addEventListener("input",o=>{o.stopPropagation(),fetchPost("/api/search/searchWidget",{k:s.value},l=>{let r="";l.data.blocks.forEach((c,u)=>{r+=`<div data-value="${c.path}" data-content="${c.content}" class="b3-list-item${u===0?" b3-list-item--focus":""}">
    ${c.name}
    <span class="b3-list-item__meta">${c.content}</span>
</div>`}),i.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",o=>{const l=o.target,r=hasClosestByClassName(l,"b3-list-item");r&&hintRenderWidget(r.dataset.content,t)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),fetchPost("/api/search/searchWidget",{k:""},o=>{let l="";o.data.blocks.forEach((r,c)=>{l+=`<div class="b3-list-item${c===0?" b3-list-item--focus":""}" data-content="${r.content}">
${r.name}
<span class="b3-list-item__meta">${r.content}</span>
</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=l,setPosition(this.subElement,0,0)})}showContent(t,a,n){var i,s;this.range=a,hideElements(["hint"],t),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let o="";const l=a.toString()!==""||((s=(i=a.cloneContents().childNodes[0])==null?void 0:i.classList)==null?void 0:s.contains("emoji"));l&&(o+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',t.disabled||(o+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),t.disabled||(o+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(l||!t.disabled)&&(o+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${o}</div>`,this.subElement.lastElementChild.addEventListener("click",c=>fo(this,null,function*(){const u=hasClosestByClassName(c.target,"keyboard__action");if(!u)return;const g=u.getAttribute("data-action");if(g==="copy")focusByRange(getEditorRange(n)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(g==="cut")focusByRange(getEditorRange(n)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(g==="delete"){const m=getEditorRange(n);m.insertNode(document.createElement("wbr"));const d=n.outerHTML;m.extractContents(),focusByWbr(n,m),focusByRange(m),updateTransaction(t,n.getAttribute("data-node-id"),n.outerHTML,d),this.subElement.classList.add("fn__none")}else if(g==="paste"){if(focusByRange(getEditorRange(n)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const m=yield readClipboard();paste(t,Object.assign(m,{target:n}))}catch(m){console.log(m)}this.subElement.classList.add("fn__none")}else g==="select"?(selectAll(t,n,a),this.subElement.classList.add("fn__none")):g==="copyPlainText"?(focusByRange(getEditorRange(n)),copyPlainText(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):g==="pasteAsPlainText"?(focusByRange(getEditorRange(n)),pasteAsPlainText(t),this.subElement.classList.add("fn__none")):g==="pasteEscaped"?(focusByRange(getEditorRange(n)),pasteEscaped(t,n),this.subElement.classList.add("fn__none")):g==="back"?this.subElement.lastElementChild.innerHTML=o:g==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${l?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${l?"":" fn__none"}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,setPosition(this.subElement,r.left,r.top+28,Constants.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=getSelectionPosition(n,a);setPosition(this.subElement,r.left,r.top-48,Constants.SIZE_TOOLBAR_HEIGHT)}genItem(t,a){let n;switch(a.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":n=new ToolbarItem(t,a);break;case"block-ref":n=new BlockRef(t,a);break;case"inline-math":n=new InlineMath(t,a);break;case"inline-memo":n=new InlineMemo(t,a);break;case"|":n=new Divider;break;case"text":n=new Font(t,a);break;case"a":n=new Link(t,a);break;default:n=new ToolbarItem(t,a);break}if(n)return n.element}mergeNode(t){for(let a=0;a<t.length;a++)t[a].nodeType!==3&&t[a].tagName==="WBR"&&(t[a].remove(),a--);for(let a=0;a<t.length;a++)t[a].nodeType===3&&(t[a].textContent===""?(t[a].remove(),a--):t[a+1]&&t[a+1].nodeType===3&&(t[a].textContent=t[a].textContent+t[a+1].textContent,t[a+1].remove(),a--))}updateLanguage(t,a,n){const i=n===window.siyuan.languages.clear?"":n;a.app&&a.app.plugins&&a.app.plugins.forEach(l=>{l.eventBus.emit("code-language-change",{language:i,languageElements:t,protyle:a})}),Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(i)||(window.siyuan.storage[Constants.LOCAL_CODELANG]=i,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG]));const s=[],o=[];t.forEach(l=>{const r=hasClosestBlock(l);if(r){const c=r.getAttribute("data-node-id");o.push({id:c,data:r.outerHTML,action:"update"}),l.textContent=n===window.siyuan.languages.clear?"":n;const u=getContenteditableElement(r);Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(i)?(r.dataset.content=u.textContent.trim(),r.dataset.subtype=i,r.className="render-node",r.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,processRender(r)):(u.textContent=u.textContent,u.parentElement.removeAttribute("data-render"),highlightRender(r)),r.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),s.push({id:c,data:r.outerHTML,action:"update"})}}),transaction(a,s,o),this.subElement.classList.add("fn__none"),focusByRange(this.range)}}const af=(e,t,a,n,i)=>{let s=1,o;fetchPost(`/api/riff/get${n}RiffCards`,{id:t,page:s},l=>{var r;const c=new Dialog({positionId:Constants.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${escapeHtml(a)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${n===""&&t===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${s}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${isMobile()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${isMobile()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${Tn(l.data.blocks,a,n)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))},resizeCallback(d){d!=="d"&&d!=="t"&&o&&o.resize()}});l.data.blocks.length>0&&(o=new Protyle(e,c.element.querySelector("#cardPreview"),{blockId:"",action:[Constants.CB_GET_ALL],render:{gutter:!0,breadcrumbDocName:!0,title:!0,hideTitleOnZoom:!0},typewriterMode:!1}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=o),c.editors={card:o},o.resize(),kt(o,(r=c.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const u=c.element.querySelector('[data-type="previous"]'),g=c.element.querySelector('[data-type="next"]'),m=c.element.querySelector(".b3-list--background");l.data.pageCount>1&&g.removeAttribute("disabled"),c.element.setAttribute("data-key",Constants.DIALOG_VIEWCARDS),c.element.addEventListener("click",d=>{var f;if(typeof d.detail=="string"){let p=m.querySelector(".b3-list-item--focus");if(p){p.classList.remove("b3-list-item--focus"),d.detail==="arrowup"?p=p.previousElementSibling||p.parentElement.lastElementChild:d.detail==="arrowdown"?p=p.nextElementSibling||p.parentElement.firstElementChild:d.detail==="home"?p=p.parentElement.firstElementChild:d.detail==="end"&&(p=p.parentElement.lastElementChild);const y=p.getBoundingClientRect(),_=p.parentElement.getBoundingClientRect();(y.top<_.top||y.bottom>_.bottom)&&p.scrollIntoView(y.top<_.top),kt(o,p.getAttribute("data-id")),p.classList.add("b3-list-item--focus")}d.stopPropagation(),d.preventDefault();return}let b=d.target;for(;b&&c.element!==b;){const p=b.getAttribute("data-type");if(p==="close"){c.destroy(),d.stopPropagation(),d.preventDefault();break}else if(p==="previous"){if(s<=1)return;s--,s<=1&&u.setAttribute("disabled","disabled"),fetchPost(`/api/riff/get${n}RiffCards`,{id:t,page:s},y=>{var _;s===y.data.pageCount?g.setAttribute("disabled","disabled"):y.data.pageCount>1&&g.removeAttribute("disabled"),g.nextElementSibling.nextElementSibling.textContent=`${s}/${y.data.pageCount||1}`,m.innerHTML=Tn(y.data.blocks,a,n),m.scrollTop=0,kt(o,(_=c.element.querySelector(".b3-list-item--focus"))==null?void 0:_.getAttribute("data-id"))}),d.stopPropagation(),d.preventDefault();break}else if(p==="next"){if(s>=l.data.pageCount)return;s++,u.removeAttribute("disabled"),fetchPost(`/api/riff/get${n}RiffCards`,{id:t,page:s},y=>{var _;s===y.data.pageCount?g.setAttribute("disabled","disabled"):y.data.pageCount>1&&g.removeAttribute("disabled"),g.nextElementSibling.nextElementSibling.textContent=`${s}/${y.data.pageCount||1}`,m.innerHTML=Tn(y.data.blocks,a,n),m.scrollTop=0,kt(o,(_=c.element.querySelector(".b3-list-item--focus"))==null?void 0:_.getAttribute("data-id"))}),d.stopPropagation(),d.preventDefault();break}else if(p==="reset"){fetchPost("/api/riff/resetRiffCards",{type:n===""?"deck":n.toLowerCase(),deckID:n===""?t:Constants.QUICK_DECK_ID,id:t,blockIDs:[b.getAttribute("data-id")]},()=>{b.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=dayjs().format("YYYY-MM-DD")}),d.stopPropagation(),d.preventDefault();break}else if(p==="resetAll"){confirmDialog(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",c.element.querySelector(".counter").textContent),()=>{fetchPost("/api/riff/resetRiffCards",{type:n===""?"deck":n.toLowerCase(),deckID:n===""?t:Constants.QUICK_DECK_ID,id:t},()=>{c.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(y=>{y.textContent=dayjs().format("YYYY-MM-DD")})})}),d.stopPropagation(),d.preventDefault();break}else if(p==="card-item"){kt(o,b.getAttribute("data-id")),(f=m.querySelector(".b3-list-item--focus"))==null||f.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus"),d.stopPropagation(),d.preventDefault();break}else if(p==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:n===""?t:Constants.QUICK_DECK_ID,blockIDs:[b.getAttribute("data-id")]},y=>{var _;let k=b.parentElement.nextElementSibling;k||(k=b.parentElement.previousElementSibling),!k&&b.parentElement.parentElement.childElementCount>1&&(k=b.parentElement.parentElement.firstElementChild),k?(kt(o,k.getAttribute("data-id")),(_=m.querySelector(".b3-list-item--focus"))==null||_.classList.remove("b3-list-item--focus"),k.classList.add("b3-list-item--focus"),b.parentElement.remove()):(kt(o,""),m.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),c.element.querySelector(".counter").textContent=(parseInt(c.element.querySelector(".counter").textContent)-1).toString(),i&&i(y)}),d.stopPropagation(),d.preventDefault();break}b=b.parentElement}})})},Tn=(e,t,a)=>{let n="",i=!0;const s=t.split("/");return s.splice(0,1),e.forEach(o=>{var l,r,c,u;if(o.type){let g;a===""?g=getNotebookName(o.box)+getDisplayName(Lute.UnEscapeHTMLStr(o.hPath),!1):(g=getDisplayName(Lute.UnEscapeHTMLStr(o.hPath),!1).replace("/"+s.join("/"),""),g.startsWith("/")&&(g=g.substring(1))),n+=`<div data-type="card-item" class="b3-list-item${i?" b3-list-item--focus":""}${isMobile()?"":" b3-list-item--hide-action"}" data-id="${o.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${o.content||Constants.ZWSP}</span>
<span class="${isMobile()||!g?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${escapeAttr(g)}">${escapeHtml(g)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${((l=o.riffCard)==null?void 0:l.reps)===0?" fn__none":""}">${(r=o.riffCard)==null?void 0:r.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${(c=o.riffCard)!=null&&c.due?"":" fn__none"}">${dayjs((u=o.riffCard)==null?void 0:u.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,i=!1}else n+=`<div data-type="card-item" class="b3-list-item${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${o.content}</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),e.length===0&&(n=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),n},kt=(e,t)=>{if(!t){e.protyle.element.classList.add("fn__none"),e.protyle.element.nextElementSibling.classList.remove("fn__none");return}e.protyle.element.classList.remove("fn__none"),e.protyle.element.nextElementSibling.classList.add("fn__none"),e.protyle.scroll.lastScrollTop=0,addLoading(e.protyle),fetchPost("/api/block/getDocInfo",{id:t},a=>{e.protyle.wysiwyg.renderCustom(a.data.ial),fetchPost("/api/filetree/getDoc",{id:t,mode:0,size:Constants.SIZE_GET_MAX},n=>{onGet({updateReadonly:!0,data:n,protyle:e.protyle,action:n.data.rootID===n.data.id?[]:[Constants.CB_GET_ALL]})})})},Qt=e=>`<li data-id="${e.id}" data-name="${escapeAttr(e.name)}" class="b3-list-item b3-list-item--narrow${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${escapeHtml(e.name)}</span>
    <span class="b3-list-item__meta">${e.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-list-item__action--warning b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${isMobile()?" fn__none":""}">${e.updated}</span>
</li>`,nf=(e,t)=>{window.siyuan.dialogs.find(a=>{if(a.element.getAttribute("data-key")===Constants.DIALOG_MAKECARD)return hideElements(["dialog"]),!0}),fetchPost("/api/riff/getRiffDecks",{},a=>{let n="";a.data.forEach(s=>{n+=Qt(s)});const i=new Dialog({positionId:Constants.DIALOG_MAKECARD,width:isMobile()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${n}</ul>
</div>`});i.element.setAttribute("data-key",Constants.DIALOG_MAKECARD),i.element.addEventListener("click",s=>{let o=s.target;for(;o&&o!==i.element;){const l=o.getAttribute("data-type");if(l==="create"){let r="";const c=i.element.querySelector(".b3-text-field");c.value?(r&&hideMessage(r),fetchPost("/api/riff/createRiffDeck",{name:c.value},u=>{i.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",Qt(u.data)),c.value=""})):(r=showMessage(window.siyuan.languages._kernel[142]),c.focus()),s.stopPropagation(),s.preventDefault();break}else if(l==="add"){fetchPost("/api/riff/addRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:t},r=>{o.parentElement.outerHTML=Qt(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:t},r=>{o.parentElement.outerHTML=Qt(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="delete"){confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${escapeHtml(o.parentElement.getAttribute("data-name"))}</b>?`,()=>{fetchPost("/api/riff/removeRiffDeck",{deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.remove()})},void 0,!0),s.stopPropagation(),s.preventDefault();break}else if(l==="view"){viewCards(e,o.parentElement.getAttribute("data-id"),o.parentElement.getAttribute("data-name"),"",r=>{o.parentElement.outerHTML=Qt(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="viewall"){viewCards(e,"",window.siyuan.languages.all,""),s.stopPropagation(),s.preventDefault();break}else if(l==="rename"){const r=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),c=r.element.querySelector("input"),u=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{u[1].click()}),c.value=o.parentElement.getAttribute("data-name"),c.focus(),c.select(),u[0].addEventListener("click",()=>{r.destroy()}),u[1].addEventListener("click",()=>{fetchPost("/api/riff/renameRiffDeck",{name:c.value,deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,o.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}})})},sf=(e,t)=>{let a=!0;const n=[];t.forEach(i=>{i.getAttribute("data-type")!=="NodeThematicBreak"&&(i.classList.remove("protyle-wysiwyg--select"),n.push(i.getAttribute("data-node-id")),(i.getAttribute(Constants.CUSTOM_RIFF_DECKS)||"").indexOf(Constants.QUICK_DECK_ID)===-1&&(a=!1))}),a?transaction(e,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}]):transaction(e,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:n}])},lf=e=>{window.siyuan.menus.menu.append(new MenuItem({id:"transferBlockRef",label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const t=new Dialog({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_TRANSFERBLOCKREF);const a=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{n[1].click()}),a.focus(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{fetchPost("/api/block/transferBlockRef",{fromID:e,toID:a.value}),t.destroy()})}}).element)},In=(e,t,a,n=!0,i)=>{fetchPost("/api/av/searchAttributeView",{keyword:t,excludes:n&&a?[a]:void 0},s=>{let o="";s.data.results.forEach((l,r)=>{const c=l.children&&l.children.length>0&&n;o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-av-id="${l.avID}" data-block-id="${l.blockID}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl${n?"":" fn__none"}" style="height:auto;align-self: stretch;margin: 4px 0;">
        <svg class="b3-list-item__arrow">${c?'<use xlink:href="#iconRight"></use>':""}</svg>
    </span>
    <span class="fn__space--small"></span>
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${escapeHtml(l.avName||window.siyuan.languages._kernel[267])}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${escapeGreat(l.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${l.avID===a?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`,c&&(o+='<div class="fn__none">',l.children.forEach(u=>{const g=getViewName(u.viewLayout);o+=`<div style="padding-left: 48px;" class="b3-list-item b3-list-item--narrow" data-av-id="${u.avID}" data-view-id="${u.viewID}">
<span class="b3-list-item__text">${escapeHtml(u.avName||window.siyuan.languages._kernel[267])}</span> 
<span class="b3-list-item__meta">${escapeHtml(u.viewName)}${g===u.viewName?"":" - "+g}</span>
</div>`}),o+="</div>")}),e.innerHTML=o,i&&i()})},Os=(e,t,a)=>{t.dataset.avId=a.dataset.avId,t.dataset.blockId=a.dataset.blockId,t.querySelector(".b3-menu__accelerator").textContent=a.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?a.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const n=hasClosestByClassName(t,"b3-menu__items");n&&go(n,e,!0)},of=(e,t,a,n=!0)=>{window.siyuan.menus.menu.remove();const i=new Menu;i.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter"${isMobile()?"":' style="width: 50vw"'} >
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(o){const l=o.querySelector(".b3-list"),r=o.querySelector("input");r.addEventListener("keydown",c=>{if(!c.isComposing&&(UDLRHint(l,c),c.key==="Enter")){c.preventDefault(),c.stopPropagation();const u=l.querySelector(".b3-list-item--focus");a?a(u):Os(e,t,u),window.siyuan.menus.menu.remove()}}),r.addEventListener("input",c=>{c.stopPropagation(),!c.isComposing&&In(l,r.value,e,n)}),r.addEventListener("compositionend",()=>{In(l,r.value,e,n)}),o.lastElementChild.addEventListener("click",c=>{let u=c.target;for(;u&&!u.classList.contains("b3-list");){if(u.classList.contains("b3-list-item__toggle")){u.firstElementChild.classList.contains("b3-list-item__arrow--open")?(u.firstElementChild.classList.remove("b3-list-item__arrow--open"),u.parentElement.nextElementSibling.classList.add("fn__none")):(u.firstElementChild.classList.add("b3-list-item__arrow--open"),u.parentElement.nextElementSibling.classList.remove("fn__none")),c.preventDefault(),c.stopPropagation();break}else if(u.classList.contains("b3-list-item")){c.preventDefault(),c.stopPropagation(),a?a(u):Os(e,t,u),window.siyuan.menus.menu.remove();break}u=u.parentElement}}),In(l,"",e,n,()=>{const c=t.getBoundingClientRect();i.open({x:c.left,y:c.bottom,h:c.height}),o.querySelector("input").focus()})}}),i.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const s=hasTopClosestByClassName(t,"block__popover",!0);i.element.setAttribute("data-from",s?s.dataset.level+"popover":"app")},rf=e=>{const t=e.avElement.querySelector('input[data-type="colName"]'),n=e.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),i=e.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let s;e.colsData.find(l=>{if(l.id===i)return l.relation||(l.relation={}),s=l,!0});const o=e.avElement.querySelector('[data-type="name"]').value;transaction(e.protyle,[{action:"updateAttrViewColRelation",avID:e.avID,keyID:i,id:n||s.relation.avID,backRelationKeyID:s.relation.avID===n&&s.relation.backKeyID||Lute.NewNodeID(),isTwoWay:e.avElement.querySelector(".b3-switch").checked,name:t.value,format:o},{action:"doUpdateUpdated",id:e.blockElement.getAttribute("data-node-id"),data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColRelation",avID:e.avID,keyID:i,id:s.relation.avID||n,backRelationKeyID:s.relation.backKeyID,isTwoWay:s.relation.isTwoWay,name:t.dataset.oldValue,format:s.name}]),e.avElement.remove(),updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:o}),focusBlock(e.blockElement)},go=(e,t,a=!1)=>{const n=e.querySelector('.b3-menu__item[data-type="goSearchAV"]'),i=n.nextElementSibling,s=i.querySelector(".b3-switch"),o=i.nextElementSibling,l=o.nextElementSibling,r=JSON.parse(n.dataset.oldValue);if(r.avID){const c=o.querySelector("input");a&&(n.dataset.avId!==r.avID?(c.value="",s.checked=!1):(c.value=c.dataset.oldValue,s.checked=r.isTwoWay)),s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),n.dataset.avId&&r.avID!==n.dataset.avId||r.isTwoWay!==s.checked||c.dataset.oldValue!==c.value?l.classList.remove("fn__none"):l.classList.add("fn__none")}else n.dataset.avId&&(s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),l.classList.remove("fn__none"))},Dn=e=>{const t=e.querySelector(".b3-form__icona .b3-text-field");e.querySelector(".b3-menu__icon.fn__grab")?(t.nextElementSibling.classList.remove("fn__none"),t.style.paddingRight="26px"):(t.nextElementSibling.classList.add("fn__none"),t.style.paddingRight="")},je=e=>{if(e.type==="selected")return`<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
<span class="b3-menu__label fn__ellipsis ${e.isDetached?"":" popover__block"}" ${e.isDetached?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${e.id}">${e.text}</span>
<svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>`;if(e.type==="empty")return e.newName?`<button class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis">${window.siyuan.languages.newRowInRelation.replace("${x}",e.text).replace("${y}",e.newName)}</span>
</button>`:`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(e.type=="unselect")return`<button data-row-id="${e.rowId}" class="${e.className||"b3-menu__item ariaLabel"}" data-position="west" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis${e.isDetached?"":" popover__block"}" ${e.isDetached?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${e.id}">${e.text}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},qs=(e,t,a)=>{fetchPost("/api/av/getAttributeViewPrimaryKeyValues",{id:e.firstElementChild.getAttribute("data-av-id"),keyword:a},n=>{const i=n.data.rows.values||[];let s="",o="";const l=[];t.querySelectorAll(".av__cell--relation").forEach(c=>{const u=c.querySelector(".av__celltext");l.push(c.dataset.rowId),o+=`<button data-row-id="${c.dataset.rowId}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel${u.textContent.indexOf(a)>-1?"":" fn__none"}" 
draggable="true">${je({type:"selected",id:u.dataset.id,isDetached:!u.classList.contains("av__celltext--ref"),text:Lute.EscapeHTMLStr(u.textContent||window.siyuan.languages.untitled)})}</button>`}),i.forEach(c=>{l.includes(c.blockID)||(s+=je({type:"unselect",rowId:c.blockID,id:c.block.id,isDetached:c.isDetached,text:Lute.EscapeHTMLStr(c.block.content||window.siyuan.languages.untitled)}))});const r=e.querySelector(".popover__block");e.querySelector(".b3-menu__items").innerHTML=`${o}
<button class="b3-menu__separator"></button>
${s}
${a?je({type:"empty",newName:Lute.EscapeHTMLStr(a),text:`<span style="color: var(--b3-protyle-inline-blockref-color);" class="popover__block" data-id="${r.getAttribute("data-id")}">${r.textContent}</span>`}):s?"":je({type:"empty"})}`,e.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current"),Dn(e)})},cf=e=>{fetchPost("/api/av/getAttributeViewPrimaryKeyValues",{id:e.menuElement.firstElementChild.getAttribute("data-av-id"),keyword:""},t=>{const a=t.data.rows.values||[];let n="",i="";const s=[];e.cellElements[0].querySelectorAll(".av__cell--relation").forEach(u=>{const g=u.querySelector(".av__celltext");s.push(u.dataset.rowId),i+=`<button data-row-id="${u.dataset.rowId}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${je({type:"selected",id:g.dataset.id,isDetached:!g.classList.contains("av__celltext--ref"),text:Lute.EscapeHTMLStr(g.textContent||window.siyuan.languages.untitled)})}</button>`}),a.forEach(u=>{s.includes(u.blockID)||(n+=je({type:"unselect",rowId:u.blockID,id:u.block.id,isDetached:u.isDetached,text:Lute.EscapeHTMLStr(u.block.content||window.siyuan.languages.untitled)}))}),e.menuElement.querySelector(".b3-menu__items").innerHTML=`${i}
<button class="b3-menu__separator"></button>
${n||je({type:"empty"})}`;const o=e.cellElements[e.cellElements.length-1].getBoundingClientRect();setPosition(e.menuElement,o.left,o.bottom,o.height),e.menuElement.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current");const l=e.menuElement.querySelector("input");l.focus();const r=l.parentElement.parentElement.querySelector(".popover__block");r.innerHTML=Lute.EscapeHTMLStr(t.data.name),r.setAttribute("data-id",t.data.blockIDs[0]);const c=e.menuElement.querySelector(".b3-menu__items");l.addEventListener("keydown",u=>{if(u.isComposing)return;upDownHint(c,u,"b3-menu__item--current");const g=e.menuElement.querySelector(".b3-menu__item--current");u.key==="Enter"&&g&&g.getAttribute("data-type")==="setRelationCell"&&(mo(e.protyle,e.blockElement,g,e.cellElements),u.preventDefault(),u.stopPropagation())}),l.addEventListener("input",u=>{u.isComposing||(qs(e.menuElement,e.cellElements[0],l.value),u.stopPropagation())}),l.addEventListener("compositionend",u=>{u.stopPropagation(),qs(e.menuElement,e.cellElements[0],l.value)}),Dn(e.menuElement),e.menuElement.querySelector('[data-type="copyRelatedItems"]').addEventListener("click",()=>{let u="";const g=e.menuElement.querySelectorAll('.b3-menu__item[draggable="true"]');g.forEach(m=>{g.length>1&&(u+="- ");const d=m.querySelector(".b3-menu__label");!d.dataset.id||d.dataset.id==="undefined"?u+=d.textContent+`
`:u+=`((${d.dataset.id} "${d.textContent}"))
`}),u&&(writeText(u.trimEnd()),showMessage(window.siyuan.languages.copied))})})},df=(e,t)=>{let a;return getFieldsByData(e).find(n=>{if(n.id===getColId(t[0],e.viewType))return a=n.relation,!0}),a&&a.avID?`<div data-av-id="${a.avID}" class="fn__flex-column">
<div class="b3-menu__item" data-type="nobg">
    <div class="b3-form__icona fn__flex-1" style="overflow: visible">
        <input class="b3-text-field fn__block" style="min-width: 190px"/>
        <svg class="b3-form__icona-icon ariaLabel fn__none" data-position="north" data-type="copyRelatedItems" aria-label="${window.siyuan.languages.copy} ${window.siyuan.languages.relatedItems}"><use xlink:href="#iconCopy"></use></svg>
    </div>
    <span class="fn__space"></span>
    <span style="color: var(--b3-protyle-inline-blockref-color);max-width: 200px" data-id="" class="popover__block fn__pointer fn__ellipsis"></span>
</div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`:""},mo=(e,t,a,n)=>{const i=hasClosestByClassName(a,"b3-menu");if(!i||i.querySelector(".dragover__bottom, .dragover__top"))return;if(!t.contains(n[0])){const o=t.getAttribute("data-av-type"),l=getFieldIdByCellElement(n[0],o);o==="table"?n[0]=t.querySelector(`.av__row[data-id="${l}"] .av__cell[data-col-id="${n[0].dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${n[0].dataset.colId}"]`):n[0]=t.querySelector(`.av__gallery-item[data-id="${l}"] .av__cell[data-field-id="${n[0].dataset.fieldId}"]`)}const s={blockIDs:[],contents:[]};if(i.querySelectorAll('[draggable="true"]').forEach(o=>{const l=o.getAttribute("data-row-id"),r=o.querySelector(".b3-menu__label");s.blockIDs.push(l),s.contents.push({type:"block",block:{id:r.getAttribute("data-id"),content:r.textContent},isDetached:!r.classList.contains("popover__block")})}),a.classList.contains("b3-menu__item")){const o=a.getAttribute("data-row-id"),l=a.querySelector(".b3-menu__label").getAttribute("data-id"),r=i.querySelector(".b3-menu__separator"),c=i.querySelector("input").value;if(a.getAttribute("draggable")){!r.nextElementSibling.getAttribute("data-row-id")&&!c&&r.nextElementSibling.remove();const u=s.blockIDs.indexOf(o);s.blockIDs.splice(u,1),s.contents.splice(u,1),r.after(a),a.outerHTML=je({type:"unselect",rowId:o,id:l,isDetached:!a.querySelector(".popover__block"),text:Lute.EscapeHTMLStr(a.querySelector(".b3-menu__label").textContent),className:a.className})}else if(o)s.blockIDs.push(o),s.contents.push({type:"block",block:{id:l,content:a.firstElementChild.textContent},isDetached:!a.firstElementChild.getAttribute("style")}),r.before(a),a.outerHTML=`<button data-row-id="${o}" data-position="west" data-type="setRelationCell" class="${a.className}" 
draggable="true">${je({type:"selected",rowId:o,id:l,isDetached:!a.querySelector(".popover__block"),text:Lute.EscapeHTMLStr(a.querySelector(".b3-menu__label").textContent)})}</button>`,r.nextElementSibling||r.insertAdjacentHTML("afterend",je({type:"empty"}));else{const u=a.querySelector(".popover__block").getAttribute("data-id"),g=a.querySelector("b").textContent,m=Lute.NewNodeID(),d=hasClosestByClassName(n[0],"av__body");transaction(e,[{action:"insertAttrViewBlock",avID:i.firstElementChild.getAttribute("data-av-id"),srcs:[{itemID:m,id:Lute.NewNodeID(),isDetached:!0,content:g}],blockID:u,groupID:d?d.getAttribute("data-group-id"):""},{action:"doUpdateUpdated",id:u,data:dayjs().format("YYYYMMDDHHmmss")}]),s.blockIDs.push(m),s.contents.push({type:"block",block:{content:g},isDetached:!0}),r.insertAdjacentHTML("beforebegin",`<button data-row-id="${m}" data-position="west" data-type="setRelationCell" 
class="${a.className} ariaLabel" draggable="true">${je({type:"selected",rowId:m,isDetached:!0,text:Lute.EscapeHTMLStr(g)})}</button>`)}}updateCellsValue(e,t,s,n),Dn(i)},uf=e=>{const t=[];e.forEach(a=>{const n=a.getAttribute("data-node-id");n&&t.push({itemID:Lute.NewNodeID(),id:n,isDetached:!1})}),t.length>0&&openSearchAV("",e[0],a=>{const n=a.dataset.avId,i=a.dataset.viewId;transaction(void 0,[{action:"insertAttrViewBlock",ignoreDefaultFill:!i,viewID:i,avID:n,srcs:t,blockID:a.dataset.blockId},{action:"doUpdateUpdated",id:a.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}])})},ff=(e,t,a)=>{var n,i;if(t&&((i=(n=e.title)==null?void 0:n.editElement)!=null&&i.contains(t.startContainer))||a==="title")openSearchAV("",e.breadcrumb.element,s=>{const o=s.dataset.avId,l=s.dataset.viewId;transaction(e,[{action:"insertAttrViewBlock",ignoreDefaultFill:!l,viewID:l,avID:o,srcs:[{itemID:Lute.NewNodeID(),id:e.block.rootID,isDetached:!1}],blockID:s.dataset.blockId},{action:"doUpdateUpdated",id:s.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:[e.block.rootID],avID:o}]),focusByRange(t)});else{let s;const o=[];if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(l=>{s||(s=l),o.push(l.getAttribute("data-node-id"))}),!s){const l=hasClosestBlock(t.startContainer);l&&(s=l,o.push(l.getAttribute("data-node-id")))}s||(s=e.wysiwyg.element,o.push(e.block.rootID)),openSearchAV("",s,l=>{const r=[],c=[];o.forEach(m=>{r.push(m),c.push({itemID:Lute.NewNodeID(),id:m,isDetached:!1})});const u=l.dataset.avId,g=l.dataset.viewId;transaction(e,[{action:"insertAttrViewBlock",ignoreDefaultFill:!g,viewID:g,avID:u,srcs:c,blockID:l.dataset.blockId},{action:"doUpdateUpdated",id:l.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:r,avID:u}]),focusByRange(t)})}};var po=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class gf{constructor(t){isMac()?this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)):this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)).replace("\u2318\u2191",updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)).replace("\u2325\u2318A",updateHotkeyTip(window.siyuan.config.keymap.editor.general.attr.custom)).replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+"),t.options.backlinkData&&(this.gutterTip=this.gutterTip.replace(window.siyuan.languages.enter,window.siyuan.languages.openBy)),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",a=>{var n;hideTooltip(),window.siyuan.menus.menu.remove();const i=a.target.parentElement;let s=[],o=[],l;if(i.dataset.rowId){if(l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${i.dataset.nodeId}"]`)).find(u=>{if(!isInEmbedBlock(u)&&!isInAVBlock(u))return!0}),(n=l.querySelector('.block__icon[data-type="av-sort"]'))!=null&&n.classList.contains("block__icon--active")){const u=l.querySelectorAll(".av__body");if(u.length===1){a.preventDefault(),a.stopPropagation();return}else if(["template","created","updated"].includes(u[0].getAttribute("data-dtype"))){a.preventDefault(),a.stopPropagation();return}}const c=l.querySelector(`.av__body${i.dataset.groupId?`[data-group-id="${i.dataset.groupId}"]`:""} .av__row[data-id="${i.dataset.rowId}"]`);c.classList.contains("av__row--select")||l.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(u=>{u.classList.remove("av__row--select"),u.querySelector("use").setAttribute("xlink:href","#iconUncheck")}),c.classList.add("av__row--select"),c.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),updateHeader(c),l.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(u=>{var g;const m=((g=hasClosestByClassName(u,"av__body"))==null?void 0:g.dataset.groupId)||"";s.push(u.getAttribute("data-id")+(m?"@"+m:"")),o.push(u)})}else{const c=i.getAttribute("data-node-id");o=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let u=!1;if(o.forEach(g=>{const m=g.getAttribute("data-node-id");m===c&&(u=!0),s.push(m)}),!u){let g;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${c}"]`)).find(m=>{if(!isInEmbedBlock(m)&&this.isMatchNode(m))return g=m,!0}),g&&(o.forEach(m=>{m.classList.remove("protyle-wysiwyg--select")}),g.classList.add("protyle-wysiwyg--select"),o=[g],s=[c])}}const r=document.createElement("div");r.className=t.wysiwyg.element.className,o.forEach(c=>{if(c.querySelector("iframe")){const u=c.getAttribute("data-type"),g=genEmptyElement();g.classList.add("protyle-wysiwyg--select"),getContenteditableElement(g).innerHTML=`<svg class="svg"><use xlink:href="${i.querySelector("use").getAttribute("xlink:href")}"></use></svg> ${getLangByType(u)}`,r.append(g)}else r.append(processClonePHElement(c.cloneNode(!0)))}),r.setAttribute("style",`position:fixed;opacity:.1;width:${o[0].clientWidth}px;padding:0;`),document.body.append(r),a.dataTransfer.setDragImage(r,0,0),setTimeout(()=>{r.remove()}),i.style.opacity="0.38",window.siyuan.dragElement=l||t.wysiwyg.element,a.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}${i.getAttribute("data-type")}${Constants.ZWSP}${i.getAttribute("data-subtype")}${Constants.ZWSP}${s}${Constants.ZWSP}${window.siyuan.config.system.workspaceDir}`,t.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(a=>{a.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",a=>{var n;const i=hasClosestByTag(a.target,"BUTTON");if(!i)return;a.preventDefault(),a.stopPropagation(),hideTooltip(),clearSelect(["av","img"],t.wysiwyg.element);const s=i.getAttribute("data-node-id");if(!s){if(i.getAttribute("disabled"))return;i.setAttribute("disabled","disabled");let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${(i.previousElementSibling||i.nextElementSibling).getAttribute("data-node-id")}"]`)).find(r=>{if(!isInEmbedBlock(r)&&this.isMatchNode(r))return l=r,!0}),!l)return;if(a.altKey){let r=!0;Array.from(l.children).find(g=>{if(g.classList.contains("list")&&Array.from(g.children).find(d=>{if(d.classList.contains("li")&&d.getAttribute("fold")!=="1"&&d.childElementCount>3)return r=!1,!0}))return!0});const c=[],u=[];Array.from(l.children).forEach(g=>{g.classList.contains("list")&&Array.from(g.children).forEach(m=>{if(m.classList.contains("li")){r?m.removeAttribute("fold"):m.childElementCount>3&&m.setAttribute("fold","1");const d=m.getAttribute("data-node-id");c.push({action:"setAttrs",id:d,data:JSON.stringify({fold:r?"":"1"})}),u.push({action:"setAttrs",id:d,data:JSON.stringify({fold:r?"1":""})})}})}),transaction(t,c,u),i.removeAttribute("disabled")}else{const r=setFold(t,l).fold;r===1?i.firstElementChild.style.transform="":r===0&&(i.firstElementChild.style.transform="rotate(90deg)")}hideElements(["select"],t),window.siyuan.menus.menu.remove();return}const o=i.getBoundingClientRect();if(i.dataset.type==="NodeAttributeViewRowMenu"||i.dataset.type==="NodeAttributeViewRow"){const l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${i.dataset.nodeId}"] .av__row[data-id="${i.dataset.rowId}"]`)).find(c=>{if(!isInEmbedBlock(c))return!0});if(!l)return;const r=hasClosestBlock(l);if(!r)return;if(i.dataset.type==="NodeAttributeViewRow"){const c=r.getAttribute("data-av-id"),u=[Lute.NewNodeID()],g=a.altKey?l.previousElementSibling.getAttribute("data-id")||"":i.dataset.rowId,m=dayjs().format("YYYYMMDDHHmmss"),d=l.parentElement.getAttribute("data-group-id");transaction(t,[{action:"insertAttrViewBlock",avID:c,previousID:g,srcs:[{itemID:Lute.NewNodeID(),id:u[0],isDetached:!0,content:""}],blockID:s,groupID:d},{action:"doUpdateUpdated",id:s,data:m}],[{action:"removeAttrViewBlock",srcIDs:u,avID:c},{action:"doUpdateUpdated",id:s,data:r.getAttribute("updated")}]),insertAttrViewBlockAnimation({protyle:t,blockElement:r,srcIDs:u,previousId:g,groupID:d}),a.altKey&&this.element.querySelectorAll("button").forEach(f=>{f.dataset.rowId=u[0]}),r.setAttribute("updated",m)}else{if(!t.disabled&&a.shiftKey){const c=(n=l.querySelector('[data-dtype="block"] .av__celltext--ref'))==null?void 0:n.getAttribute("data-id");if(c){fetchPost("/api/attr/getBlockAttrs",{id:c},u=>{openFileAttr(u.data,"av",t)});return}}avContextmenu(t,l,{x:o.left,y:o.bottom,w:o.width,h:o.height,isLeft:!0})}return}if(isOnlyMeta(a))t.options.backlinkData?checkFold(s,(l,r)=>{openFileById({app:t.app,id:s,action:r,zoomIn:l})}):zoomOut({protyle:t,id:s});else if(a.altKey){let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(r=>{if(!isInEmbedBlock(r)&&this.isMatchNode(r))return l=r,!0}),!l)return;if(i.getAttribute("data-type")==="NodeListItem"&&l.parentElement.getAttribute("data-node-id")){let r=!0;Array.from(l.parentElement.children).find(g=>{if(g.classList.contains("li")&&g.getAttribute("fold")!=="1"&&g.childElementCount>3)return r=!1,!0}),i.parentElement.querySelector("[data-type='fold'] > svg").style.transform=r?"rotate(90deg)":"";const c=[],u=[];Array.from(l.parentElement.children).find(g=>{if(g.classList.contains("li")){r?g.removeAttribute("fold"):g.childElementCount>3&&g.setAttribute("fold","1");const m=g.getAttribute("data-node-id");c.push({action:"setAttrs",id:m,data:JSON.stringify({fold:r?"":"1"})}),u.push({action:"setAttrs",id:m,data:JSON.stringify({fold:r?"1":""})})}}),transaction(t,c,u)}else{const r=setFold(t,l).fold,c=i.parentElement.querySelector("[data-type='fold'] > svg");r!==-1&&c&&(c.style.transform=r===0?"rotate(90deg)":"")}l.classList.remove("protyle-wysiwyg--hl")}else a.shiftKey&&!t.disabled?openAttr(t.wysiwyg.element.querySelector(`[data-node-id="${s}"]`),"bookmark",t):!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(t,i),t.toolbar.range||(t.toolbar.range=getEditorRange(t.wysiwyg.element.querySelector(`[data-node-id="${s}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}),this.element.addEventListener("contextmenu",a=>{const n=hasClosestByTag(a.target,"BUTTON");if(!(!n||n.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){hideTooltip(),clearSelect(["av","img"],t.wysiwyg.element);const i=n.getBoundingClientRect();if(n.dataset.type==="NodeAttributeViewRowMenu"){const s=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${n.dataset.nodeId}"] .av__row[data-id="${n.dataset.rowId}"]`)).find(o=>{if(!isInEmbedBlock(o))return!0});s&&avContextmenu(t,s,{x:i.left,y:i.bottom,w:i.width,h:i.height,isLeft:!0})}else n.dataset.type!=="NodeAttributeViewRow"&&(this.renderMenu(t,n),t.toolbar.range||(t.toolbar.range=getEditorRange(t.wysiwyg.element.querySelector(`[data-node-id="${n.getAttribute("data-node-id")}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}a.preventDefault(),a.stopPropagation()}}),this.element.addEventListener("mouseleave",a=>{Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(n=>{n.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),a.preventDefault(),a.stopPropagation()}),this.element.addEventListener("mousewheel",a=>{hideElements(["gutter"],t),a.stopPropagation()},{passive:!0})}isMatchNode(t){const a=t.getBoundingClientRect();let n=this.element.getBoundingClientRect().top+6;return a.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(n=n-(a.height-this.element.clientHeight)/2),a.top<=n&&a.bottom>=n}turnsOneInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsOneInto(t)}}}turnsIntoOne(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoOneTransaction(t)}}}turnsInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoTransaction(t)}}}showMobileAppearance(t){const a=document.getElementById("keyboardToolbar"),n=a.querySelectorAll("#keyboardToolbar .keyboard__dynamic");n[0].classList.add("fn__none"),n[1].classList.remove("fn__none"),a.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),a.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),a.classList.remove("fn__none");const i=t.contentElement.scrollTop+333.5;renderTextMenu(t,a),showKeyboardToolbarUtil(i)}renderMultipleMenu(t,a){var n;let i=!1,s=!1;if(a.find((r,c)=>{if(r.classList.contains("li"))return i=!0,!0;if(r.nextElementSibling&&a[c+1]&&r.nextElementSibling===a[c+1])s=!0;else if(c!==a.length-1)return s=!1,!0}),!i&&!t.disabled){const r=[];s&&(r.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,protyle:t,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,selectsElement:a,type:"Blocks2ULs"})),r.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:a,type:"Blocks2OLs"})),r.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:a,type:"Blocks2TLs"})),r.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:a,type:"Blocks2Blockquote"}))),r.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:a,type:"Blocks2Ps",isContinue:s})),r.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:a,level:1,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:a,level:2,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:a,level:3,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:a,level:4,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:a,level:5,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:a,level:6,type:"Blocks2Hs",isContinue:s})),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:r}).element),s&&!(a[0].parentElement.classList.contains("sb")&&a.length+1===a[0].parentElement.childElementCount)&&window.siyuan.menus.menu.append(new MenuItem({id:"mergeSuperBlock",icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({menuId:"hLayout",label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:t,selectsElement:a,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({menuId:"vLayout",label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:t,selectsElement:a,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){AIActions(a,t)}}).element);const o=copySubMenu(Array.from(a).map(r=>r.getAttribute("data-node-id")),!0,a[0]).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let r="";a.forEach(c=>{r+=getPlainText(c)+`
`}),copyPlainText(r.trimEnd()),focusBlock(a[0])}},{id:"copy",iconHTML:"",label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(a[0])?focusBlock(a[0]):focusByRange(getEditorRange(a[0])),document.execCommand("copy")}}]),l=this.genCopyTextRef(a);if(l&&o.splice(7,0,l),t.disabled||o.push({id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){duplicateBlock(a,t)}}),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:o}).element),!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"cut",label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{focusBlock(a[0]),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"move",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{movePathTo(c=>{hintMoveBlock(c[0],a,t)})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addEditorToDatabase(t,getEditorRange(a[0]))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var c;(c=t.breadcrumb)==null||c.hide(),removeBlock(t,a[0],getEditorRange(a[0]),"Backspace")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_appearance",type:"separator"}).element);const r=new MenuItem({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(r),isMobile()||r.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(a,t),this.genWidths(a,t)}if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(new MenuItem({id:"separator_quickMakeCard",type:"separator"}).element);const r=!a.some(c=>!c.hasAttribute(Constants.CUSTOM_RIFF_DECKS)&&c.getAttribute("data-type")!=="NodeThematicBreak");window.siyuan.menus.menu.append(new MenuItem({id:r?"removeCard":"quickMakeCard",label:r?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,icon:"iconRiffCard",click(){quickMakeCard(t,a)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDeck",label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",ignore:!window.siyuan.config.flashcard.deck,click(){const c=[];a.forEach(u=>{u.getAttribute("data-type")!=="NodeThematicBreak"&&c.push(u.getAttribute("data-node-id"))}),makeCard(t.app,c)}}).element)}return(n=t==null?void 0:t.app)!=null&&n.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:a},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(t,a){var n,i;if(!a)return;hideElements(["util","toolbar","hint"],t),window.siyuan.menus.menu.remove(),isMobile()&&activeBlur();const s=a.getAttribute("data-node-id"),o=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(o.length>1){if(window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_BLOCK_MULTI),Array.from(o).find(b=>{if(s===b.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(t,Array.from(o))}else window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_BLOCK_SINGLE);let l;if(a.tagName==="BUTTON"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(f=>{if(!isInEmbedBlock(f)&&this.isMatchNode(f))return l=f,!0}):l=a,!l)return;const r=l.getAttribute("data-type"),c=l.getAttribute("data-subtype"),u=[];hideElements(["select"],t),l.classList.add("protyle-wysiwyg--select"),countBlockWord([s],t.block.rootID),r==="NodeParagraph"&&!t.disabled?(u.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,selectsElement:[l],type:"Blocks2ULs"})),u.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:[l],type:"Blocks2OLs"})),u.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:[l],type:"Blocks2TLs"})),u.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),u.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),u.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),u.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),u.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),u.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),u.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!t.disabled?(u.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:[l],type:"Blocks2Ps"})),u.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),c!=="h1"&&u.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),c!=="h2"&&u.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),c!=="h3"&&u.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),c!=="h4"&&u.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),c!=="h5"&&u.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),c!=="h6"&&u.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!t.disabled?(u.push(this.turnsOneInto({menuId:"paragraph",id:s,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelList"})),u.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),l.getAttribute("data-subtype")==="o"?(u.push(this.turnsOneInto({menuId:"list",id:s,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"OL2UL"})),u.push(this.turnsOneInto({menuId:"check",id:s,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"UL2TL"}))):l.getAttribute("data-subtype")==="t"?(u.push(this.turnsOneInto({menuId:"list",id:s,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"TL2UL"})),u.push(this.turnsOneInto({menuId:"orderedList",id:s,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"TL2OL"}))):(u.push(this.turnsOneInto({menuId:"orderedList",id:s,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"UL2OL"})),u.push(this.turnsOneInto({menuId:"check",id:s,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"OL2TL"})))):r==="NodeBlockquote"&&!t.disabled&&u.push(this.turnsOneInto({menuId:"paragraph",id:s,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelBlockquote"})),u.length>0&&!t.disabled&&window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),!t.disabled&&!l.classList.contains("hr")&&window.siyuan.menus.menu.append(new MenuItem({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){AIActions([l],t)}}).element);const g=copySubMenu([s],!0,l).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){copyPlainText(getPlainText(l).trimEnd()),focusBlock(l)}},{id:r==="NodeAttributeView"?"copyMirror":"copy",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.copyMirror:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(l)?focusBlock(l):focusByRange(getEditorRange(l)),document.execCommand("copy")}}]),m=this.genCopyTextRef([l]);if(m&&g.splice(7,0,m),r==="NodeAttributeView"?(g.splice(6,0,{iconHTML:"",label:window.siyuan.languages.copyAVID,click(){writeText(l.getAttribute("data-av-id"))}}),t.disabled||(g.push({id:"duplicateMirror",iconHTML:"",label:window.siyuan.languages.duplicateMirror,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){duplicateBlock([l],t)}}),g.push({id:"duplicateCompletely",iconHTML:"",label:window.siyuan.languages.duplicateCompletely,accelerator:window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,click(){duplicateCompletely(t,l)}}))):t.disabled||g.push({id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){duplicateBlock([l],t)}}),window.siyuan.menus.menu.append(new MenuItem({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:g}).element),t.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,accelerator:"\u2318X",click:()=>{focusBlock(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"move",icon:"iconMove",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,click:()=>{movePathTo(f=>{hintMoveBlock(f[0],[l],t)})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",icon:"iconDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,click:()=>{addEditorToDatabase(t,getEditorRange(l))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u232B",click:()=>{var f;(f=t.breadcrumb)==null||f.hide(),removeBlock(t,l,getEditorRange(l),"Backspace")}}).element)),r==="NodeSuperBlock"&&!t.disabled){let f;window.siyuan.menus.menu.append(new MenuItem({id:"separator_cancelSuperBlock",type:"separator"}).element);const b=l.getAttribute("data-sb-layout")==="col";window.siyuan.menus.menu.append(new MenuItem({id:"cancelSuperBlock",label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,accelerator:window.siyuan.config.keymap.editor.general[b?"hLayout":"vLayout"].custom,click(){return po(this,null,function*(){const p=yield cancelSB(t,l);transaction(t,p.doOperations,p.undoOperations),focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${p.previousId}"]`)),hideElements(["gutter"],t)})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto"+(b?"VLayout":"HLayout"),accelerator:window.siyuan.config.keymap.editor.general[b?"vLayout":"hLayout"].custom,label:window.siyuan.languages.turnInto+" "+window.siyuan.languages[b?"vLayout":"hLayout"],click(){const p=l.outerHTML;b?l.setAttribute("data-sb-layout","row"):l.setAttribute("data-sb-layout","col"),l.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,l.outerHTML,p),focusByRange(t.toolbar.range),hideElements(["gutter"],t)}}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&!l.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new MenuItem({id:"separator_code",type:"separator"}).element);const f=l.getAttribute("linewrap"),b=l.getAttribute("ligatures"),p=l.getAttribute("linenumber");window.siyuan.menus.menu.append(new MenuItem({id:"code",type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{id:"md31",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${f==="true"||window.siyuan.config.editor.codeLineWrap&&f!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",_=>{const k=y.querySelector("input");_.target.tagName!=="INPUT"&&(k.checked=!k.checked),l.setAttribute("linewrap",k.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{linewrap:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md2",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeLigatures&&b!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",_=>{const k=y.querySelector("input");_.target.tagName!=="INPUT"&&(k.checked=!k.checked),l.setAttribute("ligatures",k.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{ligatures:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md27",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&p!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",_=>{const k=y.querySelector("input");_.target.tagName!=="INPUT"&&(k.checked=!k.checked),l.setAttribute("linenumber",k.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{linenumber:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&["echarts","mindmap"].includes(l.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new MenuItem({id:"separator_chart",type:"separator"}).element);const f=l.style.height;let b=l.outerHTML;window.siyuan.menus.menu.append(new MenuItem({id:"chart",label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{id:"height",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${f?parseInt(f):"420"}" step="1" min="148" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind:p=>{p.querySelector("input").addEventListener("change",y=>{const _=(y.target.value||"420")+"px";l.style.height=_,updateTransaction(t,s,l.outerHTML,b),b=l.outerHTML,y.stopPropagation();const k=l.querySelector('[contenteditable="false"]');if(k){k.style.height=_;const x=window.echarts.getInstanceById(k.getAttribute("_echarts_instance_"));x&&x.resize()}})}},{id:"update",label:window.siyuan.languages.update,icon:"iconEdit",click(){t.toolbar.showRender(t,l)}}]}).element)}else if(r==="NodeTable"&&!t.disabled){let f=getEditorRange(l);const b=l.querySelector("table");b.contains(f.startContainer)||(f=getEditorRange(b.querySelector("th")));const p=hasClosestByTag(f.startContainer,"TD")||hasClosestByTag(f.startContainer,"TH");p&&(window.siyuan.menus.menu.append(new MenuItem({id:"separator_table",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"table",type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:tableMenu(t,l,p,f).menus}).element))}else if(r==="NodeAttributeView")window.siyuan.menus.menu.append(new MenuItem({id:"separator_exportCSV",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"exportCSV",icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){fetchPost("/api/export/exportAttributeView",{id:l.getAttribute("data-av-id"),blockID:s},f=>{openByMobile(f.data.zip)})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"showDatabaseInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,click(){useShell("showItemInFolder",path.join(window.siyuan.config.system.dataDir,"storage","av",l.getAttribute("data-av-id"))+".json")}}).element);else if((r==="NodeVideo"||r==="NodeAudio")&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_VideoOrAudio",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:r==="NodeVideo"?"assetVideo":"assetAudio",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:videoMenu(t,l,r)}).element);else if(r==="NodeIFrame"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_IFrame",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"assetIFrame",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:iframeMenu(t,l)}).element);else if(r==="NodeHTMLBlock"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_html",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"html",icon:"iconHTML5",label:"HTML",click(){t.toolbar.showRender(t,l)}}).element);else if(r==="NodeBlockQueryEmbed"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"separator_blockEmbed",type:"separator"}).element);const f=l.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new MenuItem({id:"blockEmbed",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{id:"refresh",icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){l.removeAttribute("data-render"),blockRender(t,l)}},{id:"update",icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){t.toolbar.showRender(t,l)}},{type:"separator"},{id:"embedBlockBreadcrumb",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${f==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&f!=="false"?" checked":""}></div>`,bind(b){b.addEventListener("click",p=>{const y=b.querySelector("input");p.target.tagName!=="INPUT"&&(y.checked=!y.checked),l.setAttribute("breadcrumb",y.checked.toString()),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{breadcrumb:y.checked.toString()}}),l.removeAttribute("data-render"),blockRender(t,l),window.siyuan.menus.menu.remove()})}},{id:"headingEmbedMode",label:window.siyuan.languages.headingEmbedMode,type:"submenu",submenu:[{id:"showHeadingWithBlocks",label:window.siyuan.languages.showHeadingWithBlocks,iconHTML:"",checked:l.getAttribute("custom-heading-mode")==="0",click(){l.setAttribute("custom-heading-mode","0"),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":"0"}}),l.removeAttribute("data-render"),blockRender(t,l)}},{id:"showHeadingOnlyTitle",label:window.siyuan.languages.showHeadingOnlyTitle,iconHTML:"",checked:l.getAttribute("custom-heading-mode")==="1",click(){l.setAttribute("custom-heading-mode","1"),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":"1"}}),l.removeAttribute("data-render"),blockRender(t,l)}},{id:"showHeadingOnlyBlocks",label:window.siyuan.languages.showHeadingOnlyBlocks,iconHTML:"",checked:l.getAttribute("custom-heading-mode")==="2",click(){l.setAttribute("custom-heading-mode","2"),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":"2"}}),l.removeAttribute("data-render"),blockRender(t,l)}},{id:"default",label:window.siyuan.languages.default,iconHTML:"",checked:!l.getAttribute("custom-heading-mode"),click(){l.removeAttribute("custom-heading-mode"),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":""}}),l.removeAttribute("data-render"),blockRender(t,l)}}]}]}).element)}else if(r==="NodeHeading"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element);const f=[];c!=="h1"&&f.push(this.genHeadingTransform(t,s,1)),c!=="h2"&&f.push(this.genHeadingTransform(t,s,2)),c!=="h3"&&f.push(this.genHeadingTransform(t,s,3)),c!=="h4"&&f.push(this.genHeadingTransform(t,s,4)),c!=="h5"&&f.push(this.genHeadingTransform(t,s,5)),c!=="h6"&&f.push(this.genHeadingTransform(t,s,6)),window.siyuan.menus.menu.append(new MenuItem({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:f}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:s,removeFoldAttr:l.getAttribute("fold")!=="1"},b=>{isInAndroid()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+Constants.ZWSP):isInHarmony()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+Constants.ZWSP):writeText(b.data+Constants.ZWSP)})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:s,removeFoldAttr:l.getAttribute("fold")!=="1"},b=>{isInAndroid()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+Constants.ZWSP):isInHarmony()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(b.data).trimEnd(),b.data+Constants.ZWSP):writeText(b.data+Constants.ZWSP),fetchPost("/api/block/getHeadingDeleteTransaction",{id:s},p=>{if(p.data.doOperations.forEach(y=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${y.id}"]`).forEach(_=>{_.remove()})}),t.wysiwyg.element.childElementCount===0){const y=Lute.NewNodeID(),_=genEmptyElement(!1,!1,y);t.wysiwyg.element.insertAdjacentElement("afterbegin",_),p.data.doOperations.push({action:"insert",data:_.outerHTML,id:y,parentID:t.block.parentID}),p.data.undoOperations.push({action:"delete",id:y}),focusBlock(_)}transaction(t,p.data.doOperations,p.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingDeleteTransaction",{id:s},b=>{if(b.data.doOperations.forEach(p=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${p.id}"]`).forEach(y=>{y.remove()})}),t.wysiwyg.element.childElementCount===0){const p=Lute.NewNodeID(),y=genEmptyElement(!1,!1,p);t.wysiwyg.element.insertAdjacentElement("afterbegin",y),b.data.doOperations.push({action:"insert",data:y.outerHTML,id:p,parentID:t.block.parentID}),b.data.undoOperations.push({action:"delete",id:p}),focusBlock(y)}transaction(t,b.data.doOperations,b.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),t.options.backlinkData||(window.siyuan.menus.menu.append(new MenuItem({id:"enter",accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)}/${updateHotkeyTip("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.enter,click:()=>{zoomOut({protyle:t,id:s})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"enterBack",accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{enterBack(t,s)}}).element)),!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"insertBefore",icon:"iconBefore",label:window.siyuan.languages.insertBefore,accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"beforebegin",s)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"insertAfter",icon:"iconAfter",label:window.siyuan.languages.insertAfter,accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"afterend",s)}}).element);const f=l.lastElementChild.querySelector(".protyle-attr--refcount");f&&f.textContent&&transferBlockRef(s)}if(window.siyuan.menus.menu.append(new MenuItem({id:"jumpTo",type:"submenu",label:window.siyuan.languages.jumpTo,submenu:[{id:"jumpToParentPrev",iconHTML:"",label:window.siyuan.languages.jumpToParentPrev,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"previous")}},{iconHTML:"",id:"jumpToParentNext",label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"next")}},{iconHTML:"",id:"jumpToParent",label:window.siyuan.languages.jumpToParent,accelerator:window.siyuan.config.keymap.editor.general.jumpToParent.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"parent")}}]}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new MenuItem({id:"fold",label:window.siyuan.languages.fold,accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)}/${updateHotkeyTip("\u2325"+window.siyuan.languages.click)}`,click(){setFold(t,l),focusBlock(l)}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7"+window.siyuan.languages.click),click(){openAttr(l,"bookmark",t)}}).element)),!t.disabled){const f=new MenuItem({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(f),isMobile()||f.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([l],t),this.genWidths([l],t)}if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_4",type:"separator"}).element),window.siyuan.config.cloudRegion===0&&!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((n=getContenteditableElement(l))==null?void 0:n.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!l.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new MenuItem({id:"wechatReminder",icon:"iconMp",label:window.siyuan.languages.wechatReminder,ignore:window.siyuan.config.readonly,click(){openWechatNotify(l)}}).element),r!=="NodeThematicBreak"&&!window.siyuan.config.readonly){const f=l.hasAttribute(Constants.CUSTOM_RIFF_DECKS);window.siyuan.menus.menu.append(new MenuItem({id:f?"removeCard":"quickMakeCard",icon:"iconRiffCard",label:f?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click(){quickMakeCard(t,[l])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDeck",label:window.siyuan.languages.addToDeck,ignore:!window.siyuan.config.flashcard.deck,icon:"iconRiffCard",click(){makeCard(t.app,[s])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_5",type:"separator"}).element)}(i=t==null?void 0:t.app)!=null&&i.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:[l]},separatorPosition:"bottom"});let d=l.getAttribute("updated")||"";return d&&(d=`${window.siyuan.languages.modifiedAt} ${dayjs(d).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new MenuItem({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${d}${window.siyuan.languages.createdAt} ${dayjs(s.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(t,a,n){return{id:"heading"+n,iconHTML:"",icon:"iconHeading"+n,label:window.siyuan.languages["heading"+n],click(){fetchPost("/api/block/getHeadingLevelTransaction",{id:a,level:n},i=>{i.data.doOperations.forEach((s,o)=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{l.outerHTML=s.data}),t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{mathRender(l)}),o===0&&focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`),t.wysiwyg.element,!0)}),transaction(t,i.data.doOperations,i.data.undoOperations)})}}}genClick(t,a,n){updateBatchTransaction(t,a,n),focusBlock(t[0])}genAlign(t,a){window.siyuan.menus.menu.append(new MenuItem({id:"layout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="":n.style.textAlign="left"})}},{id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="center":n.style.textAlign="center"})}},{id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="flex-end":n.style.textAlign="right"})}},{id:"justify",icon:"iconMenu",label:window.siyuan.languages.justify,click:()=>{this.genClick(t,a,n=>{n.style.textAlign="justify"})}},{id:"separator_1",type:"separator"},{id:"ltr",icon:"iconLtr",label:window.siyuan.languages.ltr,accelerator:window.siyuan.config.keymap.editor.general.ltr.custom,click:()=>{this.genClick(t,a,n=>{n.style.direction="ltr"})}},{id:"rtl",icon:"iconRtl",label:window.siyuan.languages.rtl,accelerator:window.siyuan.config.keymap.editor.general.rtl.custom,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")||(n.style.direction="rtl")})}},{id:"separator_2",type:"separator"},{id:"clearFontStyle",icon:"iconTrashcan",label:window.siyuan.languages.clearFontStyle,click:()=>{this.genClick(t,a,n=>{n.classList.contains("av")?n.style.justifyContent="":(n.style.textAlign="",n.style.direction="")})}}]}).element)}updateNodeElements(t,a,n){const i=[],s=[];t.forEach(o=>{i.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),n.addEventListener(n.type==="number"?"blur":"change",()=>{t.forEach(o=>{s.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),transaction(a,s,i),window.siyuan.menus.menu.remove(),focusBlock(t[0])})}genWidths(t,a){let n;const i=t[0],s=[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${i.style.width.endsWith("px")?parseInt(i.style.width):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.width}"><span class="fn__flex-center">px</span></div>`,bind:l=>{const r=l.querySelector("input");r.addEventListener("input",()=>{t.forEach(c=>{c.style.width=r.value+"px",c.style.flex="none"}),n.value="0",n.parentElement.setAttribute("aria-label",r.value+"px")}),this.updateNodeElements(t,a,r)}}];["25%","33%","50%","67%","75%","100%"].forEach(l=>{s.push({id:"width_"+l,iconHTML:"",label:l,click:()=>{this.genClick(t,a,r=>{r.style.width=l,r.style.flex="none"})}})}),s.push({id:"separator_1",type:"separator"});const o=i.style.width.endsWith("%")?parseInt(i.style.width):0;window.siyuan.menus.menu.append(new MenuItem({id:"width",label:window.siyuan.languages.width,submenu:s.concat([{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${i.style.width.endsWith("px")?i.style.width:i.style.width||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${o}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind:l=>{n=l.querySelector("input"),n.addEventListener("input",()=>{t.forEach(r=>{r.style.width=n.value+"%",r.style.flex="none"}),n.parentElement.setAttribute("aria-label",`${n.value}%`)}),this.updateNodeElements(t,a,n)}},{id:"separator_2",type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,a,l=>{l.style.width&&(l.style.width="",l.style.flex="")})}}])}).element)}genHeights(t,a){if(t.find(r=>{if(!r.classList.contains("p")&&!r.classList.contains("code-block")&&!r.classList.contains("render-node"))return!0}))return;let i;const s=t[0],o=[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${s.style.height.endsWith("px")?parseInt(s.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind:r=>{const c=r.querySelector("input");c.addEventListener("input",()=>{t.forEach(u=>{u.style.height=c.value+"px",u.style.flex="none"}),i.value="0",i.parentElement.setAttribute("aria-label",c.value+"px")}),this.updateNodeElements(t,a,c)}}];["25%","33%","50%","67%","75%","100%"].forEach(r=>{o.push({id:"height_"+r,iconHTML:"",label:r,click:()=>{this.genClick(t,a,c=>{c.style.height=r,c.style.flex="none"})}})}),o.push({type:"separator"});const l=s.style.height.endsWith("%")?parseInt(s.style.height):0;window.siyuan.menus.menu.append(new MenuItem({id:"heightDrag",label:window.siyuan.languages.height,submenu:o.concat([{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${s.style.height.endsWith("px")?s.style.height:s.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${l}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind:r=>{i=r.querySelector("input"),i.addEventListener("input",()=>{t.forEach(c=>{c.style.height=i.value+"%",c.style.flex="none"}),i.parentElement.setAttribute("aria-label",`${i.value}%`)}),this.updateNodeElements(t,a,i)}},{type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,a,r=>{r.style.height&&(r.style.height="",r.style.overflow="")})}}])}).element)}genCopyTextRef(t){return isNotEditBlock(t[0])?!1:{id:"copyText",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){t[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(t[0])),document.execCommand("copy")}}}render(t,a,n,i){var s;if(t.title&&t.title.element.getAttribute("data-render")!=="true")return;const o=n.parentElement.parentElement.querySelector(".protyle-select");if(o&&!o.classList.contains("fn__none"))return;let l="",r=a,c=0,u=0,g,m=!1;for(;r;){let k=hasClosestBlock(r.parentElement);if(!isInEmbedBlock(r)){let x;m||(x=r.getAttribute("data-type"));let T=r.getAttribute("data-node-id");if(x==="NodeAttributeView"&&i){const C=hasClosestByClassName(i,"av__row");if(C&&!C.classList.contains("av__row--header")&&C.dataset.id){a=C;const A=hasClosestByClassName(C,"av__body");let S=isMac()?window.siyuan.languages.rowTip:window.siyuan.languages.rowTip.replace("\u21E7","Shift+");t.disabled?S=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.indexOf("<br")):((s=C.querySelector('[data-dtype="block"]'))==null?void 0:s.getAttribute("data-detached"))==="true"&&(S=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.lastIndexOf("<br"))),l=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${T}" data-row-id="${C.dataset.id}" data-group-id="${A.dataset.groupId||""}" class="ariaLabel" data-position="parentW" aria-label="${S}"><svg><use xlink:href="#iconDrag"></use></svg><span ${t.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,t.disabled||(l=`<button data-type="NodeAttributeViewRow" data-node-id="${T}" data-row-id="${C.dataset.id}" data-group-id="${A.dataset.groupId||""}" class="ariaLabel" data-position="parentW" aria-label="${isMac()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${l}`);break}}if(u===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(x))return;const C=getTopAloneElement(r);g=C.querySelector(".li")||C.querySelector(".list"),(isInEmbedBlock(g)||isInAVBlock(g))&&(g=void 0),C!==r&&x!=="NodeHeading"&&(r=C,k=hasClosestBlock(r.parentElement),x=r.getAttribute("data-type"),T=r.getAttribute("data-node-id"))}x==="NodeListItem"&&u===1&&(l=""),u+=1;let w=this.gutterTip;t.disabled&&(w=this.gutterTip.split("<br>").splice(0,2).join("<br>"));let v="";t.options.backlinkData&&(v=`class="popover__block" data-id="${T}"`);const h=`<button class="ariaLabel" data-position="parentW" aria-label="${w}" 
data-type="${x}" data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${T}">
    <svg><use xlink:href="#${getIconByType(x,r.getAttribute("data-subtype"))}"></use></svg>
    <span ${v} ${t.disabled?"":'draggable="true"'}></span>
</button>`;m||(l=h+l);let E="";if(x==="NodeListItem"&&r.childElementCount>3||x==="NodeHeading"){const C=r.getAttribute("fold");E=`<button class="ariaLabel" data-position="parentW" aria-label="${window.siyuan.languages.fold}" 
data-type="fold" style="cursor:inherit;"><svg style="width: 10px${C&&C==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}if((x==="NodeListItem"||x==="NodeList")&&(g=r,x==="NodeListItem"&&r.childElementCount>3&&(l=h+E)),x==="NodeHeading"&&(l=l+E),x==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")){if(m=!0,k&&k.getAttribute("fold")==="1")return;k&&k.getAttribute("data-type")==="NodeBlockquote"&&(c+=8)}}if(k)r=k;else break}let d=!0;const f=this.element.querySelectorAll("button");if(f.length!==l.split("</button>").length-1?d=!1:Array.from(f).find(k=>{const x=k.getAttribute("data-node-id");if(x&&l.indexOf(x)===-1)return d=!1,!0;const T=k.getAttribute("data-row-id");if(T&&l.indexOf(T)===-1||!T&&l.indexOf("NodeAttributeViewRowMenu")>-1)return d=!1,!0}),d&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=l,this.element.classList.remove("fn__none"),this.element.style.width="";const b=n.parentElement.getBoundingClientRect().top;let p=a.getBoundingClientRect(),y=0;g&&!window.siyuan.config.editor.rtl&&getComputedStyle(a).direction!=="rtl"?(p=g.firstElementChild.getBoundingClientRect(),c=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(p=r.getBoundingClientRect(),c=0):a.classList.contains("av__row")||(p.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||p.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&p.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?y=(p.height-this.element.clientHeight)/2:(r.getAttribute("data-type")==="NodeAttributeView"||a.getAttribute("data-type")==="NodeAttributeView")&&b<p.top&&(y=8)),this.element.style.top=`${Math.max(p.top,b)+y}px`;let _=p.left-this.element.clientWidth-c;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?_=r.getBoundingClientRect().left-this.element.clientWidth-c:a.classList.contains("av__row")&&(_=r.getBoundingClientRect().left-this.element.clientWidth-c+parseInt(getComputedStyle(r).paddingLeft)),this.element.style.left=`${_}px`,_<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${p.left-this.element.clientWidth-c/2+3}px`,l="",Array.from(this.element.children).reverse().forEach((k,x)=>{x!==0&&(k.firstElementChild.style.height="14px"),l+=k.outerHTML}),this.element.innerHTML=l):this.element.querySelectorAll("svg").forEach(k=>{k.style.height=""})}}const bo=(e,t)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){fetchPost("/api/filetree/removeDoc",{notebook:e,path:t});return}fetchPost("/api/block/getDocInfo",{id:getDisplayName(t,!0,!0)},a=>{const n=escapeHtml(a.data.name);let i=`${window.siyuan.languages.confirmDeleteTip.replace("${x}",n)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`;a.data.subFileCount>0&&(i=`${window.siyuan.languages.andSubFile.replace("${x}",n).replace("${y}",a.data.subFileCount)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`),confirmDialog(window.siyuan.languages.deleteOpConfirm,i,()=>{fetchPost("/api/filetree/removeDoc",{notebook:e,path:t})},void 0,!0)})},mf=e=>{if(e.length===1){const t=hasTopClosestByTag(e[0],"UL");if(t){const a=t.getAttribute("data-url");e[0].getAttribute("data-type")==="navigation-file"?bo(a,e[0].getAttribute("data-path")):confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteTip.replace("${x}",Lute.EscapeHTMLStr(getNotebookName(a)))}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{fetchPost("/api/notebook/removeNotebook",{notebook:a,callback:Constants.CB_MOUNT_REMOVE})},void 0,!0)}}else{const t=[];if(e.forEach(a=>{a.getAttribute("data-path")!=="/"&&t.push(a.getAttribute("data-path"))}),t.length===0){showMessage(window.siyuan.languages.notBatchRemove);return}confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmRemoveAll.replace("${count}",t.length)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{fetchPost("/api/filetree/removeDocs",{paths:t})},void 0,!0)}};var ka=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Ca=(e,t=0)=>{let a=0,n=0;return e.cards.forEach((i,s)=>{s>t||(i.state===0?a++:n++)}),`<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardNewCard}">
    <span class="ft__error">${a}</span> /
    <span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${e.unreviewedNewCardCount}</span>
</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardReviewCard}">
    <span class="ft__error">${n}</span> /
    <span class="ft__success">${e.unreviewedOldCardCount}</span>
</span>`},yo=e=>{let t;return t=`<div class="toolbar toolbar--border">
    <svg class="toolbar__icon"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="fn__flex-1 fn__flex-center toolbar__text">${window.siyuan.languages.riffCard}</span>
    <div data-type="count" class="${e.cardsData.cards.length===0?"fn__none":"fn__flex"}">${Ca(e.cardsData)}</span></div>
    <svg class="toolbar__icon" data-id="${e.id||""}" data-cardtype="${e.cardType}" data-type="filter"><use xlink:href="#iconFilter"></use></svg>
    <svg class="toolbar__icon" data-type="more"><use xlink:href="#iconMore"></use></svg>
    <svg class="toolbar__icon" data-type="close"><use xlink:href="#iconCloseRound"></use></svg>
</div>`,`<div class="card__main">
    ${t}
    <div class="card__block fn__flex-1 ${e.cardsData.cards.length===0?"fn__none":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${e.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action fn__none">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            ${isMobile()?"":"(p / q)"}
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer}${isMobile()?"":" ("+window.siyuan.languages.space+" / "+window.siyuan.languages.enterKey+")"}</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <button class="b3-button b3-button--cancel" disabled="disabled" style="display: flex;margin-bottom: 8px;height: 28px;padding: 0;" data-type="-2"><svg><use xlink:href="#iconLeft"></use></svg>${isMobile()?"":"(p / q)"}</button>
            <button data-type="-3" aria-label="0 / x" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F4A4}</div>
                ${window.siyuan.languages.skip}${isMobile()?"":" (0)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j / a" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain}${isMobile()?"":" (1)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k / s" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard}${isMobile()?"":" (2)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / d / ${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey}" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood}${isMobile()?"":" (3)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ; / f" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy}${isMobile()?"":" (4)"}
            </button>
        </div>
    </div>
</div>`},Us=(e,t,a,n)=>{fetchPost("/api/block/getDocInfo",{id:e},i=>{t.wysiwyg.renderCustom(i.data.ial),fetchPost("/api/filetree/getDoc",{id:e,mode:0,size:Constants.SIZE_GET_MAX},s=>{onGet({updateReadonly:!0,data:s,protyle:t,action:s.data.rootID===s.data.id?[]:[Constants.CB_GET_ALL],afterCB:()=>{if(t.element.classList.contains("fn__none"))return;let o=!1;!window.siyuan.config.flashcard.superBlock&&!window.siyuan.config.flashcard.heading&&!window.siyuan.config.flashcard.list&&!window.siyuan.config.flashcard.mark?o=!1:(window.siyuan.config.flashcard.superBlock&&t.wysiwyg.element.querySelector(":scope > .sb")&&(o=!0),window.siyuan.config.flashcard.heading&&t.wysiwyg.element.querySelector(':scope > [data-type="NodeHeading"]')&&(o=!0),window.siyuan.config.flashcard.list&&t.wysiwyg.element.querySelector(".list, .li")&&(o=!0),window.siyuan.config.flashcard.mark&&t.wysiwyg.element.querySelector('span[data-type~="mark"]')&&(o=!0));const l=a.querySelectorAll(".card__action");o?(window.siyuan.config.flashcard.superBlock&&t.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&t.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&t.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&t.element.classList.add("card__block--hidemark"),l[0].classList.remove("fn__none"),l[1].classList.add("fn__none")):(t.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),l[0].classList.add("fn__none"),l[1].querySelectorAll("button.b3-button").forEach((r,c)=>{c<2||(r.previousElementSibling.textContent=n.nextDues[c-1])}),l[1].classList.remove("fn__none"))}})})})},ho=e=>ka(void 0,null,function*(){window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen&&fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]'));let t=0;typeof e.index=="number"&&(t=e.index);const a=new Protyle(e.app,e.element.querySelector("[data-type='render']"),{blockId:"",action:[Constants.CB_GET_ALL],render:{background:!1,gutter:!0,breadcrumbDocName:!0,title:!0,hideTitleOnZoom:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=a),e.cardsData.cards.length>0&&Us(e.cardsData.cards[t].blockID,a.protyle,e.element,e.cardsData.cards[t]),e.element.setAttribute("data-key",Constants.DIALOG_OPENCARD);const n=e.element.querySelectorAll(".card__action");e.index===0||typeof e.index=="undefined"?(n[0].firstElementChild.setAttribute("disabled","disabled"),n[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(n[0].firstElementChild.removeAttribute("disabled"),n[1].querySelector(".b3-button").removeAttribute("disabled"));const i=e.element.querySelector('[data-type="count"]'),s=e.element.querySelector('[data-type="filter"]'),o=()=>{const l=s.getAttribute("data-cardtype"),r=s.getAttribute("data-id");fetchPost(l==="all"?"/api/riff/getRiffDueCards":l==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:r,deckID:r,notebook:r},c=>ka(void 0,null,function*(){t=0,e.cardsData=c.data;for(let u=0;u<e.app.plugins.length;u++)e.cardsData=yield e.app.plugins[u].updateCards(e.cardsData);e.cardsData.cards.length>0?Sa({countElement:i,editor:a,actionElements:n,index:t,cardsData:e.cardsData}):Fs(i,a,n)}))};return i.innerHTML=Ca(e.cardsData,t),e.element.firstChild.addEventListener("click",l=>{const r=l.target;let c="";const u=e.cardsData.cards[t],g=s.getAttribute("data-id");if(typeof l.detail=="string")["1","j","a"].includes(l.detail)?c="1":["2","k","s"].includes(l.detail)?c="2":["3","l","d"].includes(l.detail)?c="3":["4",";","f"].includes(l.detail)?c="4":[" ","enter"].includes(l.detail)?c="-1":["p","q"].includes(l.detail)?c="-2":["0","x"].includes(l.detail)&&(c="-3");else{if(hasClosestByAttribute(r,"data-type","fullscreen")){fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]')),resize(a.protyle),window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen,setStorageVal(Constants.LOCAL_FLASHCARD,window.siyuan.storage[Constants.LOCAL_FLASHCARD]),l.stopPropagation(),l.preventDefault();return}if(hasClosestByAttribute(r,"data-type","more")&&u){if(l.stopPropagation(),l.preventDefault(),s.getAttribute("data-cardtype")==="all"&&s.getAttribute("data-id")){showMessage(window.siyuan.languages.noSupportTip);return}const y=new Menu;y.addItem({id:"setDueTime",icon:"iconClock",label:window.siyuan.languages.setDueTime,click(){const _=new Dialog({title:window.siyuan.languages.setDueTime,content:`<div class="b3-dialog__content">
    <div class="b3-label__text">${window.siyuan.languages.showCardDay}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" value="1" type="number" step="1" min="1">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),k=_.element.querySelector("input"),x=_.element.querySelectorAll(".b3-button");_.bindInput(k,()=>{x[1].click()}),k.focus(),k.select(),x[0].addEventListener("click",()=>{_.destroy()}),x[1].addEventListener("click",()=>{fetchPost("/api/riff/batchSetRiffCardsDueTime",{cardDues:[{id:u.cardID,due:dayjs().add(parseInt(k.value),"day").format("YYYYMMDDHHmmss")}]},()=>{n[0].classList.add("fn__none"),n[1].classList.remove("fn__none"),u.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),e.cardsData.cards.splice(t,1),t--,_.destroy()})})}}),u.state!==0&&y.addItem({id:"reset",icon:"iconRefresh",label:window.siyuan.languages.reset,click(){fetchPost("/api/riff/resetRiffCards",{type:s.getAttribute("data-cardtype"),id:g,deckID:Constants.QUICK_DECK_ID,blockIDs:[u.blockID]},()=>{const _=window.siyuan.languages._time["1m"].replace("%s","");u.lapses=0,u.lastReview=-621355968e5,u.reps=0,u.state=0,u.nextDues={1:_,2:_.replace("1","5"),3:_.replace("1","10"),4:window.siyuan.languages._time["1d"].replace("%s","").replace("1","6")},n[1].querySelectorAll("button.b3-button").forEach((k,x)=>{x<2||(k.previousElementSibling.textContent=u.nextDues[x-1])}),e.cardsData.unreviewedOldCardCount--,e.cardsData.unreviewedNewCardCount++,i.innerHTML=Ca(e.cardsData,t)})}}),y.addItem({id:"removeRiffCard",icon:"iconTrashcan",label:`${window.siyuan.languages.remove} <b>${window.siyuan.languages.riffCard}</b>`,click(){n[0].classList.add("fn__none"),n[1].classList.remove("fn__none"),u.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[u.blockID]}]),e.cardsData.cards.splice(t,1),t--}}),y.addSeparator(),y.addItem({id:"forgetCountAndRevisionCountAndCardStatusAndLastReviewTime",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.forgetCount}</div>
    <div class="fn__space"></div>
    <div>${u.lapses}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.revisionCount}</div>
    <div class="fn__space"></div>
    <div>${u.reps}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.cardStatus}</div>
    <div class="fn__space"></div>
    <div class="${u.state===0?"ft__primary":"ft__success"}">${u.state===0?window.siyuan.languages.flashcardNewCard:window.siyuan.languages.flashcardReviewCard}</div>
</div><div class="fn__flex${u.lastReview>0?"":" fn__none"}">
    <div class="fn__flex-1 ft__breakword" style="width: 170px;">${window.siyuan.languages.lastReviewTime}</div>
    <div class="fn__space"></div>
    <div>${dayjs(u.lastReview).format("YYYY-MM-DD")}</div>
</div>`}),y.fullscreen();return}if(hasClosestByAttribute(r,"data-type","close")){e.dialog&&e.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}const b=hasClosestByAttribute(r,"data-type","filter");if(b){fetchPost("/api/riff/getRiffDecks",{},y=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({id:"all",iconHTML:"",label:window.siyuan.languages.all,click(){s.setAttribute("data-id",""),s.setAttribute("data-cardtype","all"),o()}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"fileTree",iconHTML:"",label:window.siyuan.languages.fileTree,click(){movePathTo((k,x)=>{s.setAttribute("data-id",k[0]==="/"?x[0]:getDisplayName(k[0],!0,!0)),s.setAttribute("data-cardtype",k[0]==="/"?"notebook":"doc"),o()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(e.title||y.data.length>0)&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),e.title&&(window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:escapeHtml(e.title),click(){s.setAttribute("data-id",e.id),s.setAttribute("data-cardtype",e.cardType),o()}}).element),y.data.length>0&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),y.data.forEach(k=>{window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:escapeHtml(k.name),click(){s.setAttribute("data-id",k.id),s.setAttribute("data-cardtype","all"),o()}}).element)});const _=b.getBoundingClientRect();window.siyuan.menus.menu.popup({x:_.left,y:_.bottom})}),l.stopPropagation(),l.preventDefault();return}if(hasClosestByAttribute(r,"data-type","newround")){o(),l.stopPropagation(),l.preventDefault();return}}if(!c){const m=hasClosestByClassName(r,"b3-button");m&&(c=m.getAttribute("data-type"))}if(!(!c||!u)){if(l.preventDefault(),l.stopPropagation(),hideElements(["toolbar","hint","util","gutter"],a.protyle),c==="-1")if(n[0].classList.contains("fn__none"))c="3";else{a.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),n[0].classList.add("fn__none"),n[1].querySelectorAll("button.b3-button").forEach((m,d)=>{d<2||(m.previousElementSibling.textContent=u.nextDues[d-1])}),n[1].classList.remove("fn__none"),Aa(e.app,u,c);return}else if(c==="-2"){t>0&&(t--,Sa({countElement:i,editor:a,actionElements:n,index:t,cardsData:e.cardsData}),Aa(e.app,e.cardsData.cards[t+1],c));return}["1","2","3","4","-3"].includes(c)&&n[0].classList.contains("fn__none")&&fetchPost(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:u.deckID,cardID:u.cardID,rating:parseInt(c),reviewedCards:e.cardsData.cards},()=>{if(c!=="-3"&&(window.siyuan.config.sync.provider!==0&&isPaidUser()||window.siyuan.config.sync.provider===0&&!needSubscribe(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),t++,t>e.cardsData.cards.length-1){const m=s.getAttribute("data-cardtype");fetchPost(m==="all"?"/api/riff/getRiffDueCards":m==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:g,deckID:g,notebook:g,reviewedCards:e.cardsData.cards},d=>ka(void 0,null,function*(){Aa(e.app,e.cardsData.cards[t-1],c),t=0,e.cardsData=d.data;for(let f=0;f<e.app.plugins.length;f++)e.cardsData=yield e.app.plugins[f].updateCards(e.cardsData);e.cardsData.cards.length===0?e.cardsData.unreviewedCount>0?wo(i,a,n,d.data.unreviewedCount):Fs(i,a,n):Sa({countElement:i,editor:a,actionElements:n,index:t,cardsData:e.cardsData})}));return}Sa({countElement:i,editor:a,actionElements:n,index:t,cardsData:e.cardsData}),Aa(e.app,e.cardsData.cards[t-1],c)})}}),a}),Aa=(e,t,a)=>{e.plugins.forEach(n=>{n.eventBus.emit("click-flashcard-action",{type:a,card:t})})},pf=e=>{window.siyuan.config.readonly||fetchPost("/api/riff/getRiffDueCards",{deckID:""},t=>{_o(e,t.data,"all")})},_o=(e,t,a,n,i)=>ka(void 0,null,function*(){if(window.siyuan.dialogs.find(c=>{if(c.element.getAttribute("data-key")===Constants.DIALOG_OPENCARD)return c.destroy(),!0}))return;let o;getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0));for(let c=0;c<e.plugins.length;c++)t=yield e.plugins[c].updateCards(t);const l=new Dialog({positionId:Constants.DIALOG_OPENCARD,content:yo({id:n,cardType:a,cardsData:t,isTab:!1}),width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),o&&focusByRange(o)},resizeCallback(c){c!=="d"&&c!=="t"&&r&&r.resize()}});l.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-surface)",l.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=yield ho({app:e,element:l.element,cardsData:t,title:i,id:n,cardType:a,dialog:l});r.resize(),l.editors={card:r},updateCardHV()}),Sa=e=>{e.editor.protyle.element.classList.remove("fn__none"),e.editor.protyle.element.nextElementSibling.classList.add("fn__none"),e.countElement.innerHTML=Ca(e.cardsData,e.index),e.countElement.classList.remove("fn__none"),e.index===0?(e.actionElements[0].firstElementChild.setAttribute("disabled","disabled"),e.actionElements[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(e.actionElements[0].firstElementChild.removeAttribute("disabled"),e.actionElements[1].querySelector(".b3-button").removeAttribute("disabled")),Us(e.cardsData.cards[e.index].blockID,e.editor.protyle,hasClosestByAttribute(e.countElement,"data-key",Constants.DIALOG_OPENCARD),e.cardsData.cards[e.index])},Fs=(e,t,a)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const n=t.protyle.element.nextElementSibling;n.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,n.classList.remove("fn__none"),a[0].classList.add("fn__none"),a[1].classList.add("fn__none");const i=e.parentElement.querySelector('[data-type="more"]');i.classList.add("fn__none"),i.previousElementSibling.classList.add("fn__none")},wo=(e,t,a,n)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const i=t.protyle.element.nextElementSibling;i.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",n)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,i.classList.remove("fn__none"),a[0].classList.add("fn__none"),a[1].classList.add("fn__none")};let ea,ta=!1;const La=(e,t,a)=>{const n=e.querySelector('[data-type="docprevious"]'),i=e.querySelector('[data-type="docnext"]');t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const s=e.querySelector('.b3-select[data-type="opselect"]'),o=e.querySelector(".b3-list--background");e.querySelector(".protyle-title__input").classList.add("fn__none"),e.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),e.querySelector('.history__text[data-type="mdPanel"]').classList.add("fn__none"),fetchPost("/api/history/searchHistory",{query:a,page:t,op:s.value,type:3},l=>{t<l.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const r=e.querySelector('[data-type="jumpRepoPage"]');l.data.pageCount>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),r.setAttribute("data-totalpage",l.data.pageCount.toString()),r.textContent=t.toString();const c=i.nextElementSibling.nextElementSibling;if(c.classList.remove("fn__none"),c.textContent=window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",l.data.pageCount).replace("${y}",l.data.totalCount),l.data.histories.length===0){o.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let u="";l.data.histories.forEach(g=>{u+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${g}">
    <span class="b3-list-item__text">${dayjs(parseInt(g)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),o.innerHTML=u})},bf=e=>{const t=`<div class="history__action">
    <div class="block__icons">
        <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" disabled>1</button>
        <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
        <span class="fn__space"></span>
        <div class="fn__flex-1"></div>
        <select data-type="opselect" class="b3-select">
            <option value="all" selected>${window.siyuan.languages.allOp}</option>
            <option value="update">${window.siyuan.languages.historyUpdate}</option>
            <option value="format">${window.siyuan.languages.historyFormat}</option>
            <option value="sync">${window.siyuan.languages.historySync}</option>
            <option value="replace">${window.siyuan.languages.historyReplace}</option>
            <option value="outline">${window.siyuan.languages.historyOutline}</option>
        </select>
    </div>
</div>
<div class="fn__flex fn__flex-1 history__panel">
    <ul class="b3-list b3-list--background history__side" ${isMobile()?"":`style="width: ${window.siyuan.storage[Constants.LOCAL_HISTORY].sideDocWidth}"`}>
        <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
    </ul>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="protyle-title__input fn__none ft__center ft__breakword"></div>
        <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
        <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
    </div>
</div>`,a=new Dialog({title:e.pathString,content:t,width:isMobile()?"100vw":"90vw",height:isMobile()?"100vh":"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){ea=void 0}});a.element.setAttribute("data-key",Constants.DIALOG_HISTORYDOC);const n=a.element.querySelector(".b3-select");n.addEventListener("change",()=>{La(a.element,1,e.id)});const i=a.element.querySelector('.history__text[data-type="docPanel"]'),s=a.element.querySelector('.history__text[data-type="mdPanel"]');La(a.element,1,e.id),ea=new Protyle(e.app,i,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(ea.protyle);const o=a.element.querySelector('[data-type="jumpRepoPage"]'),l=a.element.querySelector(".protyle-title__input");a.element.addEventListener("click",r=>{let c=r.target;for(;c&&!c.isEqualNode(a.element);){const u=c.getAttribute("data-type");if(u==="rollback"&&!ta){Ys(c.parentElement,n.value,e.id,g=>{const m=g.path;ta=!1;const d=window.siyuan.languages.rollbackConfirm.replace("${name}",escapeHtml(g.title)).replace("${time}",c.previousElementSibling.previousElementSibling.textContent.trim());confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,d,()=>{fetchPost("/api/history/rollbackDocHistory",{notebook:e.notebookId,historyPath:m})})}),r.stopPropagation(),r.preventDefault();break}else if(c.classList.contains("b3-list-item")&&!ta){Ys(c,n.value,e.id,g=>{var m;const d=g.path;fetchPost("/api/history/getDocHistoryContent",{historyPath:d},f=>{f.data.isLargeDoc?(s.value=f.data.content,s.classList.remove("fn__none"),i.classList.add("fn__none")):(s.classList.add("fn__none"),i.classList.remove("fn__none"),onGet({data:f,protyle:ea.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),l.textContent=g.title,l.classList.remove("fn__none"),ta=!1}),(m=c.parentElement.querySelector(".b3-list-item--focus"))==null||m.classList.remove("b3-list-item--focus"),c.classList.add("b3-list-item--focus")}),r.stopPropagation(),r.preventDefault();break}else if((u==="docprevious"||u==="docnext")&&c.getAttribute("disabled")!=="disabled"){const g=parseInt(o.textContent);La(a.element,u==="docprevious"?g-1:g+1,e.id),r.stopPropagation(),r.preventDefault();break}else if(u==="jumpRepoPage"){const g=parseInt(c.getAttribute("data-totalpage")||"1");confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",g),`<input class="b3-text-field fn__block" type="number" min="1" max="${g}" value="${o.textContent}">`,m=>{const d=m.element.querySelector(".b3-text-field");d.value!==""&&La(a.element,Math.max(1,Math.min(parseInt(d.value),g)),e.id)})}c=c.parentElement}}),resizeSide(a.element.querySelector(".history__resize"),a.element.querySelector(".history__side"),"sideDocWidth")},Ys=(e,t,a,n)=>{ta=!0;const i=e.getAttribute("data-path");i&&n(i);const s=e.getAttribute("data-created");ea.protyle.options.history.created=s,fetchPost("/api/history/getHistoryItems",{query:a,op:t,type:3,created:s},o=>{n(o.data.items[0])})};var vo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const yf=(e,t,a)=>{if(hideTooltip(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_TITLE){window.siyuan.menus.menu.remove();return}fetchPost("/api/block/getDocInfo",{id:e.block.rootID},n=>{var i;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_TITLE);const s=hasTopClosestByClassName(e.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",s?s.dataset.level+"popover-"+a:"app-"+a),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:copySubMenu([e.block.rootID],!0,void 0,e.block.showAll?e.block.id:e.block.rootID)}).element),!e.disabled){window.siyuan.menus.menu.append(movePathToMenu([e.path]));const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addEditorToDatabase(e,o,"title")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{deleteFile(e.notebookId,e.path)}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7"+window.siyuan.languages.click),click(){openFileAttr(n.data.ial,"bookmark",e)}}).element),!window.siyuan.config.readonly){window.siyuan.config.cloudRegion===0&&window.siyuan.menus.menu.append(new MenuItem({id:"wechatReminder",label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){openFileWechatNotify(e)}}).element);const o=!!n.data.ial[Constants.CUSTOM_RIFF_DECKS],l=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getTreeRiffDueCards",{rootID:e.block.rootID},r=>{openCardByData(e.app,r.data,"doc",e.block.rootID,r.data.name)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},r=>{viewCards(e.app,e.block.rootID,pathPosix().join(getNotebookName(e.notebookId),r.data),"Tree")})}},{id:o?"removeCard":"quickMakeCard",iconHTML:"",label:o?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var r;let c=(r=e.title)==null?void 0:r.element;c||(c=document.createElement("div"),c.setAttribute("data-node-id",e.block.rootID),c.setAttribute(Constants.CUSTOM_RIFF_DECKS,n.data.ial[Constants.CUSTOM_RIFF_DECKS])),quickMakeCard(e,[c])}}];window.siyuan.config.flashcard.deck&&l.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{makeCard(e.app,[e.block.rootID])}}),window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:l}).element)}window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return vo(this,null,function*(){const o=getDisplayName(e.path,!1,!0),l=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:o+".sy"});popSearch(e.app,{hasReplace:!1,hPath:pathPosix().join(getNotebookName(e.notebookId),l.data),idPath:[pathPosix().join(e.notebookId,o)],page:1})})}}).element),e.disabled||transferBlockRef(e.block.rootID),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),e.model||window.siyuan.menus.menu.append(new MenuItem({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",click(){openMobileFileById(e.app,e.block.id,e.block.rootID!==e.block.id?[Constants.CB_GET_ALL]:[Constants.CB_GET_CONTEXT])}}).element),e.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){openDocHistory({app:e.app,id:e.block.rootID,notebookId:e.notebookId,pathString:n.data.name})}}).element),window.siyuan.menus.menu.append(exportMd(e.block.showAll?e.block.id:e.block.rootID)),window.siyuan.menus.menu.append(new MenuItem({id:"separator_4",type:"separator"}).element),(i=e==null?void 0:e.app)!=null&&i.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"click-editortitleicon",detail:{protyle:e,data:n.data},separatorPosition:"bottom"}),window.siyuan.menus.menu.append(new MenuItem({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${dayjs(n.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>${window.siyuan.languages.createdAt} ${dayjs(n.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.fullscreen()})};var Eo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class hf{constructor(t){const a=document.createElement("div");a.className="protyle-breadcrumb";let n="";a.innerHTML=`${isMobile()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${updateHotkeyTip(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
${n}
<button class="block__icon fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly" data-subtype="unlock"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="doc" aria-label="${isMac()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon fn__flex-center fn__none ariaLabel" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=a.firstElementChild,a.addEventListener("click",i=>{let s=i.target;for(;s&&!s.isEqualNode(a);){const o=s.getAttribute("data-node-id"),l=s.getAttribute("data-type");if(o){i.preventDefault();break}else if(l==="mobile-menu"){this.genMobileMenu(t),i.preventDefault(),i.stopPropagation();break}else if(l==="doc"){if(i.shiftKey)fetchPost("/api/block/getDocInfo",{id:t.block.rootID},r=>{openFileAttr(r.data.ial,"bookmark",t)});else{const r=s.getBoundingClientRect();openTitleMenu(t,{x:r.right,y:r.bottom,isLeft:!0},Constants.MENU_FROM_TITLE_BREADCRUMB)}i.stopPropagation(),i.preventDefault();break}else if(l==="more"){const r=s.getBoundingClientRect();this.showMenu(t,{x:r.right,y:r.bottom,isLeft:!0}),i.stopPropagation(),i.preventDefault();break}else if(l==="readonly"){updateReadonly(s,t),i.stopPropagation(),i.preventDefault();break}else if(l==="exit-focus"){zoomOut({protyle:t,id:t.block.rootID,focusId:t.block.id}),i.stopPropagation(),i.preventDefault();break}else if(l==="context"){i.stopPropagation(),i.preventDefault(),s.classList.contains("block__icon--active")?(zoomOut({protyle:t,id:t.options.blockId}),s.classList.remove("block__icon--active")):(fetchPost("/api/filetree/getDoc",{id:t.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{onGet({data:r,protyle:t,action:[Constants.CB_GET_HL]})}),s.classList.add("block__icon--active"));break}else if(l==="undo"){t.undo.undo(t),i.preventDefault(),i.stopPropagation();break}else if(l==="redo"){t.undo.redo(t),i.preventDefault(),i.stopPropagation();break}else if(l==="outdent"){if(t.toolbar.range){const r=hasClosestBlock(t.toolbar.range.startContainer);r&&listOutdent(t,[r.parentElement],t.toolbar.range)}i.preventDefault(),i.stopPropagation();break}else if(l==="indent"){if(t.toolbar.range){const r=hasClosestBlock(t.toolbar.range.startContainer);r&&listIndent(t,[r.parentElement],t.toolbar.range)}i.preventDefault(),i.stopPropagation();break}s=s.parentElement}})}startRecord(t){this.messageId=showMessage(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const a=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[a])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(t){const a=new Menu(Constants.MENU_BREADCRUMB_MOBILE_PATH);let n;if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);!t.wysiwyg.element.isEqualNode(s.startContainer)&&!t.wysiwyg.element.contains(s.startContainer)?n=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild:n=hasClosestBlock(s.startContainer)}n||(n=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild);const i=n.getAttribute("data-node-id");fetchPost("/api/block/getBlockBreadcrumb",{id:i,excludeTypes:[]},s=>{s.data.forEach(o=>{let l=!1;(!t.block.showAll&&o.id===t.block.parentID||t.block.showAll&&o.id===t.block.id)&&(l=!0),a.addItem({current:l,icon:getIconByType(o.type,o.subType),label:o.name,click(){zoomOut({protyle:t,id:o.id})}})}),a.fullscreen()})}toggleExit(t){const a=this.element.parentElement.querySelector('[data-type="exit-focus"]');t?a.classList.add("fn__none"):a.classList.remove("fn__none")}showMenu(t,a){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_BREADCRUMB_MORE){window.siyuan.menus.menu.remove();return}let n;const i=hasClosestBlock(getEditorRange(t.element).startContainer);i&&(n=i.getAttribute("data-node-id")),fetchPost("/api/block/getTreeStat",{id:n||(t.block.showAll?t.block.id:t.block.rootID)},s=>{var o,l,r,c;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_BREADCRUMB_MORE),!t.contentElement.classList.contains("fn__none")&&!t.disabled){let g="";g='<input class="b3-form__upload" type="file" multiple="multiple"',t.options.upload.accept?g+=` accept="${t.options.upload.accept}">`:g+=">";const m=new MenuItem({id:"insertAsset",icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${g}`}).element;m.querySelector("input").addEventListener("change",d=>{d.target.files.length!==0&&(uploadFiles(t,d.target.files,d.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(m),!isInAndroid()&&!isInHarmony()&&window.siyuan.menus.menu.append(new MenuItem({id:(o=this.mediaRecorder)!=null&&o.isRecording?"endRecord":"startRecord",current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(l=this.mediaRecorder)!=null&&l.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>Eo(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(d=>{this.mediaRecorder=new RecordMedia(d),this.mediaRecorder.recorder.onaudioprocess=f=>{if(!this.mediaRecorder.isRecording)return;const b=f.inputBuffer.getChannelData(0),p=f.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(b,p)},this.startRecord(t)}).catch(()=>{showMessage(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const d=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[d])}else hideMessage(this.messageId),this.startRecord(t)})}).element)}if(t.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"netImg2LocalAsset",label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){net2LocalAssets(t,"Img")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"netAssets2LocalAssets",label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){net2LocalAssets(t,"Assets")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"uploadAssets2CDN",label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){needSubscribe()||confirmDialog("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{fetchPost("/api/asset/uploadCloud",{id:t.block.id})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new MenuItem({id:"share2Liandi",label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){confirmDialog("\u{1F929} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip.replace("${accountServer}",getCloudURL("")),()=>{fetchPost("/api/export/export2Liandi",{id:t.block.parentID})})}}).element)),(r=t.scroll)!=null&&r.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new MenuItem({id:"keepLazyLoad",current:t.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{t.scroll.keepLazyLoad=!t.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"refresh",icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{reloadProtyle(t,!isMobile())}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"optimizeTypography",label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{hideElements(["toolbar"],t),fetchPost("/api/format/autoSpace",{id:t.block.rootID})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"editMode",icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{id:"wysiwyg",current:!t.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{setEditMode(t,"wysiwyg"),t.scroll.lastScrollTop=0,fetchPost("/api/filetree/getDoc",{id:t.block.id,size:t.block.id===t.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:Constants.SIZE_GET_MAX},g=>{onGet({data:g,protyle:t,action:t.block.id===t.block.rootID?[Constants.CB_GET_FOCUS,Constants.CB_GET_HTML,Constants.CB_GET_UNUNDO]:[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS,Constants.CB_GET_UNUNDO,Constants.CB_GET_HTML]})})}},{id:"preview",current:!t.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{setEditMode(t,"preview"),window.siyuan.menus.menu.remove()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const g=t.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new MenuItem({id:"editReadonly",label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:g==="true",label:window.siyuan.languages.enable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"true"}})}},{id:"disable",iconHTML:"",current:!g||g==="false",label:window.siyuan.languages.disable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}(c=t==null?void 0:t.app)!=null&&c.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:t,data:s.data.stat},separatorPosition:"top"}),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"docInfo",iconHTML:"",type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.runeCount}</div><div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.wordCount}</div><div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.linkCount}</div><div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.imageCount}</div><div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.refCount}</div><div class="fn__flex">${window.siyuan.languages.blockCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.blockCount}</div>`}).element),window.siyuan.menus.menu.fullscreen();const u=hasTopClosestByClassName(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",u?u.dataset.level+"popover":"app")})}render(t,a=!1,n){}hide(){isMobile()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}var Mn=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});class _f{constructor(t){var a;if(this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),(a=t.options.render)!=null&&a.titleShowTop)this.element.innerHTML='<div class="protyle-attr"></div>';else{this.element.innerHTML=`<span aria-label="${isMac()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}" data-position="west" class="protyle-title__icon ariaLabel"><svg><use xlink:href="#iconFile"></use></svg></span>
<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}" class="protyle-title__input" data-tip="${window.siyuan.languages._kernel[16]}"> </div><div class="protyle-attr"></div>`,this.editElement=this.element.querySelector(".protyle-title__input"),this.editElement.addEventListener("paste",i=>{i.stopPropagation(),i.preventDefault();let s=i.clipboardData.getData("text/siyuan");if(s){try{JSON.parse(s),s=i.clipboardData.getData("text/plain")}catch(o){}s=t.lute.BlockDOM2Content(s)}else s=i.clipboardData.getData("text/plain");setTimeout(function(){document.execCommand("insertText",!1,replaceFileName(s))},0),this.rename(t)}),this.editElement.addEventListener("click",()=>{var i;(i=t.toolbar)==null||i.element.classList.add("fn__none")}),this.editElement.addEventListener("input",i=>{i.isComposing||(this.editElement.textContent===""&&this.editElement.querySelectorAll("br").forEach(s=>{s.remove()}),this.rename(t))}),this.editElement.addEventListener("compositionend",()=>{this.rename(t)}),this.editElement.addEventListener("drop",i=>{i.stopPropagation(),i.preventDefault()}),this.editElement.addEventListener("keydown",i=>Mn(this,null,function*(){if(!i.isComposing){if(commonHotkey(t,i))return!0;if(matchHotKey("\u21E7\u2318V",i)){i.preventDefault(),i.stopPropagation();let s=(yield readText())||"";if(s){s=s.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),enableLuteMarkdownSyntax(t);let o=t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(s));restoreLuteMarkdownSyntax(t),o=o.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,replaceFileName(o)),this.rename(t)}return}if(matchHotKey(window.siyuan.config.keymap.general.enterBack.custom,i)){t.path.split("/").length>2,i.preventDefault(),i.stopPropagation();return}if(!electronUndo(i))if(i.key==="ArrowDown"){const s=getSelection().getRangeAt(0).getClientRects();if(s.length===0||this.editElement.getBoundingClientRect().bottom-s[s.length-1].bottom<25){const o=getNoContainerElement(t.wysiwyg.element.firstElementChild);o&&focusBlock(o,t.wysiwyg.element),i.preventDefault(),i.stopPropagation()}}else if(i.key==="Enter"){const s=getContenteditableElement(t.wysiwyg.element.firstElementChild);if(s&&s.textContent===""&&s.getAttribute("placeholder"))focusBlock(t.wysiwyg.element.firstElementChild,t.wysiwyg.element);else{const o=Lute.NewNodeID(),l=genEmptyElement(!1,!0,o);t.wysiwyg.element.insertAdjacentElement("afterbegin",l),focusByWbr(l,t.toolbar.range||getEditorRange(l)),transaction(t,[{action:"insert",data:l.outerHTML,id:o,parentID:t.block.parentID}],[{action:"delete",id:o}])}i.preventDefault(),i.stopPropagation()}else matchHotKey(window.siyuan.config.keymap.editor.general.attr.custom,i)?(fetchPost("/api/block/getDocInfo",{id:t.block.rootID},s=>{openFileAttr(s.data.ial,"bookmark",t)}),i.preventDefault(),i.stopPropagation()):matchHotKey("\u2318A",i)&&(getEditorRange(this.editElement).selectNodeContents(this.editElement),i.preventDefault(),i.stopPropagation())}}));const n=this.element.querySelector(".protyle-title__icon");n.addEventListener("click",i=>{if(i.shiftKey)fetchPost("/api/block/getDocInfo",{id:t.block.rootID},s=>{openFileAttr(s.data.ial,"bookmark",t)});else{const s=n.getBoundingClientRect();openTitleMenu(t,{x:s.left,y:s.bottom},Constants.MENU_FROM_TITLE_PROTYLE)}}),this.element.addEventListener("contextmenu",i=>{var s;if(i.shiftKey)return;if(getSelection().rangeCount===0||n.contains(i.target)){openTitleMenu(t,{x:i.clientX,y:i.clientY},Constants.MENU_FROM_TITLE_PROTYLE);return}(s=t.toolbar)==null||s.element.classList.add("fn__none"),window.siyuan.menus.menu.remove();const o=getEditorRange(this.editElement);o.toString()!==""&&(window.siyuan.menus.menu.append(new MenuItem({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click:()=>{focusByRange(getEditorRange(this.editElement)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click:()=>{focusByRange(getEditorRange(this.editElement)),document.execCommand("cut"),setTimeout(()=>{this.rename(t)},Constants.TIMEOUT_INPUT)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:()=>{const l=getEditorRange(this.editElement);l.extractContents(),focusByRange(l),setTimeout(()=>{this.rename(t)},Constants.TIMEOUT_INPUT)}}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click:()=>Mn(this,null,function*(){if(focusByRange(getEditorRange(this.editElement)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const l=(yield readText())||"";document.execCommand("insertText",!1,replaceFileName(l)),this.rename(t)}catch(l){console.log(l)}})}).element),window.siyuan.menus.menu.append(new MenuItem({id:"pasteAsPlainText",label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click:()=>Mn(this,null,function*(){let l=(yield readText())||"";l=l.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),enableLuteMarkdownSyntax(t);let r=t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(l));restoreLuteMarkdownSyntax(t),r=r.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,replaceFileName(r)),this.rename(t)})}).element),window.siyuan.menus.menu.append(new MenuItem({id:"selectAll",label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click:()=>{o.selectNodeContents(this.editElement),focusByRange(o)}}).element),window.siyuan.menus.menu.popup({x:i.clientX,y:i.clientY})})}this.element.querySelector(".protyle-attr").addEventListener("click",n=>{fetchPost("/api/block/getDocInfo",{id:t.block.rootID},i=>{commonClick(n,t,i.data.ial)})})}rename(t){if(clearTimeout(this.timeout),!validateName(this.editElement.textContent,this.editElement)){const a=getSelectionOffset(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,Constants.SIZE_TITLE)),focusByOffset(this.editElement,a.start,a.end),!1}hideTooltip(),this.timeout=window.setTimeout(()=>{const a=replaceFileName(this.editElement.textContent);if(fetchPost("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:a}),a!==this.editElement.textContent){const n=getSelectionOffset(this.editElement);this.setTitle(a),focusByOffset(this.editElement,n.start,n.end)}setTitle(a)},Constants.TIMEOUT_INPUT)}setTitle(t){if(this.editElement)code160to32(t)!==code160to32(this.editElement.textContent)&&(this.editElement.textContent=t===window.siyuan.languages.untitled?"":t);else{const a=document.getElementById("toolbarName");code160to32(t)!==code160to32(a.value)&&(a.value=t===window.siyuan.languages.untitled?"":t)}}render(t,a){var n;if(t.options.render.hideTitleOnZoom&&(t.block.showAll?this.element.classList.add("fn__none"):this.element.classList.remove("fn__none")),this.element.getAttribute("data-render")==="true"&&this.element.dataset.nodeId===t.block.rootID)return!1;this.element.setAttribute("data-node-id",t.block.rootID),a.data.ial[Constants.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(Constants.CUSTOM_RIFF_DECKS,a.data.ial[Constants.CUSTOM_RIFF_DECKS]),(n=t.background)==null||n.render(a.data.ial,t.block.rootID),t.wysiwyg.renderCustom(a.data.ial),this.element.setAttribute("data-render","true"),this.setTitle(a.data.ial.title);let i="";if(a.data.ial.bookmark&&(i+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(a.data.ial.bookmark)}</div>`),a.data.ial.name&&(i+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(a.data.ial.name)}</div>`),a.data.ial.alias&&(i+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(a.data.ial.alias)}</div>`),a.data.ial.memo&&(i+=`<div class="protyle-attr--memo ariaLabel" aria-label="${Lute.EscapeHTMLStr(a.data.ial.memo)}" data-position="north"><svg><use xlink:href="#iconM"></use></svg></div>`),a.data.ial["custom-avs"]){let s="";a.data.attrViews.forEach(o=>{s+=`<span data-av-id="${o.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block">${o.name}</span>&nbsp;`}),s&&(s=s.substring(0,s.length-6)),i+=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${s}</div>`}if(this.element.querySelector(".protyle-attr").innerHTML=i,a.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${a.data.refCount}</div>`),this.editElement&&new Date().getTime()-dayjs(a.data.id.split("-")[0]).toDate().getTime()<2e3){const s=this.editElement.ownerDocument.createRange();s.selectNodeContents(this.editElement),focusByRange(s)}}}var Ws=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const xa=null;class wf{constructor(t){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img src="${this.transparentData}">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first" style="position: relative;overflow: hidden"><input aria-label="${window.siyuan.languages.upload}" class="ariaLabel b3-form__upload" type="file"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="show-random" aria-label="${window.siyuan.languages.builtIn}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon ariaLabel fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last ariaLabel" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="protyle-background__ia">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="b3-chips b3-chips__doctag fn__none"></div>
    <div class="protyle-background__action">
        <button class="b3-button b3-button--cancel" data-menu="true" data-type="tag">
            <svg><use xlink:href="#iconTags"></use></svg>
            ${window.siyuan.languages.addTag}
        </button>
        <button class="b3-button b3-button--cancel" data-type="icon">
            <svg><use xlink:href="#iconEmoji"></use></svg>
            ${window.siyuan.languages.addIcon}
        </button>
        <button class="b3-button b3-button--cancel" data-type="random">
            <svg><use xlink:href="#iconImage"></use></svg>
            ${window.siyuan.languages.titleBg}
        </button>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.querySelector(".protyle-background__img img"),this.actionElements=this.element.querySelectorAll(".protyle-background__action:not(.fn__flex-center) .b3-button"),this.element.addEventListener("dragover",a=>Ws(this,null,function*(){a.preventDefault()})),this.element.addEventListener("drop",a=>Ws(this,null,function*(){a.dataTransfer.types[0]==="Files"&&a.dataTransfer.files[0].type.indexOf("image")!==-1&&uploadFiles(t,[a.dataTransfer.files[0]],void 0,n=>{const i=JSON.parse(n),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":s}})})})),this.imgElement.addEventListener("mousedown",a=>{if(a.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const n=a.clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((n-l.clientY)/s*100+o).toFixed(2)}%`,a.preventDefault()},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}}),this.element.querySelector("input").addEventListener("change",a=>{a.target.files.length!==0&&uploadFiles(t,a.target.files,a.target,n=>{const i=JSON.parse(n),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":s}})})}),this.element.addEventListener(getEventName(),a=>{let n=a.target;for(hideElements(["gutter"],t);n&&!n.isEqualNode(this.element);){const i=n.getAttribute("data-type");if(n.tagName==="IMG"&&n.parentElement.classList.contains("protyle-background__img")){const s=n.getAttribute("src");a.detail>1&&!s.startsWith("data:image/png;base64")&&(previewImages([s]),a.preventDefault(),a.stopPropagation()),window.siyuan.menus.menu.remove();break}else if(i==="position"&&!t.disabled){const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),s[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",a.preventDefault(),a.stopPropagation();break}else if(i==="cancel"||i==="confirm"){this.imgElement.style.cursor="";const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(s[0].classList.remove("fn__none"),s[1].classList.add("fn__none"),s[2].classList.add("fn__none"),i==="confirm"){const o=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=o,fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":o}})}else this.render(this.ial,t.block.rootID);a.preventDefault(),a.stopPropagation();break}else if(i==="open-emoji"&&!t.disabled){const s=this.iconElement.getBoundingClientRect();openEmojiPanel(t.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width},void 0,n.querySelector("img")),a.preventDefault(),a.stopPropagation();break}else if(i==="show-random"&&!t.disabled){let s="";xa.forEach((l,r)=>{s+=`<div data-index="${r}" style="height: 128px;${l}" class="b3-card b3-card--wrap"></div>`});const o=new Dialog({title:window.siyuan.languages.builtIn,content:`<div class="b3-cards">${s}</div>`,width:isMobile()?"92vw":"912px",height:isMobile()?"80vh":"70vh"});o.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDRANDOM),o.element.addEventListener("click",l=>{const r=l.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=xa[parseInt(r.getAttribute("data-index"))],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),o.destroy())}),a.preventDefault(),a.stopPropagation();break}else if(i==="random"&&!t.disabled){this.ial["title-img"]=xa[getRandom(0,xa.length-1)],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),a.preventDefault(),a.stopPropagation();break}else if(i==="asset"&&!t.disabled){const s=n.getBoundingClientRect();assetMenu(t,{x:n.parentElement.getBoundingClientRect().right,y:s.bottom+8,isLeft:!0},o=>{this.ial["title-img"]=`background-image:url("${o}")`,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),window.siyuan.menus.menu.remove()},Constants.SIYUAN_ASSETS_IMAGE),a.preventDefault(),a.stopPropagation();break}else if(i==="remove"&&!t.disabled){delete this.ial["title-img"],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":""}}),a.preventDefault(),a.stopPropagation();break}else if(i==="icon"&&!t.disabled){const s=getRandomEmoji();if(s){updateFileTreeEmoji(s,t.block.rootID),updateOutlineEmoji(s,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{icon:s}}),t.model&&t.model.parent.setDocIcon(s),this.iconElement.classList.remove("fn__none");const o=this.iconElement.getBoundingClientRect();openEmojiPanel(t.block.rootID,"doc",{x:o.left,y:o.bottom,h:o.height,w:o.width})}a.preventDefault(),a.stopPropagation();break}else if(i==="tag"&&!t.disabled){this.openTag(t,n),a.preventDefault(),a.stopPropagation();break}else if(i==="link"&&!t.disabled){const s=new Dialog({title:window.siyuan.languages.link,width:isMobile()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});s.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDLINK);const o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=`background-image:url("${s.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy()}),s.element.querySelector("input").focus(),a.preventDefault(),a.stopPropagation();break}else if(i==="open-search"){popSearch(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${n.textContent}#`,r:"",page:1}),a.preventDefault(),a.stopPropagation();break}else if(i==="remove-tag"&&!t.disabled){n.parentElement.remove(),this.removeTag(t),a.preventDefault(),a.stopPropagation();break}n=n.parentElement}})}removeTag(t,a){const n=this.getTags();fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:n.toString()}},()=>{a&&a()}),n.length===0?delete this.ial.tags:this.ial.tags=n.toString(),this.render(this.ial,t.block.rootID)}render(t,a){var n;const i=t["title-img"],s=t.icon,o=t.tags;if(this.ial=t,this.element.setAttribute("data-node-id",a),o){let l="";const r=["secondary","primary","info","success","warning","error","pink"];Array.from(new Set(o.split(",").map(c=>c.trim()))).forEach((c,u)=>{c.replace(/ /g,"")&&(l+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[u%7]}" data-type="open-search">${escapeHtml(c)}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`)}),this.tagsElement.innerHTML=`${l}
<div class="protyle-background__action fn__flex-center">
    <button class="b3-button b3-button--cancel" style="margin-bottom: 8px" data-menu="true" data-type="tag"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addTag}</button>
</div>`,this.tagsElement.classList.remove("fn__none"),this.actionElements[0].classList.add("fn__none")}else this.tagsElement.classList.add("fn__none"),this.actionElements[0].classList.remove("fn__none");if(s?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=unicode2Emoji(s),this.actionElements[1].classList.add("fn__none")):(this.actionElements[1].classList.remove("fn__none"),this.iconElement.classList.add("fn__none")),i){if(this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(i)),i.indexOf("url(")>-1){const l=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(n=this.imgElement.style.backgroundImage)==null?void 0:n.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=l,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");this.actionElements[2].classList.add("fn__none"),this.imgElement.parentElement.classList.remove("fn__none"),this.iconElement.style.marginTop="",this.imgElement.style.height="200px"}else this.imgElement.parentElement.classList.add("fn__none"),this.actionElements[2].classList.remove("fn__none"),this.iconElement.style.marginTop="8px";i||s?this.iconElement.parentElement.style.marginTop="":this.iconElement.parentElement.style.marginTop="8px"}openTag(t,a){window.siyuan.menus.menu.remove();const n=new Menu;n.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.tag}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind:s=>{const o=s.querySelector(".b3-list--background");fetchPost("/api/search/searchTag",{k:""},r=>{let c="";const u=this.getTags();r.data.tags.forEach((g,m)=>{c+=`<div class="b3-list-item b3-list-item--narrow${m===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${g}</div>
    ${u.includes(Lute.UnEscapeHTMLStr(g))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`}),o.innerHTML=c});const l=s.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),!r.isComposing)if(upDownHint(o,r),r.key==="Enter"){const c=o.querySelector(".b3-list-item--focus");this.addTags(c?c.dataset.type==="new"?c.querySelector("mark").textContent.trim():c.textContent.trim():l.value.trim(),t,()=>{l.value="",l.dispatchEvent(new CustomEvent("input"))})}else r.key==="Escape"&&window.siyuan.menus.menu.remove()}),l.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTag",{k:l.value.trim()},c=>{let u="",g=!1;const m=this.getTags();c.data.tags.forEach((d,f)=>{u+=`<div class="b3-list-item b3-list-item--narrow${f===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${d}</div>
    ${m.includes(Lute.UnEscapeHTMLStr(d.replace(/<mark>/g,"").replace(/<\/mark>/g,"")))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`,d===`<mark>${c.data.k}</mark>`&&(g=!0)}),!g&&c.data.k&&(u=`<div data-type="new" class="b3-list-item b3-list-item--narrow${u?"":" b3-list-item--focus"}"><div class="fn__flex-1">${window.siyuan.languages.new} <mark>${escapeHtml(c.data.k)}</mark></div></div>`+u),o.innerHTML=u})}),o.addEventListener("click",r=>{const c=r.target,u=hasClosestByClassName(c,"b3-list-item");u&&this.addTags(u.dataset.type==="new"?u.querySelector("mark").textContent.trim():u.textContent.trim(),t,()=>{l.value="",l.dispatchEvent(new CustomEvent("input")),l.focus()})})}});const i=n.element.querySelector(".b3-menu__items");i.setAttribute("style","overflow: initial"),n.fullscreen(),i.firstElementChild.setAttribute("style","padding: 0 8px;height: 100%;")}getTags(t){const a=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(n=>{const i=n.textContent.trim();t&&i===t&&n.remove(),a.push(i)}),a}addTags(t,a,n){const i=this.getTags(t);if(i.includes(t)){this.removeTag(a,n);return}i.push(t),fetchPost("/api/attr/setBlockAttrs",{id:a.block.rootID,attrs:{tags:i.toString()}},()=>{n()}),this.ial.tags=i.toString(),this.render(this.ial,a.block.rootID)}}class vf{constructor(t,a,n){this.version=Constants.SIYUAN_VERSION;let i=n;t.plugins.forEach(l=>{l.protyleOptions&&(i=merge(i,l.protyleOptions))});const o=new Options(i).merge();if(this.protyle={getInstance:()=>this,app:t,transactionTime:new Date().getTime(),id:genUUID(),disabled:!1,updated:!1,element:a,options:o,block:{},highlight:{mark:isSupportCSSHL()?new Highlight:void 0,markHL:isSupportCSSHL()?new Highlight:void 0,ranges:[],rangeIndex:0,styleElement:document.createElement("style")}},isSupportCSSHL()){const l=genUUID();this.protyle.highlight.styleElement.dataset.uuid=l,this.protyle.highlight.styleElement.textContent=`.protyle-content::highlight(search-mark-${l}) {background-color: var(--b3-highlight-background);color: var(--b3-highlight-color);}
  .protyle-content::highlight(search-mark-hl-${l}) {color: var(--b3-highlight-color);background-color: var(--b3-highlight-current-background)}`}if(this.protyle.hint=new Hint(this.protyle),o.render.breadcrumb&&(this.protyle.breadcrumb=new Breadcrumb(this.protyle)),o.render.title&&(this.protyle.title=new Title(this.protyle)),o.render.background&&(this.protyle.background=new Background(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),o.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new Undo,this.protyle.wysiwyg=new WYSIWYG(this.protyle),this.protyle.toolbar=new Toolbar(this.protyle),this.protyle.scroll=new Scroll(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Gutter(this.protyle)),(o.upload.url||o.upload.handler)&&(this.protyle.upload=new Upload),this.init(),o.action.includes(Constants.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new Model({app:t,id:this.protyle.id,type:"protyle",msgCallback:l=>{var r;switch(l.cmd){case"reload":l.data===this.protyle.block.rootID&&reloadProtyle(this.protyle,!1);break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`.av[data-av-id="${l.data.id}"]`)).forEach(c=>{c.removeAttribute("data-render"),avRender(c,this.protyle)});break;case"addLoading":l.data===this.protyle.block.rootID&&addLoading(this.protyle,l.msg);break;case"unfoldHeading":setFoldById(l.data,this.protyle);break;case"transactions":this.onTransaction(l);break;case"readonly":window.siyuan.config.editor.readOnly=l.data,setReadonlyByConfig(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===l.data.srcRootBlockID&&(this.protyle.block.showAll&&l.cmd==="heading2doc"&&!this.protyle.options.backlinkData?fetchPost("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{onGet({data:c,protyle:this.protyle})}):reloadProtyle(this.protyle,!1));break;case"rename":this.protyle.path===l.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(l.data.title),this.protyle.background&&(this.protyle.background.ial.title=l.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===l.data.id&&(!document.body.classList.contains("body--blur")&&getSelection().rangeCount>0&&((r=this.protyle.title.editElement)!=null&&r.contains(getSelection().getRangeAt(0).startContainer))||this.protyle.title.setTitle(l.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${l.data.id}"]`).forEach(c=>{c.getAttribute("data-subtype")==="d"&&(c.innerHTML=l.data.refText)});break;case"moveDoc":this.protyle.path===l.data.fromPath&&(this.protyle.path=l.data.newPath,this.protyle.notebookId=l.data.toNotebook);break;case"unmount":this.protyle.notebookId===l.data.box&&setEmpty(t);break;case"removeDoc":l.data.ids.includes(this.protyle.block.rootID)&&(setEmpty(t),delete window.siyuan.storage[Constants.LOCAL_FILEPOSITION][this.protyle.block.rootID],setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION]));break}}}),n.backlinkData){this.protyle.block.rootID=n.blockId,renderBacklink(this.protyle,n.backlinkData),this.protyle.wysiwyg.element.style.padding="4px 16px 4px 24px";return}if(!n.blockId){removeLoading(this.protyle);return}this.protyle.options.mode!=="preview"&&n.rootId&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][n.rootId]&&(o.action.includes(Constants.CB_GET_SCROLL)||o.action.includes(Constants.CB_GET_ROOTSCROLL)&&n.rootId===n.blockId)?getDocByScroll({protyle:this.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][n.rootId],mergedOptions:o,cb:()=>{this.afterOnGet(o)}}):this.getDoc(o)}}onTransaction(t){let a="";t.data[0].doOperations.find(n=>{var i;if(!this.protyle.preview.element.classList.contains("fn__none"))this.protyle.preview.render(this.protyle),n.action==="updateAttrs"&&onTransaction(this.protyle,n,!1);else{if(this.protyle.options.backlinkData&&["delete","move"].includes(n.action))return!0;onTransaction(this.protyle,n,!1),n.action==="delete"&&typeof((i=n.data)==null?void 0:i.createEmptyParagraph)=="boolean"&&!n.data.createEmptyParagraph||(a=n.action)}}),this.protyle.wysiwyg.element.childElementCount===0&&this.protyle.block.parentID&&a&&(a==="delete"&&this.protyle.block.showAll?this.protyle.options.handleEmptyContent?this.protyle.options.handleEmptyContent():zoomOut({protyle:this.protyle,id:this.protyle.block.rootID,focusId:this.protyle.block.id}):(this.protyle.undo.clear(),this.reload(!1)))}getDoc(t){var a;fetchPost("/api/filetree/getDoc",{id:t.blockId,isBacklink:t.action.includes(Constants.CB_GET_BACKLINK),originalRefBlockIDs:t.originalRefBlockIDs,mode:t.action&&t.action.includes(Constants.CB_GET_CONTEXT)?3:0,size:(a=t.action)!=null&&a.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},n=>{onGet({data:n,protyle:this.protyle,action:t.action,afterCB:()=>{this.afterOnGet(t)}})})}afterOnGet(t){this.protyle.model,resize(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),t.after&&t.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=setLute({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Preview(this.protyle),initUI(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){destroy(this.protyle)}resize(){resize(this.protyle)}reload(t){reloadProtyle(this.protyle,t)}insert(t,a=!1,n=!1){insertHTML(t,this.protyle,a,n)}transaction(t,a){transaction(this.protyle,t,a)}turnIntoOneTransaction(t,a,n){turnsIntoOneTransaction({protyle:this.protyle,selectsElement:t,type:a,level:n})}turnIntoTransaction(t,a,n){turnsIntoTransaction({protyle:this.protyle,nodeElement:t,type:a,level:n})}updateTransaction(t,a,n){updateTransaction(this.protyle,t,a,n)}updateBatchTransaction(t,a){updateBatchTransaction(t,this.protyle,a)}getRange(t){return getEditorRange(t)}hasClosestBlock(t){return hasClosestBlock(t)}focusBlock(t,a=!0){return focusBlock(t,void 0,a)}disable(){disabledProtyle(this.protyle)}enable(){enableProtyle(this.protyle)}renderAVAttribute(t,a,n){renderAVAttribute(t,a,this.protyle,n)}}var $n=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const js=(e,t)=>{e.addEventListener("change",()=>{fetchPost("/api/attr/setBlockAttrs",{id:t,attrs:{[e.dataset.name]:e.value}})})},Ef=e=>{const t=e.getAttribute("data-node-id"),a=getEditorRange(e),n=e.getAttribute(Constants.CUSTOM_REMINDER_WECHAT);let i="";n&&(i=dayjs(n).format("YYYY-MM-DD HH:mm"));const s=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${i}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){focusByRange(a)}});s.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{o[1].getAttribute("disabled")||(o[1].setAttribute("disabled","disabled"),fetchPost("/api/block/setBlockReminder",{id:t,timed:"0"},()=>{e.removeAttribute(Constants.CUSTOM_REMINDER_WECHAT),s.destroy()}))}),o[2].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}if(o[2].getAttribute("disabled"))return;o[2].setAttribute("disabled","disabled");const r=dayjs(l).format("YYYYMMDDHHmmss");fetchPost("/api/block/setBlockReminder",{id:t,timed:r},()=>{e.setAttribute(Constants.CUSTOM_REMINDER_WECHAT,r),s.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})},kf=e=>{fetchPost("/api/block/getDocInfo",{id:e.block.rootID},t=>{const a=t.data.ial[Constants.CUSTOM_REMINDER_WECHAT];let n="";a&&(n=dayjs(a).format("YYYY-MM-DD HH:mm"));const i=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${n}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:"0"},()=>{i.destroy()})}),s[2].addEventListener("click",()=>{const o=i.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:dayjs(o).format("YYYYMMDDHHmmss")},()=>{i.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})})},ko=(e,t="bookmark",a)=>{let n="",i="",s=!1;const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;let l;a||(getAllEditor().find(c=>{if(e.id===c.protyle.block.rootID)return a=c.protyle,!0}),a||(l=new Protyle(window.siyuan.ws.app,document.createElement("div"),{blockId:e.id}))),Object.keys(e).forEach(c=>{Constants.CUSTOM_RIFF_DECKS===c||c.startsWith("custom-sy-")||(c===Constants.CUSTOM_REMINDER_WECHAT?i=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${c}" value="${dayjs(e[c]).format("YYYY-MM-DD HH:mm")}">
</label>`:c.indexOf("custom-av")>-1?s=!0:c.indexOf("custom")>-1&&(n+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${c.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical;" spellcheck="false" class="b3-text-field fn__block" rows="1" data-name="${c}">${e[c]}</textarea>
</label>`))});const r=new Dialog({width:isMobile()?"92vw":"50vw",containerClassName:"b3-dialog__container--theme",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${s?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea style="resize: vertical" spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${e.memo||""}</textarea>
            </label>
            ${i}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${n}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--cancel">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){focusByRange(o),a?hideElements(["select"],a):l.destroy()}});r.element.setAttribute("data-key",Constants.DIALOG_ATTR),r.element.querySelector('.b3-text-field[data-name="bookmark"]').value=e.bookmark||"",r.element.querySelector('.b3-text-field[data-name="name"]').value=e.name||"",r.element.querySelector('.b3-text-field[data-name="alias"]').value=e.alias||"",r.element.addEventListener("click",c=>{let u=c.target;for(typeof c.detail=="string"&&(u=r.element.querySelector(`.item--full[data-type="${c.detail}"]`));u!==r.element;){const g=u.dataset.action;if(u.classList.contains("item--full"))u.parentElement.querySelector(".item--focus").classList.remove("item--focus"),u.classList.add("item--focus"),r.element.querySelectorAll(".custom-attr").forEach(m=>{m.dataset.type===u.dataset.type?(m.dataset.type==="NodeAttributeView"&&m.innerHTML===""&&renderAVAttribute(m,e.id,a||l.protyle),m.classList.remove("fn__none")):m.classList.add("fn__none")});else if(g==="remove"){fetchPost("/api/attr/setBlockAttrs",{id:e.id,attrs:{["custom-"+u.previousElementSibling.textContent]:""}}),u.parentElement.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(g==="bookmark"){fetchPost("/api/attr/getBookmarkLabels",{},m=>{window.siyuan.menus.menu.remove(),m.data.length===0?window.siyuan.menus.menu.append(new MenuItem({id:"emptyContent",iconHTML:"",label:window.siyuan.languages.emptyContent,type:"readonly"}).element):m.data.forEach(d=>{window.siyuan.menus.menu.append(new MenuItem({label:d,click(){const f=u.parentElement.parentElement.querySelector("input");f.value=d,f.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:c.clientX,y:c.clientY+16,w:16})}),c.stopPropagation(),c.preventDefault();break}else if(g==="addCustom"){const m=new Dialog({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input spellcheck="false" class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});m.element.setAttribute("data-key",Constants.DIALOG_SETCUSTOMATTR);const d=m.element.querySelector("input"),f=m.element.querySelectorAll(".b3-button");m.bindInput(d,()=>{f[1].click()}),d.focus(),d.select(),f[0].addEventListener("click",()=>{m.destroy()}),f[1].addEventListener("click",()=>{if(!isValidAttrName(d.value))return showMessage(window.siyuan.languages.attrName+" <b>"+escapeHtml(d.value)+"</b> "+window.siyuan.languages.invalid),!1;u.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${d.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical" spellcheck="false" data-name="custom-${d.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const b=u.parentElement.previousElementSibling.querySelector(".b3-text-field");b.focus(),js(b,e.id),m.destroy()}),c.stopPropagation(),c.preventDefault();break}u=u.parentElement}}),r.element.querySelectorAll(".b3-text-field").forEach(c=>{t!=="av"&&t!=="custom"&&t===c.getAttribute("data-name")&&c.focus(),js(c,e.id)}),t==="av"?r.element.dispatchEvent(new CustomEvent("click",{detail:"NodeAttributeView"})):t==="custom"&&r.element.dispatchEvent(new CustomEvent("click",{detail:"custom"}))},Cf=(e,t="bookmark",a)=>{if(e.getAttribute("data-type")==="NodeThematicBreak")return;const n=e.getAttribute("data-node-id");fetchPost("/api/attr/getBlockAttrs",{id:n},i=>{ko(i.data,t,a)})},Af=(e,t=!0,a,n)=>{const i=[{id:"copyBlockRef",iconHTML:"",accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{copyTextByType(e,"ref"),a&&focusBlock(a)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{copyTextByType(e,"blockEmbed"),a&&focusBlock(a)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{copyTextByType(e,"protocol"),a&&focusBlock(a)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{copyTextByType(e,"protocolMd"),a&&focusBlock(a)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:t?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{copyTextByType(e,"hPath"),a&&focusBlock(a)}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,accelerator:t?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{copyTextByType(e,"id"),a&&focusBlock(a)}}];return n&&i.push({id:"copyMarkdown",iconHTML:"",label:window.siyuan.languages.copyMarkdown,accelerator:void 0,click:()=>$n(void 0,null,function*(){const o=(yield fetchSyncPost("/api/export/exportMdContent",{id:n,refMode:3,embedMode:1,yfm:!1,fillCSSVar:!1,adjustHeadingLevel:!1})).data.content;writeText(o),a&&focusBlock(a)})}),i},Sf=e=>{if(!window.siyuan.isPublish)return new MenuItem({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportTemplate",label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>$n(void 0,null,function*(){const t=yield fetchSyncPost("/api/block/getRefText",{id:e}),a=new Dialog({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});a.element.setAttribute("data-key",Constants.DIALOG_EXPORTTEMPLATE);const n=a.element.querySelector("input"),i=a.element.querySelectorAll(".b3-button");a.bindInput(n,()=>{i[1].click()});let s=replaceFileName(t.data);const o=32;s.length>o&&(s=s.substring(0,o)),n.value=s,n.focus(),n.select(),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{n.value.trim()===""?n.value=window.siyuan.languages.untitled:n.value=replaceFileName(n.value),s.length>o&&(s=s.substring(0,o)),fetchPost("/api/template/docSaveAsTemplate",{id:e,name:n.value,overwrite:!1},l=>{if(l.code===1){confirmDialog(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{fetchPost("/api/template/docSaveAsTemplate",{id:e,name:n.value,overwrite:!0},r=>{r.code===0&&showMessage(window.siyuan.languages.exportTplSucc)})});return}showMessage(window.siyuan.languages.exportTplSucc)}),a.destroy()})})},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportSY",{id:e},a=>{hideMessage(t),openByMobile(a.data.zip)})}},{id:"exportMarkdown",label:"Markdown .zip",icon:"iconMarkdown",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportMd",{id:e},a=>{hideMessage(t),openByMobile(a.data.zip)})}},{id:"exportImage",label:window.siyuan.languages.image,icon:"iconImage",click:()=>{exportImage(e)}},{id:"exportPDF",label:window.siyuan.languages.print,icon:"iconPDF",ignore:!isInAndroid()&&!isInHarmony(),click:()=>{const t=showMessage(window.siyuan.languages.exporting),a=window.siyuan.storage[Constants.LOCAL_EXPORTPDF];fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:a.keepFold,merge:a.mergeSubdocs},n=>$n(void 0,null,function*(){const i=window.location.protocol+"//"+window.location.host+"/",s=yield onExport(n,void 0,i,{type:"pdf",id:e});isInAndroid()?window.JSAndroid.print(s):isInHarmony()&&window.JSHarmony.print(s),setTimeout(()=>{hideMessage(t)},3e3)}))}},{id:"exportHTML_SiYuan",label:"HTML (SiYuan)",iconClass:"ft__error",icon:"iconHTML5",click:()=>{saveExport({type:"html",id:e})}},{id:"exportHTML_Markdown",label:"HTML (Markdown)",icon:"iconHTML5",click:()=>{saveExport({type:"htmlmd",id:e})}}]}).element},Co=(e,t,a,n)=>{const i=[];if(i.push({id:Ve()?"useDefault":"useBrowserView",label:Ve()?window.siyuan.languages.useDefault:window.siyuan.languages.useBrowserView,accelerator:n?window.siyuan.languages.click:"",click:()=>{zn(t)}}),a)return i;window.siyuan.menus.menu.append(new Ee({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element)},Lf=e=>new MenuItem({id:"rename",accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{rename(e)}}).element,xf=e=>new MenuItem({id:"move",label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){movePathTo((t,a)=>{moveToPath(e,a[0],t[0])},e)}}).element;var Ao=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Hn=(e,t,a,n=[])=>{fetchPost("/api/search/searchAsset",{k:t,exts:n},i=>{let s="";i.data.forEach((c,u)=>{s+=`<div data-value="${c.path}" class="b3-list-item${u===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${c.hName}</div></div>`});const o=e.querySelector(".b3-list"),l=e.querySelector("#preview"),r=e.querySelector("input");o.innerHTML=s||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,i.data.length>0?l.innerHTML=renderAssetsPreview(i.data[0].path):l.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.fullscreen(),t||r.select()})},Tf=(e,t,a,n)=>{const i=new Menu(Constants.MENU_BACKGROUND_ASSET);i.isOpen||i.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: ${isMobile()?"80":"50"}vh">
<div class="fn__flex-column" style="${isMobile()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${isMobile()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(s){s.style.maxWidth="none";const o=s.querySelector(".b3-list"),l=s.querySelector("#preview");o.addEventListener("mouseover",c=>{const u=c.target,g=hasClosestByClassName(u,"b3-list-item");g&&(l.innerHTML=renderAssetsPreview(g.getAttribute("data-value")))});const r=s.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;const u=s.querySelector(".b3-list--empty");if(!u){const g=upDownHint(o,c);g&&(l.innerHTML=renderAssetsPreview(g.getAttribute("data-value")),c.stopPropagation())}if(c.key==="Enter"){if(u)a||(window.siyuan.menus.menu.remove(),focusByRange(e.toolbar.range));else{const g=s.querySelector(".b3-list-item--focus");a?a(g.getAttribute("data-value"),g.textContent):(hintRenderAssets(g.getAttribute("data-value"),e),window.siyuan.menus.menu.remove())}c.preventDefault(),c.stopPropagation()}else c.key==="Escape"&&(a||focusByRange(e.toolbar.range))}),r.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),Hn(s,r.value,t,n))}),r.addEventListener("compositionend",c=>{c.stopPropagation(),Hn(s,r.value,t,n)}),s.lastElementChild.addEventListener("click",c=>{const u=c.target;if(hasClosestByAttribute(u,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),c.stopPropagation();return}if(hasClosestByAttribute(u,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),c.stopPropagation();return}const d=hasClosestByClassName(u,"b3-list-item");if(d){c.stopPropagation();const f=d.getAttribute("data-value");a?a(f,d.textContent):(hintRenderAssets(f,e),window.siyuan.menus.menu.remove())}}),Hn(s,"",t,n)}})},If=(e,t)=>{var a;const n=hasClosestBlock(t);if(!n)return;hideElements(["util","toolbar","hint"],e);const i=n.getAttribute("data-node-id");let s=n.outerHTML;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_INLINE_FILE_ANNOTATION_REF);let o;window.siyuan.menus.menu.append(new MenuItem({id:"idAndAnchor",iconHTML:"",type:"readonly",label:`<div>ID</div><textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${isMobile()?"100%":"360px"}" class="b3-text-field" readonly>${t.getAttribute("data-id")||""}</textarea><div class="fn__hr"></div><div>${window.siyuan.languages.anchor}</div><textarea rows="1" style="margin:4px 0;width: ${isMobile()?"100%":"360px"}" class="b3-text-field"></textarea>`,bind(r){r.style.maxWidth="none",o=r.querySelectorAll(".b3-text-field")[1],o.value=t.textContent;const c=()=>{o.value?t.innerHTML=Lute.EscapeHTMLStr(o.value):t.innerHTML="*"};o.addEventListener("input",u=>{u.isComposing||(c(),u.stopPropagation())}),o.addEventListener("compositionend",u=>{u.isComposing||(c(),u.stopPropagation())}),o.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(u))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:[{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"file-annotation-ref",e.toolbar.range),updateTransaction(e,i,n.outerHTML,s),s=n.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),s=n.outerHTML}}]}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s),focusByWbr(n,e.toolbar.range),s=n.outerHTML}}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const l=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),o.select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==s&&(n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,s));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!e.element.contains(r.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))}},Df=(e,t)=>{var a;const n=hasClosestBlock(t);if(!n)return;hideElements(["util","toolbar","hint"],e);const i=t.getAttribute("data-id"),s=n.getAttribute("data-node-id");let o=n.outerHTML;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_INLINE_REF),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"anchor",iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(r){const c=r.querySelector("input");c.value=t.getAttribute("data-subtype")==="d"?"":t.textContent,c.addEventListener("input",()=>{c.value?t.innerHTML=Lute.EscapeHTMLStr(c.value).trim()||i:fetchPost("/api/block/getRefText",{id:i},u=>{t.innerHTML=u.data}),t.setAttribute("data-subtype",c.value?"s":"d")}),c.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(u))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element)),!e.disabled){let r=[];t.getAttribute("data-subtype")==="s"?r.push({id:"turnToDynamic",iconHTML:"",label:window.siyuan.languages.turnToDynamic,click(){t.setAttribute("data-subtype","d"),fetchPost("/api/block/getRefText",{id:i},c=>{t.innerHTML=c.data,n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o),o=n.outerHTML}),focusByRange(e.toolbar.range)}}):r.push({id:"turnToStatic",iconHTML:"",label:window.siyuan.languages.turnToStatic,click(){t.setAttribute("data-subtype","s"),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o),focusByRange(e.toolbar.range),o=n.outerHTML}}),r=r.concat([{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"block-ref",e.toolbar.range),updateTransaction(e,s,n.outerHTML,o),o=n.outerHTML}},{id:"*",iconHTML:"",label:"*",click(){t.setAttribute("data-subtype","s"),t.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o),focusByRange(e.toolbar.range),o=n.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.setAttribute("data-subtype","s"),t.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o),focusByRange(e.toolbar.range),o=n.outerHTML}},{id:"link",label:window.siyuan.languages.link,iconHTML:"",click(){t.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${t.getAttribute("data-id")}">${t.innerHTML}</span><wbr>`,n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o),focusByWbr(n,e.toolbar.range),o=n.outerHTML}}]),t.parentElement.textContent.trim()===t.textContent.trim()&&t.parentElement.tagName==="DIV"&&r.push({id:"blockEmbed",iconHTML:"",label:window.siyuan.languages.blockEmbed,click(){const c=`<div data-content="select * from blocks where id='${i}'" data-node-id="${s}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${dayjs().format("YYYYMMDDHHmmss")}">${n.querySelector(".protyle-attr").outerHTML}</div>`;n.outerHTML=c,updateTransaction(e,s,c,o),blockRender(e,e.wysiwyg.element),o=n.outerHTML}}),r.push({id:"defBlock",iconHTML:"",label:window.siyuan.languages.defBlock,click(){fetchPost("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!1})}}),r.push({id:"defBlockChildren",iconHTML:"",label:window.siyuan.languages.defBlockChildren,click(){fetchPost("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!0})}}),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:r}).element)}window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML).trim())}}).element),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML)),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o),focusByWbr(n,e.toolbar.range),o=n.outerHTML}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o),focusByWbr(n,e.toolbar.range),o=n.outerHTML}}).element)),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-blockref",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const l=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.data=t,window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),e.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==o&&(n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,n.outerHTML,o));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!e.element.contains(r.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))})},Mf=(e,t)=>{var a;const n=getEditorRange(t);window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_INLINE_CONTEXT),e.toolbar.showContent(e,n,t),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-content",detail:{protyle:e,range:n,element:t},separatorPosition:"top"})},$f=(e,t)=>{if(e.block.showAll)Vs({protyle:e,id:e.block.parent2ID,focusId:t});else{const a=e.path.split("/");a.length>2&&openMobileFileById(e.app,a[a.length-2],[Constants.CB_GET_FOCUS,Constants.CB_GET_SCROLL])}},Vs=e=>{var t,a;if(e.protyle.options.backlinkData)return;typeof e.isPushBack=="undefined"&&(e.isPushBack=!0),typeof e.reload=="undefined"&&(e.reload=!1);const n=U(e.protyle.element,"block__popover",!0);if(n){const s=n.querySelector('[data-type="pin"]');s&&n.getAttribute("data-pin")!=="true"&&(s.setAttribute("aria-label",window.siyuan.languages.unpin),s.querySelector("use").setAttribute("xlink:href","#iconUnpin"),n.setAttribute("data-pin","true"))}const i=(t=e.protyle.breadcrumb)==null?void 0:t.element.querySelector(".protyle-breadcrumb__item--active");if(!e.reload&&i&&i.getAttribute("data-node-id")===e.id){if(e.id===e.protyle.block.rootID)return;const s=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId||e.id}"]`);if(s){Ae(s),s.scrollIntoView();return}}(a=window.siyuan.mobile)!=null&&a.editor&&(window.siyuan.storage[H.LOCAL_DOCINFO]={id:e.id},Xa(H.LOCAL_DOCINFO,window.siyuan.storage[H.LOCAL_DOCINFO]),e.isPushBack&&zl()),Ce("/api/filetree/getDoc",{id:e.id,size:e.id===e.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:H.SIZE_GET_MAX},s=>Ao(void 0,null,function*(){if(e.isPushBack?Ut({data:s,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[H.CB_GET_FOCUS,H.CB_GET_HTML]:[H.CB_GET_ALL,H.CB_GET_FOCUS,H.CB_GET_HTML],afterCB:e.callback}):Ut({data:s,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[H.CB_GET_FOCUS,H.CB_GET_HTML,H.CB_GET_UNUNDO]:[H.CB_GET_ALL,H.CB_GET_FOCUS,H.CB_GET_UNUNDO,H.CB_GET_HTML],afterCB:e.callback}),e.focusId){let o=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId}"]`);if(!o){const l=yield jn("/api/block/getUnfoldedParentID",{id:e.focusId});e.focusId=l.data.parentID,o=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.data.parentID}"]`)}if(o){let l=o;for(;l.getBoundingClientRect().height===0;)l=l.parentElement;l.classList.contains("protyle-wysiwyg")?l=o.previousElementSibling||o.nextElementSibling:l=ct(l),Ae(l);const r=new ResizeObserver(()=>{Gt(e.protyle,o,!0)});r.observe(e.protyle.wysiwyg.element),setTimeout(()=>{r.disconnect()},1e3*3)}else if(e.focusId){if(e.id===e.protyle.block.rootID){Ce("/api/filetree/getDoc",{id:e.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{Ut({data:l,protyle:e.protyle,action:e.isPushBack?[H.CB_GET_FOCUS]:[H.CB_GET_FOCUS,H.CB_GET_UNUNDO]})});return}}else{Ce("/api/filetree/getDoc",{id:e.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{Ut({data:l,protyle:e.protyle,action:e.isPushBack?[H.CB_GET_FOCUS]:[H.CB_GET_FOCUS,H.CB_GET_UNUNDO]})});return}}else e.id!==e.protyle.block.rootID&&(e.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{e.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365))}))},Hf=(e,t,a,n)=>{var i;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_INLINE_IMG);const s=hasClosestBlock(a);if(!s)return;hideElements(["util","toolbar","hint"],e);const o=s.getAttribute("data-node-id"),l=a.querySelector("img"),r=a.querySelector(".protyle-action__title span"),c=s.outerHTML;let u=l.getAttribute("src");if(u||(u=""),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"imageUrlAndTitleAndTooltipText",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.imageURL}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea spellcheck="false" style="margin:4px 0;width: ${isMobile()?"100%":"360px"}" rows="1" class="b3-text-field">${u}</textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="margin:4px 0;width: ${isMobile()?"100%":"360px"}" rows="1" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.tooltipText}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="margin:4px 0;width: ${isMobile()?"100%":"360px"}" rows="1" class="b3-text-field"></textarea>`,bind(f){f.style.maxWidth="none";const b=f.querySelectorAll("textarea");b[0].addEventListener("input",p=>{const y=p.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim();if(l.setAttribute("src",y),l.setAttribute("data-src",y),y.startsWith("assets/")){const _=a.querySelector(".img__net");_&&_.remove()}else window.siyuan.config.editor.displayNetImgMark&&a.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),b[1].value=r.innerText,b[1].addEventListener("input",p=>{const y=p.target.value;l.setAttribute("title",y),r.innerText=y,mathRender(r)}),b[2].value=l.getAttribute("alt")||"",f.addEventListener("click",p=>{let y=p.target;for(;y;){if(y.dataset.action==="copy"){writeText(y.parentElement.nextElementSibling.value),showMessage(window.siyuan.languages.copied);break}y=y.parentElement}})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){let f=e.lute.BlockDOM2StdMd(a.outerHTML);f=f.replace(/%20/g," "),writeText(f)}}).element),e.disabled&&window.siyuan.menus.menu.append(new MenuItem({id:"copyImageURL",label:window.siyuan.languages.copy+" "+window.siyuan.languages.imageURL,icon:"iconLink",click(){writeText(l.getAttribute("src"))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){copyPNGByLink(l.getAttribute("src"))}}).element),!e.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){let y=e.lute.BlockDOM2StdMd(a.outerHTML);y=y.replace(/%20/g," "),writeText(y),a.outerHTML="<wbr>",s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,s.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){a.outerHTML="<wbr>",s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,s.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element);const f=l.getAttribute("data-src");f.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(f)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"ocr",label:"OCR",submenu:[{id:"ocrResult",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(y){y.style.maxWidth="none",fetchPost("/api/asset/getImageOCRText",{path:l.getAttribute("src")},_=>{const k=y.querySelector("textarea");k.value=_.data.text,k.dataset.ocrText=_.data.text})}},{type:"separator"},{id:"reOCR",iconHTML:"",label:window.siyuan.languages.reOCR,click(){fetchPost("/api/asset/ocr",{path:l.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new MenuItem({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){alignImgCenter(e,s,[a],o,c)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){alignImgLeft(e,s,[a],o,c)}}).element);let b;window.siyuan.menus.menu.append(new MenuItem({id:"width",label:window.siyuan.languages.width,submenu:[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" style="margin: 4px 8px 4px 0" value="${l.parentElement.style.width.endsWith("px")?parseInt(l.parentElement.style.width):""}" type="number" placeholder="${window.siyuan.languages.width}"><span class="fn__flex-center">px</span></div>`,bind(y){const _=y.querySelector("input");_.addEventListener("input",()=>{b.value="0",b.parentElement.setAttribute("aria-label",_.value?_.value+"px":window.siyuan.languages.default),img3115(a),l.parentElement.style.width=_.value?_.value+"px":"",l.style.height=""}),_.addEventListener("blur",()=>{_.value!==l.parentElement.style.width.replace("px","")&&(s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,s.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(s))})}},Ct("25%",l,e,o,s,c),Ct("33%",l,e,o,s,c),Ct("50%",l,e,o,s,c),Ct("67%",l,e,o,s,c),Ct("75%",l,e,o,s,c),Ct("100%",l,e,o,s,c),{id:"separator_1",type:"separator"},{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${l.parentElement.style.width?l.parentElement.style.width.replace("vw","%").replace("calc(","").replace(" - 8px)",""):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${l.parentElement.style.width.indexOf("%")>-1||l.parentElement.style.width.endsWith("vw")?parseInt(l.parentElement.style.width.replace("calc(","")):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind(y){b=y.querySelector("input"),b.addEventListener("input",()=>{img3115(a),l.parentElement.style.width=`calc(${b.value}% - 8px)`,l.style.height="",b.parentElement.setAttribute("aria-label",`${b.value}%`)}),b.addEventListener("change",()=>{s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,s.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(s)})}},{id:"separator_2",type:"separator"},Ct(window.siyuan.languages.default,l,e,o,s,c)]}).element);let p;window.siyuan.menus.menu.append(new MenuItem({id:"height",label:window.siyuan.languages.height,submenu:[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${l.style.height.endsWith("px")?parseInt(l.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind(y){const _=y.querySelector("input");_.addEventListener("input",()=>{p.value="0",p.parentElement.setAttribute("aria-label",_.value?_.value+"px":window.siyuan.languages.default),l.style.height=_.value?_.value+"px":"",img3115(a),l.parentElement.style.width=""}),_.addEventListener("blur",()=>{_.value!==l.style.height.replace("px","")&&(s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,s.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(s))})}},At("25%",l,e,o,s,c),At("33%",l,e,o,s,c),At("50%",l,e,o,s,c),At("67%",l,e,o,s,c),At("75%",l,e,o,s,c),At("100%",l,e,o,s,c),{id:"separator_1",type:"separator"},{id:"heightDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${l.style.height?l.style.height.replace("vh","%"):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${l.style.height.endsWith("vh")?parseInt(l.style.height):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind(y){p=y.querySelector("input"),p.addEventListener("input",()=>{img3115(a),l.parentElement.style.width="",l.style.height=p.value+"vh",p.parentElement.setAttribute("aria-label",`${p.value}%`)}),p.addEventListener("change",()=>{s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,s.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(s)})}},{id:"separator_2",type:"separator"},At(window.siyuan.languages.default,l,e,o,s,c)]}).element)}const g=l.getAttribute("src");g&&(window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),openMenu(e.app,g,!1,!1));const m=l.getAttribute("data-src");m&&m.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem(exportAsset(m)).element),(i=e==null?void 0:e.app)!=null&&i.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-image",detail:{protyle:e,element:a},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const d=hasTopClosestByClassName(e.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app"),!e.disabled){const f=window.siyuan.menus.menu.element.querySelectorAll("textarea");f[0].value?f[1].select():f[0].select(),window.siyuan.menus.menu.removeCB=()=>{const b=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');b&&b.dataset.ocrText!==b.value&&fetchPost("/api/asset/setImageOCRText",{path:l.getAttribute("src"),text:b.value}),l.setAttribute("alt",f[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o,s.outerHTML,c)}}},Gs=(e,t,a=!1)=>{var n;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",H.MENU_INLINE_A);const i=G(t);if(!i)return;ba(),Nt(["util","toolbar","hint"],e);const s=i.getAttribute("data-node-id");let o=i.outerHTML;const l=t.getAttribute("data-href");let r;e.disabled||(window.siyuan.menus.menu.append(new Ee({id:"linkAndAnchorAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea spellcheck="false" rows="1" 
style="margin:4px 0;width: ${O()?"100%":"360px"}" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.anchor}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="width: ${O()?"100%":"360px"};margin: 4px 0;" rows="1" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="width: ${O()?"100%":"360px"};margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(u){u.style.maxWidth="none",r=u.querySelectorAll("textarea"),r[0].value=Lute.UnEscapeHTMLStr(l)||"",r[0].addEventListener("keydown",m=>{if((m.key==="Enter"||m.key==="Escape")&&!m.isComposing)m.preventDefault(),m.stopPropagation(),window.siyuan.menus.menu.remove();else if(m.key==="Tab"&&!m.isComposing)m.preventDefault(),m.stopPropagation(),r[1].focus();else if(Jt(m))return});let g=t.textContent.replace(H.ZWSP,"");!g&&l&&(g=decodeURIComponent(l.replace("https://","").replace("http://","")),g.length>H.SIZE_LINK_TEXT_MAX&&(g=g.substring(0,H.SIZE_LINK_TEXT_MAX)+"..."),t.innerHTML=Lute.EscapeHTMLStr(g)),r[1].value=g,r[1].addEventListener("compositionend",()=>{t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()||"*")}),r[1].addEventListener("input",m=>{m.isComposing||(t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim())||"*")}),r[1].addEventListener("keydown",m=>{if((m.key==="Enter"||m.key==="Escape")&&!m.isComposing)m.preventDefault(),m.stopPropagation(),window.siyuan.menus.menu.remove();else if(m.key==="Tab"&&!m.isComposing)m.preventDefault(),m.stopPropagation(),m.shiftKey?r[0].focus():r[2].focus();else if(Jt(m))return}),r[2].value=Lute.UnEscapeHTMLStr(t.getAttribute("data-title")||""),r[2].addEventListener("keydown",m=>{if((m.key==="Enter"||m.key==="Escape")&&!m.isComposing)m.preventDefault(),m.stopPropagation(),window.siyuan.menus.menu.remove();else if(m.key==="Tab"&&m.shiftKey&&!m.isComposing)m.preventDefault(),m.stopPropagation(),r[1].focus();else if(Jt(m))return}),u.addEventListener("click",m=>{let d=m.target;for(;d;){if(d.dataset.action==="copy"){Za(d.parentElement.nextElementSibling.value),tt(window.siyuan.languages.copied);break}d=d.parentElement}})}}).element),window.siyuan.menus.menu.append(new Ee({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new Ee({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const u=document.createRange();u.selectNode(t),He(u),document.execCommand("copy")}}).element),e.disabled&&window.siyuan.menus.menu.append(new Ee({id:"copyAHref",label:window.siyuan.languages.copyAHref,icon:"iconLink",click(){Za(l)}}).element),e.disabled||(window.siyuan.menus.menu.append(new Ee({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const u=document.createRange();u.selectNode(t),He(u),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new Ee({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),i.setAttribute("updated",at().format("YYYYMMDDHHmmss")),sa(e,s,i.outerHTML,o),Va(i,e.toolbar.range),o=i.outerHTML}}).element),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new Ee({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){wl(l)}}).element),l!=null&&l.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new Ee({id:"turnIntoRef",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){t.setAttribute("data-subtype","s");const u=t.getAttribute("data-type").split(" ");u.push("block-ref"),u.splice(u.indexOf("a"),1),t.setAttribute("data-type",u.join(" ")),t.setAttribute("data-id",r[0].value.replace("siyuan://blocks/","")),r[0].value="",r[2].value="",t.removeAttribute("data-href"),t.removeAttribute("data-title"),i.setAttribute("updated",at().format("YYYYMMDDHHmmss")),sa(e,s,i.outerHTML,o),e.toolbar.range.selectNode(t),e.toolbar.range.collapse(!1),He(e.toolbar.range),o=i.outerHTML}}).element),window.siyuan.menus.menu.append(new Ee({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){r[0].value="",r[2].value="",i.setAttribute("updated",at().format("YYYYMMDDHHmmss")),Il(t,"a",e.toolbar.range),sa(e,s,i.outerHTML,o),o=i.outerHTML}}).element)),l&&(window.siyuan.menus.menu.append(new Ee({id:"separator_2",type:"separator"}).element),Co(e.app,l,!1,!0),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new Ee(Al(l)).element)),!e.disabled&&((n=e==null?void 0:e.app)!=null&&n.plugins)&&il({plugins:e.app.plugins,type:"open-menu-link",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const c=ca(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",c?c.dataset.level+"popover":"app"),!e.disabled&&(a||e.lute.GetLinkDest(l)||l!=null&&l.startsWith("assets/")?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?t.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-title"),t.getAttribute("data-type").indexOf("a")>-1?t.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-href"),!r[1].value&&(r[0].value||r[2].value)&&(t.textContent="*");const u=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);u&&!e.element.contains(u.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),He(e.toolbar.range)),!r[1].value&&!r[0].value&&!r[2].value&&t.remove(),o!==i.outerHTML&&(i.setAttribute("updated",at().format("YYYYMMDDHHmmss")),sa(e,s,i.outerHTML,o))})},Nf=(e,t)=>{var a;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_INLINE_TAG);const n=hasClosestBlock(t);if(!n)return;hideElements(["util","toolbar","hint"],e);const i=n.getAttribute("data-node-id");let s=n.outerHTML;window.siyuan.menus.menu.append(new MenuItem({id:"tag",iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__block" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(l){const r=l.querySelector("input");r.value=t.textContent.replace(Constants.ZWSP,""),r.addEventListener("change",()=>{updateTransaction(e,i,n.outerHTML,s),s=n.outerHTML}),r.addEventListener("compositionend",()=>{t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(r.value||"")}),r.addEventListener("input",c=>{c.isComposing||(t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(r.value||""))}),r.addEventListener("keydown",c=>{if((c.key==="Enter"||c.key==="Escape")&&!c.isComposing){if(c.preventDefault(),c.stopPropagation(),r.value)e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range);else{const u=n.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,u),focusByWbr(n,e.toolbar.range)}window.siyuan.menus.menu.remove()}else if(electronUndo(c))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.languages.click,icon:"iconSearch",click(){popSearch(e.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${t.textContent}#`,r:"",page:1})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameTag(t.textContent.replace(Constants.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){e.toolbar.range.setStart(t.firstChild,0),e.toolbar.range.setEnd(t.lastChild,t.lastChild.textContent.length),e.toolbar.setInlineMark(e,"tag","range")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const l=document.createRange();l.selectNode(t),focusByRange(l),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){const l=document.createRange();l.selectNode(t),focusByRange(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const l=n.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,n.outerHTML,l),focusByWbr(n,e.toolbar.range)}}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-tag",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const o=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},Bf=(e,t)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_INLINE_MATH);const a=hasClosestBlock(t);if(!a)return;const n=a.getAttribute("data-node-id"),i=a.outerHTML;window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const o=document.createRange();o.selectNode(t),focusByRange(o),document.execCommand("copy")}}).element),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const o=document.createRange();o.selectNode(t),focusByRange(o),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,n,a.outerHTML,i),focusByWbr(a,e.toolbar.range)}}).element));const s=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.left,y:s.top+26,h:26})},Ct=(e,t,a,n,i,s)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),img3115(t.parentElement.parentElement),t.parentElement.style.width=e===window.siyuan.languages.default?"":`calc(${e} - 8px)`,t.style.height="",updateTransaction(a,n,i.outerHTML,s),focusBlock(i)}}),At=(e,t,a,n,i,s)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),t.style.height=e===window.siyuan.languages.default?"":parseInt(e)+"vh",img3115(t.parentElement.parentElement),t.parentElement.style.width="",updateTransaction(a,n,i.outerHTML,s),focusBlock(i)}}),Pf=(e,t)=>{const a=t.getAttribute("data-node-id"),n=t.querySelector("iframe");let i=t.outerHTML;const s=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${n.getAttribute("src")||""}</textarea>`,bind(l){l.style.maxWidth="none",l.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim(),u=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||u&&u[1])){const g={bvid:getSearch("bvid",c)||u&&u[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true",autoplay:"0"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((f,b)=>{if(!f)return;b===0&&(f=f.substr(1));const p=f.split("=");g[p[0]]=p[1]});let m="https://player.bilibili.com/player.html?";const d=Object.keys(g);d.forEach((f,b)=>{m+=`${f}=${g[f]}`,b<d.length-1&&(m+="&")}),n.setAttribute("src",m),n.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),n.style.height||(n.style.height="360px"),n.style.width||(n.style.width="640px")}else n.setAttribute("src",c);updateTransaction(e,a,t.outerHTML,i),i=t.outerHTML,r.stopPropagation()})}}],o=n.getAttribute("src");return o?(s.push({type:"separator"}),s.concat(openMenu(e.app,o,!0,!1))):s},Rf=(e,t,a)=>{const n=t.getAttribute("data-node-id"),i=t.querySelector(a==="NodeVideo"?"video":"audio");let s=t.outerHTML;const o=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.link}">${i.getAttribute("src")}</textarea>`,bind(r){r.style.maxWidth="none",r.querySelector("textarea").addEventListener("change",c=>{i.setAttribute("src",c.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()),updateTransaction(e,n,t.outerHTML,s),s=t.outerHTML,c.stopPropagation()})}}],l=i.getAttribute("src");return l&&l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(l)}})),l&&o.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:openMenu(e.app,l,!0,!1)}),l&&l.startsWith("assets/")&&o.push(exportAsset(l)),o},Of=(e,t,a,n)=>{var i;const s=[],o=getColIndex(a);(a.rowSpan>1||a.colSpan>1)&&s.push({id:"cancelMerged",label:window.siyuan.languages.cancelMerged,click:()=>{const S=t.outerHTML;let L=a.rowSpan,$=a.parentElement;const R=a.colSpan;for(;L>0&&$;){let D=$.children[o],M=R;for(;M>0&&D;)D.classList.remove("fn__none"),D.colSpan=1,D.rowSpan=1,D=D.nextElementSibling,M--;$=$.nextElementSibling,L--}if(a.rowSpan=1,a.colSpan=1,a.tagName==="TH"){let D;if(Array.from(t.querySelectorAll("thead tr")).find(M=>{if(D=M,Array.from(M.children).forEach(P=>{(P.rowSpan!==1||P.classList.contains("fn__none"))&&(D=void 0)}),D)return!0}),D){const M=t.querySelector("tbody"),P=t.querySelector("thead");for(;D!==P.lastElementChild;)M.insertAdjacentElement("afterbegin",P.lastElementChild)}}focusByRange(n),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,S)}});const l=t.querySelectorAll("col")[o];(l.style.width||l.style.minWidth!=="60px")&&s.push({id:"useDefaultWidth",label:window.siyuan.languages.useDefaultWidth,click:()=>{const S=t.outerHTML;l.style.width="",l.style.minWidth="60px",updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,S)}});const r=t.getAttribute("custom-pinthead");s.push({id:r?"unpinTableHead":"pinTableHead",icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const S=t.outerHTML;r?t.removeAttribute("custom-pinthead"):t.setAttribute("custom-pinthead","true"),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,S)}}),s.push({id:"separator_1",type:"separator"}),s.push({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{setTableAlign(e,[a],t,"left",n)}}),s.push({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{setTableAlign(e,[a],t,"center",n)}}),s.push({id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{setTableAlign(e,[a],t,"right",n)}}),s.push({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{setTableAlign(e,[a],t,"",n)}});const c=[];c.push(...s),c.push({type:"separator"});const u=t.querySelector("table"),g=a.parentElement.querySelector(".fn__none");let m=!1,d=!1;Array.from(a.parentElement.children).forEach(S=>{S.colSpan>1&&(m=!0),S.rowSpan>1&&(d=!0)});let f=!1,b=!1,p=!1,y=a.parentElement.previousElementSibling;!y&&a.parentElement.parentElement.tagName==="TBODY"&&(y=u.querySelector("thead").lastElementChild),y&&(f=y.querySelector(".fn__none"),Array.from(y.children).forEach(S=>{S.colSpan>1&&(b=!0),S.rowSpan>1&&(p=!0)}));let _=!1,k=!1,x=!1,T=a.parentElement.nextElementSibling;!T&&a.parentElement.parentElement.tagName==="THEAD"&&(T=(i=u.querySelector("tbody"))==null?void 0:i.firstElementChild),T&&(_=T.querySelector(".fn__none"),Array.from(T.children).forEach(S=>{S.colSpan>1&&(k=!0),S.rowSpan>1&&(x=!0)}));let w=!0;Array.from(u.rows).find(S=>{const L=S.cells[o];if(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1)return w=!1,!0});let v=!0;Array.from(u.rows).find(S=>{const L=S.cells[o+1];if(L&&(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1))return v=!1,!0});let h=!0;Array.from(u.rows).find(S=>{const L=S.cells[o-1];if(L&&(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1))return h=!1,!0});const E=[];E.push({id:"insertRowAbove",icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{insertRowAbove(e,n,a,t)}}),(!_||_&&!x&&k)&&E.push({id:"insertRowBelow",icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{insertRow(e,n,a,t)}}),(w||h)&&E.push({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{insertColumn(e,t,a,"beforebegin",n)}}),(w||v)&&E.push({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{insertColumn(e,t,a,"afterend",n)}}),c.push(...E);const C=[];((!g||g&&!d&&m)&&(!f||f&&!p&&b)||(!g||g&&!d&&m)&&(!_||_&&!x&&k)||w&&h||w&&v)&&C.push({id:"separator_2",type:"separator"}),(!g||g&&!d&&m)&&(!f||f&&!p&&b)&&C.push({id:"moveToUp",icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{moveRowToUp(e,n,a,t)}}),(!g||g&&!d&&m)&&(!_||_&&!x&&k)&&C.push({id:"moveToDown",icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{moveRowToDown(e,n,a,t)}}),w&&h&&C.push({id:"moveToLeft",icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{moveColumnToLeft(e,n,a,t)}}),w&&v&&C.push({id:"moveToRight",icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{moveColumnToRight(e,n,a,t)}}),c.push(...C),(a.parentElement.parentElement.tagName!=="THEAD"&&(!g&&!d||g&&!d&&m)||w)&&c.push({type:"separator"});const A=[];return a.parentElement.parentElement.tagName!=="THEAD"&&(!g&&!d||g&&!d&&m)&&A.push({id:"deleteRow",icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{deleteRow(e,n,a,t)}}),w&&A.push({id:"deleteColumn",icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{deleteColumn(e,n,t,a)}}),c.push(...A),{menus:c,removeMenus:A,insertMenus:E,otherMenus:s,other2Menus:C}},qf=(e,t)=>{Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(a=>{if(!isInEmbedBlock(a)){const n=So(t,a,!0,!1,!0,!0);return n.doOperations[0].context={focusId:e.currentNodeID},transaction(t,n.doOperations,n.undoOperations),!0}})},So=(e,t,a,n,i=!0,s=!1)=>{if(t.getAttribute("data-type")==="NodeListItem"&&t.childElementCount<4)return{fold:-1};if(t.getAttribute("data-type")==="NodeThematicBreak")return{fold:-1};const o=t.getAttribute("fold")==="1";if(o){if(typeof a=="boolean"&&!a)return{fold:-1};t.removeAttribute("fold"),t.querySelectorAll(".protyle-linenumber__rows").forEach(u=>{lineNumberRender(u.parentElement)})}else{if(typeof a=="boolean"&&a)return{fold:-1};if(t.setAttribute("fold","1"),getSelection().rangeCount>0){const u=getSelection().getRangeAt(0),g=hasClosestBlock(u.startContainer);g&&g.getBoundingClientRect().width===0&&focusBlock(t,void 0,!1)}clearSelect(["img","av"],t)}const l=t.getAttribute("data-node-id"),r=[],c=[];return t.getAttribute("data-type")==="NodeHeading"?o?(i&&t.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" height="24px" src="/stage/loading-pure.svg"></div>'),r.push({action:"unfoldHeading",id:l,data:n?"remove":void 0}),c.push({action:"foldHeading",id:l})):(r.push({action:"foldHeading",id:l}),c.push({action:"unfoldHeading",id:l}),removeFoldHeading(t)):(r.push({action:"setAttrs",id:l,data:JSON.stringify({fold:o?"":"1"})}),c.push({action:"setAttrs",id:l,data:JSON.stringify({fold:o?"1":""})})),s||transaction(e,r,c),preventScroll(e),{fold:o?0:1,undoOperations:c,doOperations:r}};var Lo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const xo=(e,t,a,n)=>Lo(void 0,null,function*(){var i,s,o,l,r,c,u,g,m,d,f;(i=e.observerLoad)==null||i.disconnect(),preventScroll(e);const b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((b==null?void 0:b.length)>0){const A=[],S=[];let L,$=!1;n==="Backspace"?(L=b[0].previousElementSibling,L||($=!0,L=b[b.length-1].nextElementSibling)):(L=b[b.length-1].nextElementSibling,$=!0,L||($=!1,L=b[0].previousElementSibling));let R,D;hideElements(["select"],e);const M={};for(let P=0;P<b.length;P++){const B=b[P],N=getTopAloneElement(B);D=N.parentElement;const X=N.getAttribute("data-node-id");if(A.push({action:"delete",id:X}),n==="Backspace"?(L=getPreviousBlock(N),L||($=!0,L=getNextBlock(N))):(L=getNextBlock(N),$=!0,L||($=!1,L=getPreviousBlock(N))),!L&&!e.options.backlinkData&&(L=N.parentElement||e.wysiwyg.element.firstElementChild,$=!1),N.getAttribute("data-type")==="NodeHeading"&&N.getAttribute("fold")==="1"){const Y=yield fetchSyncPost("/api/block/getHeadingDeleteTransaction",{id:N.getAttribute("data-node-id")});A.push(...Y.data.doOperations.slice(1));const z=N.previousElementSibling?N.previousElementSibling.getAttribute("data-node-id"):"";Y.data.undoOperations.forEach((se,te)=>{se.previousID=z,te>0&&(se.context={ignoreProcess:"true"})}),S.push(...Y.data.undoOperations),N.firstElementChild.removeAttribute("contenteditable"),N.remove()}else{let Y=N.outerHTML;(N.classList.contains("render-node")||N.querySelector("div.render-node"))&&(Y=e.lute.SpinBlockDOM(N.outerHTML));let z=N.previousElementSibling?N.previousElementSibling.getAttribute("data-node-id"):"";if(N.previousElementSibling&&N.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&N.previousElementSibling.getAttribute("fold")==="1"&&(((s=N.nextElementSibling)==null?void 0:s.getAttribute("data-type"))!=="NodeHeading"||((o=N.nextElementSibling)==null?void 0:o.getAttribute("data-type"))==="NodeHeading"&&((l=N.nextElementSibling)==null?void 0:l.getAttribute("data-subtype"))<N.getAttribute("data-subtype"))){const se=N.previousElementSibling.getAttribute("data-node-id");if(!M[se]){const te=yield fetchSyncPost("/api/block/getHeadingDeleteTransaction",{id:se});M[se]={element:N.previousElementSibling,previousID:te.data.doOperations[te.data.doOperations.length-1].id}}z=M[se].previousID}S.push({action:"insert",data:Y,id:X,previousID:z,parentID:N.parentElement.getAttribute("data-node-id")||e.block.parentID}),N.getAttribute("data-subtype")==="o"&&N.classList.contains("li")?R=N.parentElement:R=void 0,N.remove()}}if(Object.keys(M).forEach(P=>{const B=setFold(e,M[P].element,!0,!1,!1,!0);A.push(...B.doOperations),S.splice(0,0,...B.undoOperations)}),L)if(e.block.showAll&&L.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0)setTimeout(()=>{zoomOut({protyle:e,id:e.block.parent2ID,focusId:e.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else{if(L.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0){const P=Lute.NewNodeID(),B=genEmptyElement(!1,!0,P);L.insertAdjacentElement("afterbegin",B),A.push({action:"insert",data:B.outerHTML,id:P,parentID:L.getAttribute("data-node-id")||e.block.parentID}),S.push({action:"delete",id:P}),L=void 0,focusByWbr(B,a)}n!=="Backspace"&&$?focusBlock(L):focusBlock(L,void 0,!1),scrollCenter(e,L),R&&(S.push({action:"update",id:R.getAttribute("data-node-id"),data:R.outerHTML}),updateListOrder(R,1),A.push({action:"update",id:R.getAttribute("data-node-id"),data:R.outerHTML}))}if(A.length>0)if(D&&D.getAttribute("data-type")==="NodeSuperBlock"&&D.childElementCount===2){const P=yield cancelSB(e,D,a);transaction(e,A.concat(P.doOperations),P.undoOperations.concat(S.reverse()))}else transaction(e,A,S.reverse());hideElements(["util"],e);return}const p=t.getAttribute("data-type");if(p==="NodeCodeBlock"&&getContenteditableElement(t).textContent.trim()===""){t.classList.add("protyle-wysiwyg--select"),xo(e,t,a,n);return}if(!t.previousElementSibling&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){n!=="Delete"&&a.insertNode(document.createElement("wbr"));const A=t.parentElement;A.insertAdjacentElement("beforebegin",t),A.childElementCount===1?(transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(r=t.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:A.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"delete",id:A.getAttribute("data-node-id")}],[{action:"insert",id:A.getAttribute("data-node-id"),data:A.outerHTML,previousID:(c=t.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:A.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"move",id:t.getAttribute("data-node-id"),parentID:A.getAttribute("data-node-id")}]),A.remove()):transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(u=t.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:A.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:t.getAttribute("data-node-id"),parentID:A.getAttribute("data-node-id")}]),n==="Delete"?Ta(t,a,!0):focusByWbr(t,a);return}if(t.parentElement.classList.contains("li")&&t.getAttribute("data-type")!=="NodeHeading"&&t.previousElementSibling.classList.contains("protyle-action")){To(e,t,a,n==="Delete");return}const y=getPreviousBlock(t);if(["NodeCodeBlock","NodeTable","NodeAttributeView"].includes(p)){if(y)if(y.classList.contains("p")&&getContenteditableElement(y).textContent===""){const A=getPreviousBlock(y);transaction(e,[{action:"delete",id:y.getAttribute("data-node-id")}],[{action:"insert",data:y.outerHTML,id:y.getAttribute("data-node-id"),parentID:y.parentElement.getAttribute("data-node-id")||e.block.parentID,previousID:A&&(!y.previousElementSibling||!y.previousElementSibling.classList.contains("protyle-action"))?A.getAttribute("data-node-id"):void 0}]),y.remove()}else focusBlock(y,void 0,!1);return}if(p==="NodeHeading"){t.previousElementSibling&&t.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&t.previousElementSibling.getAttribute("fold")==="1"&&setFold(e,t.previousElementSibling,!0,!1,!1),t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"&&setFold(e,t,!0,!1,!1),turnsIntoTransaction({protyle:e,selectsElement:[t],type:"Blocks2Ps",range:Ta(t,a,n==="Delete")});return}if(t.previousElementSibling&&t.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;if(!y){if(e.wysiwyg.element.childElementCount>1&&getContenteditableElement(t).textContent===""){focusBlock(e.wysiwyg.element.firstElementChild.nextElementSibling);const A=getTopAloneElement(t);transaction(e,[{action:"delete",id:A.getAttribute("data-node-id")}],[{action:"insert",data:A.outerHTML,id:A.getAttribute("data-node-id"),parentID:e.block.parentID}]),A.remove()}return}const _=t.parentElement,k=getContenteditableElement(t),x=getLastBlock(y);if(a.toString()===""&&isMobile()&&x&&x.classList.contains("hr")&&getSelectionOffset(k).start===0){transaction(e,[{action:"delete",id:x.getAttribute("data-node-id")}],[{action:"insert",data:x.outerHTML,id:x.getAttribute("data-node-id"),previousID:(g=x.previousElementSibling)==null?void 0:g.getAttribute("data-node-id"),parentID:x.parentElement.getAttribute("data-node-id")}]),x.remove();return}const T=x&&(x.classList.contains("table")||x.classList.contains("render-node")||x.classList.contains("iframe")||x.classList.contains("hr")||x.classList.contains("av")||x.classList.contains("code-block")),w=x.getAttribute("data-node-id");if(T){if(x.classList.contains("code-block")){if(k.textContent.trim()===""){const A=t.getAttribute("data-node-id"),S=[{action:"delete",id:A}],L=[{action:"insert",data:t.outerHTML,id:A,previousID:(m=t.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")}];if(t.remove(),_.getAttribute("data-type")==="NodeSuperBlock"&&_.childElementCount===2){const $=yield cancelSB(e,_);transaction(e,S.concat($.doOperations),$.undoOperations.concat(L))}else transaction(e,S,L);focusBlock(e.wysiwyg.element.querySelector(`[data-node-id="${w}"]`),void 0,!1)}else focusBlock(x,void 0,!1);return}if(k.textContent!==""||t.classList.contains("av")){focusBlock(x,void 0,!1);return}}const v=getTopEmptyElement(t),h=v.getAttribute("data-node-id");a.insertNode(document.createElement("wbr"));const E=[{action:"update",data:x.outerHTML,id:w},{action:"insert",data:v.outerHTML,id:h,previousID:(d=t.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:_.getAttribute("data-node-id")}],C=[{action:"delete",id:h}];if(T)v.remove(),focusBlock(x,void 0,!1),E.splice(0,1);else{const A=getContenteditableElement(x);if(k&&(k.textContent!==""||k.querySelector(".emoji"))&&(a.setEndAfter(k.lastChild),(((f=A==null?void 0:A.lastElementChild)==null?void 0:f.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const D=hasNextSibling(A==null?void 0:A.lastElementChild);D&&D.textContent===`
`&&D.remove()}if(A){let D=A.lastChild;D&&D.nodeType===3&&(D.textContent||(D=hasPreviousSibling(D)),D&&D.nodeType===3&&D.textContent.endsWith(`
`)&&(D.textContent=D.textContent.slice(0,-1)))}const S=e.contentElement.scrollTop,L=a.extractContents();a.selectNodeContents(A),a.collapse(!1),a.insertNode(L);const $=A.innerHTML.trimStart(),R=A.textContent.trimStart();if(($.startsWith("```")||$.startsWith("\xB7\xB7\xB7")||$.startsWith("~~~")||$.indexOf("\n```")>-1&&R.indexOf("\n```")>-1||$.indexOf(`
~~~`)>-1&&R.indexOf(`
~~~`)>-1||$.indexOf(`
\xB7\xB7\xB7`)>-1&&R.indexOf(`
\xB7\xB7\xB7`)>-1)&&!($.indexOf(`
`)===-1&&$.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let D=A.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");D.endsWith("\n```")||(D+="\n```"),A.innerHTML=D}x.outerHTML=e.lute.SpinBlockDOM(x.outerHTML),mathRender(getPreviousBlock(v)),v.remove(),e.contentElement.scrollTop=S,e.scroll.lastScrollTop=S-1,C.push({action:"update",data:x.outerHTML,id:w})}if(_.getAttribute("data-type")==="NodeSuperBlock"&&_.childElementCount===2){const A=yield cancelSB(e,_);transaction(e,C.concat(A.doOperations),A.undoOperations.concat(E))}else transaction(e,C,E);focusByWbr(e.wysiwyg.element,a)}),Ta=(e,t,a)=>{if(a){const n=getPreviousBlock(e);if(n){const i=getContenteditableElement(getLastBlock(n));if(i)return setLastNodeRange(i,t,!1)}}},Uf=(e,t,a,n)=>{const i=t.outerHTML,s=hasPreviousSibling(e);s&&s.textContent.endsWith(Constants.ZWSP)&&(s.textContent=s.textContent.substring(0,s.textContent.length-1));const o=hasNextSibling(e);o&&o.textContent.startsWith(Constants.ZWSP)&&(o.textContent=o.textContent.replace(Constants.ZWSP,"")),e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,i),focusByWbr(t,a);const l=getContenteditableElement(t);l.innerHTML.trim()===""&&(l.innerHTML="")},To=(e,t,a,n=!1)=>{var i;if(!t.parentElement.previousElementSibling&&t.parentElement.nextElementSibling&&t.parentElement.nextElementSibling.classList.contains("protyle-attr")){listOutdent(e,[t.parentElement],a,n,t);return}if(!t.parentElement.previousElementSibling&&t.parentElement.parentElement.parentElement.classList.contains("list")){a.insertNode(document.createElement("wbr"));const m=t.parentElement.parentElement,d=m.outerHTML,f=t.parentElement.parentElement.previousElementSibling.lastElementChild,b=f.parentElement.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove(),f.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),m.getAttribute("data-subtype")==="o"&&updateListOrder(m),transaction(e,[{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML},{action:"update",data:f.parentElement.outerHTML,id:f.parentElement.getAttribute("data-node-id")}],[{action:"update",data:b,id:f.parentElement.getAttribute("data-node-id")},{action:"update",data:d,id:m.getAttribute("data-node-id")}]),focusByWbr(f.parentElement,a);return}if(!t.parentElement.previousElementSibling){if(t.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;Ta(t,a,n),a.insertNode(document.createElement("wbr"));const m=t.parentElement.parentElement,d=m.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove();const f=document.createElement("div");f.innerHTML=t.parentElement.innerHTML;const b=[],p=[];if(Array.from(f.children).forEach((y,_)=>{var k;b.push({action:"insert",id:y.getAttribute("data-node-id"),data:y.outerHTML,previousID:_===0?(k=m.previousElementSibling)==null?void 0:k.getAttribute("data-node-id"):b[_-1].id,parentID:m.parentElement.getAttribute("data-node-id")||e.block.parentID}),p.push({action:"delete",id:y.getAttribute("data-node-id")})}),m.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),m.getAttribute("data-subtype")==="o"&&updateListOrder(m,parseInt(m.firstElementChild.getAttribute("data-marker"))-1),b.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML}),p.push({action:"update",data:d,id:m.getAttribute("data-node-id")}),transaction(e,b,p),m.parentElement.classList.contains("sb")&&m.parentElement.getAttribute("data-sb-layout")==="col"){const y=[];let _=m;for(;_&&(y.push(_),p[0].id!==_.getAttribute("data-node-id"));)_=_.previousElementSibling;turnsIntoOneTransaction({protyle:e,selectsElement:y.reverse(),type:"BlocksMergeSuperBlock",level:"row"})}focusByWbr(e.wysiwyg.element,a);return}const s=t.parentElement;if(s.previousElementSibling&&s.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const o=s.getAttribute("data-node-id"),l=s.parentElement;Ta(t,a,n),a.insertNode(document.createElement("wbr"));const r=l.outerHTML,c=[],u=[{action:"insert",id:o,data:"",previousID:s.previousElementSibling.getAttribute("data-node-id")}],g=s.previousElementSibling.lastElementChild;if(s.previousElementSibling.getAttribute("fold")==="1")if(getContenteditableElement(t).textContent.trim()===""&&t.nextElementSibling.classList.contains("protyle-attr"))c.push({action:"delete",id:o}),u[0].data=s.outerHTML,setLastNodeRange(getContenteditableElement(s.previousElementSibling),a),a.collapse(!0),s.remove();else{setLastNodeRange(getContenteditableElement(s.previousElementSibling),a),a.collapse(!0),focusByRange(a),(i=t.querySelector("wbr"))==null||i.remove();return}else{let m=g.previousElementSibling.getAttribute("data-node-id");Array.from(t.parentElement.children).forEach((d,f)=>{if(d.classList.contains("protyle-action")||d.classList.contains("protyle-attr"))return;const b=d.getAttribute("data-node-id");c.push({action:"move",id:b,previousID:m}),u.push({action:"move",id:b,previousID:f===1?void 0:m,parentID:o}),m=b,g.before(d)}),c.push({action:"delete",id:o}),u[0].data=s.outerHTML,s.remove()}l.classList.contains("protyle-wysiwyg")?transaction(e,c,u):(l.getAttribute("data-subtype")==="o"&&updateListOrder(l),updateTransaction(e,l.getAttribute("data-node-id"),l.outerHTML,r)),focusByWbr(g.parentElement,a)},ze=(e,t)=>{if(e.getAttribute("data-subtype")!=="o")return;let a;Array.from(e.children).forEach((n,i)=>{i===0?t?(a=t,n.setAttribute("data-marker",a+"."),n.querySelector(".protyle-action--order").textContent=a+"."):a=parseInt(n.getAttribute("data-marker")):n.classList.contains("li")&&(a++,n.setAttribute("data-marker",a+"."),n.querySelector(".protyle-action--order").textContent=a+".")})},Io=(e,t=0,a=!1)=>{const n=document.createElement("template"),i=e.getAttribute("data-subtype");if(i==="o"){const s=parseInt(e.getAttribute("data-marker"))+t;n.innerHTML=`<div data-marker="${s+1}." data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${s+1}.</div>${genEmptyBlock(!1,a)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i==="t"?n.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${genEmptyBlock(!1,a)}<div class="protyle-attr" contenteditable="false"></div></div>`:n.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${genEmptyBlock(!1,a)}<div class="protyle-attr" contenteditable="false"></div></div>`;return n.content.firstElementChild},Ff=(e,t,a)=>{var n;const i=hasClosestByClassName(t,"li");if(!i)return;const s=(n=i.querySelector(".list"))==null?void 0:n.lastElementChild.previousElementSibling;if(!s)return;const o=Io(s,0,!0),l=o.getAttribute("data-node-id");s.after(o),s.parentElement.getAttribute("fold")==="1"&&setFold(e,s.parentElement,!0),i.getAttribute("fold")==="1"&&setFold(e,i,!0),transaction(e,[{action:"insert",id:l,data:o.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:l}]),focusByWbr(o,a)},Yf=(e,t,a)=>{if(t.forEach(s=>{s.removeAttribute("select-start"),s.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const n=t[0].previousElementSibling;if(!n)return;a.collapse(!1),a.insertNode(document.createElement("wbr"));const i=n.parentElement.outerHTML;if(n.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const s=n.lastElementChild.previousElementSibling.outerHTML,o=[],l=[],r=n.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=n.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");t.forEach((u,g)=>{o.push({action:"move",id:u.getAttribute("data-node-id"),previousID:c}),l.push({action:"move",id:u.getAttribute("data-node-id"),previousID:g===0?n.getAttribute("data-node-id"):c}),c=u.getAttribute("data-node-id"),u.setAttribute("data-subtype",r);const m=u.querySelector(".protyle-action");r==="o"?(m.classList.add("protyle-action--order"),m.classList.remove("protyle-action--task"),n.lastElementChild.previousElementSibling.lastElementChild.before(u)):r==="t"?(u.setAttribute("data-marker","*"),m.innerHTML=`<svg><use xlink:href="#icon${u.classList.contains("protyle-task--done")?"Check":"Uncheck"}"></use></svg>`,m.classList.remove("protyle-action--order"),m.classList.add("protyle-action--task"),n.lastElementChild.previousElementSibling.lastElementChild.before(u)):(u.setAttribute("data-marker","*"),m.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',m.classList.remove("protyle-action--order","protyle-action--task"),n.lastElementChild.previousElementSibling.lastElementChild.before(u))}),r==="o"?(ze(n.lastElementChild.previousElementSibling),ze(n.parentElement)):n.getAttribute("data-subtype")==="o"&&ze(n.parentElement),n.parentElement.classList.contains("protyle-wysiwyg")&&(o.push({action:"update",data:n.lastElementChild.previousElementSibling.outerHTML,id:n.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:s,id:n.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),transaction(e,o,l))}else{const s=n.outerHTML,o=t[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",o),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:l.outerHTML,id:r,previousID:n.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];n.lastElementChild.before(l);const u=[];let g;t.forEach((m,d)=>{c.push({action:"move",id:m.getAttribute("data-node-id"),parentID:r,previousID:g}),u.push({action:"move",id:m.getAttribute("data-node-id"),previousID:d===0?n.getAttribute("data-node-id"):g}),g=m.getAttribute("data-node-id"),l.lastElementChild.before(m)}),u.push({action:"delete",id:r}),o==="o"&&(ze(l,1),ze(n.parentElement)),n.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:n.outerHTML,id:n.getAttribute("data-node-id")}),u.push({action:"update",data:s,id:n.getAttribute("data-node-id")}),transaction(e,c,u))}n.parentElement.classList.contains("protyle-wysiwyg")||updateTransaction(e,n.parentElement.getAttribute("data-node-id"),n.parentElement.outerHTML,i),focusByWbr(n,a)},Wf=(e,t,a)=>{var n,i;const s=t.parentElement;if(!s.previousElementSibling){removeBlock(e,t,a,"Backspace");return}const o=s.getAttribute("data-node-id"),l=[],r=[];a.insertNode(document.createElement("wbr"));const c=Lute.NewNodeID();let u="",g=0;Array.from(s.parentElement.children).forEach(d=>{!g&&d===s?g=1:g&&!d.classList.contains("protyle-attr")&&(r.push({id:d.getAttribute("data-node-id"),action:"move",previousID:o}),l.push({id:d.getAttribute("data-node-id"),action:"delete"}),d.getAttribute("data-subtype")==="o"&&(r.push({id:d.getAttribute("data-node-id"),action:"update",data:d.outerHTML}),d.setAttribute("data-marker",g+"."),d.firstElementChild.innerHTML=g+"."),u+=d.outerHTML,d.remove(),g++)}),r.reverse(),u=`<div data-subtype="${s.getAttribute("data-subtype")}" data-node-id="${c}" data-type="NodeList" class="list" updated="${dayjs().format("YYYYMMDDHHmmss")}">${u}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,s.parentElement.insertAdjacentHTML("afterend",u),l.push({id:c,action:"insert",previousID:s.parentElement.getAttribute("data-node-id"),data:u}),r.push({id:c,action:"delete"}),Array.from(s.children).reverse().forEach(d=>{!d.classList.contains("protyle-action")&&!d.classList.contains("protyle-attr")&&(l.push({id:d.getAttribute("data-node-id"),action:"move",previousID:s.parentElement.getAttribute("data-node-id")}),r.push({id:d.getAttribute("data-node-id"),action:"move",parentID:o}),s.parentElement.after(d))});const m=s.parentElement.getAttribute("data-node-id");s.parentElement.childElementCount===2?(r.splice(0,0,{id:m,action:"insert",data:s.parentElement.outerHTML,previousID:(n=s.parentElement.previousElementSibling)==null?void 0:n.getAttribute("data-node-id"),parentID:s.parentElement.parentElement.getAttribute("data-node-id")||e.block.rootID}),s.parentElement.remove(),l.push({id:m,action:"delete"})):(r.splice(0,0,{id:o,action:"insert",data:s.outerHTML,previousID:(i=s.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:m}),s.remove(),l.push({id:o,action:"delete"})),transaction(e,l,r),focusByWbr(e.wysiwyg.element,a)},jf=(e,t,a,n=!1,i)=>{var s,o,l,r,c,u,g,m;if(t.forEach(h=>{h.removeAttribute("select-start"),h.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const d=t[0].parentElement,f=d.getAttribute("data-node-id");if(!f)return;const b=d.parentElement,p=b.parentElement;if((s=d.previousElementSibling)!=null&&s.classList.contains("protyle-action")&&!p.getAttribute("data-node-id"))return;if(b.classList.contains("protyle-wysiwyg")||b.classList.contains("sb")||b.classList.contains("bq")){const h=[],E=[];a.collapse(!1),moveToPrevious(i,a,n),a.insertNode(document.createElement("wbr"));let C;!t[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(C=parseInt(t[0].getAttribute("data-marker")));let A=f,S=d,L=t[t.length-1].nextElementSibling,$=t[t.length-1].lastElementChild.previousElementSibling;if(t.forEach(D=>{Array.from(D.children).forEach((M,P)=>{const B=M.getAttribute("data-node-id");B&&(h.push({action:"move",id:B,previousID:A,parentID:b.getAttribute("data-node-id")||e.block.parentID}),E.push({action:"move",id:B,previousID:P===1?void 0:A,parentID:D.getAttribute("data-node-id"),data:M.contains(a.startContainer)?"focus":""}),A=B,S.after(M),S=M)})}),!window.siyuan.config.editor.listLogicalOutdent&&!L.classList.contains("protyle-attr")){let D;$.getAttribute("data-subtype")!==L.getAttribute("data-subtype")&&(D=Lute.NewNodeID(),$=document.createElement("div"),$.classList.add("list"),$.setAttribute("data-subtype",L.getAttribute("data-subtype")),$.setAttribute("data-node-id",D),$.setAttribute("data-type","NodeList"),$.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),$.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,S.after($),h.push({action:"insert",id:D,data:$.outerHTML,previousID:S.getAttribute("data-node-id")}));let M;for(;L&&!L.classList.contains("protyle-attr");){h.push({action:"move",id:L.getAttribute("data-node-id"),previousID:M||((o=$.lastElementChild.previousElementSibling)==null?void 0:o.getAttribute("data-node-id")),parentID:$.getAttribute("data-node-id")}),E.push({action:"move",id:L.getAttribute("data-node-id"),parentID:$.getAttribute("data-node-id"),previousID:M||((l=L.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"))}),M=L.getAttribute("data-node-id");const P=L;L=L.nextElementSibling,$.lastElementChild.before(P)}$.getAttribute("data-subtype")==="o"&&(Array.from($.children).forEach(P=>{const B=P.getAttribute("data-node-id");B&&E.push({action:"update",id:B,data:P.outerHTML})}),ze($,1),Array.from($.children).forEach(P=>{const B=P.getAttribute("data-node-id");B&&h.push({action:"update",id:B,data:P.outerHTML})})),D&&E.push({action:"delete",id:D})}const R=d.outerHTML;t.forEach(D=>{D.remove()}),d.childElementCount===1?(h.push({action:"delete",id:f}),f===e.block.id&&(e.block.id=e.block.parentID),E.splice(0,0,{action:"insert",data:R,id:f,previousID:(r=d.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:b.getAttribute("data-node-id")||e.block.parentID}),d.remove()):(d.getAttribute("data-subtype")==="o"&&ze(d,C),h.push({action:"update",id:f,data:d.outerHTML}),E.splice(0,0,{action:"update",id:f,data:R})),transaction(e,h,E),d.childElementCount!==1&&b.classList.contains("sb")&&b.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:[d,d.nextElementSibling],type:"BlocksMergeSuperBlock",level:"row"}),focusByWbr(b,a);return}if(d.childElementCount===2&&b.childElementCount===3){a.collapse(!1),moveToPrevious(i,a,n),a.insertNode(document.createElement("wbr"));const h=b.outerHTML;t[0].firstElementChild.remove(),t[0].lastElementChild.remove(),d.outerHTML=t[0].innerHTML,updateTransaction(e,b.getAttribute("data-node-id"),b.outerHTML,h),focusByWbr(b,a);return}a.collapse(!1),moveToPrevious(i,a,n),a.insertNode(document.createElement("wbr"));const y=[],_=[],k=(c=t[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id");let x;!t[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(x=parseInt(t[0].getAttribute("data-marker")));const T=b.parentElement.outerHTML;let w=t[t.length-1].nextElementSibling,v=t[t.length-1].lastElementChild.previousElementSibling;if(t.reverse().forEach(h=>{const E=h.getAttribute("data-node-id");y.push({action:"move",id:E,previousID:b.getAttribute("data-node-id")}),_.push({action:"move",id:E,previousID:k,parentID:d.getAttribute("data-node-id")}),b.after(h),(h.getAttribute("data-subtype")==="o"||h.getAttribute("data-subtype")==="t")&&b.getAttribute("data-subtype")==="u"?(_.push({action:"update",id:E,data:h.outerHTML}),h.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',h.setAttribute("data-subtype","u"),h.setAttribute("data-marker","*"),h.classList.remove("protyle-task--done"),y.push({action:"update",id:E,data:h.outerHTML})):(h.getAttribute("data-subtype")==="u"||h.getAttribute("data-subtype")==="t")&&b.getAttribute("data-subtype")==="o"?(_.push({action:"update",id:E,data:h.outerHTML}),h.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',h.setAttribute("data-subtype","o"),h.setAttribute("data-marker","1."),y.push({action:"update",id:E,data:h.outerHTML})):(h.getAttribute("data-subtype")==="u"||h.getAttribute("data-subtype")==="o")&&b.getAttribute("data-subtype")==="t"&&(_.push({action:"update",id:E,data:h.outerHTML}),h.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',h.setAttribute("data-subtype","t"),h.setAttribute("data-marker","*"),y.push({action:"update",id:E,data:h.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!w.classList.contains("protyle-attr")){let h;v.classList.contains("list")||(h=Lute.NewNodeID(),v=document.createElement("div"),v.classList.add("list"),v.setAttribute("data-subtype",w.getAttribute("data-subtype")),v.setAttribute("data-node-id",h),v.setAttribute("data-type","NodeList"),v.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),v.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,y.push({action:"insert",id:h,data:v.outerHTML,previousID:t[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),t[0].lastElementChild.before(v));let E;for(;w&&!w.classList.contains("protyle-attr");){const C=w.getAttribute("data-node-id");w.getAttribute("data-subtype")!==v.getAttribute("data-subtype")&&(_.push({action:"update",id:C,data:w.outerHTML}),w.querySelector(".protyle-action").outerHTML=v.querySelector(".protyle-action").outerHTML,w.setAttribute("data-subtype",v.getAttribute("data-subtype")),w.setAttribute("data-marker",v.getAttribute("data-marker")),y.push({action:"update",id:C,data:w.outerHTML})),y.push({action:"move",id:C,previousID:E||((u=v.lastElementChild.previousElementSibling)==null?void 0:u.getAttribute("data-node-id")),parentID:v.getAttribute("data-node-id")}),_.push({action:"move",id:C,previousID:E||((g=v.parentElement)==null?void 0:g.getAttribute("data-node-id"))}),E=C;const A=w;w=w.nextElementSibling,v.lastElementChild.before(A)}v.getAttribute("data-subtype")==="o"&&(Array.from(v.children).forEach(C=>{const A=C.getAttribute("data-node-id");A&&_.push({action:"update",id:A,data:C.outerHTML})}),ze(v,1),Array.from(v.children).forEach(C=>{const A=C.getAttribute("data-node-id");A&&y.push({action:"update",id:A,data:C.outerHTML})})),h&&_.push({action:"delete",id:h})}if(!window.siyuan.config.editor.listLogicalOutdent&&d.nextElementSibling){w=d.nextElementSibling;let h;for(;w&&!w.classList.contains("protyle-attr");){const E=w.getAttribute("data-node-id");y.push({action:"move",id:E,previousID:h||v.getAttribute("data-node-id")}),_.push({action:"move",id:E,previousID:h||d.getAttribute("data-node-id")}),h=E;const C=w;w=w.nextElementSibling,v.after(C),v=C}}d.childElementCount===1&&b.childElementCount===3?(y.push({action:"delete",id:b.getAttribute("data-node-id")}),_.splice(0,0,{action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:(m=b.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")}),b.remove()):d.childElementCount===1?(y.push({action:"delete",id:d.getAttribute("data-node-id")}),_.splice(0,0,{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:d.previousElementSibling.getAttribute("data-node-id")}),d.remove()):d.getAttribute("data-subtype")==="o"&&(_.splice(0,0,{action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")}),ze(d,x),y.push({action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")})),p.classList.contains("protyle-wysiwyg")?transaction(e,y,_):(b&&b.getAttribute("data-subtype")==="o"&&ze(p),updateTransaction(e,p.getAttribute("data-node-id"),p.outerHTML,T)),focusByWbr(p,a)};var Do=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Vf=(e,t,a)=>Do(void 0,null,function*(){const n=[],i=[];let s=t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0;t.classList.remove("protyle-wysiwyg--select"),t.removeAttribute("select-start"),t.removeAttribute("select-end");const o=t.getAttribute("data-node-id"),l=t.cloneNode();l.innerHTML=t.lastElementChild.outerHTML;let r=t.parentElement.getAttribute("data-node-id");if(!s&&!r)if(e.block.showAll||e.options.backlinkData){const c=yield fetchSyncPost("/api/block/getBlockSiblingID",{id:o});s=c.data.previous,r=c.data.parent}else r=e.block.rootID;return i.push({action:"insert",id:o,data:l.outerHTML,previousID:s,parentID:r}),Array.from(t.children).forEach((c,u)=>{if(u===t.childElementCount-1){n.push({action:"delete",id:o}),a&&getContenteditableElement(t).insertAdjacentHTML("afterbegin","<wbr>"),t.lastElementChild.remove(),t.querySelectorAll("protyle-html").forEach(g=>{g.setAttribute("data-content",g.getAttribute("data-content").replace(/&lt;/g,"<").replace(/&gt;/g,">"))}),t.outerHTML=t.innerHTML,a&&focusByWbr(e.wysiwyg.element,a);return}n.push({action:"move",id:c.getAttribute("data-node-id"),previousID:s,parentID:r}),i.push({action:"move",id:c.getAttribute("data-node-id"),previousID:c.previousElementSibling?c.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:o}),s=c.getAttribute("data-node-id")}),mathRender(e.wysiwyg.element),n.forEach(c=>{const u=e.wysiwyg.element.querySelector(`[data-node-id="${c.id}"]`);u&&u.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(u.removeAttribute("data-render"),blockRender(e,u))}),{doOperations:n,undoOperations:i,previousId:s}}),Gf=(e,t,a)=>{const n=document.createElement("div");return n.setAttribute("data-node-id",t||Lute.NewNodeID()),n.setAttribute("data-type","NodeSuperBlock"),n.setAttribute("class","sb"),n.setAttribute("data-sb-layout",e),n.innerHTML=a||`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,n},zf=(e,t,a)=>{fetchPost("/api/block/getBlockSiblingID",{id:t.getAttribute("data-node-id")},n=>{const i=n.data[a];i&&openMobileFileById(e.app,i,i!==e.block.rootID&&e.block.showAll?[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS]:[Constants.CB_GET_FOCUS])})},Kf=(e,t,a)=>{var n;const i=getEditorRange(e.wysiwyg.element);let s;if(a)s=e.wysiwyg.element.querySelector(`[data-node-id="${a}"]`);else{const u=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");u.length>0?(t==="beforebegin"?s=u[0]:s=u[u.length-1],hideElements(["select"],e)):(s=hasClosestBlock(i.startContainer),s=getTopAloneElement(s),s.classList.contains("list")?s=hasClosestByClassName(i.startContainer,"li"):s.classList.contains("bq")&&(s=hasClosestBlock(i.startContainer)))}if(!s)return;(n=e.observerLoad)==null||n.disconnect();let o=Nn(!1,!0),l=1;s.getAttribute("data-type")==="NodeListItem"?(o=genListItemElement(s,0,!0),l=parseInt(s.parentElement.firstElementChild.getAttribute("data-marker"))):t==="beforebegin"&&s.previousElementSibling&&s.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&s.previousElementSibling.getAttribute("fold")==="1"?o=zs(s.previousElementSibling,!1,!0):t==="afterend"&&s&&s.getAttribute("data-type")==="NodeHeading"&&s.getAttribute("fold")==="1"&&(o=zs(s,!1,!0));const r=s.parentElement.outerHTML,c=o.getAttribute("data-node-id");if(s.insertAdjacentElement(t,o),s.getAttribute("data-type")==="NodeListItem"&&s.getAttribute("data-subtype")==="o"&&!o.parentElement.classList.contains("protyle-wysiwyg"))updateListOrder(o.parentElement,l),updateTransaction(e,o.parentElement.getAttribute("data-node-id"),o.parentElement.outerHTML,r);else{let u;t==="beforebegin"?u=[{action:"insert",data:o.outerHTML,id:c,nextID:s.getAttribute("data-node-id")}]:u=[{action:"insert",data:o.outerHTML,id:c,previousID:s.getAttribute("data-node-id")}],transaction(e,u,[{action:"delete",id:c}])}s.parentElement.classList.contains("sb")&&s.parentElement.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:t==="afterend"?[s,s.nextElementSibling]:[s.previousElementSibling,s],type:"BlocksMergeSuperBlock",level:"row"}),focusByWbr(e.wysiwyg.element,i),scrollCenter(e)},Zf=(e=!0,t=!0,a)=>{let n="";return e&&(n=Constants.ZWSP),t&&(n+="<wbr>"),a&&(n+=a),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${n}</div><div contenteditable="false" class="protyle-attr">${Constants.ZWSP}</div></div>`},Nn=(e=!0,t=!0,a)=>{const n=document.createElement("div");return n.setAttribute("data-node-id",a||Lute.NewNodeID()),n.setAttribute("data-type","NodeParagraph"),n.classList.add("p"),n.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${e?H.ZWSP:""}${t?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${H.ZWSP}</div>`,n},zs=(e,t=!1,a=!1)=>{const n=`<div data-subtype="${e.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeHeading" class="${e.className}"><div contenteditable="true" spellcheck="false">${a?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`;if(t)return n;{const i=document.createElement("template");return i.innerHTML=n,i.content.firstElementChild}},Xf=e=>{let t=e;switch(e){case"NodeIFrame":t="IFrame";break;case"NodeAttributeView":t=window.siyuan.languages.database;break;case"NodeThematicBreak":t=window.siyuan.languages.line;break;case"NodeWidget":t=window.siyuan.languages.widget;break;case"NodeVideo":t=window.siyuan.languages.video;break;case"NodeAudio":t=window.siyuan.languages.audio;break;case"NodeBlockQueryEmbed":t=window.siyuan.languages.blockEmbed;break}return t},Jf=(e,t,a,n,i)=>{var s;if(t!=="NodeCodeBlock"&&!((s=a.previousElementSibling)!=null&&s.classList.contains("protyle-action--task"))&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(n.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(n.innerHTML.substring(0,2)))){const o=n.innerHTML.indexOf("\u3011")+1;let l=n.innerHTML.indexOf("]")+1;l===0?l=o:l>0&&o>0&&(l=Math.min(l,o)),n.removeAttribute("placeholder");const r=n.innerHTML.substring(1,2).toLowerCase()==="x";if(a.parentElement.classList.contains("li")&&a.parentElement.childElementCount===3){if(!a.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&a.parentElement.parentElement.childElementCount===2){const c=a.parentElement.parentElement,u=c.outerHTML;return c.setAttribute("data-subtype","t"),c.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),a.parentElement.setAttribute("data-subtype","t"),r&&a.parentElement.classList.add("protyle-task--done"),a.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div>`,n.innerHTML=n.innerHTML.substring(l),updateTransaction(e,c.getAttribute("data-node-id"),c.outerHTML,u),focusByWbr(e.wysiwyg.element,i),!0}return!1}else{const c=a.getAttribute("data-node-id"),u=Lute.NewNodeID(),g=Lute.NewNodeID(),m=Lute.NewNodeID(),d=a.outerHTML;return n.innerHTML=n.innerHTML.substring(l),transaction(e,[{action:"update",id:c,data:a.outerHTML},{action:"insert",id:u,data:`<div data-subtype="t" data-node-id="${u}" updated="${u.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${m}" data-type="NodeListItem" class="li${r?" protyle-task--done":""}" updated="${m.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div><div data-node-id="${g}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:c},{action:"move",id:c,previousID:g},{action:"delete",id:g}],[{action:"move",id:c,previousID:u},{action:"delete",id:u},{action:"update",id:c,data:d}]),a.outerHTML=`<div data-subtype="t" data-node-id="${u}" data-type="NodeList" class="list" updated="${u.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${m}" data-type="NodeListItem" class="li${r?" protyle-task--done":""}" updated="${m.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div>${a.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,i),!0}}return!1},Qf=(e,t,a,n,i)=>{if(t==="NodeHeading"&&["* ","- "].includes(n.innerHTML.substring(0,2))&&a.parentElement.getAttribute("data-type")!=="NodeListItem"){const s=a.getAttribute("data-node-id"),o=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),c=a.outerHTML,u=n.innerHTML.substring(0,1);return n.innerHTML=n.innerHTML.substring(2),transaction(e,[{action:"update",id:s,data:a.outerHTML},{action:"insert",id:o,data:`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${u}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:s},{action:"move",id:s,previousID:l},{action:"delete",id:l}],[{action:"update",id:s,data:c},{action:"move",id:s,previousID:o},{action:"delete",id:o}]),a.outerHTML=`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${u}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${a.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,i),!0}return!1};var Mo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const eg=(e,t,a,n=!0,i)=>Mo(void 0,null,function*(){var s,o,l,r,c,u;if(!t.parentElement)return;if(t.classList.contains("av")){const w=hasClosestByClassName(a.startContainer,"av__cursor");w?w.textContent=Constants.ZWSP:updateAVName(e,t);return}const g=getContenteditableElement(t),m=t.getAttribute("data-type");if(!g){m==="NodeThematicBreak"?t.innerHTML="<div><wbr></div>":m==="NodeBlockQueryEmbed"?t.lastElementChild.previousElementSibling.innerHTML="<wbr>"+Constants.ZWSP:m==="NodeMathBlock"||m==="NodeHTMLBlock"?(t.firstElementChild.firstChild.nodeType===3&&t.firstElementChild.firstChild.remove(),t.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+Constants.ZWSP):m==="NodeIFrame"||m==="NodeWidget"?t.innerHTML="<wbr>"+t.firstElementChild.outerHTML+t.lastElementChild.outerHTML:m==="NodeVideo"?t.firstElementChild.innerHTML="<wbr>"+Constants.ZWSP+t.firstElementChild.firstElementChild.outerHTML+t.firstElementChild.lastElementChild.outerHTML:m==="NodeAudio"?t.firstElementChild.innerHTML=t.firstElementChild.firstElementChild.outerHTML+"<wbr>"+Constants.ZWSP:m==="NodeCodeBlock"&&(a.startContainer.textContent=Constants.ZWSP),focusByWbr(t,a);return}t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss"));const d=document.createElement("wbr");if(a.insertNode(d),i){const w=hasNextSibling(d);if(i.inputType==="deleteContentForward"&&w&&w.nodeType===1&&!w.textContent.startsWith(Constants.ZWSP)){const v=(w.getAttribute("data-type")||"").split(" ");(v.includes("code")||v.includes("kbd")||v.includes("tag"))&&w.insertAdjacentElement("afterbegin",d)}if((i.inputType==="deleteContentBackward"||i.inputType==="deleteContentForward")&&w&&w.nodeType===1&&w.tagName==="BR"){const v=hasNextSibling(w);v&&v.nodeType===1&&((s=v.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1&&w.remove(),i.inputType==="deleteContentBackward"&&((o=w.previousSibling.previousSibling)!=null&&o.textContent.endsWith(`
`))&&(w.outerHTML=`
`)}}const f=t.getAttribute("data-node-id");if(m!=="NodeCodeBlock"&&m!=="NodeHeading"&&(g.innerHTML.endsWith(`
<wbr>`)||g.innerHTML.endsWith(`
<wbr>
`))){updateTransaction(e,f,t.outerHTML,e.wysiwyg.lastHTMLs[f]||t.outerHTML.replace(`
<wbr>`,"<wbr>")),d.remove();return}if(turnIntoTaskList(e,m,t,g,a)||headingTurnIntoList(e,m,t,g,a))return;const b=t.querySelector("br");b&&b.parentElement.tagName!=="TD"&&b.parentElement.tagName!=="TH"&&(b.parentElement.textContent.trim()===""||((r=(l=b.previousSibling)==null?void 0:l.previousSibling)==null?void 0:r.textContent)===`
`)&&b.remove(),m!=="NodeHeading"&&(g.innerHTML.startsWith("\u300B<wbr>")||g.innerHTML.startsWith(Constants.ZWSP+"\u300B<wbr>")||g.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(g.innerHTML=g.innerHTML.replace("\u300B<wbr>","><wbr>"));const p=g.innerHTML.trimStart(),y=g.textContent.trimStart();if(!((p.startsWith("````")||p.startsWith("\xB7\xB7\xB7\xB7")||p.startsWith("~~~~"))&&p.indexOf(`
`)===-1)){if((p.startsWith("```")||p.startsWith("\xB7\xB7\xB7")||p.startsWith("~~~"))&&p.indexOf(`
`)===-1&&p.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){updateTransaction(e,f,t.outerHTML,e.wysiwyg.lastHTMLs[f]),d.remove();return}}m==="NodeParagraph"&&(g.innerHTML.startsWith("\xA5\xA5<wbr>")||g.innerHTML.startsWith("\uFFE5\uFFE5<wbr>")||p.indexOf(`
\xA5\xA5<wbr>`)>-1||p.indexOf(`
\uFFE5\uFFE5<wbr>`)>-1)&&(g.innerHTML=g.innerHTML.replace("\xA5\xA5<wbr>","$$$$<wbr>").replace("\uFFE5\uFFE5<wbr>","$$$$<wbr>"));const _=hasClosestByAttribute(a.startContainer,"data-type","block-ref");_&&_.getAttribute("data-subtype")==="d"&&(yield fetchSyncPost("/api/block/getRefText",{id:_.getAttribute("data-id")})).data!==_.innerHTML.replace("<wbr>","")&&_.setAttribute("data-subtype","s");let k=t.outerHTML,x=!1;if(["---","___","***"].includes(g.textContent)&&m!=="NodeCodeBlock"){k=`<div data-node-id="${f}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const w=t.nextElementSibling;w&&w.getAttribute("data-node-id")?isNotEditBlock(w)?x=!0:focusBlock(w):k+=genEmptyBlock(!1,!0)}else{if(m!=="NodeCodeBlock"&&(p.startsWith("```")||p.startsWith("~~~")||p.startsWith("\xB7\xB7\xB7")||p.indexOf("\n```")>-1&&y.indexOf("\n```")>-1||p.indexOf(`
~~~`)>-1&&y.indexOf(`
~~~`)>-1||p.indexOf(`
\xB7\xB7\xB7`)>-1&&y.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(p.indexOf(`
`)===-1&&p.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let w=g.innerHTML.trim().replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();w.endsWith("\n```")||(w=w.replace("<wbr>","")+"<wbr>\n```"),g.innerHTML=w,k=t.outerHTML}k=e.lute.SpinBlockDOM(k)}hideElements(["util"],e,!0),m==="NodeTable"&&t.querySelector(".table__select").removeAttribute("style");const T=document.createElement("template");if(T.innerHTML=k,n&&(((c=getContenteditableElement(T.content.firstElementChild))==null?void 0:c.innerHTML)!==getContenteditableElement(t).innerHTML||T.content.childElementCount===1&&((u=getContenteditableElement(T.content.firstElementChild))==null?void 0:u.innerHTML)==="<wbr>")&&!(T.content.childElementCount===1&&T.content.firstElementChild.classList.contains("code-block")&&m==="NodeCodeBlock")){t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"&&T.content.firstElementChild.getAttribute("data-subtype")!==t.dataset.subtype&&(setFold(e,t,void 0,void 0,!1),k=k.replace(' fold="1"',""),e.wysiwyg.lastHTMLs[f]=t.outerHTML);let w;t.classList.contains("table")&&(w=t.firstElementChild.scrollLeft),/<span data-type="backslash">.+<\/span><wbr>/.test(k)?t.outerHTML=k:t.outerHTML=k.replace("</span><wbr>","</span>"+Constants.ZWSP+"<wbr>"),e.wysiwyg.element.querySelectorAll(`[data-node-id="${f}"]`).forEach(v=>{isInEmbedBlock(v)||(t=v)}),k.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(t.querySelectorAll('[data-type="inline-math"]')).find(v=>{if(v.dataset.content.indexOf("<wbr>")>-1)return v.setAttribute("data-content",v.dataset.content.replace("<wbr>","")),e.toolbar.showRender(e,v),!0}),k="",Array.from(T.content.children).forEach((v,h)=>{const E=v.getAttribute("data-node-id");let C;E===f?C=t:C=e.wysiwyg.element.querySelector(`[data-node-id="${E}"]`);const A=C.getAttribute("data-type");if(A==="NodeCodeBlock"){const S=C.querySelector(".protyle-action__language");S?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&S.textContent===""&&(S.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]),highlightRender(C)):T.content.childElementCount===1&&e.toolbar.showRender(e,C)}else if(["NodeMathBlock","NodeHTMLBlock"].includes(A))A==="NodeMathBlock"&&mathRender(C),e.toolbar.showRender(e,C);else if(A==="NodeBlockQueryEmbed")blockRender(e,C),C.getAttribute("data-content")||e.toolbar.showRender(e,C),hideElements(["hint"],e);else if(A==="NodeThematicBreak"&&x)focusBlock(t);else if(C.querySelectorAll('[data-type~="block-ref"][data-subtype="d"]').forEach(S=>{S.textContent===""&&fetchPost("/api/block/getRefText",{id:S.getAttribute("data-id")},L=>{S.innerHTML=L.data})}),mathRender(C),h===T.content.childElementCount-1){const S=t.querySelector("wbr");if(S&&S.parentElement.tagName==="SPAN"&&S.parentElement.innerHTML==="<wbr>"){const L=S.parentElement.getAttribute("data-type")||"";(L.includes("sup")||L.includes("u")||L.includes("sub"))&&S.insertAdjacentText("beforebegin",Constants.ZWSP)}focusByWbr(e.wysiwyg.element,a),e.hint.render(e),w>0&&(t.firstElementChild.scrollLeft=w)}k+=C.outerHTML})}else t.getAttribute("data-type")==="NodeCodeBlock"?(g.parentElement.removeAttribute("data-render"),highlightRender(t)):(focusByWbr(e.wysiwyg.element,a),e.hint.render(e));hideElements(["gutter"],e),$o(k,e,f)}),$o=(e,t,a)=>{const n=document.createElement("template");n.innerHTML=e;const i=[],s=[];Array.from(n.content.children).forEach((o,l)=>{var r;o.getAttribute("spellcheck")==="false"&&o.getAttribute("contenteditable")==="false"&&o.setAttribute("contenteditable","true");const c=o.getAttribute("data-node-id");if(c===a)i.push({id:a,data:o.outerHTML,action:"update"}),s.push({id:a,data:t.wysiwyg.lastHTMLs[a],action:"update"}),t.wysiwyg.lastHTMLs[a]=o.outerHTML;else{let u;l===0&&(u=t.wysiwyg.element.querySelector(`[data-node-id="${c}"]`)),i.push({action:"insert",data:o.outerHTML,id:c,previousID:l===0?(r=u==null?void 0:u.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):o.previousElementSibling.getAttribute("data-node-id"),parentID:(u==null?void 0:u.parentElement.getAttribute("data-node-id"))||t.block.parentID}),s.push({id:c,action:"delete"})}}),transaction(t,i,s)};var Ho=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const No=(e,t,a,n)=>{const i=document.createElement("template");i.innerHTML=t;let s=[];if(t.endsWith("]")&&t.startsWith("["))try{s=JSON.parse(t)}catch(l){console.warn("insert cell: JSON.parse error")}else i.content.querySelector("table")&&i.content.querySelectorAll("tr").forEach(l=>{s.push([]),Array.from(l.children).forEach(r=>{s[s.length-1].push(r.textContent)})});const o=n.dataset.avId;fetchPost("/api/av/getAttributeViewKeysByAvID",{avID:o},l=>Ho(void 0,null,function*(){var r,c;const u=l.data,g=Array.from(n.querySelectorAll(".av__cell--active, .av__cell--select"))||[];if(s&&Array.isArray(s)&&s.length>0){g.length===0&&n.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(T=>{T.querySelectorAll(".av__cell").forEach(w=>{g.push(w)})}),g.length===0&&g.push(n.querySelector(".av__row:not(.av__row--header) .av__cell"));const p=[],y=[],_=n.dataset.nodeId;let k;const x=g[0].getAttribute("data-col-id");for(let T=0;T<s.length&&(k?k=k.nextElementSibling:k=hasClosestByClassName(g[0].parentElement,"av__row"),!!k.classList.contains("av__row"));T++){let w;for(let v=0;v<s[T].length;v++){const h=s[T][v];if(w?w.nextElementSibling?w=w.nextElementSibling:w.parentElement.classList.contains("av__colsticky")&&(w=w.parentElement.nextElementSibling):w=k.querySelector(`.av__cell[data-col-id="${x}"]`),!w.classList.contains("av__cell"))break;const E=yield updateCellsValue(a,n,h,[w],u,t,!0);E.doOperations.length>0&&(p.push(...E.doOperations),y.push(...E.undoOperations))}}p.length>0&&(p.push({action:"doUpdateUpdated",id:_,data:dayjs().format("YYYYMMDDHHmmss")}),y.push({action:"doUpdateUpdated",id:_,data:n.getAttribute("updated")}),transaction(a,p,y));return}const m=getContenteditableElement(i.content.firstElementChild);if(m&&m.childNodes.length===1&&((r=m.firstElementChild)==null?void 0:r.getAttribute("data-type"))==="block-ref"){const p=n.querySelector(".av__cell--select");if(p){const y=m.firstElementChild.getAttribute("data-id"),_=getFieldIdByCellElement(p,n.getAttribute("data-av-type"));transaction(a,[{action:"replaceAttrViewBlock",avID:o,previousID:_,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:o,previousID:y,nextID:_,isDetached:p.dataset.detached==="true"}]),updateAttrViewCellAnimation(p,{type:"block",isDetached:!1,block:{content:m.firstElementChild.textContent,id:y}});return}}const d=a.lute.BlockDOM2Content(t),f=n.querySelectorAll(".av__row--select"),b=[];if(d.split(`
`).forEach(p=>{b.push(p.split("	"))}),f.length>0&&b.length===1&&b[0].length===1){updateCellsValue(a,n,d,void 0,u,t);return}if(f.length>0&&f.forEach(p=>{p.querySelectorAll(".av__cell").forEach(y=>{g.push(y)})}),g.length>0){if(b.length===1&&b[0].length===1)updateCellsValue(a,n,d,g,u,t);else{let p;const y=[],_=[],k=g[0].getAttribute("data-col-id");for(let x=0;x<b.length&&(p?p=p.nextElementSibling:p=hasClosestByClassName(g[0].parentElement,"av__row"),!!p.classList.contains("av__row"));x++){let T;for(let w=0;w<b[x].length&&(T?T.nextElementSibling?T=T.nextElementSibling:T.parentElement.classList.contains("av__colsticky")&&(T=T.parentElement.nextElementSibling):T=p.querySelector(`.av__cell[data-col-id="${k}"]`),!!T.classList.contains("av__cell"));w++){const v=b[x][w],h=yield updateCellsValue(a,n,v,[T],u,t,!0);h.doOperations.length>0&&(y.push(...h.doOperations),_.push(...h.undoOperations))}}if(y.length>0){const x=n.getAttribute("data-node-id");y.push({action:"doUpdateUpdated",id:x,data:dayjs().format("YYYYMMDDHHmmss")}),_.push({action:"doUpdateUpdated",id:x,data:n.getAttribute("updated")}),transaction(a,y,_)}}(c=document.querySelector(".av__panel"))==null||c.remove()}else if(hasClosestByClassName(e.startContainer,"av__title")){const p=document.createTextNode(d);e.insertNode(p),e.setEnd(p,d.length),e.collapse(!1),focusByRange(e),updateAVName(a,n)}}))},Bo=(e,t,a,n)=>{const i=document.createElement("template");i.innerHTML=t;const s=i.content.querySelectorAll("th, td");if(s.length===0)return!1;const o=n.firstElementChild.scrollLeft,l=n.querySelector("table").scrollTop,r=n.querySelector(".table__select");let c=0;const u=[];n.querySelectorAll("th, td").forEach(m=>{!m.classList.contains("fn__none")&&s.length>c&&isIncludeCell({tableSelectElement:r,scrollLeft:o,scrollTop:l,item:m})&&(u.push(m),c++)}),r.removeAttribute("style");const g=n.outerHTML;return n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),u.forEach((m,d)=>{m.innerHTML=s[d].innerHTML,d===u.length-1&&setLastNodeRange(m,e,!1)}),e.collapse(!1),updateTransaction(a,n.getAttribute("data-node-id"),n.outerHTML,g),!0},tg=(e,t,a=!1,n=!1,i=!1)=>{var s,o,l,r;if(e==="")return;const c=n?t.toolbar.range:getEditorRange(t.wysiwyg.element);fixTableRange(c);let u;hasClosestByAttribute(c.startContainer,"data-type","NodeTable")&&!a&&(hasClosestByTag(c.startContainer,"TABLE")?u=t.lute.BlockDOM2InlineBlockDOM(e):a=!0);let g=hasClosestBlock(c.startContainer);if(g||(t.toolbar.range?g=hasClosestBlock(t.toolbar.range.startContainer):g=t.wysiwyg.element.firstElementChild),!g)return;if(g.classList.contains("av")){c.deleteContents(),No(c,e,t,g);return}if(g.classList.contains("table")&&g.querySelector(".table__select").clientWidth>0&&Bo(c,e,t,g))return;let m=g.getAttribute("data-node-id");c.insertNode(document.createElement("wbr"));let d=g.outerHTML;const f=g.getAttribute("data-type"),b=f==="NodeCodeBlock",p=getContenteditableElement(g);if(!a&&(b||t.toolbar.getCurrentType(c).includes("code"))){c.deleteContents();let A=!1;b&&p.textContent===""&&(A=!0),c.insertNode(document.createTextNode(e.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),c.collapse(!1),c.insertNode(document.createElement("wbr")),A&&(c.collapse(!1),c.insertNode(document.createTextNode(`
`))),b?((s=g.querySelector('[data-render="true"]'))==null||s.removeAttribute("data-render"),highlightRender(g)):focusByWbr(g,c),g.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,m,g.outerHTML,d),setTimeout(()=>{scrollCenter(t,g,!1,"smooth")},Constants.TIMEOUT_LOAD);return}const y=[],_=[];if(c.toString()!==""){const A=hasClosestByAttribute(c.commonAncestorContainer,"data-type","inline-math");A?A.remove():c.startContainer.nodeType===3&&((o=c.startContainer.parentElement.getAttribute("data-type"))==null?void 0:o.indexOf("block-ref"))>-1?(c.deleteContents(),c.startContainer.nodeType!==3&&c.startContainer.textContent===""&&c.startContainer.remove()):c.deleteContents(),c.insertNode(document.createElement("wbr")),y.push({action:"update",id:m,data:d}),_.push({action:"update",id:m,data:g.outerHTML})}const k=document.createElement("template");/^\s*&gt;|\*|-|\+|\d*.|\[ \]|[x]/.test(e)&&p.textContent.replace(Constants.ZWSP,"")!==""&&(u=e);let x=u||e;x=x.replace(/;;;lt;;;/g,"&lt;").replace(/;;;gt;;;/g,"&gt;"),k.innerHTML=x;let T=!1;if((p.textContent.replace(Constants.ZWSP,"")!==""||f==="NodeHeading")&&k.content.childElementCount===1&&k.content.firstChild.nodeType!==3&&k.content.firstElementChild.getAttribute("data-type")==="NodeHeading"&&(a=!1,T=!0),!a&&(k.content.firstChild.nodeType===3||T||k.content.firstChild.nodeType!==3&&(k.content.firstElementChild.classList.contains("p")&&k.content.childElementCount===1||k.content.firstElementChild.tagName!=="DIV"))){k.content.firstChild.nodeType!==3&&k.content.firstElementChild.classList.contains("p")&&(k.innerHTML=k.content.firstElementChild.firstElementChild.innerHTML.trim());const A=c.startContainer.nodeType===3?c.startContainer.parentElement:c.startContainer;if(A.tagName==="SPAN"&&A===(c.endContainer.nodeType===3?c.endContainer.parentElement:c.endContainer)&&k.content.querySelector("span, img")){const S=document.createElement("span"),L=A.attributes;for(let $=0;$<L.length;$++)S.setAttribute(L[$].name,L[$].value);c.setEnd(A.lastChild,A.lastChild.textContent.length),S.append(c.extractContents()),A.after(S),c.setStartBefore(S),c.collapse(!0)}c.insertNode(k.content.cloneNode(!0)),c.collapse(!1),(l=g.querySelector("wbr"))==null||l.remove(),t.wysiwyg.lastHTMLs[m]=d,input(t,g,c);return}const w=hasClosestByClassName(g,"li");if(((r=k.content.children[0])==null?void 0:r.getAttribute("data-type"))==="NodeListItem")if(w)g=w,m=g.getAttribute("data-node-id"),d=g.outerHTML;else{const S=k.content.children[0].getAttribute("data-subtype");k.innerHTML=`<div${S==="o"?' data-marker="1."':""} data-subtype="${S}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${e}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`}let v,h=!1;!c.toString()&&i&&getSelectionOffset(g,t.wysiwyg.element,c).start===0&&p.textContent!==""&&(h=!0),(k.content.firstChild.nodeType===3||k.content.firstChild.nodeType===1&&k.content.firstElementChild.tagName!=="DIV")&&(k.innerHTML=t.lute.SpinBlockDOM(k.innerHTML)),(h?Array.from(k.content.children):Array.from(k.content.children).reverse()).find(A=>{let S=A.getAttribute("data-node-id");const L=A.getAttribute("parent-heading");if(S===m)_.push({action:"update",data:A.outerHTML,id:S}),y.push({action:"update",id:S,data:d});else{if(A.classList.contains("li")&&!g.parentElement.classList.contains("list")){S=Lute.NewNodeID();const $=document.createElement("div");$.setAttribute("data-subtype",A.getAttribute("data-subtype")),$.setAttribute("data-node-id",S),$.setAttribute("data-type","NodeList"),$.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),$.classList.add("list"),$.append(A),A=$}A.removeAttribute("parent-heading"),_.push({action:"insert",data:A.outerHTML,id:S,context:{ignoreProcess:L?"true":"false"},nextID:h?m:void 0,previousID:h?void 0:m}),y.push({action:"delete",id:S})}if(!L){const $=[];A.classList.contains("render-node")&&A.getAttribute("data-type")==="NodeCodeBlock"?$.push(A):$.push(...A.querySelectorAll('.render-node[data-type="NodeCodeBlock"]')),$.forEach(R=>{var D;(D=R.querySelector(".protyle-icons"))==null||D.remove();const M=R.querySelector('[spin="1"]');M&&(M.innerHTML=""),R.removeAttribute("data-render")}),processClonePHElement(A),h?g.before(A):g.after(A)}v||(v=A)}),p&&p.textContent===""&&g.classList.contains("p")&&(_.find((A,S)=>{if(A.id===m)return _.splice(S,1),!0}),_.push({action:"delete",id:m}),y.find((A,S)=>{if(A.id===m&&A.action==="update")return y.splice(S,1),!0}),y.push({action:"insert",data:d,id:m,previousID:g.previousElementSibling?g.previousElementSibling.getAttribute("data-node-id"):"",parentID:g.parentElement.getAttribute("data-node-id")||t.block.parentID}),g.remove()),v&&focusBlock(v,void 0,!1);const E=t.wysiwyg.element.querySelector("wbr");E&&E.remove();let C;g.getAttribute("data-type")==="NodeHeading"&&g.getAttribute("fold")==="1"&&(C=setFold(t,g,!0,!1,!1,!0),_.reverse(),C.doOperations[0].context={focusId:v==null?void 0:v.getAttribute("data-node-id")},_.push(...C.doOperations),y.push(...C.undoOperations)),transaction(t,_,y),t.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(A=>{A.remove()})},Ye=(e,t)=>e?`<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(e)}</span>`:t?`<span class="b3-list-item__meta">${t}</span>`:"",ag=(e,t)=>{const a=[{filter:[window.siyuan.languages.template,"template","\u6A21\u677F","moban","muban","mb"],id:"template",value:Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:[window.siyuan.languages.widget,"widget","\u6302\u4EF6","guajian","gj"],id:"widget",value:Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:[window.siyuan.languages.assets,"assets","\u8D44\u6E90","ziyuan","zy"],id:"assets",value:Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:[window.siyuan.languages.ref,"block reference","\u5757\u5F15\u7528","kuaiyinyong","kyy"],id:"ref",value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:[window.siyuan.languages.blockEmbed,"embed block","\u5D4C\u5165\u5757","qianrukuai","qrk"],id:"blockEmbed",value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:[window.siyuan.languages.aiWriting,"ai writing","ai\u7F16\u5199","aibianxie","aibx","\u4EBA\u5DE5\u667A\u80FD","rengongzhineng","rgzn"],id:"aiWriting",value:Constants.ZWSP+5,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.aiWriting}</span>${Ye(window.siyuan.config.keymap.editor.general.aiWriting.custom,"")}</div>`},{filter:[window.siyuan.languages.database,"database","db","\u6570\u636E\u5E93","shujuku","sjk","\u89C6\u56FE","view"],id:"database",value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`},{filter:[window.siyuan.languages.newFileRef,"create new doc with reference","\u65B0\u5EFA\u6587\u6863\u5E76\u5F15\u7528","xinjianwendangbingyinyong","xjwdbyy"],id:"newFileRef",value:Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFileRef}</span></div>`},{filter:[window.siyuan.languages.newSubDocRef,"create sub doc with reference","\u65B0\u5EFA\u5B50\u6587\u6863\u5E76\u5F15\u7528","xinjianziwendangbingyinyong","xjzwdbyy"],id:"newSubDocRef",value:Constants.ZWSP+6,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newSubDocRef}</span></div>`},{value:"",id:"separator_1",html:"separator"},{filter:[window.siyuan.languages.heading1,"heading1","h1","\u4E00\u7EA7\u6807\u9898","yijibiaoti","yjbt"],id:"heading1",value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span>${Ye(window.siyuan.config.keymap.editor.heading.heading1.custom,"# ")}</div>`},{filter:[window.siyuan.languages.heading2,"heading2","h2","\u4E8C\u7EA7\u6807\u9898","erjibiaoti","ejbt"],id:"heading2",value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span>${Ye(window.siyuan.config.keymap.editor.heading.heading2.custom,"## ")}</div>`},{filter:[window.siyuan.languages.heading3,"heading3","h3","\u4E09\u7EA7\u6807\u9898","sanjibiaoti","sjbt"],id:"heading3",value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span>${Ye(window.siyuan.config.keymap.editor.heading.heading3.custom,"### ")}</div>`},{filter:[window.siyuan.languages.heading4,"heading4","h4","\u56DB\u7EA7\u6807\u9898","sijibiaoti","sjbt"],id:"heading4",value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span>${Ye(window.siyuan.config.keymap.editor.heading.heading4.custom,"#### ")}</div>`},{filter:[window.siyuan.languages.heading5,"heading5","h5","\u4E94\u7EA7\u6807\u9898","wujibiaoti","wjbt"],id:"heading5",value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span>${Ye(window.siyuan.config.keymap.editor.heading.heading5.custom,"##### ")}</div>`},{filter:[window.siyuan.languages.heading6,"heading6","h6","\u516D\u7EA7\u6807\u9898","liujibiaoti","ljbt"],id:"heading6",value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span>${Ye(window.siyuan.config.keymap.editor.heading.heading6.custom,"###### ")}</div>`},{filter:[window.siyuan.languages.list,"unordered list","\u65E0\u5E8F\u5217\u8868","wuxvliebiao","wuxuliebiao","wxlb"],id:"list",value:"- "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span>${Ye(window.siyuan.config.keymap.editor.insert.list.custom,"- ")}</div>`},{filter:[window.siyuan.languages["ordered-list"],"order list","ordered list","\u6709\u5E8F\u5217\u8868","youxvliebiao","youxuliebiao","yxlb"],id:"orderedList",value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span>${Ye(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,"1. ")}</div>`},{filter:[window.siyuan.languages.check,"task list","todo list","\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb"],id:"check",value:"- [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span>${Ye(window.siyuan.config.keymap.editor.insert.check.custom,"[]")}</div>`},{filter:[window.siyuan.languages.quote,"blockquote","bq","\u5F15\u8FF0","yinshu","ys"],id:"quote",value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span>${Ye(window.siyuan.config.keymap.editor.insert.quote.custom,">")}</div>`},{filter:[window.siyuan.languages.code,"code block","\u4EE3\u7801\u5757","daimakuai","dmk"],id:"code",value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span>${Ye(window.siyuan.config.keymap.editor.insert.code.custom,"```"+window.siyuan.languages.enterKey)}</div>`},{filter:[window.siyuan.languages.table,"table","\u8868\u683C","biaoge","bg"],id:"table",value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:[window.siyuan.languages.line,"thematic break","divider","\u5206\u9694\u7EBF","\u5206\u5272\u7EBF","fengexian","fgx"],id:"line",value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:[window.siyuan.languages.math,"formulas block","math block","\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk"],id:"math",value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],id:"html",value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",id:"separator_2",html:"separator"},{filter:[window.siyuan.languages.emoji,"emoji","\u8868\u60C5","biaoqing","bq"],id:"emoji",value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:[window.siyuan.languages.link,"link","a","\u94FE\u63A5","lianjie","lj"],id:"link",value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:[window.siyuan.languages.bold,"bold","strong","\u7C97\u4F53","cuti","ct","\u52A0\u7C97","jiacu","jc"],id:"bold",value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:[window.siyuan.languages.italic,"italic","em","\u659C\u4F53","xieti","xt"],id:"italic",value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:[window.siyuan.languages.underline,"underline","\u4E0B\u5212\u7EBF","xiahuaxian","xhx"],id:"underline",value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:[window.siyuan.languages.strike,"strike","delete","\u5220\u9664\u7EBF","shanchuxian","scx"],id:"strike",value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:[window.siyuan.languages.mark,"mark","\u6807\u8BB0","biaoji","bj","\u9AD8\u4EAE","gaoliang","gl"],id:"mark",value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:[window.siyuan.languages.sup,"superscript","\u4E0A\u6807","shangbiao","sb"],id:"sup",value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:[window.siyuan.languages.sub,"subscript","\u4E0B\u6807","xiaobiao","xb"],id:"sub",value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-code"],"inline code","\u884C\u7EA7\u4EE3\u7801","hangjidaima","hjdm"],id:"inlineCode",value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:[window.siyuan.languages.kbd,"kbd","\u952E\u76D8","jianpan","jp"],id:"kbd",value:"kbd",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.kbd}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.kbd.custom)}</span></div>`},{filter:[window.siyuan.languages.tag,"tags","\u6807\u7B7E","biaoqian","bq"],id:"tag",value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-math"],"inline formulas","inline math","\u884C\u7EA7\u516C\u5F0F","hangjigongshi","hjgs","\u884C\u7EA7\u6570\u5B66\u516C\u5F0F","hangjishuxvegongshi","hangjishuxuegongshi","hjsxgs"],id:"inlineMath",value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",id:"separator_3",html:"separator"},{filter:[window.siyuan.languages.insertAsset,"insert image or file","upload","\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","charutupianhuowenjian","crtphwj","\u4E0A\u4F20","sc"],id:"insertAsset",value:Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${t.options.upload.accept?'multiple="'+t.options.upload.accept+'"':""}></div>`},{filter:[window.siyuan.languages.insertIframeURL,"insert iframe link","\u63D2\u5165 iframe \u94FE\u63A5","charuiframelianjie","criframelj"],id:"insertIframeURL",value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:[window.siyuan.languages.insertImgURL,"insert image link","image","img","\u63D2\u5165\u56FE\u7247\u94FE\u63A5","charutupianlianjie","crtplj"],id:"insertImgURL",value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:[window.siyuan.languages.insertVideoURL,"insert video link","\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj"],id:"insertVideoURL",value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:[window.siyuan.languages.insertAudioURL,"insert audio link","\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj"],id:"insertAudioURL",value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",id:"separator_4",html:"separator"},{filter:[window.siyuan.languages.staff,"staff","\u4E94\u7EBF\u8C31","wuxianpu","wxp"],id:"staff",value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:[window.siyuan.languages.chart,"chart","\u56FE\u8868","tubiao","tb"],id:"chart",value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["flowchart","flow chart","\u6D41\u7A0B\u56FE","liuchengtu","lct"],id:"flowChart",value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["graphviz","\u72B6\u6001\u56FE","zhuangtaitu","ztt"],id:"graph",value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["mermaid","diagram","\u56FE\u8868","tubiao","tb"],id:"mermaid",value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:[window.siyuan.languages.mindmap,"mindmap","\u8111\u56FE","naotu","nt"],id:"mindmap",value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["plantuml","\u5EFA\u6A21\u8BED\u8A00","jianmoyuyan","jmyy"],id:"UML",value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",id:"separator_5",html:"separator"},{filter:[window.siyuan.languages.infoStyle,"info style","\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys"],id:"infoStyle",value:`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:[window.siyuan.languages.successStyle,"success style","\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys"],id:"successStyle",value:`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:[window.siyuan.languages.warningStyle,"warning style","\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys"],id:"warningStyle",value:`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:[window.siyuan.languages.errorStyle,"error style","\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys"],id:"errorStyle",value:`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:[window.siyuan.languages.clearFontStyle,"clear style","\u6E05\u9664\u6837\u5F0F","qingchuyangshi","qcys"],id:"clearFontStyle",value:`style${Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`},{value:"",id:"separator_6",html:"separator"}];let n=!1;return t.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{a.push({filter:s.filter,id:s.id,value:`plugin${Constants.ZWSP}${i.name}${Constants.ZWSP}${s.id}`,html:s.html}),n=!0})}),n||a.pop(),e===""?a:a.filter(i=>i.filter?!!i.filter.find(o=>{if(o.toLowerCase().indexOf(e.toLowerCase())>-1)return!0}):!1)},ng=(e,t)=>(t.hint.genLoading(t),fetchPost("/api/search/searchTag",{k:e},a=>{const n=[];let i=!1;a.data.tags.forEach(s=>{const o=s.replace(/<mark>/g,"").replace(/<\/mark>/g,"");n.push({value:`<span data-type="tag">${o}</span>`,html:`<div class="b3-list-item__text">${s}</div>`}),o===a.data.k&&(i=!0)}),a.data.k&&!i&&(n.splice(0,0,{value:`<span data-type="tag">${a.data.k}</span>`,html:`<div class="b3-list-item__text">${window.siyuan.languages.newTag} <mark>${escapeHtml(a.data.k)}</mark></div>`}),n.length>1&&(n[1].focus=!0)),t.hint.genHTML(n,t,!0,"hint")}),[]),Ks=e=>{let t;e.type==="NodeDocument"&&e.ial.icon?(t=ve(e.ial.icon,"b3-list-item__graphic popover__block",!0),t=t.replace('popover__block"',`popover__block" data-id="${e.id}"`)):t=`<svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${is(e.type)}"></use></svg>`;let a="";e.name&&(a+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${e.name}</span></span><span class="fn__space"></span>`),e.alias&&(a+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${e.alias}</span></span><span class="fn__space"></span>`),e.memo&&(a+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${e.memo}</span></span>`),a&&(a=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${a}</div>`);let n="";return e.refCount&&(n=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${e.refCount}</span>`),`${a}<div class="b3-list-item__first" data-node-id="${e.id}">
    ${t}
    <span class="b3-list-item__text">${e.content}</span>${n}
</div>
<div class="b3-list-item__meta b3-list-item__showall">${e.hPath}</div>`},Po=(e,t,a)=>{const n=G(ut(t.wysiwyg.element).startContainer);return t.hint.genLoading(t),Ce("/api/search/searchRefBlock",{k:e,id:n?n.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:a==="av"?"":t.block.rootID,isDatabase:a==="av",isSquareBrackets:["[[","\u3010\u3010"].includes(t.hint.splitChar)},i=>{const s=[];if(i.data.newDoc){const o=Lute.UnEscapeHTMLStr(hn(i.data.k));s.push({value:`((newFile "${o}"${H.ZWSP}'${o}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach(o=>{let l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="d">${o.name||o.refText.replace(new RegExp(H.ZWSP,"g"),"")}</span>`;if(a==="search")l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${e}${H.ZWSP}${o.name||o.refText.replace(new RegExp(H.ZWSP,"g"),"")}</span>`;else if(a==="av"){let r=o.name||o.refText.replace(new RegExp(H.ZWSP,"g"),"");n&&(r=o.ial["custom-sy-av-s-text-"+n.getAttribute("data-av-id")]||r),l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${r}</span>`}s.push({value:l,html:Ks(o)})}),a==="search"&&(t.hint.splitChar="((",t.hint.lastIndex=-1),s.length===0?s.push({value:"",html:window.siyuan.languages.emptyContent}):i.data.newDoc&&s.length>1&&(s[1].focus=!0),t.hint.genHTML(s,t,!0,a)}),[]},sg=(e,t)=>{if(e.endsWith("}}")||e.endsWith("\u300D\u300D"))return[];t.hint.genLoading(t);const a=hasClosestBlock(getEditorRange(t.wysiwyg.element).startContainer);return fetchPost("/api/search/searchRefBlock",{k:e,isDatabase:!1,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),id:a?a.getAttribute("data-node-id"):t.block.parentID,rootID:t.block.rootID},n=>{const i=[];n.data.blocks.forEach(s=>{i.push({value:`{{select * from blocks where id='${s.id}'}}`,html:Ks(s)})}),i.length===0&&i.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(i,t,!0,"hint")}),[]},ig=(e,t,a)=>{fetchPost("/api/template/render",{id:t.block.parentID,path:e},n=>{focusByRange(t.toolbar.range);const i=getContenteditableElement(a);i&&i.textContent.trim()===""?insertHTML(n.data.content,t,!0):insertHTML(n.data.content,t),t.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(s=>{s.remove()}),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),hideElements(["util"],t)})},lg=(e,t)=>{focusByRange(t.toolbar.range),insertHTML(t.lute.SpinBlockDOM(`<iframe src="/widgets/${e}/" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),t,!0),hideElements(["util"],t)},og=(e,t)=>{focusByRange(t.toolbar.range);const a=pathPosix().extname(e).toLowerCase(),n=e.startsWith("assets/")?getAssetName(e):e;insertHTML(genAssetHTML(a,e,n,e.startsWith("assets/")?n+a:e),t),hideElements(["util"],t)},rg=(e,t,a)=>{if(e==="/")return;const n=getDisplayName(e,!0,!0);if(a.block.rootID===n)return;const i=[];let s;const o=t[0].parentElement;let l;if(t.forEach((r,c)=>{c===t.length-1&&r.parentElement&&(s=getTopAloneElement(r),l=s.nextElementSibling||s.previousElementSibling,s===r&&(s=void 0)),i.push({action:"append",id:r.getAttribute("data-node-id"),parentID:n}),r.remove()}),s)i.push({action:"delete",id:s.getAttribute("data-node-id")}),s.remove();else if(o.classList.contains("list")&&o.getAttribute("data-subtype")==="o"&&o.childElementCount>1)updateListOrder(o,1),Array.from(o.children).forEach(r=>{r.classList.contains("protyle-attr")||i.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(a.block.showAll&&o.classList.contains("protyle-wysiwyg")&&o.childElementCount===0)setTimeout(()=>{zoomOut({protyle:a,id:a.block.parent2ID,focusId:a.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else if(o.classList.contains("protyle-wysiwyg")&&o.innerHTML===""&&!hasClosestByClassName(o,"block__edit",!0)&&a.block.id===a.block.rootID){const r=Lute.NewNodeID(),c=genEmptyElement(!1,!1,r);i.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:a.block.parentID}),o.innerHTML=c.outerHTML,focusBlock(c)}else l&&focusBlock(l);transaction(a,i)};var Ro=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const ye=e=>{e.menu.addItem({iconHTML:"",label:Zs(e.operator,!!e.data),click(){if(!e.data)transaction(e.protyle,[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.operator},blockID:e.blockID}],[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.oldOperator},blockID:e.blockID}]);else{e.target.querySelector(".b3-menu__accelerator").textContent=Zs(e.operator,!0);const t=getFieldsByData(e.data).find(a=>{if(a.id===e.colId)return a.rollup||(a.rollup={}),!0});t.rollup.calc={operator:e.operator},transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:t.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:{operator:e.oldOperator}}}])}}})},cg=(e,t,a,n)=>Ro(void 0,null,function*(){let i,s,o,l,r,c;if(a)l=a.data.id,s=t.dataset.colType,r=t.dataset.calc,o=a.colId,c=a.blockID;else{const d=hasClosestBlock(t);if(!d||(i=hasClosestByClassName(t,"av__row--footer"),!i))return;i.classList.add("av__row--show"),s=t.dataset.dtype,o=t.dataset.colId,l=d.dataset.avId,r=t.dataset.operator,c=d.dataset.nodeId}if(s==="lineNumber")return;const u=new Menu(Constants.MENU_AV_CALC,()=>{i&&i.classList.remove("av__row--show")});if(u.isOpen)return;ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"",data:a==null?void 0:a.data,blockID:c,target:t}),a!=null&&a.data&&s!=="checkbox"&&ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Unique values",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count all",data:a==null?void 0:a.data,blockID:c,target:t}),s!=="checkbox"?(ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count empty",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count not empty",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count values",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count unique values",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent empty",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent not empty",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent unique values",data:a==null?void 0:a.data,blockID:c,target:t})):(ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Checked",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Unchecked",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent checked",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent unchecked",data:a==null?void 0:a.data,blockID:c,target:t}));let g=!1;if(s==="rollup"){let d,f,b=a==null?void 0:a.data;if(b||(b=(yield fetchSyncPost("api/av/renderAttributeView",{id:l})).data),getFieldsByData(b).find(p=>{var y,_;if(p.id===o)return d=(y=p.rollup)==null?void 0:y.relationKeyID,f=(_=p.rollup)==null?void 0:_.keyID,!0}),d&&f){let p;getFieldsByData(b).find(y=>{var _;if(y.id===d)return p=(_=y.relation)==null?void 0:_.avID,!0}),p&&(yield fetchSyncPost("api/av/getAttributeView",{id:p})).data.av.keyValues.find(_=>{if(_.key.id===f)return g=_.key.type==="number",!0})}}["number","template"].includes(s)||g?(ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Sum",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Average",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Median",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Min",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Max",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Range",data:a==null?void 0:a.data,blockID:c,target:t})):["date","created","updated"].includes(s)&&(ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Earliest",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Latest",data:a==null?void 0:a.data,blockID:c,target:t}),ye({menu:u,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Range",data:a==null?void 0:a.data,blockID:c,target:t}));const m=t.getBoundingClientRect();u.open({x:Math.max(n||0,m.left),y:m.bottom,h:m.height})}),Oo=e=>{if(!e.calc||!e.calc.result)return"";let t=e.calc.result.number;(e.calc.operator==="Earliest"||e.calc.operator==="Latest"||e.calc.operator==="Range"&&["date","created","updated"].includes(e.type))&&(t=e.calc.result[e.type]);let a="";switch(e.calc.operator){case"Count all":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountAll}</small>`;break;case"Count values":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountValues}</small>`;break;case"Count unique values":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountUniqueValues}</small>`;break;case"Count empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountEmpty}</small>`;break;case"Count not empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountNotEmpty}</small>`;break;case"Percent empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentEmpty}</small>`;break;case"Percent not empty":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentNotEmpty}</small>`;break;case"Percent unique values":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentUniqueValues}</small>`;break;case"Sum":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultSum}</small>`;break;case"Average":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultAverage}</small>`;break;case"Median":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMedian}</small>`;break;case"Min":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMin}</small>`;break;case"Max":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMax}</small>`;break;case"Range":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultRange}</small>`;break;case"Earliest":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorEarliest}</small>`;break;case"Latest":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorLatest}</small>`;break;case"Checked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.checked}</small>`;break;case"Unchecked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.unchecked}</small>`;break;case"Percent checked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentChecked}</small>`;break;case"Percent unchecked":a=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentUnchecked}</small>`;break}return a},Zs=(e,t)=>{switch(e){case void 0:case"":return t?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Unique values":return window.siyuan.languages.uniqueValues;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Percent unique values":return window.siyuan.languages.calcOperatorPercentUniqueValues;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}};var qo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const dg=(e,t)=>{var a,n,i,s,o;if(isOnlyMeta(t))return!1;const l=hasClosestBlock(t.target);if(!l)return!1;const r=l.getAttribute("data-av-type");let c=t.target;for(;c&&!c.isEqualNode(l);){const u=c.getAttribute("data-type");if(u==="av-header-add"&&!e.disabled){const g=addCol(e,l),m=c.getBoundingClientRect();return g.open({x:m.left,y:m.bottom,h:m.height}),t.preventDefault(),t.stopPropagation(),!0}else{if(u==="av-header-more"&&!e.disabled)return openMenuPanel({protyle:e,blockElement:l,type:"properties"}),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-add-more"&&!e.disabled)return insertRows({blockElement:l,protyle:e,count:1,previousID:"",groupID:((a=l.querySelector(".av__body"))==null?void 0:a.getAttribute("data-group-id"))||""}),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-more"&&!e.disabled)return openMenuPanel({protyle:e,blockElement:l,type:"config"}),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-switcher"&&!e.disabled)return openMenuPanel({protyle:e,blockElement:l,type:"switcher"}),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-sort"&&!e.disabled)return openMenuPanel({protyle:e,blockElement:l,type:"sorts"}),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-filter"&&!e.disabled)return openMenuPanel({protyle:e,blockElement:l,type:"filters"}),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-add"&&!e.disabled)return addView(e,l),t.preventDefault(),t.stopPropagation(),!0;if(u==="block-more"&&!e.disabled)return window.siyuan.menus.menu.remove(),e.toolbar.range=document.createRange(),e.toolbar.range.selectNodeContents(c),focusByRange(e.toolbar.range),r==="table"&&(c.parentElement.classList.add("av__cell--select"),addDragFill(c.parentElement)),hintRef(c.previousElementSibling.textContent.trim(),e,"av"),t.preventDefault(),t.stopPropagation(),!0;if(u==="set-page-size"&&!e.disabled)return setPageSize({target:c,protyle:e,avID:l.getAttribute("data-av-id"),nodeElement:l}),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-add-bottom"&&!e.disabled){const g=hasClosestByClassName(c,"av__body");return insertRows({blockElement:l,protyle:e,count:1,previousID:g&&((i=(n=g.querySelector(".av__row--util"))==null?void 0:n.previousElementSibling)==null?void 0:i.getAttribute("data-id"))||((s=c.previousElementSibling)==null?void 0:s.getAttribute("data-id"))||void 0,groupID:g?g.getAttribute("data-group-id"):""}),t.preventDefault(),t.stopPropagation(),!0}else if(u==="av-add-top"&&!e.disabled){const g=hasClosestByClassName(c,"av__group-title");return insertRows({blockElement:l,protyle:e,count:1,previousID:"",groupID:g?g.nextElementSibling.getAttribute("data-group-id"):""}),t.preventDefault(),t.stopPropagation(),!0}else{if(c.classList.contains("av__cell--header")&&!e.disabled)return showColMenu(e,l,c),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("av__cell")&&!e.disabled){if(!hasClosestByClassName(c,"av__row--header")){if(c.querySelector(".av__pulse"))return;const g=getTypeByCellElement(c);if(r==="gallery")hasClosestByClassName(c,"av__gallery-item")&&g!=="updated"&&g!=="created"&&g!=="lineNumber"&&popTextCell(e,[c]);else{const m=hasClosestByClassName(c,"av__scroll");if(!m)return;const d=hasClosestByClassName(c,"av__row");if(!d)return;g==="updated"||g==="created"||g==="lineNumber"?selectRow(d.querySelector(".av__firstcol"),"toggle"):(m.querySelectorAll(".av__row--select").forEach(f=>{f.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),f.classList.remove("av__row--select")}),updateHeader(d),popTextCell(e,[c]))}}return t.preventDefault(),t.stopPropagation(),!0}else{if(c.classList.contains("av__calc")&&!e.disabled)return openCalcMenu(e,c,void 0,t.clientX-64),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("b3-menu__avemoji")&&!e.disabled){const g=c.getBoundingClientRect();return openEmojiPanel(c.nextElementSibling.getAttribute("data-id"),"doc",{x:g.left,y:g.bottom,h:g.height,w:g.width},m=>{c.innerHTML=unicode2Emoji(m||window.siyuan.storage[Constants.LOCAL_IMAGES].file)},c.querySelector("img")),t.preventDefault(),t.stopPropagation(),!0}else{if(u==="av-gallery-edit"&&!e.disabled)return editGalleryItem(c),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-gallery-more"&&!e.disabled){const g=c.getBoundingClientRect();return openGalleryItemMenu({target:c,protyle:e,position:{x:g.left,y:g.bottom}}),t.preventDefault(),t.stopPropagation(),!0}else if(u==="av-group-fold"){if(c.getAttribute("data-folding")!=="true"){c.setAttribute("data-folding","true");const g=c.firstElementChild.classList.contains("av__group-arrow--open");transaction(e,[{action:"foldAttrViewGroup",avID:l.dataset.avId,blockID:l.dataset.nodeId,id:c.dataset.id,data:g}],[{action:"foldAttrViewGroup",avID:l.dataset.avId,blockID:l.dataset.nodeId,id:c.dataset.id,data:!g}]),g?(c.firstElementChild.classList.remove("av__group-arrow--open"),c.parentElement.nextElementSibling.classList.add("fn__none")):(c.firstElementChild.classList.add("av__group-arrow--open"),c.parentElement.nextElementSibling.classList.remove("fn__none"))}return t.preventDefault(),t.stopPropagation(),!0}else if(u==="av-load-more"){l.querySelectorAll(".av__row--footer").forEach(m=>{m.style.transform=""}),l.removeAttribute("data-render");const g=hasClosestByClassName(c,"av__body");return g.dataset.pageSize=(parseInt(g.dataset.pageSize)+parseInt(g.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),avRender(l,e),t.preventDefault(),t.stopPropagation(),!0}else{if(c.classList.contains("av__firstcol"))return window.siyuan.menus.menu.remove(),selectRow(c,"toggle"),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("item")&&c.parentElement.classList.contains("layout-tab-bar"))return c.classList.contains("item--focus")?openViewMenu({protyle:e,blockElement:l,element:c}):transaction(e,[{action:"setAttrViewBlockView",blockID:l.getAttribute("data-node-id"),id:c.dataset.id,avID:l.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:l.getAttribute("data-node-id"),id:c.parentElement.querySelector(".item--focus").getAttribute("data-id"),avID:l.getAttribute("data-av-id")}]),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("av__cellassetimg"))return previewAttrViewImages(removeCompressURL(c.getAttribute("src")),l.getAttribute("data-av-id"),l.getAttribute(Constants.CUSTOM_SY_AV_VIEW),((o=l.querySelector('[data-type="av-search"]'))==null?void 0:o.value.trim())||""),t.preventDefault(),t.stopPropagation(),!0;if(c.classList.contains("av__row")&&t.shiftKey&&!c.classList.contains("av__row--header"))return selectRow(c.querySelector(".av__firstcol"),"toggle"),t.preventDefault(),t.stopPropagation(),!0;if(u==="copy")return writeText(getCellText(hasClosestByClassName(c,"av__cell"))),showMessage(window.siyuan.languages.copied),t.preventDefault(),t.stopPropagation(),!0;if(u==="av-search-icon"){const g=l.querySelector('input[data-type="av-search"]');g.style.width="128px",g.style.paddingLeft="",g.style.paddingRight="";const m=hasClosestByClassName(g,"av__views");return m&&m.classList.add("av__views--show"),setTimeout(()=>{g.focus()},Constants.TIMEOUT_TRANSITION),t.preventDefault(),t.stopPropagation(),!0}}}}}}c=c.parentElement}return!1},ug=(e,t,a)=>{var n;if(hideElements(["hint"],e),t.classList.contains("av__row--header"))return!1;const i=hasClosestBlock(t);if(!i)return!1;const s=i.getAttribute("data-av-type");s==="table"?(t.classList.contains("av__row--select")||clearSelect(["row"],i),clearSelect(["cell"],i),t.classList.add("av__row--select"),t.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),updateHeader(t)):(t.classList.contains("av__gallery-item--select")||clearSelect(["galleryItem"],i),t.classList.add("av__gallery-item--select"));const o=new Menu,l=i.querySelectorAll(".av__row--select:not(.av__row--header), .av__gallery-item--select"),r=l[0].querySelector('.av__cell[data-dtype="block"]'),c=Array.from(l).map(m=>m.querySelector('[data-dtype="block"] .av__celltext').getAttribute("data-id"));l.length===1&&r.getAttribute("data-detached");let u=!1;l.forEach(m=>{m.querySelector('.av__cell[data-dtype="block"]').getAttribute("data-detached")!=="true"&&(u=!0)});const g=[{id:"copyKeyContent",iconHTML:"",label:window.siyuan.languages.copyKeyContent,click(){let m="";l.forEach((d,f)=>{l.length>1&&(m+="- "),m+=d.querySelector('.av__cell[data-dtype="block"] .av__celltext').textContent.trim(),c.length>1&&f!==c.length-1&&(m+=`
`)}),writeText(m)}}];if(u&&g.splice(1,0,{id:"copyBlockRef",iconHTML:"",label:window.siyuan.languages.copyBlockRef,click:()=>{let m="";for(let d=0;d<c.length;d++){const f=c[d];let b="";const p=l[d].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?b=p.querySelector(".av__celltext").textContent:b=`((${f} '${p.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}'))`,c.length>1&&(m+="- "),m+=b,c.length>1&&d!==c.length-1&&(m+=`
`)}writeText(m)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,click:()=>{let m="";c.forEach((d,f)=>{c.length>1&&(m+="- ");const b=l[f].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?m+=b.querySelector(".av__celltext").textContent:m+=`{{select * from blocks where id='${d}'}}`,c.length>1&&f!==c.length-1&&(m+=`
`)}),writeText(m)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,click:()=>{let m="";c.forEach((d,f)=>{c.length>1&&(m+="- ");const b=l[f].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?m+=b.querySelector(".av__celltext").textContent:m+=`siyuan://blocks/${d}`,c.length>1&&f!==c.length-1&&(m+=`
`)}),writeText(m)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,click:()=>{let m="";for(let d=0;d<c.length;d++){const f=c[d];let b="";const p=l[d].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?b=p.querySelector(".av__celltext").textContent:b=`[${p.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}](siyuan://blocks/${f})`,c.length>1&&(m+="- "),m+=b,c.length>1&&d!==c.length-1&&(m+=`
`)}writeText(m)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,click:()=>qo(void 0,null,function*(){let m="";for(let d=0;d<c.length;d++){const f=c[d];let b="";const p=l[d].querySelector(".av__cell[data-dtype='block']");p.getAttribute("data-detached")==="true"?b=p.querySelector(".av__celltext").textContent:b=(yield fetchSyncPost("/api/filetree/getHPathByID",{id:f})).data,c.length>1&&(m+="- "),m+=b,c.length>1&&d!==c.length-1&&(m+=`
`)}writeText(m)})},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,click:()=>{let m="";c.forEach((d,f)=>{c.length>1&&(m+="- ");const b=l[f].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?m+=b.querySelector(".av__celltext").textContent:m+=d,c.length>1&&f!==c.length-1&&(m+=`
`)}),writeText(m)}}),o.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:g}),!e.disabled){o.addItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,icon:"iconDatabase",click(){openSearchAV(i.getAttribute("data-av-id"),l[0],d=>{const f=[],b=[];l.forEach(_=>{const k=_.getAttribute("data-id"),x=genCellValueByElement("block",_.querySelector('.av__cell[data-dtype="block"]'));f.push({itemID:Lute.NewNodeID(),content:x.block.content,id:x.block.id||"",isDetached:x.isDetached}),b.push(k)});const p=d.dataset.avId,y=d.dataset.viewId;transaction(e,[{action:"insertAttrViewBlock",ignoreDefaultFill:!y,viewID:y,avID:p,srcs:f,context:{ignoreTip:"true"},blockID:d.dataset.blockId,groupID:t.parentElement.getAttribute("data-group-id")},{action:"doUpdateUpdated",id:d.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:b,avID:p}])})}}),l.length===1&&(r.getAttribute("data-detached")!=="true"&&o.addSeparator({id:"separator_1"}),o.addItem({id:s==="table"?"insertRowBefore":"insertItemBefore",icon:"iconBefore",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages[s==="table"?"insertRowBefore":"insertItemBefore"].replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" value="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field"><span class="fn__space"></span>`)}
</div>`,bind(d){const f=d.querySelector("input");d.addEventListener("click",()=>{document.activeElement!==f&&(insertRows({blockElement:i,protyle:e,count:parseInt(f.value),previousID:l[0].previousElementSibling.getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())}),f.addEventListener("keydown",b=>{!b.isComposing&&b.key==="Enter"&&(insertRows({blockElement:i,protyle:e,count:parseInt(f.value),previousID:l[0].previousElementSibling.getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())})}}),o.addItem({id:s==="table"?"insertRowAfter":"insertItemAfter",icon:"iconAfter",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages[s==="table"?"insertRowAfter":"insertItemAfter"].replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field" value="1"><span class="fn__space"></span>`)}
</div>`,bind(d){const f=d.querySelector("input");d.addEventListener("click",()=>{document.activeElement!==f&&(insertRows({blockElement:i,protyle:e,count:parseInt(f.value),previousID:l[0].getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())}),f.addEventListener("keydown",b=>{!b.isComposing&&b.key==="Enter"&&(insertRows({blockElement:i,protyle:e,count:parseInt(f.value),previousID:l[0].getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())})}}),o.addSeparator({id:"separator_2"}),r.getAttribute("data-detached")!=="true"&&o.addItem({id:"unbindBlock",label:window.siyuan.languages.unbindBlock,icon:"iconLinkOff",click(){updateCellsValue(e,i,{content:r.querySelector(".av__celltext").textContent},[r])}})),o.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){deleteRow(i,e)}});const m=[];s==="table"?t.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(d=>{const f=Array.from(i.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${d.dataset.colId}"]`)),b=d.getAttribute("data-dtype");if(!["updated","created"].includes(b)){const p=d.dataset.icon;m.push({iconHTML:p?unicode2Emoji(p,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(b)}"></use></svg>`,label:escapeHtml(d.querySelector(".av__celltext").textContent.trim()),click(){popTextCell(e,f)}})}}):t.querySelectorAll(".av__cell").forEach(d=>{const f=Array.from(i.querySelectorAll(`.av__gallery-item--select .av__cell[data-field-id="${d.dataset.fieldId}"]`)),b=d.getAttribute("data-dtype");if(!["updated","created"].includes(b)){const p=d.parentElement.querySelector(".av__gallery-tip, .av__gallery-name").firstElementChild.cloneNode(!0);p.classList.add("b3-menu__icon"),m.push({iconHTML:p.outerHTML,label:escapeHtml(d.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]),click(){t.querySelector(".av__gallery-fields").classList.add("av__gallery-fields--edit"),t.querySelector('[data-type="av-gallery-edit"]').setAttribute("aria-label",window.siyuan.languages.hideEmptyFields),popTextCell(e,f)}})}}),o.addItem({id:"fields",icon:"iconAttr",label:window.siyuan.languages.fields,type:"submenu",submenu:m})}return(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-av",detail:{protyle:e,element:i,selectRowElements:l},separatorPosition:"top"}),o.open(a),!0},fg=(e,t)=>{const a=t.getAttribute("data-av-id"),n=t.getAttribute("data-node-id"),i=t.querySelector(".av__title");i.textContent===""&&i.querySelectorAll("br").forEach(l=>{l.remove()});const s=i.textContent.trim();if(s===i.dataset.title.trim())return;if(s.length>Constants.SIZE_TITLE)return showMessage(window.siyuan.languages._kernel[106]),!1;const o=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"setAttrViewName",id:a,data:s},{action:"doUpdateUpdated",id:n,data:o}],[{action:"setAttrViewName",id:a,data:i.dataset.title},{action:"doUpdateUpdated",id:n,data:t.getAttribute("updated")}]),t.setAttribute("updated",o),i.dataset.title=s,Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${a}"]`)).forEach(l=>{if(t===l)return;const r=l.querySelector(".av__title");r&&(r.textContent=s,r.dataset.title=s)})},gg=(e,t,a)=>{var n;if(e)if(a)updateHeaderCell(e,a);else{const i=e.querySelector(".av__drag-fill"),s=hasClosestBlock(e);if(!s)return;const o=s.getAttribute("data-av-type"),l=e.querySelector(".b3-menu__avemoji");o==="gallery"?(t.type==="checkbox"&&(t.checkbox={checked:((n=t.checkbox)==null?void 0:n.checked)||!1,content:e.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]}),e.innerHTML=renderCell(t,0,l?!l.classList.contains("fn__none"):!1,o),e.parentElement.setAttribute("data-empty",cellValueIsEmpty(t).toString())):e.innerHTML=renderCell(t,0,l?!l.classList.contains("fn__none"):!1),i&&addDragFill(e),renderCellAttr(e,t)}},mg=(e,t)=>{e.querySelectorAll(`.av__cell[data-col-id="${t}"]`).forEach(a=>{a.remove()})},pg=(e,t)=>{fetchPost("/api/av/duplicateAttributeViewBlock",{avID:t.getAttribute("data-av-id")},a=>{t.classList.remove("protyle-wysiwyg--select");const n=document.createElement("template");n.innerHTML=e.lute.SpinBlockDOM(`<div data-node-id="${a.data.blockID}" data-av-id="${a.data.avID}" data-type="NodeAttributeView" data-av-type="table"></div>`);const i=n.content.firstElementChild;t.after(i),avRender(i,e,()=>{focusBlock(i),scrollCenter(e)}),transaction(e,[{action:"insert",data:i.outerHTML,id:a.data.blockID,previousID:t.dataset.nodeId}],[{action:"delete",id:a.data.blockID}])})};let Ne;const Bn=(e,t,a=[])=>{var n;let i="",s=!1;if(a.length===0&&document.querySelectorAll(".av__panel .b3-chips .b3-chip").forEach(o=>{a.push(o.dataset.content)}),t){const o=((n=document.querySelector(".av__panel .b3-menu__item--current"))==null?void 0:n.getAttribute("data-name"))||"";t.forEach(l=>{if(!e||e.toLowerCase().indexOf(l.name.toLowerCase())>-1||l.name.toLowerCase().indexOf(e.toLowerCase())>-1){const r=l.desc?`${escapeAriaLabel(l.name)}<div class='ft__on-surface'>${escapeAriaLabel(l.desc||"")}</div>`:"";i+=`<button data-type="addColOptionOrCell" class="b3-menu__item${o===l.name?" b3-menu__item--current":""}" data-name="${escapeAttr(l.name)}" data-desc="${escapeAttr(l.desc||"")}" draggable="true" data-color="${l.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${r}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})">
            <span class="fn__ellipsis">${escapeHtml(l.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
    ${a.includes(l.name)?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`}e===l.name&&(s=!0)})}if(!s&&e){i=i.replace('class="b3-menu__item b3-menu__item--current"','class="b3-menu__item"');const o=((t==null?void 0:t.length)||0)%14+1;i=`<button data-type="addColOptionOrCell" class="b3-menu__item b3-menu__item--current" data-name="${e}" data-color="${o}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${o});color:var(--b3-font-color${o})">
        <span class="fn__ellipsis">${escapeHtml(e)}</span>
    </span>
</div>
<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${window.siyuan.languages.enterKey}</span>
</button>${i}`}else i.indexOf("b3-menu__item--current")===-1&&(i=i.replace('class="b3-menu__item"','class="b3-menu__item b3-menu__item--current"'));return i},Xs=(e,t,a,n)=>{if(!a)return;const i=n.getAttribute("data-av-type"),s=getColId(t[0],i),o=[],l=[];let r;const c=n.getAttribute("data-av-id");t.forEach((u,g)=>{var m;const d=getFieldIdByCellElement(u,i);if(!d)return;n.contains(u)||(i==="table"?u=t[g]=n.querySelector(`.av__row[data-id="${d}"] .av__cell[data-col-id="${u.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${u.dataset.colId}"]`):u=t[g]=n.querySelector(`.av__gallery-item[data-id="${d}"] .av__cell[data-field-id="${u.dataset.fieldId}"]`));const f=Ne[g],b=JSON.parse(JSON.stringify(f));g===0?((m=f.mSelect)==null||m.find((p,y)=>{if(p.content===a.dataset.content)return f.mSelect.splice(y,1),!0}),r=f.mSelect):f.mSelect=r,o.push({action:"updateAttrViewCell",id:f.id,keyID:s,rowID:d,avID:c,data:f}),l.push({action:"updateAttrViewCell",id:f.id,keyID:s,rowID:d,avID:c,data:b}),u.classList.contains("custom-attr__avvalue")?u.innerHTML=genAVValueHTML(f):updateAttrViewCellAnimation(u,f)}),o.push({action:"doUpdateUpdated",id:n.getAttribute("data-node-id"),data:dayjs().format("YYYYMMDDHHmmss")}),transaction(e,o,l),Array.from(document.querySelectorAll(".av__panel .b3-menu__item")).find(u=>{var g;if(u.dataset.name===a.dataset.content)return(g=u.querySelector(".b3-menu__checked"))==null||g.remove(),!0}),a.remove()},bg=(e,t,a,n,i,s)=>{const o=hasClosestByClassName(a,"b3-menu");if(!o)return;const l=n.getAttribute("data-node-id"),r=n.getAttribute("data-av-type"),c=s&&s[0]?getColId(s[0],r):o.querySelector(".b3-menu__item").getAttribute("data-col-id");let u=a.parentElement.dataset.name,g=a.parentElement.dataset.desc,m=a.parentElement.dataset.color;const d=getFieldsByData(t),f=new Menu(Constants.MENU_AV_COL_OPTION,()=>{if(u===y.value&&g===_.value||!y.value)return;transaction(e,[{action:"updateAttrViewColOption",id:c,avID:t.id,data:{newColor:m,oldName:u,newName:y.value,newDesc:_.value}},{action:"doUpdateUpdated",id:l,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOption",id:c,avID:t.id,data:{newColor:m,oldName:y.value,newName:u,newDesc:g}}]),d.find(w=>{if(w.id===c)return w.options.find(h=>{if(h.name===y.value&&h.desc===_.value)return!0})||w.options.find(h=>{if(h.name===u)return h.name=y.value,h.desc=_.value,!0}),!0});const k=o.querySelector(".b3-menu__items").scrollTop,x=o.querySelector(".b3-chips"),T=x?x.clientHeight:0;s?(s.forEach((w,v)=>{const h=getFieldIdByCellElement(w,r);r==="table"||i?w=s[v]=n.querySelector(`.av__row[data-id="${h}"] .av__cell[data-col-id="${w.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${w.dataset.colId}"]`):w=s[v]=n.querySelector(`.av__gallery-item[data-id="${h}"] .av__cell[data-field-id="${w.dataset.fieldId}"]`),Ne[v].mSelect.find(E=>{if(E.content===u)return E.content=y.value,!0}),w.classList.contains("custom-attr__avvalue")?w.innerHTML=genAVValueHTML(Ne[v]):updateAttrViewCellAnimation(w,Ne[v])}),o.innerHTML=Da(d,s,!1,n),Ia(e,t,o,s,n)):(o.innerHTML=getEditHTML({protyle:e,data:t,colId:c,isCustomAttr:i}),bindEditEvent({protyle:e,data:t,menuElement:o,isCustomAttr:i,blockID:l})),x&&(o.querySelector(".b3-menu__items").scrollTop=k+(o.querySelector(".b3-chips").clientHeight-T))});if(f.isOpen)return;f.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div>
<div class="b3-form__icona fn__block">
    <input class="b3-text-field b3-form__icona-input" type="text" size="16">
    <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${g?escapeAriaLabel(g):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea rows="1" placeholder="${window.siyuan.languages.addDesc}" class="b3-text-field fn__block" type="text" data-value="${escapeAttr(g)}">${g}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(k){const x=k.querySelector("input");x.addEventListener("keydown",w=>{w.isComposing||w.key==="Enter"&&f.close()}),x.value=u;const T=k.querySelector("textarea");x.nextElementSibling.addEventListener("click",()=>{const w=T.parentElement;w.classList.toggle("fn__none"),w.classList.contains("fn__none")||T.focus()}),T.addEventListener("keydown",w=>{w.isComposing||w.key==="Enter"&&f.close()}),T.addEventListener("input",()=>{x.nextElementSibling.setAttribute("aria-label",T.value?escapeHtml(T.value):window.siyuan.languages.addDesc)})}}),f.addItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){confirmDialog(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let k=[];d.find(h=>{if(h.id===c)return k=h.options,!0});const x=a.parentElement.dataset.name;transaction(e,[{action:"removeAttrViewColOption",id:c,avID:t.id,data:x},{action:"doUpdateUpdated",id:l,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOptions",id:c,avID:t.id,data:k}]),k.find((h,E)=>{if(h.name===x)return k.splice(E,1),!0});const T=o.querySelector(".b3-menu__items").scrollTop,w=o.querySelector(".b3-chips"),v=w?w.clientHeight:0;s?(s.forEach((h,E)=>{const C=getFieldIdByCellElement(h,r);r==="table"||i?h=s[E]=n.querySelector(`.av__row[data-id="${C}"] .av__cell[data-col-id="${h.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${h.dataset.colId}"]`):h=s[E]=n.querySelector(`.av__gallery-item[data-id="${C}"] .av__cell[data-field-id="${h.dataset.fieldId}"]`),Ne[E].mSelect.find((A,S)=>{if(A.content===x)return Ne[E].mSelect.splice(S,1),!0}),h.classList.contains("custom-attr__avvalue")?h.innerHTML=genAVValueHTML(Ne[E]):updateAttrViewCellAnimation(h,Ne[E])}),o.innerHTML=Da(d,s,!1,n),Ia(e,t,o,s,n)):(o.innerHTML=getEditHTML({protyle:e,data:t,colId:c,isCustomAttr:i}),bindEditEvent({protyle:e,data:t,menuElement:o,isCustomAttr:i,blockID:l})),w&&(o.querySelector(".b3-menu__items").scrollTop=T+(o.querySelector(".b3-chips").clientHeight-v))},void 0,!0)}}),f.addSeparator();let b='<div class="fn__flex fn__flex-wrap" style="width: 238px">';Array.from(Array(14).keys()).forEach(k=>{b+=`<button data-color="${k+1}" class="color__square${parseInt(m)===k+1?" color__square--current":""}" style="color: var(--b3-font-color${k+1});background-color: var(--b3-font-background${k+1});">A</button>`}),f.addItem({type:"empty",iconHTML:"",label:b+"</div>",bind(k){k.addEventListener("click",x=>{var T;const w=x.target;if(w.classList.contains("color__square")&&!w.classList.contains("color__square--current")){(T=k.querySelector(".color__square--current"))==null||T.classList.remove("color__square--current"),w.classList.add("color__square--current");const v=w.getAttribute("data-color");transaction(e,[{action:"updateAttrViewColOption",id:c,avID:t.id,data:{oldName:u,newName:y.value,oldColor:m,newColor:v,newDesc:_.value}},{action:"doUpdateUpdated",id:l,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOption",id:c,avID:t.id,data:{oldName:y.value,newName:u,oldColor:v,newColor:m,newDesc:_.value}}]),d.find(E=>{if(E.id===c)return E.options.find(C=>{if(C.name===u)return C.name=y.value,C.color=v,!0}),!0});const h=o.querySelector(".b3-menu__items").scrollTop;s?(s.forEach((E,C)=>{const A=getFieldIdByCellElement(E,r);r==="table"?E=s[C]=n.querySelector(`.av__row[data-id="${A}"] .av__cell[data-col-id="${E.dataset.colId}"]`)||n.querySelector(`.fn__flex-1[data-col-id="${E.dataset.colId}"]`):E=s[C]=n.querySelector(`.av__gallery-item[data-id="${A}"] .av__cell[data-field-id="${E.dataset.fieldId}"]`),Ne[C].mSelect.find(S=>{if(S.content===u)return S.content=y.value,S.color=v,!0}),E.classList.contains("custom-attr__avvalue")?E.innerHTML=genAVValueHTML(Ne[C]):updateAttrViewCellAnimation(E,Ne[C])}),o.innerHTML=Da(d,s,!1,n),Ia(e,t,o,s,n)):(o.innerHTML=getEditHTML({protyle:e,data:t,colId:c,isCustomAttr:i}),bindEditEvent({protyle:e,data:t,menuElement:o,isCustomAttr:i,blockID:l})),o.querySelector(".b3-menu__items").scrollTop=h,u=y.value,g=_.value,m=v}})}});const p=a.getBoundingClientRect();f.open({x:p.right,y:p.bottom,w:p.width,h:p.height});const y=window.siyuan.menus.menu.element.querySelector("input");y.select();const _=window.siyuan.menus.menu.element.querySelector("textarea")},Ia=(e,t,a,n,i)=>{const s=a.querySelector("input"),o=getColId(n[0],i.getAttribute("data-av-type"));let l;getFieldsByData(t).find(c=>{if(c.id===o){l=c;return}}),l.options||(l.options=[]);const r=a.lastElementChild.lastElementChild;s.addEventListener("input",c=>{c.isComposing||(r.innerHTML=Bn(s.value,l.options))}),s.addEventListener("compositionend",()=>{r.innerHTML=Bn(s.value,l.options)}),s.addEventListener("keydown",c=>{if(c.isComposing)return;let u=upDownHint(r,c,"b3-menu__item--current",r.firstElementChild);c.key==="Enter"?(u||(u=a.querySelector(".b3-menu__item--current")),u.querySelector(".b3-menu__checked")?Xs(e,n,a.querySelector(`.b3-chips .b3-chip[data-content="${escapeAttr(u.dataset.name)}"]`),i):Uo(e,t,n,u,a,i)):c.key==="Backspace"&&s.value===""&&Xs(e,n,s.previousElementSibling,i)})},Uo=(e,t,a,n,i,s)=>{let o=!1;if(Array.from(i.querySelectorAll(".b3-chips .b3-chip")).find(f=>{if(f.dataset.content===n.dataset.name)return o=!0,!0}),o){i.querySelector("input").focus();return}hasClosestBlock(a[0])||a.forEach((f,b)=>{const p=getFieldIdByCellElement(f,t.viewType);t.viewType==="table"||isCustomAttr(f)?a[b]=s.querySelector(`.av__row[data-id="${p}"] .av__cell[data-col-id="${f.dataset.colId}"]`)||s.querySelector(`.fn__flex-1[data-col-id="${f.dataset.colId}"]`):a[b]=s.querySelector(`.av__gallery-item[data-id="${p}"] .av__cell[data-field-id="${f.dataset.fieldId}"]`)});const r=getColId(a[0],s.getAttribute("data-av-type"));let c;const u=getFieldsByData(t);u.find(f=>{if(f.id===r){c=f,c.options||(c.options=[]);return}});const g=[],m=[];let d;if(a.forEach((f,b)=>{const p=getFieldIdByCellElement(f,t.viewType);if(!p)return;const y=Ne[b],_=JSON.parse(JSON.stringify(y));if(b===0){if(c.type==="mSelect"){let k=!1;y.mSelect.find(x=>{if(x.content===n.dataset.name)return k=!0,!0}),k||y.mSelect.push({color:n.dataset.color,content:n.dataset.name})}else y.mSelect=[{color:n.dataset.color,content:n.dataset.name}];d=y.mSelect}else y.mSelect=d;g.push({action:"updateAttrViewCell",id:y.id,keyID:r,rowID:p,avID:t.id,data:y}),m.push({action:"updateAttrViewCell",id:y.id,keyID:r,rowID:p,avID:t.id,data:_}),f.classList.contains("custom-attr__avvalue")?f.innerHTML=genAVValueHTML(y):updateAttrViewCellAnimation(f,y)}),n.querySelector(".b3-menu__accelerator")?(c.options.push({color:n.dataset.color,name:n.dataset.name}),g.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:t.id,data:c.options}),g.push({action:"doUpdateUpdated",id:s.getAttribute("data-node-id"),data:dayjs().format("YYYYMMDDHHmmss")}),transaction(e,g,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:n.dataset.name}])):(g.push({action:"doUpdateUpdated",id:s.getAttribute("data-node-id"),data:dayjs().format("YYYYMMDDHHmmss")}),transaction(e,g,m)),c.type==="select")s.setAttribute("data-rendering","true"),i.parentElement.dispatchEvent(new CustomEvent("click",{detail:"close"}));else{const f=i.querySelector(".b3-menu__items").scrollTop,b=i.querySelector(".b3-chips").clientHeight;i.innerHTML=Da(u,a,!1,s),Ia(e,t,i,a,s),i.querySelector("input").focus(),i.querySelector(".b3-menu__items").scrollTop=f+(i.querySelector(".b3-chips").clientHeight-b)}},Da=(e,t,a=!1,n)=>{var i;if(a){Ne=[];const c=t[0].classList.contains("custom-attr__avvalue");t.forEach(u=>{Ne.push(genCellValueByElement(c?u.dataset.type:getTypeByCellElement(u),u))})}const s=getColId(t[0],n.getAttribute("data-av-type")),o=e.find(c=>{if(c.id===s)return c});let l="";const r=[];return(i=Ne[0].mSelect)==null||i.forEach(c=>{r.push(c.content),l+=`<div class="b3-chip b3-chip--middle" data-content="${escapeAttr(c.content)}" style="white-space: nowrap;max-width:100%;background-color:var(--b3-font-background${c.color});color:var(--b3-font-color${c.color})"><span class="fn__ellipsis">${escapeHtml(c.content)}</span><svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips" style="max-width: 50vw">
    ${l}
    <input>
</div>
<div>${Bn("",o.options,r)}</div>
</div>`},yg=(e,t,a)=>{const n=[],i=[];return t.mSelect.forEach(s=>{var o;if(e.options||(e.options=[]),!e.options.find(r=>{if(r.name===s.content)return s.color=r.color,!0})){const r=((((o=e.options)==null?void 0:o.length)||0)%14+1).toString();e.options.push({name:s.content,color:r}),s.color=r,n.push({action:"updateAttrViewColOptions",id:e.id,avID:a,data:e.options}),i.push({action:"removeAttrViewColOption",id:e.id,avID:a,data:s.content})}}),{doOperations:n,undoOperations:i}},hg=e=>{const t=new Menu(Constants.MENU_AV_ADD_SORT),a=getFieldsByData(e.data);a.forEach(n=>{let i=!1;n.type==="lineNumber"?i=!0:e.data.view.sorts.find(s=>{if(s.column===n.id)return i=!0,!0}),i||t.addItem({label:n.name,iconHTML:n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`,click:()=>{const s=Object.assign([],e.data.view.sorts);e.data.view.sorts.push({column:n.id,order:"ASC"}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:e.data.id,data:e.data.view.sorts,blockID:e.blockID}],[{action:"setAttrViewSorts",avID:e.data.id,data:s,blockID:e.blockID}]),e.menuElement.innerHTML=Yo(a,e.data.view.sorts),Fo(e.protyle,e.menuElement,e.data,e.blockID),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height)}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},Fo=(e,t,a,n)=>{t.querySelectorAll("select").forEach(i=>{i.addEventListener("change",()=>{const s=i.parentElement.getAttribute("data-id"),o=JSON.parse(JSON.stringify(a.view.sorts));i.previousElementSibling.classList.contains("b3-menu__icon")?a.view.sorts.find(l=>{if(l.column===s)return l.column=i.value,i.parentElement.setAttribute("data-id",i.value),!0}):a.view.sorts.find(l=>l.column===s).order=i.value,transaction(e,[{action:"setAttrViewSorts",avID:a.id,data:a.view.sorts,blockID:n}],[{action:"setAttrViewSorts",avID:a.id,data:o,blockID:n}])})})},Yo=(e,t)=>{let a="";const n=i=>{let s="";return e.forEach(o=>{s+=`<option value="${o.id}" ${o.id===i?"selected":""}>${o.icon&&unicode2Emoji(o.icon)}${o.name}</option>`}),s};return t.forEach(i=>{a+=`<button draggable="true" class="b3-menu__item" data-id="${i.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select fn__flex-1" style="margin: 4px 0">
        ${n(i.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${i.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${i.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${a}
<button class="b3-menu__item${t.length===e.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addSort}</span>
</button>
<button class="b3-menu__item b3-menu__item--warning${a?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeSorts}</span>
</button>
</div>`},_g=e=>{const t=genCellValueByElement("date",e[0]).date,a=t.isNotTime;let n="";const i=new Date().getTime();if(t.isNotEmpty){n=dayjs(t.content).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const o=n.split("-")[0];o.length!==4&&(n=new Array(4-o.length).fill(0).join("")+n)}else n=dayjs(i).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");let s="";if(t.isNotEmpty2){s=dayjs(t.content2).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const o=s.split("-")[0];o.length!==4&&(s=new Array(4-o.length).fill(0).join("")+s)}else t.hasEndDate&&(s=dayjs(i).format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));return`<div class="b3-menu__items">
<div>
    <input type="${a?"date":"datetime-local"}" max="${a?"9999-12-31":"9999-12-31 23:59"}" value="${n}" data-value="${dayjs(t.content||i).format("YYYY-MM-DD HH:mm")}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${a?"date":"datetime-local"}" max="${a?"9999-12-31":"9999-12-31 23:59"}" value="${s}" data-value="${t.isNotEmpty2?dayjs(t.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${t.hasEndDate?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${t.hasEndDate?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${a?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},wg=e=>{const t=e.menuElement.querySelectorAll("input");return t.forEach(a=>{a.addEventListener("keydown",n=>{var i;n.isComposing||n.key==="Enter"&&(updateCellsValue(e.protyle,e.blockElement,{content:Ma(t[0].dataset.value)||0,isNotEmpty:t[0].value!=="",content2:Ma(t[1].dataset.value)||0,isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements),(i=document.querySelector(".av__panel"))==null||i.dispatchEvent(new CustomEvent("click",{detail:"close"})))})}),t[0].addEventListener("change",()=>{t[0].dataset.value=t[0].value.length>10?t[0].value:t[0].value+" 00:00"}),t[1].addEventListener("change",()=>{t[1].dataset.value=t[1].value.length>10?t[1].value:t[1].value+" 00:00"}),t[2].addEventListener("change",()=>{if(t[2].checked){if(!t[1].dataset.value){const a=new Date().getTime();t[1].dataset.value=dayjs(a).format("YYYY-MM-DD HH:mm"),t[1].value=dayjs(a).format(t[3].checked?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")}t[1].classList.remove("fn__none")}else t[1].classList.add("fn__none")}),t[3].addEventListener("change",()=>{t[0].value="",t[1].value="",t[3].checked?(t[0].setAttribute("type","datetime-local"),t[1].setAttribute("type","datetime-local"),t[0].setAttribute("max","9999-12-31 23:59"),t[1].setAttribute("max","9999-12-31 23:59"),t[0].value=t[0].dataset.value,t[1].value=t[1].dataset.value):(t[0].setAttribute("type","date"),t[1].setAttribute("type","date"),t[0].setAttribute("max","9999-12-31"),t[1].setAttribute("max","9999-12-31"),t[0].value=t[0].dataset.value.substring(0,10),t[1].value=t[1].dataset.value.substring(0,10))}),()=>{updateCellsValue(e.protyle,e.blockElement,{content:Ma(t[0].dataset.value)||0,isNotEmpty:t[0].value!=="",content2:Ma(t[1].dataset.value)||0,isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}},Ma=e=>{const t=e.split("-")[0],a=new Date(e);return(t.startsWith("00")||t.startsWith("000")||t.length<3)&&a.setFullYear(parseInt(t)),a.getTime()},we=e=>{e.menu.addItem({iconHTML:"",label:Wo(e.format),click(){transaction(e.protyle,[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.oldFormat,type:"number"}]),e.avPanelElement.remove()}})},vg=e=>{const t=new Menu(Constants.MENU_AV_COL_FORMAT_NUMBER);we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"commas",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"percent",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"USD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"CNY",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"EUR",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"GBP",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"JPY",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"RUB",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"INR",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"KRW",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"CAD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"CHF",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"THB",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"AUD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"HKD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"TWD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"MOP",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"SGD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),we({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"NZD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement});const a=e.element.getBoundingClientRect();t.open({x:a.left,y:a.bottom,h:a.height,w:a.width,isLeft:!0})},Wo=e=>e===""?window.siyuan.languages.numberFormatNone:e==="commas"?window.siyuan.languages.numberFormatCommas:e==="percent"?window.siyuan.languages.numberFormatPercent:window.siyuan.languages["numberFormat"+e],Js=(e,t)=>{var a,n;if(t.classList.contains("b3-list--empty"))return;e.target.querySelector(".b3-menu__accelerator").textContent=t.querySelector(".b3-list-item__text").textContent;const i=getFieldsByData(e.data).find(o=>{if(o.id===e.colId)return o.rollup||(o.rollup={}),!0});if(e.isRelation){if(t.dataset.colId===((a=i.rollup)==null?void 0:a.relationKeyID))return;i.rollup={relationKeyID:t.dataset.colId};const o=e.target.nextElementSibling;o.querySelector(".b3-menu__accelerator").textContent="",o.setAttribute("data-av-id",t.dataset.targetAvId);const l=o.nextElementSibling;l.removeAttribute("data-col-type"),l.removeAttribute("data-calc"),l.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}else{if(t.dataset.colId===((n=i.rollup)==null?void 0:n.keyID))return;i.rollup.keyID=t.dataset.colId,delete i.rollup.calc;const o=e.target.nextElementSibling;o.removeAttribute("data-calc"),o.setAttribute("data-col-type",t.dataset.colType),o.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}const s=JSON.parse(JSON.stringify(i.rollup));transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:i.rollup.relationKeyID,keyID:i.rollup.keyID,data:{calc:i.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:s.relationKeyID,keyID:s.keyID,data:{calc:s.calc}}])},Qs=(e,t,a,n,i)=>{if(!n&&!a){showMessage(window.siyuan.languages.selectRelation);return}fetchPost(n?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewRollupDestKeys",{avID:a,keyword:t},s=>{let o="";s.data.keys.forEach((l,r)=>{o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${l.id}" ${n?`data-target-av-id="${l.relation.avID}"`:`data-col-type="${l.type}"`}>
        ${l.icon?unicode2Emoji(l.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${getColIconByType(l.type)}"></use></svg>`}
        <span class="b3-list-item__text">${escapeHtml(l.name||window.siyuan.languages.title)}</span>
</div>`}),e.innerHTML=o||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,i&&i()})},Eg=e=>{window.siyuan.menus.menu.remove();const t=new Menu;t.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[e.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(a){const n=a.querySelector(".b3-list"),i=a.querySelector("input");i.addEventListener("keydown",s=>{if(s.isComposing)return;upDownHint(n,s)&&s.stopPropagation(),s.key==="Enter"&&(s.preventDefault(),s.stopPropagation(),Js(e,n.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),i.addEventListener("input",s=>{s.stopPropagation(),Qs(n,i.value,e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation)}),a.lastElementChild.addEventListener("click",s=>{const o=hasClosestByClassName(s.target,"b3-list-item");o&&(s.stopPropagation(),Js(e,o),window.siyuan.menus.menu.remove())}),Qs(n,"",e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation,()=>{const s=e.target.getBoundingClientRect();t.open({x:s.left,y:s.bottom,h:s.height}),a.querySelector("input").focus()})}}),t.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},kg=e=>{var t,a;let n;return e.colData?n=e.colData:getFieldsByData(e.data).find(i=>{if(i.id===getColId(e.cellElements[0],e.data.viewType))return n=i,!0}),`<button class="b3-menu__item b3-menu__item--current" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(n.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${getNameByOperator((a=(t=n.rollup)==null?void 0:t.calc)==null?void 0:a.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},Cg=e=>{const t=e.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(t){const a=JSON.parse(t.dataset.oldValue),n=e.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let i="";a.relationKeyID&&getFieldsByData(e.data).find(s=>{if(s.id===a.relationKeyID)return t.querySelector(".b3-menu__accelerator").textContent=s.name,i=s.relation.avID,n.dataset.avId=i,!0}),a.keyID&&i&&fetchPost("/api/av/getAttributeView",{id:i},s=>{s.data.av.keyValues.find(o=>{if(o.key.id===a.keyID){n.querySelector(".b3-menu__accelerator").textContent=o.key.name;const l=e.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return l.dataset.colType=o.key.type,a.calc&&(l.dataset.calc=a.calc.operator),!0}})})}};var jo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Vo=e=>{let t="";const a=e.view;if(e.viewType==="gallery"){let n="";a.coverFrom===0?n=window.siyuan.languages.calcOperatorNone:a.coverFrom===1?n=window.siyuan.languages.contentImage:a.coverFrom===3?n=window.siyuan.languages.contentBlock:a.fields.find(i=>{if(i.type==="mAsset"&&i.id===a.coverFromAssetKeyID)return n=i.name,!0}),t=`<button class="b3-menu__item" data-type="set-gallery-cover">
    <span class="fn__flex-center">${window.siyuan.languages.cardPreview1}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${n}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-gallery-ratio">
    <span class="fn__flex-center">${window.siyuan.languages.cardAspectRatio}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${getCardAspectRatio(a.cardAspectRatio)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-gallery-size">
    <span class="fn__flex-center">${window.siyuan.languages.cardSize}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${a.cardSize===0?window.siyuan.languages.small:a.cardSize===1?window.siyuan.languages.medium:window.siyuan.languages.large}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fitImage}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-gallery-fit" type="checkbox" class="b3-switch b3-switch--menu" ${a.fitImage?"checked":""}>
</label>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.displayFieldName}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-gallery-name" type="checkbox" class="b3-switch b3-switch--menu" ${a.displayFieldName?"checked":""}>
</label>`}return`<div class="b3-menu__items">
    <div class="b3-menu__items">
    <button class="b3-menu__item" data-type="nobg">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.layout}</span>
    </button>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="nobg">
        <div class="av__layout">
            <div data-type="set-layout" data-view-type="table" class="av__layout-item${e.viewType==="table"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconTable"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.table}</div>
            </div>
            <div data-type="set-layout" data-view-type="gallery" class="av__layout-item${e.viewType==="gallery"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconGallery"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.gallery}</div>
            </div>
        </div>
    </button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.showTitle}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-view-title" type="checkbox" class="b3-switch b3-switch--menu" ${a.hideAttrViewName?"":"checked"}>
    </label>
    ${t}
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.showAllEntriesIcons}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-entries-icons" type="checkbox" class="b3-switch b3-switch--menu" ${a.showIcon?"checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.wrapAllFields}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-entries-wrap" type="checkbox" class="b3-switch b3-switch--menu" ${a.wrapField?"checked":""}>
    </label>
    <button class="b3-menu__item" data-type="set-page-size" data-size="${a.pageSize}">
        <span class="fn__flex-center">${window.siyuan.languages.entryNum}</span>
        <span class="fn__flex-1"></span>
        <span class="b3-menu__accelerator">${a.pageSize===Constants.SIZE_DATABASE_MAZ_SIZE?window.siyuan.languages.all:a.pageSize}</span>
        <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
    </button>
</div>`},Go=e=>{const t=e.menuElement.querySelector('.b3-switch[data-type="toggle-view-title"]');t.addEventListener("change",()=>{const o=e.blockElement.getAttribute("data-av-id"),l=e.blockElement.getAttribute("data-node-id"),r=t.checked;transaction(e.protyle,[{action:"hideAttrViewName",avID:o,blockID:l,data:!r}],[{action:"hideAttrViewName",avID:o,blockID:l,data:r}]),e.data.view.hideAttrViewName=!r});const a=e.menuElement.querySelector('.b3-switch[data-type="toggle-entries-icons"]');a.addEventListener("change",()=>{const o=e.blockElement.getAttribute("data-av-id"),l=e.blockElement.getAttribute("data-node-id"),r=a.checked;transaction(e.protyle,[{action:"setAttrViewShowIcon",avID:o,blockID:l,data:r}],[{action:"setAttrViewShowIcon",avID:o,blockID:l,data:!r}]),e.data.view.showIcon=r});const n=e.menuElement.querySelector('.b3-switch[data-type="toggle-entries-wrap"]');if(n.addEventListener("change",()=>{const o=e.blockElement.getAttribute("data-av-id"),l=e.blockElement.getAttribute("data-node-id"),r=n.checked;transaction(e.protyle,[{action:"setAttrViewWrapField",avID:o,blockID:l,data:r}],[{action:"setAttrViewWrapField",avID:o,blockID:l,data:!r}]),getFieldsByData(e.data).forEach(c=>{c.wrap=r}),e.data.view.wrapField=r}),e.data.viewType!=="gallery")return;const i=e.menuElement.querySelector('.b3-switch[data-type="toggle-gallery-fit"]');i.addEventListener("change",()=>{const o=e.blockElement.getAttribute("data-av-id"),l=e.blockElement.getAttribute("data-node-id"),r=i.checked;transaction(e.protyle,[{action:"setAttrViewFitImage",avID:o,blockID:l,data:r}],[{action:"setAttrViewFitImage",avID:o,blockID:l,data:!r}]),e.data.view.fitImage=r});const s=e.menuElement.querySelector('.b3-switch[data-type="toggle-gallery-name"]');s.addEventListener("change",()=>{const o=e.blockElement.getAttribute("data-av-id"),l=e.blockElement.getAttribute("data-node-id"),r=s.checked;transaction(e.protyle,[{action:"setAttrViewDisplayFieldName",avID:o,blockID:l,data:r}],[{action:"setAttrViewDisplayFieldName",avID:o,blockID:l,data:!r}]),e.data.view.displayFieldName=r})},Ag=e=>jo(void 0,null,function*(){if(e.target.classList.contains("av__layout-item--select")||e.target.dataset.load==="true")return;e.target.dataset.load="true",e.target.parentElement.querySelector(".av__layout-item--select").classList.remove("av__layout-item--select"),e.target.classList.add("av__layout-item--select");const t=yield fetchSyncPost("/api/av/changeAttrViewLayout",{blockID:e.nodeElement.getAttribute("data-node-id"),avID:e.nodeElement.getAttribute("data-av-id"),layoutType:e.target.getAttribute("data-view-type")}),a=document.querySelector(".av__panel").lastElementChild;return a.innerHTML=Vo(t.data),Go({protyle:e.protyle,data:t.data,menuElement:a,blockElement:e.nodeElement}),e.target.removeAttribute("data-load"),t.data});var aa=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const ei=e=>{const t={};let a;return e.querySelectorAll(".av__body").forEach(n=>{const i=n.dataset.groupId,s=parseInt(n.dataset.pageSize);i?t[i]={pageSize:s}:a||(a=s)}),{groupPageSize:t,unGroupPageSize:a}},Sg=e=>aa(void 0,null,function*(){const t=e.blockElement.getAttribute("data-node-id"),a=getFieldsByData(e.data).find(o=>o.id===e.fieldId),n=a?{field:e.fieldId,method:a.type==="number"?1:["date","updated","created"].includes(a.type)?2:0,order:0,range:a.type==="number"?{numStart:0,numEnd:1e3,numStep:100}:null,hideEmpty:!0}:{field:null,method:null,order:null,range:null,hideEmpty:null},i=yield fetchSyncPost("/api/av/setAttrViewGroup",{blockID:t,avID:e.blockElement.getAttribute("data-av-id"),group:n});e.data.view=i.data.view,e.menuElement.innerHTML=Ha(getFieldsByData(e.data),e.data.view),Na({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const s=e.blockElement.querySelector(".av__views").getBoundingClientRect();setPosition(e.menuElement,s.right-e.menuElement.clientWidth,s.bottom,s.height)}),Lg=(e,t)=>{const a='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>';let n=`<button class="b3-menu__item" data-type="setGroupMethod">
    <div class="b3-menu__label">${window.siyuan.languages.calcOperatorNone}</div>
    ${!t||!t.field?a:""}
</button>`;return e.forEach(i=>{["rollup","mAsset","lineNumber"].includes(i.type)||(n+=`<button class="b3-menu__item" data-id="${i.id}" data-type="setGroupMethod">
    <div class="b3-menu__label fn__flex">
        ${i.icon?unicode2Emoji(i.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(i.type)}"></use></svg>`}
        ${escapeHtml(i.name)||"&nbsp;"}
    </div>
    ${(t==null?void 0:t.field)===i.id?a:""}
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="${!t||!t.field?"go-config":"goGroups"}">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.groupMethod}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
</div>`},$a=(e,t)=>{if(t==="sort")switch(e){case 0:return window.siyuan.languages.asc;case 1:return window.siyuan.languages.desc;case 2:return window.siyuan.languages.customSort;case 3:return window.siyuan.languages.sortBySelectOption;default:return""}else if(t==="date")switch(e){case 2:return window.siyuan.languages.groupMethodDateRelative;case 3:return window.siyuan.languages.groupMethodDateDay;case 4:return window.siyuan.languages.groupMethodDateWeek;case 5:return window.siyuan.languages.groupMethodDateMonth;case 6:return window.siyuan.languages.groupMethodDateYear;default:return""}},xg=e=>{var t,a,n;return`<div class="b3-menu__items">
    <button class="b3-menu__item" data-type="nobg">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goGroups">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.numberFormatNone}</span>
    </button>
    <button class="b3-menu__separator"></button>
    <div class="b3-menu__item" data-type="nobg">
        <div class="fn__block">
            <div class="b3-menu__labels">${window.siyuan.languages.groupRange}</div>
            <div class="fn__flex">
                <input data-type="avGroupRange" class="b3-text-field fn__flex-1" value="${((t=e==null?void 0:e.range)==null?void 0:t.numStart)||0}">
                <span class="fn__space"></span>-<span class="fn__space"></span>
                <input class="b3-text-field fn__flex-1" value="${((a=e==null?void 0:e.range)==null?void 0:a.numEnd)||1e3}">            
            </div>
            <div class="fn__hr"></div>
            <div class="b3-menu__labels">${window.siyuan.languages.groupStep}</div>
            <input class="b3-text-field fn__block" value="${((n=e==null?void 0:e.range)==null?void 0:n.numStep)||100}">
            <div class="fn__hr--small"></div>
        </div>
    </div>
</div>`},Tg=e=>()=>aa(void 0,null,function*(){if(!e.menuElement.querySelector('[data-type="avGroupRange"]'))return;const t=e.blockElement.getAttribute("data-node-id"),a=e.menuElement.querySelectorAll("input"),n={numStart:a[0].value?parseFloat(a[0].value):e.data.view.group.range.numStart,numEnd:a[1].value?parseFloat(a[1].value):e.data.view.group.range.numEnd,numStep:a[2].value?parseFloat(a[2].value):e.data.view.group.range.numStep};if(objEquals(e.data.view.group.range,n))return;Object.assign(e.data.view.group.range,n);const i=yield fetchSyncPost("/api/av/setAttrViewGroup",{blockID:t,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=i.data.view}),Ha=(e,t)=>{var a;let n="",i;if(t.group&&t.group.field){let s="";if(i=e.find(o=>o.id===t.group.field),((a=t.groups)==null?void 0:a.length)>0){const o=["created","date","created","updated"].includes(i.type);let l=0;t.groups.forEach(r=>{var c,u,g;r.groupHidden===0&&l++;let m=`<div class="b3-menu__label fn__flex-1 fn__ellipsis">${r.name||""}</div>`;((u=(c=r.groupValue)==null?void 0:c.mSelect)==null?void 0:u.length)>0?m=`<div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${r.groupValue.mSelect[0].color});color:var(--b3-font-color${r.groupValue.mSelect[0].color})">
            <span class="fn__ellipsis">${escapeHtml(r.groupValue.mSelect[0].content)}</span>
        </span>
    </div>`:((g=r.groupValue)==null?void 0:g.type)=="checkbox"&&(m=`<div class="b3-menu__label fn__flex">
<svg class="b3-menu__icon"><use xlink:href="#icon${r.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg> ${i.name||""}
</div>`),s+=`<button class="b3-menu__item${r.groupHidden===0?"":" b3-menu__item--hidden"}" draggable="${o?"false":"true"}" data-id="${r.id}">
    ${o?"":'<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>'}
    ${m}
    <svg class="b3-menu__action b3-menu__action--show" data-type="hideGroup" data-id="${r.id}"><use xlink:href="#iconEye${r.groupHidden===0?"":"off"}"></use></svg>
</button>`}),s=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label"></span>
    <span class="block__icon" data-type="hideGroups">
        ${window.siyuan.languages[l===0?"showAll":"hideAll"]}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye${l===0?"":"off"}"></use></svg>
    </span>
</button>`+s}n=`<button class="b3-menu__item${["date","updated","created"].includes(i.type)?"":" fn__none"}" data-type="goGroupsDate">
    <span class="b3-menu__label">${window.siyuan.languages.date}</span>
    <span class="b3-menu__accelerator">${$a(t.group.method,"date")}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item${i.type==="number"?"":" fn__none"}" data-type="getGroupsNumber">
    <span class="b3-menu__label">${window.siyuan.languages.numberFormatNone}</span>
    <span class="b3-menu__accelerator">${t.group.range&&typeof t.group.range.numStart=="number"?`${t.group.range.numStart} - ${t.group.range.numEnd}`:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item${["checkbox","rollup","mAsset"].includes(i.type)?" fn__none":""}" data-type="goGroupsSort">
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${$a(t.group.order,"sort")}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.hideEmptyGroup}</span>
    <span class="fn__space fn__flex-1"></span>
    <input type="checkbox" class="b3-switch b3-switch--menu"${t.group.hideEmpty?" checked":""}>
</label>
${s}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item b3-menu__item--warning" data-type="removeGroups">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeGroup}</span>
</button>`}return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.group}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="goGroupsMethod">
    <span class="b3-menu__label">${window.siyuan.languages.groupMethod}</span>
    <span class="b3-menu__accelerator">${i?i.name:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
${n}
</div>`},Na=e=>{const t=e.menuElement.querySelector("input");if(!t)return;const a=e.blockElement.getAttribute("data-node-id");t.addEventListener("change",()=>aa(void 0,null,function*(){e.data.view.group.hideEmpty=t.checked;const n=yield fetchSyncPost("/api/av/setAttrViewGroup",{blockID:a,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=n.data.view,e.menuElement.innerHTML=Ha(getFieldsByData(e.data),e.data.view),Na({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const i=e.blockElement.querySelector(".av__views").getBoundingClientRect();setPosition(e.menuElement,i.right-e.menuElement.clientWidth,i.bottom,i.height)}))},Ig=e=>{const t=new Menu(Constants.MENU_AV_GROUP_DATE);if(t.isOpen)return;const a=e.blockElement.getAttribute("data-node-id");[2,3,4,5,6].forEach(i=>{const s=$a(i,"date");t.addItem({iconHTML:"",checked:e.data.view.group.method===i,label:s,click(){return aa(this,null,function*(){e.data.view.group.method=i,e.target.querySelector(".b3-menu__accelerator").textContent=s;const o=yield fetchSyncPost("/api/av/setAttrViewGroup",{blockID:a,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=o.data.view,e.menuElement.innerHTML=Ha(getFieldsByData(e.data),e.data.view),Na({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const l=e.blockElement.querySelector(".av__views").getBoundingClientRect();setPosition(e.menuElement,l.right-e.menuElement.clientWidth,l.bottom,l.height)})}})});const n=e.target.getBoundingClientRect();t.open({isLeft:!0,x:n.right,y:n.bottom})},Dg=e=>{const t=new Menu(Constants.MENU_AV_GROUP_SORT);if(t.isOpen)return;const a=e.blockElement.getAttribute("data-node-id"),n=getFieldsByData(e.data).find(s=>s.id===e.data.view.group.field);(["created","date","created","updated"].includes(n.type)?[0,1]:["mSelect","select"].includes(n.type)?[3,2,0,1]:[2,0,1]).forEach(s=>{const o=$a(s,"sort");t.addItem({iconHTML:"",checked:e.data.view.group.order===s,label:o,click(){return aa(this,null,function*(){e.target.querySelector(".b3-menu__accelerator").textContent=o,e.data.view.group.order=s;const l=yield fetchSyncPost("/api/av/setAttrViewGroup",{blockID:a,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=l.data.view,e.menuElement.innerHTML=Ha(getFieldsByData(e.data),e.data.view),Na({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const r=e.blockElement.querySelector(".av__views").getBoundingClientRect();setPosition(e.menuElement,r.right-e.menuElement.clientWidth,r.bottom,r.height)})}})});const i=e.target.getBoundingClientRect();t.open({isLeft:!0,x:i.right,y:i.bottom})};var zo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Ko=e=>{var t;let a=document.querySelector(".av__panel");if(a){a.remove();return}const n=e.blockElement.getAttribute("data-av-id"),i=getPageSize(e.blockElement);fetchPost("/api/av/renderAttributeView",{id:n,query:((t=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:t.value.trim())||"",pageSize:i.unGroupPageSize,groupPaging:i.groupPageSize,viewID:e.blockElement.getAttribute(Constants.CUSTOM_SY_AV_VIEW)},s=>{var o;if(a=document.querySelector(".av__panel"),a){a.remove();return}window.siyuan.menus.menu.remove();const l=e.blockElement.getAttribute("data-node-id"),r=!e.blockElement.classList.contains("av");let c=s.data,u,g=getFieldsByData(c);if(e.type==="config")u=getViewHTML(c);else if(e.type==="properties")u=St(g);else if(e.type==="sorts")u=getSortsHTML(g,c.view.sorts);else if(e.type==="switcher")u=getSwitcherHTML(c.views,c.viewID);else if(e.type==="filters")u=getFiltersHTML(c);else if(e.type==="select")u=getSelectHTML(g,e.cellElements,!0,e.blockElement);else if(e.type==="asset")u=getAssetHTML(e.cellElements);else if(e.type==="edit")e.editData&&(typeof e.editData.colData.wrap=="undefined"&&(e.editData.colData.wrap=c.view.wrapField),e.editData.previousID?g.find((y,_)=>{if(y.id===e.editData.previousID)return g.splice(_+1,0,e.editData.colData),!0}):c.viewType==="table"?g.splice(0,0,e.editData.colData):g.push(e.editData.colData)),u=getEditHTML({protyle:e.protyle,data:c,colId:e.colId,isCustomAttr:r});else if(e.type==="date")u=getDateHTML(e.cellElements);else if(e.type==="rollup")u=`<div class="b3-menu__items">${getRollupHTML({data:c,cellElements:e.cellElements})}</div>`;else if(e.type==="relation"&&(u=getRelationHTML(c,e.cellElements),!u)){Ko({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:getColId(e.cellElements[0],c.viewType)});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex};">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu" ${["select","date","asset","relation","rollup"].includes(e.type)?`style="min-width: 200px;${isMobile()?"max-width: 90vw;":"max-width: 50vw;"}"`:""}>${u}</div>
</div>`),a=document.querySelector(".av__panel");let m;const d=a.lastElementChild;let f=(o=e.blockElement.querySelector(`.av__views, .av__row[data-col-id="${e.colId}"] > .block__logo`))==null?void 0:o.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(e.type)){let y=e.cellElements[e.cellElements.length-1];if(!e.blockElement.contains(y)){const k=getFieldIdByCellElement(y,c.viewType);c.viewType==="table"?y=e.blockElement.querySelector(`.av__row[data-id="${k}"] .av__cell[data-col-id="${y.dataset.colId}"]`):y=e.blockElement.querySelector(`.av__gallery-item[data-id="${k}"] .av__cell[data-field-id="${y.dataset.fieldId}"]`)}const _=(y||e.cellElements[e.cellElements.length-1]).getBoundingClientRect();if(e.type==="select"?bindSelectEvent(e.protyle,c,d,e.cellElements,e.blockElement):e.type==="date"?m=bindDateEvent({protyle:e.protyle,data:c,menuElement:d,cellElements:e.cellElements,blockElement:e.blockElement}):e.type==="asset"?(bindAssetEvent({protyle:e.protyle,menuElement:d,cellElements:e.cellElements,blockElement:e.blockElement}),setTimeout(()=>{setPosition(d,_.left,_.bottom,_.height)},Constants.TIMEOUT_LOAD)):e.type==="relation"?bindRelationEvent({menuElement:d,cellElements:e.cellElements,protyle:e.protyle,blockElement:e.blockElement}):e.type==="rollup"&&bindRollupData({protyle:e.protyle,data:c,menuElement:d}),["select","date","relation","rollup"].includes(e.type)){const k=d.querySelector("input");k&&(k.select(),k.focus()),setPosition(d,_.left,_.bottom,_.height)}}else setPosition(d,f.right-d.clientWidth,f.bottom,f.height),e.type==="sorts"?bindSortsEvent(e.protyle,d,c,l):e.type==="edit"?bindEditEvent({protyle:e.protyle,data:c,menuElement:d,isCustomAttr:r,blockID:l}):e.type==="config"?bindViewEvent({protyle:e.protyle,data:c,menuElement:d,blockElement:e.blockElement}):e.type==="switcher"&&bindSwitcherEvent({protyle:e.protyle,menuElement:d,blockElement:e.blockElement});e.cb&&e.cb(a),a.addEventListener("dragstart",y=>{window.siyuan.dragElement=y.target,window.siyuan.dragElement.style.opacity=".38"}),a.addEventListener("drop",y=>{var _,k,x,T,w,v;if(p=0,!window.siyuan.dragElement){y.preventDefault(),y.stopPropagation();return}window.siyuan.dragElement.style.opacity="";const h=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,e.protyle&&e.protyle.disabled){y.preventDefault(),y.stopPropagation();return}if(!e.protyle&&window.siyuan.config.readonly){y.preventDefault(),y.stopPropagation();return}const E=a.querySelector(".dragover__bottom, .dragover__top");if(!E)return;const C=E.classList.contains("dragover__top"),A=h.dataset.id,S=E.dataset.id;if(E.querySelector('[data-type="removeSort"]')){const L=c.view.sorts,$=Object.assign([],L);let R;L.find((D,M)=>{if(D.column===A)return R=L.splice(M,1)[0],!0}),L.find((D,M)=>{if(D.column===S)return C?L.splice(M,0,R):L.splice(M+1,0,R),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:L,blockID:l}],[{action:"setAttrViewSorts",avID:n,data:$,blockID:l}]),d.innerHTML=getSortsHTML(g,c.view.sorts),bindSortsEvent(e.protyle,d,c,l);return}if(E.querySelector('[data-type="removeFilter"]')){const L=c.view.filters,$=Object.assign([],L);let R;L.find((D,M)=>{if(D.column===A)return R=L.splice(M,1)[0],!0}),L.find((D,M)=>{if(D.column===S)return C?L.splice(M,0,R):L.splice(M+1,0,R),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:L,blockID:l}],[{action:"setAttrViewFilters",avID:n,data:$,blockID:l}]),d.innerHTML=getFiltersHTML(c);return}if(E.querySelector('[data-type="av-view-edit"]')){transaction(e.protyle,[{action:"sortAttrViewView",avID:n,blockID:l,id:A,previousID:C?(_=E.previousElementSibling)==null?void 0:_.getAttribute("data-id"):E.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:n,blockID:l,id:A,previousID:(k=h.previousElementSibling)==null?void 0:k.getAttribute("data-id")}]),C?(E.before(h),E.classList.remove("dragover__top")):(E.after(h),E.classList.remove("dragover__bottom"));return}if(E.querySelector('[data-type="editAssetItem"]')){C?E.before(h):E.after(h);const L=[];Array.from(E.parentElement.children).forEach($=>{["image","file"].includes($.dataset.type)&&L.push({content:$.dataset.content,name:$.dataset.name,type:$.dataset.type})}),updateAssetCell({protyle:e.protyle,cellElements:e.cellElements,replaceValue:L,blockElement:e.blockElement});return}if(E.querySelector('[data-type="setColOption"]')){const L=e.cellElements?getColId(e.cellElements[0],c.viewType):d.querySelector(".b3-menu__item").getAttribute("data-col-id"),$=g.find(P=>P.id===L).options,R=Object.assign([],$);let D;$.find((P,B)=>{if(P.name===h.dataset.name)return D=$.splice(B,1)[0],!0}),$.find((P,B)=>{if(P.name===E.dataset.name)return C?$.splice(B,0,D):$.splice(B+1,0,D),!0}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:L,avID:n,data:$}],[{action:"updateAttrViewColOptions",id:L,avID:n,data:R}]);const M=d.querySelector(".b3-menu__items").scrollTop;e.cellElements?(d.innerHTML=getSelectHTML(g,e.cellElements,!1,e.blockElement),bindSelectEvent(e.protyle,c,d,e.cellElements,e.blockElement)):(d.innerHTML=getEditHTML({protyle:e.protyle,data:c,colId:L,isCustomAttr:r}),bindEditEvent({protyle:e.protyle,data:c,menuElement:d,isCustomAttr:r,blockID:l})),d.querySelector(".b3-menu__items").scrollTop=M;return}if(E.getAttribute("data-type")==="setRelationCell"){C?E.before(h):E.after(h),E.classList.remove("dragover__bottom","dragover__top");const L=[],$=[];E.parentElement.querySelectorAll(".fn__grab").forEach(R=>{const D=R.nextElementSibling;L.push(D.parentElement.dataset.rowId),$.push({isDetached:!D.style.color,type:"block",block:{content:D.textContent,id:D.dataset.id}})}),updateCellsValue(e.protyle,e.blockElement,{blockIDs:L,contents:$},e.cellElements);return}if(E.getAttribute("data-type")==="editCol"){const L=(C?(x=E.previousElementSibling)==null?void 0:x.getAttribute("data-id"):E.getAttribute("data-id"))||"",$=((T=h.previousElementSibling)==null?void 0:T.getAttribute("data-id"))||"";if(L!==$&&L!==A){transaction(e.protyle,[{action:"sortAttrViewCol",avID:n,previousID:L,id:A,blockID:l}],[{action:"sortAttrViewCol",avID:n,previousID:$,id:A,blockID:l}]);let R;g.find((D,M)=>{if(D.id===A)return R=g.splice(M,1)[0],!0}),g.find((D,M)=>{if(D.id===S)return C?g.splice(M,0,R):g.splice(M+1,0,R),!0})}d.innerHTML=St(g);return}if(E.querySelector('[data-type="hideGroup"]')){const L=(C?(w=E.previousElementSibling)==null?void 0:w.getAttribute("data-id"):E.getAttribute("data-id"))||"",$=((v=h.previousElementSibling)==null?void 0:v.getAttribute("data-id"))||"";L!==$&&L!==A&&(transaction(e.protyle,[{action:"sortAttrViewGroup",avID:n,blockID:l,previousID:L,id:A}],[{action:"sortAttrViewGroup",avID:n,blockID:l,previousID:$,id:A}]),d.querySelector('[data-type="goGroupsSort"] .b3-menu__accelerator').textContent=getLanguageByIndex(2,"sort"),c.view.group.order=2,c.view.groups.find((R,D)=>{if(R.id===A){const M=c.view.groups.splice(D,1)[0];return c.view.groups.find((P,B)=>{if(P.id===S)return C?c.view.groups.splice(B,0,M):c.view.groups.splice(B+1,0,M),!0}),!0}}),C?E.before(h):E.after(h)),E.classList.remove("dragover__top","dragover__bottom");return}});let b;a.addEventListener("dragover",y=>{if(y.dataTransfer.types.includes("Files")){y.preventDefault();return}const _=y.target;let k=hasClosestByAttribute(_,"draggable","true");if(k||(k=hasClosestByAttribute(document.elementFromPoint(y.clientX,y.clientY-1),"draggable","true")),!(!k||k===window.siyuan.dragElement)){if(y.preventDefault(),b&&k===b){const x=k.getBoundingClientRect();a.querySelectorAll(".dragover__bottom, .dragover__top").forEach(T=>{T.classList.remove("dragover__bottom","dragover__top")}),y.clientY>x.top+x.height/2?k.classList.add("dragover__bottom"):k.classList.add("dragover__top");return}b=k}});let p=0;a.addEventListener("dragleave",()=>{p--,p===0&&a.querySelectorAll(".dragover__bottom, .dragover__top").forEach(y=>{y.classList.remove("dragover__bottom","dragover__top")})}),a.addEventListener("dragenter",y=>{y.preventDefault(),p++}),a.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),a.addEventListener("mousedown",y=>{y.button===1&&!hasClosestByClassName(y.target,"b3-menu")&&document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"}))}),a.addEventListener("click",y=>zo(void 0,null,function*(){var _,k,x,T,w,v;let h,E=y.target;for(typeof y.detail=="string"?h=y.detail:typeof y.detail=="object"&&(h=y.detail.type,E=y.detail.target);E&&E!==a||h;){if(h=(E==null?void 0:E.dataset.type)||h,h==="close"){e.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")?(m==null||m(),a.remove(),focusBlock(e.blockElement)):window.siyuan.menus.menu.remove():hideElements(["util"],e.protyle),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="go-config"){d.innerHTML=getViewHTML(c),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),bindViewEvent({protyle:e.protyle,data:c,menuElement:d,blockElement:e.blockElement}),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="go-properties"){f=e.blockElement.querySelector(".av__views").getBoundingClientRect(),d.innerHTML=St(g),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="go-layout"){d.innerHTML=getLayoutHTML(c),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),bindLayoutEvent({protyle:e.protyle,data:c,menuElement:d,blockElement:e.blockElement}),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="goSorts"){d.innerHTML=getSortsHTML(g,c.view.sorts),bindSortsEvent(e.protyle,d,c,l),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="removeSorts"){transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:[],blockID:l}],[{action:"setAttrViewSorts",avID:n,data:c.view.sorts,blockID:l}]),c.view.sorts=[],d.innerHTML=getSortsHTML(g,c.view.sorts),bindSortsEvent(e.protyle,d,c,l),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="addSort"){addSort({data:c,rect:E.getBoundingClientRect(),menuElement:d,tabRect:f,avId:n,protyle:e.protyle,blockID:l}),y.preventDefault(),y.stopPropagation();break}else if(h==="removeSort"){const C=Object.assign([],c.view.sorts);c.view.sorts.find((A,S)=>{if(A.column===E.parentElement.dataset.id)return c.view.sorts.splice(S,1),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:n,data:c.view.sorts,blockID:l}],[{action:"setAttrViewSorts",avID:n,data:C,blockID:l}]),d.innerHTML=getSortsHTML(g,c.view.sorts),bindSortsEvent(e.protyle,d,c,l),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="goFilters"){d.innerHTML=getFiltersHTML(c),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="removeFilters"){transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:[],blockID:l}],[{action:"setAttrViewFilters",avID:n,data:c.view.filters,blockID:l}]),c.view.filters=[],d.innerHTML=getFiltersHTML(c),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="addFilter"){addFilter({data:c,rect:E.getBoundingClientRect(),menuElement:d,tabRect:f,avId:n,protyle:e.protyle,blockElement:e.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(h==="removeFilter"){window.siyuan.menus.menu.remove();const C=Object.assign([],c.view.filters);c.view.filters.find((A,S)=>{if(A.column===E.parentElement.dataset.id&&A.value.type===E.parentElement.dataset.filterType)return c.view.filters.splice(S,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:n,data:c.view.filters,blockID:l}],[{action:"setAttrViewFilters",avID:n,data:C,blockID:l}]),d.innerHTML=getFiltersHTML(c),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="setFilter"){c.view.filters.find(C=>{if(C.column===E.parentElement.parentElement.dataset.id&&C.value.type===E.parentElement.parentElement.dataset.filterType)return setFilter({empty:!1,filter:C,protyle:e.protyle,data:c,target:E,blockElement:e.blockElement}),!0}),y.preventDefault(),y.stopPropagation();break}else if(h==="numberFormat"){formatNumber({avPanelElement:a,element:E,protyle:e.protyle,oldFormat:E.dataset.format,colId:d.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:n}),y.preventDefault(),y.stopPropagation();break}else if(h==="newCol"){a.remove(),addCol(e.protyle,e.blockElement).open({x:f.right,y:f.bottom,h:f.height,isLeft:!0}),y.preventDefault(),y.stopPropagation();break}else if(h==="update-view-icon"){const C=E.getBoundingClientRect();openEmojiPanel("","av",{x:C.left,y:C.bottom+4,h:C.height,w:C.width},A=>{transaction(e.protyle,[{action:"setAttrViewViewIcon",avID:n,id:c.viewID,data:A}],[{action:"setAttrViewViewIcon",id:c.viewID,avID:n,data:E.dataset.icon}]),E.innerHTML=A?unicode2Emoji(A):'<svg style="width: 14px;height: 14px;"><use xlink:href="#iconTable"></use></svg>',E.dataset.icon=A},E.querySelector("img")),y.preventDefault(),y.stopPropagation();break}else if(h==="set-page-size"){setPageSize({target:E,protyle:e.protyle,avID:n,nodeElement:e.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(h==="duplicate-view"){const C=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:n,previousID:c.viewID,id:C,blockID:l}],[{action:"removeAttrViewView",avID:n,id:C,blockID:l}]),a.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="delete-view"){transaction(e.protyle,[{action:"removeAttrViewView",avID:n,id:c.viewID,blockID:l}]),a.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="update-icon"){const C=E.getBoundingClientRect();openEmojiPanel("","av",{x:C.left,y:C.bottom+4,h:C.height,w:C.width},A=>{const S=d.querySelector(".b3-menu__item").getAttribute("data-col-id");if(transaction(e.protyle,[{action:"setAttrViewColIcon",id:S,avID:n,data:A}],[{action:"setAttrViewColIcon",id:S,avID:n,data:E.dataset.icon}]),E.innerHTML=A?unicode2Emoji(A):`<svg style="height: 14px;width: 14px"><use xlink:href="#${getColIconByType(E.dataset.colType)}"></use></svg>`,r){const L=e.blockElement.querySelector(`.av__row[data-col-id="${S}"] .block__logoicon`);L.outerHTML=A?unicode2Emoji(A,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(L.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${S}"]`),void 0,{icon:A});E.dataset.icon=A},E.querySelector("img")),y.preventDefault(),y.stopPropagation();break}else if(h==="showAllCol"){const C=[],A=[];g.forEach(S=>{S.hidden&&(C.push({action:"setAttrViewColHidden",id:S.id,avID:n,data:!1,blockID:l}),A.push({action:"setAttrViewColHidden",id:S.id,avID:n,data:!0,blockID:l}),S.hidden=!1)}),C.length>0&&(transaction(e.protyle,C,A),d.innerHTML=St(g),setPosition(d,f.right-d.clientWidth,f.bottom,f.height)),y.preventDefault(),y.stopPropagation();break}else if(h==="hideAllCol"){const C=[],A=[];g.forEach(S=>{!S.hidden&&S.type!=="block"&&(C.push({action:"setAttrViewColHidden",id:S.id,avID:n,data:!0,blockID:l}),A.push({action:"setAttrViewColHidden",id:S.id,avID:n,data:!1,blockID:l}),S.hidden=!0)}),C.length>0&&(transaction(e.protyle,C,A),d.innerHTML=St(g),setPosition(d,f.right-d.clientWidth,f.bottom,f.height)),y.preventDefault(),y.stopPropagation();break}else if(h==="editCol"){d.innerHTML=getEditHTML({protyle:e.protyle,data:c,colId:E.dataset.id,isCustomAttr:r}),bindEditEvent({protyle:e.protyle,data:c,menuElement:d,isCustomAttr:r,blockID:l}),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="updateColType"){const C=e.colId||d.querySelector(".b3-menu__item").getAttribute("data-col-id");if(E.dataset.newType!==E.dataset.oldType){const S=a.querySelector('.b3-text-field[data-type="name"]').value;let L=S;if(g.find($=>{if($.id===C)return $.type=E.dataset.newType,getColNameByType(E.dataset.oldType)===S&&(L=getColNameByType(E.dataset.newType),$.name=L),!0}),transaction(e.protyle,[{action:"updateAttrViewCol",id:C,avID:n,name:L,type:E.dataset.newType}],[{action:"updateAttrViewCol",id:C,avID:n,name:S,type:E.dataset.oldType}]),E.dataset.newType==="lineNumber"){if(c.view.sorts.find(D=>D.column===C)){const D=Object.assign([],c.view.sorts),M=c.view.sorts.filter(P=>P.column!==C);transaction(e.protyle,[{action:"setAttrViewSorts",avID:c.id,data:M,blockID:l}],[{action:"setAttrViewSorts",avID:c.id,data:D,blockID:l}])}if(c.view.filters.find(D=>D.column===C)){const D=JSON.parse(JSON.stringify(c.view.filters)),M=c.view.filters.filter(P=>P.column!==C);transaction(e.protyle,[{action:"setAttrViewFilters",avID:c.id,data:M,blockID:l}],[{action:"setAttrViewFilters",avID:c.id,data:D,blockID:l}])}}}d.innerHTML=getEditHTML({protyle:e.protyle,data:c,colId:C,isCustomAttr:r}),bindEditEvent({protyle:e.protyle,data:c,menuElement:d,isCustomAttr:r,blockID:l}),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="goUpdateColType"){const C=hasClosestByClassName(E,"b3-menu");C&&(C.firstElementChild.classList.add("fn__none"),C.lastElementChild.classList.remove("fn__none")),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="goSearchAV"){openSearchAV(n,E,void 0,!1),y.preventDefault(),y.stopPropagation();break}else if(h==="goSearchRollupCol"){goSearchRollupCol({target:E,data:c,isRelation:!0,protyle:e.protyle,colId:e.colId||d.querySelector(".b3-menu__item").getAttribute("data-col-id")}),y.preventDefault(),y.stopPropagation();break}else if(h==="goSearchRollupTarget"){goSearchRollupCol({target:E,data:c,isRelation:!1,protyle:e.protyle,colId:e.colId||d.querySelector(".b3-menu__item").getAttribute("data-col-id")}),y.preventDefault(),y.stopPropagation();break}else if(h==="goSearchRollupCalc"){openCalcMenu(e.protyle,E,{data:c,colId:e.colId||d.querySelector(".b3-menu__item").getAttribute("data-col-id"),blockID:l}),y.preventDefault(),y.stopPropagation();break}else if(h==="updateRelation"){updateRelation({protyle:e.protyle,avElement:a,avID:n,colsData:g,blockElement:e.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(h==="goEditCol"){const C=hasClosestByClassName(E,"b3-menu");C&&(C.firstElementChild.classList.remove("fn__none"),C.lastElementChild.classList.add("fn__none")),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="hideCol"){const C=d.querySelector('[data-type="go-properties"]'),A=C?d.querySelector(".b3-menu__item").getAttribute("data-col-id"):E.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:A,avID:n,data:!0,blockID:l}],[{action:"setAttrViewColHidden",id:A,avID:n,data:!1,blockID:l}]),g.find(S=>S.id===A).hidden=!0,C?(d.innerHTML=getEditHTML({protyle:e.protyle,data:c,colId:A,isCustomAttr:r}),bindEditEvent({protyle:e.protyle,data:c,menuElement:d,isCustomAttr:r,blockID:l})):d.innerHTML=St(g),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="showCol"){const C=d.querySelector('[data-type="go-properties"]'),A=C?d.querySelector(".b3-menu__item").getAttribute("data-col-id"):E.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:A,avID:n,data:!1,blockID:l}],[{action:"setAttrViewColHidden",id:A,avID:n,data:!0,blockID:l}]),g.find(S=>S.id===A).hidden=!1,C?(d.innerHTML=getEditHTML({protyle:e.protyle,data:c,colId:A,isCustomAttr:r}),bindEditEvent({protyle:e.protyle,data:c,menuElement:d,isCustomAttr:r,blockID:l})):d.innerHTML=St(g),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="duplicateCol"){duplicateCol({blockElement:e.blockElement,protyle:e.protyle,colId:d.querySelector(".b3-menu__item").getAttribute("data-col-id"),data:c,viewID:c.viewID}),y.preventDefault(),y.stopPropagation();break}else if(h==="removeCol"){r||(f=e.blockElement.querySelector(".av__views").getBoundingClientRect());const C=d.querySelector(".b3-menu__item").getAttribute("data-col-id"),A=g.find(L=>{if(L.id===C)return!0}),S=A.type==="relation"&&((_=A.relation)==null?void 0:_.isTwoWay);if(r||S){const L=new Dialog({title:S?window.siyuan.languages.removeColConfirm:window.siyuan.languages.deleteOpConfirm,content:`<div class="b3-dialog__content">
    ${S?window.siyuan.languages.confirmRemoveRelationField.replace("${x}",d.querySelector("input").value||window.siyuan.languages._kernel[272]).replace("${y}",d.querySelector('.b3-menu__item[data-type="goSearchAV"] .b3-menu__accelerator').textContent).replace("${z}",d.querySelector('input[data-type="colName"]').value||window.siyuan.languages._kernel[272]):window.siyuan.languages.removeCol.replace("${x}",d.querySelector("input").value||window.siyuan.languages._kernel[272])}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${S?window.siyuan.languages.removeBothRelationField:window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove${S?"":" fn__none"}" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`,width:"520px"});L.element.addEventListener("click",$=>{let R=$.target;const D=typeof $.detail=="string";for(;R&&R!==L.element||D;){const M=R.getAttribute("data-action");if(M==="delete"||D&&$.detail==="Enter"){removeCol({protyle:e.protyle,fields:g,avID:n,blockID:l,menuElement:d,isCustomAttr:r,blockElement:e.blockElement,avPanelElement:a,tabRect:f,isTwoWay:!0}),L.destroy();break}else if(M==="keep-relation"){removeCol({protyle:e.protyle,fields:g,avID:n,blockID:l,menuElement:d,isCustomAttr:r,blockElement:e.blockElement,avPanelElement:a,tabRect:f,isTwoWay:!1}),L.destroy();break}else if(R.classList.contains("b3-button--cancel")||D&&$.detail==="Escape"){L.destroy();break}R=R.parentElement}}),L.element.setAttribute("data-key",Constants.DIALOG_CONFIRM)}else removeCol({protyle:e.protyle,fields:g,avID:n,blockID:l,menuElement:d,isCustomAttr:r,blockElement:e.blockElement,avPanelElement:a,tabRect:f,isTwoWay:!1});y.preventDefault(),y.stopPropagation();break}else if(h==="setColOption"){setColOption(e.protyle,c,E,e.blockElement,r,e.cellElements),y.preventDefault(),y.stopPropagation();break}else if(h==="setRelationCell"){(k=d.querySelector(".b3-menu__item--current"))==null||k.classList.remove("b3-menu__item--current"),E.classList.add("b3-menu__item--current"),setRelationCell(e.protyle,e.blockElement,E,e.cellElements),y.preventDefault(),y.stopPropagation();break}else if(h==="addColOptionOrCell"){(x=d.querySelector(".b3-menu__item--current"))==null||x.classList.remove("b3-menu__item--current"),E.classList.add("b3-menu__item--current"),E.querySelector(".b3-menu__checked")?removeCellOption(e.protyle,e.cellElements,d.querySelector(`.b3-chips .b3-chip[data-content="${escapeAttr(E.dataset.name)}"]`),e.blockElement):addColOptionOrCell(e.protyle,c,e.cellElements,E,d,e.blockElement),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="removeCellOption"){removeCellOption(e.protyle,e.cellElements,E.parentElement,e.blockElement),y.preventDefault(),y.stopPropagation();break}else if(h==="addAssetLink"){addAssetLink(e.protyle,e.cellElements,E,e.blockElement),y.preventDefault(),y.stopPropagation();break}else if(h==="addAssetExist"){const C=E.getBoundingClientRect();assetMenu(e.protyle,{x:C.right,y:C.bottom,w:E.parentElement.clientWidth+8,h:C.height},(A,S)=>{let L;Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(A).toLowerCase())?L={type:"image",content:A,name:""}:L={type:"file",content:A,name:S},updateAssetCell({protyle:e.protyle,cellElements:e.cellElements,addValue:[L],blockElement:e.blockElement}),window.siyuan.menus.menu.remove()}),y.preventDefault(),y.stopPropagation();break}else if(h==="openAssetItem"){const C=E.parentElement.dataset.content,A=pathPosix().extname(C);Constants.SIYUAN_ASSETS_IMAGE.includes(A)?previewAttrViewImages(C,n,e.blockElement.getAttribute(Constants.CUSTOM_SY_AV_VIEW),((T=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:T.value.trim())||""):window.open(C),y.preventDefault(),y.stopPropagation();break}else if(h==="editAssetItem"){editAssetItem({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,content:E.parentElement.dataset.content,type:E.parentElement.dataset.type,name:E.parentElement.dataset.name,index:parseInt(E.parentElement.dataset.index),rect:E.parentElement.getBoundingClientRect()}),y.preventDefault(),y.stopPropagation();break}else if(h==="clearDate"){const C=g.find(A=>{if(A.id===getColId(e.cellElements[0],c.viewType))return!0});updateCellsValue(e.protyle,e.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:C.date?!C.date.fillSpecificTime:!0},e.cellElements),a.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="av-add"){window.siyuan.menus.menu.remove(),addView(e.protyle,e.blockElement),a.remove(),y.preventDefault(),y.stopPropagation();break}else if(h==="av-view-switch"){E.parentElement.classList.contains("b3-menu__item--current")||((w=a.querySelector(".b3-menu__item--current"))==null||w.classList.remove("b3-menu__item--current"),E.parentElement.classList.add("b3-menu__item--current"),transaction(e.protyle,[{action:"setAttrViewBlockView",blockID:l,id:E.parentElement.dataset.id,avID:n}],[{action:"setAttrViewBlockView",blockID:l,id:e.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:n}])),y.preventDefault(),y.stopPropagation();break}else if(h==="av-view-edit"){E.parentElement.classList.contains("b3-menu__item--current")?openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:E.parentElement}):((v=a.querySelector(".b3-menu__item--current"))==null||v.classList.remove("b3-menu__item--current"),E.parentElement.classList.add("b3-menu__item--current"),transaction(e.protyle,[{action:"setAttrViewBlockView",blockID:l,id:E.parentElement.dataset.id,avID:n}],[{action:"setAttrViewBlockView",blockID:l,id:e.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:n}]),window.siyuan.menus.menu.remove(),openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:E.parentElement})),y.preventDefault(),y.stopPropagation();break}else if(h==="set-gallery-cover"){setGalleryCover({target:E,protyle:e.protyle,nodeElement:e.blockElement,view:c.view}),y.preventDefault(),y.stopPropagation();break}else if(h==="set-gallery-size"){setGallerySize({target:E,protyle:e.protyle,nodeElement:e.blockElement,view:c.view}),y.preventDefault(),y.stopPropagation();break}else if(h==="set-gallery-ratio"){setGalleryRatio({target:E,protyle:e.protyle,nodeElement:e.blockElement,view:c.view}),y.preventDefault(),y.stopPropagation();break}else if(h==="set-layout"){c=yield updateLayout({target:E,protyle:e.protyle,nodeElement:e.blockElement,data:c}),g=getFieldsByData(c),y.preventDefault(),y.stopPropagation();break}else if(h==="goGroupsDate"){goGroupsDate({target:E,menuElement:d,protyle:e.protyle,blockElement:e.blockElement,data:c}),g=getFieldsByData(c),y.stopPropagation(),y.preventDefault();break}else if(h==="goGroupsSort"){goGroupsSort({target:E,menuElement:d,protyle:e.protyle,blockElement:e.blockElement,data:c}),g=getFieldsByData(c),y.stopPropagation(),y.preventDefault();break}else if(h==="setGroupMethod"){setGroupMethod({protyle:e.protyle,fieldId:E.getAttribute("data-id"),data:c,menuElement:d,blockElement:e.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(h==="goGroups"){d.querySelector('[data-type="avGroupRange"]')&&m&&(yield m()),m=void 0,c.view.group&&c.view.group.field||E.classList.contains("block__icon")?(d.innerHTML=getGroupsHTML(g,c.view),bindGroupsEvent({protyle:e.protyle,menuElement:d,blockElement:e.blockElement,data:c})):d.innerHTML=getGroupsMethodHTML(g,c.view.group),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="goGroupsMethod"){window.siyuan.menus.menu.remove(),d.innerHTML=getGroupsMethodHTML(g,c.view.group),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}else if(h==="getGroupsNumber"){window.siyuan.menus.menu.remove(),d.innerHTML=getGroupsNumberHTML(c.view.group),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),m=bindGroupsNumber({protyle:e.protyle,data:c,menuElement:d,blockElement:e.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(h==="hideGroup"){window.siyuan.menus.menu.remove();const C=E.firstElementChild,A=C.getAttribute("xlink:href")!=="#iconEye";C.setAttribute("xlink:href",A?"#iconEye":"#iconEyeoff");let S,L=0;c.view.groups.forEach($=>{$.id===E.dataset.id&&(S=$.groupHidden,$.groupHidden=A?0:2),$.groupHidden===0&&L++}),E.parentElement.classList[A?"remove":"add"]("b3-menu__item--hidden"),d.querySelector('[data-type="hideGroups"]').innerHTML=`${window.siyuan.languages[L===0?"showAll":"hideAll"]}
<span class="fn__space"></span>
<svg><use xlink:href="#iconEye${L===0?"":"off"}"></use></svg>`,transaction(e.protyle,[{action:"hideAttrViewGroup",avID:c.id,blockID:l,id:E.dataset.id,data:A?0:2}],[{action:"hideAttrViewGroup",avID:c.id,blockID:l,id:E.dataset.id,data:S}]),y.preventDefault(),y.stopPropagation();break}else if(h==="hideGroups"){window.siyuan.menus.menu.remove();const C=E.querySelector("use").getAttribute("xlink:href")==="#iconEyeoff";E.innerHTML=`${window.siyuan.languages[C?"showAll":"hideAll"]}
<span class="fn__space"></span>
<svg><use xlink:href="#iconEye${C?"":"off"}"></use></svg>`,c.view.groups.forEach(A=>{var S;A.groupHidden=C?2:0;const L=E.parentElement.parentElement.querySelector(`.b3-menu__item[data-id="${A.id}"]`);L.classList[C?"add":"remove"]("b3-menu__item--hidden"),(S=L.querySelector(".b3-menu__action use"))==null||S.setAttribute("xlink:href",`#iconEye${C?"off":""}`)}),transaction(e.protyle,[{action:"hideAttrViewAllGroups",avID:c.id,blockID:l,data:C}],[{action:"hideAttrViewAllGroups",avID:c.id,blockID:l,data:!C}]),y.preventDefault(),y.stopPropagation();break}else if(h==="removeGroups"){window.siyuan.menus.menu.remove(),transaction(e.protyle,[{action:"removeAttrViewGroup",avID:c.id,blockID:l}],[{action:"setAttrViewGroup",avID:c.id,blockID:l,data:c.view.group}]),c.view.group=null,delete c.view.groups,d.innerHTML=getGroupsHTML(g,c.view),setPosition(d,f.right-d.clientWidth,f.bottom,f.height),y.preventDefault(),y.stopPropagation();break}if(!E||!E.parentElement)break;E=E.parentElement}}))})},St=e=>{let t="",a="";return e.forEach(n=>{n.hidden?a+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${n.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`}
        ${escapeHtml(n.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`:t+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${n.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`}
        ${escapeHtml(n.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action${n.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`}),a&&(a=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${a}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.fields}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${t}
${a}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},Ba=e=>e&&e.replace(/&/g,"&amp;").replace(/</g,"&lt;"),Mg=e=>e.replace(/</g,"&lt;"),Lt=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),Zo=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;"),ti=e=>e.startsWith("assets/")&&(e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg"))?e+"?style=thumb":e,$g=e=>e.startsWith("assets/")&&(e.endsWith(".png?style=thumb")||e.endsWith(".jpg?style=thumb")||e.endsWith(".jpeg?style=thumb"))?e.replace("?style=thumb",""):e;var Xo=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const ai=e=>{let t=e,a="";try{const n=new URL(e);n.protocol.startsWith("http")&&(t=n.host,a=n.href.replace(n.origin,""),a.length>12&&(a=a.substring(0,4)+"..."+a.substring(a.length-6)))}catch(n){t=Lute.EscapeHTMLStr(e)}return`<span class="av__celltext av__celltext--url" data-type="url" data-href="${Lt(e)}"><span>${t}</span><span class="ft__on-surface">${a}</span></span>`},Jo=e=>{if(!e)return"";let t="";const a=e.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return a.length>0?(a.forEach(n=>{n.querySelector(".av__cellicon")?t+=`${n.firstChild.textContent} \u2192 ${n.lastChild.textContent}, `:n.getAttribute("data-type")==="url"?t=n.getAttribute("data-href")+", ":n.getAttribute("data-type")!=="block-more"&&(t+=n.textContent+", ")}),t=t.substring(0,t.length-2)):t=e.textContent,t},ni=(e,t)=>{var a;const n={type:e,id:t.dataset.id};if(e==="number"){const i=t.querySelector(".av__celltext").getAttribute("data-content");n.number={content:parseFloat(i)||0,isNotEmpty:!!i}}else if(["text","block","url","phone","email","template"].includes(e)){const i=t.querySelector(".av__celltext");if(n[e]={content:e==="url"?i.dataset.href:i.textContent},e==="block"&&i.dataset.id&&(n.block.id=i.dataset.id,(a=i.previousElementSibling)!=null&&a.classList.contains("b3-menu__avemoji"))){const s=i.previousElementSibling.getAttribute("data-unicode");s&&(n.block.icon=s)}}else if(e==="mSelect"||e==="select"){const i=[];t.querySelectorAll(".b3-chip").forEach(s=>{i.push({content:s.textContent.trim(),color:s.style.color.replace("var(--b3-font-color","").replace(")","")})}),n.mSelect=i}else if(["date","created","updated"].includes(e))n[e]=JSON.parse(t.querySelector(".av__celltext").getAttribute("data-value"));else if(e==="checkbox")n.checkbox={checked:t.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(e==="relation"){const i=[],s=[];Array.from(t.querySelectorAll(".av__cell--relation")).forEach(o=>{const l=o.querySelector(".av__celltext");i.push(o.dataset.rowId),s.push({isDetached:!l.classList.contains("av__celltext--ref"),block:{content:l.textContent,id:l.dataset.id},type:"block"})}),n.relation={blockIDs:i,contents:s}}else if(e==="mAsset"){const i=[];Array.from(t.children).forEach(s=>{if(!s.classList.contains("av__celltext--url")&&!s.classList.contains("av__cellassetimg"))return;const o=s.classList.contains("av__cellassetimg");i.push({type:o?"image":"file",content:o?removeCompressURL(s.getAttribute("src")):s.getAttribute("data-url"),name:o?"":s.getAttribute("data-name")})}),n.mAsset=i}return e==="block"&&(n.isDetached=t.dataset.detached==="true"),n},Rt=e=>{if(["number","text","block","url","phone","email","template","mAsset"].includes(e.type))return e[e.type].content;if(["mSelect","select"].includes(e.type))return e.mSelect[0].content;if(e.type==="rollup")return Rt(e.relation.contents[0]);if(e.type==="checkbox")return e.checkbox.checked?"true":"false";if(e.type==="relation")return Rt(e.relation.contents[0]);if(["date","created","updated"].includes(e.type))return dayjs(e[e.type].content).format("YYYY-MM-DD HH:mm");if(e.type==="lineNumber")return""},Qo=(e,t)=>{if(e===t.type)return t;const a={type:e};if(e==="number")["date","created","updated"].includes(e)?a.number={content:t[t.type].content,isNotEmpty:t[t.type].isNotEmpty}:a.number={content:parseFloat(Rt(t))||0,isNotEmpty:!0};else if(["text","block","url","phone","email","template"].includes(e))a[e]={content:Rt(t).toString()};else if(e==="mSelect"||e==="select")a.mSelect=[{content:Rt(t).toString(),color:"1"}],a.mSelect[0].content||(a.mSelect=[]);else if(e==="rollup")a.rollup={contents:[t]};else if(e==="checkbox")a.checkbox={checked:!0};else if(e==="relation")t.type==="block"?a.relation={blockIDs:[t.blockID],contents:[t]}:a.relation={blockIDs:[],contents:[]};else if(e==="mAsset"){const n=Rt(t).toString();a.mAsset=[{type:Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(n).toLowerCase())?"image":"file",content:n,name:""}]}else if(["date","created","updated"].includes(e))["date","created","updated"].includes(t.type)?a[e]=JSON.parse(JSON.stringify(t[t.type])):a[e]={content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0};else if(e==="lineNumber")return{type:"lineNumber"};return a},er=(e,t)=>{let a={type:e,[e==="select"?"mSelect":e]:t};if(typeof t=="string"&&t){if(e==="number")a={type:e,number:{content:parseFloat(t)||0,isNotEmpty:!0}};else if(["text","block","url","phone","email","template"].includes(e))a={type:e,[e]:{content:t}};else if(e==="mSelect"||e==="select")a={type:e,mSelect:[{content:t,color:"1"}]};else if(e==="checkbox")a={type:e,checkbox:{checked:!0}};else if(e==="date"){let n=t.split("\u2192");n.length!==2&&(n=t.split("-"),n.length!==2&&(n=t.split("~")));const i=dayjs(n[0]),s=dayjs(n[1]||"");isNaN(i.valueOf())?a={type:e,date:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,formattedContent:"",hasEndDate:!1,isNotTime:!0}}:a={type:e,date:{content:i.valueOf(),isNotEmpty:!0,content2:s.valueOf()||0,isNotEmpty2:!isNaN(s.valueOf()),hasEndDate:!isNaN(s.valueOf()),isNotTime:i.hour()===0&&n[0].split(":").length===1,formattedContent:""}}}else if(e==="relation")a={type:e,relation:{blockIDs:[t],contents:[]}};else if(e==="mAsset"){const n=pathPosix().extname(t).toLowerCase();a={type:e,mAsset:[{type:Constants.SIYUAN_ASSETS_IMAGE.includes(n)?"image":"file",content:t,name:""}]}}}else(typeof t=="undefined"||!t)&&(e==="number"?a={type:e,number:{content:0,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(e)?a={type:e,[e]:{content:""}}:e==="mSelect"||e==="select"||e==="mAsset"?a={type:e,[e==="select"?"mSelect":e]:[]}:["date","created","updated"].includes(e)?a={type:e,[e]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:e==="checkbox"?a={type:e,checkbox:{checked:!1}}:e==="relation"?a={type:e,relation:{blockIDs:[],contents:[]}}:e==="rollup"&&(a={type:e,rollup:{contents:[]}}));return e==="block"&&(typeof t=="object"&&t&&t.id?a.isDetached=!1:a.isDetached=!0),a},si=(e,t,a=!0)=>{const n=t.getBoundingClientRect();if(!a){const s=e.querySelector(".av__scroll"),o=U(t,"av__row");if(s&&o){const l=o.querySelector(".av__colsticky");if(!l.contains(t)){const r=l.getBoundingClientRect().right,c=s.getBoundingClientRect();r>n.left||c.right<n.left?s.scrollLeft=s.scrollLeft+n.left-r:r<n.left&&c.right<n.right&&(n.width+r>c.right?s.scrollLeft=s.scrollLeft+n.left-r:s.scrollLeft=s.scrollLeft+n.right-c.right)}}}const i=U(e,"protyle-content",!0);if(i&&t.getAttribute("data-dtype")!=="checkbox"){const s=document.getElementById("keyboardToolbar"),o=parseInt(s.getAttribute("data-keyboardheight"))||window.outerHeight/2-42;n.bottom>window.innerHeight-o-42?i.scrollTop+=n.bottom-window.innerHeight+42+o:n.top<110&&(i.scrollTop-=110-n.top)}},Pn=e=>{if(e.parentElement.classList.contains("av__gallery-field"))return e.getAttribute("data-dtype");const t=hasClosestByClassName(e,"av__scroll");if(t)return t.querySelector(".av__row--header").querySelector(`[data-col-id="${e.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},Hg=(e,t,a)=>{var n;if(t.length===0||t.length===1&&!t[0]||(a||(a=Pn(t[0])),a==="updated"||a==="created"||document.querySelector(".av__mask")))return;const i=hasClosestBlock(t[0]);if(!i)return;const s=i.getAttribute("data-av-type");let o=t[0].getBoundingClientRect();const l=hasClosestByClassName(i,"protyle-content",!0);s==="table"&&si(i,t[0],!1),o=t[0].getBoundingClientRect();let r="",c=o.height;const u=getComputedStyle(t[0]);let g=`font-family:${u.fontFamily};font-size:${u.fontSize};line-height:${u.lineHeight};padding:${u.padding};position:absolute;top: ${o.top}px;`;if(l){const b=l.getBoundingClientRect();o.bottom>b.bottom&&(c=b.bottom-o.top);const p=Math.min(Math.max(o.width,25),b.width);g=`style='height: ${c}px;width:${p}px;left: ${o.left<b.left||o.left+p>b.right?b.left:o.left}px;${g}'`}else g=`style='height: ${c}px;width:${Math.max(o.width,25)}px;left: ${o.left}px;${g}'`;if(["text","email","phone","block","template"].includes(a))r=`<textarea ${g} spellcheck="false" class="b3-text-field"></textarea>`;else if(a==="url")r=`<textarea ${g} spellcheck="false" class="b3-text-field">${t[0].firstElementChild.getAttribute("data-href")}</textarea>`;else if(a==="number")r=`<input type="number" spellcheck="false" value="${t[0].firstElementChild.getAttribute("data-content")}" ${g} class="b3-text-field">`;else{if(["select","mSelect"].includes(a)){if(i.getAttribute("data-rendering")==="true")return;openMenuPanel({protyle:e,blockElement:i,type:"select",cellElements:t})}else a==="mAsset"?(openMenuPanel({protyle:e,blockElement:i,type:"asset",cellElements:t}),focusBlock(i)):a==="date"?openMenuPanel({protyle:e,blockElement:i,type:"date",cellElements:t}):a==="checkbox"?Rn(e,a,i,t):a==="relation"?openMenuPanel({protyle:e,blockElement:i,type:"relation",cellElements:t}):a==="rollup"&&openMenuPanel({protyle:e,blockElement:i,type:"rollup",cellElements:t,colId:getColId(t[0],s)});s==="table"&&!hasClosestByClassName(t[0],"custom-attr")&&(t[0].classList.add("av__cell--select"),Ra(t[0]));return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${r}
</div>`);const m=document.querySelector(".av__mask"),d=m.querySelector(".b3-text-field");d&&(["text","email","phone","block","template"].includes(a)&&(d.value=((n=t[0].querySelector(".av__celltext"))==null?void 0:n.textContent)||""),d.select(),d.focus(),a==="template"&&fetchPost("/api/av/renderAttributeView",{id:i.dataset.avId,viewID:i.getAttribute(Constants.CUSTOM_SY_AV_VIEW)},b=>{getFieldsByData(b.data).find(p=>{if(p.id===getColId(t[0],s))return d.value=p.template,d.dataset.template=p.template,!0})}),a==="block"&&d.addEventListener("input",b=>{if(Constants.BLOCK_HINT_KEYS.includes(d.value.substring(0,2))){if(e.toolbar.range=document.createRange(),t[0]&&!i.contains(t[0])){const y=getFieldIdByCellElement(t[0],s);s==="table"?t[0]=i.querySelector(`.av__row[data-id="${y}"] .av__cell[data-col-id="${t[0].dataset.colId}"]`):t[0]=i.querySelector(`.av__gallery-item[data-id="${y}"] .av__cell[data-field-id="${t[0].dataset.fieldId}"]`)}e.toolbar.range.selectNodeContents(t[0].lastChild),focusByRange(e.toolbar.range),s==="table"&&(t[0].classList.add("av__cell--select"),Ra(t[0]));let p=d.value;isDynamicRef(p)?p=p.substring(2,24):p=p.substring(2),hintRef(p,e,"av"),m==null||m.remove(),b.preventDefault(),b.stopPropagation()}}),d.addEventListener("keydown",b=>{b.isComposing||electronUndo(b)||(b.key==="Escape"||b.key==="Tab"||b.key==="Enter"&&!b.shiftKey&&isNotCtrl(b))&&(Rn(e,a,i,t),b.key==="Tab"&&e.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:b.shiftKey,ctrlKey:b.ctrlKey,altKey:b.altKey,metaKey:b.metaKey,key:"Tab",keyCode:9})),b.preventDefault(),b.stopPropagation())}));const f=b=>{b.target.classList.contains("av__mask")&&document.activeElement.tagName!=="TEXTAREA"&&document.activeElement.tagName!=="INPUT"&&(Rn(e,a,i,t),m==null||m.remove())};m.addEventListener("click",b=>{f(b)}),m.addEventListener("contextmenu",b=>{f(b)}),m.addEventListener("mousedown",b=>{b.button===1&&(b.target.classList.contains("av__mask")&&document.activeElement&&document.activeElement.nodeType===1&&document.activeElement.blur(),f(b))})},Rn=(e,t,a,n)=>{const i=a.getAttribute("data-av-type");if(i==="table"){const l=hasClosestByClassName(n[0],"av__row");if(!l||n.length===1&&n[0].dataset.detached==="true"&&!l.dataset.id)return}const s=document.querySelector(".av__mask"),o=a.getAttribute("data-av-id");if(t==="template"){const l=getColId(n[0],i),r=s.querySelector(".b3-text-field");r.value!==r.dataset.template&&!a.getAttribute("data-loading")&&(transaction(e,[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.dataset.template,type:"template"}]),a.setAttribute("data-loading","true"))}else tr(e,a,t==="checkbox"?{checked:n[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:s.querySelector(".b3-text-field").value,n);i==="table"&&n[0]&&!hasClosestByClassName(n[0],"custom-attr")&&(n[0].classList.add("av__cell--select"),Ra(n[0])),document.querySelector(".b3-dialog")||focusBlock(a),document.querySelectorAll(".av__mask").forEach(l=>{l.remove()})},tr=(e,t,a,n,i,s,o=!1)=>Xo(void 0,null,function*(){const l=[],r=[],c=t.dataset.avId,u=t.dataset.nodeId;let g="";const m=[];let d;(n==null?void 0:n.length)>0?d=n:(d=Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select")),d.length===0&&t.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(p=>{p.querySelectorAll(".av__cell").forEach(y=>{d.push(y)})}));const f=hasClosestByClassName(d[0],"custom-attr"),b=t.getAttribute("data-av-type");for(let p=0;p<d.length;p++){let y=d[p];const _=getFieldIdByCellElement(y,b);if(!_||(t.contains(y)||(b==="table"?y=d[p]=t.querySelector(`.av__row[data-id="${_}"] .av__cell[data-col-id="${y.dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${y.dataset.colId}"]`):y=d[p]=t.querySelector(`.av__gallery-item[data-id="${_}"] .av__cell[data-field-id="${y.dataset.fieldId}"]`)),!y))break;const k=Pn(y)||y.dataset.type;if(["created","updated","template","rollup"].includes(k))break;const x=y.dataset.id,T=getColId(y,b);g+=Jo(y)+(d[p+1]&&y.nextElementSibling&&y.nextElementSibling===d[p+1]?"	":`

`);const w=ni(k,y);(p===0||d[p-1]!==y.previousElementSibling)&&m.push([]),m[m.length-1].push(w);let v=a;if(k==="mAsset"){if(Array.isArray(a))v=w.mAsset.concat(a);else if(typeof a!="undefined"&&typeof a!="object"){let E=e.lute.GetLinkDest(a),C="",A="";if(!E&&a.startsWith("assets/")&&(E=a,C=getAssetName(a)+pathPosix().extname(a)),s){const S=document.createElement("template");S.innerHTML=s;const L=S.content.querySelector('[data-type~="a"]');if(L)E=L.getAttribute("data-href"),C=L.textContent;else{const $=S.content.querySelector(".img img");$&&(A=$.getAttribute("data-src"))}}if(E||(C=a),!E&&!C&&!A)break;A?v=w.mAsset.concat({type:"image",content:A,name:""}):v=w.mAsset.concat({type:"file",content:E,name:C})}}else if(k==="mSelect"||k==="select"){if(typeof a=="string"){const E=[];let C=w.mSelect.length;[...new Set(a.split(",").map(A=>A.trim().replace(/\n|\r\n|\r|\u2028|\u2029/g,"")))].forEach(A=>{if(!A)return;let S=!1;w.mSelect.find(L=>{if(L.content===A)return S=!0,!0}),!S&&(C++,E.push({content:A,color:C.toString()}))}),v=w.mSelect.concat(E)}}else k==="block"&&typeof a=="string"&&w.block.id&&(v={content:a,id:w.block.id},w.block.icon&&(v.icon=w.block.icon));let h;if(typeof v=="object"&&v.type?h=Qo(k,v):h=er(k,v),h.id=x,h.type==="date"&&typeof h.date=="string"||h.type==="relation"&&typeof h.relation=="string")break;if(i&&(k==="select"||k==="mSelect")){const E=mergeAddOption(i.find(C=>C.id===T),h,c);l.push(...E.doOperations),r.push(...E.undoOperations)}if(k==="date"){if(!(a&&typeof a=="object"&&typeof a.isNotTime=="boolean")){const E=yield fetchSyncPost("/api/av/getAttributeViewKeysByID",{avID:c,keyIDs:[T]});E.data[0].date&&(h.date.isNotTime=!E.data[0].date.fillSpecificTime)}h.date.formattedContent=w.date.formattedContent}if(objEquals(h,w))break;l.push({action:"updateAttrViewCell",id:x,avID:c,keyID:T,rowID:_,data:h}),r.push({action:"updateAttrViewCell",id:x,avID:c,keyID:T,rowID:_,data:w}),f?y.innerHTML=genAVValueHTML(h):updateAttrViewCellAnimation(y,h)}return o?{doOperations:l,undoOperations:r}:(l.length>0&&(l.push({action:"doUpdateUpdated",id:u,data:dayjs().format("YYYYMMDDHHmmss")}),r.push({action:"doUpdateUpdated",id:u,data:t.getAttribute("updated")}),transaction(e,l,r)),{text:g.substring(0,g.length-2),json:m})}),ar=(e,t)=>{t.type==="checkbox"?t.checkbox.checked?(e.classList.add("av__cell-check"),e.classList.remove("av__cell-uncheck")):(e.classList.remove("av__cell-check"),e.classList.add("av__cell-uncheck")):t.type==="block"&&(t.isDetached?e.setAttribute("data-detached","true"):(e.querySelector(".av__celltext").setAttribute("data-id",t.block.id),e.removeAttribute("data-detached")))},Pa=(e,t=0,a=!0,n="table")=>{var i,s,o,l,r,c,u,g,m,d,f,b,p;let y="";if(e.type==="template")y=`<span class="av__celltext">${e&&e.template.content||""}</span>`;else if(e.type==="text")y=`<span class="av__celltext">${e?Lute.EscapeHTMLStr(e.text.content||""):""}</span>`;else if(["email","phone"].includes(e.type))y=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${e?Lute.EscapeHTMLStr(e[e.type].content||""):""}</span>`;else if(e.type==="url")y=ai(((i=e==null?void 0:e.url)==null?void 0:i.content)||"");else if(e.type==="block")e!=null&&e.isDetached?y=`<span class="av__celltext">${Lute.EscapeHTMLStr(e.block.content||"")}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:y=`<span class="b3-menu__avemoji${a?"":" fn__none"}" data-unicode="${e.block.icon||""}">${ve(e.block.icon||window.siyuan.storage[H.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(e.block.content)}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(e.type==="number")y=`<span class="av__celltext" data-content="${e!=null&&e.number.isNotEmpty?e==null?void 0:e.number.content:""}">${(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content)||""}</span>`;else if(e.type==="mSelect"||e.type==="select")(s=e==null?void 0:e.mSelect)==null||s.forEach((_,k)=>{e.type==="select"&&k>0||(y+=`<span class="b3-chip" style="background-color:var(--b3-font-background${_.color});color:var(--b3-font-color${_.color})">${Ba(_.content)}</span>`)});else if(e.type==="date"){const _=e?e.date:null;y=`<span class="av__celltext" data-value='${JSON.stringify(_)}'>`,_&&_.isNotEmpty&&(y+=at(_.content).format(_.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),_&&_.hasEndDate&&_.isNotEmpty&&_.isNotEmpty2&&(y+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${at(_.content2).format(_.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),y+="</span>"}else if(["created","updated"].includes(e.type)){const _=e?e[e.type]:null;y=`<span class="av__celltext" data-value='${JSON.stringify(_)}'>`,_&&_.isNotEmpty&&(y+=at(_.content).format("YYYY-MM-DD HH:mm")),y+="</span>"}else if(["lineNumber"].includes(e.type))y=`<span class="av__celltext" data-value='${t+1}'>${t+1}</span>`;else if(e.type==="mAsset")(o=e==null?void 0:e.mAsset)==null||o.forEach(_=>{_.type==="image"?y+=`<img loading="lazy" class="av__cellassetimg ariaLabel" aria-label="${_.content}" src="${ti(_.content)}">`:y+=`<span class="b3-chip av__celltext--url ariaLabel" aria-label="${Lt(_.content)}" data-name="${Lt(_.name)}" data-url="${Lt(_.content)}">${_.name||_.content}</span>`});else if(e.type==="checkbox")y+=`<div class="fn__flex"><svg class="av__checkbox"><use xlink:href="#icon${(l=e==null?void 0:e.checkbox)!=null&&l.checked?"Check":"Uncheck"}"></use></svg>`,n==="gallery"&&((r=e==null?void 0:e.checkbox)!=null&&r.content)&&(y+=`<span class="fn__space"></span>${(c=e==null?void 0:e.checkbox)==null?void 0:c.content}`),y+="</div>";else if(e.type==="rollup"){let _;(g=(u=e==null?void 0:e.rollup)==null?void 0:u.contents)==null||g.forEach(k=>{const x=["template","select","mSelect","mAsset","relation"].includes(k.type)?Pa(k,t,a,n):nr(k,a);x&&(y+=x+(k.type==="checkbox"?"":", ")),_=k.type}),y&&(_==="checkbox"?y=`<div class="fn__flex">${y}</div>`:y.endsWith(", ")&&(y=y.substring(0,y.length-2)))}else e.type==="relation"&&((d=(m=e==null?void 0:e.relation)==null?void 0:m.contents)==null||d.forEach((_,k)=>{if(_&&_.block){const x=e.relation.blockIDs[k];_!=null&&_.isDetached?y+=`<span data-row-id="${x}" class="av__cell--relation"><span class="${a?"":" fn__none"}">\u2796<span class="fn__space--5"></span></span><span class="av__celltext">${Lute.EscapeHTMLStr(_.block.content||window.siyuan.languages.untitled)}</span></span>`:y+=`<span data-row-id="${x}" class="av__cell--relation" data-block-id="${_.block.id}"><span class="b3-menu__avemoji${a?"":" fn__none"}" data-unicode="${_.block.icon||""}">${ve(_.block.icon||window.siyuan.storage[H.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${_.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(_.block.content||window.siyuan.languages.untitled)}</span></span>`}}),y&&y.endsWith(", ")&&(y=y.substring(0,y.length-2)));return(["text","template","url","email","phone","date","created","updated"].includes(e.type)&&((f=e[e.type])!=null&&f.content)||e.type==="lineNumber"||e.type==="number"&&((b=e.number)!=null&&b.isNotEmpty)||e.type==="block"&&((p=e.block)!=null&&p.content))&&(y+=`<span ${e.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),y},nr=(e,t)=>{var a,n,i,s,o;let l="";if(["text"].includes(e.type))l=e&&e[e.type].content||"";else if(["email","phone"].includes(e.type)){const r=e?e[e.type].content:"";r&&(l=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${r}</span>`)}else if(e.type==="url"){const r=((a=e==null?void 0:e.url)==null?void 0:a.content)||"";r&&(l=ai(r))}else if(e.type==="block")e!=null&&e.isDetached?l=`<span class="av__celltext">${Lute.EscapeHTMLStr(((n=e.block)==null?void 0:n.content)||window.siyuan.languages.untitled)}</span>`:l=`<span class="b3-menu__avemoji${t?"":" fn__none"}" data-unicode="${e.block.icon||""}">${ve(e.block.icon||window.siyuan.storage[H.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${(i=e.block)==null?void 0:i.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(((s=e.block)==null?void 0:s.content)||window.siyuan.languages.untitled)}</span>`;else if(e.type==="number")l=(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content.toString())||"";else if(e.type==="checkbox")l+=`<svg class="av__checkbox"><use xlink:href="#icon${(o=e==null?void 0:e.checkbox)!=null&&o.checked?"Check":"Uncheck"}"></use></svg><span class="fn__space"></span>`;else if(["date","updated","created"].includes(e.type)){const r=e?e[e.type]:null;r.formattedContent?l=r.formattedContent:(r&&r.isNotEmpty&&(l=at(r.content).format(r.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),r&&r.hasEndDate&&r.isNotEmpty&&r.isNotEmpty2&&(l=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${at(r.content2).format(r.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),l&&(l=`<span class="av__celltext">${l}</span>`)}return l},Ng=(e,t)=>{var a;if(typeof t.icon!="undefined"&&(e.dataset.icon=t.icon,e.querySelector(".av__cellheadericon").outerHTML=t.icon?unicode2Emoji(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${getColIconByType(e.dataset.dtype)}"></use></svg>`),typeof t.name!="undefined"&&(e.querySelector(".av__celltext").textContent=t.name),typeof t.pin!="undefined"){const n=e.querySelector(".av__celltext");t.pin?e.querySelector(".av__cellheadericon--pin")||n.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):(a=e.querySelector(".av__cellheadericon--pin"))==null||a.remove()}},Bg=e=>{let t=hasClosestByClassName(e,"av__row");if(!t)return;let a=-1;for(;t;)t=t.previousElementSibling,a++;let n=-2;for(;e;)e=e.previousElementSibling,e&&e.classList.contains("av__colsticky")&&(e=e.lastElementChild),n++;return{rowIndex:a,celIndex:n}},Pg=(e,t,a,n,i)=>{var s;(s=t.querySelector(".av__drag-fill"))==null||s.remove();const o={};t.querySelectorAll(".av__cell--active").forEach(m=>{if(n.includes(m.dataset.id))return;const d=hasClosestByClassName(m,"av__row");if(!d)return;o[d.dataset.id]||(o[d.dataset.id]=[]);const f=ni(Pn(m),m);f.colId=m.dataset.colId,f.element=m,o[d.dataset.id].push(f)});const l=[],r=[],c=t.dataset.avId,u=Object.keys(a),g=!!i.querySelector(".b3-menu__avemoji");Object.keys(o).forEach((m,d)=>{o[m].forEach((f,b)=>{if(["rollup","template","created","updated"].includes(f.type)||f.type==="block"&&f.element.getAttribute("data-detached")!=="true")return;const p=JSON.parse(JSON.stringify(a[u[d%u.length]][b]));p.id=f.id;const y=f.colId;p.type==="block"&&(p.isDetached=!0,delete p.block.id),l.push({action:"updateAttrViewCell",id:f.id,avID:c,keyID:y,rowID:m,data:p}),f.element.innerHTML=Pa(p,0,g),ar(f.element,p),delete f.colId,delete f.element,r.push({action:"updateAttrViewCell",id:f.id,avID:c,keyID:y,rowID:m,data:f})})}),focusBlock(t),l.length>0&&transaction(e,l,r)},Ra=e=>{if(e&&(e.classList.add("av__cell--active"),!e.querySelector(".av__drag-fill"))){const t=e.getAttribute("data-dtype");if(["template","rollup","lineNumber","created","updated"].includes(t))return;e.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`)}},sr=e=>{var t,a,n,i,s,o,l;if(e.type==="checkbox")return!1;if(["text","block","url","phone","email","template"].includes(e.type))return!((t=e[e.type])!=null&&t.content);if(e.type==="number")return!((a=e.number)!=null&&a.isNotEmpty);if(["mSelect","mAsset","select"].includes(e.type))return!(((n=e[e.type==="select"?"mSelect":e.type])==null?void 0:n.length)>0);if(["date","created","updated"].includes(e.type))return!((i=e[e.type])!=null&&i.isNotEmpty)&&!((s=e[e.type])!=null&&s.isNotEmpty2);if(e.type==="relation")return!((o=e.relation)!=null&&o.blockIDs&&e.relation.blockIDs.length>0);if(e.type==="rollup")return!((l=e.rollup)!=null&&l.contents&&e.rollup.contents.length>0)};var ir=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const lr=e=>{if(["select","number","date","created","updated"].includes(e))return"=";if(["checkbox"].includes(e))return"Is false";if(["rollup","relation","mAsset","text","mSelect","url","block","email","phone","template"].includes(e))return"Contains"},ii=(e,t,a)=>{const n=hasClosestByClassName(e,"b3-menu");if(n){if(["date","updated","created"].includes(a)){const i=n.querySelector('.b3-menu__item div[data-type="filter1"]'),s=i.nextElementSibling;t==="Is between"?(s.classList.remove("fn__none"),i.classList.remove("fn__none")):t==="Is empty"||t==="Is not empty"?(s.classList.add("fn__none"),i.classList.add("fn__none")):(i.classList.remove("fn__none"),s.classList.add("fn__none"));return}n.querySelectorAll("input, .b3-chip").forEach(i=>{const s=hasClosestByClassName(i,"b3-menu__item");s&&(t!=="Is empty"&&t!=="Is not empty"?s.classList.remove("fn__none"):s.classList.add("fn__none"))})}},li=e=>{window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item").forEach(t=>{const a=t.querySelector(".b3-chip.b3-chip--middle");if(a){const n=a.dataset.name.toLowerCase();!e||e.indexOf(n)>-1||n.indexOf(e)>-1?t.classList.remove("fn__none"):t.classList.add("fn__none")}})},or=e=>ir(void 0,null,function*(){var t,a,n,i,s,o,l,r,c,u,g,m,d,f,b,p,y,_,k,x,T;let w=e.target.getBoundingClientRect();w.height===0&&(w=e.protyle.wysiwyg.element.querySelector(`[data-col-id="${e.target.dataset.colId}"]`).getBoundingClientRect());const v=e.blockElement.getAttribute("data-node-id");let h;const E=new Menu("set-filter-"+e.filter.column,()=>{const M=JSON.parse(JSON.stringify(e.data.view.filters));if(!h||!h.value)return;const P={column:e.filter.column,value:{type:e.filter.value.type},operator:h.value};let B=!1,N;if(L.type==="select"||L.type==="mSelect"){const z=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(se=>{if(se.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const te=se.nextElementSibling.firstElementChild;z.push({color:te.dataset.color,content:te.dataset.name})}}),N=genCellValue(L.type,z)}else if(["date","updated","created"].includes(L.type)){const z=E.element.querySelector('.b3-select[data-type="dateType"]'),se=E.element.querySelectorAll('.b3-select[data-type="dataDirection"]');z.value==="custom"?(P.relativeDate={count:parseInt(se[0].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(se[0].parentElement.lastElementChild.value),direction:parseInt(se[0].value)},P.relativeDate2={count:parseInt(se[1].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(se[1].parentElement.lastElementChild.value),direction:parseInt(se[1].value)},N={type:L.type}):(N=genCellValue(L.type,{isNotEmpty2:D[2].value!=="",isNotEmpty:D[0].value!=="",content:D[0].value?new Date(D[0].value+" 00:00").getTime():0,content2:D[2].value?new Date(D[2].value+" 00:00").getTime():0,hasEndDate:P.operator==="Is between",isNotTime:!0}),P.relativeDate=null,P.relativeDate2=null)}else["text","mAsset","url","block","email","phone","template","relation","number"].includes(L.type)?N=genCellValue(L.type,D[0].value):L.type==="checkbox"?N=genCellValue(L.type,{checked:P.operator==="Is true"}):N=genCellValue(L.type,void 0);e.filter.value.type==="rollup"?P.value={rollup:{contents:[N]},type:"rollup"}:P.value=N,["rollup","mAsset"].includes(e.filter.value.type)&&(P.quantifier=E.element.querySelector('.b3-select[data-type="quantifier"]').value);let X=!1;if(e.data.view.filters.find((z,se)=>{if(z.column===e.filter.column&&z.value.type===e.filter.value.type)return z.value.type==="checkbox"?(B=!0,e.data.view.filters[se]=P,!0):objEquals(z,P)?(X=!0,!0):(e.data.view.filters[se]=P,B=!0,!0)}),!e.empty&&(X||!B))return;transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:v}],[{action:"setAttrViewFilters",avID:e.data.id,data:M,blockID:v}]);const Y=hasClosestByClassName(e.target,"b3-menu");Y&&(Y.innerHTML=On(e.data))});if(E.isOpen)return;let C="",A;const S=getFieldsByData(e.data);S.find(M=>{if(M.id===e.filter.column)return A=M,!0});let L=JSON.parse(JSON.stringify(e.filter.value));if(A.type==="rollup"){if(!A.rollup||!A.rollup.relationKeyID||!A.rollup.keyID){showMessage(window.siyuan.languages.plsChoose),(t=document.querySelector(".av__panel"))==null||t.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:A.id});return}if((a=A.rollup.calc)!=null&&a.operator&&!["Range","Unique values"].includes(A.rollup.calc.operator))["Count all","Count empty","Count not empty","Count values","Count unique values","Percent empty","Percent not empty","Percent unique values","Percent checked","Percent unchecked","Sum","Average","Median","Min","Max"].includes(A.rollup.calc.operator)?L.type="number":["Checked","Unchecked"].includes(A.rollup.calc.operator)?L.type="checkbox":["Earliest","Latest"].includes(A.rollup.calc.operator)&&(L.type="date");else{let M="";S.find(B=>{if(B.id===A.rollup.relationKeyID)return M=B.relation.avID,!0}),(yield fetchSyncPost("/api/av/getAttributeView",{id:M})).data.av.keyValues.find(B=>{if(B.key.id===A.rollup.keyID)return L.type=B.key.type,B.key.type==="select"&&(A.options=B.key.options),!0})}e.data.view.filters.find(M=>{if(M.column===A.id&&M.value.type==="rollup"){if(!M.value.rollup||!M.value.rollup.contents||M.value.rollup.contents.length===0){const P=L.type==="select"?"mSelect":L.type;L={[P]:genCellValue(L.type,L.type==="checkbox"?{checked:void 0}:"")[P],type:L.type}}else L=M.value.rollup.contents[0];return!0}})}let $=!1;switch(L.type==="checkbox"&&($=typeof L.checkbox=="undefined"||typeof L.checkbox.checked=="undefined"),L.type){case"checkbox":C=`<option ${e.filter.operator==="Is true"&&!$?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${e.filter.operator==="Is false"&&!$?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,$&&(C=`<option selected></option>${C}`);break;case"block":case"mAsset":case"text":case"url":case"phone":case"email":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${e.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":C=`<option ${e.filter.operator==="="?"selected":""} value="=">=</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":C=`<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":C=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(["rollup","mAsset"].includes(e.filter.value.type)&&E.addItem({iconHTML:"",type:"readonly",label:` <select style="margin: 4px 0" class="b3-select fn__size200" data-type="quantifier">
    <option ${e.filter.quantifier===""||e.filter.quantifier==="Any"?"selected":""} value="Any">${window.siyuan.languages.filterQuantifierAny}</option>
    <option ${e.filter.quantifier==="All"?"selected":""} value="All">${window.siyuan.languages.filterQuantifierAll}</option>
    <option ${e.filter.quantifier==="None"?"selected":""} value="None">${window.siyuan.languages.filterQuantifierNone}</option>
</select>`}),E.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200" data-type="operation">${C}</select>`}),L.type==="select"||L.type==="mSelect")((n=A.options)==null?void 0:n.length)>0&&E.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">`,bind(M){const P=M.querySelector("input");P.addEventListener("keydown",B=>{if(B.isComposing)return;let N=upDownHint(E.element.querySelector(".b3-menu__items"),B,"b3-menu__item--current",M.nextElementSibling);B.key==="Enter"&&(N||(N=E.element.querySelector(".b3-menu__item--current")),N.dispatchEvent(new CustomEvent("click")))}),P.addEventListener("input",B=>{B.isComposing||li(P.value.toLowerCase())}),P.addEventListener("compositionend",()=>{li(P.value.toLowerCase())})}}),(i=A.options)==null||i.forEach(M=>{var P;let B="iconUncheck";(P=L==null?void 0:L.mSelect)==null||P.find(N=>{N.content===M.name&&(B="iconCheck")}),E.addItem({icon:B,label:`<span class="b3-chip b3-chip--middle" data-name="${M.name}" data-color="${M.color}" style="max-width: 178px;margin:3px 0;background-color:var(--b3-font-background${M.color});color:var(--b3-font-color${M.color})">
    <span class="fn__ellipsis">${M.name}</span>
</span>`,bind(N){N.addEventListener("click",()=>{const X=N.querySelector("use");X.getAttribute("xlink:href")==="#iconUncheck"?X.setAttribute("xlink:href","#iconCheck"):X.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","mAsset","email","phone","template"].includes(L.type)){let M="";L&&(L.type==="mAsset"?L.mAsset&&(M=((s=L.mAsset[0])==null?void 0:s.content)||""):M=L[L.type].content||""),E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${M}" class="b3-text-field fn__size200">`})}else if(L.type==="relation"){let M="";L&&(M=L.relation.blockIDs[0]||""),E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${M}" class="b3-text-field fn__size200"><div style="position:fixed" class="protyle-hint b3-list b3-list--background fn__none"></div>`,bind(P){const B=P.querySelector("input"),N=B.nextElementSibling,X=()=>{!A.relation||!A.relation.avID||fetchPost("/api/av/getAttributeViewPrimaryKeyValues",{id:A.relation.avID,keyword:B.value},Y=>{let z="";(Y.data.rows.values||[]).forEach((te,re)=>{z+=`<div class="b3-list-item${re===0?" b3-list-item--focus":""}">${te.block.content||window.siyuan.languages.untitled}</div>`}),N.innerHTML=z,z===""?N.classList.add("fn__none"):N.classList.remove("fn__none");const se=B.getBoundingClientRect();setPosition(N,se.left,se.bottom+4,se.height+4)})};B.addEventListener("input",Y=>{Y.isComposing||X()}),B.addEventListener("compositionend",()=>{X()}),B.addEventListener("keydown",Y=>{Y.isComposing||(Y.key!=="Enter"&&N.innerHTML!==""&&N.classList.remove("fn__none"),upDownHint(N,Y),Y.key==="Enter"&&(N.classList.contains("fn__none")?E.close():(B.value=N.querySelector(".b3-list-item--focus").textContent.replace(/\n/g," "),N.classList.add("fn__none")),Y.preventDefault(),Y.stopPropagation()))}),N.addEventListener("click",Y=>{const z=hasClosestByClassName(Y.target,"b3-list-item");z&&(B.value=z.textContent.replace(/\n/g," "),N.classList.add("fn__none"))})}})}else if(L.type==="number")E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${L!=null&&L.number.isNotEmpty?L.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(L.type)){const M=L?L[L.type]:null,P=!((o=e.filter.relativeDate)!=null&&o.direction),B=!((l=e.filter.relativeDate2)!=null&&l.direction);E.addItem({iconHTML:"",type:"readonly",label:`<div data-type="filter1">
    <div class="fn__size200">
        <select class="b3-select fn__block" data-type="dateType">
            <option value="time"${e.filter.relativeDate?"":" selected"}>${window.siyuan.languages.includeTime}</option>
            <option value="custom"${e.filter.relativeDate?" selected":""}>${window.siyuan.languages.relativeToToday}</option>
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__size200 ${e.filter.relativeDate?"fn__none":""}">
        <input value="${M&&(M.isNotEmpty||L.type!=="date")?dayjs(M.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((r=e.filter.relativeDate)==null?void 0:r.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((c=e.filter.relativeDate)==null?void 0:c.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${P?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" oninput="this.value = Math.max(this.value, 1)" step="1" value="${((u=e.filter.relativeDate)==null?void 0:u.count)||1}" class="b3-text-field fn__flex-1${P?" fn__none":""}"/>
        <span class="fn__space${P?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((g=e.filter.relativeDate)==null?void 0:g.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate||((m=e.filter.relativeDate)==null?void 0:m.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((d=e.filter.relativeDate)==null?void 0:d.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((f=e.filter.relativeDate)==null?void 0:f.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>
<div data-type="filter2 fn__none">
    <div class="fn__hr--small"></div>
    <div class="fn__size200 ${e.filter.relativeDate2?"fn__none":""}">
        <input value="${M&&M.isNotEmpty2?dayjs(M.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate2?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((b=e.filter.relativeDate2)==null?void 0:b.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((p=e.filter.relativeDate2)==null?void 0:p.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${B?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" oninput="this.value = Math.max(this.value, 1)" value="${((y=e.filter.relativeDate2)==null?void 0:y.count)||1}" class="b3-text-field fn__flex-1${B?" fn__none":""}"/>
        <span class="fn__space${B?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((_=e.filter.relativeDate2)==null?void 0:_.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate2||((k=e.filter.relativeDate2)==null?void 0:k.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((x=e.filter.relativeDate2)==null?void 0:x.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((T=e.filter.relativeDate2)==null?void 0:T.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>`})}E.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const M=Object.assign([],e.data.view.filters);e.data.view.filters.find((B,N)=>{if(B.column===e.filter.column&&e.filter.value.type===B.value.type)return e.data.view.filters.splice(N,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:v}],[{action:"setAttrViewFilters",avID:e.data.id,data:M,blockID:v}]);const P=hasClosestByClassName(e.target,"b3-menu");P&&(P.innerHTML=On(e.data))}}),h=E.element.querySelector('.b3-select[data-type="operation"]'),h==null||h.addEventListener("change",()=>{ii(h,h.value,L.type)});const R=E.element.querySelector('.b3-select[data-type="dateType"]');R==null||R.addEventListener("change",()=>{const M=E.element.querySelectorAll('[data-type="dataDirection"]'),P=M[0].parentElement,B=M[1].parentElement,N=P.previousElementSibling,X=B.previousElementSibling;R.value==="custom"?(P.classList.remove("fn__none"),B.classList.remove("fn__none"),N.classList.add("fn__none"),X.classList.add("fn__none")):(P.classList.add("fn__none"),B.classList.add("fn__none"),N.classList.remove("fn__none"),X.classList.remove("fn__none"))}),E.element.querySelectorAll('.b3-select[data-type="dataDirection"]').forEach(M=>{M.addEventListener("change",()=>{const P=M.nextElementSibling.nextElementSibling;M.value==="0"?(P.classList.add("fn__none"),P.nextElementSibling.classList.add("fn__none")):(P.classList.remove("fn__none"),P.nextElementSibling.classList.remove("fn__none"))})});const D=E.element.querySelectorAll(".b3-text-field");["relation","select","mSelect"].includes(L.type)||D.forEach(M=>{M.addEventListener("keydown",P=>{if(P.isComposing){P.preventDefault();return}P.key==="Enter"&&(E.close(),P.preventDefault())})}),ii(h,h.value,L.type),E.open({x:w.left,y:w.bottom}),D.length>0&&D[0].select()}),Rg=e=>{const t=new Menu(Constants.MENU_AV_ADD_FILTER);getFieldsByData(e.data).forEach(a=>{let n;e.data.view.filters.find(i=>{if(i.column===a.id&&i.value.type===a.type)return n=i,!0}),!n&&a.type!=="lineNumber"&&t.addItem({label:a.name,iconHTML:a.icon?unicode2Emoji(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(a.type)}"></use></svg>`,click:()=>{const i=genCellValue(a.type,a.type==="checkbox"?{checked:void 0}:"");n={column:a.id,operator:lr(a.type),value:i},e.data.view.filters.push(n),e.menuElement.innerHTML=On(e.data),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height);const s=e.menuElement.querySelector(`[data-id="${a.id}"] .b3-chip`);or({empty:!0,filter:n,protyle:e.protyle,data:e.data,target:s,blockElement:e.blockElement})}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},On=e=>{let t="";const a=getFieldsByData(e),n=i=>{let s="";return a.find(o=>{var l,r,c,u,g,m;if(o.id===i.column&&o.type===i.value.type){let d="";["rollup","mAsset"].includes(o.type)&&(i.quantifier===""||i.quantifier==="Any"?d=window.siyuan.languages.filterQuantifierAny+" ":i.quantifier==="All"?d=window.siyuan.languages.filterQuantifierAll+" ":i.quantifier==="None"&&(d=window.siyuan.languages.filterQuantifierNone+" "));const f=o.type==="rollup"?((r=(l=i.value.rollup)==null?void 0:l.contents)==null?void 0:r.length)>0?i.value.rollup.contents[0]:{type:"rollup"}:i.value;if(i.operator==="Is empty")d=": "+d+window.siyuan.languages.filterOperatorIsEmpty;else if(i.operator==="Is not empty")d=": "+d+window.siyuan.languages.filterOperatorIsNotEmpty;else if(i.operator==="Is false")(f.type!=="checkbox"||typeof f.checkbox.checked=="boolean")&&(d=": "+d+window.siyuan.languages.unchecked);else if(i.operator==="Is true")(f.type!=="checkbox"||typeof f.checkbox.checked=="boolean")&&(d=": "+d+window.siyuan.languages.checked);else if(["created","updated","date"].includes(f.type)){let b="",p="";i.relativeDate?(b=`${window.siyuan.languages[["pastDate","current","nextDate"][i.relativeDate.direction+1]]}
 ${i.relativeDate.direction?i.relativeDate.count:""}
 ${window.siyuan.languages[["day","week","month","year"][i.relativeDate.unit]]}`,i.relativeDate2&&(p=`${window.siyuan.languages[["pastDate","current","nextDate"][i.relativeDate2.direction+1]]}
 ${i.relativeDate2.direction?i.relativeDate2.count:""}
 ${window.siyuan.languages[["day","week","month","year"][i.relativeDate2.unit]]}`)):f&&((c=f[f.type])!=null&&c.content&&(b=dayjs(f[f.type].content).format("YYYY-MM-DD")),f&&((u=f[f.type])!=null&&u.content2)&&(p=dayjs(f[f.type].content2).format("YYYY-MM-DD"))),b&&(i.operator==="Is between"&&p?d=` ${d}${window.siyuan.languages.filterOperatorIsBetween} ${b} ${p}`:i.operator==="="?d=`: ${d}${b}`:[">","<"].includes(i.operator)?d=` ${d}${i.operator} ${b}`:i.operator===">="?d=` ${d}\u2265 ${b}`:i.operator==="<="&&(d=` ${d}\u2264 ${b}`))}else if(["mSelect","select"].includes(f.type)){let b="";((g=f.mSelect)==null?void 0:g.length)>0&&(f.mSelect.forEach((p,y)=>{b+=p.content,y!==f.mSelect.length-1&&(b+=", ")}),b&&(i.operator==="Contains"?d=`: ${d}${b}`:i.operator==="Does not contains"?d=` ${d}${window.siyuan.languages.filterOperatorDoesNotContain} ${b}`:i.operator==="="?d=`: ${d}${b}`:i.operator==="!="&&(d=` ${d}${window.siyuan.languages.filterOperatorIsNot} ${b}`))),!b&&["rollup","mAsset"].includes(o.type)&&!["Is empty","Is not empty"].includes(i.operator)&&(d="")}else if(f.type==="number"&&f.number&&f.number.isNotEmpty)["=","!=",">","<"].includes(i.operator)?d=` ${d}${i.operator} ${f.number.content}`:i.operator===">="?d=` ${d}\u2265 ${f.number.content}`:i.operator==="<="&&(d=` ${d}\u2264 ${f.number.content}`);else if(["text","block","url","mAsset","phone","email","relation","template"].includes(f.type)){let b;f[f.type]&&(f.type==="relation"?b=f.relation.blockIDs[0]||"":f.type==="mAsset"?b=((m=f.mAsset[0])==null?void 0:m.content)||"":b=f[f.type].content||"",b&&(["=","Contains"].includes(i.operator)?d=`: ${d}${b}`:i.operator==="Does not contains"?d=` ${d}${window.siyuan.languages.filterOperatorDoesNotContain} ${b}`:i.operator==="!="?d=` ${d}${window.siyuan.languages.filterOperatorIsNot} ${b}`:i.operator==="Starts with"?d=` ${d}${window.siyuan.languages.filterOperatorStartsWith} ${b}`:i.operator==="Ends with"?d=` ${d}${window.siyuan.languages.filterOperatorEndsWith} ${b}`:[">","<"].includes(i.operator)?d=` ${d}${i.operator} ${b}`:i.operator===">="?d=` ${d}\u2265 ${b}`:i.operator==="<="&&(d=` ${d}\u2264 ${b}`))),!b&&["rollup","mAsset"].includes(o.type)&&!["Is empty","Is not empty"].includes(i.operator)&&(d="")}return s+=`<span data-type="setFilter" class="b3-chip${d?" b3-chip--primary":""}">
    ${o.icon?unicode2Emoji(o.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${getColIconByType(o.type)}"></use></svg>`}
    <span class="fn__ellipsis">${o.name}${d}</span>
</span>`,!0}}),s};return e.view.filters.forEach(i=>{const s=n(i);s&&(t+=`<button class="b3-menu__item" draggable="true" data-id="${i.column}" data-filter-type="${i.value.type}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${s}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${t}
<button class="b3-menu__item${e.view.filters.length===a.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item b3-menu__item--warning${t?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`};var rr=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Og=(e,t)=>{if(t==="table"||hasClosestByClassName(e,"custom-attr"))return e.getAttribute("data-col-id");if(t==="gallery")return e.getAttribute("data-field-id")},cr=e=>{let t;const a=getFieldsByData(e.data);a.find((s,o)=>{if(s.id===e.colId)return t=JSON.parse(JSON.stringify(s)),a.splice(o+1,0,t),!0}),t.name=duplicateNameAddOne(t.name),t.id=Lute.NewNodeID();const n=dayjs().format("YYYYMMDDHHmmss"),i=e.blockElement.getAttribute("data-node-id");transaction(e.protyle,[{action:"duplicateAttrViewKey",keyID:e.colId,nextID:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:i,data:n}],[{action:"removeAttrViewCol",id:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:i,data:e.blockElement.getAttribute("updated")}]),Se({blockElement:e.blockElement,protyle:e.protyle,type:t.type,name:t.name,icon:t.icon,previousID:e.colId,data:e.data,id:t.id}),e.blockElement.setAttribute("updated",n)},oi=e=>{var t,a,n,i,s;let o;getFieldsByData(e.data).find(r=>{if(r.id===e.colId)return o=r,!0});let l=`<button class="b3-menu__item" data-type="nobg" data-col-id="${e.colId}">
    <span class="block__icon${e.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator" data-id="separator_1"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-col-type="${o.type}" data-icon="${o.icon}" data-type="update-icon">${o.icon?unicode2Emoji(o.icon):`<svg style="width: 14px;height: 14px"><use xlink:href="#${Ke(o.type)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${o.desc?escapeAriaLabel(o.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__block" type="text" data-value="${escapeAttr(o.desc)}">${o.desc}</textarea>
        </div>
        <div class="fn__hr--small"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="goUpdateColType" ${o.type==="block"?"disabled":""}>
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${Ke(o.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${Ot(o.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(["mSelect","select"].includes(o.type))l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <input data-type="addOption" class="b3-text-field fn__block" type="text" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.addAttr}" style="margin: 4px 0">
</button>`,o.options||(o.options=[]),o.options.forEach(r=>{const c=r.desc?`${escapeAriaLabel(r.name)}<div class='ft__on-surface'>${escapeAriaLabel(r.desc||"")}</div>`:"";l+=`<button class="b3-menu__item${l?"":" b3-menu__item--current"}" draggable="true" data-name="${escapeAttr(r.name)}" data-desc="${escapeAttr(r.desc||"")}" data-color="${r.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${c}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">
            <span class="fn__ellipsis">${escapeHtml(r.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(o.type==="number")l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${o.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${getLabelByNumberFormat(o.numberFormat)}</span>
</button>`;else if(o.type==="template")l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <textarea spellcheck="false" rows="${Math.min(o.template.split(`
`).length,8)}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${o.template}</textarea>
</button>`;else if(o.type==="relation"){const r=((t=o.relation)==null?void 0:t.avID)===e.data.id;l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${((a=o.relation)==null?void 0:a.avID)||""}" data-old-value='${JSON.stringify(o.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${r?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${(n=o.relation)!=null&&n.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${e.data.name} ${o.name}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else o.type==="rollup"?l+='<button class="b3-menu__separator" data-id="separator_2"></button>'+getRollupHTML({colData:o}):o.type==="date"&&(l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillCreated}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillCreated" type="checkbox" class="b3-switch b3-switch--menu" ${(i=o.date)!=null&&i.autoFillNow?"checked":""}>
</label>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillSpecificTime}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillSpecificTime" type="checkbox" class="b3-switch b3-switch--menu" ${(s=o.date)!=null&&s.fillSpecificTime?"checked":""}>
</label>`);return l+=`<button class="b3-menu__separator" data-id="separator_3"></button>
<label class="b3-menu__item">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconSoftWrap"></use></svg>
    <span class="fn__flex-center">${window.siyuan.languages.wrap}</span>
    <span class="fn__space fn__flex-1"></span>
    <input type="checkbox" data-type="wrap" class="b3-switch b3-switch--menu"${o.wrap?" checked":""}>
</label>`,o.type!=="block"&&(l+=`<button class="b3-menu__item${o.type==="relation"?" fn__none":""}" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item  b3-menu__item--warning" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>`),`<div class="b3-menu__items">
    ${l}
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${o.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${Ie("text",o.type)}
    ${Ie("number",o.type)}
    ${Ie("select",o.type)}
    ${Ie("mSelect",o.type)}
    ${Ie("date",o.type)}
    ${Ie("mAsset",o.type)}
    ${Ie("checkbox",o.type)}
    ${Ie("url",o.type)}
    ${Ie("email",o.type)}
    ${Ie("phone",o.type)}
    ${Ie("template",o.type)}
    ${Ie("relation",o.type)}
    ${Ie("rollup",o.type)}
    ${Ie("lineNumber",o.type)}
    ${Ie("created",o.type)}
    ${Ie("updated",o.type)}
</div>`},ri=e=>{const t=e.data.id,a=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),n=getFieldsByData(e.data).find(m=>m.id===a),i=e.menuElement.querySelector('[data-type="name"]');i.addEventListener("blur",()=>{const m=i.value;m!==n.name&&(transaction(e.protyle,[{action:"updateAttrViewCol",id:a,avID:t,name:m,type:n.type}],[{action:"updateAttrViewCol",id:a,avID:t,name:n.name,type:n.type}]),n.name=m,updateAttrViewCellAnimation(e.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${a}"]`),void 0,{name:m}))}),i.addEventListener("keydown",m=>{m.isComposing||(m.key==="Escape"?e.menuElement.parentElement.remove():m.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),i.addEventListener("keyup",m=>{if(m.isComposing)return;const d=e.menuElement.querySelector('[data-type="colName"]');d&&d.setAttribute("placeholder",`${e.data.name} ${i.value}`)}),i.select(),i.value=n.name;const s=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');i.nextElementSibling.addEventListener("click",()=>{const m=s.parentElement;m.classList.toggle("fn__none"),m.classList.contains("fn__none")||s.focus()}),s.addEventListener("blur",()=>{const m=s.value;m!==n.desc&&(transaction(e.protyle,[{action:"setAttrViewColDesc",id:a,avID:t,data:m}],[{action:"setAttrViewColDesc",id:a,avID:t,data:n.desc}]),n.desc=m)}),s.addEventListener("keydown",m=>{m.isComposing||(m.key==="Escape"?e.menuElement.parentElement.remove():m.key==="Enter"&&(s.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),s.addEventListener("input",()=>{i.nextElementSibling.setAttribute("aria-label",s.value?escapeHtml(s.value):window.siyuan.languages.addDesc)});const o=e.menuElement.querySelector('[data-type="updateTemplate"]');o&&(o.addEventListener("blur",()=>{const m=o.value;m!==n.template&&(transaction(e.protyle,[{action:"updateAttrViewColTemplate",id:a,avID:t,data:m,type:n.type}],[{action:"updateAttrViewColTemplate",id:a,avID:t,data:n.template,type:n.type}]),n.template=m)}),o.addEventListener("keydown",m=>{m.isComposing||(m.key==="Escape"?e.menuElement.parentElement.remove():m.key==="Enter"&&!m.shiftKey&&(o.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}));const l=e.menuElement.querySelector('.b3-switch[data-type="wrap"]');l&&l.addEventListener("change",()=>{transaction(e.protyle,[{action:"setAttrViewColWrap",id:a,avID:t,data:l.checked,blockID:e.blockID}],[{action:"setAttrViewColWrap",id:a,avID:t,data:!l.checked,blockID:e.blockID}]),n.wrap=l.checked,e.data.view.wrapField=e.data.view.wrapField&&l.checked});const r=e.menuElement.querySelector('[data-type="addOption"]');r&&r.addEventListener("keydown",m=>{if(!m.isComposing&&(m.key==="Escape"&&e.menuElement.parentElement.remove(),m.key==="Enter")){let d=!1;if(n.options.find(f=>{if(r.value===f.name)return d=!0,!0}),d||!r.value)return;n.options.push({color:((n.options.length||0)%14+1).toString(),name:r.value}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:a,avID:t,data:n.options}],[{action:"removeAttrViewColOption",id:a,avID:t,data:r.value}]),e.menuElement.innerHTML=oi({protyle:e.protyle,colId:a,data:e.data,isCustomAttr:e.isCustomAttr}),ri({protyle:e.protyle,menuElement:e.menuElement,data:e.data,isCustomAttr:e.isCustomAttr,blockID:e.blockID}),e.menuElement.querySelector('[data-type="addOption"]').focus()}});const c=e.menuElement.querySelector('[data-type="fillCreated"]');c&&c.addEventListener("change",()=>{transaction(e.protyle,[{avID:t,action:"setAttrViewColDateFillCreated",id:a,data:c.checked}],[{avID:t,action:"setAttrViewColDateFillCreated",id:a,data:!c.checked}])});const u=e.menuElement.querySelector('[data-type="fillSpecificTime"]');u&&u.addEventListener("change",()=>{transaction(e.protyle,[{avID:t,action:"setAttrViewColDateFillSpecificTime",id:a,data:u.checked}],[{avID:t,action:"setAttrViewColDateFillSpecificTime",id:a,data:!u.checked}])});const g=e.menuElement.querySelector('[data-type="backRelation"]');if(g){g.addEventListener("change",()=>{toggleUpdateRelationBtn(e.menuElement,t)});const m=e.menuElement.querySelector('[data-type="goSearchAV"]'),d=JSON.parse(m.getAttribute("data-old-value")),f=e.menuElement.querySelector('[data-type="colName"]');f.addEventListener("input",()=>{toggleUpdateRelationBtn(e.menuElement,t)}),d.avID?fetchPost("/api/av/getAttributeView",{id:d.avID},b=>{m.querySelector(".b3-menu__accelerator").textContent=d.avID===t?window.siyuan.languages.thisDatabase:b.data.av.name||window.siyuan.languages._kernel[267],b.data.av.keyValues.find(p=>{if(p.key.id===d.backKeyID)return f.setAttribute("data-old-value",p.key.name||window.siyuan.languages._kernel[272]),f.value=p.key.name||window.siyuan.languages._kernel[272],!0}),toggleUpdateRelationBtn(e.menuElement,t)}):toggleUpdateRelationBtn(e.menuElement,t)}bindRollupData(e)},Ot=e=>{switch(e){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[e];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox;case"block":return window.siyuan.languages._attrView.key;case"lineNumber":return window.siyuan.languages.lineNumber}},Ke=e=>{switch(e){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck";case"lineNumber":return"iconOrderedList"}},Se=e=>{if(!e.blockElement)return;const t=e.blockElement.getAttribute("data-node-id");e.blockElement.classList.contains("av")?e.blockElement.querySelectorAll(".av__row").forEach(i=>{let s;e.previousID?s=i.querySelector(`[data-col-id="${e.previousID}"]`):s=i.querySelector(".av__cell").previousElementSibling;let o="";i.classList.contains("av__row--header")?o=`<div class="av__cell av__cell--header" draggable="true" data-icon="${e.icon||""}" data-col-id="${e.id}" data-dtype="${e.type}" data-wrap="false" style="width: 200px;">
    ${e.icon?unicode2Emoji(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Ke(e.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${e.name}</span>
    <div class="av__widthdrag"></div>
</div>`:o='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',s.insertAdjacentHTML("afterend",o)}):e.blockElement.querySelector(".fn__hr").insertAdjacentHTML("beforebegin",`<div class="block__icons av__row" data-id="${t}" data-col-id="${e.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Ot(e.type)}">
        <svg class="block__logoicon"><use xlink:href="#${Ke(e.type)}"></use></svg>
        <span>${Ot(e.type)}</span>
    </div>
    <div data-col-id="${e.id}" data-block-id="${t}" data-type="${e.type}" data-options="[]" class="fn__flex-1 fn__flex">
        <div class="fn__flex-1"></div>
    </div>
</div>`);const a=document.querySelector(".av__panel .b3-menu");if(a&&e.data&&e.blockElement.classList.contains("av")){a.innerHTML=oi({protyle:e.protyle,data:e.data,colId:e.id,isCustomAttr:!1}),ri({protyle:e.protyle,data:e.data,menuElement:a,isCustomAttr:!1,blockID:t});const i=e.blockElement.querySelector(".av__views").getBoundingClientRect();i&&setPosition(a,i.right-a.clientWidth,i.bottom,i.height);return}let n;e.data&&(n=getFieldsByData(e.data).find(i=>i.id===e.id)),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.id,editData:{previousID:e.previousID,colData:n||dr(e.type,e.id,e.name)}}),window.siyuan.menus.menu.remove()},qg=(e,t,a)=>{const n=a.getAttribute("data-dtype"),i=a.getAttribute("data-col-id"),s=t.getAttribute("data-av-id"),o=t.getAttribute("data-node-id"),l=a.querySelector(".av__celltext").textContent.trim(),r=a.dataset.desc,c=new Menu(Constants.MENU_AV_HEADER_CELL,()=>{const d=c.element.querySelector(".b3-text-field").value;d!==l&&(transaction(e,[{action:"updateAttrViewCol",id:i,avID:s,name:d,type:n}],[{action:"updateAttrViewCol",id:i,avID:s,name:l,type:n}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:d}));const f=c.element.querySelector("textarea").value;f!==r&&transaction(e,[{action:"setAttrViewColDesc",id:i,avID:s,data:f}],[{action:"setAttrViewColDesc",id:i,avID:s,data:r}]),focusBlock(t)});c.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div><div class="fn__flex">
    <div class="fn__space"></div>
    <span class="b3-menu__avemoji">${a.dataset.icon?unicode2Emoji(a.dataset.icon):`<svg style="height: 14px;width: 14px;"><use xlink:href="#${Ke(n)}"></use></svg>`}</span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field b3-form__icona-input" type="text">
        <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${r?escapeAriaLabel(r):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
    </div>
    <div class="fn__space"></div>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <div class="fn__flex">
        <span class="fn__space"></span>
        <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" class="b3-text-field fn__block" type="text" data-value="${escapeAttr(r)}">${r}</textarea>
        <span class="fn__space"></span>    
    </div>
</div>
<div class="fn__hr--small"></div>`,bind(d){const f=d.querySelector(".b3-menu__avemoji");f.addEventListener("click",y=>{const _=f.getBoundingClientRect();openEmojiPanel("","av",{x:_.left,y:_.bottom+4,h:_.height,w:_.width},k=>{transaction(e,[{action:"setAttrViewColIcon",id:i,avID:s,data:k}],[{action:"setAttrViewColIcon",id:i,avID:s,data:a.dataset.icon}]),f.innerHTML=k?unicode2Emoji(k):`<svg style="height: 14px;width: 14px"><use xlink:href="#${Ke(n)}"></use></svg>`,updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{icon:k})},f.querySelector("img")),y.preventDefault(),y.stopPropagation()});const b=d.querySelector("input");b.value=l,b.addEventListener("keydown",y=>{y.isComposing||y.key==="Enter"&&(c.close(),y.preventDefault())});const p=d.querySelector("textarea");b.nextElementSibling.addEventListener("click",()=>{const y=p.parentElement.parentElement;y.classList.toggle("fn__none"),y.classList.contains("fn__none")||p.focus()}),p.addEventListener("keydown",y=>{y.isComposing||y.key==="Enter"&&(c.close(),y.preventDefault())}),p.addEventListener("input",()=>{b.nextElementSibling.setAttribute("aria-label",p.value?escapeHtml(p.value):window.siyuan.languages.addDesc)})}}),c.addItem({id:"edit",icon:"iconEdit",label:window.siyuan.languages.edit,click(){const d=c.element.querySelector(".b3-text-field").value;openMenuPanel({protyle:e,blockElement:t,type:"edit",colId:i,cb(f){const b=f.querySelector('.b3-text-field[data-type="name"]');b.value=d,b.select()}})}}),c.addSeparator({id:"separator_1"}),n!=="lineNumber"&&(c.addItem({id:"filter",icon:"iconFilter",label:window.siyuan.languages.filter,click(){fetchPost("/api/av/renderAttributeView",{id:s},d=>{const f=d.data;let b;f.view.filters.find(y=>{if(y.column===i&&y.value.type===n)return b=y,!0});let p=!1;b||(p=!0,b={column:i,operator:getDefaultOperatorByType(n),value:genCellValue(n,"")},f.view.filters.push(b)),setFilter({empty:p,filter:b,protyle:e,data:f,blockElement:t,target:t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`)})})}}),c.addItem({id:"asc",icon:"iconUp",label:window.siyuan.languages.asc,click(){fetchPost("/api/av/renderAttributeView",{id:s},d=>{transaction(e,[{action:"setAttrViewSorts",avID:d.data.id,data:[{column:i,order:"ASC"}],blockID:o}],[{action:"setAttrViewSorts",avID:d.data.id,data:d.data.view.sorts,blockID:o}])})}}),c.addItem({id:"desc",icon:"iconDown",label:window.siyuan.languages.desc,click(){fetchPost("/api/av/renderAttributeView",{id:s},d=>{transaction(e,[{action:"setAttrViewSorts",avID:d.data.id,data:[{column:i,order:"DESC"}],blockID:o}],[{action:"setAttrViewSorts",avID:d.data.id,data:d.data.view.sorts,blockID:o}])})}}));const u=a.dataset.pin==="true";if(c.addItem({id:u?"unfreezeCol":"freezeCol",icon:u?"iconUnpin":"iconPin",label:u?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){transaction(e,[{action:"setAttrViewColPin",id:i,avID:s,data:!u,blockID:o}],[{action:"setAttrViewColPin",id:i,avID:s,data:u,blockID:o}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{pin:!u})}}),n!=="block"&&c.addItem({id:"hide",icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){transaction(e,[{action:"setAttrViewColHidden",id:i,avID:s,data:!0,blockID:o}],[{action:"setAttrViewColHidden",id:i,avID:s,data:!1,blockID:o}])}}),c.addItem({icon:"iconRefresh",label:window.siyuan.languages.syncColWidth,click(){transaction(e,[{action:"syncAttrViewTableColWidth",keyID:i,avID:s,id:t.getAttribute(Constants.CUSTOM_SY_AV_VIEW)}])}}),c.addItem({icon:"iconSoftWrap",label:`<label class="fn__flex fn__pointer"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch b3-switch--menu"${a.dataset.wrap==="true"?" checked":""}></label>`,bind(d){const f=d.querySelector(".b3-switch");f.addEventListener("change",()=>{a.dataset.wrap=f.checked.toString(),transaction(e,[{action:"setAttrViewColWrap",id:i,avID:s,data:f.checked,blockID:o}],[{action:"setAttrViewColWrap",id:i,avID:s,data:!f.checked,blockID:o}]),c.close()})}}),c.addSeparator({id:"separator_2"}),c.addItem({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){var d;const f=ci(e,t,((d=a.previousElementSibling)==null?void 0:d.getAttribute("data-col-id"))||"");t.contains(a)||(a=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const b=a.getBoundingClientRect();f.open({x:b.left,y:b.bottom,h:b.height})}}),c.addItem({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const d=ci(e,t,i);t.contains(a)||(a=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const f=a.getBoundingClientRect();d.open({x:f.left,y:f.bottom,h:f.height})}}),n!=="block"){let d;n!=="relation"&&c.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){fetchPost("/api/av/renderAttributeView",{id:s},f=>{cr({blockElement:t,viewID:t.getAttribute(Constants.CUSTOM_SY_AV_VIEW),protyle:e,colId:i,data:f.data})})}}),c.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){return rr(this,null,function*(){var f;if(n==="relation"){const p=(yield fetchSyncPost("/api/av/getAttributeView",{id:s})).data.av.keyValues.find(y=>y.key.id===i);if((f=p.key.relation)!=null&&f.isTwoWay){const y=yield fetchSyncPost("/api/av/getAttributeView",{id:p.key.relation.avID}),_=new Dialog({title:window.siyuan.languages.removeColConfirm,content:`<div class="b3-dialog__content">
    ${window.siyuan.languages.confirmRemoveRelationField.replace("${x}",p.key.name||window.siyuan.languages._kernel[272]).replace("${y}",y.data.av.name||window.siyuan.languages._kernel[267]).replace("${z}",y.data.av.keyValues.find(k=>k.key.id===p.key.relation.backKeyID).key.name||window.siyuan.languages._kernel[272])}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.removeBothRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`,width:"520px"});_.element.addEventListener("click",k=>{let x=k.target;const T=typeof k.detail=="string";for(;x&&x!==_.element||T;){const w=x.getAttribute("data-action");if(w==="delete"||T&&k.detail==="Enter"){qn({protyle:e,colId:i,avID:s,blockID:o,oldValue:l,type:n,cellElement:a,blockElement:t,removeDest:!0}),_.destroy();break}else if(w==="keep-relation"){qn({protyle:e,colId:i,avID:s,blockID:o,oldValue:l,type:n,cellElement:a,blockElement:t,removeDest:!1}),_.destroy();break}else if(x.classList.contains("b3-button--cancel")||T&&k.detail==="Escape"){_.destroy();break}x=x.parentElement}}),_.element.querySelector("button").focus(),_.element.setAttribute("data-key",Constants.DIALOG_CONFIRM);return}}qn({protyle:e,colId:i,avID:s,blockID:o,oldValue:l,type:n,cellElement:a,blockElement:t,removeDest:!1})})}})}const g=a.getBoundingClientRect();c.open({x:g.left,y:g.bottom,h:g.height});const m=window.siyuan.menus.menu.element.querySelector(".b3-text-field");m&&(m.select(),m.focus())},qn=e=>{var t;const a=dayjs().format("YYYYMMDDHHmmss");transaction(e.protyle,[{action:"removeAttrViewCol",id:e.colId,avID:e.avID,removeDest:e.removeDest},{action:"doUpdateUpdated",id:e.blockID,data:a}],[{action:"addAttrViewCol",name:e.oldValue,avID:e.avID,type:e.type,id:e.colId,previousID:((t=e.cellElement.previousElementSibling)==null?void 0:t.getAttribute("data-col-id"))||""},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),removeAttrViewColAnimation(e.blockElement,e.colId),e.blockElement.setAttribute("updated",a)},Ug=e=>{const t=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let a="";const n=e.fields.find((s,o)=>{var l;if(s.id===t)return a=(l=e.fields[o-1])==null?void 0:l.id,e.fields.splice(o,1),!0}),i=dayjs().format("YYYYMMDDHHmmss");transaction(e.protyle,[{action:"removeAttrViewCol",id:t,avID:e.avID,removeDest:e.isTwoWay},{action:"doUpdateUpdated",id:e.blockID,data:i}],[{action:"addAttrViewCol",name:n.name,avID:e.avID,type:n.type,id:t,previousID:a},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),removeAttrViewColAnimation(e.blockElement,t),e.blockElement.setAttribute("updated",i),e.isCustomAttr?e.avPanelElement.remove():(e.menuElement.innerHTML=getPropertiesHTML(e.fields),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height))},Ie=(e,t)=>`<button class="b3-menu__item" data-type="updateColType" data-old-type="${t}" data-new-type="${e}">
    <svg class="b3-menu__icon"><use xlink:href="#${Ke(e)}"></use></svg>
    <span class="b3-menu__label">${Ot(e)}</span>
    ${e===t?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,ci=(e,t,a)=>{const n=new Menu(Constants.MENU_AV_HEADER_ADD),i=t.getAttribute("data-av-id");typeof a=="undefined"&&t.getAttribute("data-av-type")==="table"&&(a=Array.from(t.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id"));const s=t.getAttribute("data-node-id");return n.addItem({id:"text",icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:i,type:"text",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"text",name:window.siyuan.languages.text,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"number",icon:"iconNumber",label:window.siyuan.languages.number,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:i,type:"number",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"number",name:window.siyuan.languages.number,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"select",icon:"iconListItem",label:window.siyuan.languages.select,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:i,type:"select",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"select",name:window.siyuan.languages.select,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"multiSelect",icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:i,type:"mSelect",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"mSelect",name:window.siyuan.languages.multiSelect,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"date",icon:"iconCalendar",label:window.siyuan.languages.date,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:i,type:"date",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"date",name:window.siyuan.languages.date,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"assets",icon:"iconImage",label:window.siyuan.languages.assets,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:i,type:"mAsset",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"mAsset",name:window.siyuan.languages.assets,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"checkbox",icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:i,type:"checkbox",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"checkbox",name:window.siyuan.languages.checkbox,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"link",icon:"iconLink",label:window.siyuan.languages.link,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:i,type:"url",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"url",name:window.siyuan.languages.link,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"email",icon:"iconEmail",label:window.siyuan.languages.email,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:i,type:"email",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"email",name:window.siyuan.languages.email,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"phone",icon:"iconPhone",label:window.siyuan.languages.phone,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:i,type:"phone",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"phone",name:window.siyuan.languages.phone,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"template",icon:"iconMath",label:window.siyuan.languages.template,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:i,type:"template",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"template",name:window.siyuan.languages.template,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"relation",icon:"iconOpen",label:window.siyuan.languages.relation,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:i,type:"relation",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"relation",name:window.siyuan.languages.relation,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"rollup",icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:i,type:"rollup",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"rollup",name:window.siyuan.languages.rollup,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"lineNumber",icon:"iconOrderedList",label:window.siyuan.languages.lineNumber,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.lineNumber,avID:i,type:"lineNumber",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"lineNumber",name:window.siyuan.languages.lineNumber,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"createdTime",icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:i,type:"created",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"created",name:window.siyuan.languages.createdTime,id:o,previousID:a}),t.setAttribute("updated",l)}}),n.addItem({id:"updatedTime",icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:i,type:"updated",id:o,previousID:a},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),Se({blockElement:t,protyle:e,type:"updated",name:window.siyuan.languages.updatedTime,id:o,previousID:a}),t.setAttribute("updated",l)}}),n},dr=(e,t,a)=>({hidden:!1,icon:"",id:t,name:a,desc:"",numberFormat:"",pin:!1,template:"",type:e,width:"",wrap:void 0,calc:null}),Un=(e,t,a)=>{e.value===""?(t.classList.add("fn__none"),typeof a=="number"&&(e.style.paddingRight=e.dataset.oldPaddingRight)):(t.classList.remove("fn__none"),typeof a=="number"&&e.style.setProperty("padding-right",`${a*2+t.clientWidth}px`,"important"))},di=e=>{e.inputElement.dataset.oldPaddingRight=e.inputElement.style.paddingRight,e.inputElement.insertAdjacentHTML("afterend",`<svg class="${e.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${e.right?"right: "+e.right+"px;":""}${e.height?"height:"+e.height+"px;":""}${e.width?"width:"+e.width:""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const t=e.inputElement.nextElementSibling;t.addEventListener("click",()=>{e.inputElement.value="",e.inputElement.focus(),Un(e.inputElement,t,e.right),e.clearCB&&e.clearCB()}),e.inputElement.addEventListener("input",()=>{Un(e.inputElement,t,e.right)}),Un(e.inputElement,t,e.right)};var ur=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const ui=e=>{let t="";return e.cards.forEach((a,n)=>{if(t+=`<div data-id="${a.id}" draggable="true" class="av__gallery-item">`,e.coverFrom!==0){const i="av__gallery-cover av__gallery-cover--"+e.cardAspectRatio;a.coverURL?a.coverURL.startsWith("background")?t+=`<div class="${i}"><img class="av__gallery-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" style="${a.coverURL}"></div>`:t+=`<div class="${i}"><img loading="lazy" class="av__gallery-img${e.fitImage?" av__gallery-img--fit":""}" src="${ti(a.coverURL)}"></div>`:a.coverContent?t+=`<div class="${i}"><div class="av__gallery-content">${a.coverContent}</div><div></div></div>`:t+=`<div class="${i}"></div>`}t+='<div class="av__gallery-fields">',a.values.forEach((i,s)=>{var o,l,r;if(e.fields[s].hidden)return;let c="";i.valueType==="checkbox"&&(c=(l=(o=i.value)==null?void 0:o.checkbox)!=null&&l.checked?" av__cell-check":" av__cell-uncheck");const u=sr(i.value);let g=Lt(e.fields[s].name)||Ot(e.fields[s].type);e.fields[s].desc&&(g+=Lt(`<div class="ft__on-surface">${e.fields[s].desc}</div>`)),i.valueType==="checkbox"&&!e.displayFieldName&&(i.value.checkbox.content=e.fields[s].name||Ot(e.fields[s].type));const m=`<div class="av__cell${c}${e.displayFieldName?"":" ariaLabel"}" 
data-wrap="${e.fields[s].wrap}" 
aria-label="${g}" 
data-position="5west"
data-id="${i.id}" 
data-field-id="${e.fields[s].id}" 
data-dtype="${i.valueType}" 
${(r=i.value)!=null&&r.isDetached?' data-detached="true"':""} 
style="${i.bgColor?`background-color:${i.bgColor};`:""}
${i.color?`color:${i.color};`:""}">${Pa(i.value,n,e.showIcon,"gallery")}</div>`;e.displayFieldName?t+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${u}">
    <div class="av__gallery-name">
        ${e.fields[s].icon?ve(e.fields[s].icon,void 0,!0):`<svg><use xlink:href="#${Ke(e.fields[s].type)}"></use></svg>`}${Lute.EscapeHTMLStr(e.fields[s].name)}
        ${e.fields[s].desc?`<svg aria-label="${e.fields[s].desc}" data-position="north" class="ariaLabel"><use xlink:href="#iconInfo"></use></svg>`:""}
    </div>
    ${m}
</div>`:t+=`<div class="av__gallery-field" data-empty="${u}">
    <div class="av__gallery-tip">
        ${e.fields[s].icon?ve(e.fields[s].icon,void 0,!0):`<svg><use xlink:href="#${Ke(e.fields[s].type)}"></use></svg>`}${window.siyuan.languages.edit} ${Lute.EscapeHTMLStr(e.fields[s].name)}
    </div>
    ${m}
</div>`}),t+=`</div>
    <div class="av__gallery-actions">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.displayEmptyFields}" data-type="av-gallery-edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.more}" data-type="av-gallery-more"><svg><use xlink:href="#iconMore"></use></svg></span>
    </div>
</div>`}),t+=`<div class="av__gallery-add" data-type="av-add-bottom"><svg class="svg"><use xlink:href="#iconAdd"></use></svg><span class="fn__space"></span>${window.siyuan.languages.newRow}</div>`,`<div class="av__gallery${e.cardSize===0?" av__gallery--small":e.cardSize===2?" av__gallery--big":""}">
    ${t}
</div>
<div class="av__gallery-load${e.cardCount>e.cards.length?"":" fn__none"}">
    <button class="b3-button av__button" data-type="av-load-more">
        <svg><use xlink:href="#iconArrowDown"></use></svg>
        <span>${window.siyuan.languages.loadMore}</span>
        <svg data-type="set-page-size" data-size="${e.pageSize}"><use xlink:href="#iconMore"></use></svg>
    </button>
</div>`},fr=e=>{const t=e.blockElement.querySelector('[data-type="av-search"]'),a=t&&document.activeElement===t,n=(t==null?void 0:t.value)||"";let i="";e.data.view.groups.forEach(s=>{var o;s.groupHidden===0&&(i+=`${pi(s,s.cards.length)}
<div data-group-id="${s.id}" data-page-size="${s.pageSize}" data-dtype="${s.groupKey.type}" data-content="${Lute.EscapeHTMLStr((o=s.groupValue.text)==null?void 0:o.content)}" class="av__body${s.groupFolded?" fn__none":""}">${ui(s)}</div>`)}),e.renderAll?e.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${Oa(e.data,a||!!n,!e.protyle.disabled&&!F(e.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div>
        ${i}
    </div>
    <div class="av__cursor" contenteditable="true">${H.ZWSP}</div>
</div>`:e.blockElement.querySelector(".av__header").nextElementSibling.innerHTML=i,fi(e)},fi=e=>{const t=e.data.view;if((t.coverFrom===1||t.coverFrom===3)&&ht(e.blockElement),typeof e.resetData.oldOffset=="number"&&(e.protyle.contentElement.scrollTop=e.resetData.oldOffset),e.blockElement.getAttribute("data-need-focus")==="true"&&(Ae(e.blockElement),e.blockElement.removeAttribute("data-need-focus")),e.blockElement.setAttribute("data-render","true"),e.resetData.alignSelf&&(e.blockElement.style.alignSelf=e.resetData.alignSelf),e.resetData.selectItemIds.find(i=>{let s=e.blockElement.querySelector(`.av__body[data-group-id="${i.groupId}"] .av__gallery-item[data-id="${i.fieldId}"]`);s||(s=e.blockElement.querySelector(`.av__gallery-item[data-id="${i.fieldId}"]`)),s&&s.classList.add("av__gallery-item--select")}),e.resetData.editIds.find(i=>{let s=e.blockElement.querySelector(`.av__body[data-group-id="${i.groupId}"] .av__gallery-item[data-id="${i.fieldId}"]`);s||(s=e.blockElement.querySelector(`.av__gallery-item[data-id="${i.fieldId}"]`)),s&&s.querySelector(".av__gallery-fields").classList.add("av__gallery-fields--edit")}),Object.keys(e.resetData.pageSizes).forEach(i=>{const s=e.blockElement.querySelector(`.av__body[data-group-id="${i==="unGroup"?"":i}"]`);s&&(s.dataset.pageSize=e.resetData.pageSizes[i])}),getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);if(!U(i.startContainer,"av__title")){const s=G(i.startContainer);s&&e.blockElement===s&&!e.resetData.isSearching&&Ae(e.blockElement)}}if(e.blockElement.querySelector(".layout-tab-bar").scrollLeft=e.blockElement.querySelector(".layout-tab-bar .item--focus").offsetLeft-30,e.cb&&e.cb(e.data),!e.renderAll)return;const a=e.blockElement.querySelector(".av__views"),n=e.blockElement.querySelector('[data-type="av-search"]');n.value=e.resetData.query||"",e.resetData.isSearching&&n.focus(),n.addEventListener("compositionstart",i=>{i.stopPropagation()}),n.addEventListener("keydown",i=>{i.isComposing||Jt(i)}),n.addEventListener("input",i=>{i.stopPropagation(),!i.isComposing&&(n.value||document.activeElement===n?a.classList.add("av__views--show"):a.classList.remove("av__views--show"),qt(e.blockElement,e.protyle))}),n.addEventListener("compositionend",()=>{qt(e.blockElement,e.protyle)}),n.addEventListener("blur",i=>{i.isComposing||n.value||(a.classList.remove("av__views--show"),n.style.width="0",n.style.paddingLeft="0",n.style.paddingRight="0")}),di({inputElement:n,right:0,width:"1em",height:n.clientHeight,clearCB(){a.classList.remove("av__views--show"),n.style.width="0",n.style.paddingLeft="0",n.style.paddingRight="0",Ae(e.blockElement),qt(e.blockElement,e.protyle)}})},gi=e=>ur(void 0,null,function*(){var t,a,n;const i=e.blockElement.querySelector('[data-type="av-search"]'),s=[];e.blockElement.querySelectorAll(".av__gallery-fields--edit").forEach(f=>{s.push({groupId:U(f,"av__body").dataset.groupId||"",fieldId:f.parentElement.getAttribute("data-id")})});const o=[];e.blockElement.querySelectorAll(".av__gallery-item--select").forEach(f=>{const b=f.getAttribute("data-id");b&&o.push({groupId:U(f,"av__body").dataset.groupId||"",fieldId:b})});const l={};e.blockElement.querySelectorAll(".av__body").forEach(f=>{l[f.dataset.groupId||"unGroup"]=f.dataset.pageSize});const r={isSearching:i&&document.activeElement===i,query:(i==null?void 0:i.value)||"",alignSelf:e.blockElement.style.alignSelf,oldOffset:e.protyle.contentElement.scrollTop,editIds:s,selectItemIds:o,pageSizes:l};e.blockElement.firstElementChild.innerHTML===""&&(e.blockElement.style.alignSelf="",e.blockElement.firstElementChild.outerHTML=`<div class="av__gallery">
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
</div>`);const c=(t=e.protyle.options.history)==null?void 0:t.created,u=(a=e.protyle.options.history)==null?void 0:a.snapshot;let g=e.data;if(!g){const f=ei(e.blockElement);g=(yield jn(c?"/api/av/renderHistoryAttributeView":u?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:e.blockElement.getAttribute("data-av-id"),created:c,snapshot:u,pageSize:f.unGroupPageSize,groupPaging:f.groupPageSize,viewID:e.blockElement.getAttribute(H.CUSTOM_SY_AV_VIEW)||"",query:r.query.trim()})).data}if(g.viewType==="table"){e.blockElement.setAttribute("data-av-type","table"),Ze(e.blockElement,e.protyle,e.cb,e.renderAll);return}const m=g.view;if(((n=m.groups)==null?void 0:n.length)>0){fr({blockElement:e.blockElement,protyle:e.protyle,cb:e.cb,renderAll:e.renderAll,data:g,resetData:r});return}const d=ui(m);if(e.renderAll)e.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${Oa(g,r.isSearching||!!r.query,!e.protyle.disabled&&!F(e.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div>
        <div class="av__body" data-group-id="" data-page-size="${m.pageSize}">
            ${d}
        </div>
    </div>
    <div class="av__cursor" contenteditable="true">${H.ZWSP}</div>
</div>`;else{const f=e.blockElement.querySelector(".av__body");f.innerHTML=d,f.dataset.pageSize=m.pageSize.toString()}fi({resetData:r,renderAll:e.renderAll,data:g,cb:e.cb,protyle:e.protyle,blockElement:e.blockElement}),m.hideAttrViewName&&e.blockElement.querySelector(".av__gallery").classList.add("av__gallery--top")}),Oa=(e,t,a)=>{let n="",i,s=!1;return Ds(e).forEach(o=>{s||e.view.filters.find(l=>{if(l.value.type===o.type&&o.id===l.column)return s=!0,!0})}),e.views.forEach(o=>{n+=`<div draggable="true" data-position="north" data-av-type="${o.type}" data-id="${o.id}" data-page="${o.pageSize}" data-desc="${Zo(o.desc||"")}" class="ariaLabel item${o.id===e.viewID?" item--focus":""}">
    ${o.icon?ve(o.icon,"item__graphic",!0):`<svg class="item__graphic"><use xlink:href="#${va(o.type)}"></use></svg>`}
    <span class="item__text">${Ba(o.name)}</span>
</div>`,o.id===e.viewID&&(i=o)}),`<div class="av__header">
        <div class="fn__flex av__views${t?" av__views--show":""}">
            <div class="layout-tab-bar fn__flex">
                ${n}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newView}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" aria-label="${window.siyuan.languages.allViews}" data-position="8south" class="ariaLabel block__icon${e.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
                <span class="fn__space"></span>
                <small>${e.views.length}</small>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" aria-label="${window.siyuan.languages.filter}" data-position="8south" class="ariaLabel block__icon${s?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" aria-label="${window.siyuan.languages.sort}" data-position="8south" class="ariaLabel block__icon${e.view.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <button data-type="av-search-icon" aria-label="${window.siyuan.languages.search}" data-position="8south" class="ariaLabel block__icon">
                <svg><use xlink:href="#iconSearch"></use></svg>
            </button>
            <div style="position: relative" class="fn__flex">
                <input style="${t?"width:128px":"width:0;padding-left: 0;padding-right: 0;"}" data-type="av-search" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <span data-type="av-more" aria-label="${window.siyuan.languages.config}" data-position="8south" class="ariaLabel block__icon">
                <svg><use xlink:href="#iconSettings"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newRow}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${e.isMirror?` <span data-av-id="${e.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block block__icon block__icon--show ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${a}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title${i.hideAttrViewName?" fn__none":""}" data-title="${e.name||""}" data-tip="${window.siyuan.languages._kernel[267]}">${e.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>`},mi=(e,t)=>{let a="",n='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',i=-1,s=-1,o=0;const l=t.clientWidth;e.columns.forEach((c,u)=>{c.hidden||(c.pin&&(i=u),o<l-200&&(o+=parseInt(c.width)||200,s=u))}),l===0&&(s=i),i=Math.min(i,s),i>-1&&(n='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',a='<div class="av__colsticky">');let r=!1;return e.columns.forEach((c,u)=>{var g;c.hidden||(n+=`<div class="av__cell av__cell--header" data-col-id="${c.id}"  draggable="true" 
data-icon="${c.icon}" data-dtype="${c.type}" data-wrap="${c.wrap}" data-pin="${c.pin}" 
data-desc="${Lt(c.desc)}" data-position="north" 
style="width: ${c.width||"200px"};">
    ${c.icon?ve(c.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Ke(c.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${Ba(c.name)}</span>
    ${c.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,i===u&&(n+="</div>"),c.type==="lineNumber"?a+=`<div data-col-id="${c.id}" data-dtype="${c.type}" class="av__calc" style="width: ${c.width||"200px"}">&nbsp;</div>`:a+=`<div class="av__calc${c.calc&&c.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${c.id}" data-dtype="${c.type}" data-operator="${((g=c.calc)==null?void 0:g.operator)||""}" 
style="width: ${c.width||"200px"}">${Oo(c)||`<svg><use xlink:href="#iconDown"></use></svg><small>${window.siyuan.languages.calc}</small>`}</div>`,c.calc&&c.calc.operator!==""&&(r=!0),i===u&&(a+="</div>"))}),n+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newCol}" data-type="av-header-add" data-position="4south"><svg><use xlink:href="#iconAdd"></use></svg></div>
</div>
</div>`,e.rows.forEach((c,u)=>{n+=`<div class="av__row" data-id="${c.id}">`,i>-1?n+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':n+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',c.cells.forEach((g,m)=>{var d,f,b;if(e.columns[m].hidden)return;let p="";g.valueType==="checkbox"&&(p=(f=(d=g.value)==null?void 0:d.checkbox)!=null&&f.checked?" av__cell-check":" av__cell-uncheck"),n+=`<div class="av__cell${p}" data-id="${g.id}" data-col-id="${e.columns[m].id}" 
data-wrap="${e.columns[m].wrap}" 
data-dtype="${e.columns[m].type}" 
${(b=g.value)!=null&&b.isDetached?' data-detached="true"':""} 
style="width: ${e.columns[m].width||"200px"};
${g.valueType==="number"?"text-align: right;":""}
${g.bgColor?`background-color:${g.bgColor};`:""}
${g.color?`color:${g.color};`:""}">${Pa(g.value,u,e.showIcon)}</div>`,i===m&&(n+="</div>")}),n+="<div></div></div>"}),`${n}<div class="av__row--util${e.rowCount>e.rows.length?" av__readonly--show":""}">
    <div class="av__colsticky">
        <button class="b3-button av__button" data-type="av-add-bottom">
            <svg><use xlink:href="#iconAdd"></use></svg>
            <span>${window.siyuan.languages.newRow}</span>
        </button>
        <span class="fn__space"></span>
        <button class="b3-button av__button${e.rowCount>e.rows.length?"":" fn__none"}" data-type="av-load-more">
            <svg><use xlink:href="#iconArrowDown"></use></svg>
            <span>${window.siyuan.languages.loadMore}</span>
            <svg data-type="set-page-size" data-size="${e.pageSize}"><use xlink:href="#iconMore"></use></svg>
        </button>
    </div>
</div>
<div class="av__row--footer${r?" av__readonly--show":""}">${a}</div>`},pi=(e,t)=>{let a="";return["mSelect","select"].includes(e.groupValue.type)?e.groupValue.mSelect.forEach(n=>{a+=`<span class="b3-chip" style="background-color:var(--b3-font-background${n.color});color:var(--b3-font-color${n.color})">${Ba(n.content)}</span>`}):e.groupValue.type==="checkbox"?a=`<svg style="width:calc(1.625em - 12px);height:calc(1.625em - 12px)"><use xlink:href="#icon${e.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg>`:a=e.name,`<div class="av__group-title">
    <div class="av__group-icon" data-type="av-group-fold" data-id="${e.id}">
        <svg class="${e.groupFolded?"":"av__group-arrow--open"}"><use xlink:href="#iconRight"></use></svg>
    </div>
    <span class="fn__space"></span>
    <span class="av__group-name">${a}</span>
    ${t===0?'<span class="fn__space"></span>':`<span class="av__group-counter">${t}</span>`}
    <span class="av__group-icon av__group-icon--hover ariaLabel" data-type="av-add-top" data-position="north" aria-label="${window.siyuan.languages.newRow}"><svg><use xlink:href="#iconAdd"></use></svg></span>
</div>`},gr=e=>{const t=e.blockElement.querySelector('[data-type="av-search"]'),a=t&&document.activeElement===t,n=(t==null?void 0:t.value)||"";let i="";e.data.view.groups.forEach(s=>{var o;s.groupHidden===0&&(i+=`${pi(s,s.rows.length)}
<div data-group-id="${s.id}" data-page-size="${s.pageSize}" data-dtype="${s.groupKey.type}" data-content="${Lute.EscapeHTMLStr((o=s.groupValue.text)==null?void 0:o.content)}" style="float: left" class="av__body${s.groupFolded?" fn__none":""}">${mi(s,e.blockElement)}</div>`)}),e.renderAll?e.blockElement.firstElementChild.outerHTML=`<div class="av__container">
    ${Oa(e.data,a||!!n,!e.protyle.disabled&&!F(e.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__scroll">
        ${i}
    </div>
    <div class="av__cursor" contenteditable="true">${H.ZWSP}</div>
</div>`:e.blockElement.firstElementChild.querySelector(".av__scroll").innerHTML=i,bi(e)},bi=e=>{var t;e.blockElement.getAttribute("data-need-focus")==="true"&&(Ae(e.blockElement),e.blockElement.removeAttribute("data-need-focus")),e.blockElement.setAttribute("data-render","true"),e.blockElement.querySelector(".av__scroll").scrollLeft=e.resetData.left,e.blockElement.style.alignSelf=e.resetData.alignSelf;const a=e.protyle.contentElement.getBoundingClientRect();if(e.resetData.headerTransform){const s=e.blockElement.querySelector('.av__row--header[style^="transform"]');s&&(s.style.transform=e.resetData.headerTransform)}else setTimeout(()=>{qa(e.blockElement,a,"top")},H.TIMEOUT_LOAD);if(e.resetData.footerTransform){const s=e.blockElement.querySelector('.av__row--footer[style^="transform"]');s&&(s.style.transform=e.resetData.footerTransform)}else setTimeout(()=>{qa(e.blockElement,a,"bottom")},H.TIMEOUT_LOAD);if(e.resetData.selectCellId){let s=e.blockElement.querySelector(`.av__body[data-group-id="${e.resetData.selectCellId.groupId}"] .av__row[data-id="${e.resetData.selectCellId.rowId}"] .av__cell[data-col-id="${e.resetData.selectCellId.colId}"]`);s||(s=e.blockElement.querySelector(`.av__row[data-id="${e.resetData.selectCellId.rowId}"] .av__cell[data-col-id="${e.resetData.selectCellId.colId}"]`)),s&&(s.classList.add("av__cell--select"),si(e.blockElement,s));const o=document.querySelector(".av__mask"),l=document.querySelector(".av__panel");if(o)(t=o.querySelector("textarea, input"))==null||t.focus();else if(!l&&!e.resetData.isSearching&&getSelection().rangeCount>0){const r=getSelection().getRangeAt(0),c=G(r.startContainer);c&&e.blockElement===c&&Ae(e.blockElement)}else l&&!s&&l.remove()}if(e.resetData.selectRowIds.forEach((s,o)=>{let l=e.blockElement.querySelector(`.av__body[data-group-id="${s.groupId}"] .av__row[data-id="${s.rowId}"]`);l||(l=e.blockElement.querySelector(`.av__row[data-id="${s.rowId}"]`)),l&&(l.classList.add("av__row--select"),l.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck")),o===e.resetData.selectRowIds.length-1&&l&&Wn(l)}),Object.keys(e.resetData.pageSizes).forEach(s=>{const o=e.blockElement.querySelector(`.av__body[data-group-id="${s==="unGroup"?"":s}"]`);o&&(o.dataset.pageSize=e.resetData.pageSizes[s])}),e.resetData.dragFillId){let s=e.blockElement.querySelector(`.av__body[data-group-id="${e.resetData.dragFillId.groupId}"] .av__row[data-id="${e.resetData.dragFillId.rowId}"] .av__cell[data-col-id="${e.resetData.dragFillId.colId}"]`);s||(s=e.blockElement.querySelector(`.av__row[data-id="${e.resetData.dragFillId.rowId}"] .av__cell[data-col-id="${e.resetData.dragFillId.colId}"]`)),Ra(s)}if(e.resetData.activeIds.forEach(s=>{let o=e.blockElement.querySelector(`.av__body[data-group-id="${s.groupId}"] .av__row[data-id="${s.rowId}"] .av__cell[data-col-id="${s.colId}"]`);o||(o=e.blockElement.querySelector(`.av__row[data-id="${s.rowId}"] .av__cell[data-col-id="${s.colId}"]`)),o==null||o.classList.add("av__cell--active")}),getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);if(!U(s.startContainer,"av__title")){const o=G(s.startContainer);o&&e.blockElement===o&&!e.resetData.isSearching&&Ae(e.blockElement)}}if(e.blockElement.querySelector(".layout-tab-bar").scrollLeft=e.blockElement.querySelector(".layout-tab-bar .item--focus").offsetLeft-30,e.cb&&e.cb(e.data),!e.renderAll)return;const n=e.blockElement.querySelector(".av__views"),i=e.blockElement.querySelector('[data-type="av-search"]');i.value=e.resetData.query||"",e.resetData.isSearching&&i.focus(),i.addEventListener("compositionstart",s=>{s.stopPropagation()}),i.addEventListener("keydown",s=>{s.isComposing||Jt(s)}),i.addEventListener("input",s=>{s.stopPropagation(),!s.isComposing&&(i.value||document.activeElement===i?n.classList.add("av__views--show"):n.classList.remove("av__views--show"),qt(e.blockElement,e.protyle))}),i.addEventListener("compositionend",()=>{qt(e.blockElement,e.protyle)}),i.addEventListener("blur",s=>{s.isComposing||i.value||(n.classList.remove("av__views--show"),i.style.width="0",i.style.paddingLeft="0",i.style.paddingRight="0")}),di({inputElement:i,right:0,width:"1em",height:i.clientHeight,clearCB(){n.classList.remove("av__views--show"),i.style.width="0",i.style.paddingLeft="0",i.style.paddingRight="0",Ae(e.blockElement),qt(e.blockElement,e.protyle)}})},Ze=(e,t,a,n=!0)=>{let i=[];e.getAttribute("data-type")==="NodeAttributeView"?i=[e]:i=Array.from(e.querySelectorAll('[data-type="NodeAttributeView"]')),i.length!==0&&i.length>0&&i.forEach(s=>{var o,l,r,c,u;if(s.removeAttribute("data-rendering"),s.getAttribute("data-render")==="true"||U(s,"av__gallery-content"))return;if((O()||Mt()||Ve()||ft())&&s.classList.add("av--touch"),s.getAttribute("data-av-type")==="gallery"){gi({blockElement:s,protyle:t,cb:a,renderAll:n});return}let g;const m=s.querySelector(".av__cell--select");m&&(g={groupId:U(m,"av__body").dataset.groupId||"",rowId:U(m,"av__row").dataset.id,colId:m.getAttribute("data-col-id")});const d=[];s.querySelectorAll(".av__row--select").forEach(v=>{const h=v.getAttribute("data-id");h&&d.push({groupId:U(v,"av__body").dataset.groupId||"",rowId:h})});let f;const b=s.querySelector(".av__drag-fill");b&&(f={groupId:U(b,"av__body").dataset.groupId||"",rowId:U(b,"av__row").dataset.id,colId:b.parentElement.getAttribute("data-col-id")});const p=[];s.querySelectorAll(".av__cell--active").forEach(v=>{p.push({groupId:U(v,"av__body").dataset.groupId||"",rowId:U(v,"av__row").dataset.id,colId:v.getAttribute("data-col-id")})});const y=s.querySelector('[data-type="av-search"]'),_={};s.querySelectorAll(".av__body").forEach(v=>{_[v.dataset.groupId||"unGroup"]=v.dataset.pageSize});const k={selectCellId:g,alignSelf:s.style.alignSelf,left:((o=s.querySelector(".av__scroll"))==null?void 0:o.scrollLeft)||0,headerTransform:(l=s.querySelector('.av__row--header[style^="transform"]'))==null?void 0:l.style.transform,footerTransform:(r=s.querySelector(".av__row--footer"))==null?void 0:r.style.transform,isSearching:y&&document.activeElement===y,selectRowIds:d,dragFillId:f,activeIds:p,query:(y==null?void 0:y.value)||"",pageSizes:_};if(s.firstElementChild.innerHTML===""){s.style.alignSelf="";let v="";[1,2,3].forEach(()=>{v+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),s.firstElementChild.innerHTML=v}const x=(c=t.options.history)==null?void 0:c.created,T=(u=t.options.history)==null?void 0:u.snapshot,w=ei(s);Ce(x?"/api/av/renderHistoryAttributeView":T?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:s.getAttribute("data-av-id"),created:x,snapshot:T,pageSize:w.unGroupPageSize,groupPaging:w.groupPageSize,viewID:s.getAttribute(H.CUSTOM_SY_AV_VIEW)||"",query:k.query.trim(),blockID:s.getAttribute("data-node-id")},v=>{var h;const E=v.data.view;if(v.data.viewType==="gallery"){s.setAttribute("data-av-type","table"),gi({blockElement:s,protyle:t,cb:a,renderAll:n,data:v.data});return}if(((h=E.groups)==null?void 0:h.length)>0){gr({blockElement:s,protyle:t,cb:a,renderAll:n,data:v.data,resetData:k});return}const C=`<div class="av__body" data-group-id="" data-page-size="${E.pageSize}" style="float: left">
    ${mi(E,s)}
</div>`;n?s.firstElementChild.outerHTML=`<div class="av__container">
    ${Oa(v.data,k.isSearching||!!k.query,!t.disabled&&!F(s,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__scroll">
        ${C}
    </div>
    <div class="av__cursor" contenteditable="true">${H.ZWSP}</div>
</div>`:s.firstElementChild.querySelector(".av__scroll").innerHTML=C,bi({renderAll:n,data:v.data,cb:a,protyle:t,blockElement:s,resetData:k}),s.style.margin=""})})};let yi;const qt=(e,t)=>{clearTimeout(yi),yi=window.setTimeout(()=>{e.removeAttribute("data-render"),Ze(e,t,void 0,!1)},H.TIMEOUT_INPUT)},hi={},Fg=(e,t)=>{if(t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.id}"]`)).forEach(a=>{const n=a.querySelector(".av__title");n&&(n.textContent=t.data,n.dataset.title=t.data)}),t.action==="setAttrViewColWidth"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{const n=a.querySelector(`.av__cell[data-col-id="${t.id}"]`);!n||n.style.width===t.data||a.getAttribute(Constants.CUSTOM_SY_AV_VIEW)!==t.keyID||a.querySelectorAll(".av__row").forEach(i=>{i.querySelector(`[data-col-id="${t.id}"]`).style.width=t.data})});return}if(t.action==="setAttrViewCardSize"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{a.querySelectorAll(".av__gallery").forEach(n=>{n.classList.remove("av__gallery--small","av__gallery--big"),t.data===0?n.classList.add("av__gallery--small"):t.data===2&&n.classList.add("av__gallery--big")})});return}if(t.action==="setAttrViewCardAspectRatio"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{a.querySelectorAll(".av__gallery-cover").forEach(n=>{n.className="av__gallery-cover av__gallery-cover--"+t.data})});return}if(t.action==="hideAttrViewName"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{const n=a.querySelector(".av__title");if(n&&(t.data?n.classList.add("fn__none"):n.classList.remove("fn__none"),a.getAttribute("data-av-type")==="gallery"&&!a.querySelector(".av__group-title"))){const i=a.querySelector(".av__gallery");t.data?i.classList.add("av__gallery--top"):i.classList.remove("av__gallery--top")}});return}if(t.action==="setAttrViewWrapField"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{a.querySelectorAll(".av__cell").forEach(n=>{n.setAttribute("data-wrap",t.data.toString())})});return}if(t.action==="setAttrViewFitImage"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"] .av__gallery-img`)).forEach(a=>{t.data?a.classList.add("av__gallery-img--fit"):a.classList.remove("av__gallery-img--fit")});return}if(t.action==="setAttrViewShowIcon"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{a.querySelectorAll('.av__cell[data-dtype="block"] .b3-menu__avemoji, .av__cell[data-dtype="relation"] .b3-menu__avemoji').forEach(n=>{t.data?n.classList.remove("fn__none"):n.classList.add("fn__none")})});return}if(t.action==="setAttrViewColWrap"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{a.querySelectorAll(`.av__cell[data-col-id="${t.id}"],.av__cell[data-field-id="${t.id}"]`).forEach(n=>{n.setAttribute("data-wrap",t.data.toString())})});return}if(t.action==="foldAttrViewGroup"){Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.avID}"]`)).forEach(a=>{const n=a.querySelector(`[data-type="av-group-fold"][data-id="${t.id}"]`);n&&(t.data?(n.firstElementChild.classList.remove("av__group-arrow--open"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.firstElementChild.classList.add("av__group-arrow--open"),n.parentElement.nextElementSibling.classList.remove("fn__none")),n.removeAttribute("data-folding"))});return}clearTimeout(hi[e.id]),hi[e.id]=window.setTimeout(()=>{const a=t.action==="setAttrViewName"?t.id:t.avID,n=document.querySelector(`.b3-dialog--open[data-key="${Constants.DIALOG_ATTR}"] .custom-attr > [data-av-id="${a}"]`);n&&(n.removeAttribute("data-rendering"),renderAVAttribute(n.parentElement,n.dataset.nodeId,e)),Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${a}"]`)).forEach(i=>{var s;if(i.removeAttribute("data-render"),t.action==="sortAttrViewRow")clearSelect(["cell"],i);else if(t.action==="sortAttrViewCol")i.querySelectorAll(".av__cell--active").forEach(l=>{var r;l.classList.remove("av__cell--active"),(r=l.querySelector(".av__drag-fill"))==null||r.remove()}),addDragFill(i.querySelector(".av__cell--select"));else if(t.action==="setAttrViewBlockView"){const l=i.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${t.id}"]`);l&&i.querySelectorAll(".av__body").forEach(r=>{r.dataset.pageSize=l.dataset.page})}else if(t.action==="addAttrViewView")i.querySelectorAll(".av__body").forEach(l=>{l.dataset.pageSize="50"});else if(t.action==="removeAttrViewView")i.querySelectorAll(".av__body").forEach(l=>{var r;l.dataset.pageSize=(r=i.querySelector(`.av__views > .layout-tab-bar .item[data-id="${i.getAttribute(Constants.CUSTOM_SY_AV_VIEW)}"]`))==null?void 0:r.getAttribute("data-page")});else if(t.action==="sortAttrViewView"&&t.data==="unRefresh"){const l=i.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${t.id}"]`);if(l&&!t.previousID&&!l.previousElementSibling)return;if(l&&t.previousID&&((s=l.previousElementSibling)==null?void 0:s.getAttribute("data-id"))===t.previousID)return}const o=i.querySelector('[data-type="ghost"]');Ze(i,e,()=>{var l,r;if(t.action==="insertAttrViewBlock"&&((l=t.context)==null?void 0:l.ignoreTip)!=="true")if((r=t.context)!=null&&r.message)showMessage(t.context.message);else{const c=t.groupID?`[data-group-id="${t.groupID}"]`:"";if(i.getAttribute("data-av-type")==="gallery"&&t.srcs.forEach(u=>{var g,m;const d=(g=i.querySelector(`.av__body${c} .av__gallery-item[data-id="${u.itemID}"]`))==null?void 0:g.querySelector(".av__gallery-fields");d&&((m=d.querySelector('[data-dtype="block"]'))==null?void 0:m.parentElement.getAttribute("data-empty"))==="true"&&d.classList.add("av__gallery-fields--edit")}),t.srcs.length===1){let u=i.querySelector(`.av__body${c} [data-id="${t.srcs[0].itemID}"] .av__cell[data-dtype="block"]`);if(!u){const g=i.querySelectorAll(`.av__body [data-id="${t.srcs[0].itemID}"] .av__cell[data-dtype="block"]`);g.length===1&&(u=g[0])}u&&u.getAttribute("data-detached")==="true"&&u.querySelector(".av__celltext").textContent===""&&u.getBoundingClientRect().height!==0&&o&&popTextCell(e,[u],"block")}t.srcs.find(u=>{if(!i.querySelector(`.av__body [data-id="${u.itemID}"]`)&&!i.querySelector(`.av__body [data-dtype="block"] .av__celltext--ref[data-id="${u.id}"]`))return showMessage(window.siyuan.languages.insertRowTip),!0})}else t.action==="addAttrViewView"&&i.getAttribute("data-node-id")===t.blockID&&openMenuPanel({protyle:e,blockElement:i,type:"config"});i.removeAttribute("data-loading")})})},["insertAttrViewBlock"].includes(t.action)?2:100)},Ut=e=>{if(e.action||(e.action=[]),e.protyle.wysiwyg.element.removeAttribute("data-top"),e.data.code===1){e.action.includes(H.CB_GET_APPEND)||(e.protyle.model?e.protyle.model.parent.parent.removeTab(e.protyle.model.parent.id,!1):e.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);return}if(e.data.code!==3&&(e.protyle.notebookId=e.data.data.box,e.protyle.path=e.data.data.path,!(e.data.data.eof&&!e.scrollAttr&&(e.action.includes(H.CB_GET_BEFORE)?e.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):e.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),e.data.data.mode!==4)))){if(Nt(["gutterOnly"],e.protyle),e.protyle.block.parentID=e.data.data.parentID,e.protyle.block.parent2ID=e.data.data.parent2ID,e.protyle.block.rootID=e.data.data.rootID,e.protyle.block.showAll=e.action.includes(H.CB_GET_ALL),e.protyle.block.mode=e.data.data.mode,e.protyle.block.blockCount=e.data.data.blockCount,e.protyle.block.scroll=e.data.data.scroll,e.protyle.block.action=e.action,e.action.includes(H.CB_GET_UNCHANGEID)||(e.protyle.block.id=e.data.data.id,e.protyle.scroll.lastScrollTop=0,e.protyle.contentElement.scrollTop=0,e.protyle.wysiwyg.element.setAttribute("data-doc-type",e.data.data.type)),!(e.protyle.options.render.title&&e.protyle.title.element.getAttribute("data-render")!=="true")){if(e.action.includes(H.CB_GET_APPEND)||e.action.includes(H.CB_GET_BEFORE)||e.action.includes(H.CB_GET_HTML)){e.protyle.options.render.title&&e.protyle.options.render.hideTitleOnZoom&&(e.protyle.block.showAll?e.protyle.title.element.classList.add("fn__none"):e.protyle.title.element.classList.remove("fn__none")),_i({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),Hi(e.protyle);return}}Ce("/api/block/getDocInfo",{id:e.protyle.block.rootID},t=>{e.protyle.options.render.title?e.protyle.title.render(e.protyle,t):(e.protyle.options.render.background&&e.protyle.background.render(t.data.ial,e.protyle.block.rootID),e.protyle.wysiwyg.renderCustom(t.data.ial)),_i({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),Hi(e.protyle)})}},_i=(e,t)=>{var a;if(t.contentElement.classList.contains("fn__none")&&t.wysiwyg.element.innerHTML!=="")return;const i=new DOMParser().parseFromString(e.content,"text/html");i.querySelectorAll("[data-inline-memo-content]").forEach(l=>{const r=l.getAttribute("data-inline-memo-content");r&&l.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(r))}),e.content=i.body.innerHTML;const s=t.contentElement.clientHeight*8,o=typeof e.updateReadonly=="undefined"?t.wysiwyg.element.innerHTML==="":e.updateReadonly;if(e.action.includes(H.CB_GET_APPEND)){if(!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad&&t.contentElement.scrollHeight>s){let l=t.wysiwyg.element.firstElementChild;const r=[];for(;t.wysiwyg.element.childElementCount>2&&r&&t.wysiwyg.element.lastElementChild!==l&&t.contentElement.scrollHeight-l.offsetTop>s;){r.push(l);l=l.nextElementSibling}const c=l.getBoundingClientRect().top;r.forEach(u=>{u.remove()}),t.contentElement.scrollTop=t.contentElement.scrollTop+(l.getBoundingClientRect().top-c)-1,t.scroll.lastScrollTop=t.contentElement.scrollTop,Nt(["toolbar"],t)}t.wysiwyg.element.insertAdjacentHTML("beforeend",e.content)}else if(e.action.includes(H.CB_GET_BEFORE)){const l=t.wysiwyg.element.firstElementChild,r=l.getBoundingClientRect().top;if(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.content),t.contentElement.scrollTop=t.contentElement.scrollTop+(l.getBoundingClientRect().top-r),t.scroll.lastScrollTop=t.contentElement.scrollTop,!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad){const c=[];let u=t.wysiwyg.element.childElementCount,g=t.contentElement.scrollHeight,m=t.wysiwyg.element.lastElementChild;for(;u>2&&g>s&&m.getBoundingClientRect().top>window.innerHeight;)c.push(m),m=m.previousElementSibling,u--,g-=m.clientHeight+8;c.forEach(d=>{d.remove()}),Nt(["toolbar"],t)}}else t.wysiwyg.element.innerHTML=e.content;if(t.wysiwyg.element.querySelectorAll("video, audio").forEach(l=>{l.addEventListener("playing",()=>{vn(),console.log("playing")})}),!t.block.showAll&&t.wysiwyg.element.childElementCount===1&&t.wysiwyg.element.firstElementChild.classList.contains("p")){const l=Te(t.wysiwyg.element.firstElementChild);l&&l.textContent===""&&(l.classList.add("protyle-wysiwyg--empty"),l.setAttribute("placeholder",window.siyuan.languages.emptyMobilePlaceholder))}if(e.action.includes(H.CB_GET_BACKLINK)&&vi(e.expand,t.wysiwyg.element),ht(t.wysiwyg.element),Tt(t.wysiwyg.element),Ze(t.wysiwyg.element,t),Xe(t,t.wysiwyg.element),!e.action.includes(H.CB_GET_HISTORY)){if(t.options.render.scroll&&t.scroll.update(t),e.action.includes(H.CB_GET_FOCUSFIRST)){const l=t.wysiwyg.element.offsetTop-16;mn(t,l,H.TIMEOUT_INPUT),t.contentElement.scrollTop=l}if(e.isSyncing?mr(t):(t.breadcrumb&&(t.breadcrumb.element.nextElementSibling.textContent=""),t.element.removeAttribute("disabled-forever"),e.action.includes(H.CB_GET_OPENNEW)&&window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly?wi(t):br(t,o)),pr(t,e.action,e.scrollAttr),e.action.includes(H.CB_GET_SETID)&&(t.block.id=t.block.rootID,t.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),(a=t.options.defIds)==null||a.forEach(l=>{t.wysiwyg.element.querySelectorAll(`[data-id="${l}"]`).forEach(r=>{r.classList.add("def--mark")})}),t.options.defIds=[],e.action.includes(H.CB_GET_APPEND)||e.action.includes(H.CB_GET_BEFORE)){t.app.plugins.forEach(l=>{l.eventBus.emit("loaded-protyle-dynamic",{protyle:t,position:e.action.includes(H.CB_GET_APPEND)?"afterend":"beforebegin"})});return}!t.disabled&&!e.action.includes(H.CB_GET_ALL)&&t.background&&t.background.element.classList.add("protyle-background--mobileshow"),t.options.render.breadcrumb&&(t.breadcrumb.toggleExit(!e.action.includes(H.CB_GET_ALL)),t.breadcrumb.render(t)),e.afterCB&&e.afterCB(),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("block__edit")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&t.contentElement.scrollHeight>0&&!e.action.includes(H.CB_GET_FOCUSFIRST)&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&Ce("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{Ut({data:l,protyle:t,action:[H.CB_GET_APPEND,H.CB_GET_UNCHANGEID]})}),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("fn__none")&&t.scroll.updateIndex(t,e.scrollAttr.startId,l=>{l>1&&t.block.blockCount>1&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&tt(window.siyuan.languages.scrollGetMore)}),t.app.plugins.forEach(l=>{l.eventBus.emit("loaded-protyle-static",{protyle:t})})}},mr=e=>{Fn(e),e.breadcrumb&&!O()?e.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:tt(window.siyuan.languages._kernel[81]),e.element.setAttribute("disabled-forever","true")},Fn=e=>{if(window.siyuan.menus.menu.remove(),Nt(["gutter","toolbar","select","hint","util"],e),e.disabled=!0,e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","false"),e.title.editElement.style.userSelect="text"),document.getElementById("toolbarName").setAttribute("readonly","readonly"),e.background&&(e.background.element.classList.remove("protyle-background--enable"),e.background.element.classList.remove("protyle-background--mobileshow")),e.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(t=>{t.classList.remove("protyle-icons--show")}),e.wysiwyg.element.querySelectorAll(".av__gallery-fields--edit").forEach(t=>{t.classList.remove("av__gallery-fields--edit")}),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(t=>{var a;t.classList.add("fn__none"),t.classList.contains("protyle-icon--first")&&((a=t.nextElementSibling)==null||a.classList.add("protyle-icon--first"))}),e.wysiwyg.element.style.userSelect="text",e.wysiwyg.element.setAttribute("contenteditable","false"),e.wysiwyg.element.setAttribute("data-readonly","true"),e.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(t=>{t.setAttribute("contenteditable","false")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(t=>{t.setAttribute("draggable","false")}),e.breadcrumb){const t=e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]');t.querySelector("use").setAttribute("xlink:href","#iconLock"),t.setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit),t.setAttribute("data-subtype","lock");const a=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&!a.classList.contains("fn__none")&&(a.classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.add("fn__none"))}ba()},wi=e=>{if(e.element.getAttribute("disabled-forever")==="true")return;e.disabled=!1,O()?document.getElementById("toolbarName").removeAttribute("readonly"):(e.wysiwyg.element.setAttribute("contenteditable","true"),e.wysiwyg.element.style.userSelect=""),e.wysiwyg.element.setAttribute("data-readonly","false"),e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","true"),e.title.editElement.style.userSelect=""),e.background&&e.background.element.classList.add("protyle-background--enable"),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(a=>{var n;a.classList.remove("fn__none"),a.classList.contains("protyle-icon--first")&&((n=a.nextElementSibling)==null||n.classList.remove("protyle-icon--first"))}),e.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(a=>{U(a,"protyle-wysiwyg__embed")||a.setAttribute("contenteditable","true")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(a=>{a.setAttribute("draggable","true")});const t=e.contentElement.getBoundingClientRect();if(e.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.querySelector(".av__scroll")&&qa(a,t,"all")}),e.breadcrumb){const a=e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]');a.querySelector("use").setAttribute("xlink:href","#iconUnlock"),a.setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit),a.setAttribute("data-subtype","unlock");const n=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&n.classList.contains("fn__none")&&(n.classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.remove("fn__none"))}ba()},pr=(e,t,a)=>{var n;let i;if(a&&a.focusId?i=e.wysiwyg.element.querySelector(`[data-node-id="${a.focusId}"]`):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${e.block.id}"]`)).find(o=>{if(!F(o,"data-type","block-render",!0))return i=o,!0}),e.block.mode===4?(mn(e),i=e.wysiwyg.element.lastElementChild):(!i||t.includes(H.CB_GET_FOCUSFIRST))&&(i=e.wysiwyg.element.firstElementChild),t.includes(H.CB_GET_HL)&&(mn(e),pa(i)),t.includes(H.CB_GET_FOCUS)||t.includes(H.CB_GET_FOCUSFIRST)){let o;a&&a.focusId?o=ja(i,a.focusStart,a.focusEnd):Ae(i,void 0,!t.includes(H.CB_GET_OUTLINE))}const s=a&&typeof a.scrollTop=="number";if(s&&(e.contentElement.scrollTop=a.scrollTop),(n=e.observerLoad)==null||n.disconnect(),t.includes(H.CB_GET_FOCUS)||t.includes(H.CB_GET_SCROLL)||t.includes(H.CB_GET_HL)||t.includes(H.CB_GET_FOCUSFIRST)){const o=e.contentElement.getBoundingClientRect(),l=i.getBoundingClientRect();!s&&(o.top>l.top||o.bottom<l.bottom)&&Gt(e,i,!0)}else return;e.observerLoad=new ResizeObserver(()=>{if(s&&(e.contentElement.scrollTop=a.scrollTop),t.includes(H.CB_GET_FOCUS)||t.includes(H.CB_GET_HL)||t.includes(H.CB_GET_FOCUSFIRST)){const o=e.contentElement.getBoundingClientRect(),l=i.getBoundingClientRect();!s&&(o.top>l.top||o.bottom<l.bottom)&&Gt(e,i,!0)}}),e.observerLoad.observe(e.wysiwyg.element),e.observer.unobserve(e.wysiwyg.element),setTimeout(()=>{e.observerLoad.disconnect(),e.observer.observe(e.wysiwyg.element)},1e3*3),i===e.wysiwyg.element.firstElementChild&&!s&&e.observerLoad.disconnect()},br=(e,t)=>{let a=window.siyuan.config.readonly?"true":"false";t?a==="false"&&(a=window.siyuan.config.editor.readOnly?"true":"false",a==="false"&&(a=e.wysiwyg.element.getAttribute(H.CUSTOM_SY_READONLY))):a=e.disabled?"true":"false",a==="true"?Fn(e):wi(e)},Yg=(e,t)=>{e.block.showAll=!0;let a="";t.forEach((n,i)=>{a+=ki(n.blockPaths,!1,i)+Ei(n.dom,n.expand)}),e.wysiwyg.element.innerHTML=a,Ci(e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),removeLoading(e),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&disabledProtyle(e)},vi=(e,t)=>{t.firstElementChild.classList.contains("li")?e?t.querySelectorAll(".li .li").forEach(a=>{a.childElementCount>3&&a.setAttribute("fold","1")}):t.firstElementChild.setAttribute("fold","1"):t.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(t.children).forEach((a,n)=>{(e&&n>2||!e&&n>1)&&((e&&n===3||!e&&n===2)&&a.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg style="transform: rotate(90deg);"><use xlink:href="#iconMore"></use></svg></div>'),a.classList.add("fn__none"))})},Ei=(e,t)=>{const a=document.createElement("template");return a.innerHTML=e,vi(t,a.content),a.innerHTML},Wg=(e,t)=>{fetchPost("/api/filetree/getDoc",{id:t.getAttribute("data-id"),size:Constants.SIZE_GET_MAX},a=>{t.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),t.classList.add("protyle-breadcrumb__item--active");let n=t.parentElement.nextElementSibling;for(;n&&!n.classList.contains("protyle-breadcrumb__bar");){const i=n;n=n.nextElementSibling,i.remove()}t.parentElement.insertAdjacentHTML("afterend",Ei(a.data.content,!0)),processRender(t.parentElement.parentElement),avRender(t.parentElement.parentElement,e),blockRender(e,t.parentElement.parentElement),a.data.isSyncing?disabledForeverProtyle(e):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?disabledProtyle(e):t.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&t.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(i=>{i.setAttribute("contenteditable","false")})})},jg=e=>{let t=e.nextElementSibling;for(;t&&!t.classList.contains("protyle-breadcrumb__bar");)t.classList.remove("fn__none"),t=t.nextElementSibling;e.remove()},ki=(e,t,a)=>{if(1>e.length)return`<div contenteditable="false" style="border-top: ${a===0?0:1}px solid var(--b3-border-color);min-height: 0;width: 100%;" class="protyle-breadcrumb__bar"><span></span></div>`;let n="";return e.forEach((i,s)=>{s===0&&!t||(n+=`<span class="protyle-breadcrumb__item${s===e.length-1?" protyle-breadcrumb__item--active":""}" data-id="${i.id}">
    <svg class="popover__block" data-id="${i.id}"><use xlink:href="#${is(i.type,i.subType)}"></use></svg>
    ${i.name?`<span class="protyle-breadcrumb__text" title="${i.name}">${i.name}</span>`:""}
</span>`,s!==e.length-1&&(n+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${n}</div>`},Ci=e=>{e.querySelectorAll(".protyle-breadcrumb__bar").forEach(t=>{t.classList.remove("protyle-breadcrumb__bar--nowrap");const a=Array.from(t.querySelectorAll(".protyle-breadcrumb__text"));if(a.length===0)return;let n=!1;const i=F(t,"data-type","NodeBlockQueryEmbed");for(;t.scrollHeight>30&&!n&&a.length>1;)a.find((s,o)=>{if(o>(i?0:-1)){if(!s.classList.contains("protyle-breadcrumb__text--ellipsis"))return s.classList.add("protyle-breadcrumb__text--ellipsis"),!0;o===a.length-1&&s.classList.contains("protyle-breadcrumb__text--ellipsis")&&(n=!0)}});t.classList.add("protyle-breadcrumb__bar--nowrap"),t.lastElementChild&&(t.scrollLeft=t.lastElementChild.offsetLeft-t.clientWidth+14)})},Xe=(e,t,a)=>{let n=[];t.getAttribute("data-type")==="NodeBlockQueryEmbed"?n=[t]:n=Array.from(t.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),n.length!==0&&n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;if(i.setAttribute("data-render","true"),be(i),i.childElementCount>3){i.style.height=i.clientHeight-4+"px";for(let l=1;l<i.children.length-1;l++)i.children[l].classList.contains("protyle-cursor")||(i.children[l].remove(),l--)}const s=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));let o=i.getAttribute("breadcrumb");if(o?o=o==="true":o=window.siyuan.config.editor.embedBlockBreadcrumb,s.startsWith("//!js"))try{const l=new Function("fetchSyncPost","item","protyle","top",s)(jn,i,e,a);if(l instanceof Promise)l.then(r=>{if(Array.isArray(r))Ce("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:r,headingMode:["0","1","2"].includes(i.getAttribute("custom-heading-mode"))?parseInt(i.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,breadcrumb:o},c=>{na(c.data.blocks||[],e,i,a)});else return}).catch(r=>{na([],e,i,a,r)});else if(Array.isArray(l))Ce("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:l,headingMode:["0","1","2"].includes(i.getAttribute("custom-heading-mode"))?parseInt(i.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,breadcrumb:o},r=>{na(r.data.blocks||[],e,i,a)});else return}catch(l){na([],e,i,a,l)}else Ce("/api/search/searchEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),stmt:s,headingMode:["0","1","2"].includes(i.getAttribute("custom-heading-mode"))?parseInt(i.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,excludeIDs:[i.getAttribute("data-node-id"),e.block.rootID],breadcrumb:o},l=>{na(l.data.blocks,e,i,a)})})},na=(e,t,a,n,i)=>{const s=a.querySelector(".fn__rotate");s&&s.classList.remove("fn__rotate");let o="";e.forEach(c=>{let u="";c.blockPaths.length!==0&&(u=ki(c.blockPaths,!0)),o+=`<div class="protyle-wysiwyg__embed" data-id="${c.block.id}">${u}${c.block.content}</div>`}),e.length>0?(a.firstElementChild.insertAdjacentHTML("afterend",o),Ci(a.querySelector(".protyle-wysiwyg__embed"))):a.firstElementChild.insertAdjacentHTML("afterend",`<div class="protyle-wysiwyg__embed ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${i||window.siyuan.languages.refExpired}</div>`),ht(a),Tt(a),Ze(a,t),n&&(t.contentElement.scrollTop=n);let l=0,r=a;for(;l<4&&r;)r=F(r.parentElement,"data-type","NodeBlockQueryEmbed"),l++;l<4&&a.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(c=>{Xe(t,c)}),a.style.height=""},Vg=(e=!1)=>{};let yr,hr;const Gg=(e,t)=>{},_r=(e,t,a=!1)=>{},zg=()=>{yr="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(hr)},Kg=e=>{if(!e)return;let t=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${e.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${e.wordCount}<span class="fn__space"></span>`;0<e.linkCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${e.linkCount}<span class="fn__space"></span>`),0<e.imageCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${e.imageCount}<span class="fn__space"></span>`),0<e.refCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${e.refCount}<span class="fn__space"></span>`),0<e.blockCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.blockCount}</span>&nbsp;${e.blockCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=t};var Ai=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),wr=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())}),vr=(e,t,a)=>(t=e[Ai("asyncIterator")])?t.call(e):(e=e[Ai("iterator")](),t={},a=(n,i)=>(i=e[n])&&(t[n]=s=>new Promise((o,l,r)=>(s=i.call(e,s),r=s.done,Promise.resolve(s.value).then(c=>o({value:c,done:r}),l)))),a("next"),a("return"),t);const Si=(e,t)=>{const a=jt(e),n=[];if(a!==e&&(e.remove(),n.push({action:"delete",id:a.getAttribute("data-node-id")})),a.remove(),t.wysiwyg.element.childElementCount===0)if(t.block.rootID===t.block.id){const i=Lute.NewNodeID(),s=Nn(!1,!1,i);n.push({action:"insert",data:s.outerHTML,id:i,parentID:t.block.parentID}),t.wysiwyg.element.innerHTML=s.outerHTML}else Vs({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:t.block.id});n.length>0&&xt(t,n,[])},Li=()=>{if(window.siyuan.transactions.length===0)return;const e=window.siyuan.transactions[0].protyle,t=window.siyuan.transactions[0].doOperations,a=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),Ce("/api/transactions",{session:e.id,app:H.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:a}]},n=>{window.siyuan.transactions.length===0?_r([],e.block.rootID,!0):Li(),(window.siyuan.config.sync.provider!==0&&tl()||window.siyuan.config.sync.provider===0&&!el(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none");let i;if(getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0)),n.data[0].doOperations.forEach(s=>{if(s.action==="unfoldHeading"||s.action==="foldHeading"){Mi(s,e);return}if(s.action==="update"){e.options.backlinkData&&(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{Z(o)||i&&(o===i.startContainer||o.contains(i.startContainer))||(o.outerHTML=s.data.replace("<wbr>",""))}),ht(e.wysiwyg.element),Tt(e.wysiwyg.element),Ze(e.wysiwyg.element,e),Xe(e,e.wysiwyg.element)),Yn(e,s);return}if(s.action==="delete"||s.action==="append"){e.options.backlinkData&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{!Z(o)&&!o.contains(i.startContainer)&&o.remove()}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Xe(e,o))}),Nt(["gutter"],e);return}if(s.action==="move"){if(e.options.backlinkData){const o=[];Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(r=>{if(!Z(r)){const c=W(r,"data-node-id",null);c&&!c.contains(i.startContainer)&&o.push(r)}});let l=!1;s.previousID&&o.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(r=>{!Z(r)&&!r.nextElementSibling.contains(i.startContainer)&&(r.after(_e(o[0].cloneNode(!0))),l=!0)}):o.length>0&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(r=>{var c;!Z(r)&&!ct(r).contains(i.startContainer)&&((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(_e(o[0].cloneNode(!0))):r.prepend(_e(o[0].cloneNode(!0))),l=!0)}),o.forEach(r=>{l?r.remove():!l&&r.parentElement&&Si(r,e)})}e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"],[data-node-id="${s.parentID}"],[data-node-id="${s.previousID}"]`)&&(o.removeAttribute("data-render"),Xe(e,o))});return}if(s.action==="insert"){if(e.options.backlinkData){const o=[];s.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(l=>{var r;((r=l.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==s.id&&!l.contains(i.startContainer)&&!F(l,"data-node-id",s.id)&&!Z(l)&&(l.insertAdjacentHTML("afterend",s.data),o.push(l.nextElementSibling))}):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(l=>{!Z(l)&&!l.contains(i.startContainer)&&(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==s.id?(l.firstElementChild.insertAdjacentHTML("afterend",s.data),o.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==s.id&&(l.insertAdjacentHTML("afterbegin",s.data),o.push(l.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.forEach(l=>{ht(l),Tt(l),Ze(l,e),Xe(e,l);const r=l.querySelector("wbr");r&&r.remove()})}e.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(o=>{o.remove()})}}),e.wysiwyg.element.childElementCount===0&&!e.block.showAll){const s=Lute.NewNodeID(),o=Nn(!1,!0,s);e.wysiwyg.element.insertAdjacentElement("afterbegin",o),xt(e,[{action:"insert",data:o.outerHTML,id:s,parentID:e.block.parentID}]),Va(o,i)}})},Yn=(e,t)=>{let a=!1;const n=(s,o)=>{const l=document.createElement("template");l.innerHTML=e.lute.SpinBlockDOM(o),l.content.querySelectorAll('[contenteditable="true"]').forEach(c=>{c.setAttribute("contenteditable","false")}),l.content.querySelectorAll(".protyle-wysiwyg--select").forEach(c=>{c.classList.remove("protyle-wysiwyg--select")});const r=l.content.querySelector("wbr");r&&r.remove(),s.outerHTML=l.innerHTML,a=!0},i=document.createElement("template");i.innerHTML=t.data,e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(s=>{const o=s.querySelectorAll(`[data-node-id="${t.id}"]`);o.length>0?o.forEach(l=>{n(l,t.data)}):s.querySelectorAll(".protyle-wysiwyg__embed").forEach(l=>{const r=i.content.querySelector(`[data-node-id="${l.getAttribute("data-id")}"]`);r&&!Z(r)&&n(l.querySelector("[data-node-id]"),r.outerHTML)})}),a&&(ht(e.wysiwyg.element),Tt(e.wysiwyg.element),Ze(e.wysiwyg.element,e))},xi=(e,t,a,n)=>{n&&focusSideBlock(e[0]),e.forEach(i=>{if(n)i.remove();else{const s=getTopAloneElement(i);s&&s.remove()}}),a.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{i.querySelector(`[data-node-id="${t}"]`)&&(i.removeAttribute("data-render"),blockRender(a,i))})},Ti=(e,t,a,n)=>{e.forEach(s=>{s.getAttribute("data-subtype")==="echarts"?s.outerHTML=t.lute.SpinBlockDOM(a.data):s.outerHTML=a.data}),Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${a.id}"]`)).find(s=>{if(!isInEmbedBlock(s))return e[0]=s,!0});const i=e[0].querySelector("wbr");if(n){const s=getEditorRange(e[0]);i?focusByWbr(e[0],s):focusBlock(e[0])}else i&&i.remove();processRender(e.length===1?e[0]:t.wysiwyg.element),highlightRender(e.length===1?e[0]:t.wysiwyg.element),avRender(e.length===1?e[0]:t.wysiwyg.element,t),blockRender(t,e.length===1?e[0]:t.wysiwyg.element),Yn(t,a)},Zg=(e,t,a)=>{var n,i,s,o;const l=[];if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(r=>{isInEmbedBlock(r)||l.push(r)}),t.action==="setAttrs"){e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(r=>{JSON.parse(t.data).fold==="1"?r.setAttribute("fold","1"):r.removeAttribute("fold")});return}if(t.action==="unfoldHeading"){const r=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(c=>{if(c.removeAttribute("fold"),a)return;const u=isInEmbedBlock(c);if(u){u.removeAttribute("data-render"),blockRender(e,u);return}t.retData&&(Ii(t.retData,e),c.insertAdjacentHTML("afterend",t.retData)),t.data==="remove"&&c.remove()}),t.retData&&(e.disabled&&disabledProtyle(e),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),e.contentElement.scrollTop=r,e.scroll.lastScrollTop=r);return}if(t.action==="foldHeading"){if(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(r=>{r.setAttribute("fold","1"),t.retData||removeFoldHeading(r)}),a)return;t.retData&&(t.retData.forEach(r=>{let c;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`)).find(u=>{if(c=isInEmbedBlock(u),c)return!0;u.remove()}),c&&(c.removeAttribute("data-render"),blockRender(e,c))}),e.wysiwyg.element.childElementCount===0&&zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id}));return}if(t.action==="delete"){l.length>0||!a?xi(l,t.id,e,a):a&&zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(r=>{isInEmbedBlock(r)||l.push(r)}),xi(l,t.id,e,a)}});return}if(t.action==="update"){if(l.length===0){const r=e.wysiwyg.element.querySelector("[data-node-id]");if(r){const c=r.getAttribute("data-node-id"),u=document.createElement("template");u.innerHTML=t.data;const g=u.content.querySelector(`[data-node-id="${c}"]`);if(g){l.push(r),t.data=g.outerHTML,t.id=c;for(let m=1;m<e.wysiwyg.element.childElementCount;m++)e.wysiwyg.element.childNodes[m].remove(),m--}}}l.length>0?Ti(l,e,t,a):a?zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(r=>{isInEmbedBlock(r)||l.push(r)}),Ti(l,e,t,a)}}):Yn(e,t);return}if(t.action==="updateAttrs"){const r=t.data,c={};let u="",g="",m="",d="",f="";Object.keys(r.new).forEach(p=>{c[p]=r.new[p];const y=Lute.EscapeHTMLStr(r.new[p]);p==="bookmark"?u=`<div class="protyle-attr--bookmark">${y}</div>`:p==="name"?g=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${y}</div>`:p==="alias"?m=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${y}</div>`:p==="memo"?d=`<div class="protyle-attr--memo ariaLabel" aria-label="${y}" data-position="north"><svg><use xlink:href="#iconM"></use></svg></div>`:p==="custom-avs"&&r.new["av-names"]&&(f=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${r.new["av-names"]}</div>`)});let b=u+g+m+d+f;if(e.block.rootID===t.id){if(e.title){r.new["custom-avs"]&&!r.new["av-names"]&&(b+=((n=e.title.element.querySelector(".protyle-attr--av"))==null?void 0:n.outerHTML)||"");const p=e.title.element.querySelector(".protyle-attr--refcount");p&&(b+=p.outerHTML),r.new[Constants.CUSTOM_RIFF_DECKS]&&r.new[Constants.CUSTOM_RIFF_DECKS]!==r.old[Constants.CUSTOM_RIFF_DECKS]?(e.title.element.style.animation="addCard 450ms linear",e.title.element.setAttribute(Constants.CUSTOM_RIFF_DECKS,r.new[Constants.CUSTOM_RIFF_DECKS]),setTimeout(()=>{e.title.element.style.animation=""},450)):r.new[Constants.CUSTOM_RIFF_DECKS]||e.title.element.removeAttribute(Constants.CUSTOM_RIFF_DECKS),e.title.element.querySelector(".protyle-attr").innerHTML=b}if(e.wysiwyg.renderCustom(c),r.new[Constants.CUSTOM_SY_FULLWIDTH]!==r.old[Constants.CUSTOM_SY_FULLWIDTH]&&resize(e),r.new[Constants.CUSTOM_SY_READONLY]!==r.old[Constants.CUSTOM_SY_READONLY]){let p=r.new[Constants.CUSTOM_SY_READONLY];p||(p=window.siyuan.config.editor.readOnly?"true":"false"),p==="true"?disabledProtyle(e):enableProtyle(e)}(r.new.icon!==r.old.icon||r.new["title-img"]!==r.old["title-img"]||r.new.tags!==r.old.tags&&e.background)&&(e=window.siyuan.mobile.editor.protyle,e.background.ial.icon=r.new.icon,e.background.ial.tags=r.new.tags,e.background.ial["title-img"]=r.new["title-img"],e.background.render(e.background.ial,e.block.rootID),(i=e.model)==null||i.parent.setDocIcon(r.new.icon));return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(p=>{var y;if(p.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(r.old).forEach(T=>{p.removeAttribute(T)}),r.new.style&&r.new[Constants.CUSTOM_RIFF_DECKS]&&r.new[Constants.CUSTOM_RIFF_DECKS]!==r.old[Constants.CUSTOM_RIFF_DECKS]&&(r.new.style+=";animation:addCard 450ms linear"),Object.keys(r.new).forEach(T=>{T!=="id"&&(p.setAttribute(T,r.new[T]),T===Constants.CUSTOM_RIFF_DECKS&&r.new[Constants.CUSTOM_RIFF_DECKS]!==r.old[Constants.CUSTOM_RIFF_DECKS]&&(p.style.animation="addCard 450ms linear",setTimeout(()=>{p.parentElement?p.style.animation="":e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(w=>{w.style.animation=""})},450)))}),r["data-av-type"]&&p.setAttribute("data-av-type",r["data-av-type"]);const _=p.querySelectorAll(".protyle-attr"),k=_[_.length-1];r.new["custom-avs"]&&!r.new["av-names"]&&(b+=((y=k.querySelector(".protyle-attr--av"))==null?void 0:y.outerHTML)||"");const x=k.querySelector(".protyle-attr--refcount");x&&(b+=x.outerHTML),k.innerHTML=b+Constants.ZWSP});return}if(t.action==="move"){if(((s=t.context)==null?void 0:s.ignoreProcess)==="true")return;let r;if(a&&getSelection().rangeCount>0){r=getSelection().getRangeAt(0);const u=hasClosestBlock(r.startContainer);u&&(getContenteditableElement(u)?r.insertNode(document.createElement("wbr")):getContenteditableElement(l[0]).insertAdjacentHTML("afterbegin","<wbr>"))}let c=!1;if(t.previousID&&l.length>0){const u=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`);if(u.length===0&&e.options.backlinkData&&a&&getSelection().rangeCount>0){const g=hasTopClosestByAttribute(r.startContainer,"data-node-id",null);g&&(g.before(processClonePHElement(l[0].cloneNode(!0))),c=!0)}else u.forEach(g=>{isInEmbedBlock(g)||(g.after(processClonePHElement(l[0].cloneNode(!0))),c=!0)})}else if(l.length>0){const u=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`);if(!e.options.backlinkData&&t.parentID===e.block.parentID&&!e.block.showAll)e.wysiwyg.element.prepend(processClonePHElement(l[0].cloneNode(!0))),c=!0;else if(u.length===0&&e.options.backlinkData&&a&&getSelection().rangeCount>0){const g=hasTopClosestByAttribute(getSelection().getRangeAt(0).startContainer,"data-node-id",null);g&&(g.before(processClonePHElement(l[0].cloneNode(!0))),c=!0)}else u.forEach(g=>{var m;isInEmbedBlock(g)||((m=g.firstElementChild)!=null&&m.classList.contains("protyle-action")?g.firstElementChild.after(processClonePHElement(l[0].cloneNode(!0))):g.prepend(processClonePHElement(l[0].cloneNode(!0))),c=!0)})}l.forEach(u=>{c?u.remove():!c&&u.parentElement&&Si(u,e)}),a&&r&&(t.data==="focus"?(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(u=>{if(!isInEmbedBlock(u))return focusBlock(u),!0}),document.querySelectorAll("wbr").forEach(u=>{u.remove()})):focusByWbr(e.wysiwyg.element,r)),a||e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(u=>{u.querySelector(`[data-node-id="${t.id}"],[data-node-id="${t.parentID}"],[data-node-id="${t.previousID}"]`)&&(u.removeAttribute("data-render"),blockRender(e,u))});return}if(t.action==="insert"){if(((o=t.context)==null?void 0:o.ignoreProcess)==="true")return;const r=[];if(t.previousID){const c=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`);if(c.length===0&&a&&e.wysiwyg.element.childElementCount===0)e.wysiwyg.element.innerHTML=t.data;else if(c.length===0&&e.options.backlinkData&&a&&getSelection().rangeCount>0){const u=hasClosestBlock(getSelection().getRangeAt(0).startContainer);u&&(u.insertAdjacentHTML("beforebegin",t.data),r.push(u.previousElementSibling))}else c.forEach(u=>{const g=isInEmbedBlock(u);g?(g.removeAttribute("data-render"),blockRender(e,g)):(u.insertAdjacentHTML("afterend",t.data),r.push(u.nextElementSibling))})}else if(t.nextID)Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.nextID}"]`)).forEach(c=>{const u=isInEmbedBlock(c);u?(u.removeAttribute("data-render"),blockRender(e,u)):(c.insertAdjacentHTML("beforebegin",t.data),r.push(c.previousElementSibling))});else{const c=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`);if(!e.options.backlinkData&&t.parentID===e.block.parentID&&!e.block.showAll)e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.data),r.push(e.wysiwyg.element.firstElementChild);else if(c.length===0&&e.options.backlinkData&&a&&getSelection().rangeCount>0){const u=hasClosestBlock(getSelection().getRangeAt(0).startContainer);u&&(u.insertAdjacentHTML("beforebegin",t.data),r.push(u.previousElementSibling))}else c.forEach(u=>{var g;isInEmbedBlock(u)||((g=u.firstElementChild)!=null&&g.classList.contains("protyle-action")?(u.firstElementChild.insertAdjacentHTML("afterend",t.data),r.push(u.firstElementChild.nextElementSibling)):(u.insertAdjacentHTML("afterbegin",t.data),r.push(u.firstElementChild)))})}if(e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(c=>{c.lastElementChild.getAttribute("spin")==="1"&&c.lastElementChild.remove()}),r.length===0)return;r.forEach(c=>{processRender(c),highlightRender(c),avRender(c,e),blockRender(e,c);const u=c.querySelector("wbr");if(a){const g=getEditorRange(c);u?focusByWbr(c,g):focusBlock(c)}else u&&u.remove()}),e.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(c=>{c.remove()});return}if(t.action==="append"){e.options.backlinkData||reloadProtyle(e,!1);return}if(["addAttrViewCol","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup","sortAttrViewKey","setAttrViewColDesc","duplicateAttrViewKey","setAttrViewViewDesc","setAttrViewCoverFrom","setAttrViewCoverFromAssetKeyID","setAttrViewBlockView","setAttrViewCardSize","setAttrViewCardAspectRatio","hideAttrViewName","setAttrViewShowIcon","setAttrViewWrapField","setAttrViewGroup","removeAttrViewGroup","hideAttrViewGroup","sortAttrViewGroup","foldAttrViewGroup","hideAttrViewAllGroups","setAttrViewFitImage","setAttrViewDisplayFieldName","insertAttrViewBlock","setAttrViewColDateFillSpecificTime"].includes(t.action)){a?t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.id}"]`)).forEach(r=>{const c=r.querySelector(".av__title");c&&(c.textContent=t.data,c.dataset.title=t.data)}):refreshAV(e,t);return}if(t.action==="doUpdateUpdated"){l.forEach(r=>{r.setAttribute("updated",t.data)});return}},Xg=e=>{let t;const a=Lute.NewNodeID();if(e.type==="BlocksMergeSuperBlock")t=genSBElement(e.level,a);else if(e.type==="Blocks2Blockquote")t=document.createElement("div"),t.classList.add("bq"),t.setAttribute("data-node-id",a),t.setAttribute("data-type","NodeBlockquote"),t.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(e.type.endsWith("Ls")){t=document.createElement("div"),t.classList.add("list"),t.setAttribute("data-node-id",a),t.setAttribute("data-type","NodeList"),e.type==="Blocks2ULs"?t.setAttribute("data-subtype","u"):e.type==="Blocks2OLs"?t.setAttribute("data-subtype","o"):t.setAttribute("data-subtype","t");let r="";e.selectsElement.forEach((c,u)=>{e.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:e.type==="Blocks2OLs"?r+=`<div data-marker="${u+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${u+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),t.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const n=e.selectsElement[0].getAttribute("data-node-id"),i=e.selectsElement[0].parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,s=[{action:"insert",id:a,data:t.outerHTML,nextID:n,parentID:i}],o=[];e.selectsElement[0].previousElementSibling?e.selectsElement[0].before(t):e.selectsElement[0].parentElement.prepend(t);let l;e.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const u=r.getAttribute("data-node-id");o.push({action:"move",id:u,previousID:l||a,parentID:i}),e.type.endsWith("Ls")?(s.push({action:"move",id:u,parentID:t.children[c].getAttribute("data-node-id")}),t.children[c].firstElementChild.after(r)):(s.push({action:"move",id:u,previousID:l,parentID:a}),t.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),c===e.selectsElement.length-1&&o.push({action:"delete",id:a}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(e.protyle,r))}),xt(e.protyle,s,o),focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.selectsElement[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},Ii=(e,t)=>{const a=document.createElement("template");a.innerHTML=e,Array.from(a.content.children).forEach(n=>{var i;(i=t.wysiwyg.element.querySelector(`:scope > [data-node-id="${n.getAttribute("data-node-id")}"]`))==null||i.remove()})},Jg=e=>{var t;(t=e.protyle.observerLoad)==null||t.disconnect();let a=e.selectsElement,n;if(e.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),a=Array.from(e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),a.length===0&&(a=[e.nodeElement]);let r=!1,c=!1;if(a.find((u,g)=>{if(u.classList.contains("li"))return c=!0,!0;if(u.nextElementSibling&&a[g+1]&&u.nextElementSibling===a[g+1])r=!0;else if(g!==a.length-1)return r=!1,!0}),c)return;a.length===1&&e.type==="Blocks2Hs"&&a[0].getAttribute("data-type")==="NodeHeading"&&e.level===parseInt(a[0].getAttribute("data-subtype").substr(1))&&(e.type="Blocks2Ps"),e.isContinue=r}let i="";const s=[],o=[];let l;a.forEach((r,c)=>{var u,g,m,d,f,b,p,y;r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end"),i+=r.outerHTML;const _=r.getAttribute("data-node-id"),k=document.createElement("template");if(e.isContinue)if(o.push({action:"insert",id:_,previousID:((b=s[s.length-1])==null?void 0:b.id)||((p=r.previousElementSibling)==null?void 0:p.getAttribute("data-node-id")),data:r.outerHTML,parentID:((y=r.parentElement)==null?void 0:y.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),s.push({action:"delete",id:_}),c===a.length-1){const x=e.protyle.lute[e.type](i,e.level);k.innerHTML=x,Array.from(k.content.children).forEach(T=>{var w,v,h;const E=T.getAttribute("data-node-id");s.push({action:"insert",id:E,previousID:((w=T.previousElementSibling)==null?void 0:w.getAttribute("data-node-id"))||((v=r.previousElementSibling)==null?void 0:v.getAttribute("data-node-id")),data:T.outerHTML,parentID:((h=r.parentElement)==null?void 0:h.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),o.splice(0,0,{action:"delete",id:E})}),r.outerHTML=x}else r.remove();else{let x=e.protyle.lute[e.type](r.outerHTML,e.level);if(k.innerHTML=x,!k.content.querySelector(`[data-node-id="${_}"]`))o.push({action:"insert",id:_,previousID:l||((u=r.previousElementSibling)==null?void 0:u.getAttribute("data-node-id")),data:r.outerHTML,parentID:((g=r.parentElement)==null?void 0:g.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),Array.from(k.content.children).forEach(T=>{var w,v,h;const E=T.getAttribute("data-node-id");s.push({action:"insert",id:E,previousID:((w=T.previousElementSibling)==null?void 0:w.getAttribute("data-node-id"))||((v=r.previousElementSibling)==null?void 0:v.getAttribute("data-node-id")),data:T.outerHTML,parentID:((h=r.parentElement)==null?void 0:h.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),o.splice(0,0,{action:"delete",id:E})}),s.push({action:"delete",id:_}),r===((m=a[c+1])==null?void 0:m.previousElementSibling)?l=_:l=void 0;else{let T;r.getAttribute("data-type")==="NodeHeading"&&r.getAttribute("fold")==="1"&&k.content.firstElementChild.getAttribute("data-subtype")!==r.dataset.subtype&&(T=setFold(e.protyle,r,void 0,void 0,!1,!0),x=x.replace(' fold="1"',"")),T&&((d=T.doOperations)==null?void 0:d.length)>0&&s.push(...T.doOperations),o.push({action:"update",id:_,data:r.outerHTML}),s.push({action:"update",id:_,data:x}),T&&((f=T.undoOperations)==null?void 0:f.length)>0&&o.push(...T.undoOperations)}r.outerHTML=x}}),xt(e.protyle,s,o),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element,e.protyle),blockRender(e.protyle,e.protyle.wysiwyg.element),n||e.range?focusByWbr(e.protyle.wysiwyg.element,n||e.range):focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${a[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},Qg=e=>wr(void 0,null,function*(){var t,a;if(e.nodeElement.querySelector("wbr")||(t=getContenteditableElement(e.nodeElement))==null||t.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var n=vr(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),i,s,o;i=!(s=yield n.next()).done;i=!1){const g=s.value,m=g.getAttribute("data-node-id");g.removeAttribute("fold");const d=yield fetchSyncPost("/api/transactions",{session:e.protyle.id,app:Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:m}],undoOperations:[{action:"foldHeading",id:m}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:m}],[{action:"foldHeading",id:m}],e.protyle),g.insertAdjacentHTML("afterend",d.data[0].doOperations[0].retData)}}catch(g){o=[g]}finally{try{i&&(s=n.return)&&(yield s.call(n))}finally{if(o)throw o[0]}}const l=e.nodeElement.outerHTML;let r=(a=e.nodeElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id");!e.nodeElement.previousElementSibling&&e.protyle.block.showAll&&(r=(yield fetchSyncPost("/api/block/getBlockRelevantIDs",{id:e.id})).data.previousID);const c=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,u=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=u,e.type==="CancelList"||e.type==="CancelBlockquote"){const g=document.createElement("template");g.innerHTML=u;const m=[{action:"delete",id:e.id}],d=[];let f=r;Array.from(g.content.children).forEach(b=>{const p=b.getAttribute("data-node-id");m.push({action:"insert",data:b.outerHTML,id:p,previousID:f,parentID:c}),d.push({action:"delete",id:p}),f=p}),d.push({action:"insert",data:l,id:e.id,previousID:r,parentID:c}),xt(e.protyle,m,d)}else sa(e.protyle,e.id,u,l);focusByWbr(e.protyle.wysiwyg.element,getEditorRange(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(g=>{g.textContent===""&&fetchPost("/api/block/getRefText",{id:g.getAttribute("data-id")},m=>{g.innerHTML=m.data})}),blockRender(e.protyle,e.protyle.wysiwyg.element),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element,e.protyle)});let Di;const xt=(e,t,a)=>{if(t.length===0)return;if(!e){Ce("/api/transactions",{session:H.SIYUAN_APPID,app:H.SIYUAN_APPID,transactions:[{doOperations:t}]});return}const n=window.siyuan.transactions[window.siyuan.transactions.length-1];let i=!1;const s=new Date().getTime();if(n&&n.doOperations.length===1&&n.doOperations[0].action==="update"&&t.length===1&&t[0].action==="update"&&n.doOperations[0].id===t[0].id&&e.transactionTime-s<H.TIMEOUT_INPUT&&(i=!0),a&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.model&&e.model.headElement.classList.remove("item--unupdate"),e.updated=!0,i?e.undo.replace(t,e):e.undo.add(t,a,e)),t.length===1&&(t[0].action==="unfoldHeading"||t[0].action==="setAttrViewBlockView"||t[0].action==="setAttrs"&&t[0].data.startsWith('{"fold":'))||t.length===2&&t[0].action==="insertAttrViewBlock"){e.transactionTime=s+H.TIMEOUT_INPUT*2,Ce("/api/transactions",{session:e.id,app:H.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:a}]},o=>{o.data[0].doOperations.forEach(l=>{if(l.action==="unfoldHeading"||l.action==="foldHeading")Mi(l,e);else if(l.action==="setAttrs"){const r=e.gutter.element.querySelector('[data-type="fold"]');r&&r.removeAttribute("disabled"),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(c=>{c.querySelector(`[data-node-id="${l.id}"]`)&&(c.removeAttribute("data-render"),Xe(e,c))})}})});return}window.clearTimeout(Di),i?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=e,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=t):window.siyuan.transactions.push({protyle:e,doOperations:t,undoOperations:a}),e.transactionTime=s,Di=window.setTimeout(()=>{Li()},H.TIMEOUT_INPUT*2),t.find(o=>{var l;if(o.action==="insert")return(l=e.observerLoad)==null||l.disconnect(),!0})},Mi=(e,t)=>{var a;if(e.action==="unfoldHeading"||e.action==="foldHeading"){const n=t.gutter.element.querySelector('[data-type="fold"]');if(n&&n.removeAttribute("disabled"),e.action==="unfoldHeading"){const i=t.contentElement.scrollTop;if(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{const o=Z(s);if(o){o.removeAttribute("data-render"),Xe(t,o);return}if(s.lastElementChild.classList.contains("protyle-attr")||s.lastElementChild.remove(),Ii(e.retData,t),s.insertAdjacentHTML("afterend",e.retData),e.data==="remove"){const l=getSelection();l.rangeCount>0&&s.contains(l.getRangeAt(0).startContainer)&&Ae(s.nextElementSibling,void 0,!0),s.remove()}}),t.disabled&&Fn(t),ht(t.wysiwyg.element),Tt(t.wysiwyg.element),Ze(t.wysiwyg.element,t),Xe(t,t.wysiwyg.element),(a=e.context)!=null&&a.focusId){const s=t.wysiwyg.element.querySelector(`[data-node-id="${e.context.focusId}"]`);Ae(s),Gt(t,s,!1)}else t.contentElement.scrollTop=i,t.scroll.lastScrollTop=i;return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{const s=Z(i);s&&(s.removeAttribute("data-render"),Xe(t,s))}),t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&Ce("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{Ut({data:i,protyle:t,action:[H.CB_GET_APPEND,H.CB_GET_UNCHANGEID]})});return}},sa=(e,t,a,n)=>{a!==n&&xt(e,[{id:t,data:a,action:"update"}],[{id:t,data:n,action:"update"}])},Er=(e,t,a)=>{const n=[],i=[];e.forEach(s=>{const o=s.getAttribute("data-node-id");s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"),i.push({action:"update",id:o,data:s.outerHTML}),a(s),n.push({action:"update",id:o,data:s.outerHTML})}),xt(t,n,i)},em=(e,t)=>isCustomAttr(e)?e.getAttribute("data-row-id"):hasClosestByClassName(e,t==="table"?"av__row":"av__gallery-item").dataset.id,tm=(e,t)=>{const a=hasClosestByClassName(e,"av__row");if(!a)return;const n=e.querySelector("use");a.classList.contains("av__row--header")||t==="unselectAll"?n.getAttribute("xlink:href")==="#iconCheck"||t==="unselectAll"?a.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconUncheck");const s=hasClosestByClassName(i,"av__row");s&&s.classList.remove("av__row--select")}):a.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconCheck");const s=hasClosestByClassName(i,"av__row");s&&s.classList.add("av__row--select")}):t==="select"||n.getAttribute("xlink:href")==="#iconUncheck"&&t==="toggle"?(a.classList.add("av__row--select"),n.setAttribute("xlink:href","#iconCheck")):(t==="unselect"||n.getAttribute("xlink:href")==="#iconCheck"&&t==="toggle")&&(a.classList.remove("av__row--select"),n.setAttribute("xlink:href","#iconUncheck")),focusBlock(hasClosestBlock(a)),Wn(a)},Wn=e=>{const t=G(e);if(!t)return;const a=e.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,n=e.parentElement.querySelectorAll(".av__row:not(.av__row--header)").length,i=e.parentElement.firstElementChild,s=i.querySelector("use");n===a&&n!==0?(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck")):a===0?(i.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck")):a>0&&(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconIndeterminateCheck"));const o=t.querySelector(".av__counter"),l=t.querySelectorAll(".av__row--select:not(.av__row--header)").length;if(l===0){o.classList.add("fn__none");return}o.classList.remove("fn__none"),o.innerHTML=`${l} ${window.siyuan.languages.selected}`},kr=e=>{const t=e.getAttribute("data-av-type");e.querySelectorAll(".av__body").forEach(a=>{const n=a.dataset.pageSize;if(n){const i=a.querySelectorAll(t==="table"?".av__row:not(.av__row--header)":".av__gallery-item").length;parseInt(n)<i&&(a.dataset.pageSize=i.toString())}})},Cr=e=>{var t;e.blockElement.querySelector('[data-type="av-search"]').value="";const a=e.groupID?`.av__body[data-group-id="${e.groupID}"] `:"";let n=e.blockElement.querySelector(a+`.av__row[data-id="${e.previousId}"]`)||e.blockElement.querySelector(a+".av__row--header");e.blockElement.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(n=e.blockElement.querySelector(a+".av__row--util").previousElementSibling);const s=e.blockElement.querySelector(`.av__body[data-group-id="${e.groupID}"] `);if(s&&["updated","created"].includes(s.getAttribute("data-dtype"))&&s.getAttribute("data-content")!=="_@today@_"&&(n=(t=e.blockElement.querySelector('.av__body[data-content="_@today@_"] .av__row--util'))==null?void 0:t.previousElementSibling),!n)return;let o='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>';const l=n.querySelectorAll(".av__colsticky .av__cell").length-1;l>-1&&(o='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),n.querySelectorAll(".av__cell").forEach((c,u)=>{var g;let m=1;const d=getTypeByCellElement(c);if(d==="lineNumber"){const f=(g=c.querySelector(".av__celltext"))==null?void 0:g.getAttribute("data-value");f&&(m=parseInt(f))}o+=`<div class="av__cell${d==="checkbox"?" av__cell-uncheck":""}" data-col-id="${c.dataset.colId}" 
data-wrap="${c.dataset.wrap}" 
data-dtype="${c.dataset.dtype}" 
style="width: ${c.style.width};${c.dataset.dtype==="number"?"text-align: right;":""}" 
${d==="block"?' data-detached="true"':""}>${renderCell(genCellValue(d,null),m)}</div>`,l===u&&(o+="</div>")});let r="";clearSelect(["cell","row"],e.blockElement),e.srcIDs.forEach(()=>{r+=`<div class="av__row" data-type="ghost">
    ${o}
</div>`}),n.insertAdjacentHTML("afterend",r),fetchPost("/api/av/getAttributeViewAddingBlockDefaultValues",{avID:e.blockElement.getAttribute("data-av-id"),viewID:e.blockElement.getAttribute(Constants.CUSTOM_SY_AV_VIEW),groupID:e.groupID,previousID:e.previousId},c=>{if(c.data.values){let u;const g=Object.keys(c.data.values);e.blockElement.querySelectorAll('[data-type="ghost"]').forEach(m=>{m.querySelectorAll(".av__cell").forEach(d=>{if(!u&&d.getAttribute("data-detached")==="true"&&(u=d),g.includes(d.dataset.colId)){const f=c.data.values[d.dataset.colId];d.innerHTML=renderCell(f),renderCellAttr(d,f)}})})}kr(e.blockElement)})},qa=(e,t,a)=>{if(e.dataset.avType!=="table")return;const n=e.querySelectorAll(".av__row--header");n.length>0&&(a==="top"||a==="all")&&n.forEach(s=>{const o=s.parentElement.getBoundingClientRect(),l=Math.floor(t.top-o.top);l>0&&l<o.height-s.clientHeight?s.style.transform=`translateY(${l}px)`:s.style.transform=""});const i=e.querySelectorAll(".av__row--footer");i.length>0&&(a==="bottom"||a==="all")&&i.forEach(s=>{if(s.querySelector(".av__calc--ashow")){const o=s.parentElement.getBoundingClientRect(),l=Math.ceil(t.bottom-o.bottom);l<0&&-l<o.height-s.clientHeight?s.style.transform=`translateY(${l}px)`:s.style.transform=""}else s.style.transform=""})},ia=e=>{var t;if(e.currentPageSize===e.newPageSize)return;e.nodeElement.querySelectorAll(".av__body").forEach(n=>{n.dataset.pageSize=e.newPageSize});const a=e.nodeElement.getAttribute("data-node-id");transaction(e.protyle,[{action:"setAttrViewPageSize",avID:e.avID,data:parseInt(e.newPageSize),blockID:a}],[{action:"setAttrViewPageSize",data:parseInt(e.currentPageSize),avID:e.avID,blockID:a}]),(t=document.querySelector(".av__panel"))==null||t.remove()},am=e=>{const t=new Menu(Constants.MENU_AV_PAGE_SIZE);if(t.isOpen)return;const a=e.target.dataset.size;t.addItem({iconHTML:"",label:"10",checked:a==="10",click(){ia({currentPageSize:a,newPageSize:"10",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a==="25",label:"25",click(){ia({currentPageSize:a,newPageSize:"25",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a==="50",label:"50",click(){ia({currentPageSize:a,newPageSize:"50",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a==="100",label:"100",click(){ia({currentPageSize:a,newPageSize:"100",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:a===Constants.SIZE_DATABASE_MAZ_SIZE.toString(),label:window.siyuan.languages.all,click(){ia({currentPageSize:a,newPageSize:Constants.SIZE_DATABASE_MAZ_SIZE.toString(),protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}});const n=e.target.getBoundingClientRect();t.open({x:n.left,y:n.bottom})},nm=(e,t)=>{const a=e.querySelectorAll(".av__row--select:not(.av__row--header), .av__gallery-item--select");if(a.length===0)return;const n=e.getAttribute("data-av-id"),i=[],s=[];a.forEach(l=>{s.push(l.getAttribute("data-id"))}),a.forEach(l=>{var r;const c=genCellValueByElement("block",l.querySelector('.av__cell[data-dtype="block"]'));i.push({action:"insertAttrViewBlock",avID:n,previousID:((r=l.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"",srcs:[{itemID:Lute.NewNodeID(),id:l.getAttribute("data-id"),isDetached:c.isDetached,content:c.block.content}],blockID:e.dataset.nodeId,groupID:l.parentElement.getAttribute("data-group-id")})});const o=dayjs().format("YYYYMMDDHHmmss");i.push({action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}),transaction(t,[{action:"removeAttrViewBlock",srcIDs:s,avID:n},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:o}],i),a.forEach(l=>{l.remove()}),qa(e,t.contentElement.getBoundingClientRect(),"all"),Wn(e.querySelector(".av__row")),e.setAttribute("updated",o)},sm=e=>{const t=e.blockElement.getAttribute("data-av-id"),a=[],n=[];new Array(e.count).fill(0).forEach(()=>{const s=Lute.NewNodeID();a.push(s),n.push({itemID:Lute.NewNodeID(),id:s,isDetached:!0,content:""})});const i=dayjs().format("YYYYMMDDHHmmss");transaction(e.protyle,[{action:"insertAttrViewBlock",avID:t,previousID:e.previousID,srcs:n,blockID:e.blockElement.dataset.nodeId,groupID:e.groupID},{action:"doUpdateUpdated",id:e.blockElement.dataset.nodeId,data:i}],[{action:"removeAttrViewBlock",srcIDs:a,avID:t},{action:"doUpdateUpdated",id:e.blockElement.dataset.nodeId,data:e.blockElement.getAttribute("updated")}]),e.blockElement.getAttribute("data-av-type")==="gallery"?insertGalleryItemAnimation({blockElement:e.blockElement,protyle:e.protyle,srcIDs:a,previousId:e.previousID,groupID:e.groupID}):Cr({protyle:e.protyle,blockElement:e.blockElement,srcIDs:a,previousId:e.previousID,groupID:e.groupID}),e.blockElement.setAttribute("updated",i)},im=()=>{},lm=()=>{},om=e=>{hideElements(["gutterOnly"],e);const t=setPadding(e),a=4;setTimeout(()=>{if(e.scroll&&e.scroll.element.parentElement.getAttribute("style")&&e.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(e.contentElement.clientHeight-49,200)}px`),!e.disabled){const i=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(s=>{s.querySelector(".av__scroll")&&stickyRow(s,i,"all")})}(t.width>a||isNaN(t.width))&&typeof window.echarts!="undefined"&&e.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(i=>{const s=window.echarts.getInstanceById(i.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));s&&s.resize()}),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(i=>{i.nextElementSibling.style.wordBreak==="break-word"&&lineNumberRender(i.parentElement)});const n=e.wysiwyg.element.querySelector("[data-resize-top]");n&&(n.scrollIntoView(),e.contentElement.scrollTop+=parseInt(n.getAttribute("data-resize-top")),n.removeAttribute("data-resize-top"))},Constants.TIMEOUT_TRANSITION+100)},rm=(e,t)=>{var a,n,i,s;if(t==="preview"){if(!e.preview.element.classList.contains("fn__none"))return;e.preview.element.classList.remove("fn__none"),e.contentElement.classList.add("fn__none"),(a=e.scroll)==null||a.element.classList.add("fn__none"),e.options.render.breadcrumb&&((n=e.breadcrumb)==null||n.element.classList.add("fn__none"),e.breadcrumb.toggleExit(!0)),e.preview.render(e)}else if(t==="wysiwyg"){if(!e.contentElement.classList.contains("fn__none"))return;e.preview.element.classList.add("fn__none"),e.contentElement.classList.remove("fn__none"),e.options.render.scroll&&((i=e.scroll)==null||i.element.classList.remove("fn__none")),e.options.render.breadcrumb&&((s=e.breadcrumb)==null||s.element.classList.remove("fn__none"),e.breadcrumb.toggleExit(!e.block.showAll)),resize(e)}hideElements(["gutterOnly","toolbar","select","hint","util"],e),e.app.plugins.forEach(o=>{o.eventBus.emit("switch-protyle-mode",{protyle:e})})};let $i;const cm=(e,t)=>{t.addEventListener("scroll",()=>{const a=t.getBoundingClientRect();if(!e.toolbar.element.classList.contains("fn__none")){const n=e.toolbar.element.getAttribute("data-inity").split(Constants.ZWSP),i=parseInt(n[0])+(parseInt(n[1])-t.scrollTop);i<a.top-e.toolbar.toolbarHeight||i>a.bottom-e.toolbar.toolbarHeight?e.toolbar.element.style.display="none":(e.toolbar.element.style.top=i+"px",e.toolbar.element.style.display="")}if(e.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.dataset.render==="true"&&stickyRow(n,a,"all")}),!e.element.classList.contains("block__edit")&&!isMobile()&&e.contentElement.setAttribute("data-scrolltop",t.scrollTop.toString()),window.siyuan.dragElement||hideElements(["gutterOnly"],e),e.scroll&&!e.scroll.element.classList.contains("fn__none")&&(clearTimeout($i),$i=window.setTimeout(()=>{let n=document.elementFromPoint(a.left+a.width/2,a.top+10);n.classList.contains("protyle-wysiwyg")&&(n=document.elementFromPoint(a.left+a.width/2,a.top+20));const i=hasClosestBlock(n);if(!i){if((e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(hasClosestByClassName(n,"protyle-background")||hasClosestByClassName(n,"protyle-title"))){const s=e.scroll.element.querySelector(".b3-slider");s.value="1",e.scroll.element.setAttribute("aria-label",`Blocks 1/${e.block.blockCount}`)}return}e.scroll.updateIndex(e,i.getAttribute("data-node-id"))},Constants.TIMEOUT_LOAD)),!(e.wysiwyg.element.getAttribute("data-top")||e.block.showAll||e.scroll&&e.scroll.element.classList.contains("fn__none")||!e.scroll||e.scroll.lastScrollTop===t.scrollTop||e.scroll.lastScrollTop===-1||!e.wysiwyg.element.firstElementChild)){if(e.scroll.lastScrollTop>t.scrollTop){if(t.scrollTop===0)return;t.scrollTop<t.clientHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(e.contentElement.style.width=e.contentElement.offsetWidth+"px",e.contentElement.style.overflow="hidden",e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{e.contentElement.style.overflow="",e.contentElement.style.width="",onGet({data:n,protyle:e,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})}))}else if(t.scrollTop>t.scrollHeight-t.clientHeight*1.8&&e.wysiwyg.element.lastElementChild&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"){if(e.scroll.lastScrollTop>768&&t.scrollTop>e.scroll.lastScrollTop*2){t.scrollTop=e.scroll.lastScrollTop;return}e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{onGet({data:n,protyle:e,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})})}e.scroll.lastScrollTop=Math.max(t.scrollTop,0)}},{capture:!1,passive:!0,once:!1})},dm=e=>{e.contentElement=document.createElement("div"),e.contentElement.className="protyle-content",(e.options.render.background||e.options.render.title)&&(e.contentElement.innerHTML='<div class="protyle-top"></div>',e.options.render.background&&e.contentElement.firstElementChild.appendChild(e.background.element),e.options.render.title&&e.contentElement.firstElementChild.appendChild(e.title.element)),e.contentElement.appendChild(e.wysiwyg.element),e.options.action.includes(Constants.CB_GET_HISTORY)||scrollEvent(e,e.contentElement),e.element.append(e.contentElement),e.element.appendChild(e.preview.element),e.upload&&e.element.appendChild(e.upload.element),e.options.render.scroll&&e.element.appendChild(e.scroll.element.parentElement),e.gutter&&e.element.appendChild(e.gutter.element),e.element.appendChild(e.hint.element),e.selectElement=document.createElement("div"),e.selectElement.className="protyle-select fn__none",e.element.appendChild(e.selectElement),e.element.appendChild(e.toolbar.element),e.element.appendChild(e.toolbar.subElement),e.element.append(e.highlight.styleElement),Ar(e),setEditMode(e,e.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let t;const a=genUUID(),n=isMac();e.contentElement.addEventListener("mousewheel",s=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||n&&!s.metaKey||!n&&!s.ctrlKey||s.deltaX!==0)){if(s.stopPropagation(),s.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(s.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;setInlineStyle(),clearTimeout(t),showMessage(`${window.siyuan.languages.fontSize} ${window.siyuan.config.editor.fontSize}px<span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.reset} 16px</button>`,void 0,void 0,a),t=window.setTimeout(()=>{var o;fetchPost("/api/setting/setEditor",window.siyuan.config.editor),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(l=>{lineNumberRender(l.parentElement)}),(o=document.querySelector(`#message [data-id="${a}"] button`))==null||o.addEventListener("click",()=>{window.siyuan.config.editor.fontSize=16,setInlineStyle(),fetchPost("/api/setting/setEditor",window.siyuan.config.editor),hideMessage(a),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(l=>{lineNumberRender(l.parentElement)})})},Constants.TIMEOUT_LOAD)}},{passive:!0}),e.contentElement.addEventListener("click",s=>{e.disabled||e.contentElement.querySelector(".protyle-wysiwyg--select")||!s.target.classList.contains("protyle-content")&&!s.target.classList.contains("protyle-wysiwyg")||setTimeout(()=>{if(window.getSelection().rangeCount>0){const c=window.getSelection().getRangeAt(0);if(c.toString()!==""&&e.wysiwyg.element.contains(c.startContainer))return}const o=e.wysiwyg.element.lastElementChild,l=o.getBoundingClientRect(),r=document.createRange();if(s.y>l.bottom){const c=getContenteditableElement(getLastBlock(o));if(!e.options.click.preventInsetEmptyBlock&&(!c||o.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||o.getAttribute("data-type")==="NodeParagraph"&&getContenteditableElement(c).innerHTML!=="")){let u;o.getAttribute("data-type")==="NodeHeading"&&o.getAttribute("fold")==="1"?u=genHeadingElement(o):u=genEmptyElement(!1,!1),e.wysiwyg.element.insertAdjacentElement("beforeend",u),transaction(e,[{action:"insert",data:u.outerHTML,id:u.getAttribute("data-node-id"),previousID:u.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:u.getAttribute("data-node-id")}]);const g=getContenteditableElement(u);r.selectNodeContents(g),r.collapse(!0),focusByRange(r),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},Constants.TIMEOUT_TRANSITION)}else c&&(r.selectNodeContents(c),r.collapse(!1),focusByRange(r));e.toolbar.range=r}})});let i=!1;e.element.addEventListener("mouseover",s=>{const o=hasClosestByClassName(s.target,"protyle-attr");if(o&&!o.parentElement.classList.contains("protyle-title")){const c=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),i=!0,o.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(i){const c=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),i=!1}const l=hasClosestBlock(s.target);if(e.options.render.gutter&&l){if(l&&(l.classList.contains("list")||l.classList.contains("li")))return;const c=isInEmbedBlock(l);if(c){e.gutter.render(e,c,e.wysiwyg.element);return}e.gutter.render(e,l,e.wysiwyg.element,s.target);return}const r=hasClosestByTag(s.target,"BUTTON");if(r&&r.parentElement.classList.contains("protyle-gutters")){const c=r.getAttribute("data-type");if(c==="fold"||c==="NodeAttributeViewRow"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(u=>{u.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${r.getAttribute("data-node-id")}"]`)).find(u=>{if(!isInEmbedBlock(u)&&e.gutter.isMatchNode(u)){const g=r.dataset.groupId&&r.dataset.groupId!=="undefined"?`.av__body[data-group-id="${r.dataset.groupId}"] `:"",m=u.querySelector(g+`.av__row[data-id="${r.dataset.rowId}"]`);return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(d=>{u!==d&&d.classList.remove("protyle-wysiwyg--hl"),m&&m!==d&&m.classList.remove("av__row--hl")}),c==="NodeAttributeViewRowMenu"?m.classList.add("av__row--hl"):u.classList.add("protyle-wysiwyg--hl"),!0}}),s.preventDefault();return}})},Ar=(e,t)=>{e.element.removeAttribute("data-loading"),setTimeout(()=>{e.element.getAttribute("data-loading")!=="finished"&&e.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${t||""}</div>
</div>`)},Constants.TIMEOUT_LOAD)},Hi=e=>{e.element.setAttribute("data-loading","finished"),e.element.querySelectorAll(".wysiwygLoading").forEach(t=>{t.remove()})},um=e=>{if(e.options.action.includes(Constants.CB_GET_HISTORY))return{width:0,padding:0};const t=Sr(e),a=t.left,n=t.right;e.options.backlinkData?e.wysiwyg.element.style.padding=`4px ${n}px 4px ${a}px`:e.wysiwyg.element.style.padding=`${t.top}px ${n}px ${t.bottom}px ${a}px`,e.options.render.background&&e.background.element.querySelector(".protyle-background__ia").setAttribute("style",`margin-left:${a}px;margin-right:${n}px`),e.options.render.title&&(e.title.element.style.margin=`16px ${n}px 0 ${a}px`),e.element.style.setProperty("--b3-width-protyle",e.element.clientWidth+"px"),e.element.style.setProperty("--b3-width-protyle-content",e.contentElement.clientWidth+"px");const i=e.wysiwyg.element.getAttribute("data-realwidth"),s=e.wysiwyg.element.clientWidth-a-n;return e.wysiwyg.element.setAttribute("data-realwidth",s.toString()),e.element.style.setProperty("--b3-width-protyle-wysiwyg",s.toString()+"px"),{width:i?Math.abs(parseFloat(i)-s):0}},Sr=e=>{let t=16,a=24,n=16;if(e.options.typewriterMode&&(isMobile()?n=window.innerHeight/5:n=e.element.clientHeight/2),!isMobile()){let i=e.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_FULLWIDTH);i||(i=window.siyuan.config.editor.fullWidth?"true":"false");let s=(e.element.clientWidth-Constants.SIZE_EDITOR_WIDTH)/2;i==="false"&&s>96?(s>Constants.SIZE_EDITOR_WIDTH&&(s=e.element.clientWidth*.382/1.382),s=Math.ceil(s),a=s,t=s):e.element.clientWidth>Constants.SIZE_EDITOR_WIDTH&&(a=96,t=96)}return{left:a,right:t,bottom:n,top:16}},fm=(e,t,a)=>{if(!e.preview.element.classList.contains("fn__none")){e.preview.render(e),removeLoading(e);return}if(window.siyuan.config.editor.displayBookmarkIcon?e.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):e.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),e.title&&(e.title.element.removeAttribute("data-render"),e.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?e.title.element.classList.add("protyle-wysiwyg--attr"):e.title.element.classList.remove("protyle-wysiwyg--attr")),e.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),restoreLuteMarkdownSyntax(e),e.lute.SetGFMStrikethrough1(!1),addLoading(e),e.options.backlinkData){const n=e.element.getAttribute("data-ismention")==="true",i=hasClosestByClassName(e.element,"sy__backlink");if(i){const s=i.querySelectorAll(".b3-text-field"),o=n?s[1].value:s[0].value;fetchPost(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:e.element.getAttribute("data-defid"),refTreeID:e.block.rootID,highlight:!isSupportCSSHL(),keyword:o},l=>{e.options.backlinkData=n?l.data.backmentions:l.data.backlinks,renderBacklink(e,e.options.backlinkData),searchMarkRender(e,l.data.keywords)})}}else preventScroll(e),getDocByScroll({protyle:e,focus:t,scrollAttr:saveScroll(e,!0),updateReadonly:a,cb(n){var i;(i=e.query)!=null&&i.key&&searchMarkRender(e,n,e.highlight.rangeIndex)}})};var Lr=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const gm=(e,t,a)=>{fetchPost("/api/block/getDocInfo",{id:e},n=>{t.updateTitle(n.data.name),a&&a.title&&a.title.setTitle(n.data.name)})},mm=(e,t,a=!0,n=!0,i=!1)=>{a&&hideMessage(),window.siyuan.mobile.popEditor&&(t.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?hideElements(["dialog"]):reloadProtyle(window.siyuan.mobile.popEditor.protyle,!1,n)),window.siyuan.mobile.editor&&(t.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?setEmpty(e):(reloadProtyle(window.siyuan.mobile.editor.protyle,!1,n),fetchPost("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},s=>{Dr(s.data.name),window.siyuan.mobile.editor.protyle.title.setTitle(s.data.name)}))),setNoteBook(()=>{window.siyuan.mobile.docks.file.init(!1)})},pm=e=>{getAllEditor().forEach(t=>{t.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"] span[data-type~="block-ref"][data-subtype="d"][data-id="${e.defBlockID}"]`).forEach(a=>{a.innerHTML=e.refText})})},bm=e=>{getAllEditor().forEach(a=>{if(a.protyle.block.rootID===e.rootID&&a.protyle.title){const n=a.protyle.title.element.querySelector(".protyle-attr"),i=n.querySelector(".protyle-attr--refcount");i?e.rootRefCount===0?i.remove():i.textContent=e.rootRefCount.toString():e.rootRefCount>0&&n.insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${e.rootRefCount}</div>`)}e.rootID!==e.blockID&&a.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"]`).forEach(n=>{const i=n.lastElementChild.querySelector(".protyle-attr--refcount");if(i)e.refCount===0?i.remove():i.textContent=e.refCount.toString();else if(e.refCount>0){const s=n.lastElementChild;s.childElementCount>0?s.lastElementChild.insertAdjacentHTML("afterend",`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>`):s.innerHTML=`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>${Constants.ZWSP}`}e.refCount===0?n.removeAttribute("refcount"):n.setAttribute("refcount",e.refCount.toString())})});let t;if(t=window.siyuan.mobile.docks.file.element.querySelector(`li[data-node-id="${e.rootID}"]`),t){const a=t.querySelector(".counter");a?e.rootRefCount===0?a.remove():a.textContent=e.rootRefCount.toString():e.rootRefCount>0&&t.insertAdjacentHTML("beforeend",`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${e.rootRefCount}</span>`)}},ym=e=>{window.siyuan.config.readonly||(e.plugins.forEach(t=>{t.eventBus.emit("lock-screen")}),fetchPost("/api/system/logoutAuth",{},()=>{redirectToCheckAuth()}))},xr=()=>{if(document.querySelector("#errorLog"))return;let e=`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${H.SIYUAN_VERSION}</small>`,t=`<div>${window.siyuan.languages.kernelFault1}</div><div class="fn__hr"></div><div>${window.siyuan.languages.kernelFault2}</div>`;Mt()&&(e=`\u{1F375} ${window.siyuan.languages.pleaseWait} <small>v${H.SIYUAN_VERSION}</small>`,t=`<div>${window.siyuan.languages.reconnectPrompt}</div><div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const a=new Xn({disableClose:!0,title:e,width:O()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    ${t}
</div>
</div>`});a.element.id="errorLog",a.element.setAttribute("data-key",H.DIALOG_KERNELFAULT);const n=a.element.querySelector(".b3-button");n&&n.addEventListener("click",()=>{a.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},Tr=()=>Lr(void 0,null,function*(){hideAllElements(["util"]),window.siyuan.mobile.editor&&(yield saveScroll(window.siyuan.mobile.editor.protyle)),fetchPost("/api/system/exit",{force:!1},e=>{if(e.code===1){const t=showMessage(e.msg,e.data.closeTimeout,"error"),a=document.querySelector(`#message [data-id="${t}"] button`);a&&a.addEventListener("click",()=>{fetchPost("/api/system/exit",{force:!0},()=>{(isInIOS()||isInAndroid()||isInHarmony())&&(window.location.href="siyuan://api/system/exit")})})}else e.code===2?(hideMessage(),window.siyuan.config.system.container==="std"&&ipcRenderer.send(Constants.SIYUAN_SHOW_WINDOW),confirmDialog(window.siyuan.languages.tip,e.msg,()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(isInIOS()||isInAndroid()||isInHarmony())&&(window.location.href="siyuan://api/system/exit")})}),hm=()=>{if(document.getElementById("transactionError"))return;const e=new Dialog({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_STATEEXCEPTED);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{Tr()}),t[1].addEventListener("click",()=>{Ir(),e.destroy()})},Ir=e=>{window.siyuan.storage[Constants.LOCAL_FILEPOSITION]={},setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION]),fetchPost("/api/system/rebuildDataIndex",{},()=>{e&&e()})};let Ua;const _m=e=>{const t=document.querySelector("#status");if(t)if(isMobile()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;clearTimeout(Ua),t.innerHTML=e.msg,t.style.bottom="0",Ua=window.setTimeout(()=>{t.style.bottom=""},12e3)}else{const a=t.querySelector(".status__msg");a&&(clearTimeout(Ua),a.innerHTML=e.msg,Ua=window.setTimeout(()=>{a.innerHTML=""},12e3))}},wm=e=>{let t=document.getElementById("progress");if(t||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),t=document.getElementById("progress")),e.code===2){t.remove();return}e.code===0?t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${e.data.current}/${e.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${e.data.current/e.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div class="ft__breakword">${e.msg}</div>
</div>`:e.code===1&&(t.lastElementChild?t.lastElementChild.lastElementChild.innerHTML=e.msg:t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div class="ft__breakword">${e.msg}</div>
</div>`)},vm=e=>{const t=document.querySelector(".status__backgroundtask");t&&(e.length===0?(t.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_STATUS_BACKGROUND_TASK&&window.siyuan.menus.menu.remove()):(t.classList.remove("fn__none"),t.setAttribute("data-tasks",JSON.stringify(e)),t.innerHTML=e[0].action+"<div><div></div></div>"))},Em=()=>{fetchPost("/api/sync/getBootSync",{},e=>{if(e.code===1){const t=new Dialog({width:isMobile()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${e.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});t.element.setAttribute("data-key",Constants.DIALOG_BOOTSYNCFAILED);const a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{a[1].getAttribute("disabled")||(a[1].setAttribute("disabled","disabled"),fetchPost("/api/sync/performBootSync",{},n=>{n.code===0&&t.destroy(),a[1].removeAttribute("disabled")}))})}})},Dr=e=>{const t=document.getElementById("drag"),a=getWorkspaceName();if(e===window.siyuan.languages.siyuanNote){const n=`${a} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`;document.title=n,t&&(t.textContent=n,t.setAttribute("title",n))}else{if(e=e||window.siyuan.languages.untitled,document.title=`${e} - ${a} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`,!t)return;t.setAttribute("title",e),t.innerHTML=escapeHtml(e)}},km=e=>{const t=document.querySelector("#configBazaarReadme .item__side");if(!t||e.id!==JSON.parse(t.getAttribute("data-obj")).repoURL)return;const a=t.querySelector('[data-type="install"]');a&&(e.percent>=1?(a.parentElement.classList.add("fn__none"),a.parentElement.nextElementSibling.classList.add("fn__none")):(a.classList.add("b3-button--progress"),a.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),a.innerHTML=`<span style="width: ${e.percent*100}%"></span>`,a.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${e.percent*100}%"></span>`))},Cm=(e,t)=>{const a=document.querySelector("#menuSyncNow use"),n=document.querySelector("#toolbarSync use");if(!e){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&needSubscribe("")?(a==null||a.setAttribute("xlink:href","#iconCloudOff"),n.setAttribute("xlink:href","#iconCloudOff")):(a==null||a.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc"));return}a==null||a.parentElement.classList.remove("fn__rotate"),n.parentElement.classList.remove("fn__rotate"),e.code===0?(a==null||a.parentElement.classList.add("fn__rotate"),n.parentElement.classList.add("fn__rotate"),a==null||a.setAttribute("xlink:href","#iconRefresh"),n.setAttribute("xlink:href","#iconRefresh")):e.code===2?(a==null||a.setAttribute("xlink:href","#iconCloudError"),n.setAttribute("xlink:href","#iconCloudError")):e.code===1&&(a==null||a.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc")),t.forEach(i=>{e.code===0?i.eventBus.emit("sync-start",e):e.code===1?i.eventBus.emit("sync-end",e):e.code===2&&i.eventBus.emit("sync-fail",e)})};var Mr=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const Ce=(e,t,a,n)=>{const i={method:"POST"};t&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&(window.siyuan.reqIds[e]=new Date().getTime(),t.type==="local"&&e==="/api/graph/getLocalGraph"||(t.reqId=window.siyuan.reqIds[e])),e==="/api/transactions"&&(t.reqId=new Date().getTime()),t instanceof FormData?i.body=t:i.body=JSON.stringify(t)),n&&(i.headers=n),fetch(e,i).then(s=>{var o;switch(s.status){case 403:case 404:return{data:null,msg:s.statusText,code:-s.status};default:return s.status==401&&setTimeout(()=>{window.location.reload()},3e3),((o=s.headers.get("content-type"))==null?void 0:o.indexOf("application/json"))>-1?s.json():s.text()}}).then(s=>{if(typeof s=="string"){a&&a(s);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&s.data.reqId&&window.siyuan.reqIds[e]&&window.siyuan.reqIds[e]>s.data.reqId||(typeof s=="object"&&typeof s.msg=="string"&&typeof s.code=="number"?Zn(s)&&a&&a(s):a&&a(s))}).catch(s=>{if(console.warn("fetch post failed ["+s+"], url ["+e+"]"),e==="/api/transactions"&&(s.message==="Failed to fetch"||s.message==="Unexpected end of JSON input")){xr();return}})},jn=(e,t)=>Mr(void 0,null,function*(){const a={method:"POST"};t&&(t instanceof FormData?a.body=t:a.body=JSON.stringify(t));const i=yield(yield fetch(e,a)).json();return Zn(i),i}),Am=(e,t)=>{fetch(e).then(a=>{var n;return((n=a.headers.get("content-type"))==null?void 0:n.indexOf("application/json"))>-1?a.json():a.text()}).then(a=>{t(a)})};var Ni=(e,t,a)=>new Promise((n,i)=>{var s=r=>{try{l(a.next(r))}catch(c){i(c)}},o=r=>{try{l(a.throw(r))}catch(c){i(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(s,o);l((a=a.apply(e,t)).next())});const $r=e=>{var t;const a=document.getElementsByTagName("html")[0];a.setAttribute("lang",window.siyuan.config.appearance.lang),a.setAttribute("data-theme-mode",Nr()),a.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),a.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const i=document.getElementById("themeDefaultStyle"),s=`/appearance/themes/${e.mode===1?"midnight":"daylight"}/theme.css?v=${Constants.SIYUAN_VERSION}`;if(i){if(!i.getAttribute("href").startsWith(s)){const f=document.createElement("link");new Promise(b=>{f.rel="stylesheet",f.href=s,f.onload=b,i.parentNode.insertBefore(f,i)}).then(()=>{i.remove(),f.id="themeDefaultStyle"})}}else addStyle(s,"themeDefaultStyle");const o=document.getElementById("themeStyle");if(e.mode===1&&e.themeDark!=="midnight"||e.mode===0&&e.themeLight!=="daylight"){const f=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.css?v=${e.themeVer}`;o?o.getAttribute("href").startsWith(f)||o.setAttribute("href",f):addStyle(f,"themeStyle")}else o&&o.remove();!((t=window.webkit)!=null&&t.messageHandlers)&&!window.JSAndroid&&!window.JSHarmony&&"serviceWorker"in window.navigator&&"caches"in window&&"fetch"in window&&navigator.serviceWorker&&document.head.insertAdjacentHTML("afterbegin",`<meta name="theme-color" content="${getComputedStyle(document.body).getPropertyValue("--b3-toolbar-background").trim()}">`),Bi();const l=document.getElementById("themeScript"),r=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.js?v=${e.themeVer}`;l?l.getAttribute("src").startsWith(r)||(l.remove(),addScript(r,"themeScript")):addScript(r,"themeScript");const c=["ant","material"].includes(e.icon),u=document.getElementById("iconScript"),g=document.getElementById("iconDefaultScript"),m=`/appearance/icons/${c?e.icon:"material"}/icon.js?v=${Constants.SIYUAN_VERSION}`,d=`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`;if(c&&g&&g.getAttribute("src").startsWith(m)||!c&&u&&u.getAttribute("src").startsWith(d)){c&&(u==null||u.remove(),Array.from(document.body.children).forEach(f=>{f.tagName==="svg"&&!f.getAttribute("data-name")&&!["iconsMaterial","iconsAnt"].includes(f.id)&&f.remove()}));return}g&&!g.getAttribute("src").startsWith(m)&&(g.remove(),e.icon==="ant"?document.querySelectorAll("#iconsMaterial").forEach(f=>{f.remove()}):document.querySelectorAll("#iconsAnt").forEach(f=>{f.remove()})),addScript(m,"iconDefaultScript").then(()=>{u==null||u.remove(),c||addScript(d,"iconScript").then(()=>{Array.from(document.body.children).forEach((f,b)=>{f.tagName==="svg"&&b!==0&&!f.getAttribute("data-name")&&!["iconsMaterial","iconsAnt"].includes(f.id)&&f.remove()})})})},Sm=()=>{const e=document.getElementById("loading");e&&setTimeout(()=>{e.remove()},160),Pi(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{const a=t.matches?"dark":"light";Pi(a),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&a==="light"||window.siyuan.config.appearance.mode===1&&a==="dark"||fetchPost("/api/system/setAppearanceMode",{mode:a==="light"?0:1},n=>Ni(void 0,null,function*(){if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(i){console.error("destroyTheme error: "+i)}else{window.location.reload();return}window.siyuan.config.appearance=n.data.appearance,$r(n.data.appearance)})))})},Lm=(e=!0,t="../../../")=>Ni(void 0,null,function*(){const a=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n;isMac()||isIPad()||isIPhone()?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1fa8f;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+21a9, U+21aa, U+2122, U+2194-2199, U+23cf, U+25b6, U+25c0, U+25fb, U+25fc, U+25aa, U+25ab, U+2600-2603,
  U+260e, U+2611, U+261d, U+2639, U+263a, U+2640, U+2642, U+2660, U+2663, U+2665, U+2666, U+2668, U+267b, U+26aa, U+26ab, 
  U+2702, U+2708, U+2934, U+2935, U+1f170, U+1f171, U+1f17e, U+1f17f, U+1f202, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, 
  U+1f251, U+1fae4, U+2049, U+203c, U+3030, U+303d, U+24c2, U+26a0, U+26a1, U+26be, U+27a1, U+2b05-2b07, U+3297, U+3299, U+a9, U+ae;
  size-adjust: 115%;
}
@font-face {
  font-family: "Emojis";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 115%;
}`:(yield isWin11())?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1f3f4, U+e0067, U+e0062,
  U+e0065, U+e006e, U+e007f, U+e0073, U+e0063, U+e0074, U+e0077, U+e006c;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+263a, U+21a9, U+2642, U+303d, U+2197, U+2198, U+2199, U+2196, U+2195, U+2194, U+2660, U+2665, U+2666, 
  U+2663, U+3030, U+21aa, U+25b6, U+25c0, U+2640, U+203c, U+a9, U+ae, U+2122;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 85%;
}`:n=`@font-face {
  font-family: "Emojis Reset";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1f170-1f171, U+1f17e, U+1f17f, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, U+1f251, U+1f32b, U+1f3bc,
  U+1f411, U+1f42d, U+1f42e, U+1f431, U+1f435, U+1f441, U+1f4a8, U+1f4ab, U+1f525, U+1f600-1f60d, U+1f60f-1f623,
  U+1f625-1f62b, U+1f62d-1f63f, U+1F643, U+1F640, U+1f79, U+1f8f, U+1fa79, U+1fae4, U+1fae9, U+1fac6, U+1fabe, U+1fadf,
  U+200d, U+203c, U+2049, U+2122, U+2139, U+2194-2199, U+21a9, U+21aa, U+23cf, U+25aa, U+25ab, U+25b6, U+25c0, U+25fb-25fe,
  U+2611, U+2615, U+2618, U+261d, U+2620, U+2622, U+2623, U+2626, U+262a, U+262e, U+2638-263a, U+2640, U+2642, U+2648-2653,
  U+265f, U+2660, U+2663, U+2665, U+2666, U+267b, U+267e, U+267f, U+2692-2697, U+2699, U+269b, U+269c, U+26a0, U+26a1,
  U+26a7, U+26aa, U+26ab, U+26b0, U+26b1, U+2702, U+2708, U+2709, U+270c, U+270d, U+2712, U+2714, U+2716, U+271d, U+2733,
  U+2734, U+2744, U+2747, U+2763, U+2764, U+2934-2935, U+3030, U+303d, U+3297, U+3299, U+fe0f, U+e50a, U+a9, U+ae;
  size-adjust: 92%;
}
@font-face {
  font-family: "Emojis";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol"),
  local("Apple Color Emoji"),
  local("Twemoji Mozilla"),
  local("Noto Color Emoji"),
  local("Android Emoji"),
  local("EmojiSymbols");
  size-adjust: 92%;
}`;let i="";if(window.siyuan.config.editor.rtl&&(i=`.protyle-title__input,
.protyle-wysiwyg .p,
.protyle-wysiwyg .code-block .hljs,
.protyle-wysiwyg .table,
.protyle-wysiwyg .render-node protyle-html,
.protyle-wysiwyg .render-node > div[spin="1"],
.protyle-wysiwyg [data-type="NodeHeading"] {direction: rtl}
.protyle-wysiwyg [data-node-id].li > .protyle-action {
    right: 0;
    left: auto;
    direction: rtl;
}
.protyle-wysiwyg [data-node-id].li > [data-node-id] {
    margin-right: 34px;
    margin-left: 0;
}
.protyle-wysiwyg [data-node-id].li::before {
    right: 17px;
    left: auto;
}
.b3-typography table:not([style*="text-align: left"]) {
  margin-left: auto;
}`),n+=`
:root{--b3-font-size-editor:${window.siyuan.config.editor.fontSize}px}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
${i}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-gutters button svg {height:${a}px}`,window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "Emojis Additional", "Emojis Reset", "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),e){const s=document.getElementById("siyuanStyle");s?s.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n}),Bi=(e=H.PROTYLE_CDN)=>{const t=document.getElementById("protyleHljsStyle");let a;window.siyuan.config.appearance.mode===0?(a=window.siyuan.config.appearance.codeBlockThemeLight,H.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(a)||(a="default")):(a=window.siyuan.config.appearance.codeBlockThemeDark,H.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(a)||(a="github-dark"));const n=`${e}/js/highlight.js/styles/${a}.min.css?v=11.11.1`;t?t.href.includes(n)||(t.remove(),Ga(n,"protyleHljsStyle")):Ga(n,"protyleHljsStyle")},xm=e=>{},Hr=e=>{if(e.startsWith("#"))return e;let t;const a=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),n=(a&&a[4]||"").trim();let i=a?(a[1]|256).toString(16).slice(1)+(a[2]|256).toString(16).slice(1)+(a[3]|256).toString(16).slice(1):e;return n!==""?t=n:t=1,t=(t*255|256).toString(16).slice(1),i=i+t,i},Pi=e=>{(isInIOS()||isInAndroid()||isInHarmony())&&setTimeout(()=>{const t=Hr(getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim());let a=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(e==="dark"?a=1:a=0),isInIOS()?window.webkit.messageHandlers.changeStatusBar.postMessage((t||(a===0?"#fff":"#1e1e1e"))+" "+a):isInAndroid()?window.JSAndroid.changeStatusBarColor(t,a):isInHarmony()&&window.JSHarmony.changeStatusBarColor(t,a)},500)},Nr=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?e:window.siyuan.config.appearance.mode===0?"light":"dark"},Tt=(e,t=H.PROTYLE_CDN,a=1)=>{let n,i=!1;e.classList.contains("code-block")?n=e.querySelectorAll(".hljs"):e.classList.contains("item__readme")?(n=e.querySelectorAll("pre code"),n.forEach(s=>{s.parentElement.setAttribute("linenumber","false")})):e.classList.contains("b3-typography")?(n=e.querySelectorAll(".code-block code"),i=!0):n=e.querySelectorAll(".code-block .hljs"),n.length!==0&&(Bi(t),oe(`${t}/js/highlight.js/highlight.min.js?v=11.11.1`,"protyleHljsScript").then(()=>{oe(`${t}/js/highlight.js/third-languages.js?v=2.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(s=>{const o=s.parentElement.querySelectorAll(".protyle-icon");if(o.length===2&&(o[0].setAttribute("aria-label",window.siyuan.languages.copy),o[1].setAttribute("aria-label",window.siyuan.languages.more)),s.getAttribute("data-render")==="true")return;const l=s.querySelector("wbr");let r=0;if(l){let b=l.previousSibling;for(;b;){for(r+=b.textContent.length;!b.previousSibling&&b.parentElement.tagName!=="DIV";)b=b.parentElement;b=b.previousSibling}l.remove()}let c;i?c=s.parentElement.getAttribute("data-language"):s.previousElementSibling?c=s.previousElementSibling.firstElementChild.textContent:c=s.className.replace("language-",""),window.hljs.getLanguage(c)||(c="plaintext"),s.classList.add("hljs"),s.setAttribute("data-render","true");const u=s.parentElement.getAttribute("linewrap"),g=s.parentElement.getAttribute("ligatures"),m=s.parentElement.getAttribute("linenumber"),d=s.lastElementChild?s.lastElementChild:s;u==="true"||u!=="false"&&window.siyuan.config.editor.codeLineWrap?(d.style.setProperty("white-space","pre-wrap"),d.style.setProperty("word-break","break-word")):(d.style.setProperty("white-space","pre"),d.style.setProperty("word-break","initial")),g==="true"||g!=="false"&&window.siyuan.config.editor.codeLigatures?d.style.fontVariantLigatures="normal":d.style.fontVariantLigatures="none";const f=d.textContent;s.firstElementChild&&(!i&&(m==="true"||m!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(s.firstElementChild.className="protyle-linenumber__rows",s.firstElementChild.setAttribute("contenteditable","false"),Ri(s,a),s.style.display=""):(s.firstElementChild.className="fn__none",s.firstElementChild.innerHTML="",d.style.paddingLeft="",s.style.display="block")),d.innerHTML=window.hljs.highlight(f+(f.endsWith(`
`)?"":`
`),{language:c,ignoreIllegals:!0}).value,l&&getSelection().rangeCount>0&&ja(s,r,r)})})}))},Ri=(e,t=1)=>{const a=e.parentElement.getAttribute("lineNumber");if(a==="false"||!window.siyuan.config.editor.codeSyntaxHighlightLineNum&&a!=="true")return;e.parentElement.style.lineHeight=`${((parseInt(e.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const n=e.lastElementChild,i=n.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);i[i.length-1]===""&&i.length>1&&i.pop(),e.firstElementChild.innerHTML=`<span>${i.length}</span>`,n.style.paddingLeft=`${e.firstElementChild.clientWidth+16}px`;let s="";if(n.style.wordBreak==="break-word"){const o=window.getComputedStyle(n),l=document.createElement("div");l.className="hljs",l.setAttribute("style",`padding-left:${n.style.paddingLeft};
width: ${n.getBoundingClientRect().width/t}px;
white-space:${o.whiteSpace};
word-break:${o.wordBreak};
font-variant-ligatures:${o.fontVariantLigatures};
padding-right:0;max-height: none;box-sizing: border-box;position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;`),l.setAttribute("contenteditable","true"),e.insertAdjacentElement("afterend",l),i.map(r=>{l.textContent=r.trim()?r:"<br>",s+=`<span style="height:${l.clientHeight}px"></span>`}),l.remove()}else s="<span></span>".repeat(i.length);if(e.firstElementChild.innerHTML=s,e.scrollHeight>e.clientHeight&&getSelection().rangeCount>0){const o=getSelection().getRangeAt(0);if(e.contains(o.startContainer)){const l=document.createElement("br");o.insertNode(l),l.scrollIntoView({block:"nearest"}),l.remove()}}};class qe{}qe.graphvizRender=xe,qe.highlightRender=Tt,qe.mathRender=rn,qe.mermaidRender=cn,qe.flowchartRender=un,qe.chartRender=on,qe.abcRender=ln,qe.mindmapRender=dn,qe.plantumlRender=fn,qe.avRender=Ze,qe.htmlRender=gn,window.Protyle=qe;const Br=qe})(),oa=oa.default,oa})())});Rr();})();
